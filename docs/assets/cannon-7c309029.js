import{g as Ae}from"./cannonJSPlugin-f229288c.js";function xe(ge){throw new Error('Could not dynamically require "'+ge+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Be={exports:{}};(function(ge,Se){(function(v){ge.exports=v()})(function(){return function v(I,ct,p){function e(l,i){if(!ct[l]){if(!I[l]){var t=typeof xe=="function"&&xe;if(!i&&t)return t(l,!0);if(s)return s(l,!0);throw new Error("Cannot find module '"+l+"'")}var o=ct[l]={exports:{}};I[l][0].call(o.exports,function(n){var a=I[l][1][n];return e(a||n)},o,o.exports,v,I,ct,p)}return ct[l].exports}for(var s=typeof xe=="function"&&xe,r=0;r<p.length;r++)e(p[r]);return e}({1:[function(v,I,ct){I.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(v,I,ct){I.exports={version:v("../package.json").version,AABB:v("./collision/AABB"),ArrayCollisionMatrix:v("./collision/ArrayCollisionMatrix"),Body:v("./objects/Body"),Box:v("./shapes/Box"),Broadphase:v("./collision/Broadphase"),Constraint:v("./constraints/Constraint"),ContactEquation:v("./equations/ContactEquation"),Narrowphase:v("./world/Narrowphase"),ConeTwistConstraint:v("./constraints/ConeTwistConstraint"),ContactMaterial:v("./material/ContactMaterial"),ConvexPolyhedron:v("./shapes/ConvexPolyhedron"),Cylinder:v("./shapes/Cylinder"),DistanceConstraint:v("./constraints/DistanceConstraint"),Equation:v("./equations/Equation"),EventTarget:v("./utils/EventTarget"),FrictionEquation:v("./equations/FrictionEquation"),GSSolver:v("./solver/GSSolver"),GridBroadphase:v("./collision/GridBroadphase"),Heightfield:v("./shapes/Heightfield"),HingeConstraint:v("./constraints/HingeConstraint"),LockConstraint:v("./constraints/LockConstraint"),Mat3:v("./math/Mat3"),Material:v("./material/Material"),NaiveBroadphase:v("./collision/NaiveBroadphase"),ObjectCollisionMatrix:v("./collision/ObjectCollisionMatrix"),Pool:v("./utils/Pool"),Particle:v("./shapes/Particle"),Plane:v("./shapes/Plane"),PointToPointConstraint:v("./constraints/PointToPointConstraint"),Quaternion:v("./math/Quaternion"),Ray:v("./collision/Ray"),RaycastVehicle:v("./objects/RaycastVehicle"),RaycastResult:v("./collision/RaycastResult"),RigidVehicle:v("./objects/RigidVehicle"),RotationalEquation:v("./equations/RotationalEquation"),RotationalMotorEquation:v("./equations/RotationalMotorEquation"),SAPBroadphase:v("./collision/SAPBroadphase"),SPHSystem:v("./objects/SPHSystem"),Shape:v("./shapes/Shape"),Solver:v("./solver/Solver"),Sphere:v("./shapes/Sphere"),SplitSolver:v("./solver/SplitSolver"),Spring:v("./objects/Spring"),Trimesh:v("./shapes/Trimesh"),Vec3:v("./math/Vec3"),Vec3Pool:v("./utils/Vec3Pool"),World:v("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(v,I,ct){var p=v("../math/Vec3");v("../utils/Utils"),I.exports=e;function e(l){l=l||{},this.lowerBound=new p,l.lowerBound&&this.lowerBound.copy(l.lowerBound),this.upperBound=new p,l.upperBound&&this.upperBound.copy(l.upperBound)}var s=new p;e.prototype.setFromPoints=function(l,i,t,o){var n=this.lowerBound,a=this.upperBound,c=t;n.copy(l[0]),c&&c.vmult(n,n),a.copy(n);for(var h=1;h<l.length;h++){var u=l[h];c&&(c.vmult(u,s),u=s),u.x>a.x&&(a.x=u.x),u.x<n.x&&(n.x=u.x),u.y>a.y&&(a.y=u.y),u.y<n.y&&(n.y=u.y),u.z>a.z&&(a.z=u.z),u.z<n.z&&(n.z=u.z)}return i&&(i.vadd(n,n),i.vadd(a,a)),o&&(n.x-=o,n.y-=o,n.z-=o,a.x+=o,a.y+=o,a.z+=o),this},e.prototype.copy=function(l){return this.lowerBound.copy(l.lowerBound),this.upperBound.copy(l.upperBound),this},e.prototype.clone=function(){return new e().copy(this)},e.prototype.extend=function(l){var i=l.lowerBound.x;this.lowerBound.x>i&&(this.lowerBound.x=i);var t=l.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);var i=l.lowerBound.y;this.lowerBound.y>i&&(this.lowerBound.y=i);var t=l.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);var i=l.lowerBound.z;this.lowerBound.z>i&&(this.lowerBound.z=i);var t=l.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)},e.prototype.overlaps=function(l){var i=this.lowerBound,t=this.upperBound,o=l.lowerBound,n=l.upperBound;return(o.x<=t.x&&t.x<=n.x||i.x<=n.x&&n.x<=t.x)&&(o.y<=t.y&&t.y<=n.y||i.y<=n.y&&n.y<=t.y)&&(o.z<=t.z&&t.z<=n.z||i.z<=n.z&&n.z<=t.z)},e.prototype.contains=function(l){var i=this.lowerBound,t=this.upperBound,o=l.lowerBound,n=l.upperBound;return i.x<=o.x&&t.x>=n.x&&i.y<=o.y&&t.y>=n.y&&i.z<=o.z&&t.z>=n.z},e.prototype.getCorners=function(l,i,t,o,n,a,c,h){var u=this.lowerBound,f=this.upperBound;l.copy(u),i.set(f.x,u.y,u.z),t.set(f.x,f.y,u.z),o.set(u.x,f.y,f.z),n.set(f.x,u.y,u.z),a.set(u.x,f.y,u.z),c.set(u.x,u.y,f.z),h.copy(f)};var r=[new p,new p,new p,new p,new p,new p,new p,new p];e.prototype.toLocalFrame=function(l,i){var t=r,o=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],f=t[6],x=t[7];this.getCorners(o,n,a,c,h,u,f,x);for(var d=0;d!==8;d++){var b=t[d];l.pointToLocal(b,b)}return i.setFromPoints(t)},e.prototype.toWorldFrame=function(l,i){var t=r,o=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],f=t[6],x=t[7];this.getCorners(o,n,a,c,h,u,f,x);for(var d=0;d!==8;d++){var b=t[d];l.pointToWorld(b,b)}return i.setFromPoints(t)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(v,I,ct){I.exports=p;function p(){this.matrix=[]}p.prototype.get=function(e,s){if(e=e.index,s=s.index,s>e){var r=s;s=e,e=r}return this.matrix[(e*(e+1)>>1)+s-1]},p.prototype.set=function(e,s,r){if(e=e.index,s=s.index,s>e){var l=s;s=e,e=l}this.matrix[(e*(e+1)>>1)+s-1]=r?1:0},p.prototype.reset=function(){for(var e=0,s=this.matrix.length;e!==s;e++)this.matrix[e]=0},p.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(v,I,ct){var p=v("../objects/Body"),e=v("../math/Vec3"),s=v("../math/Quaternion");v("../shapes/Shape"),v("../shapes/Plane"),I.exports=r;function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}r.prototype.collisionPairs=function(c,h,u){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=p.STATIC|p.KINEMATIC;r.prototype.needBroadphaseCollision=function(c,h){return!(!(c.collisionFilterGroup&h.collisionFilterMask)||!(h.collisionFilterGroup&c.collisionFilterMask)||(c.type&l||c.sleepState===p.SLEEPING)&&(h.type&l||h.sleepState===p.SLEEPING))},r.prototype.intersectionTest=function(c,h,u,f){this.useBoundingBoxes?this.doBoundingBoxBroadphase(c,h,u,f):this.doBoundingSphereBroadphase(c,h,u,f)};var i=new e;new e,new s,new e,r.prototype.doBoundingSphereBroadphase=function(c,h,u,f){var x=i;h.position.vsub(c.position,x);var d=Math.pow(c.boundingRadius+h.boundingRadius,2),b=x.norm2();b<d&&(u.push(c),f.push(h))},r.prototype.doBoundingBoxBroadphase=function(c,h,u,f){c.aabbNeedsUpdate&&c.computeAABB(),h.aabbNeedsUpdate&&h.computeAABB(),c.aabb.overlaps(h.aabb)&&(u.push(c),f.push(h))};var t={keys:[]},o=[],n=[];r.prototype.makePairsUnique=function(c,h){for(var u=t,f=o,x=n,d=c.length,b=0;b!==d;b++)f[b]=c[b],x[b]=h[b];c.length=0,h.length=0;for(var b=0;b!==d;b++){var G=f[b].id,at=x[b].id,V=G<at?G+","+at:at+","+G;u[V]=b,u.keys.push(V)}for(var b=0;b!==u.keys.length;b++){var V=u.keys.pop(),k=u[V];c.push(f[k]),h.push(x[k]),delete u[V]}},r.prototype.setWorld=function(c){};var a=new e;r.boundingSphereCheck=function(c,h){var u=a;return c.position.vsub(h.position,u),Math.pow(c.shape.boundingSphereRadius+h.shape.boundingSphereRadius,2)>u.norm2()},r.prototype.aabbQuery=function(c,h,u){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(v,I,ct){I.exports=r;var p=v("./Broadphase"),e=v("../math/Vec3"),s=v("../shapes/Shape");function r(i,t,o,n,a){p.apply(this),this.nx=o||10,this.ny=n||10,this.nz=a||10,this.aabbMin=i||new e(100,100,100),this.aabbMax=t||new e(-100,-100,-100);var c=this.nx*this.ny*this.nz;if(c<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=c,this.binLengths.length=c;for(var h=0;h<c;h++)this.bins[h]=[],this.binLengths[h]=0}r.prototype=new p,r.prototype.constructor=r;var l=new e;new e,r.prototype.collisionPairs=function(i,t,o){var n=i.numObjects(),a=i.bodies,H=this.aabbMax,C=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,f=h*u,x=u,d=1,b=H.x,G=H.y,at=H.z,V=C.x,k=C.y,R=C.z,B=c/(b-V),F=h/(G-k),T=u/(at-R),j=(b-V)/c,K=(G-k)/h,pt=(at-R)/u,M=Math.sqrt(j*j+K*K+pt*pt)*.5,E=s.types,_=E.SPHERE,O=E.PLANE;E.BOX,E.COMPOUND,E.CONVEXPOLYHEDRON;for(var g=this.bins,z=this.binLengths,w=this.bins.length,m=0;m!==w;m++)z[m]=0;var y=Math.ceil,C=Math.min,H=Math.max;function W(oe,he,re,Qt,Zt,ue,ce){var ee=(oe-V)*B|0,$t=(he-k)*F|0,Yt=(re-R)*T|0,ie=y((Qt-V)*B),te=y((Zt-k)*F),Ht=y((ue-R)*T);ee<0?ee=0:ee>=c&&(ee=c-1),$t<0?$t=0:$t>=h&&($t=h-1),Yt<0?Yt=0:Yt>=u&&(Yt=u-1),ie<0?ie=0:ie>=c&&(ie=c-1),te<0?te=0:te>=h&&(te=h-1),Ht<0?Ht=0:Ht>=u&&(Ht=u-1),ee*=f,$t*=x,Yt*=d,ie*=f,te*=x,Ht*=d;for(var pe=ee;pe<=ie;pe+=f)for(var ve=$t;ve<=te;ve+=x)for(var fe=Yt;fe<=Ht;fe+=d){var me=pe+ve+fe;g[me][z[me]++]=ce}}for(var m=0;m!==n;m++){var A=a[m],L=A.shape;switch(L.type){case _:var X=A.position.x,ut=A.position.y,st=A.position.z,nt=L.radius;W(X-nt,ut-nt,st-nt,X+nt,ut+nt,st+nt,A);break;case O:L.worldNormalNeedsUpdate&&L.computeWorldNormal(A.quaternion);var q=L.worldNormal,Q=V+j*.5-A.position.x,bt=k+K*.5-A.position.y,dt=R+pt*.5-A.position.z,Mt=l;Mt.set(Q,bt,dt);for(var ht=0,St=0;ht!==c;ht++,St+=f,Mt.y=bt,Mt.x+=j)for(var zt=0,Rt=0;zt!==h;zt++,Rt+=x,Mt.z=dt,Mt.y+=K)for(var Vt=0,Et=0;Vt!==u;Vt++,Et+=d,Mt.z+=pt)if(Mt.dot(q)<M){var Tt=St+Rt+Et;g[Tt][z[Tt]++]=A}break;default:A.aabbNeedsUpdate&&A.computeAABB(),W(A.aabb.lowerBound.x,A.aabb.lowerBound.y,A.aabb.lowerBound.z,A.aabb.upperBound.x,A.aabb.upperBound.y,A.aabb.upperBound.z,A);break}}for(var m=0;m!==w;m++){var At=z[m];if(At>1)for(var Wt=g[m],ht=0;ht!==At;ht++)for(var A=Wt[ht],zt=0;zt!==ht;zt++){var Gt=Wt[zt];this.needBroadphaseCollision(A,Gt)&&this.intersectionTest(A,Gt,t,o)}}this.makePairsUnique(t,o)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(v,I,ct){I.exports=s;var p=v("./Broadphase"),e=v("./AABB");function s(){p.apply(this)}s.prototype=new p,s.prototype.constructor=s,s.prototype.collisionPairs=function(r,l,i){var t=r.bodies,o=t.length,n,a,c,h;for(n=0;n!==o;n++)for(a=0;a!==n;a++)c=t[n],h=t[a],this.needBroadphaseCollision(c,h)&&this.intersectionTest(c,h,l,i)},new e,s.prototype.aabbQuery=function(r,l,i){i=i||[];for(var t=0;t<r.bodies.length;t++){var o=r.bodies[t];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(l)&&i.push(o)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(v,I,ct){I.exports=p;function p(){this.matrix={}}p.prototype.get=function(e,s){if(e=e.id,s=s.id,s>e){var r=s;s=e,e=r}return e+"-"+s in this.matrix},p.prototype.set=function(e,s,r){if(e=e.id,s=s.id,s>e){var l=s;s=e,e=l}r?this.matrix[e+"-"+s]=!0:delete this.matrix[e+"-"+s]},p.prototype.reset=function(){this.matrix={}},p.prototype.setNumObjects=function(e){}},{}],9:[function(v,I,ct){I.exports=t;var p=v("../math/Vec3"),e=v("../math/Quaternion"),s=v("../math/Transform");v("../shapes/ConvexPolyhedron"),v("../shapes/Box");var r=v("../collision/RaycastResult"),l=v("../shapes/Shape"),i=v("../collision/AABB");function t(w,m){this.from=w?w.clone():new p,this.to=m?m.clone():new p,this._direction=new p,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new r,this.hasHit=!1,this.callback=function(y){}}t.prototype.constructor=t,t.CLOSEST=1,t.ANY=2,t.ALL=4;var o=new i,n=[];t.prototype.intersectWorld=function(w,m){return this.mode=m.mode||t.ANY,this.result=m.result||new r,this.skipBackfaces=!!m.skipBackfaces,this.collisionFilterMask=typeof m.collisionFilterMask<"u"?m.collisionFilterMask:-1,this.collisionFilterGroup=typeof m.collisionFilterGroup<"u"?m.collisionFilterGroup:-1,m.from&&this.from.copy(m.from),m.to&&this.to.copy(m.to),this.callback=m.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(o),n.length=0,w.broadphase.aabbQuery(w,o,n),this.intersectBodies(n),this.hasHit};var a=new p,c=new p;t.pointInTriangle=h;function h(w,m,y,C){C.vsub(m,O),y.vsub(m,a),w.vsub(m,c);var H=O.dot(O),W=O.dot(a),A=O.dot(c),L=a.dot(a),X=a.dot(c),ut,st;return(ut=L*A-W*X)>=0&&(st=H*X-W*A)>=0&&ut+st<H*L-W*W}var u=new p,f=new e;t.prototype.intersectBody=function(w,m){m&&(this.result=m,this._updateDirection());var y=this.checkCollisionResponse;if(!(y&&!w.collisionResponse)&&!(!(this.collisionFilterGroup&w.collisionFilterMask)||!(w.collisionFilterGroup&this.collisionFilterMask)))for(var C=u,H=f,W=0,A=w.shapes.length;W<A;W++){var L=w.shapes[W];if(!(y&&!L.collisionResponse)&&(w.quaternion.mult(w.shapeOrientations[W],H),w.quaternion.vmult(w.shapeOffsets[W],C),C.vadd(w.position,C),this.intersectShape(L,H,C,w),this.result._shouldStop))break}},t.prototype.intersectBodies=function(w,m){m&&(this.result=m,this._updateDirection());for(var y=0,C=w.length;!this.result._shouldStop&&y<C;y++)this.intersectBody(w[y])},t.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(w,m,y,C){var H=this.from,W=z(H,this._direction,y);if(!(W>w.boundingSphereRadius)){var A=this[w.type];A&&A.call(this,w,m,y,C)}},new p,new p;var x=new p,d=new p,b=new p,G=new p;new p,new r,t.prototype.intersectBox=function(w,m,y,C){return this.intersectConvex(w.convexPolyhedronRepresentation,m,y,C)},t.prototype[l.types.BOX]=t.prototype.intersectBox,t.prototype.intersectPlane=function(w,m,y,C){var H=this.from,W=this.to,A=this._direction,L=new p(0,0,1);m.vmult(L,L);var X=new p;H.vsub(y,X);var ut=X.dot(L);W.vsub(y,X);var st=X.dot(L);if(!(ut*st>0)&&!(H.distanceTo(W)<ut)){var nt=L.dot(A);if(!(Math.abs(nt)<this.precision)){var q=new p,Q=new p,bt=new p;H.vsub(y,q);var dt=-L.dot(q)/nt;A.scale(dt,Q),H.vadd(Q,bt),this.reportIntersection(L,bt,w,C,-1)}}},t.prototype[l.types.PLANE]=t.prototype.intersectPlane,t.prototype.getAABB=function(w){var m=this.to,y=this.from;w.lowerBound.x=Math.min(m.x,y.x),w.lowerBound.y=Math.min(m.y,y.y),w.lowerBound.z=Math.min(m.z,y.z),w.upperBound.x=Math.max(m.x,y.x),w.upperBound.y=Math.max(m.y,y.y),w.upperBound.z=Math.max(m.z,y.z)};var at={faceList:[0]};t.prototype.intersectHeightfield=function(w,m,y,C){w.data,w.elementSize;var H=new p,W=new t(this.from,this.to);s.pointToLocalFrame(y,m,W.from,W.from),s.pointToLocalFrame(y,m,W.to,W.to);var A=[],L=null,X=null,ut=null,st=null,nt=w.getIndexOfPosition(W.from.x,W.from.y,A,!1);if(nt&&(L=A[0],X=A[1],ut=A[0],st=A[1]),nt=w.getIndexOfPosition(W.to.x,W.to.y,A,!1),nt&&((L===null||A[0]<L)&&(L=A[0]),(ut===null||A[0]>ut)&&(ut=A[0]),(X===null||A[1]<X)&&(X=A[1]),(st===null||A[1]>st)&&(st=A[1])),L!==null){var q=[];w.getRectMinMax(L,X,ut,st,q),q[0],q[1];for(var Q=L;Q<=ut;Q++)for(var bt=X;bt<=st;bt++){if(this.result._shouldStop||(w.getConvexTrianglePillar(Q,bt,!1),s.pointToWorldFrame(y,m,w.pillarOffset,H),this.intersectConvex(w.pillarConvex,m,H,C,at),this.result._shouldStop))return;w.getConvexTrianglePillar(Q,bt,!0),s.pointToWorldFrame(y,m,w.pillarOffset,H),this.intersectConvex(w.pillarConvex,m,H,C,at)}}},t.prototype[l.types.HEIGHTFIELD]=t.prototype.intersectHeightfield;var V=new p,k=new p;t.prototype.intersectSphere=function(w,m,y,C){var H=this.from,W=this.to,A=w.radius,L=Math.pow(W.x-H.x,2)+Math.pow(W.y-H.y,2)+Math.pow(W.z-H.z,2),X=2*((W.x-H.x)*(H.x-y.x)+(W.y-H.y)*(H.y-y.y)+(W.z-H.z)*(H.z-y.z)),ut=Math.pow(H.x-y.x,2)+Math.pow(H.y-y.y,2)+Math.pow(H.z-y.z,2)-Math.pow(A,2),st=Math.pow(X,2)-4*L*ut,nt=V,q=k;if(!(st<0))if(st===0)H.lerp(W,st,nt),nt.vsub(y,q),q.normalize(),this.reportIntersection(q,nt,w,C,-1);else{var Q=(-X-Math.sqrt(st))/(2*L),bt=(-X+Math.sqrt(st))/(2*L);if(Q>=0&&Q<=1&&(H.lerp(W,Q,nt),nt.vsub(y,q),q.normalize(),this.reportIntersection(q,nt,w,C,-1)),this.result._shouldStop)return;bt>=0&&bt<=1&&(H.lerp(W,bt,nt),nt.vsub(y,q),q.normalize(),this.reportIntersection(q,nt,w,C,-1))}},t.prototype[l.types.SPHERE]=t.prototype.intersectSphere;var R=new p;new p,new p;var B=new p;t.prototype.intersectConvex=function(m,y,C,H,W){for(var A=R,L=B,X=W&&W.faceList||null,ut=m.faces,st=m.vertices,nt=m.faceNormals,q=this._direction,Q=this.from,bt=this.to,dt=Q.distanceTo(bt),Mt=X?X.length:ut.length,ht=this.result,St=0;!ht._shouldStop&&St<Mt;St++){var zt=X?X[St]:St,Rt=ut[zt],Vt=nt[zt],Et=y,Tt=C;L.copy(st[Rt[0]]),Et.vmult(L,L),L.vadd(Tt,L),L.vsub(Q,L),Et.vmult(Vt,A);var At=q.dot(A);if(!(Math.abs(At)<this.precision)){var Wt=A.dot(L)/At;if(!(Wt<0)){q.mult(Wt,x),x.vadd(Q,x),d.copy(st[Rt[0]]),Et.vmult(d,d),Tt.vadd(d,d);for(var Gt=1;!ht._shouldStop&&Gt<Rt.length-1;Gt++){b.copy(st[Rt[Gt]]),G.copy(st[Rt[Gt+1]]),Et.vmult(b,b),Et.vmult(G,G),Tt.vadd(b,b),Tt.vadd(G,G);var oe=x.distanceTo(Q);!(h(x,d,b,G)||h(x,b,d,G))||oe>dt||this.reportIntersection(A,x,m,H,zt)}}}}},t.prototype[l.types.CONVEXPOLYHEDRON]=t.prototype.intersectConvex;var F=new p,T=new p,j=new p,K=new p,pt=new p,M=new p;new i;var E=[],_=new s;t.prototype.intersectTrimesh=function(m,y,C,H,W){var A=F,L=E,X=_,ut=B,st=T,nt=j,q=K,Q=M,bt=pt;W&&W.faceList;var dt=m.indices;m.vertices,m.faceNormals;var Mt=this.from,ht=this.to,St=this._direction;X.position.copy(C),X.quaternion.copy(y),s.vectorToLocalFrame(C,y,St,st),s.pointToLocalFrame(C,y,Mt,nt),s.pointToLocalFrame(C,y,ht,q);var zt=nt.distanceSquared(q);m.tree.rayQuery(this,X,L);for(var Rt=0,Vt=L.length;!this.result._shouldStop&&Rt!==Vt;Rt++){var Et=L[Rt];m.getNormal(Et,A),m.getVertex(dt[Et*3],d),d.vsub(nt,ut);var Tt=st.dot(A),At=A.dot(ut)/Tt;if(!(At<0)){st.scale(At,x),x.vadd(nt,x),m.getVertex(dt[Et*3+1],b),m.getVertex(dt[Et*3+2],G);var Wt=x.distanceSquared(nt);!(h(x,b,d,G)||h(x,d,b,G))||Wt>zt||(s.vectorToWorldFrame(y,A,bt),s.pointToWorldFrame(C,y,x,Q),this.reportIntersection(bt,Q,m,H,Et))}}L.length=0},t.prototype[l.types.TRIMESH]=t.prototype.intersectTrimesh,t.prototype.reportIntersection=function(w,m,y,C,H){var W=this.from,A=this.to,L=W.distanceTo(m),X=this.result;if(!(this.skipBackfaces&&w.dot(this._direction)>0))switch(X.hitFaceIndex=typeof H<"u"?H:-1,this.mode){case t.ALL:this.hasHit=!0,X.set(W,A,w,m,y,C,L),X.hasHit=!0,this.callback(X);break;case t.CLOSEST:(L<X.distance||!X.hasHit)&&(this.hasHit=!0,X.hasHit=!0,X.set(W,A,w,m,y,C,L));break;case t.ANY:this.hasHit=!0,X.hasHit=!0,X.set(W,A,w,m,y,C,L),X._shouldStop=!0;break}};var O=new p,g=new p;function z(w,m,y){y.vsub(w,O);var C=O.dot(m);m.mult(C,g),g.vadd(w,g);var H=y.distanceTo(g);return H}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(v,I,ct){var p=v("../math/Vec3");I.exports=e;function e(){this.rayFromWorld=new p,this.rayToWorld=new p,this.hitNormalWorld=new p,this.hitPointWorld=new p,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},e.prototype.abort=function(){this._shouldStop=!0},e.prototype.set=function(s,r,l,i,t,o,n){this.rayFromWorld.copy(s),this.rayToWorld.copy(r),this.hitNormalWorld.copy(l),this.hitPointWorld.copy(i),this.shape=t,this.body=o,this.distance=n}},{"../math/Vec3":30}],11:[function(v,I,ct){v("../shapes/Shape");var p=v("../collision/Broadphase");I.exports=e;function e(s){p.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var r=this.axisList;this._addBodyHandler=function(l){r.push(l.body)},this._removeBodyHandler=function(l){var i=r.indexOf(l.body);i!==-1&&r.splice(i,1)},s&&this.setWorld(s)}e.prototype=new p,e.prototype.setWorld=function(s){this.axisList.length=0;for(var r=0;r<s.bodies.length;r++)this.axisList.push(s.bodies[r]);s.removeEventListener("addBody",this._addBodyHandler),s.removeEventListener("removeBody",this._removeBodyHandler),s.addEventListener("addBody",this._addBodyHandler),s.addEventListener("removeBody",this._removeBodyHandler),this.world=s,this.dirty=!0},e.insertionSortX=function(s){for(var r=1,l=s.length;r<l;r++){for(var i=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.x<=i.aabb.lowerBound.x);t--)s[t+1]=s[t];s[t+1]=i}return s},e.insertionSortY=function(s){for(var r=1,l=s.length;r<l;r++){for(var i=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.y<=i.aabb.lowerBound.y);t--)s[t+1]=s[t];s[t+1]=i}return s},e.insertionSortZ=function(s){for(var r=1,l=s.length;r<l;r++){for(var i=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.z<=i.aabb.lowerBound.z);t--)s[t+1]=s[t];s[t+1]=i}return s},e.prototype.collisionPairs=function(s,r,l){var i=this.axisList,t=i.length,o=this.axisIndex,n,a;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==t;n++){var c=i[n];for(a=n+1;a<t;a++){var h=i[a];if(this.needBroadphaseCollision(c,h)){if(!e.checkBounds(c,h,o))break;this.intersectionTest(c,h,r,l)}}}},e.prototype.sortList=function(){for(var s=this.axisList,r=this.axisIndex,l=s.length,i=0;i!==l;i++){var t=s[i];t.aabbNeedsUpdate&&t.computeAABB()}r===0?e.insertionSortX(s):r===1?e.insertionSortY(s):r===2&&e.insertionSortZ(s)},e.checkBounds=function(s,r,l){var i,t;l===0?(i=s.position.x,t=r.position.x):l===1?(i=s.position.y,t=r.position.y):l===2&&(i=s.position.z,t=r.position.z);var o=s.boundingRadius,n=r.boundingRadius,a=i+o,c=t-n;return c<a},e.prototype.autoDetectAxis=function(){for(var s=0,r=0,l=0,i=0,t=0,o=0,n=this.axisList,a=n.length,c=1/a,h=0;h!==a;h++){var u=n[h],f=u.position.x;s+=f,r+=f*f;var x=u.position.y;l+=x,i+=x*x;var d=u.position.z;t+=d,o+=d*d}var b=r-s*s*c,G=i-l*l*c,at=o-t*t*c;b>G?b>at?this.axisIndex=0:this.axisIndex=2:G>at?this.axisIndex=1:this.axisIndex=2},e.prototype.aabbQuery=function(s,r,l){l=l||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,t="x";i===1&&(t="y"),i===2&&(t="z");var o=this.axisList;r.lowerBound[t],r.upperBound[t];for(var n=0;n<o.length;n++){var a=o[n];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(r)&&l.push(a)}return l}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(v,I,ct){I.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/ConeEquation"),s=v("../equations/RotationalEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(i,t,o){o=o||{};var n=typeof o.maxForce<"u"?o.maxForce:1e6,a=o.pivotA?o.pivotA.clone():new r,c=o.pivotB?o.pivotB.clone():new r;this.axisA=o.axisA?o.axisA.clone():new r,this.axisB=o.axisB?o.axisB.clone():new r,p.call(this,i,a,t,c,n),this.collideConnected=!!o.collideConnected,this.angle=typeof o.angle<"u"?o.angle:0;var h=this.coneEquation=new e(i,t,o),u=this.twistEquation=new s(i,t,o);this.twistAngle=typeof o.twistAngle<"u"?o.twistAngle:0,h.maxForce=0,h.minForce=-n,u.maxForce=0,u.minForce=-n,this.equations.push(h,u)}l.prototype=new p,l.constructor=l,new r,new r,l.prototype.update=function(){var i=this.bodyA,t=this.bodyB,o=this.coneEquation,n=this.twistEquation;p.prototype.update.call(this),i.vectorToWorldFrame(this.axisA,o.axisA),t.vectorToWorldFrame(this.axisB,o.axisB),this.axisA.tangents(n.axisA,n.axisA),i.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),o.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(v,I,ct){I.exports=e;var p=v("../utils/Utils");function e(s,r,l){l=p.defaults(l,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=s,this.bodyB=r,this.id=e.idCounter++,this.collideConnected=l.collideConnected,l.wakeUpBodies&&(s&&s.wakeUp(),r&&r.wakeUp())}e.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.prototype.enable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!0},e.prototype.disable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!1},e.idCounter=0},{"../utils/Utils":53}],14:[function(v,I,ct){I.exports=s;var p=v("./Constraint"),e=v("../equations/ContactEquation");function s(r,l,i,t){p.call(this,r,l),typeof i>"u"&&(i=r.position.distanceTo(l.position)),typeof t>"u"&&(t=1e6),this.distance=i;var o=this.distanceEquation=new e(r,l);this.equations.push(o),o.minForce=-t,o.maxForce=t}s.prototype=new p,s.prototype.update=function(){var r=this.bodyA,l=this.bodyB,i=this.distanceEquation,t=this.distance*.5,o=i.ni;l.position.vsub(r.position,o),o.normalize(),o.mult(t,i.ri),o.mult(-t,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(v,I,ct){I.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation"),s=v("../equations/RotationalMotorEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(o,n,a){a=a||{};var c=typeof a.maxForce<"u"?a.maxForce:1e6,h=a.pivotA?a.pivotA.clone():new r,u=a.pivotB?a.pivotB.clone():new r;p.call(this,o,h,n,u,c);var f=this.axisA=a.axisA?a.axisA.clone():new r(1,0,0);f.normalize();var x=this.axisB=a.axisB?a.axisB.clone():new r(1,0,0);x.normalize();var d=this.rotationalEquation1=new e(o,n,a),b=this.rotationalEquation2=new e(o,n,a),G=this.motorEquation=new s(o,n,c);G.enabled=!1,this.equations.push(d,b,G)}l.prototype=new p,l.constructor=l,l.prototype.enableMotor=function(){this.motorEquation.enabled=!0},l.prototype.disableMotor=function(){this.motorEquation.enabled=!1},l.prototype.setMotorSpeed=function(o){this.motorEquation.targetVelocity=o},l.prototype.setMotorMaxForce=function(o){this.motorEquation.maxForce=o,this.motorEquation.minForce=-o};var i=new r,t=new r;l.prototype.update=function(){var o=this.bodyA,n=this.bodyB,a=this.motorEquation,c=this.rotationalEquation1,h=this.rotationalEquation2,u=i,f=t,x=this.axisA,d=this.axisB;p.prototype.update.call(this),o.quaternion.vmult(x,u),n.quaternion.vmult(d,f),u.tangents(c.axisA,h.axisA),c.axisB.copy(f),h.axisB.copy(f),this.motorEquation.enabled&&(o.quaternion.vmult(this.axisA,a.axisA),n.quaternion.vmult(this.axisB,a.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(v,I,ct){I.exports=r,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation");v("../equations/RotationalMotorEquation"),v("../equations/ContactEquation");var s=v("../math/Vec3");function r(l,i,t){t=t||{};var o=typeof t.maxForce<"u"?t.maxForce:1e6,n=new s,a=new s,c=new s;l.position.vadd(i.position,c),c.scale(.5,c),i.pointToLocalFrame(c,a),l.pointToLocalFrame(c,n),p.call(this,l,n,i,a,o);var h=this.rotationalEquation1=new e(l,i,t),u=this.rotationalEquation2=new e(l,i,t),f=this.rotationalEquation3=new e(l,i,t);this.equations.push(h,u,f)}r.prototype=new p,r.constructor=r,new s,new s,r.prototype.update=function(){var l=this.bodyA,i=this.bodyB;this.motorEquation;var t=this.rotationalEquation1,o=this.rotationalEquation2,n=this.rotationalEquation3;p.prototype.update.call(this),l.vectorToWorldFrame(s.UNIT_X,t.axisA),i.vectorToWorldFrame(s.UNIT_Y,t.axisB),l.vectorToWorldFrame(s.UNIT_Y,o.axisA),i.vectorToWorldFrame(s.UNIT_Z,o.axisB),l.vectorToWorldFrame(s.UNIT_Z,n.axisA),i.vectorToWorldFrame(s.UNIT_X,n.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(v,I,ct){I.exports=r;var p=v("./Constraint"),e=v("../equations/ContactEquation"),s=v("../math/Vec3");function r(l,i,t,o,n){p.call(this,l,t),n=typeof n<"u"?n:1e6,this.pivotA=i?i.clone():new s,this.pivotB=o?o.clone():new s;var a=this.equationX=new e(l,t),c=this.equationY=new e(l,t),h=this.equationZ=new e(l,t);this.equations.push(a,c,h),a.minForce=c.minForce=h.minForce=-n,a.maxForce=c.maxForce=h.maxForce=n,a.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}r.prototype=new p,r.prototype.update=function(){var l=this.bodyA,i=this.bodyB,t=this.equationX,o=this.equationY,n=this.equationZ;l.quaternion.vmult(this.pivotA,t.ri),i.quaternion.vmult(this.pivotB,t.rj),o.ri.copy(t.ri),o.rj.copy(t.rj),n.ri.copy(t.ri),n.rj.copy(t.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(v,I,ct){I.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(i,t,o){o=o||{};var n=typeof o.maxForce<"u"?o.maxForce:1e6;e.call(this,i,t,-n,n),this.axisA=o.axisA?o.axisA.clone():new p(1,0,0),this.axisB=o.axisB?o.axisB.clone():new p(0,1,0),this.angle=typeof o.angle<"u"?o.angle:0}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(i){var t=this.a,o=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,f=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),f.rotational.copy(c);var x=Math.cos(this.angle)-n.dot(a),d=this.computeGW(),b=this.computeGiMf(),G=-x*t-d*o-i*b;return G}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(v,I,ct){I.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(h,u,f){f=typeof f<"u"?f:1e6,p.call(this,h,u,0,f),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e,i=new e;s.prototype.computeB=function(h){var u=this.a,f=this.b,x=this.bi,d=this.bj,b=this.ri,G=this.rj,at=r,V=l,k=x.velocity,R=x.angularVelocity;x.force,x.torque;var B=d.velocity,F=d.angularVelocity;d.force,d.torque;var T=i,j=this.jacobianElementA,K=this.jacobianElementB,pt=this.ni;b.cross(pt,at),G.cross(pt,V),pt.negate(j.spatial),at.negate(j.rotational),K.spatial.copy(pt),K.rotational.copy(V),T.copy(d.position),T.vadd(G,T),T.vsub(x.position,T),T.vsub(b,T);var M=pt.dot(T),E=this.restitution+1,_=E*B.dot(pt)-E*k.dot(pt)+F.dot(V)-R.dot(at),O=this.computeGiMf(),g=-M*u-_*f-h*O;return g};var t=new e,o=new e,n=new e,a=new e,c=new e;s.prototype.getImpactVelocityAlongNormal=function(){var h=t,u=o,f=n,x=a,d=c;return this.bi.position.vadd(this.ri,f),this.bj.position.vadd(this.rj,x),this.bi.getVelocityAtWorldPoint(f,h),this.bj.getVelocityAtWorldPoint(x,u),h.vsub(u,d),this.ni.dot(d)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(v,I,ct){I.exports=s;var p=v("../math/JacobianElement"),e=v("../math/Vec3");function s(c,h,u,f){this.id=s.id++,this.minForce=typeof u>"u"?-1e6:u,this.maxForce=typeof f>"u"?1e6:f,this.bi=c,this.bj=h,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new p,this.jacobianElementB=new p,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}s.prototype.constructor=s,s.id=0,s.prototype.setSpookParams=function(c,h,u){var f=h,x=c,d=u;this.a=4/(d*(1+4*f)),this.b=4*f/(1+4*f),this.eps=4/(d*d*x*(1+4*f))},s.prototype.computeB=function(c,h,u){var f=this.computeGW(),x=this.computeGq(),d=this.computeGiMf();return-x*c-f*h-d*u},s.prototype.computeGq=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,x=u.position,d=f.position;return c.spatial.dot(x)+h.spatial.dot(d)};var r=new e;s.prototype.computeGW=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,x=u.velocity,d=f.velocity,b=u.angularVelocity||r,G=f.angularVelocity||r;return c.multiplyVectors(x,b)+h.multiplyVectors(d,G)},s.prototype.computeGWlambda=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,x=u.vlambda,d=f.vlambda,b=u.wlambda||r,G=f.wlambda||r;return c.multiplyVectors(x,b)+h.multiplyVectors(d,G)};var l=new e,i=new e,t=new e,o=new e;s.prototype.computeGiMf=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,x=u.force,d=u.torque,b=f.force,G=f.torque,at=u.invMassSolve,V=f.invMassSolve;return u.invInertiaWorldSolve?u.invInertiaWorldSolve.vmult(d,t):t.set(0,0,0),f.invInertiaWorldSolve?f.invInertiaWorldSolve.vmult(G,o):o.set(0,0,0),x.mult(at,l),b.mult(V,i),c.multiplyVectors(l,t)+h.multiplyVectors(i,o)};var n=new e;s.prototype.computeGiMGt=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,f=this.bj,x=u.invMassSolve,d=f.invMassSolve,b=u.invInertiaWorldSolve,G=f.invInertiaWorldSolve,at=x+d;return b&&(b.vmult(c.rotational,n),at+=n.dot(c.rotational)),G&&(G.vmult(h.rotational,n),at+=n.dot(h.rotational)),at};var a=new e;new e,new e,new e,new e,new e,s.prototype.addToWlambda=function(c){var h=this.jacobianElementA,u=this.jacobianElementB,f=this.bi,x=this.bj,d=a;h.spatial.mult(f.invMassSolve*c,d),f.vlambda.vadd(d,f.vlambda),u.spatial.mult(x.invMassSolve*c,d),x.vlambda.vadd(d,x.vlambda),f.invInertiaWorldSolve&&(f.invInertiaWorldSolve.vmult(h.rotational,d),d.mult(c,d),f.wlambda.vadd(d,f.wlambda)),x.invInertiaWorldSolve&&(x.invInertiaWorldSolve.vmult(u.rotational,d),d.mult(c,d),x.wlambda.vadd(d,x.wlambda))},s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(v,I,ct){I.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(i,t,o){p.call(this,i,t,-o,o),this.ri=new e,this.rj=new e,this.t=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e;s.prototype.computeB=function(i){this.a;var t=this.b;this.bi,this.bj;var o=this.ri,n=this.rj,a=r,c=l,h=this.t;o.cross(h,a),n.cross(h,c);var u=this.jacobianElementA,f=this.jacobianElementB;h.negate(u.spatial),a.negate(u.rotational),f.spatial.copy(h),f.rotational.copy(c);var x=this.computeGW(),d=this.computeGiMf(),b=-x*t-i*d;return b}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(v,I,ct){I.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(i,t,o){o=o||{};var n=typeof o.maxForce<"u"?o.maxForce:1e6;e.call(this,i,t,-n,n),this.axisA=o.axisA?o.axisA.clone():new p(1,0,0),this.axisB=o.axisB?o.axisB.clone():new p(0,1,0),this.maxAngle=Math.PI/2}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(i){var t=this.a,o=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,f=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),f.rotational.copy(c);var x=Math.cos(this.maxAngle)-n.dot(a),d=this.computeGW(),b=this.computeGiMf(),G=-x*t-d*o-i*b;return G}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(v,I,ct){I.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(r,l,i){i=typeof i<"u"?i:1e6,e.call(this,r,l,-i,i),this.axisA=new p,this.axisB=new p,this.targetVelocity=0}s.prototype=new e,s.prototype.constructor=s,s.prototype.computeB=function(r){this.a;var l=this.b;this.bi,this.bj;var i=this.axisA,t=this.axisB,o=this.jacobianElementA,n=this.jacobianElementB;o.rotational.copy(i),t.negate(n.rotational);var a=this.computeGW()-this.targetVelocity,c=this.computeGiMf(),h=-a*l-r*c;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(v,I,ct){var p=v("../utils/Utils");I.exports=e;function e(s,r,l){l=p.defaults(l,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[s,r],this.friction=l.friction,this.restitution=l.restitution,this.contactEquationStiffness=l.contactEquationStiffness,this.contactEquationRelaxation=l.contactEquationRelaxation,this.frictionEquationStiffness=l.frictionEquationStiffness,this.frictionEquationRelaxation=l.frictionEquationRelaxation}e.idCounter=0},{"../utils/Utils":53}],25:[function(v,I,ct){I.exports=p;function p(e){var s="";e=e||{},typeof e=="string"?(s=e,e={}):typeof e=="object"&&(s=""),this.name=s,this.id=p.idCounter++,this.friction=typeof e.friction<"u"?e.friction:-1,this.restitution=typeof e.restitution<"u"?e.restitution:-1}p.idCounter=0},{}],26:[function(v,I,ct){I.exports=e;var p=v("./Vec3");function e(){this.spatial=new p,this.rotational=new p}e.prototype.multiplyElement=function(s){return s.spatial.dot(this.spatial)+s.rotational.dot(this.rotational)},e.prototype.multiplyVectors=function(s,r){return s.dot(this.spatial)+r.dot(this.rotational)}},{"./Vec3":30}],27:[function(v,I,ct){I.exports=e;var p=v("./Vec3");function e(s){s?this.elements=s:this.elements=[0,0,0,0,0,0,0,0,0]}e.prototype.identity=function(){var s=this.elements;s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=0,s[7]=0,s[8]=1},e.prototype.setZero=function(){var s=this.elements;s[0]=0,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=0,s[6]=0,s[7]=0,s[8]=0},e.prototype.setTrace=function(s){var r=this.elements;r[0]=s.x,r[4]=s.y,r[8]=s.z},e.prototype.getTrace=function(r){var r=r||new p,l=this.elements;r.x=l[0],r.y=l[4],r.z=l[8]},e.prototype.vmult=function(s,r){r=r||new p;var l=this.elements,i=s.x,t=s.y,o=s.z;return r.x=l[0]*i+l[1]*t+l[2]*o,r.y=l[3]*i+l[4]*t+l[5]*o,r.z=l[6]*i+l[7]*t+l[8]*o,r},e.prototype.smult=function(s){for(var r=0;r<this.elements.length;r++)this.elements[r]*=s},e.prototype.mmult=function(s,r){for(var l=r||new e,i=0;i<3;i++)for(var t=0;t<3;t++){for(var o=0,n=0;n<3;n++)o+=s.elements[i+n*3]*this.elements[n+t*3];l.elements[i+t*3]=o}return l},e.prototype.scale=function(s,r){r=r||new e;for(var l=this.elements,i=r.elements,t=0;t!==3;t++)i[3*t+0]=s.x*l[3*t+0],i[3*t+1]=s.y*l[3*t+1],i[3*t+2]=s.z*l[3*t+2];return r},e.prototype.solve=function(s,r){r=r||new p;for(var l=3,i=4,t=[],o=0;o<l*i;o++)t.push(0);var o,n;for(o=0;o<3;o++)for(n=0;n<3;n++)t[o+i*n]=this.elements[o+3*n];t[3+4*0]=s.x,t[3+4*1]=s.y,t[3+4*2]=s.z;var a=3,c=a,h,u=4,f;do{if(o=c-a,t[o+i*o]===0){for(n=o+1;n<c;n++)if(t[o+i*n]!==0){h=u;do f=u-h,t[f+i*o]+=t[f+i*n];while(--h);break}}if(t[o+i*o]!==0)for(n=o+1;n<c;n++){var x=t[o+i*n]/t[o+i*o];h=u;do f=u-h,t[f+i*n]=f<=o?0:t[f+i*n]-t[f+i*o]*x;while(--h)}}while(--a);if(r.z=t[2*i+3]/t[2*i+2],r.y=(t[1*i+3]-t[1*i+2]*r.z)/t[1*i+1],r.x=(t[0*i+3]-t[0*i+2]*r.z-t[0*i+1]*r.y)/t[0*i+0],isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||r.x===1/0||r.y===1/0||r.z===1/0)throw"Could not solve equation! Got x=["+r.toString()+"], b=["+s.toString()+"], A=["+this.toString()+"]";return r},e.prototype.e=function(s,r,l){if(l===void 0)return this.elements[r+3*s];this.elements[r+3*s]=l},e.prototype.copy=function(s){for(var r=0;r<s.elements.length;r++)this.elements[r]=s.elements[r];return this},e.prototype.toString=function(){for(var s="",r=",",l=0;l<9;l++)s+=this.elements[l]+r;return s},e.prototype.reverse=function(s){s=s||new e;for(var r=3,l=6,i=[],t=0;t<r*l;t++)i.push(0);var t,o;for(t=0;t<3;t++)for(o=0;o<3;o++)i[t+l*o]=this.elements[t+3*o];i[3+6*0]=1,i[3+6*1]=0,i[3+6*2]=0,i[4+6*0]=0,i[4+6*1]=1,i[4+6*2]=0,i[5+6*0]=0,i[5+6*1]=0,i[5+6*2]=1;var n=3,a=n,c,h=l,u;do{if(t=a-n,i[t+l*t]===0){for(o=t+1;o<a;o++)if(i[t+l*o]!==0){c=h;do u=h-c,i[u+l*t]+=i[u+l*o];while(--c);break}}if(i[t+l*t]!==0)for(o=t+1;o<a;o++){var f=i[t+l*o]/i[t+l*t];c=h;do u=h-c,i[u+l*o]=u<=t?0:i[u+l*o]-i[u+l*t]*f;while(--c)}}while(--n);t=2;do{o=t-1;do{var f=i[t+l*o]/i[t+l*t];c=l;do u=l-c,i[u+l*o]=i[u+l*o]-i[u+l*t]*f;while(--c)}while(o--)}while(--t);t=2;do{var f=1/i[t+l*t];c=l;do u=l-c,i[u+l*t]=i[u+l*t]*f;while(--c)}while(t--);t=2;do{o=2;do{if(u=i[r+o+l*t],isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";s.e(t,o,u)}while(o--)}while(t--);return s},e.prototype.setRotationFromQuaternion=function(s){var r=s.x,l=s.y,i=s.z,t=s.w,o=r+r,n=l+l,a=i+i,c=r*o,h=r*n,u=r*a,f=l*n,x=l*a,d=i*a,b=t*o,G=t*n,at=t*a,V=this.elements;return V[3*0+0]=1-(f+d),V[3*0+1]=h-at,V[3*0+2]=u+G,V[3*1+0]=h+at,V[3*1+1]=1-(c+d),V[3*1+2]=x-b,V[3*2+0]=u-G,V[3*2+1]=x+b,V[3*2+2]=1-(c+f),this},e.prototype.transpose=function(s){s=s||new e;for(var r=s.elements,l=this.elements,i=0;i!==3;i++)for(var t=0;t!==3;t++)r[3*i+t]=l[3*t+i];return s}},{"./Vec3":30}],28:[function(v,I,ct){I.exports=e;var p=v("./Vec3");function e(o,n,a,c){this.x=o!==void 0?o:0,this.y=n!==void 0?n:0,this.z=a!==void 0?a:0,this.w=c!==void 0?c:1}e.prototype.set=function(o,n,a,c){this.x=o,this.y=n,this.z=a,this.w=c},e.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.setFromAxisAngle=function(o,n){var a=Math.sin(n*.5);this.x=o.x*a,this.y=o.y*a,this.z=o.z*a,this.w=Math.cos(n*.5)},e.prototype.toAxisAngle=function(o){o=o||new p,this.normalize();var n=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return a<.001?(o.x=this.x,o.y=this.y,o.z=this.z):(o.x=this.x/a,o.y=this.y/a,o.z=this.z/a),[o,n]};var s=new p,r=new p;e.prototype.setFromVectors=function(o,n){if(o.isAntiparallelTo(n)){var a=s,c=r;o.tangents(a,c),this.setFromAxisAngle(a,Math.PI)}else{var h=o.cross(n);this.x=h.x,this.y=h.y,this.z=h.z,this.w=Math.sqrt(Math.pow(o.norm(),2)*Math.pow(n.norm(),2))+o.dot(n),this.normalize()}};var l=new p,i=new p,t=new p;e.prototype.mult=function(o,n){n=n||new e;var a=this.w,c=l,h=i,u=t;return c.set(this.x,this.y,this.z),h.set(o.x,o.y,o.z),n.w=a*o.w-c.dot(h),c.cross(h,u),n.x=a*h.x+o.w*c.x+u.x,n.y=a*h.y+o.w*c.y+u.y,n.z=a*h.z+o.w*c.z+u.z,n},e.prototype.inverse=function(o){var n=this.x,a=this.y,c=this.z,h=this.w;o=o||new e,this.conjugate(o);var u=1/(n*n+a*a+c*c+h*h);return o.x*=u,o.y*=u,o.z*=u,o.w*=u,o},e.prototype.conjugate=function(o){return o=o||new e,o.x=-this.x,o.y=-this.y,o.z=-this.z,o.w=this.w,o},e.prototype.normalize=function(){var o=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);o===0?(this.x=0,this.y=0,this.z=0,this.w=0):(o=1/o,this.x*=o,this.y*=o,this.z*=o,this.w*=o)},e.prototype.normalizeFast=function(){var o=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;o===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=o,this.y*=o,this.z*=o,this.w*=o)},e.prototype.vmult=function(o,n){n=n||new p;var a=o.x,c=o.y,h=o.z,u=this.x,f=this.y,x=this.z,d=this.w,b=d*a+f*h-x*c,G=d*c+x*a-u*h,at=d*h+u*c-f*a,V=-u*a-f*c-x*h;return n.x=b*d+V*-u+G*-x-at*-f,n.y=G*d+V*-f+at*-u-b*-x,n.z=at*d+V*-x+b*-f-G*-u,n},e.prototype.copy=function(o){return this.x=o.x,this.y=o.y,this.z=o.z,this.w=o.w,this},e.prototype.toEuler=function(o,n){n=n||"YZX";var a,c,h,u=this.x,f=this.y,x=this.z,d=this.w;switch(n){case"YZX":var b=u*f+x*d;if(b>.499&&(a=2*Math.atan2(u,d),c=Math.PI/2,h=0),b<-.499&&(a=-2*Math.atan2(u,d),c=-Math.PI/2,h=0),isNaN(a)){var G=u*u,at=f*f,V=x*x;a=Math.atan2(2*f*d-2*u*x,1-2*at-2*V),c=Math.asin(2*b),h=Math.atan2(2*u*d-2*f*x,1-2*G-2*V)}break;default:throw new Error("Euler order "+n+" not supported yet.")}o.y=a,o.z=c,o.x=h},e.prototype.setFromEuler=function(o,n,a,c){c=c||"XYZ";var h=Math.cos(o/2),u=Math.cos(n/2),f=Math.cos(a/2),x=Math.sin(o/2),d=Math.sin(n/2),b=Math.sin(a/2);return c==="XYZ"?(this.x=x*u*f+h*d*b,this.y=h*d*f-x*u*b,this.z=h*u*b+x*d*f,this.w=h*u*f-x*d*b):c==="YXZ"?(this.x=x*u*f+h*d*b,this.y=h*d*f-x*u*b,this.z=h*u*b-x*d*f,this.w=h*u*f+x*d*b):c==="ZXY"?(this.x=x*u*f-h*d*b,this.y=h*d*f+x*u*b,this.z=h*u*b+x*d*f,this.w=h*u*f-x*d*b):c==="ZYX"?(this.x=x*u*f-h*d*b,this.y=h*d*f+x*u*b,this.z=h*u*b-x*d*f,this.w=h*u*f+x*d*b):c==="YZX"?(this.x=x*u*f+h*d*b,this.y=h*d*f+x*u*b,this.z=h*u*b-x*d*f,this.w=h*u*f-x*d*b):c==="XZY"&&(this.x=x*u*f-h*d*b,this.y=h*d*f-x*u*b,this.z=h*u*b+x*d*f,this.w=h*u*f+x*d*b),this},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(v,I,ct){var p=v("./Vec3"),e=v("./Quaternion");I.exports=s;function s(l){l=l||{},this.position=new p,l.position&&this.position.copy(l.position),this.quaternion=new e,l.quaternion&&this.quaternion.copy(l.quaternion)}var r=new e;s.pointToLocalFrame=function(l,i,t,n){var n=n||new p;return t.vsub(l,n),i.conjugate(r),r.vmult(n,n),n},s.prototype.pointToLocal=function(l,i){return s.pointToLocalFrame(this.position,this.quaternion,l,i)},s.pointToWorldFrame=function(l,i,t,n){var n=n||new p;return i.vmult(t,n),n.vadd(l,n),n},s.prototype.pointToWorld=function(l,i){return s.pointToWorldFrame(this.position,this.quaternion,l,i)},s.prototype.vectorToWorldFrame=function(l,t){var t=t||new p;return this.quaternion.vmult(l,t),t},s.vectorToWorldFrame=function(l,i,t){return l.vmult(i,t),t},s.vectorToLocalFrame=function(l,i,t,n){var n=n||new p;return i.w*=-1,i.vmult(t,n),i.w*=-1,n}},{"./Quaternion":28,"./Vec3":30}],30:[function(v,I,ct){I.exports=e;var p=v("./Mat3");function e(i,t,o){this.x=i||0,this.y=t||0,this.z=o||0}e.ZERO=new e(0,0,0),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.prototype.cross=function(i,t){var o=i.x,n=i.y,a=i.z,c=this.x,h=this.y,u=this.z;return t=t||new e,t.x=h*a-u*n,t.y=u*o-c*a,t.z=c*n-h*o,t},e.prototype.set=function(i,t,o){return this.x=i,this.y=t,this.z=o,this},e.prototype.setZero=function(){this.x=this.y=this.z=0},e.prototype.vadd=function(i,t){if(t)t.x=i.x+this.x,t.y=i.y+this.y,t.z=i.z+this.z;else return new e(this.x+i.x,this.y+i.y,this.z+i.z)},e.prototype.vsub=function(i,t){if(t)t.x=this.x-i.x,t.y=this.y-i.y,t.z=this.z-i.z;else return new e(this.x-i.x,this.y-i.y,this.z-i.z)},e.prototype.crossmat=function(){return new p([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.prototype.normalize=function(){var i=this.x,t=this.y,o=this.z,n=Math.sqrt(i*i+t*t+o*o);if(n>0){var a=1/n;this.x*=a,this.y*=a,this.z*=a}else this.x=0,this.y=0,this.z=0;return n},e.prototype.unit=function(i){i=i||new e;var t=this.x,o=this.y,n=this.z,a=Math.sqrt(t*t+o*o+n*n);return a>0?(a=1/a,i.x=t*a,i.y=o*a,i.z=n*a):(i.x=1,i.y=0,i.z=0),i},e.prototype.norm=function(){var i=this.x,t=this.y,o=this.z;return Math.sqrt(i*i+t*t+o*o)},e.prototype.length=e.prototype.norm,e.prototype.norm2=function(){return this.dot(this)},e.prototype.lengthSquared=e.prototype.norm2,e.prototype.distanceTo=function(i){var t=this.x,o=this.y,n=this.z,a=i.x,c=i.y,h=i.z;return Math.sqrt((a-t)*(a-t)+(c-o)*(c-o)+(h-n)*(h-n))},e.prototype.distanceSquared=function(i){var t=this.x,o=this.y,n=this.z,a=i.x,c=i.y,h=i.z;return(a-t)*(a-t)+(c-o)*(c-o)+(h-n)*(h-n)},e.prototype.mult=function(i,t){t=t||new e;var o=this.x,n=this.y,a=this.z;return t.x=i*o,t.y=i*n,t.z=i*a,t},e.prototype.scale=e.prototype.mult,e.prototype.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z},e.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.prototype.negate=function(i){return i=i||new e,i.x=-this.x,i.y=-this.y,i.z=-this.z,i};var s=new e,r=new e;e.prototype.tangents=function(i,t){var o=this.norm();if(o>0){var n=s,a=1/o;n.set(this.x*a,this.y*a,this.z*a);var c=r;Math.abs(n.x)<.9?(c.set(1,0,0),n.cross(c,i)):(c.set(0,1,0),n.cross(c,i)),n.cross(i,t)}else i.set(1,0,0),t.set(0,1,0)},e.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this},e.prototype.lerp=function(i,t,o){var n=this.x,a=this.y,c=this.z;o.x=n+(i.x-n)*t,o.y=a+(i.y-a)*t,o.z=c+(i.z-c)*t},e.prototype.almostEquals=function(i,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-i.x)>t||Math.abs(this.y-i.y)>t||Math.abs(this.z-i.z)>t)},e.prototype.almostZero=function(i){return i===void 0&&(i=1e-6),!(Math.abs(this.x)>i||Math.abs(this.y)>i||Math.abs(this.z)>i)};var l=new e;e.prototype.isAntiparallelTo=function(i,t){return this.negate(l),l.almostEquals(i,t)},e.prototype.clone=function(){return new e(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(v,I,ct){I.exports=t;var p=v("../utils/EventTarget");v("../shapes/Shape");var e=v("../math/Vec3"),s=v("../math/Mat3"),r=v("../math/Quaternion");v("../material/Material");var l=v("../collision/AABB"),i=v("../shapes/Box");function t(B){B=B||{},p.apply(this),this.id=t.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup=typeof B.collisionFilterGroup=="number"?B.collisionFilterGroup:1,this.collisionFilterMask=typeof B.collisionFilterMask=="number"?B.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,B.position&&this.position.copy(B.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,B.velocity&&this.velocity.copy(B.velocity),this.initVelocity=new e,this.force=new e;var F=typeof B.mass=="number"?B.mass:0;this.mass=F,this.invMass=F>0?1/F:0,this.material=B.material||null,this.linearDamping=typeof B.linearDamping=="number"?B.linearDamping:.01,this.type=F<=0?t.STATIC:t.DYNAMIC,typeof B.type==typeof t.STATIC&&(this.type=B.type),this.allowSleep=typeof B.allowSleep<"u"?B.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof B.sleepSpeedLimit<"u"?B.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof B.sleepTimeLimit<"u"?B.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new r,B.quaternion&&this.quaternion.copy(B.quaternion),this.initQuaternion=new r,this.angularVelocity=new e,B.angularVelocity&&this.angularVelocity.copy(B.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new s,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new s,this.fixedRotation=typeof B.fixedRotation<"u"?B.fixedRotation:!1,this.angularDamping=typeof B.angularDamping<"u"?B.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new e,B.shape&&this.addShape(B.shape),this.updateMassProperties()}t.prototype=new p,t.prototype.constructor=t,t.DYNAMIC=1,t.STATIC=2,t.KINEMATIC=4,t.AWAKE=0,t.SLEEPY=1,t.SLEEPING=2,t.idCounter=0,t.prototype.wakeUp=function(){var B=this.sleepState;this.sleepState=0,B===t.SLEEPING&&this.dispatchEvent({type:"wakeup"})},t.prototype.sleep=function(){this.sleepState=t.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},t.sleepyEvent={type:"sleepy"},t.sleepEvent={type:"sleep"},t.prototype.sleepTick=function(B){if(this.allowSleep){var F=this.sleepState,T=this.velocity.norm2()+this.angularVelocity.norm2(),j=Math.pow(this.sleepSpeedLimit,2);F===t.AWAKE&&T<j?(this.sleepState=t.SLEEPY,this.timeLastSleepy=B,this.dispatchEvent(t.sleepyEvent)):F===t.SLEEPY&&T>j?this.wakeUp():F===t.SLEEPY&&B-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(t.sleepEvent))}},t.prototype.updateSolveMassProperties=function(){this.sleepState===t.SLEEPING||this.type===t.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},t.prototype.pointToLocalFrame=function(B,T){var T=T||new e;return B.vsub(this.position,T),this.quaternion.conjugate().vmult(T,T),T},t.prototype.vectorToLocalFrame=function(B,T){var T=T||new e;return this.quaternion.conjugate().vmult(B,T),T},t.prototype.pointToWorldFrame=function(B,T){var T=T||new e;return this.quaternion.vmult(B,T),T.vadd(this.position,T),T},t.prototype.vectorToWorldFrame=function(B,T){var T=T||new e;return this.quaternion.vmult(B,T),T};var o=new e,n=new r;t.prototype.addShape=function(B,F,T){var j=new e,K=new r;return F&&j.copy(F),T&&K.copy(T),this.shapes.push(B),this.shapeOffsets.push(j),this.shapeOrientations.push(K),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},t.prototype.updateBoundingRadius=function(){for(var B=this.shapes,F=this.shapeOffsets,T=B.length,j=0,K=0;K!==T;K++){var pt=B[K];pt.updateBoundingSphereRadius();var M=F[K].norm(),E=pt.boundingSphereRadius;M+E>j&&(j=M+E)}this.boundingRadius=j};var a=new l;t.prototype.computeAABB=function(){for(var B=this.shapes,F=this.shapeOffsets,T=this.shapeOrientations,j=B.length,K=o,pt=n,M=this.quaternion,E=this.aabb,_=a,O=0;O!==j;O++){var g=B[O];T[O].mult(M,pt),pt.vmult(F[O],K),K.vadd(this.position,K),g.calculateWorldAABB(K,pt,_.lowerBound,_.upperBound),O===0?E.copy(_):E.extend(_)}this.aabbNeedsUpdate=!1};var c=new s,h=new s;new s,t.prototype.updateInertiaWorld=function(B){var F=this.invInertia;if(!(F.x===F.y&&F.y===F.z&&!B)){var T=c,j=h;T.setRotationFromQuaternion(this.quaternion),T.transpose(j),T.scale(F,T),T.mmult(j,this.invInertiaWorld)}};var u=new e,f=new e;t.prototype.applyForce=function(B,F){if(this.type===t.DYNAMIC){var T=u;F.vsub(this.position,T);var j=f;T.cross(B,j),this.force.vadd(B,this.force),this.torque.vadd(j,this.torque)}};var x=new e,d=new e;t.prototype.applyLocalForce=function(B,F){if(this.type===t.DYNAMIC){var T=x,j=d;this.vectorToWorldFrame(B,T),this.pointToWorldFrame(F,j),this.applyForce(T,j)}};var b=new e,G=new e,at=new e;t.prototype.applyImpulse=function(B,F){if(this.type===t.DYNAMIC){var T=b;F.vsub(this.position,T);var j=G;j.copy(B),j.mult(this.invMass,j),this.velocity.vadd(j,this.velocity);var K=at;T.cross(B,K),this.invInertiaWorld.vmult(K,K),this.angularVelocity.vadd(K,this.angularVelocity)}};var V=new e,k=new e;t.prototype.applyLocalImpulse=function(B,F){if(this.type===t.DYNAMIC){var T=V,j=k;this.vectorToWorldFrame(B,T),this.pointToWorldFrame(F,j),this.applyImpulse(T,j)}};var R=new e;t.prototype.updateMassProperties=function(){var B=R;this.invMass=this.mass>0?1/this.mass:0;var F=this.inertia,T=this.fixedRotation;this.computeAABB(),B.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),i.calculateInertia(B,this.mass,F),this.invInertia.set(F.x>0&&!T?1/F.x:0,F.y>0&&!T?1/F.y:0,F.z>0&&!T?1/F.z:0),this.updateInertiaWorld(!0)},t.prototype.getVelocityAtWorldPoint=function(B,F){var T=new e;return B.vsub(this.position,T),this.angularVelocity.cross(T,F),this.velocity.vadd(F,F),F}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(v,I,ct){v("./Body");var p=v("../math/Vec3"),e=v("../math/Quaternion");v("../collision/RaycastResult");var s=v("../collision/Ray"),r=v("../objects/WheelInfo");I.exports=l;function l(M){this.chassisBody=M.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof M.indexRightAxis<"u"?M.indexRightAxis:1,this.indexForwardAxis=typeof M.indexForwardAxis<"u"?M.indexForwardAxis:0,this.indexUpAxis=typeof M.indexUpAxis<"u"?M.indexUpAxis:2}new p,new p,new p;var i=new p,t=new p,o=new p;new s,l.prototype.addWheel=function(M){M=M||{};var E=new r(M),_=this.wheelInfos.length;return this.wheelInfos.push(E),_},l.prototype.setSteeringValue=function(M,E){var _=this.wheelInfos[E];_.steering=M},new p,l.prototype.applyEngineForce=function(M,E){this.wheelInfos[E].engineForce=M},l.prototype.setBrake=function(M,E){this.wheelInfos[E].brake=M},l.prototype.addToWorld=function(M){this.constraints,M.add(this.chassisBody);var E=this;this.preStepCallback=function(){E.updateVehicle(M.dt)},M.addEventListener("preStep",this.preStepCallback),this.world=M},l.prototype.getVehicleAxisWorld=function(M,E){E.set(M===0?1:0,M===1?1:0,M===2?1:0),this.chassisBody.vectorToWorldFrame(E,E)},l.prototype.updateVehicle=function(M){for(var E=this.wheelInfos,_=E.length,O=this.chassisBody,g=0;g<_;g++)this.updateWheelTransform(g);this.currentVehicleSpeedKmHour=3.6*O.velocity.norm();var z=new p;this.getVehicleAxisWorld(this.indexForwardAxis,z),z.dot(O.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var g=0;g<_;g++)this.castRay(E[g]);this.updateSuspension(M);for(var w=new p,m=new p,g=0;g<_;g++){var y=E[g],C=y.suspensionForce;C>y.maxSuspensionForce&&(C=y.maxSuspensionForce),y.raycastResult.hitNormalWorld.scale(C*M,w),y.raycastResult.hitPointWorld.vsub(O.position,m),O.applyImpulse(w,y.raycastResult.hitPointWorld)}this.updateFriction(M);var H=new p,W=new p,A=new p;for(g=0;g<_;g++){var y=E[g];O.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,A);var L=1;switch(this.indexUpAxis){case 1:L=-1;break}if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,W);var X=W.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(X,H),W.vsub(H,W);var ut=W.dot(A);y.deltaRotation=L*ut*M/y.radius}(y.sliding||!y.isInContact)&&y.engineForce!==0&&y.useCustomSlidingRotationalSpeed&&(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*M),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},l.prototype.updateSuspension=function(M){for(var E=this.chassisBody,_=E.mass,O=this.wheelInfos,g=O.length,z=0;z<g;z++){var w=O[z];if(w.isInContact){var m,y=w.suspensionRestLength,C=w.suspensionLength,H=y-C;m=w.suspensionStiffness*H*w.clippedInvContactDotSuspension;var W=w.suspensionRelativeVelocity,A;W<0?A=w.dampingCompression:A=w.dampingRelaxation,m-=A*W,w.suspensionForce=m*_,w.suspensionForce<0&&(w.suspensionForce=0)}else w.suspensionForce=0}},l.prototype.removeFromWorld=function(M){this.constraints,M.remove(this.chassisBody),M.removeEventListener("preStep",this.preStepCallback),this.world=null};var n=new p,a=new p;l.prototype.castRay=function(M){var E=n,_=a;this.updateWheelTransformWorld(M);var O=this.chassisBody,g=-1,z=M.suspensionRestLength+M.radius;M.directionWorld.scale(z,E);var w=M.chassisConnectionPointWorld;w.vadd(E,_);var m=M.raycastResult;m.reset();var y=O.collisionResponse;O.collisionResponse=!1,this.world.rayTest(w,_,m),O.collisionResponse=y;var C=m.body;if(M.raycastResult.groundObject=0,C){g=m.distance,M.raycastResult.hitNormalWorld=m.hitNormalWorld,M.isInContact=!0;var H=m.distance;M.suspensionLength=H-M.radius;var W=M.suspensionRestLength-M.maxSuspensionTravel,A=M.suspensionRestLength+M.maxSuspensionTravel;M.suspensionLength<W&&(M.suspensionLength=W),M.suspensionLength>A&&(M.suspensionLength=A,M.raycastResult.reset());var L=M.raycastResult.hitNormalWorld.dot(M.directionWorld),X=new p;O.getVelocityAtWorldPoint(M.raycastResult.hitPointWorld,X);var ut=M.raycastResult.hitNormalWorld.dot(X);if(L>=-.1)M.suspensionRelativeVelocity=0,M.clippedInvContactDotSuspension=1/.1;else{var st=-1/L;M.suspensionRelativeVelocity=ut*st,M.clippedInvContactDotSuspension=st}}else M.suspensionLength=M.suspensionRestLength+0*M.maxSuspensionTravel,M.suspensionRelativeVelocity=0,M.directionWorld.scale(-1,M.raycastResult.hitNormalWorld),M.clippedInvContactDotSuspension=1;return g},l.prototype.updateWheelTransformWorld=function(M){M.isInContact=!1;var E=this.chassisBody;E.pointToWorldFrame(M.chassisConnectionPointLocal,M.chassisConnectionPointWorld),E.vectorToWorldFrame(M.directionLocal,M.directionWorld),E.vectorToWorldFrame(M.axleLocal,M.axleWorld)},l.prototype.updateWheelTransform=function(M){var E=i,_=t,O=o,g=this.wheelInfos[M];this.updateWheelTransformWorld(g),g.directionLocal.scale(-1,E),_.copy(g.axleLocal),E.cross(_,O),O.normalize(),_.normalize();var z=g.steering,w=new e;w.setFromAxisAngle(E,z);var m=new e;m.setFromAxisAngle(_,g.rotation);var y=g.worldTransform.quaternion;this.chassisBody.quaternion.mult(w,y),y.mult(m,y),y.normalize();var C=g.worldTransform.position;C.copy(g.directionWorld),C.scale(g.suspensionLength,C),C.vadd(g.chassisConnectionPointWorld,C)};var c=[new p(1,0,0),new p(0,1,0),new p(0,0,1)];l.prototype.getWheelTransformWorld=function(M){return this.wheelInfos[M].worldTransform};var h=new p,u=[],f=[],x=1;l.prototype.updateFriction=function(M){for(var E=h,_=this.wheelInfos,O=_.length,g=this.chassisBody,z=f,w=u,m=0;m<O;m++){var y=_[m],C=y.raycastResult.body;y.sideImpulse=0,y.forwardImpulse=0,z[m]||(z[m]=new p),w[m]||(w[m]=new p)}for(var m=0;m<O;m++){var y=_[m],C=y.raycastResult.body;if(C){var H=w[m],W=this.getWheelTransformWorld(m);W.vectorToWorldFrame(c[this.indexRightAxis],H);var A=y.raycastResult.hitNormalWorld,L=H.dot(A);A.scale(L,E),H.vsub(E,H),H.normalize(),A.cross(H,z[m]),z[m].normalize(),y.sideImpulse=pt(g,y.raycastResult.hitPointWorld,C,y.raycastResult.hitPointWorld,H),y.sideImpulse*=x}}var X=1,ut=.5;this.sliding=!1;for(var m=0;m<O;m++){var y=_[m],C=y.raycastResult.body,st=0;if(y.slipInfo=1,C){var nt=0,q=y.brake?y.brake:nt;st=at(g,C,y.raycastResult.hitPointWorld,z[m],q),st+=y.engineForce*M;var Q=q/st;y.slipInfo*=Q}if(y.forwardImpulse=0,y.skidInfo=1,C){y.skidInfo=1;var bt=y.suspensionForce*M*y.frictionSlip,dt=bt,Mt=bt*dt;y.forwardImpulse=st;var ht=y.forwardImpulse*ut,St=y.sideImpulse*X,zt=ht*ht+St*St;if(y.sliding=!1,zt>Mt){this.sliding=!0,y.sliding=!0;var Q=bt/Math.sqrt(zt);y.skidInfo*=Q}}}if(this.sliding)for(var m=0;m<O;m++){var y=_[m];y.sideImpulse!==0&&y.skidInfo<1&&(y.forwardImpulse*=y.skidInfo,y.sideImpulse*=y.skidInfo)}for(var m=0;m<O;m++){var y=_[m],Rt=new p;if(Rt.copy(y.raycastResult.hitPointWorld),y.forwardImpulse!==0){var Vt=new p;z[m].scale(y.forwardImpulse,Vt),g.applyImpulse(Vt,Rt)}if(y.sideImpulse!==0){var C=y.raycastResult.body,Et=new p;Et.copy(y.raycastResult.hitPointWorld);var Tt=new p;w[m].scale(y.sideImpulse,Tt),g.pointToLocalFrame(Rt,Rt),Rt["xyz"[this.indexUpAxis]]*=y.rollInfluence,g.pointToWorldFrame(Rt,Rt),g.applyImpulse(Tt,Rt),Tt.scale(-1,Tt),C.applyImpulse(Tt,Et)}}};var d=new p,b=new p,G=new p;function at(M,E,_,O,g){var z=0,w=_,m=d,y=b,C=G;M.getVelocityAtWorldPoint(w,m),E.getVelocityAtWorldPoint(w,y),m.vsub(y,C);var H=O.dot(C),W=F(M,_,O),A=F(E,_,O),L=1,X=L/(W+A);return z=-H*X,g<z&&(z=g),z<-g&&(z=-g),z}var V=new p,k=new p,R=new p,B=new p;function F(M,E,_){var O=V,g=k,z=R,w=B;return E.vsub(M.position,O),O.cross(_,g),M.invInertiaWorld.vmult(g,w),w.cross(O,z),M.invMass+_.dot(z)}var T=new p,j=new p,K=new p;function pt(M,E,_,O,g,L){var w=g.norm2();if(w>1.1)return 0;var m=T,y=j,C=K;M.getVelocityAtWorldPoint(E,m),_.getVelocityAtWorldPoint(O,y),m.vsub(y,C);var H=g.dot(C),W=.2,A=1/(M.invMass+_.invMass),L=-W*H*A;return L}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(v,I,ct){var p=v("./Body"),e=v("../shapes/Sphere"),s=v("../shapes/Box"),r=v("../math/Vec3"),l=v("../constraints/HingeConstraint");I.exports=i;function i(n){if(this.wheelBodies=[],this.coordinateSystem=typeof n.coordinateSystem>"u"?new r(1,2,3):n.coordinateSystem.clone(),this.chassisBody=n.chassisBody,!this.chassisBody){var a=new s(new r(5,2,.5));this.chassisBody=new p(1,a)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}i.prototype.addWheel=function(n){n=n||{};var a=n.body;a||(a=new p(1,new e(1.2))),this.wheelBodies.push(a),this.wheelForces.push(0),new r;var c=typeof n.position<"u"?n.position.clone():new r,h=new r;this.chassisBody.pointToWorldFrame(c,h),a.position.set(h.x,h.y,h.z);var u=typeof n.axis<"u"?n.axis.clone():new r(0,1,0);this.wheelAxes.push(u);var f=new l(this.chassisBody,a,{pivotA:c,axisA:u,pivotB:r.ZERO,axisB:u,collideConnected:!1});return this.constraints.push(f),this.wheelBodies.length-1},i.prototype.setSteeringValue=function(n,a){var c=this.wheelAxes[a],h=Math.cos(n),u=Math.sin(n),f=c.x,x=c.y;this.constraints[a].axisA.set(h*f-u*x,u*f+h*x,0)},i.prototype.setMotorSpeed=function(n,a){var c=this.constraints[a];c.enableMotor(),c.motorTargetVelocity=n},i.prototype.disableMotor=function(n){var a=this.constraints[n];a.disableMotor()};var t=new r;i.prototype.setWheelForce=function(n,a){this.wheelForces[a]=n},i.prototype.applyWheelForce=function(n,a){var c=this.wheelAxes[a],h=this.wheelBodies[a],u=h.torque;c.scale(n,t),h.vectorToWorldFrame(t,t),u.vadd(t,u)},i.prototype.addToWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.add(c[h]);for(var h=0;h<a.length;h++)n.addConstraint(a[h]);n.addEventListener("preStep",this._update.bind(this))},i.prototype._update=function(){for(var n=this.wheelForces,a=0;a<n.length;a++)this.applyWheelForce(n[a],a)},i.prototype.removeFromWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.remove(c[h]);for(var h=0;h<a.length;h++)n.removeConstraint(a[h])};var o=new r;i.prototype.getWheelSpeed=function(n){var a=this.wheelAxes[n],c=this.wheelBodies[n],h=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(a,o),h.dot(o)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(v,I,ct){I.exports=e,v("../shapes/Shape");var p=v("../math/Vec3");v("../math/Quaternion"),v("../shapes/Particle"),v("../objects/Body"),v("../material/Material");function e(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.prototype.remove=function(a){var c=this.particles.indexOf(a);c!==-1&&(this.particles.splice(c,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var s=new p;e.prototype.getNeighbors=function(a,c){for(var h=this.particles.length,u=a.id,f=this.smoothingRadius*this.smoothingRadius,x=s,d=0;d!==h;d++){var b=this.particles[d];b.position.vsub(a.position,x),u!==b.id&&x.norm2()<f&&c.push(b)}};var r=new p,l=new p,i=new p,t=new p,o=new p,n=new p;e.prototype.update=function(){for(var a=this.particles.length,c=r,h=this.speedOfSound,u=this.eps,f=0;f!==a;f++){var x=this.particles[f],d=this.neighbors[f];d.length=0,this.getNeighbors(x,d),d.push(this.particles[f]);for(var b=d.length,G=0,at=0;at!==b;at++){x.position.vsub(d[at].position,c);var V=c.norm(),k=this.w(V);G+=d[at].mass*k}this.densities[f]=G,this.pressures[f]=h*h*(this.densities[f]-this.density)}for(var R=l,B=i,F=t,T=o,j=n,f=0;f!==a;f++){var K=this.particles[f];R.set(0,0,0),B.set(0,0,0);for(var pt,M,d=this.neighbors[f],b=d.length,at=0;at!==b;at++){var E=d[at];K.position.vsub(E.position,T);var _=T.norm();pt=-E.mass*(this.pressures[f]/(this.densities[f]*this.densities[f]+u)+this.pressures[at]/(this.densities[at]*this.densities[at]+u)),this.gradw(T,F),F.mult(pt,F),R.vadd(F,R),E.velocity.vsub(K.velocity,j),j.mult(1/(1e-4+this.densities[f]*this.densities[at])*this.viscosity*E.mass,j),M=this.nablaw(_),j.mult(M,j),B.vadd(j,B)}B.mult(K.mass,B),R.mult(K.mass,R),K.force.vadd(B,K.force),K.force.vadd(R,K.force)}},e.prototype.w=function(a){var c=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(c,9))*Math.pow(c*c-a*a,3)},e.prototype.gradw=function(a,c){var h=a.norm(),u=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(u,9))*Math.pow(u*u-h*h,2),c)},e.prototype.nablaw=function(a){var c=this.smoothingRadius,h=945/(32*Math.PI*Math.pow(c,9))*(c*c-a*a)*(7*a*a-3*c*c);return h}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(v,I,ct){var p=v("../math/Vec3");I.exports=e;function e(f,x,d){d=d||{},this.restLength=typeof d.restLength=="number"?d.restLength:1,this.stiffness=d.stiffness||100,this.damping=d.damping||1,this.bodyA=f,this.bodyB=x,this.localAnchorA=new p,this.localAnchorB=new p,d.localAnchorA&&this.localAnchorA.copy(d.localAnchorA),d.localAnchorB&&this.localAnchorB.copy(d.localAnchorB),d.worldAnchorA&&this.setWorldAnchorA(d.worldAnchorA),d.worldAnchorB&&this.setWorldAnchorB(d.worldAnchorB)}e.prototype.setWorldAnchorA=function(f){this.bodyA.pointToLocalFrame(f,this.localAnchorA)},e.prototype.setWorldAnchorB=function(f){this.bodyB.pointToLocalFrame(f,this.localAnchorB)},e.prototype.getWorldAnchorA=function(f){this.bodyA.pointToWorldFrame(this.localAnchorA,f)},e.prototype.getWorldAnchorB=function(f){this.bodyB.pointToWorldFrame(this.localAnchorB,f)};var s=new p,r=new p,l=new p,i=new p,t=new p,o=new p,n=new p,a=new p,c=new p,h=new p,u=new p;e.prototype.applyForce=function(){var f=this.stiffness,x=this.damping,d=this.restLength,b=this.bodyA,G=this.bodyB,at=s,V=r,k=l,R=i,B=u,F=t,T=o,j=n,K=a,pt=c,M=h;this.getWorldAnchorA(F),this.getWorldAnchorB(T),F.vsub(b.position,j),T.vsub(G.position,K),T.vsub(F,at);var E=at.norm();V.copy(at),V.normalize(),G.velocity.vsub(b.velocity,k),G.angularVelocity.cross(K,B),k.vadd(B,k),b.angularVelocity.cross(j,B),k.vsub(B,k),V.mult(-f*(E-d)-x*k.dot(V),R),b.force.vsub(R,b.force),G.force.vadd(R,G.force),j.cross(R,pt),K.cross(R,M),b.torque.vsub(pt,b.torque),G.torque.vadd(M,G.torque)}},{"../math/Vec3":30}],36:[function(v,I,ct){var p=v("../math/Vec3"),e=v("../math/Transform"),s=v("../collision/RaycastResult"),r=v("../utils/Utils");I.exports=l;function l(o){o=r.defaults(o,{chassisConnectionPointLocal:new p,chassisConnectionPointWorld:new p,directionLocal:new p,directionWorld:new p,axleLocal:new p,axleWorld:new p,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=o.maxSuspensionTravel,this.customSlidingRotationalSpeed=o.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=o.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=o.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=o.chassisConnectionPointWorld.clone(),this.directionLocal=o.directionLocal.clone(),this.directionWorld=o.directionWorld.clone(),this.axleLocal=o.axleLocal.clone(),this.axleWorld=o.axleWorld.clone(),this.suspensionRestLength=o.suspensionRestLength,this.suspensionMaxLength=o.suspensionMaxLength,this.radius=o.radius,this.suspensionStiffness=o.suspensionStiffness,this.dampingCompression=o.dampingCompression,this.dampingRelaxation=o.dampingRelaxation,this.frictionSlip=o.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=o.rollInfluence,this.maxSuspensionForce=o.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=o.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new s,this.worldTransform=new e,this.isInContact=!1}var t=new p,i=new p,t=new p;l.prototype.updateWheel=function(o){var n=this.raycastResult;if(this.isInContact){var a=n.hitNormalWorld.dot(n.directionWorld);n.hitPointWorld.vsub(o.position,i),o.getVelocityAtWorldPoint(i,t);var c=n.hitNormalWorld.dot(t);if(a>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var h=-1/a;this.suspensionRelativeVelocity=c*h,this.clippedInvContactDotSuspension=h}}else n.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,n.directionWorld.scale(-1,n.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(v,I,ct){I.exports=r;var p=v("./Shape"),e=v("../math/Vec3"),s=v("./ConvexPolyhedron");function r(t){p.call(this),this.type=p.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,o=this.halfExtents.y,n=this.halfExtents.z,a=e,c=[new a(-t,-o,-n),new a(t,-o,-n),new a(t,o,-n),new a(-t,o,-n),new a(-t,-o,n),new a(t,-o,n),new a(t,o,n),new a(-t,o,n)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new a(0,0,1),new a(0,1,0),new a(1,0,0);var u=new s(c,h);this.convexPolyhedronRepresentation=u,u.material=this.material},r.prototype.calculateLocalInertia=function(t,o){return o=o||new e,r.calculateInertia(this.halfExtents,t,o),o},r.calculateInertia=function(t,o,n){var a=t;n.x=1/12*o*(2*a.y*2*a.y+2*a.z*2*a.z),n.y=1/12*o*(2*a.x*2*a.x+2*a.z*2*a.z),n.z=1/12*o*(2*a.y*2*a.y+2*a.x*2*a.x)},r.prototype.getSideNormals=function(t,o){var n=t,a=this.halfExtents;if(n[0].set(a.x,0,0),n[1].set(0,a.y,0),n[2].set(0,0,a.z),n[3].set(-a.x,0,0),n[4].set(0,-a.y,0),n[5].set(0,0,-a.z),o!==void 0)for(var c=0;c!==n.length;c++)o.vmult(n[c],n[c]);return n},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new e;new e,r.prototype.forEachWorldCorner=function(t,o,n){for(var a=this.halfExtents,c=[[a.x,a.y,a.z],[-a.x,a.y,a.z],[-a.x,-a.y,a.z],[-a.x,-a.y,-a.z],[a.x,-a.y,-a.z],[a.x,a.y,-a.z],[-a.x,a.y,-a.z],[a.x,-a.y,a.z]],h=0;h<c.length;h++)l.set(c[h][0],c[h][1],c[h][2]),o.vmult(l,l),t.vadd(l,l),n(l.x,l.y,l.z)};var i=[new e,new e,new e,new e,new e,new e,new e,new e];r.prototype.calculateWorldAABB=function(t,o,n,a){var c=this.halfExtents;i[0].set(c.x,c.y,c.z),i[1].set(-c.x,c.y,c.z),i[2].set(-c.x,-c.y,c.z),i[3].set(-c.x,-c.y,-c.z),i[4].set(c.x,-c.y,-c.z),i[5].set(c.x,c.y,-c.z),i[6].set(-c.x,c.y,-c.z),i[7].set(c.x,-c.y,c.z);var h=i[0];o.vmult(h,h),t.vadd(h,h),a.copy(h),n.copy(h);for(var u=1;u<8;u++){var h=i[u];o.vmult(h,h),t.vadd(h,h);var f=h.x,x=h.y,d=h.z;f>a.x&&(a.x=f),x>a.y&&(a.y=x),d>a.z&&(a.z=d),f<n.x&&(n.x=f),x<n.y&&(n.y=x),d<n.z&&(n.z=d)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(v,I,ct){I.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform");function r(g,z,w){p.call(this),this.type=p.types.CONVEXPOLYHEDRON,this.vertices=g||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=z||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=w?w.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r;var l=new e;r.prototype.computeEdges=function(){var g=this.faces,z=this.vertices;z.length;var w=this.uniqueEdges;w.length=0;for(var m=l,y=0;y!==g.length;y++)for(var C=g[y],H=C.length,W=0;W!==H;W++){var A=(W+1)%H;z[C[W]].vsub(z[C[A]],m),m.normalize();for(var L=!1,X=0;X!==w.length;X++)if(w[X].almostEquals(m)||w[X].almostEquals(m)){L=!0;break}L||w.push(m.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var g=0;g<this.faces.length;g++){for(var z=0;z<this.faces[g].length;z++)if(!this.vertices[this.faces[g][z]])throw new Error("Vertex "+this.faces[g][z]+" not found!");var w=this.faceNormals[g]||new e;this.getFaceNormal(g,w),w.negate(w),this.faceNormals[g]=w;var m=this.vertices[this.faces[g][0]];if(w.dot(m)<0){console.error(".faceNormals["+g+"] = Vec3("+w.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var z=0;z<this.faces[g].length;z++)console.warn(".vertices["+this.faces[g][z]+"] = Vec3("+this.vertices[this.faces[g][z]].toString()+")")}}};var i=new e,t=new e;r.computeNormal=function(g,z,w,m){z.vsub(g,t),w.vsub(z,i),i.cross(t,m),m.isZero()||m.normalize()},r.prototype.getFaceNormal=function(g,z){var w=this.faces[g],m=this.vertices[w[0]],y=this.vertices[w[1]],C=this.vertices[w[2]];return r.computeNormal(m,y,C,z)};var o=new e;r.prototype.clipAgainstHull=function(g,z,w,m,y,C,H,W,A){for(var L=o,X=-1,ut=-Number.MAX_VALUE,st=0;st<w.faces.length;st++){L.copy(w.faceNormals[st]),y.vmult(L,L);var nt=L.dot(C);nt>ut&&(ut=nt,X=st)}for(var q=[],Q=w.faces[X],bt=Q.length,dt=0;dt<bt;dt++){var Mt=w.vertices[Q[dt]],ht=new e;ht.copy(Mt),y.vmult(ht,ht),m.vadd(ht,ht),q.push(ht)}X>=0&&this.clipFaceAgainstHull(C,g,z,q,H,W,A)};var n=new e,a=new e,c=new e,h=new e,u=new e,f=new e;r.prototype.findSeparatingAxis=function(g,z,w,m,y,C,H,W){var A=n,L=a,X=c,ut=h,st=u,nt=f,q=Number.MAX_VALUE,Q=this;if(Q.uniqueAxes)for(var dt=0;dt!==Q.uniqueAxes.length;dt++){w.vmult(Q.uniqueAxes[dt],A);var ht=Q.testSepAxis(A,g,z,w,m,y);if(ht===!1)return!1;ht<q&&(q=ht,C.copy(A))}else for(var bt=H?H.length:Q.faces.length,dt=0;dt<bt;dt++){var Mt=H?H[dt]:dt;A.copy(Q.faceNormals[Mt]),w.vmult(A,A);var ht=Q.testSepAxis(A,g,z,w,m,y);if(ht===!1)return!1;ht<q&&(q=ht,C.copy(A))}if(g.uniqueAxes)for(var dt=0;dt!==g.uniqueAxes.length;dt++){y.vmult(g.uniqueAxes[dt],L);var ht=Q.testSepAxis(L,g,z,w,m,y);if(ht===!1)return!1;ht<q&&(q=ht,C.copy(L))}else for(var St=W?W.length:g.faces.length,dt=0;dt<St;dt++){var Mt=W?W[dt]:dt;L.copy(g.faceNormals[Mt]),y.vmult(L,L);var ht=Q.testSepAxis(L,g,z,w,m,y);if(ht===!1)return!1;ht<q&&(q=ht,C.copy(L))}for(var zt=0;zt!==Q.uniqueEdges.length;zt++){w.vmult(Q.uniqueEdges[zt],ut);for(var Rt=0;Rt!==g.uniqueEdges.length;Rt++)if(y.vmult(g.uniqueEdges[Rt],st),ut.cross(st,nt),!nt.almostZero()){nt.normalize();var Vt=Q.testSepAxis(nt,g,z,w,m,y);if(Vt===!1)return!1;Vt<q&&(q=Vt,C.copy(nt))}}return m.vsub(z,X),X.dot(C)>0&&C.negate(C),!0};var x=[],d=[];r.prototype.testSepAxis=function(g,z,w,m,y,C){var H=this;r.project(H,g,w,m,x),r.project(z,g,y,C,d);var W=x[0],A=x[1],L=d[0],X=d[1],ut=W-X,st=L-A,nt=ut<st?ut:st;return nt};var b=new e,G=new e;r.prototype.calculateLocalInertia=function(g,z){this.computeLocalAABB(b,G);var w=G.x-b.x,m=G.y-b.y,y=G.z-b.z;z.x=1/12*g*(2*m*2*m+2*y*2*y),z.y=1/12*g*(2*w*2*w+2*y*2*y),z.z=1/12*g*(2*m*2*m+2*w*2*w)},r.prototype.getPlaneConstantOfFace=function(g){var z=this.faces[g],w=this.faceNormals[g],m=this.vertices[z[0]],y=-w.dot(m);return y};var at=new e,V=new e,k=new e,R=new e,B=new e,F=new e,T=new e,j=new e;r.prototype.clipFaceAgainstHull=function(g,z,w,m,y,C,H){for(var W=at,A=V,L=k,X=R,ut=B,st=F,nt=T,q=j,Q=this,bt=[],dt=m,Mt=bt,ht=-1,St=Number.MAX_VALUE,zt=0;zt<Q.faces.length;zt++){W.copy(Q.faceNormals[zt]),w.vmult(W,W);var Rt=W.dot(g);Rt<St&&(St=Rt,ht=zt)}if(!(ht<0)){var Vt=Q.faces[ht];Vt.connectedFaces=[];for(var Et=0;Et<Q.faces.length;Et++)for(var Tt=0;Tt<Q.faces[Et].length;Tt++)Vt.indexOf(Q.faces[Et][Tt])!==-1&&Et!==ht&&Vt.connectedFaces.indexOf(Et)===-1&&Vt.connectedFaces.push(Et);dt.length;for(var At=Vt.length,Wt=0;Wt<At;Wt++){var Gt=Q.vertices[Vt[Wt]],oe=Q.vertices[Vt[(Wt+1)%At]];Gt.vsub(oe,A),L.copy(A),w.vmult(L,L),z.vadd(L,L),X.copy(this.faceNormals[ht]),w.vmult(X,X),z.vadd(X,X),L.cross(X,ut),ut.negate(ut),st.copy(Gt),w.vmult(st,st),z.vadd(st,st),-st.dot(ut);var Qt;{var he=Vt.connectedFaces[Wt];nt.copy(this.faceNormals[he]);var re=this.getPlaneConstantOfFace(he);q.copy(nt),w.vmult(q,q);var Qt=re-q.dot(z)}for(this.clipFaceAgainstPlane(dt,Mt,q,Qt);dt.length;)dt.shift();for(;Mt.length;)dt.push(Mt.shift())}nt.copy(this.faceNormals[ht]);var re=this.getPlaneConstantOfFace(ht);q.copy(nt),w.vmult(q,q);for(var Qt=re-q.dot(z),Et=0;Et<dt.length;Et++){var Zt=q.dot(dt[Et])+Qt;if(Zt<=y&&(console.log("clamped: depth="+Zt+" to minDist="+(y+"")),Zt=y),Zt<=C){var ue=dt[Et];if(Zt<=0){var ce={point:ue,normal:q,depth:Zt};H.push(ce)}}}}},r.prototype.clipFaceAgainstPlane=function(g,z,w,m){var y,C,H=g.length;if(H<2)return z;var W=g[g.length-1],A=g[0];y=w.dot(W)+m;for(var L=0;L<H;L++){if(A=g[L],C=w.dot(A)+m,y<0)if(C<0){var X=new e;X.copy(A),z.push(X)}else{var X=new e;W.lerp(A,y/(y-C),X),z.push(X)}else if(C<0){var X=new e;W.lerp(A,y/(y-C),X),z.push(X),z.push(A)}W=A,y=C}return z},r.prototype.computeWorldVertices=function(g,z){for(var w=this.vertices.length;this.worldVertices.length<w;)this.worldVertices.push(new e);for(var m=this.vertices,y=this.worldVertices,C=0;C!==w;C++)z.vmult(m[C],y[C]),g.vadd(y[C],y[C]);this.worldVerticesNeedsUpdate=!1},new e,r.prototype.computeLocalAABB=function(g,z){var w=this.vertices.length,m=this.vertices;g.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),z.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var y=0;y<w;y++){var C=m[y];C.x<g.x?g.x=C.x:C.x>z.x&&(z.x=C.x),C.y<g.y?g.y=C.y:C.y>z.y&&(z.y=C.y),C.z<g.z?g.z=C.z:C.z>z.z&&(z.z=C.z)}},r.prototype.computeWorldFaceNormals=function(g){for(var z=this.faceNormals.length;this.worldFaceNormals.length<z;)this.worldFaceNormals.push(new e);for(var w=this.faceNormals,m=this.worldFaceNormals,y=0;y!==z;y++)g.vmult(w[y],m[y]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var g=0,z=this.vertices,w=0,m=z.length;w!==m;w++){var y=z[w].norm2();y>g&&(g=y)}this.boundingSphereRadius=Math.sqrt(g)};var K=new e;r.prototype.calculateWorldAABB=function(g,z,w,m){for(var y=this.vertices.length,C=this.vertices,H,W,A,L,X,ut,st=0;st<y;st++){K.copy(C[st]),z.vmult(K,K),g.vadd(K,K);var nt=K;nt.x<H||H===void 0?H=nt.x:(nt.x>L||L===void 0)&&(L=nt.x),nt.y<W||W===void 0?W=nt.y:(nt.y>X||X===void 0)&&(X=nt.y),nt.z<A||A===void 0?A=nt.z:(nt.z>ut||ut===void 0)&&(ut=nt.z)}w.set(H,W,A),m.set(L,X,ut)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(g){g=g||new e;for(var z=this.vertices.length,w=this.vertices,m=0;m<z;m++)g.vadd(w[m],g);return g.mult(1/z,g),g},r.prototype.transformAllPoints=function(g,z){var w=this.vertices.length,m=this.vertices;if(z){for(var y=0;y<w;y++){var C=m[y];z.vmult(C,C)}for(var y=0;y<this.faceNormals.length;y++){var C=this.faceNormals[y];z.vmult(C,C)}}if(g)for(var y=0;y<w;y++){var C=m[y];C.vadd(g,C)}};var pt=new e,M=new e,E=new e;r.prototype.pointIsInside=function(g){var z=this.vertices.length,w=this.vertices,m=this.faces,y=this.faceNormals,C=null,H=this.faces.length,W=pt;this.getAveragePointLocal(W);for(var A=0;A<H;A++){this.faces[A].length;var z=y[A],L=w[m[A][0]],X=M;g.vsub(L,X);var ut=z.dot(X),st=E;W.vsub(L,st);var nt=z.dot(st);if(ut<0&&nt>0||ut>0&&nt<0)return!1}return C?1:-1},new e;var _=new e,O=new e;r.project=function(g,z,w,m,y){var C=g.vertices.length,H=_,W=0,A=0,L=O,X=g.vertices;L.setZero(),s.vectorToLocalFrame(w,m,z,H),s.pointToLocalFrame(w,m,L,L);var ut=L.dot(H);A=W=X[0].dot(H);for(var st=1;st<C;st++){var nt=X[st].dot(H);nt>W&&(W=nt),nt<A&&(A=nt)}if(A-=ut,W-=ut,A>W){var q=A;A=W,W=q}y[0]=W,y[1]=A}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(v,I,ct){I.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("./ConvexPolyhedron");function r(l,i,t,o){var n=o,a=[],c=[],h=[],u=[],f=[],x=Math.cos,d=Math.sin;a.push(new e(i*x(0),i*d(0),-t*.5)),u.push(0),a.push(new e(l*x(0),l*d(0),t*.5)),f.push(1);for(var b=0;b<n;b++){var G=2*Math.PI/n*(b+1),at=2*Math.PI/n*(b+.5);b<n-1?(a.push(new e(i*x(G),i*d(G),-t*.5)),u.push(2*b+2),a.push(new e(l*x(G),l*d(G),t*.5)),f.push(2*b+3),h.push([2*b+2,2*b+3,2*b+1,2*b])):h.push([0,1,2*b+1,2*b]),(n%2===1||b<n/2)&&c.push(new e(x(at),d(at),0))}h.push(f),c.push(new e(0,0,1));for(var V=[],b=0;b<u.length;b++)V.push(u[u.length-b-1]);h.push(V),this.type=p.types.CONVEXPOLYHEDRON,s.call(this,a,h,c)}r.prototype=new s},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(v,I,ct){var p=v("./Shape"),e=v("./ConvexPolyhedron"),s=v("../math/Vec3"),r=v("../utils/Utils");I.exports=l;function l(i,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=i,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,t.minValue===null&&this.updateMinValue(),t.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,p.call(this),this.pillarConvex=new e,this.pillarOffset=new s,this.type=p.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}l.prototype=new p,l.prototype.update=function(){this._cachedPillars={}},l.prototype.updateMinValue=function(){for(var i=this.data,t=i[0][0],o=0;o!==i.length;o++)for(var n=0;n!==i[o].length;n++){var a=i[o][n];a<t&&(t=a)}this.minValue=t},l.prototype.updateMaxValue=function(){for(var i=this.data,t=i[0][0],o=0;o!==i.length;o++)for(var n=0;n!==i[o].length;n++){var a=i[o][n];a>t&&(t=a)}this.maxValue=t},l.prototype.setHeightValueAtIndex=function(i,t,o){var n=this.data;n[i][t]=o,this.clearCachedConvexTrianglePillar(i,t,!1),i>0&&(this.clearCachedConvexTrianglePillar(i-1,t,!0),this.clearCachedConvexTrianglePillar(i-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(i,t-1,!0),this.clearCachedConvexTrianglePillar(i,t-1,!1)),t>0&&i>0&&this.clearCachedConvexTrianglePillar(i-1,t-1,!0)},l.prototype.getRectMinMax=function(i,t,o,n,a){a=a||[];for(var c=this.data,h=this.minValue,u=i;u<=o;u++)for(var f=t;f<=n;f++){var x=c[u][f];x>h&&(h=x)}a[0]=this.minValue,a[1]=h},l.prototype.getIndexOfPosition=function(i,t,o,n){var a=this.elementSize,c=this.data,h=Math.floor(i/a),u=Math.floor(t/a);return o[0]=h,o[1]=u,n&&(h<0&&(h=0),u<0&&(u=0),h>=c.length-1&&(h=c.length-1),u>=c[0].length-1&&(u=c[0].length-1)),!(h<0||u<0||h>=c.length-1||u>=c[0].length-1)},l.prototype.getHeightAt=function(i,t,o){var n=[];this.getIndexOfPosition(i,t,n,o);var a=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,a),(a[0]+a[1])/2},l.prototype.getCacheConvexTrianglePillarKey=function(i,t,o){return i+"_"+t+"_"+(o?1:0)},l.prototype.getCachedConvexTrianglePillar=function(i,t,o){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(i,t,o)]},l.prototype.setCachedConvexTrianglePillar=function(i,t,o,n,a){this._cachedPillars[this.getCacheConvexTrianglePillarKey(i,t,o)]={convex:n,offset:a}},l.prototype.clearCachedConvexTrianglePillar=function(i,t,o){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(i,t,o)]},l.prototype.getConvexTrianglePillar=function(i,t,o){var n=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){var c=this.getCachedConvexTrianglePillar(i,t,o);if(c){this.pillarConvex=c.convex,this.pillarOffset=c.offset;return}n=new e,a=new s,this.pillarConvex=n,this.pillarOffset=a}var c=this.data,h=this.elementSize,u=n.faces;n.vertices.length=6;for(var f=0;f<6;f++)n.vertices[f]||(n.vertices[f]=new s);u.length=5;for(var f=0;f<5;f++)u[f]||(u[f]=[]);var x=n.vertices,d=(Math.min(c[i][t],c[i+1][t],c[i][t+1],c[i+1][t+1])-this.minValue)/2+this.minValue;o?(a.set((i+.75)*h,(t+.75)*h,d),x[0].set(.25*h,.25*h,c[i+1][t+1]-d),x[1].set(-.75*h,.25*h,c[i][t+1]-d),x[2].set(.25*h,-.75*h,c[i+1][t]-d),x[3].set(.25*h,.25*h,-d-1),x[4].set(-.75*h,.25*h,-d-1),x[5].set(.25*h,-.75*h,-d-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((i+.25)*h,(t+.25)*h,d),x[0].set(-.25*h,-.25*h,c[i][t]-d),x[1].set(.75*h,-.25*h,c[i+1][t]-d),x[2].set(-.25*h,.75*h,c[i][t+1]-d),x[3].set(-.25*h,-.25*h,-d-1),x[4].set(.75*h,-.25*h,-d-1),x[5].set(-.25*h,.75*h,-d-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(i,t,o,n,a)},l.prototype.calculateLocalInertia=function(i,t){return t=t||new s,t.set(0,0,0),t},l.prototype.volume=function(){return Number.MAX_VALUE},l.prototype.calculateWorldAABB=function(i,t,o,n){o.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},l.prototype.updateBoundingSphereRadius=function(){var i=this.data,t=this.elementSize;this.boundingSphereRadius=new s(i.length*t,i[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(v,I,ct){I.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PARTICLE}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){return l=l||new e,l.set(0,0,0),l},s.prototype.volume=function(){return 0},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},s.prototype.calculateWorldAABB=function(r,l,i,t){i.copy(r),t.copy(r)}},{"../math/Vec3":30,"./Shape":43}],42:[function(v,I,ct){I.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}s.prototype=new p,s.prototype.constructor=s,s.prototype.computeWorldNormal=function(l){var i=this.worldNormal;i.set(0,0,1),l.vmult(i,i),this.worldNormalNeedsUpdate=!1},s.prototype.calculateLocalInertia=function(l,i){return i=i||new e,i},s.prototype.volume=function(){return Number.MAX_VALUE};var r=new e;s.prototype.calculateWorldAABB=function(l,i,t,o){r.set(0,0,1),i.vmult(r,r);var n=Number.MAX_VALUE;t.set(-n,-n,-n),o.set(n,n,n),r.x===1&&(o.x=l.x),r.y===1&&(o.y=l.y),r.z===1&&(o.z=l.z),r.x===-1&&(t.x=l.x),r.y===-1&&(t.y=l.y),r.z===-1&&(t.z=l.z)},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(v,I,ct){I.exports=p;var p=v("./Shape");v("../math/Vec3"),v("../math/Quaternion"),v("../material/Material");function p(){this.id=p.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}p.prototype.constructor=p,p.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},p.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},p.prototype.calculateLocalInertia=function(e,s){throw"calculateLocalInertia() not implemented for shape type "+this.type},p.idCounter=0,p.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(v,I,ct){I.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(r){if(p.call(this),this.radius=r!==void 0?Number(r):1,this.type=p.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){l=l||new e;var i=2*r*this.radius*this.radius/5;return l.x=i,l.y=i,l.z=i,l},s.prototype.volume=function(){return 4*Math.PI*this.radius/3},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},s.prototype.calculateWorldAABB=function(r,l,i,t){for(var o=this.radius,n=["x","y","z"],a=0;a<n.length;a++){var c=n[a];i[c]=r[c]-o,t[c]=r[c]+o}}},{"../math/Vec3":30,"./Shape":43}],45:[function(v,I,ct){I.exports=i;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform"),r=v("../collision/AABB"),l=v("../utils/Octree");function i(V,k){p.call(this),this.type=p.types.TRIMESH,this.vertices=new Float32Array(V),this.indices=new Int16Array(k),this.normals=new Float32Array(k.length),this.aabb=new r,this.edges=null,this.scale=new e(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}i.prototype=new p,i.prototype.constructor=i;var t=new e;i.prototype.updateTree=function(){var V=this.tree;V.reset(),V.aabb.copy(this.aabb);var k=this.scale;V.aabb.lowerBound.x*=1/k.x,V.aabb.lowerBound.y*=1/k.y,V.aabb.lowerBound.z*=1/k.z,V.aabb.upperBound.x*=1/k.x,V.aabb.upperBound.y*=1/k.y,V.aabb.upperBound.z*=1/k.z;for(var R=new r,B=new e,F=new e,T=new e,j=[B,F,T],K=0;K<this.indices.length/3;K++){var pt=K*3;this._getUnscaledVertex(this.indices[pt],B),this._getUnscaledVertex(this.indices[pt+1],F),this._getUnscaledVertex(this.indices[pt+2],T),R.setFromPoints(j),V.insert(R,K)}V.removeEmptyNodes()};var o=new r;i.prototype.getTrianglesInAABB=function(V,k){o.copy(V);var R=this.scale,B=R.x,F=R.y,T=R.z,j=o.lowerBound,K=o.upperBound;return j.x/=B,j.y/=F,j.z/=T,K.x/=B,K.y/=F,K.z/=T,this.tree.aabbQuery(o,k)},i.prototype.setScale=function(V){var k=this.scale.x===this.scale.y===this.scale.z,R=V.x===V.y===V.z;k&&R||this.updateNormals(),this.scale.copy(V),this.updateAABB(),this.updateBoundingSphereRadius()},i.prototype.updateNormals=function(){for(var V=t,k=this.normals,R=0;R<this.indices.length/3;R++){var B=R*3,F=this.indices[B],T=this.indices[B+1],j=this.indices[B+2];this.getVertex(F,u),this.getVertex(T,f),this.getVertex(j,x),i.computeNormal(f,u,x,V),k[B]=V.x,k[B+1]=V.y,k[B+2]=V.z}},i.prototype.updateEdges=function(){for(var V={},k=function(pt,M){var E=F<T?F+"_"+T:T+"_"+F;V[E]=!0},R=0;R<this.indices.length/3;R++){var B=R*3,F=this.indices[B],T=this.indices[B+1];this.indices[B+2],k(),k(),k()}var j=Object.keys(V);this.edges=new Int16Array(j.length*2);for(var R=0;R<j.length;R++){var K=j[R].split("_");this.edges[2*R]=parseInt(K[0],10),this.edges[2*R+1]=parseInt(K[1],10)}},i.prototype.getEdgeVertex=function(V,k,R){var B=this.edges[V*2+(k?1:0)];this.getVertex(B,R)};var n=new e,a=new e;i.prototype.getEdgeVector=function(V,k){var R=n,B=a;this.getEdgeVertex(V,0,R),this.getEdgeVertex(V,1,B),B.vsub(R,k)};var c=new e,h=new e;i.computeNormal=function(V,k,R,B){k.vsub(V,h),R.vsub(k,c),c.cross(h,B),B.isZero()||B.normalize()};var u=new e,f=new e,x=new e;i.prototype.getVertex=function(V,k){var R=this.scale;return this._getUnscaledVertex(V,k),k.x*=R.x,k.y*=R.y,k.z*=R.z,k},i.prototype._getUnscaledVertex=function(V,k){var R=V*3,B=this.vertices;return k.set(B[R],B[R+1],B[R+2])},i.prototype.getWorldVertex=function(V,k,R,B){return this.getVertex(V,B),s.pointToWorldFrame(k,R,B,B),B},i.prototype.getTriangleVertices=function(V,k,R,B){var F=V*3;this.getVertex(this.indices[F],k),this.getVertex(this.indices[F+1],R),this.getVertex(this.indices[F+2],B)},i.prototype.getNormal=function(V,k){var R=V*3;return k.set(this.normals[R],this.normals[R+1],this.normals[R+2])};var d=new r;i.prototype.calculateLocalInertia=function(V,k){this.computeLocalAABB(d);var R=d.upperBound.x-d.lowerBound.x,B=d.upperBound.y-d.lowerBound.y,F=d.upperBound.z-d.lowerBound.z;return k.set(1/12*V*(2*B*2*B+2*F*2*F),1/12*V*(2*R*2*R+2*F*2*F),1/12*V*(2*B*2*B+2*R*2*R))};var b=new e;i.prototype.computeLocalAABB=function(V){var k=V.lowerBound,R=V.upperBound,B=this.vertices.length;this.vertices;var F=b;this.getVertex(0,F),k.copy(F),R.copy(F);for(var T=0;T!==B;T++)this.getVertex(T,F),F.x<k.x?k.x=F.x:F.x>R.x&&(R.x=F.x),F.y<k.y?k.y=F.y:F.y>R.y&&(R.y=F.y),F.z<k.z?k.z=F.z:F.z>R.z&&(R.z=F.z)},i.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},i.prototype.updateBoundingSphereRadius=function(){for(var V=0,k=this.vertices,R=new e,B=0,F=k.length/3;B!==F;B++){this.getVertex(B,R);var T=R.norm2();T>V&&(V=T)}this.boundingSphereRadius=Math.sqrt(V)},new e;var G=new s,at=new r;i.prototype.calculateWorldAABB=function(V,k,R,B){var F=G,T=at;F.position=V,F.quaternion=k,this.aabb.toWorldFrame(F,T),R.copy(T.lowerBound),B.copy(T.upperBound)},i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.createTorus=function(V,k,R,B,F){V=V||1,k=k||.5,R=R||8,B=B||6,F=F||Math.PI*2;for(var T=[],j=[],K=0;K<=R;K++)for(var pt=0;pt<=B;pt++){var M=pt/B*F,E=K/R*Math.PI*2,_=(V+k*Math.cos(E))*Math.cos(M),O=(V+k*Math.cos(E))*Math.sin(M),g=k*Math.sin(E);T.push(_,O,g)}for(var K=1;K<=R;K++)for(var pt=1;pt<=B;pt++){var z=(B+1)*K+pt-1,w=(B+1)*(K-1)+pt-1,m=(B+1)*(K-1)+pt,y=(B+1)*K+pt;j.push(z,w,y),j.push(w,m,y)}return new i(T,j)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(v,I,ct){I.exports=e,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver");function e(){p.call(this),this.iterations=10,this.tolerance=1e-7}e.prototype=new p;var s=[],r=[],l=[];e.prototype.solve=function(i,t){var o=0,n=this.iterations,a=this.tolerance*this.tolerance,c=this.equations,h=c.length,u=t.bodies,f=u.length,x=i,d,b,G,at,V,k;if(h!==0)for(var R=0;R!==f;R++)u[R].updateSolveMassProperties();var B=r,F=l,T=s;B.length=h,F.length=h,T.length=h;for(var R=0;R!==h;R++){var j=c[R];T[R]=0,F[R]=j.computeB(x),B[R]=1/j.computeC()}if(h!==0){for(var R=0;R!==f;R++){var K=u[R],pt=K.vlambda,M=K.wlambda;pt.set(0,0,0),M&&M.set(0,0,0)}for(o=0;o!==n;o++){at=0;for(var E=0;E!==h;E++){var j=c[E];d=F[E],b=B[E],k=T[E],V=j.computeGWlambda(),G=b*(d-V-j.eps*k),k+G<j.minForce?G=j.minForce-k:k+G>j.maxForce&&(G=j.maxForce-k),T[E]+=G,at+=G>0?G:-G,j.addToWlambda(G)}if(at*at<a)break}for(var R=0;R!==f;R++){var K=u[R],_=K.velocity,O=K.angularVelocity;_.vadd(K.vlambda,_),O&&O.vadd(K.wlambda,O)}}return o}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(v,I,ct){I.exports=p;function p(){this.equations=[]}p.prototype.solve=function(e,s){return 0},p.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},p.prototype.removeEquation=function(e){var s=this.equations,r=s.indexOf(e);r!==-1&&s.splice(r,1)},p.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(v,I,ct){I.exports=s,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver"),e=v("../objects/Body");function s(u){for(p.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=u,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}s.prototype=new p;var r=[],l=[],i={bodies:[]},t=e.STATIC;function o(u){for(var f=u.length,x=0;x!==f;x++){var d=u[x];if(!d.visited&&!(d.body.type&t))return d}return!1}var n=[];function a(u,f,x,d){for(n.push(u),u.visited=!0,f(u,x,d);n.length;)for(var b=n.pop(),G;G=o(b.children);)G.visited=!0,f(G,x,d),n.push(G)}function c(u,f,x){f.push(u.body);for(var d=u.eqs.length,b=0;b!==d;b++){var G=u.eqs[b];x.indexOf(G)===-1&&x.push(G)}}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},s.prototype.solve=function(u,f){for(var x=r,d=this.nodePool,b=f.bodies,G=this.equations,at=G.length,V=b.length,k=this.subsolver;d.length<V;)d.push(this.createNode());x.length=V;for(var R=0;R<V;R++)x[R]=d[R];for(var R=0;R!==V;R++){var B=x[R];B.body=b[R],B.children.length=0,B.eqs.length=0,B.visited=!1}for(var F=0;F!==at;F++){var T=G[F],R=b.indexOf(T.bi),j=b.indexOf(T.bj),K=x[R],pt=x[j];K.children.push(pt),K.eqs.push(T),pt.children.push(K),pt.eqs.push(T)}var M,E=0,_=l;k.tolerance=this.tolerance,k.iterations=this.iterations;for(var O=i;M=o(x);){_.length=0,O.bodies.length=0,a(M,c,O.bodies,_);var g=_.length;_=_.sort(h);for(var R=0;R!==g;R++)k.addEquation(_[R]);k.solve(u,O),k.removeAllEquations(),E++}return E};function h(u,f){return f.id-u.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(v,I,ct){var p=function(){};I.exports=p,p.prototype={constructor:p,addEventListener:function(e,s){this._listeners===void 0&&(this._listeners={});var r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(s)===-1&&r[e].push(s),this},hasEventListener:function(e,s){if(this._listeners===void 0)return!1;var r=this._listeners;return r[e]!==void 0&&r[e].indexOf(s)!==-1},removeEventListener:function(e,s){if(this._listeners===void 0)return this;var r=this._listeners;if(r[e]===void 0)return this;var l=r[e].indexOf(s);return l!==-1&&r[e].splice(l,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var s=this._listeners,r=s[e.type];if(r!==void 0){e.target=this;for(var l=0,i=r.length;l<i;l++)r[l].call(this,e)}return this}}},{}],50:[function(v,I,ct){var p=v("../collision/AABB"),e=v("../math/Vec3");I.exports=r;function s(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new p,this.data=[],this.children=[]}function r(t,o){o=o||{},o.root=null,o.aabb=t,s.call(this,o),this.maxDepth=typeof o.maxDepth<"u"?o.maxDepth:8}r.prototype=new s,s.prototype.reset=function(t,o){this.children.length=this.data.length=0},s.prototype.insert=function(t,o,n){var a=this.data;if(n=n||0,!this.aabb.contains(t))return!1;var c=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var h=!1;c.length||(this.subdivide(),h=!0);for(var u=0;u!==8;u++)if(c[u].insert(t,o,n+1))return!0;h&&(c.length=0)}return a.push(o),!0};var l=new e;s.prototype.subdivide=function(){var t=this.aabb,o=t.lowerBound,n=t.upperBound,a=this.children;a.push(new s({aabb:new p({lowerBound:new e(0,0,0)})}),new s({aabb:new p({lowerBound:new e(1,0,0)})}),new s({aabb:new p({lowerBound:new e(1,1,0)})}),new s({aabb:new p({lowerBound:new e(1,1,1)})}),new s({aabb:new p({lowerBound:new e(0,1,1)})}),new s({aabb:new p({lowerBound:new e(0,0,1)})}),new s({aabb:new p({lowerBound:new e(1,0,1)})}),new s({aabb:new p({lowerBound:new e(0,1,0)})})),n.vsub(o,l),l.scale(.5,l);for(var c=this.root||this,h=0;h!==8;h++){var u=a[h];u.root=c;var f=u.aabb.lowerBound;f.x*=l.x,f.y*=l.y,f.z*=l.z,f.vadd(o,f),f.vadd(l,u.aabb.upperBound)}},s.prototype.aabbQuery=function(t,o){this.data,this.children;for(var n=[this];n.length;){var a=n.pop();a.aabb.overlaps(t)&&Array.prototype.push.apply(o,a.data),Array.prototype.push.apply(n,a.children)}return o};var i=new p;s.prototype.rayQuery=function(t,o,n){return t.getAABB(i),i.toLocalFrame(o,i),this.aabbQuery(i,n),n},s.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var o=t.pop(),n=o.children.length-1;n>=0;n--)o.children[n].data.length||o.children.splice(n,1);Array.prototype.push.apply(t,o.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(v,I,ct){I.exports=p;function p(){this.objects=[],this.type=Object}p.prototype.release=function(){for(var e=arguments.length,s=0;s!==e;s++)this.objects.push(arguments[s])},p.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},p.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(v,I,ct){I.exports=p;function p(){this.data={keys:[]}}p.prototype.get=function(e,s){if(e>s){var r=s;s=e,e=r}return this.data[e+"-"+s]},p.prototype.set=function(e,s,r){if(e>s){var l=s;s=e,e=l}var i=e+"-"+s;this.get(e,s)||this.data.keys.push(i),this.data[i]=r},p.prototype.reset=function(){for(var e=this.data,s=e.keys;s.length>0;){var r=s.pop();delete e[r]}}},{}],53:[function(v,I,ct){function p(){}I.exports=p,p.defaults=function(e,s){e=e||{};for(var r in s)r in e||(e[r]=s[r]);return e}},{}],54:[function(v,I,ct){I.exports=s;var p=v("../math/Vec3"),e=v("./Pool");function s(){e.call(this),this.type=p}s.prototype=new e,s.prototype.constructObject=function(){return new p}},{"../math/Vec3":30,"./Pool":51}],55:[function(v,I,ct){I.exports=a;var p=v("../collision/AABB"),e=v("../shapes/Shape"),s=v("../collision/Ray"),r=v("../math/Vec3"),l=v("../math/Transform");v("../shapes/ConvexPolyhedron");var i=v("../math/Quaternion");v("../solver/Solver");var t=v("../utils/Vec3Pool"),o=v("../equations/ContactEquation"),n=v("../equations/FrictionEquation");function a(P){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new t,this.world=P,this.currentContactMaterial=null,this.enableFrictionReduction=!1}a.prototype.createContactEquation=function(P,N,U,D,yt,rt){var J;this.contactPointPool.length?(J=this.contactPointPool.pop(),J.bi=P,J.bj=N):J=new o(P,N),J.enabled=P.collisionResponse&&N.collisionResponse&&U.collisionResponse&&D.collisionResponse;var it=this.currentContactMaterial;J.restitution=it.restitution,J.setSpookParams(it.contactEquationStiffness,it.contactEquationRelaxation,this.world.dt);var S=U.material||P.material,$=D.material||N.material;return S&&$&&S.restitution>=0&&$.restitution>=0&&(J.restitution=S.restitution*$.restitution),J.si=yt||U,J.sj=rt||D,J},a.prototype.createFrictionEquationsFromContact=function(P,N){var U=P.bi,D=P.bj,yt=P.si,rt=P.sj,J=this.world,it=this.currentContactMaterial,S=it.friction,$=yt.material||U.material,ot=rt.material||D.material;if($&&ot&&$.friction>=0&&ot.friction>=0&&(S=$.friction*ot.friction),S>0){var lt=S*J.gravity.length(),tt=U.invMass+D.invMass;tt>0&&(tt=1/tt);var Z=this.frictionEquationPool,et=Z.length?Z.pop():new n(U,D,lt*tt),vt=Z.length?Z.pop():new n(U,D,lt*tt);return et.bi=vt.bi=U,et.bj=vt.bj=D,et.minForce=vt.minForce=-lt*tt,et.maxForce=vt.maxForce=lt*tt,et.ri.copy(P.ri),et.rj.copy(P.rj),vt.ri.copy(P.ri),vt.rj.copy(P.rj),P.ni.tangents(et.t,vt.t),et.setSpookParams(it.frictionEquationStiffness,it.frictionEquationRelaxation,J.dt),vt.setSpookParams(it.frictionEquationStiffness,it.frictionEquationRelaxation,J.dt),et.enabled=vt.enabled=P.enabled,N.push(et,vt),!0}return!1};var c=new r,h=new r,u=new r;a.prototype.createFrictionFromAverage=function(P){var N=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(N,this.frictionResult)||P===1)){var U=this.frictionResult[this.frictionResult.length-2],D=this.frictionResult[this.frictionResult.length-1];c.setZero(),h.setZero(),u.setZero();var yt=N.bi;N.bj;for(var rt=0;rt!==P;rt++)N=this.result[this.result.length-1-rt],N.bodyA!==yt?(c.vadd(N.ni,c),h.vadd(N.ri,h),u.vadd(N.rj,u)):(c.vsub(N.ni,c),h.vadd(N.rj,h),u.vadd(N.ri,u));var J=1/P;h.scale(J,U.ri),u.scale(J,U.rj),D.ri.copy(U.ri),D.rj.copy(U.rj),c.normalize(),c.tangents(U.t,D.t)}};var f=new r,x=new r,d=new i,b=new i;a.prototype.getContacts=function(P,N,U,D,yt,rt,J){this.contactPointPool=yt,this.frictionEquationPool=J,this.result=D,this.frictionResult=rt;for(var it=d,S=b,$=f,ot=x,lt=0,tt=P.length;lt!==tt;lt++){var Z=P[lt],et=N[lt],vt=null;Z.material&&et.material&&(vt=U.getContactMaterial(Z.material,et.material)||null);for(var wt=0;wt<Z.shapes.length;wt++){Z.quaternion.mult(Z.shapeOrientations[wt],it),Z.quaternion.vmult(Z.shapeOffsets[wt],$),$.vadd(Z.position,$);for(var Y=Z.shapes[wt],xt=0;xt<et.shapes.length;xt++){et.quaternion.mult(et.shapeOrientations[xt],S),et.quaternion.vmult(et.shapeOffsets[xt],ot),ot.vadd(et.position,ot);var gt=et.shapes[xt];if(!($.distanceTo(ot)>Y.boundingSphereRadius+gt.boundingSphereRadius)){var It=null;Y.material&&gt.material&&(It=U.getContactMaterial(Y.material,gt.material)||null),this.currentContactMaterial=It||vt||U.defaultContactMaterial;var Bt=this[Y.type|gt.type];Bt&&(Y.type<gt.type?Bt.call(this,Y,gt,$,ot,it,S,Z,et,Y,gt):Bt.call(this,gt,Y,ot,$,S,it,et,Z,Y,gt))}}}}},a.prototype[e.types.BOX|e.types.BOX]=a.prototype.boxBox=function(P,N,U,D,yt,rt,J,it){P.convexPolyhedronRepresentation.material=P.material,N.convexPolyhedronRepresentation.material=N.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,N.convexPolyhedronRepresentation.collisionResponse=N.collisionResponse,this.convexConvex(P.convexPolyhedronRepresentation,N.convexPolyhedronRepresentation,U,D,yt,rt,J,it,P,N)},a.prototype[e.types.BOX|e.types.CONVEXPOLYHEDRON]=a.prototype.boxConvex=function(P,N,U,D,yt,rt,J,it){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexConvex(P.convexPolyhedronRepresentation,N,U,D,yt,rt,J,it,P,N)},a.prototype[e.types.BOX|e.types.PARTICLE]=a.prototype.boxParticle=function(P,N,U,D,yt,rt,J,it){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexParticle(P.convexPolyhedronRepresentation,N,U,D,yt,rt,J,it,P,N)},a.prototype[e.types.SPHERE]=a.prototype.sphereSphere=function(P,N,U,D,yt,rt,J,it){var S=this.createContactEquation(J,it,P,N);D.vsub(U,S.ni),S.ni.normalize(),S.ri.copy(S.ni),S.rj.copy(S.ni),S.ri.mult(P.radius,S.ri),S.rj.mult(-N.radius,S.rj),S.ri.vadd(U,S.ri),S.ri.vsub(J.position,S.ri),S.rj.vadd(D,S.rj),S.rj.vsub(it.position,S.rj),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)};var G=new r,at=new r,V=new r;a.prototype[e.types.PLANE|e.types.TRIMESH]=a.prototype.planeTrimesh=function(P,N,U,D,yt,rt,J,it){var S=new r,$=G;$.set(0,0,1),yt.vmult($,$);for(var ot=0;ot<N.vertices.length/3;ot++){N.getVertex(ot,S);var lt=new r;lt.copy(S),l.pointToWorldFrame(D,rt,lt,S);var tt=at;S.vsub(U,tt);var Z=$.dot(tt);if(Z<=0){var et=this.createContactEquation(J,it,P,N);et.ni.copy($);var vt=V;$.scale(tt.dot($),vt),S.vsub(vt,vt),et.ri.copy(vt),et.ri.vsub(J.position,et.ri),et.rj.copy(S),et.rj.vsub(it.position,et.rj),this.result.push(et),this.createFrictionEquationsFromContact(et,this.frictionResult)}}};var k=new r,R=new r;new r;var B=new r,F=new r,T=new r,j=new r,K=new r,pt=new r,M=new r,E=new r,_=new r,O=new r,g=new r,z=new p,w=[];a.prototype[e.types.SPHERE|e.types.TRIMESH]=a.prototype.sphereTrimesh=function(P,N,U,D,yt,rt,J,it){var S=T,$=j,ot=K,lt=pt,tt=M,Z=E,et=z,vt=F,wt=R,Y=w;l.pointToLocalFrame(D,rt,U,tt);var xt=P.radius;et.lowerBound.set(tt.x-xt,tt.y-xt,tt.z-xt),et.upperBound.set(tt.x+xt,tt.y+xt,tt.z+xt),N.getTrianglesInAABB(et,Y);for(var gt=B,It=P.radius*P.radius,Bt=0;Bt<Y.length;Bt++)for(var Ct=0;Ct<3;Ct++)if(N.getVertex(N.indices[Y[Bt]*3+Ct],gt),gt.vsub(tt,wt),wt.norm2()<=It){vt.copy(gt),l.pointToWorldFrame(D,rt,vt,gt),gt.vsub(U,wt);var ft=this.createContactEquation(J,it,P,N);ft.ni.copy(wt),ft.ni.normalize(),ft.ri.copy(ft.ni),ft.ri.scale(P.radius,ft.ri),ft.ri.vadd(U,ft.ri),ft.ri.vsub(J.position,ft.ri),ft.rj.copy(gt),ft.rj.vsub(it.position,ft.rj),this.result.push(ft),this.createFrictionEquationsFromContact(ft,this.frictionResult)}for(var Bt=0;Bt<Y.length;Bt++)for(var Ct=0;Ct<3;Ct++){N.getVertex(N.indices[Y[Bt]*3+Ct],S),N.getVertex(N.indices[Y[Bt]*3+(Ct+1)%3],$),$.vsub(S,ot),tt.vsub($,Z);var Kt=Z.dot(ot);tt.vsub(S,Z);var jt=Z.dot(ot);if(jt>0&&Kt<0){tt.vsub(S,Z),lt.copy(ot),lt.normalize(),jt=Z.dot(lt),lt.scale(jt,Z),Z.vadd(S,Z);var Ut=Z.distanceTo(tt);if(Ut<P.radius){var ft=this.createContactEquation(J,it,P,N);Z.vsub(tt,ft.ni),ft.ni.normalize(),ft.ni.scale(P.radius,ft.ri),l.pointToWorldFrame(D,rt,Z,Z),Z.vsub(it.position,ft.rj),l.vectorToWorldFrame(rt,ft.ni,ft.ni),l.vectorToWorldFrame(rt,ft.ri,ft.ri),this.result.push(ft),this.createFrictionEquationsFromContact(ft,this.frictionResult)}}}for(var ne=_,Dt=O,Pt=g,ae=k,Bt=0,Ft=Y.length;Bt!==Ft;Bt++){N.getTriangleVertices(Y[Bt],ne,Dt,Pt),N.getNormal(Y[Bt],ae),tt.vsub(ne,Z);var Ut=Z.dot(ae);if(ae.scale(Ut,Z),tt.vsub(Z,Z),Ut=Z.distanceTo(tt),s.pointInTriangle(Z,ne,Dt,Pt)&&Ut<P.radius){var ft=this.createContactEquation(J,it,P,N);Z.vsub(tt,ft.ni),ft.ni.normalize(),ft.ni.scale(P.radius,ft.ri),l.pointToWorldFrame(D,rt,Z,Z),Z.vsub(it.position,ft.rj),l.vectorToWorldFrame(rt,ft.ni,ft.ni),l.vectorToWorldFrame(rt,ft.ri,ft.ri),this.result.push(ft),this.createFrictionEquationsFromContact(ft,this.frictionResult)}}Y.length=0};var m=new r,y=new r;a.prototype[e.types.SPHERE|e.types.PLANE]=a.prototype.spherePlane=function(P,N,U,D,yt,rt,J,it){var S=this.createContactEquation(J,it,P,N);if(S.ni.set(0,0,1),rt.vmult(S.ni,S.ni),S.ni.negate(S.ni),S.ni.normalize(),S.ni.mult(P.radius,S.ri),U.vsub(D,m),S.ni.mult(S.ni.dot(m),y),m.vsub(y,S.rj),-m.dot(S.ni)<=P.radius){var $=S.ri,ot=S.rj;$.vadd(U,$),$.vsub(J.position,$),ot.vadd(D,ot),ot.vsub(it.position,ot),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}};var C=new r,H=new r,W=new r;function A(P,N,U){for(var D=null,yt=P.length,rt=0;rt!==yt;rt++){var J=P[rt],it=C;P[(rt+1)%yt].vsub(J,it);var S=H;it.cross(N,S);var $=W;U.vsub(J,$);var ot=S.dot($);if(D===null||ot>0&&D===!0||ot<=0&&D===!1){D===null&&(D=ot>0);continue}else return!1}return!0}var L=new r,X=new r,ut=new r,st=new r,nt=[new r,new r,new r,new r,new r,new r],q=new r,Q=new r,bt=new r,dt=new r;a.prototype[e.types.SPHERE|e.types.BOX]=a.prototype.sphereBox=function(P,N,U,D,yt,rt,J,it){var S=this.v3pool,$=nt;U.vsub(D,L),N.getSideNormals($,rt);for(var ot=P.radius,lt=!1,tt=Q,Z=bt,et=dt,vt=null,wt=0,Y=0,xt=0,gt=null,It=0,Bt=$.length;It!==Bt&&lt===!1;It++){var Ct=X;Ct.copy($[It]);var ft=Ct.norm();Ct.normalize();var Kt=L.dot(Ct);if(Kt<ft+ot&&Kt>0){var jt=ut,Ut=st;jt.copy($[(It+1)%3]),Ut.copy($[(It+2)%3]);var ne=jt.norm(),Dt=Ut.norm();jt.normalize(),Ut.normalize();var Pt=L.dot(jt),ae=L.dot(Ut);if(Pt<ne&&Pt>-ne&&ae<Dt&&ae>-Dt){var qt=Math.abs(Kt-ft-ot);(gt===null||qt<gt)&&(gt=qt,Y=Pt,xt=ae,vt=ft,tt.copy(Ct),Z.copy(jt),et.copy(Ut),wt++)}}}if(wt){lt=!0;var mt=this.createContactEquation(J,it,P,N);tt.mult(-ot,mt.ri),mt.ni.copy(tt),mt.ni.negate(mt.ni),tt.mult(vt,tt),Z.mult(Y,Z),tt.vadd(Z,tt),et.mult(xt,et),tt.vadd(et,mt.rj),mt.ri.vadd(U,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(D,mt.rj),mt.rj.vsub(it.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}for(var Ft=S.get(),se=q,Xt=0;Xt!==2&&!lt;Xt++)for(var kt=0;kt!==2&&!lt;kt++)for(var Ot=0;Ot!==2&&!lt;Ot++)if(Ft.set(0,0,0),Xt?Ft.vadd($[0],Ft):Ft.vsub($[0],Ft),kt?Ft.vadd($[1],Ft):Ft.vsub($[1],Ft),Ot?Ft.vadd($[2],Ft):Ft.vsub($[2],Ft),D.vadd(Ft,se),se.vsub(U,se),se.norm2()<ot*ot){lt=!0;var mt=this.createContactEquation(J,it,P,N);mt.ri.copy(se),mt.ri.normalize(),mt.ni.copy(mt.ri),mt.ri.mult(ot,mt.ri),mt.rj.copy(Ft),mt.ri.vadd(U,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(D,mt.rj),mt.rj.vsub(it.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}S.release(Ft),Ft=null;for(var Jt=S.get(),le=S.get(),mt=S.get(),_t=S.get(),qt=S.get(),de=$.length,Xt=0;Xt!==de&&!lt;Xt++)for(var kt=0;kt!==de&&!lt;kt++)if(Xt%3!==kt%3){$[kt].cross($[Xt],Jt),Jt.normalize(),$[Xt].vadd($[kt],le),mt.copy(U),mt.vsub(le,mt),mt.vsub(D,mt);var ye=mt.dot(Jt);Jt.mult(ye,_t);for(var Ot=0;Ot===Xt%3||Ot===kt%3;)Ot++;qt.copy(U),qt.vsub(_t,qt),qt.vsub(le,qt),qt.vsub(D,qt);var be=Math.abs(ye),Ee=qt.norm();if(be<$[Ot].norm()&&Ee<ot){lt=!0;var Nt=this.createContactEquation(J,it,P,N);le.vadd(_t,Nt.rj),Nt.rj.copy(Nt.rj),qt.negate(Nt.ni),Nt.ni.normalize(),Nt.ri.copy(Nt.rj),Nt.ri.vadd(D,Nt.ri),Nt.ri.vsub(U,Nt.ri),Nt.ri.normalize(),Nt.ri.mult(ot,Nt.ri),Nt.ri.vadd(U,Nt.ri),Nt.ri.vsub(J.position,Nt.ri),Nt.rj.vadd(D,Nt.rj),Nt.rj.vsub(it.position,Nt.rj),this.result.push(Nt),this.createFrictionEquationsFromContact(Nt,this.frictionResult)}}S.release(Jt,le,mt,_t,qt)};var Mt=new r,ht=new r,St=new r,zt=new r,Rt=new r,Vt=new r,Et=new r,Tt=new r,At=new r,Wt=new r;a.prototype[e.types.SPHERE|e.types.CONVEXPOLYHEDRON]=a.prototype.sphereConvex=function(P,N,U,D,yt,rt,J,it){var S=this.v3pool;U.vsub(D,Mt);for(var $=N.faceNormals,ot=N.faces,lt=N.vertices,tt=P.radius,Z=0;Z!==lt.length;Z++){var et=lt[Z],vt=Rt;rt.vmult(et,vt),D.vadd(vt,vt);var wt=zt;if(vt.vsub(U,wt),wt.norm2()<tt*tt){xt=!0;var Y=this.createContactEquation(J,it,P,N);Y.ri.copy(wt),Y.ri.normalize(),Y.ni.copy(Y.ri),Y.ri.mult(tt,Y.ri),vt.vsub(D,Y.rj),Y.ri.vadd(U,Y.ri),Y.ri.vsub(J.position,Y.ri),Y.rj.vadd(D,Y.rj),Y.rj.vsub(it.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);return}}for(var xt=!1,Z=0,gt=ot.length;Z!==gt&&xt===!1;Z++){var It=$[Z],Bt=ot[Z],Ct=Vt;rt.vmult(It,Ct);var ft=Et;rt.vmult(lt[Bt[0]],ft),ft.vadd(D,ft);var Kt=Tt;Ct.mult(-tt,Kt),U.vadd(Kt,Kt);var jt=At;Kt.vsub(ft,jt);var Ut=jt.dot(Ct),ne=Wt;if(U.vsub(ft,ne),Ut<0&&ne.dot(Ct)>0){for(var Dt=[],Pt=0,ae=Bt.length;Pt!==ae;Pt++){var Ft=S.get();rt.vmult(lt[Bt[Pt]],Ft),D.vadd(Ft,Ft),Dt.push(Ft)}if(A(Dt,Ct,U)){xt=!0;var Y=this.createContactEquation(J,it,P,N);Ct.mult(-tt,Y.ri),Ct.negate(Y.ni);var se=S.get();Ct.mult(-Ut,se);var Xt=S.get();Ct.mult(-tt,Xt),U.vsub(D,Y.rj),Y.rj.vadd(Xt,Y.rj),Y.rj.vadd(se,Y.rj),Y.rj.vadd(D,Y.rj),Y.rj.vsub(it.position,Y.rj),Y.ri.vadd(U,Y.ri),Y.ri.vsub(J.position,Y.ri),S.release(se),S.release(Xt),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,kt=Dt.length;Pt!==kt;Pt++)S.release(Dt[Pt]);return}else for(var Pt=0;Pt!==Bt.length;Pt++){var Ot=S.get(),Jt=S.get();rt.vmult(lt[Bt[(Pt+1)%Bt.length]],Ot),rt.vmult(lt[Bt[(Pt+2)%Bt.length]],Jt),D.vadd(Ot,Ot),D.vadd(Jt,Jt);var le=ht;Jt.vsub(Ot,le);var mt=St;le.unit(mt);var _t=S.get(),qt=S.get();U.vsub(Ot,qt);var de=qt.dot(mt);mt.mult(de,_t),_t.vadd(Ot,_t);var ye=S.get();if(_t.vsub(U,ye),de>0&&de*de<le.norm2()&&ye.norm2()<tt*tt){var Y=this.createContactEquation(J,it,P,N);_t.vsub(D,Y.rj),_t.vsub(U,Y.ni),Y.ni.normalize(),Y.ni.mult(tt,Y.ri),Y.rj.vadd(D,Y.rj),Y.rj.vsub(it.position,Y.rj),Y.ri.vadd(U,Y.ri),Y.ri.vsub(J.position,Y.ri),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,kt=Dt.length;Pt!==kt;Pt++)S.release(Dt[Pt]);S.release(Ot),S.release(Jt),S.release(_t),S.release(ye),S.release(qt);return}S.release(Ot),S.release(Jt),S.release(_t),S.release(ye),S.release(qt)}for(var Pt=0,kt=Dt.length;Pt!==kt;Pt++)S.release(Dt[Pt])}}},new r,new r,a.prototype[e.types.PLANE|e.types.BOX]=a.prototype.planeBox=function(P,N,U,D,yt,rt,J,it){N.convexPolyhedronRepresentation.material=N.material,N.convexPolyhedronRepresentation.collisionResponse=N.collisionResponse,this.planeConvex(P,N.convexPolyhedronRepresentation,U,D,yt,rt,J,it)};var Gt=new r,oe=new r,he=new r,re=new r;a.prototype[e.types.PLANE|e.types.CONVEXPOLYHEDRON]=a.prototype.planeConvex=function(P,N,U,D,yt,rt,J,it){var S=Gt,$=oe;$.set(0,0,1),yt.vmult($,$);for(var ot=0,lt=he,tt=0;tt!==N.vertices.length;tt++){S.copy(N.vertices[tt]),rt.vmult(S,S),D.vadd(S,S),S.vsub(U,lt);var Z=$.dot(lt);if(Z<=0){var et=this.createContactEquation(J,it,P,N),vt=re;$.mult($.dot(lt),vt),S.vsub(vt,vt),vt.vsub(U,et.ri),et.ni.copy($),S.vsub(D,et.rj),et.ri.vadd(U,et.ri),et.ri.vsub(J.position,et.ri),et.rj.vadd(D,et.rj),et.rj.vsub(it.position,et.rj),this.result.push(et),ot++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(et,this.frictionResult)}}this.enableFrictionReduction&&ot&&this.createFrictionFromAverage(ot)};var Qt=new r,Zt=new r;a.prototype[e.types.CONVEXPOLYHEDRON]=a.prototype.convexConvex=function(P,N,U,D,yt,rt,J,it,S,$,ot,lt){var tt=Qt;if(!(U.distanceTo(D)>P.boundingSphereRadius+N.boundingSphereRadius)&&P.findSeparatingAxis(N,U,yt,D,rt,tt,ot,lt)){var Z=[],et=Zt;P.clipAgainstHull(U,yt,N,D,rt,tt,-100,100,Z);for(var vt=0,wt=0;wt!==Z.length;wt++){var Y=this.createContactEquation(J,it,P,N,S,$),xt=Y.ri,gt=Y.rj;tt.negate(Y.ni),Z[wt].normal.negate(et),et.mult(Z[wt].depth,et),Z[wt].point.vadd(et,xt),gt.copy(Z[wt].point),xt.vsub(U,xt),gt.vsub(D,gt),xt.vadd(U,xt),xt.vsub(J.position,xt),gt.vadd(D,gt),gt.vsub(it.position,gt),this.result.push(Y),vt++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(Y,this.frictionResult)}this.enableFrictionReduction&&vt&&this.createFrictionFromAverage(vt)}};var ue=new r,ce=new r,ee=new r;a.prototype[e.types.PLANE|e.types.PARTICLE]=a.prototype.planeParticle=function(P,N,U,D,yt,rt,J,it){var S=ue;S.set(0,0,1),J.quaternion.vmult(S,S);var $=ce;D.vsub(J.position,$);var ot=S.dot($);if(ot<=0){var lt=this.createContactEquation(it,J,N,P);lt.ni.copy(S),lt.ni.negate(lt.ni),lt.ri.set(0,0,0);var tt=ee;S.mult(S.dot(D),tt),D.vsub(tt,tt),lt.rj.copy(tt),this.result.push(lt),this.createFrictionEquationsFromContact(lt,this.frictionResult)}};var $t=new r;a.prototype[e.types.PARTICLE|e.types.SPHERE]=a.prototype.sphereParticle=function(P,N,U,D,yt,rt,J,it){var S=$t;S.set(0,0,1),D.vsub(U,S);var $=S.norm2();if($<=P.radius*P.radius){var ot=this.createContactEquation(it,J,N,P);S.normalize(),ot.rj.copy(S),ot.rj.mult(P.radius,ot.rj),ot.ni.copy(S),ot.ni.negate(ot.ni),ot.ri.set(0,0,0),this.result.push(ot),this.createFrictionEquationsFromContact(ot,this.frictionResult)}};var Yt=new i,ie=new r;new r;var te=new r,Ht=new r,pe=new r;a.prototype[e.types.PARTICLE|e.types.CONVEXPOLYHEDRON]=a.prototype.convexParticle=function(P,N,U,D,yt,rt,J,it){var S=-1,$=te,ot=pe,lt=null,tt=ie;if(tt.copy(D),tt.vsub(U,tt),yt.conjugate(Yt),Yt.vmult(tt,tt),P.pointIsInside(tt)){P.worldVerticesNeedsUpdate&&P.computeWorldVertices(U,yt),P.worldFaceNormalsNeedsUpdate&&P.computeWorldFaceNormals(yt);for(var Z=0,et=P.faces.length;Z!==et;Z++){var vt=[P.worldVertices[P.faces[Z][0]]],wt=P.worldFaceNormals[Z];D.vsub(vt[0],Ht);var Y=-wt.dot(Ht);(lt===null||Math.abs(Y)<Math.abs(lt))&&(lt=Y,S=Z,$.copy(wt))}if(S!==-1){var xt=this.createContactEquation(it,J,N,P);$.mult(lt,ot),ot.vadd(D,ot),ot.vsub(U,ot),xt.rj.copy(ot),$.negate(xt.ni),xt.ri.set(0,0,0);var gt=xt.ri,It=xt.rj;gt.vadd(D,gt),gt.vsub(it.position,gt),It.vadd(U,It),It.vsub(J.position,It),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},a.prototype[e.types.BOX|e.types.HEIGHTFIELD]=a.prototype.boxHeightfield=function(P,N,U,D,yt,rt,J,it){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexHeightfield(P.convexPolyhedronRepresentation,N,U,D,yt,rt,J,it)};var ve=new r,fe=new r,me=[0];a.prototype[e.types.CONVEXPOLYHEDRON|e.types.HEIGHTFIELD]=a.prototype.convexHeightfield=function(P,N,U,D,yt,rt,J,it){var S=N.data,$=N.elementSize,ot=P.boundingSphereRadius,lt=fe,tt=me,Z=ve;l.pointToLocalFrame(D,rt,U,Z);var et=Math.floor((Z.x-ot)/$)-1,vt=Math.ceil((Z.x+ot)/$)+1,wt=Math.floor((Z.y-ot)/$)-1,Y=Math.ceil((Z.y+ot)/$)+1;if(!(vt<0||Y<0||et>S.length||wt>S[0].length)){et<0&&(et=0),vt<0&&(vt=0),wt<0&&(wt=0),Y<0&&(Y=0),et>=S.length&&(et=S.length-1),vt>=S.length&&(vt=S.length-1),Y>=S[0].length&&(Y=S[0].length-1),wt>=S[0].length&&(wt=S[0].length-1);var xt=[];N.getRectMinMax(et,wt,vt,Y,xt);var gt=xt[0],It=xt[1];if(!(Z.z-ot>It||Z.z+ot<gt))for(var Bt=et;Bt<vt;Bt++)for(var Ct=wt;Ct<Y;Ct++)N.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(D,rt,N.pillarOffset,lt),U.distanceTo(lt)<N.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.convexConvex(P,N.pillarConvex,U,lt,yt,rt,J,it,null,null,tt,null),N.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(D,rt,N.pillarOffset,lt),U.distanceTo(lt)<N.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.convexConvex(P,N.pillarConvex,U,lt,yt,rt,J,it,null,null,tt,null)}};var we=new r,Lt=new r;a.prototype[e.types.SPHERE|e.types.HEIGHTFIELD]=a.prototype.sphereHeightfield=function(P,N,U,D,yt,rt,J,it){var S=N.data,$=P.radius,ot=N.elementSize,lt=Lt,tt=we;l.pointToLocalFrame(D,rt,U,tt);var Z=Math.floor((tt.x-$)/ot)-1,et=Math.ceil((tt.x+$)/ot)+1,vt=Math.floor((tt.y-$)/ot)-1,wt=Math.ceil((tt.y+$)/ot)+1;if(!(et<0||wt<0||Z>S.length||wt>S[0].length)){Z<0&&(Z=0),et<0&&(et=0),vt<0&&(vt=0),wt<0&&(wt=0),Z>=S.length&&(Z=S.length-1),et>=S.length&&(et=S.length-1),wt>=S[0].length&&(wt=S[0].length-1),vt>=S[0].length&&(vt=S[0].length-1);var Y=[];N.getRectMinMax(Z,vt,et,wt,Y);var xt=Y[0],gt=Y[1];if(!(tt.z-$>gt||tt.z+$<xt))for(var It=this.result,Bt=Z;Bt<et;Bt++)for(var Ct=vt;Ct<wt;Ct++){var ft=It.length;N.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(D,rt,N.pillarOffset,lt),U.distanceTo(lt)<N.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.sphereConvex(P,N.pillarConvex,U,lt,yt,rt,J,it),N.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(D,rt,N.pillarOffset,lt),U.distanceTo(lt)<N.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.sphereConvex(P,N.pillarConvex,U,lt,yt,rt,J,it);var Kt=It.length-ft;if(Kt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(v,I,ct){I.exports=d;var p=v("../shapes/Shape"),e=v("../math/Vec3"),s=v("../math/Quaternion"),r=v("../solver/GSSolver");v("../utils/Vec3Pool"),v("../equations/ContactEquation"),v("../equations/FrictionEquation");var l=v("./Narrowphase"),i=v("../utils/EventTarget"),t=v("../collision/ArrayCollisionMatrix"),o=v("../material/Material"),n=v("../material/ContactMaterial"),a=v("../objects/Body"),c=v("../utils/TupleDictionary"),h=v("../collision/RaycastResult"),u=v("../collision/AABB"),f=v("../collision/Ray"),x=v("../collision/NaiveBroadphase");function d(){i.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new x,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new t,this.collisionMatrixPrevious=new t,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new n(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}d.prototype=new i,new u;var b=new f;if(d.prototype.getContactMaterial=function(E,_){return this.contactMaterialTable.get(E.id,_.id)},d.prototype.numObjects=function(){return this.bodies.length},d.prototype.collisionMatrixTick=function(){var E=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=E,this.collisionMatrix.reset()},d.prototype.add=d.prototype.addBody=function(E){this.bodies.indexOf(E)===-1&&(E.index=this.bodies.length,this.bodies.push(E),E.world=this,E.initPosition.copy(E.position),E.initVelocity.copy(E.velocity),E.timeLastSleepy=this.time,E instanceof a&&(E.initAngularVelocity.copy(E.angularVelocity),E.initQuaternion.copy(E.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=E,this.dispatchEvent(this.addBodyEvent))},d.prototype.addConstraint=function(E){this.constraints.push(E)},d.prototype.removeConstraint=function(E){var _=this.constraints.indexOf(E);_!==-1&&this.constraints.splice(_,1)},d.prototype.rayTest=function(E,_,O){O instanceof h?this.raycastClosest(E,_,{skipBackfaces:!0},O):this.raycastAll(E,_,{skipBackfaces:!0},O)},d.prototype.raycastAll=function(E,_,O,g){return O.mode=f.ALL,O.from=E,O.to=_,O.callback=g,b.intersectWorld(this,O)},d.prototype.raycastAny=function(E,_,O,g){return O.mode=f.ANY,O.from=E,O.to=_,O.result=g,b.intersectWorld(this,O)},d.prototype.raycastClosest=function(E,_,O,g){return O.mode=f.CLOSEST,O.from=E,O.to=_,O.result=g,b.intersectWorld(this,O)},d.prototype.remove=function(E){E.world=null;var _=this.bodies.length-1,O=this.bodies,g=O.indexOf(E);if(g!==-1){O.splice(g,1);for(var z=0;z!==O.length;z++)O[z].index=z;this.collisionMatrix.setNumObjects(_),this.removeBodyEvent.body=E,this.dispatchEvent(this.removeBodyEvent)}},d.prototype.removeBody=d.prototype.remove,d.prototype.addMaterial=function(E){this.materials.push(E)},d.prototype.addContactMaterial=function(E){this.contactmaterials.push(E),this.contactMaterialTable.set(E.materials[0].id,E.materials[1].id,E)},typeof performance>"u"&&(performance={}),!performance.now){var G=Date.now();performance.timing&&performance.timing.navigationStart&&(G=performance.timing.navigationStart),performance.now=function(){return Date.now()-G}}var at=new e;d.prototype.step=function(E,_,O){if(O=O||10,_=_||0,_===0)this.internalStep(E),this.time+=E;else{var g=Math.floor((this.time+_)/E)-Math.floor(this.time/E);g=Math.min(g,O);for(var z=performance.now(),w=0;w!==g&&(this.internalStep(E),!(performance.now()-z>E*1e3));w++);this.time+=_;for(var m=this.time%E,y=m/E,C=at,H=this.bodies,W=0;W!==H.length;W++){var A=H[W];A.type!==a.STATIC&&A.sleepState!==a.SLEEPING?(A.position.vsub(A.previousPosition,C),C.scale(y,C),A.position.vadd(C,A.interpolatedPosition)):(A.interpolatedPosition.copy(A.position),A.interpolatedQuaternion.copy(A.quaternion))}}};var V={type:"postStep"},k={type:"preStep"},R={type:"collide",body:null,contact:null},B=[],F=[],T=[],j=[];new e,new e,new e,new e,new e,new e,new e,new e,new e,new s;var K=new s,pt=new s,M=new e;d.prototype.internalStep=function(E){this.dt=E;var _=this.contacts,O=T,g=j,z=this.numObjects(),w=this.bodies,m=this.solver,y=this.gravity,C=this.doProfiling,H=this.profile,W=a.DYNAMIC,A,L=this.constraints,X=F;y.norm();var ut=y.x,st=y.y,nt=y.z,q=0;for(C&&(A=performance.now()),q=0;q!==z;q++){var Q=w[q];if(Q.type&W){var bt=Q.force,dt=Q.mass;bt.x+=dt*ut,bt.y+=dt*st,bt.z+=dt*nt}}for(var q=0,Mt=this.subsystems.length;q!==Mt;q++)this.subsystems[q].update();C&&(A=performance.now()),O.length=0,g.length=0,this.broadphase.collisionPairs(this,O,g),C&&(H.broadphase=performance.now()-A);var Qt=L.length;for(q=0;q!==Qt;q++){var ht=L[q];if(!ht.collideConnected)for(var St=O.length-1;St>=0;St-=1)(ht.bodyA===O[St]&&ht.bodyB===g[St]||ht.bodyB===O[St]&&ht.bodyA===g[St])&&(O.splice(St,1),g.splice(St,1))}this.collisionMatrixTick(),C&&(A=performance.now());var zt=B,Rt=_.length;for(q=0;q!==Rt;q++)zt.push(_[q]);_.length=0;var Vt=this.frictionEquations.length;for(q=0;q!==Vt;q++)X.push(this.frictionEquations[q]);this.frictionEquations.length=0,this.narrowphase.getContacts(O,g,this,_,zt,this.frictionEquations,X),C&&(H.narrowphase=performance.now()-A),C&&(A=performance.now());for(var q=0;q<this.frictionEquations.length;q++)m.addEquation(this.frictionEquations[q]);for(var Et=_.length,Tt=0;Tt!==Et;Tt++){var ht=_[Tt],Q=ht.bi,At=ht.bj;ht.si,ht.sj;var Wt;if(Q.material&&At.material?Wt=this.getContactMaterial(Q.material,At.material)||this.defaultContactMaterial:Wt=this.defaultContactMaterial,Wt.friction,Q.material&&At.material&&(Q.material.friction>=0&&At.material.friction>=0&&Q.material.friction*At.material.friction,Q.material.restitution>=0&&At.material.restitution>=0&&(ht.restitution=Q.material.restitution*At.material.restitution)),m.addEquation(ht),Q.allowSleep&&Q.type===a.DYNAMIC&&Q.sleepState===a.SLEEPING&&At.sleepState===a.AWAKE&&At.type!==a.STATIC){var Gt=At.velocity.norm2()+At.angularVelocity.norm2(),oe=Math.pow(At.sleepSpeedLimit,2);Gt>=oe*2&&(Q._wakeUpAfterNarrowphase=!0)}if(At.allowSleep&&At.type===a.DYNAMIC&&At.sleepState===a.SLEEPING&&Q.sleepState===a.AWAKE&&Q.type!==a.STATIC){var he=Q.velocity.norm2()+Q.angularVelocity.norm2(),re=Math.pow(Q.sleepSpeedLimit,2);he>=re*2&&(At._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(Q,At,!0),this.collisionMatrixPrevious.get(Q,At)||(R.body=At,R.contact=ht,Q.dispatchEvent(R),R.body=Q,At.dispatchEvent(R))}for(C&&(H.makeContactConstraints=performance.now()-A,A=performance.now()),q=0;q!==z;q++){var Q=w[q];Q._wakeUpAfterNarrowphase&&(Q.wakeUp(),Q._wakeUpAfterNarrowphase=!1)}var Qt=L.length;for(q=0;q!==Qt;q++){var ht=L[q];ht.update();for(var St=0,Zt=ht.equations.length;St!==Zt;St++){var ue=ht.equations[St];m.addEquation(ue)}}m.solve(E,this),C&&(H.solve=performance.now()-A),m.removeAllEquations();var ce=Math.pow;for(q=0;q!==z;q++){var Q=w[q];if(Q.type&W){var ee=ce(1-Q.linearDamping,E),$t=Q.velocity;$t.mult(ee,$t);var Yt=Q.angularVelocity;if(Yt){var ie=ce(1-Q.angularDamping,E);Yt.mult(ie,Yt)}}}for(this.dispatchEvent(k),q=0;q!==z;q++){var Q=w[q];Q.preStep&&Q.preStep.call(Q)}C&&(A=performance.now());var te=K,Ht=pt,pe=this.stepnumber,ve=a.DYNAMIC|a.KINEMATIC,fe=pe%(this.quatNormalizeSkip+1)===0,me=this.quatNormalizeFast,we=E*.5;for(p.types.PLANE,p.types.CONVEXPOLYHEDRON,q=0;q!==z;q++){var Lt=w[q],P=Lt.force,N=Lt.torque;if(Lt.type&ve&&Lt.sleepState!==a.SLEEPING){var U=Lt.velocity,D=Lt.angularVelocity,yt=Lt.position,rt=Lt.quaternion,J=Lt.invMass,it=Lt.invInertiaWorld;U.x+=P.x*J*E,U.y+=P.y*J*E,U.z+=P.z*J*E,Lt.angularVelocity&&(it.vmult(N,M),M.mult(E,M),M.vadd(D,D)),yt.x+=U.x*E,yt.y+=U.y*E,yt.z+=U.z*E,Lt.angularVelocity&&(te.set(D.x,D.y,D.z,0),te.mult(rt,Ht),rt.x+=we*Ht.x,rt.y+=we*Ht.y,rt.z+=we*Ht.z,rt.w+=we*Ht.w,fe&&(me?rt.normalizeFast():rt.normalize())),Lt.aabb&&(Lt.aabbNeedsUpdate=!0),Lt.updateInertiaWorld&&Lt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,C&&(H.integrate=performance.now()-A),this.time+=E,this.stepnumber+=1,this.dispatchEvent(V),q=0;q!==z;q++){var Q=w[q],S=Q.postStep;S&&S.call(Q)}if(this.allowSleep)for(q=0;q!==z;q++)w[q].sleepTick(this.time)},d.prototype.clearForces=function(){for(var E=this.bodies,_=E.length,O=0;O!==_;O++){var g=E[O];g.force,g.torque,g.force.set(0,0,0),g.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(Be);var Ce=Be.exports;const ze=Ae(Ce);export{ze as C};
