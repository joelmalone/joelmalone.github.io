var Un=Object.defineProperty,Vn=Object.defineProperties;var Hn=Object.getOwnPropertyDescriptors;var An=Object.getOwnPropertySymbols;var Kn=Object.prototype.hasOwnProperty,Wn=Object.prototype.propertyIsEnumerable;var mn=(t,e,n)=>e in t?Un(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,yn=(t,e)=>{for(var n in e||(e={}))Kn.call(e,n)&&mn(t,n,e[n]);if(An)for(var n of An(e))Wn.call(e,n)&&mn(t,n,e[n]);return t},gn=(t,e)=>Vn(t,Hn(e));import{T as N,L as K,O as k,D as Se,a as jn,b as En,R as qn,c as Xn,S as Ce,M as W,d as Jn,V as S,e as zn,f as P,g as ce,h as Tn,C as Yn,i as Zn,j as be,k as we,l as M,m as Y,n as le,Q as j,o as Q,H as Le,p as ye,P as Ne,q as xe,F as Me,r as On,s as ue,B as he,t as $n,u as Qn,G as Pe,v as er,w,_ as Sn,x as Cn,y as nr,z as rr,I as tr,J as or,K as D,N as _e,U as sr,W as ar,X as Z,Y as ir,Z as cr,$ as lr,a0 as ur,a1 as fr,a2 as dr,a3 as hr,a4 as bn,a5 as _r,a6 as ge,a7 as pr,a8 as vr,a9 as Ar,aa as mr,ab as yr,ac as gr,ad as Er,ae as Tr,af as Ie,ag as wn}from"./vendor.76707804.js";function Re(t,e,n,r){var o={externalResourceFunction:function(s){return r(s).then(function(a){return new Uint8Array(a)})}};return n&&(o.uri=e==="file:"?n:e+n),t instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(t),o):GLTFValidator.validateString(t,o)}function Or(){var t=[];onmessage=function(e){var n=e.data;switch(n.id){case"init":{importScripts(n.url);break}case"validate":{Re(n.data,n.rootUrl,n.fileName,function(r){return new Promise(function(o,s){var a=t.length;t.push({resolve:o,reject:s}),postMessage({id:"getExternalResource",index:a,uri:r})})}).then(function(r){postMessage({id:"validate.resolve",value:r})},function(r){postMessage({id:"validate.reject",reason:r})});break}case"getExternalResource.resolve":{t[n.index].resolve(n.value);break}case"getExternalResource.reject":{t[n.index].reject(n.reason);break}}}}var Sr=function(){function t(){}return t.ValidateAsync=function(e,n,r,o){var s=this;return typeof Worker=="function"?new Promise(function(a,i){var c="".concat(Re,"(").concat(Or,")()"),u=URL.createObjectURL(new Blob([c],{type:"application/javascript"})),l=new Worker(u),f=function(h){l.removeEventListener("error",f),l.removeEventListener("message",d),i(h)},d=function(h){var _=h.data;switch(_.id){case"getExternalResource":{o(_.uri).then(function(p){l.postMessage({id:"getExternalResource.resolve",index:_.index,value:p},[p])},function(p){l.postMessage({id:"getExternalResource.reject",index:_.index,reason:p})});break}case"validate.resolve":{l.removeEventListener("error",f),l.removeEventListener("message",d),a(_.value),l.terminate();break}case"validate.reject":l.removeEventListener("error",f),l.removeEventListener("message",d),i(_.reason),l.terminate()}};l.addEventListener("error",f),l.addEventListener("message",d),l.postMessage({id:"init",url:s.Configuration.url}),l.postMessage({id:"validate",data:e,rootUrl:n,fileName:r})}):(this._LoadScriptPromise||(this._LoadScriptPromise=N.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(function(){return Re(e,n,r,o)}))},t.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},t}();function Ln(t,e,n){try{return Promise.resolve(new Uint8Array(t,e,n))}catch(r){return Promise.reject(r)}}var pe;(function(t){t[t.AUTO=0]="AUTO",t[t.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(pe||(pe={}));var fe;(function(t){t[t.NONE=0]="NONE",t[t.FIRST=1]="FIRST",t[t.ALL=2]="ALL"})(fe||(fe={}));var J;(function(t){t[t.LOADING=0]="LOADING",t[t.READY=1]="READY",t[t.COMPLETE=2]="COMPLETE"})(J||(J={}));var oe=function(){function t(){this.onParsedObservable=new k,this.coordinateSystemMode=pe.AUTO,this.animationStartMode=fe.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable=new k,this.onSkinLoadedObservable=new k,this.onTextureLoadedObservable=new k,this.onMaterialLoadedObservable=new k,this.onCameraLoadedObservable=new k,this.onCompleteObservable=new k,this.onErrorObservable=new k,this.onDisposeObservable=new k,this.onExtensionLoadedObservable=new k,this.validate=!1,this.onValidatedObservable=new k,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new k,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(t.prototype,"onParsed",{set:function(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMeshLoaded",{set:function(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTextureLoaded",{set:function(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMaterialLoaded",{set:function(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onCameraLoaded",{set:function(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onComplete",{set:function(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onError",{set:function(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onExtensionLoaded",{set:function(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onValidated",{set:function(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null);for(var e=0,n=this._requests;e<n.length;e++){var r=n[e];r.abort()}this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=function(o){return Promise.resolve(o)},this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},t.prototype.loadFile=function(e,n,r,o,s,a){var i=this;this._progressCallback=o;var c=n.name?"file:":N.GetFolderPath(n),u=n.name||N.GetFilename(n);if(s){if(this.useRangeRequests){this.validate&&K.Warn("glTF validation is not supported when range requests are enabled");var l={abort:function(){},onCompleteObservable:new k},f={readAsync:function(d,h){return new Promise(function(_,p){i._loadFile(e,n,function(v){_(new Uint8Array(v))},!0,function(v){p(v)},function(v){v.setRequestHeader("Range","bytes=".concat(d,"-").concat(d+h-1))})})},byteLength:0};return this._unpackBinaryAsync(new Se(f)).then(function(d){l.onCompleteObservable.notifyObservers(l),r(d)},a?function(d){return a(void 0,d)}:void 0),l}return this._loadFile(e,n,function(d){i._validate(e,d,c,u),i._unpackBinaryAsync(new Se({readAsync:function(h,_){return Ln(d,h,_)},byteLength:d.byteLength})).then(function(h){r(h)},a?function(h){return a(void 0,h)}:void 0)},!0,a)}return this._loadFile(e,n,function(d){i._validate(e,d,c,u),r({json:i._parseJson(d)})},s,a)},t.prototype.importMeshAsync=function(e,n,r,o,s,a){var i=this;return Promise.resolve().then(function(){return i.onParsedObservable.notifyObservers(r),i.onParsedObservable.clear(),i._log("Loading ".concat(a||"")),i._loader=i._getLoader(r),i._loader.importMeshAsync(e,n,null,r,o,s,a)})},t.prototype.loadAsync=function(e,n,r,o,s){var a=this;return Promise.resolve().then(function(){return a.onParsedObservable.notifyObservers(n),a.onParsedObservable.clear(),a._log("Loading ".concat(s||"")),a._loader=a._getLoader(n),a._loader.loadAsync(e,n,r,o,s)})},t.prototype.loadAssetContainerAsync=function(e,n,r,o,s){var a=this;return Promise.resolve().then(function(){a.onParsedObservable.notifyObservers(n),a.onParsedObservable.clear(),a._log("Loading ".concat(s||"")),a._loader=a._getLoader(n);var i=new jn(e),c=[];a.onMaterialLoadedObservable.add(function(f){c.push(f)});var u=[];a.onTextureLoadedObservable.add(function(f){u.push(f)});var l=[];return a.onCameraLoadedObservable.add(function(f){l.push(f)}),a._loader.importMeshAsync(null,e,i,n,r,o,s).then(function(f){return Array.prototype.push.apply(i.geometries,f.geometries),Array.prototype.push.apply(i.meshes,f.meshes),Array.prototype.push.apply(i.particleSystems,f.particleSystems),Array.prototype.push.apply(i.skeletons,f.skeletons),Array.prototype.push.apply(i.animationGroups,f.animationGroups),Array.prototype.push.apply(i.materials,c),Array.prototype.push.apply(i.textures,u),Array.prototype.push.apply(i.lights,f.lights),Array.prototype.push.apply(i.transformNodes,f.transformNodes),Array.prototype.push.apply(i.cameras,l),i})})},t.prototype.canDirectLoad=function(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+t._MagicBase64Encoded)||e.startsWith("data:;base64,"+t._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+t._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+t._MagicBase64Encoded)},t.prototype.directLoad=function(e,n){if(n.startsWith("base64,"+t._MagicBase64Encoded)||n.startsWith(";base64,"+t._MagicBase64Encoded)||n.startsWith("application/octet-stream;base64,"+t._MagicBase64Encoded)||n.startsWith("model/gltf-binary;base64,"+t._MagicBase64Encoded)){var r=En(n);return this._validate(e,r),this._unpackBinaryAsync(new Se({readAsync:function(o,s){return Ln(r,o,s)},byteLength:r.byteLength}))}return this._validate(e,n),Promise.resolve({json:this._parseJson(n)})},t.prototype.createPlugin=function(){return new t},Object.defineProperty(t.prototype,"loaderState",{get:function(){return this._state},enumerable:!1,configurable:!0}),t.prototype.whenCompleteAsync=function(){var e=this;return new Promise(function(n,r){e.onCompleteObservable.addOnce(function(){n()}),e.onErrorObservable.addOnce(function(o){r(o)})})},t.prototype._setState=function(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(J[this._state]))},t.prototype._loadFile=function(e,n,r,o,s,a){var i=this,c=e._loadFile(n,r,function(u){i._onProgress(u,c)},!0,o,s,a);return c.onCompleteObservable.add(function(u){i._requests.splice(i._requests.indexOf(u),1)}),this._requests.push(c),c},t.prototype._onProgress=function(e,n){if(!!this._progressCallback){n._lengthComputable=e.lengthComputable,n._loaded=e.loaded,n._total=e.total;for(var r=!0,o=0,s=0,a=0,i=this._requests;a<i.length;a++){var c=i[a];if(c._lengthComputable===void 0||c._loaded===void 0||c._total===void 0)return;r=r&&c._lengthComputable,o+=c._loaded,s+=c._total}this._progressCallback({lengthComputable:r,loaded:o,total:r?s:0})}},t.prototype._validate=function(e,n,r,o){var s=this;r===void 0&&(r=""),o===void 0&&(o=""),!!this.validate&&(this._startPerformanceCounter("Validate JSON"),Sr.ValidateAsync(n,r,o,function(a){return s.preprocessUrlAsync(r+a).then(function(i){return e._loadFileAsync(i,void 0,!0,!0)})}).then(function(a){s._endPerformanceCounter("Validate JSON"),s.onValidatedObservable.notifyObservers(a),s.onValidatedObservable.clear()},function(a){s._endPerformanceCounter("Validate JSON"),N.Warn("Failed to validate: ".concat(a.message)),s.onValidatedObservable.clear()}))},t.prototype._getLoader=function(e){var n=e.json.asset||{};this._log("Asset version: ".concat(n.version)),n.minVersion&&this._log("Asset minimum version: ".concat(n.minVersion)),n.generator&&this._log("Asset generator: ".concat(n.generator));var r=t._parseVersion(n.version);if(!r)throw new Error("Invalid version: "+n.version);if(n.minVersion!==void 0){var o=t._parseVersion(n.minVersion);if(!o)throw new Error("Invalid minimum version: "+n.minVersion);if(t._compareVersion(o,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+n.minVersion)}var s={1:t._CreateGLTF1Loader,2:t._CreateGLTF2Loader},a=s[r.major];if(!a)throw new Error("Unsupported version: "+n.version);return a(this)},t.prototype._parseJson=function(e){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: ".concat(e.length));var n=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),n},t.prototype._unpackBinaryAsync=function(e){var n=this;return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(function(){var r={Magic:1179937895},o=e.readUint32();if(o!==r.Magic)throw new qn("Unexpected magic: "+o,Xn.GLTFLoaderUnexpectedMagicError);var s=e.readUint32();n.loggingEnabled&&n._log("Binary version: ".concat(s));var a=e.readUint32();if(e.buffer.byteLength!==0&&a!==e.buffer.byteLength)throw new Error("Length in header does not match actual data length: ".concat(a," != ").concat(e.buffer.byteLength));var i;switch(s){case 1:{i=n._unpackBinaryV1Async(e,a);break}case 2:{i=n._unpackBinaryV2Async(e,a);break}default:throw new Error("Unsupported version: "+s)}return n._endPerformanceCounter("Unpack Binary"),i})},t.prototype._unpackBinaryV1Async=function(e,n){var r={JSON:0},o=e.readUint32(),s=e.readUint32();if(s!==r.JSON)throw new Error("Unexpected content format: ".concat(s));var a=n-e.byteOffset,i={json:this._parseJson(e.readString(o)),bin:null};if(a!==0){var c=e.byteOffset;i.bin={readAsync:function(u,l){return e.buffer.readAsync(c+u,l)},byteLength:a}}return Promise.resolve(i)},t.prototype._unpackBinaryV2Async=function(e,n){var r=this,o={JSON:1313821514,BIN:5130562},s=e.readUint32(),a=e.readUint32();if(a!==o.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+s===n?e.loadAsync(s).then(function(){return{json:r._parseJson(e.readString(s)),bin:null}}):e.loadAsync(s+8).then(function(){var i={json:r._parseJson(e.readString(s)),bin:null},c=function(){var u=e.readUint32(),l=e.readUint32();switch(l){case o.JSON:throw new Error("Unexpected JSON chunk");case o.BIN:{var f=e.byteOffset;i.bin={readAsync:function(d,h){return e.buffer.readAsync(f+d,h)},byteLength:u},e.skipBytes(u);break}default:{e.skipBytes(u);break}}return e.byteOffset!==n?e.loadAsync(8).then(c):Promise.resolve(i)};return c()})},t._parseVersion=function(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};var n=(e+"").match(/^(\d+)\.(\d+)/);return n?{major:parseInt(n[1]),minor:parseInt(n[2])}:null},t._compareVersion=function(e,n){return e.major>n.major?1:e.major<n.major?-1:e.minor>n.minor?1:e.minor<n.minor?-1:0},t.prototype._logOpen=function(e){this._log(e),this._logIndentLevel++},t.prototype._logClose=function(){--this._logIndentLevel},t.prototype._logEnabled=function(e){var n=t._logSpaces.substr(0,this._logIndentLevel*2);K.Log("".concat(n).concat(e))},t.prototype._logDisabled=function(e){},t.prototype._startPerformanceCounterEnabled=function(e){N.StartPerformanceCounter(e)},t.prototype._startPerformanceCounterDisabled=function(e){},t.prototype._endPerformanceCounterEnabled=function(e){N.EndPerformanceCounter(e)},t.prototype._endPerformanceCounterDisabled=function(e){},t.IncrementalLoading=!0,t.HomogeneousCoordinates=!1,t._MagicBase64Encoded="Z2xURg",t._logSpaces="                                ",t}();Ce&&Ce.RegisterPlugin(new oe);var se;(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.FLOAT=5126]="FLOAT"})(se||(se={}));var Fe;(function(t){t[t.FRAGMENT=35632]="FRAGMENT",t[t.VERTEX=35633]="VERTEX"})(Fe||(Fe={}));var q;(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D"})(q||(q={}));var ve;(function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.REPEAT=10497]="REPEAT"})(ve||(ve={}));var ee;(function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9728]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ee||(ee={}));var Nn;(function(t){t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Nn||(Nn={}));var Be;(function(t){t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Be||(Be={}));var R;(function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(R||(R={}));var z=function(){function t(){}return t.SetMatrix=function(e,n,r,o,s){var a=null;if(r.semantic==="MODEL"?a=n.getWorldMatrix():r.semantic==="PROJECTION"?a=e.getProjectionMatrix():r.semantic==="VIEW"?a=e.getViewMatrix():r.semantic==="MODELVIEWINVERSETRANSPOSE"?a=W.Transpose(n.getWorldMatrix().multiply(e.getViewMatrix()).invert()):r.semantic==="MODELVIEW"?a=n.getWorldMatrix().multiply(e.getViewMatrix()):r.semantic==="MODELVIEWPROJECTION"?a=n.getWorldMatrix().multiply(e.getTransformMatrix()):r.semantic==="MODELINVERSE"?a=n.getWorldMatrix().invert():r.semantic==="VIEWINVERSE"?a=e.getViewMatrix().invert():r.semantic==="PROJECTIONINVERSE"?a=e.getProjectionMatrix().invert():r.semantic==="MODELVIEWINVERSE"?a=n.getWorldMatrix().multiply(e.getViewMatrix()).invert():r.semantic==="MODELVIEWPROJECTIONINVERSE"?a=n.getWorldMatrix().multiply(e.getTransformMatrix()).invert():r.semantic==="MODELINVERSETRANSPOSE"&&(a=W.Transpose(n.getWorldMatrix().invert())),a)switch(r.type){case q.FLOAT_MAT2:s.setMatrix2x2(o,W.GetAsMatrix2x2(a));break;case q.FLOAT_MAT3:s.setMatrix3x3(o,W.GetAsMatrix3x3(a));break;case q.FLOAT_MAT4:s.setMatrix(o,a);break}},t.SetUniform=function(e,n,r,o){switch(o){case q.FLOAT:return e.setFloat(n,r),!0;case q.FLOAT_VEC2:return e.setVector2(n,zn.FromArray(r)),!0;case q.FLOAT_VEC3:return e.setVector3(n,S.FromArray(r)),!0;case q.FLOAT_VEC4:return e.setVector4(n,Jn.FromArray(r)),!0;default:return!1}},t.GetWrapMode=function(e){switch(e){case ve.CLAMP_TO_EDGE:return P.CLAMP_ADDRESSMODE;case ve.MIRRORED_REPEAT:return P.MIRROR_ADDRESSMODE;case ve.REPEAT:return P.WRAP_ADDRESSMODE;default:return P.WRAP_ADDRESSMODE}},t.GetByteStrideFromType=function(e){var n=e.type;switch(n){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},t.GetTextureFilterMode=function(e){switch(e){case ee.LINEAR:case ee.LINEAR_MIPMAP_NEAREST:case ee.LINEAR_MIPMAP_LINEAR:return P.TRILINEAR_SAMPLINGMODE;case ee.NEAREST:case ee.NEAREST_MIPMAP_NEAREST:return P.NEAREST_SAMPLINGMODE;default:return P.BILINEAR_SAMPLINGMODE}},t.GetBufferFromBufferView=function(e,n,r,o,s){r=n.byteOffset+r;var a=e.loadedBufferViews[n.buffer];if(r+o>a.byteLength)throw new Error("Buffer access is out of range");var i=a.buffer;switch(r+=a.byteOffset,s){case se.BYTE:return new Int8Array(i,r,o);case se.UNSIGNED_BYTE:return new Uint8Array(i,r,o);case se.SHORT:return new Int16Array(i,r,o);case se.UNSIGNED_SHORT:return new Uint16Array(i,r,o);default:return new Float32Array(i,r,o)}},t.GetBufferFromAccessor=function(e,n){var r=e.bufferViews[n.bufferView],o=n.count*t.GetByteStrideFromType(n);return t.GetBufferFromBufferView(e,r,n.byteOffset,o,n.componentType)},t.DecodeBufferToText=function(e){for(var n="",r=e.byteLength,o=0;o<r;++o)n+=String.fromCharCode(e[o]);return n},t.GetDefaultMaterial=function(e){if(!t._DefaultMaterial){ce.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),ce.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);var n={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},r={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};t._DefaultMaterial=new Tn("GLTFDefaultMaterial",e,n,r),t._DefaultMaterial.setColor4("u_emission",new Yn(.5,.5,.5,1))}return t._DefaultMaterial},t._DefaultMaterial=null,t}(),ae;(function(t){t[t.IDENTIFIER=1]="IDENTIFIER",t[t.UNKNOWN=2]="UNKNOWN",t[t.END_OF_INPUT=3]="END_OF_INPUT"})(ae||(ae={}));var xn=function(){function t(e){this._pos=0,this.currentToken=ae.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}return t.prototype.getNextToken=function(){if(this.isEnd())return ae.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=ae.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=ae.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},t.prototype.peek=function(){return this._toParse[this._pos]},t.prototype.read=function(){return this._toParse[this._pos++]},t.prototype.forward=function(){this._pos++},t.prototype.isEnd=function(){return this._pos>=this._maxPos},t}(),Mn=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],Pn=["world","view","projection","worldView","worldViewProjection","mBones"],Cr=["translation","rotation","scale"],br=["position","rotationQuaternion","scaling"],wr=function(t,e){for(var n in t){var r=t[n];e.buffers[n]=r,e.buffersCount++}},Lr=function(t,e){for(var n in t){var r=t[n];e.shaders[n]=r,e.shaderscount++}},U=function(t,e,n){for(var r in t){var o=t[r];n[e][r]=o}},Nr=function(t){if(!!t)for(var e=0;e<t.length/2;e++)t[e*2+1]=1-t[e*2+1]},In=function(t){if(t.semantic==="NORMAL")return"normal";if(t.semantic==="POSITION")return"position";if(t.semantic==="JOINT")return"matricesIndices";if(t.semantic==="WEIGHT")return"matricesWeights";if(t.semantic==="COLOR")return"color";if(t.semantic&&t.semantic.indexOf("TEXCOORD_")!==-1){var e=Number(t.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},xr=function(t){for(var e in t.animations){var n=t.animations[e];if(!(!n.channels||!n.samplers))for(var r=null,o=0;o<n.channels.length;o++){var s=n.channels[o],a=n.samplers[s.sampler];if(!!a){var i=null,c=null;n.parameters?(i=n.parameters[a.input],c=n.parameters[a.output]):(i=a.input,c=a.output);var u=z.GetBufferFromAccessor(t,t.accessors[i]),l=z.GetBufferFromAccessor(t,t.accessors[c]),f=s.target.id,d=t.scene.getNodeById(f);if(d===null&&(d=t.scene.getNodeByName(f)),d===null){N.Warn("Creating animation named "+e+". But cannot find node named "+f+" to attach to");continue}var h=d instanceof he,_=s.target.path,p=Cr.indexOf(_);p!==-1&&(_=br[p]);var v=Q.ANIMATIONTYPE_MATRIX;h||(_==="rotationQuaternion"?(v=Q.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new j):v=Q.ANIMATIONTYPE_VECTOR3);var A=null,T=[],y=0,O=!1;h&&r&&r.getKeys().length===u.length&&(A=r,O=!0),O||(t.scene._blockEntityCollection=!!t.assetContainer,A=new Q(e,h?"_matrix":_,1,v,Q.ANIMATIONLOOPMODE_CYCLE),t.scene._blockEntityCollection=!1);for(var C=0;C<u.length;C++){var b=null;if(_==="rotationQuaternion"?(b=j.FromArray([l[y],l[y+1],l[y+2],l[y+3]]),y+=4):(b=S.FromArray([l[y],l[y+1],l[y+2]]),y+=3),h){var x=d,L=S.Zero(),F=new j,E=S.Zero(),G=x.getBaseMatrix();O&&r&&(G=r.getKeys()[C].value),G.decompose(E,F,L),_==="position"?L=b:_==="rotationQuaternion"?F=b:E=b,b=W.Compose(E,F,L)}O?r&&(r.getKeys()[C].value=b):T.push({frame:u[C],value:b})}!O&&A&&(A.setKeys(T),d.animations.push(A)),r=A,t.scene.stopAnimation(d),t.scene.beginAnimation(d,0,u[u.length-1],!0,1)}}}},De=function(t){var e=null;if(t.translation||t.rotation||t.scale){var n=S.FromArray(t.scale||[1,1,1]),r=j.FromArray(t.rotation||[0,0,0,1]),o=S.FromArray(t.translation||[0,0,0]);e=W.Compose(n,r,o)}else e=W.FromArray(t.matrix);return e},Rn=function(t,e,n,r){for(var o=0;o<r.bones.length;o++)if(r.bones[o].name===n)return r.bones[o];var s=t.nodes;for(var a in s){var i=s[a];if(!!i.jointName)for(var c=i.children,o=0;o<c.length;o++){var u=t.nodes[c[o]];if(!!u.jointName&&u.jointName===n){var l=De(i),f=new he(i.name||"",r,Rn(t,e,i.jointName,r),l);return f.id=a,f}}}return null},Mr=function(t,e){for(var n=0;n<t.length;n++)for(var r=t[n],o=0;o<r.node.children.length;o++){var s=r.node.children[o];if(s===e)return r.bone}return null},Ge=function(t,e){var n=t.nodes,r=n[e];if(r)return{node:r,id:e};for(var o in n)if(r=n[o],r.jointName===e)return{node:r,id:o};return null},Pr=function(t,e){for(var n=0;n<t.jointNames.length;n++)if(t.jointNames[n]===e)return!0;return!1},Ir=function(t,e,n,r){for(var o in t.nodes){var s=t.nodes[o],a=o;if(!(!s.jointName||Pr(n,s.jointName))){var i=De(s),c=new he(s.name||"",e,null,i);c.id=a,r.push({bone:c,node:s,id:a})}}for(var u=0;u<r.length;u++)for(var l=r[u],f=l.node.children,d=0;d<f.length;d++){for(var h=null,_=0;_<r.length;_++)if(r[_].id===f[d]){h=r[_];break}h&&(h.bone._parent=l.bone,l.bone.children.push(h.bone))}},Rr=function(t,e,n,r){if(r||(r=new be(e.name||"","",t.scene)),!e.babylonSkeleton)return r;var o=[],s=[];Ir(t,r,e,o),r.bones=[];for(var a=0;a<e.jointNames.length;a++){var i=Ge(t,e.jointNames[a]);if(!!i){var c=i.node;if(!c){N.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}var u=i.id,l=t.scene.getBoneById(u);if(l){r.bones.push(l);continue}for(var f=!1,d=null,h=0;h<a;h++){var _=Ge(t,e.jointNames[h]);if(!!_){var p=_.node;if(!p){N.Warn("Joint named "+e.jointNames[h]+" does not exist when looking for parent");continue}var v=p.children;if(!!v){f=!1;for(var A=0;A<v.length;A++)if(v[A]===u){d=Rn(t,e,e.jointNames[h],r),f=!0;break}if(f)break}}}var T=De(c);!d&&o.length>0&&(d=Mr(o,u),d&&s.indexOf(d)===-1&&s.push(d));var y=new he(c.jointName||"",r,d,T);y.id=u}}var O=r.bones;r.bones=[];for(var a=0;a<e.jointNames.length;a++){var i=Ge(t,e.jointNames[a]);if(!!i){for(var h=0;h<O.length;h++)if(O[h].id===i.id){r.bones.push(O[h]);break}}}r.prepare();for(var a=0;a<s.length;a++)r.bones.push(s[a]);return r},Fn=function(t,e,n,r,o){if(o||(t.scene._blockEntityCollection=!!t.assetContainer,o=new ue(e.name||"",t.scene),o._parentContainer=t.assetContainer,t.scene._blockEntityCollection=!1,o.id=r),!e.babylonNode)return o;for(var s=[],a=null,i=new Array,c=new Array,u=new Array,l=new Array,f=0;f<n.length;f++){var d=n[f],h=t.meshes[d];if(!!h)for(var _=0;_<h.primitives.length;_++){var p=new $n,v=h.primitives[_];v.mode!==4;var A=v.attributes,T=null,y=null;for(var O in A)if(T=t.accessors[A[O]],y=z.GetBufferFromAccessor(t,T),O==="NORMAL")p.normals=new Float32Array(y.length),p.normals.set(y);else if(O==="POSITION"){if(oe.HomogeneousCoordinates){p.positions=new Float32Array(y.length-y.length/4);for(var C=0;C<y.length;C+=4)p.positions[C]=y[C],p.positions[C+1]=y[C+1],p.positions[C+2]=y[C+2]}else p.positions=new Float32Array(y.length),p.positions.set(y);c.push(p.positions.length)}else if(O.indexOf("TEXCOORD_")!==-1){var b=Number(O.split("_")[1]),x=w.UVKind+(b===0?"":b+1),L=new Float32Array(y.length);L.set(y),Nr(L),p.set(L,x)}else O==="JOINT"?(p.matricesIndices=new Float32Array(y.length),p.matricesIndices.set(y)):O==="WEIGHT"?(p.matricesWeights=new Float32Array(y.length),p.matricesWeights.set(y)):O==="COLOR"&&(p.colors=new Float32Array(y.length),p.colors.set(y));if(T=t.accessors[v.indices],T)y=z.GetBufferFromAccessor(t,T),p.indices=new Int32Array(y.length),p.indices.set(y),l.push(p.indices.length);else{for(var F=[],C=0;C<p.positions.length/3;C++)F.push(C);p.indices=new Int32Array(F),l.push(p.indices.length)}a?a.merge(p):a=p;var E=t.scene.getMaterialById(v.material);s.push(E===null?z.GetDefaultMaterial(t.scene):E),i.push(i.length===0?0:i[i.length-1]+c[c.length-2]),u.push(u.length===0?0:u[u.length-1]+l[l.length-2])}}var G;t.scene._blockEntityCollection=!!t.assetContainer,s.length>1?(G=new Qn("multimat"+r,t.scene),G.subMaterials=s):G=new we("multimat"+r,t.scene),s.length===1&&(G=s[0]),G._parentContainer=t.assetContainer,o.material||(o.material=G),new Pe(r,t.scene,a,!1,o),o.computeWorldMatrix(!0),t.scene._blockEntityCollection=!1,o.subMeshes=[];for(var V=0,f=0;f<n.length;f++){var d=n[f],h=t.meshes[d];if(!!h)for(var _=0;_<h.primitives.length;_++)h.primitives[_].mode!==4,er.AddToMesh(V,i[V],c[V],u[V],l[V],o,o,!0),V++}return o},ke=function(t,e,n,r){t.position&&(t.position=e),(t.rotationQuaternion||t.rotation)&&(t.rotationQuaternion=n),t.scaling&&(t.scaling=r)},Fr=function(t,e){if(e.matrix){var n=new S(0,0,0),r=new j,o=new S(0,0,0),s=W.FromArray(e.matrix);s.decompose(o,r,n),ke(t,n,r,o)}else e.translation&&e.rotation&&e.scale&&ke(t,S.FromArray(e.translation),j.FromArray(e.rotation),S.FromArray(e.scale));t.computeWorldMatrix(!0)},Br=function(t,e,n){var r=null;if(t.importOnlyMeshes&&(e.skin||e.meshes)&&t.importMeshesNames&&t.importMeshesNames.length>0&&t.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){var o=t.skins[e.skin],s=Fn(t,e,e.meshes,n,e.babylonNode);s.skeleton=t.scene.getLastSkeletonById(e.skin),s.skeleton===null&&(s.skeleton=Rr(t,o,s,o.babylonSkeleton),o.babylonSkeleton||(o.babylonSkeleton=s.skeleton)),r=s}}else if(e.meshes){var s=Fn(t,e,e.mesh?[e.mesh]:e.meshes,n,e.babylonNode);r=s}else if(e.light&&!e.babylonNode&&!t.importOnlyMeshes){var a=t.lights[e.light];if(a){if(a.type==="ambient"){var i=a[a.type],c=new Le(e.light,S.Zero(),t.scene);c.name=e.name||"",i.color&&(c.diffuse=M.FromArray(i.color)),r=c}else if(a.type==="directional"){var u=a[a.type],l=new ye(e.light,S.Zero(),t.scene);l.name=e.name||"",u.color&&(l.diffuse=M.FromArray(u.color)),r=l}else if(a.type==="point"){var f=a[a.type],d=new Ne(e.light,S.Zero(),t.scene);d.name=e.name||"",f.color&&(d.diffuse=M.FromArray(f.color)),r=d}else if(a.type==="spot"){var h=a[a.type],_=new xe(e.light,S.Zero(),S.Zero(),0,0,t.scene);_.name=e.name||"",h.color&&(_.diffuse=M.FromArray(h.color)),h.fallOfAngle&&(_.angle=h.fallOfAngle),h.fallOffExponent&&(_.exponent=h.fallOffExponent),r=_}}}else if(e.camera&&!e.babylonNode&&!t.importOnlyMeshes){var p=t.cameras[e.camera];if(p){if(t.scene._blockEntityCollection=!!t.assetContainer,p.type==="orthographic"){var v=new Me(e.camera,S.Zero(),t.scene,!1);v.name=e.name||"",v.mode=On.ORTHOGRAPHIC_CAMERA,v.attachControl(),r=v,v._parentContainer=t.assetContainer}else if(p.type==="perspective"){var A=p[p.type],T=new Me(e.camera,S.Zero(),t.scene,!1);T.name=e.name||"",T.attachControl(),A.aspectRatio||(A.aspectRatio=t.scene.getEngine().getRenderWidth()/t.scene.getEngine().getRenderHeight()),A.znear&&A.zfar&&(T.maxZ=A.zfar,T.minZ=A.znear),r=T,T._parentContainer=t.assetContainer}t.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(r===null){t.scene._blockEntityCollection=!!t.assetContainer;var y=new ue(e.name||"",t.scene);y._parentContainer=t.assetContainer,t.scene._blockEntityCollection=!1,e.babylonNode=y,r=y}}if(r!==null){if(e.matrix&&r instanceof ue)Fr(r,e);else{var O=e.translation||[0,0,0],C=e.rotation||[0,0,0,1],b=e.scale||[1,1,1];ke(r,S.FromArray(O),j.FromArray(C),S.FromArray(b))}r.updateCache(!0),e.babylonNode=r}return r},Ae=function(t,e,n,r){r===void 0&&(r=!1);var o=t.nodes[e],s=null;if(t.importOnlyMeshes&&!r&&t.importMeshesNames?t.importMeshesNames.indexOf(o.name||"")!==-1||t.importMeshesNames.length===0?r=!0:r=!1:r=!0,!o.jointName&&r&&(s=Br(t,o,e),s!==null&&(s.id=e,s.parent=n)),o.children)for(var a=0;a<o.children.length;a++)Ae(t,o.children[a],s,r)},Bn=function(t){var e=t.currentScene;if(e)for(var n=0;n<e.nodes.length;n++)Ae(t,e.nodes[n],null);else for(var r in t.scenes){e=t.scenes[r];for(var n=0;n<e.nodes.length;n++)Ae(t,e.nodes[n],null)}xr(t);for(var n=0;n<t.scene.skeletons.length;n++){var o=t.scene.skeletons[n];t.scene.beginAnimation(o,0,Number.MAX_VALUE,!0,1)}},Dr=function(t,e,n,r,o,s,a){var i=s.values||o.parameters;for(var c in n){var u=n[c],l=u.type;if(l===q.FLOAT_MAT2||l===q.FLOAT_MAT3||l===q.FLOAT_MAT4){if(u.semantic&&!u.source&&!u.node)z.SetMatrix(e.scene,t,u,c,r.getEffect());else if(u.semantic&&(u.source||u.node)){var f=e.scene.getNodeByName(u.source||u.node||"");if(f===null&&(f=e.scene.getNodeById(u.source||u.node||"")),f===null)continue;z.SetMatrix(e.scene,f,u,c,r.getEffect())}}else{var d=i[o.uniforms[c]];if(!d)continue;if(l===q.SAMPLER_2D){var h=e.textures[s.values?d:u.value].babylonTexture;if(h==null)continue;r.getEffect().setTexture(c,h)}else z.SetUniform(r.getEffect(),c,d,l)}}a(r)},Gr=function(t,e,n,r,o){var s=r.values||n.parameters,a=n.uniforms,i=function(u){var l=o[u],f=l.type,d=s[a[u]];if(d===void 0&&(d=l.value),!d)return"continue";var h=function(_){return function(p){l.value&&_&&(e.setTexture(_,p),delete o[_])}};f===q.SAMPLER_2D?te.LoadTextureAsync(t,r.values?d:l.value,h(u),function(){return h(null)}):l.value&&z.SetUniform(e,u,r.values?d:l.value,f)&&delete o[u]};for(var c in o)i(c)},kr=function(t,e,n){return function(r,o){e.dispose(!0),n("Cannot compile program named "+t.name+". Error: "+o+". Default material will be applied")}},Ur=function(t,e,n,r,o,s){return function(a){Gr(t,e,n,r,o),e.onBind=function(i){Dr(i,t,o,e,n,r,s)}}},Dn=function(t,e,n){for(var r in e.uniforms){var o=e.uniforms[r],s=e.parameters[o];if(t.currentIdentifier===r&&s.semantic&&!s.source&&!s.node){var a=Mn.indexOf(s.semantic);if(a!==-1)return delete n[r],Pn[a]}}return t.currentIdentifier},Gn=function(t){for(var e in t.materials)te.LoadMaterialAsync(t,e,function(){},function(){})},re=function(){function t(){}return t.CreateRuntime=function(e,n,r){var o={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:n,rootUrl:r,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&U(e.extensions,"extensions",o),e.extensionsUsed&&U(e.extensionsUsed,"extensionsUsed",o),e.buffers&&wr(e.buffers,o),e.bufferViews&&U(e.bufferViews,"bufferViews",o),e.accessors&&U(e.accessors,"accessors",o),e.meshes&&U(e.meshes,"meshes",o),e.lights&&U(e.lights,"lights",o),e.cameras&&U(e.cameras,"cameras",o),e.nodes&&U(e.nodes,"nodes",o),e.images&&U(e.images,"images",o),e.textures&&U(e.textures,"textures",o),e.shaders&&Lr(e.shaders,o),e.programs&&U(e.programs,"programs",o),e.samplers&&U(e.samplers,"samplers",o),e.techniques&&U(e.techniques,"techniques",o),e.materials&&U(e.materials,"materials",o),e.animations&&U(e.animations,"animations",o),e.skins&&U(e.skins,"skins",o),e.scenes&&(o.scenes=e.scenes),e.scene&&e.scenes&&(o.currentScene=e.scenes[e.scene]),o},t.LoadBufferAsync=function(e,n,r,o,s){var a=e.buffers[n];N.IsBase64(a.uri)?setTimeout(function(){return r(new Uint8Array(N.DecodeBase64(a.uri)))}):N.LoadFile(e.rootUrl+a.uri,function(i){return r(new Uint8Array(i))},s,void 0,!0,function(i){i&&o(i.status+" "+i.statusText)})},t.LoadTextureBufferAsync=function(e,n,r,o){var s=e.textures[n];if(!s||!s.source){o("");return}if(s.babylonTexture){r(null);return}var a=e.images[s.source];N.IsBase64(a.uri)?setTimeout(function(){return r(new Uint8Array(N.DecodeBase64(a.uri)))}):N.LoadFile(e.rootUrl+a.uri,function(i){return r(new Uint8Array(i))},void 0,void 0,!0,function(i){i&&o(i.status+" "+i.statusText)})},t.CreateTextureAsync=function(e,n,r,o){var s=e.textures[n];if(s.babylonTexture){o(s.babylonTexture);return}var a=e.samplers[s.sampler],i=a.minFilter===ee.NEAREST_MIPMAP_NEAREST||a.minFilter===ee.NEAREST_MIPMAP_LINEAR||a.minFilter===ee.LINEAR_MIPMAP_NEAREST||a.minFilter===ee.LINEAR_MIPMAP_LINEAR,c=P.BILINEAR_SAMPLINGMODE,u=r==null?new Blob:new Blob([r]),l=URL.createObjectURL(u),f=function(){return URL.revokeObjectURL(l)},d=new P(l,e.scene,!i,!0,c,f,f);a.wrapS!==void 0&&(d.wrapU=z.GetWrapMode(a.wrapS)),a.wrapT!==void 0&&(d.wrapV=z.GetWrapMode(a.wrapT)),d.name=n,s.babylonTexture=d,o(d)},t.LoadShaderStringAsync=function(e,n,r,o){var s=e.shaders[n];if(N.IsBase64(s.uri)){var a=atob(s.uri.split(",")[1]);r&&r(a)}else N.LoadFile(e.rootUrl+s.uri,r,void 0,void 0,!1,function(i){i&&o&&o(i.status+" "+i.statusText)})},t.LoadMaterialAsync=function(e,n,r,o){var s=e.materials[n];if(!s.technique){o&&o("No technique found.");return}var a=e.techniques[s.technique];if(!a){e.scene._blockEntityCollection=!!e.assetContainer;var i=new we(n,e.scene);i._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,i.diffuseColor=new M(.5,.5,.5),i.sideOrientation=Y.CounterClockWiseSideOrientation,r(i);return}var c=e.programs[a.program],u=a.states,l=ce.ShadersStore[c.vertexShader+"VertexShader"],f=ce.ShadersStore[c.fragmentShader+"PixelShader"],d="",h="",_=new xn(l),p=new xn(f),v={},A=[],T=[],y=[];for(var O in a.uniforms){var C=a.uniforms[O],b=a.parameters[C];if(v[O]=b,b.semantic&&!b.node&&!b.source){var x=Mn.indexOf(b.semantic);x!==-1?(A.push(Pn[x]),delete v[O]):A.push(O)}else b.type===q.SAMPLER_2D?y.push(O):A.push(O)}for(var L in a.attributes){var F=a.attributes[L],E=a.parameters[F];if(E.semantic){var G=In(E);G&&T.push(G)}}for(;!_.isEnd()&&_.getNextToken();){var V=_.currentToken;if(V!==ae.IDENTIFIER){d+=_.currentString;continue}var ne=!1;for(var L in a.attributes){var F=a.attributes[L],E=a.parameters[F];if(_.currentIdentifier===L&&E.semantic){d+=In(E),ne=!0;break}}ne||(d+=Dn(_,a,v))}for(;!p.isEnd()&&p.getNextToken();){var V=p.currentToken;if(V!==ae.IDENTIFIER){h+=p.currentString;continue}h+=Dn(p,a,v)}var $={vertex:c.vertexShader+n,fragment:c.fragmentShader+n},H={attributes:T,uniforms:A,samplers:y,needAlphaBlending:u&&u.enable&&u.enable.indexOf(3042)!==-1};ce.ShadersStore[c.vertexShader+n+"VertexShader"]=d,ce.ShadersStore[c.fragmentShader+n+"PixelShader"]=h;var B=new Tn(n,e.scene,$,H);if(B.onError=kr(c,B,o),B.onCompiled=Ur(e,B,a,s,v,r),B.sideOrientation=Y.CounterClockWiseSideOrientation,u&&u.functions){var ie=u.functions;ie.cullFace&&ie.cullFace[0]!==Be.BACK&&(B.backFaceCulling=!1);var I=ie.blendFuncSeparate;I&&(I[0]===R.SRC_ALPHA&&I[1]===R.ONE_MINUS_SRC_ALPHA&&I[2]===R.ONE&&I[3]===R.ONE?B.alphaMode=le.ALPHA_COMBINE:I[0]===R.ONE&&I[1]===R.ONE&&I[2]===R.ZERO&&I[3]===R.ONE?B.alphaMode=le.ALPHA_ONEONE:I[0]===R.SRC_ALPHA&&I[1]===R.ONE&&I[2]===R.ZERO&&I[3]===R.ONE?B.alphaMode=le.ALPHA_ADD:I[0]===R.ZERO&&I[1]===R.ONE_MINUS_SRC_COLOR&&I[2]===R.ONE&&I[3]===R.ONE?B.alphaMode=le.ALPHA_SUBTRACT:I[0]===R.DST_COLOR&&I[1]===R.ZERO&&I[2]===R.ONE&&I[3]===R.ONE?B.alphaMode=le.ALPHA_MULTIPLY:I[0]===R.SRC_ALPHA&&I[1]===R.ONE_MINUS_SRC_COLOR&&I[2]===R.ONE&&I[3]===R.ONE&&(B.alphaMode=le.ALPHA_MAXIMIZED))}},t}(),me=function(){function t(){}return t.RegisterExtension=function(e){if(t.Extensions[e.name]){N.Error('Tool with the same name "'+e.name+'" already exists');return}t.Extensions[e.name]=e},t.prototype.dispose=function(){},t.prototype._importMeshAsync=function(e,n,r,o,s,a,i,c){var u=this;return n.useRightHandedSystem=!0,te.LoadRuntimeAsync(n,r,o,function(l){l.assetContainer=s,l.importOnlyMeshes=!0,e===""?l.importMeshesNames=[]:typeof e=="string"?l.importMeshesNames=[e]:e&&!(e instanceof Array)?l.importMeshesNames=[e]:(l.importMeshesNames=[],N.Warn("Argument meshesNames must be of type string or string[]")),u._createNodes(l);var f=new Array,d=new Array;for(var h in l.nodes){var _=l.nodes[h];_.babylonNode instanceof Zn&&f.push(_.babylonNode)}for(var p in l.skins){var v=l.skins[p];v.babylonSkeleton instanceof be&&d.push(v.babylonSkeleton)}u._loadBuffersAsync(l,function(){u._loadShadersAsync(l,function(){Gn(l),Bn(l),!oe.IncrementalLoading&&a&&a(f,d)})}),oe.IncrementalLoading&&a&&a(f,d)},c),!0},t.prototype.importMeshAsync=function(e,n,r,o,s,a){var i=this;return new Promise(function(c,u){i._importMeshAsync(e,n,o,s,r,function(l,f){c({meshes:l,particleSystems:[],skeletons:f,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},a,function(l){u(new Error(l))})})},t.prototype._loadAsync=function(e,n,r,o,s,a){var i=this;e.useRightHandedSystem=!0,te.LoadRuntimeAsync(e,n,r,function(c){te.LoadRuntimeExtensionsAsync(c,function(){i._createNodes(c),i._loadBuffersAsync(c,function(){i._loadShadersAsync(c,function(){Gn(c),Bn(c),oe.IncrementalLoading||o()})}),oe.IncrementalLoading&&o()},a)},a)},t.prototype.loadAsync=function(e,n,r,o){var s=this;return new Promise(function(a,i){s._loadAsync(e,n,r,function(){a()},o,function(c){i(new Error(c))})})},t.prototype._loadShadersAsync=function(e,n){var r=!1,o=function(i,c){te.LoadShaderStringAsync(e,i,function(u){u instanceof ArrayBuffer||(e.loadedShaderCount++,u&&(ce.ShadersStore[i+(c.type===Fe.VERTEX?"VertexShader":"PixelShader")]=u),e.loadedShaderCount===e.shaderscount&&n())},function(){N.Error("Error when loading shader program named "+i+" located at "+c.uri)})};for(var s in e.shaders){r=!0;var a=e.shaders[s];a?o.bind(this,s,a)():N.Error("No shader named: "+s)}r||n()},t.prototype._loadBuffersAsync=function(e,n){var r=!1,o=function(i,c){te.LoadBufferAsync(e,i,function(u){e.loadedBufferCount++,u&&(u.byteLength!=e.buffers[i].byteLength&&N.Error("Buffer named "+i+" is length "+u.byteLength+". Expected: "+c.byteLength),e.loadedBufferViews[i]=u),e.loadedBufferCount===e.buffersCount&&n()},function(){N.Error("Error when loading buffer named "+i+" located at "+c.uri)})};for(var s in e.buffers){r=!0;var a=e.buffers[s];a?o.bind(this,s,a)():N.Error("No buffer named: "+s)}r||n()},t.prototype._createNodes=function(e){var n=e.currentScene;if(n)for(var r=0;r<n.nodes.length;r++)Ae(e,n.nodes[r],null);else for(var o in e.scenes){n=e.scenes[o];for(var r=0;r<n.nodes.length;r++)Ae(e,n.nodes[r],null)}},t.Extensions={},t}(),te=function(){function t(e){this._name=e}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),t.prototype.loadRuntimeAsync=function(e,n,r,o,s){return!1},t.prototype.loadRuntimeExtensionsAsync=function(e,n,r){return!1},t.prototype.loadBufferAsync=function(e,n,r,o,s){return!1},t.prototype.loadTextureBufferAsync=function(e,n,r,o){return!1},t.prototype.createTextureAsync=function(e,n,r,o,s){return!1},t.prototype.loadShaderStringAsync=function(e,n,r,o){return!1},t.prototype.loadMaterialAsync=function(e,n,r,o){return!1},t.LoadRuntimeAsync=function(e,n,r,o,s){t._ApplyExtensions(function(a){return a.loadRuntimeAsync(e,n,r,o,s)},function(){setTimeout(function(){!o||o(re.CreateRuntime(n.json,e,r))})})},t.LoadRuntimeExtensionsAsync=function(e,n,r){t._ApplyExtensions(function(o){return o.loadRuntimeExtensionsAsync(e,n,r)},function(){setTimeout(function(){n()})})},t.LoadBufferAsync=function(e,n,r,o,s){t._ApplyExtensions(function(a){return a.loadBufferAsync(e,n,r,o,s)},function(){re.LoadBufferAsync(e,n,r,o,s)})},t.LoadTextureAsync=function(e,n,r,o){t._LoadTextureBufferAsync(e,n,function(s){s&&t._CreateTextureAsync(e,n,s,r,o)},o)},t.LoadShaderStringAsync=function(e,n,r,o){t._ApplyExtensions(function(s){return s.loadShaderStringAsync(e,n,r,o)},function(){re.LoadShaderStringAsync(e,n,r,o)})},t.LoadMaterialAsync=function(e,n,r,o){t._ApplyExtensions(function(s){return s.loadMaterialAsync(e,n,r,o)},function(){re.LoadMaterialAsync(e,n,r,o)})},t._LoadTextureBufferAsync=function(e,n,r,o){t._ApplyExtensions(function(s){return s.loadTextureBufferAsync(e,n,r,o)},function(){re.LoadTextureBufferAsync(e,n,r,o)})},t._CreateTextureAsync=function(e,n,r,o,s){t._ApplyExtensions(function(a){return a.createTextureAsync(e,n,r,o,s)},function(){re.CreateTextureAsync(e,n,r,o)})},t._ApplyExtensions=function(e,n){for(var r in me.Extensions){var o=me.Extensions[r];if(e(o))return}n()},t}();oe._CreateGLTF1Loader=function(){return new me};var Vr="binary_glTF",Hr=function(t){Sn(e,t);function e(){return t.call(this,"KHR_binary_glTF")||this}return e.prototype.loadRuntimeAsync=function(n,r,o,s){var a=r.json.extensionsUsed;return!a||a.indexOf(this.name)===-1||!r.bin?!1:(this._bin=r.bin,s(re.CreateRuntime(r.json,n,o)),!0)},e.prototype.loadBufferAsync=function(n,r,o,s){return n.extensionsUsed.indexOf(this.name)===-1||r!==Vr?!1:(this._bin.readAsync(0,this._bin.byteLength).then(o,function(a){return s(a.message)}),!0)},e.prototype.loadTextureBufferAsync=function(n,r,o){var s=n.textures[r],a=n.images[s.source];if(!a.extensions||!(this.name in a.extensions))return!1;var i=a.extensions[this.name],c=n.bufferViews[i.bufferView],u=z.GetBufferFromBufferView(n,c,0,c.byteLength,se.UNSIGNED_BYTE);return o(u),!0},e.prototype.loadShaderStringAsync=function(n,r,o){var s=n.shaders[r];if(!s.extensions||!(this.name in s.extensions))return!1;var a=s.extensions[this.name],i=n.bufferViews[a.bufferView],c=z.GetBufferFromBufferView(n,i,0,i.byteLength,se.UNSIGNED_BYTE);return setTimeout(function(){var u=z.DecodeBufferToText(c);o(u)}),!0},e}(te);me.RegisterExtension(new Hr);var Kr=function(t){Sn(e,t);function e(){return t.call(this,"KHR_materials_common")||this}return e.prototype.loadRuntimeExtensionsAsync=function(n){if(!n.extensions)return!1;var r=n.extensions[this.name];if(!r)return!1;var o=r.lights;if(o)for(var s in o){var a=o[s];switch(a.type){case"ambient":{var i=new Le(a.name,new S(0,1,0),n.scene),c=a.ambient;c&&(i.diffuse=M.FromArray(c.color||[1,1,1]));break}case"point":{var u=new Ne(a.name,new S(10,10,10),n.scene),l=a.point;l&&(u.diffuse=M.FromArray(l.color||[1,1,1]));break}case"directional":{var f=new ye(a.name,new S(0,-1,0),n.scene),d=a.directional;d&&(f.diffuse=M.FromArray(d.color||[1,1,1]));break}case"spot":{var h=a.spot;if(h){var _=new xe(a.name,new S(0,10,0),new S(0,-1,0),h.fallOffAngle||Math.PI,h.fallOffExponent||0,n.scene);_.diffuse=M.FromArray(h.color||[1,1,1])}break}default:N.Warn('GLTF Material Common extension: light type "'+a.type+"\u201D not supported");break}}return!1},e.prototype.loadMaterialAsync=function(n,r,o,s){var a=n.materials[r];if(!a||!a.extensions)return!1;var i=a.extensions[this.name];if(!i)return!1;var c=new we(r,n.scene);return c.sideOrientation=Y.CounterClockWiseSideOrientation,i.technique==="CONSTANT"&&(c.disableLighting=!0),c.backFaceCulling=i.doubleSided===void 0?!1:!i.doubleSided,c.alpha=i.values.transparency===void 0?1:i.values.transparency,c.specularPower=i.values.shininess===void 0?0:i.values.shininess,typeof i.values.ambient=="string"?this._loadTexture(n,i.values.ambient,c,"ambientTexture",s):c.ambientColor=M.FromArray(i.values.ambient||[0,0,0]),typeof i.values.diffuse=="string"?this._loadTexture(n,i.values.diffuse,c,"diffuseTexture",s):c.diffuseColor=M.FromArray(i.values.diffuse||[0,0,0]),typeof i.values.emission=="string"?this._loadTexture(n,i.values.emission,c,"emissiveTexture",s):c.emissiveColor=M.FromArray(i.values.emission||[0,0,0]),typeof i.values.specular=="string"?this._loadTexture(n,i.values.specular,c,"specularTexture",s):c.specularColor=M.FromArray(i.values.specular||[0,0,0]),!0},e.prototype._loadTexture=function(n,r,o,s,a){re.LoadTextureBufferAsync(n,r,function(i){re.CreateTextureAsync(n,r,i,function(c){return o[s]=c})},a)},e}(te);me.RegisterExtension(new Kr);var m=function(){function t(){}return t.Get=function(e,n,r){if(!n||r==null||!n[r])throw new Error("".concat(e,": Failed to find index (").concat(r,")"));return n[r]},t.Assign=function(e){if(e)for(var n=0;n<e.length;n++)e[n].index=n},t}(),g=function(){function t(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}return t.RegisterExtension=function(e,n){t.UnregisterExtension(e)&&K.Warn("Extension with the name '".concat(e,"' already exists")),t._RegisteredExtensions[e]={factory:n}},t.UnregisterExtension=function(e){return t._RegisteredExtensions[e]?(delete t._RegisteredExtensions[e],!0):!1},Object.defineProperty(t.prototype,"gltf",{get:function(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bin",{get:function(){return this._bin},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"babylonScene",{get:function(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(function(e){return e.dispose&&e.dispose()}),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())},t.prototype.importMeshAsync=function(e,n,r,o,s,a,i){var c=this;return i===void 0&&(i=""),Promise.resolve().then(function(){c._babylonScene=n,c._assetContainer=r,c._loadData(o);var u=null;if(e){var l={};if(c._gltf.nodes)for(var f=0,d=c._gltf.nodes;f<d.length;f++){var h=d[f];h.name&&(l[h.name]=h.index)}var _=e instanceof Array?e:[e];u=_.map(function(p){var v=l[p];if(v===void 0)throw new Error("Failed to find node '".concat(p,"'"));return v})}return c._loadAsync(s,i,u,function(){return{meshes:c._getMeshes(),particleSystems:[],skeletons:c._getSkeletons(),animationGroups:c._getAnimationGroups(),lights:c._babylonLights,transformNodes:c._getTransformNodes(),geometries:c._getGeometries()}})})},t.prototype.loadAsync=function(e,n,r,o,s){var a=this;return s===void 0&&(s=""),Promise.resolve().then(function(){return a._babylonScene=e,a._loadData(n),a._loadAsync(r,s,null,function(){})})},t.prototype._loadAsync=function(e,n,r,o){var s=this;return Promise.resolve().then(function(){s._rootUrl=e,s._uniqueRootUrl=!e.startsWith("file:")&&n?e:"".concat(e).concat(Date.now(),"/"),s._fileName=n,s._loadExtensions(),s._checkExtensions();var a="".concat(J[J.LOADING]," => ").concat(J[J.READY]),i="".concat(J[J.LOADING]," => ").concat(J[J.COMPLETE]);s._parent._startPerformanceCounter(a),s._parent._startPerformanceCounter(i),s._parent._setState(J.LOADING),s._extensionsOnLoading();var c=new Array,u=s._babylonScene.blockMaterialDirtyMechanism;if(s._babylonScene.blockMaterialDirtyMechanism=!0,!s.parent.loadOnlyMaterials){if(r)c.push(s.loadSceneAsync("/nodes",{nodes:r,index:-1}));else if(s._gltf.scene!=null||s._gltf.scenes&&s._gltf.scenes[0]){var l=m.Get("/scene",s._gltf.scenes,s._gltf.scene||0);c.push(s.loadSceneAsync("/scenes/".concat(l.index),l))}}if(!s.parent.skipMaterials&&s.parent.loadAllMaterials&&s._gltf.materials)for(var f=0;f<s._gltf.materials.length;++f){var d=s._gltf.materials[f],h="/materials/"+f,_=Y.TriangleFillMode;c.push(s._loadMaterialAsync(h,d,null,_,function(){}))}s._babylonScene.blockMaterialDirtyMechanism=u,s._parent.compileMaterials&&c.push(s._compileMaterialsAsync()),s._parent.compileShadowGenerators&&c.push(s._compileShadowGeneratorsAsync());var p=Promise.all(c).then(function(){return s._rootBabylonMesh&&s._rootBabylonMesh.setEnabled(!0),s._extensionsOnReady(),s._parent._setState(J.READY),s._startAnimations(),o()});return p.then(function(v){return s._parent._endPerformanceCounter(a),N.SetImmediate(function(){s._disposed||Promise.all(s._completePromises).then(function(){s._parent._endPerformanceCounter(i),s._parent._setState(J.COMPLETE),s._parent.onCompleteObservable.notifyObservers(void 0),s._parent.onCompleteObservable.clear(),s.dispose()},function(A){s._parent.onErrorObservable.notifyObservers(A),s._parent.onErrorObservable.clear(),s.dispose()})}),v})}).catch(function(a){throw s._disposed||(s._parent.onErrorObservable.notifyObservers(a),s._parent.onErrorObservable.clear(),s.dispose()),a})},t.prototype._loadData=function(e){if(this._gltf=e.json,this._setupData(),e.bin){var n=this._gltf.buffers;if(n&&n[0]&&!n[0].uri){var r=n[0];(r.byteLength<e.bin.byteLength-3||r.byteLength>e.bin.byteLength)&&K.Warn("Binary buffer length (".concat(r.byteLength,") from JSON does not match chunk length (").concat(e.bin.byteLength,")")),this._bin=e.bin}else K.Warn("Unexpected BIN chunk")}},t.prototype._setupData=function(){if(m.Assign(this._gltf.accessors),m.Assign(this._gltf.animations),m.Assign(this._gltf.buffers),m.Assign(this._gltf.bufferViews),m.Assign(this._gltf.cameras),m.Assign(this._gltf.images),m.Assign(this._gltf.materials),m.Assign(this._gltf.meshes),m.Assign(this._gltf.nodes),m.Assign(this._gltf.samplers),m.Assign(this._gltf.scenes),m.Assign(this._gltf.skins),m.Assign(this._gltf.textures),this._gltf.nodes){for(var e={},n=0,r=this._gltf.nodes;n<r.length;n++){var o=r[n];if(o.children)for(var s=0,a=o.children;s<a.length;s++){var i=a[s];e[i]=o.index}}for(var c=this._createRootNode(),u=0,l=this._gltf.nodes;u<l.length;u++){var o=l[u],f=e[o.index];o.parent=f===void 0?c:this._gltf.nodes[f]}}},t.prototype._loadExtensions=function(){for(var e in t._RegisteredExtensions){var n=t._RegisteredExtensions[e].factory(this);n.name!==e&&K.Warn("The name of the glTF loader extension instance does not match the registered name: ".concat(n.name," !== ").concat(e)),this._extensions.push(n),this._parent.onExtensionLoadedObservable.notifyObservers(n)}this._extensions.sort(function(r,o){return(r.order||Number.MAX_VALUE)-(o.order||Number.MAX_VALUE)}),this._parent.onExtensionLoadedObservable.clear()},t.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var e=function(a){var i=n._extensions.some(function(c){return c.name===a&&c.enabled});if(!i)throw new Error("Require extension ".concat(a," is not available"))},n=this,r=0,o=this._gltf.extensionsRequired;r<o.length;r++){var s=o[r];e(s)}},t.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new ue("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case pe.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],t._LoadTransform(e,this._rootBabylonMesh));break}case pe.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error("Invalid coordinate system mode (".concat(this._parent.coordinateSystemMode,")"))}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e},t.prototype.loadSceneAsync=function(e,n){var r=this,o=this._extensionsLoadSceneAsync(e,n);if(o)return o;var s=new Array;if(this.logOpen("".concat(e," ").concat(n.name||"")),n.nodes)for(var a=0,i=n.nodes;a<i.length;a++){var c=i[a],u=m.Get("".concat(e,"/nodes/").concat(c),this._gltf.nodes,c);s.push(this.loadNodeAsync("/nodes/".concat(u.index),u,function(h){h.parent=r._rootBabylonMesh}))}for(var l=0,f=this._postSceneLoadActions;l<f.length;l++){var d=f[l];d()}return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then(function(){})},t.prototype._forEachPrimitive=function(e,n){if(e._primitiveBabylonMeshes)for(var r=0,o=e._primitiveBabylonMeshes;r<o.length;r++){var s=o[r];n(s)}},t.prototype._getGeometries=function(){var e=new Array,n=this._gltf.nodes;if(n)for(var r=0,o=n;r<o.length;r++){var s=o[r];this._forEachPrimitive(s,function(a){var i=a.geometry;i&&e.indexOf(i)===-1&&e.push(i)})}return e},t.prototype._getMeshes=function(){var e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);var n=this._gltf.nodes;if(n)for(var r=0,o=n;r<o.length;r++){var s=o[r];this._forEachPrimitive(s,function(a){e.push(a)})}return e},t.prototype._getTransformNodes=function(){var e=new Array,n=this._gltf.nodes;if(n)for(var r=0,o=n;r<o.length;r++){var s=o[r];s._babylonTransformNode&&s._babylonTransformNode.getClassName()==="TransformNode"&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin)}return e},t.prototype._getSkeletons=function(){var e=new Array,n=this._gltf.skins;if(n)for(var r=0,o=n;r<o.length;r++){var s=o[r];s._data&&e.push(s._data.babylonSkeleton)}return e},t.prototype._getAnimationGroups=function(){var e=new Array,n=this._gltf.animations;if(n)for(var r=0,o=n;r<o.length;r++){var s=o[r];s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup)}return e},t.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case fe.NONE:break;case fe.FIRST:{var e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case fe.ALL:{for(var e=this._getAnimationGroups(),n=0,r=e;n<r.length;n++){var o=r[n];o.start(!0)}break}default:{K.Error("Invalid animation start mode (".concat(this._parent.animationStartMode,")"));return}}},t.prototype.loadNodeAsync=function(e,n,r){var o=this;r===void 0&&(r=function(){});var s=this._extensionsLoadNodeAsync(e,n,r);if(s)return s;if(n._babylonTransformNode)throw new Error("".concat(e,": Invalid recursive node hierarchy"));var a=new Array;this.logOpen("".concat(e," ").concat(n.name||""));var i=function(f){if(t.AddPointerMetadata(f,e),t._LoadTransform(n,f),n.camera!=null){var d=m.Get("".concat(e,"/camera"),o._gltf.cameras,n.camera);a.push(o.loadCameraAsync("/cameras/".concat(d.index),d,function(A){A.parent=f}))}if(n.children)for(var h=0,_=n.children;h<_.length;h++){var p=_[h],v=m.Get("".concat(e,"/children/").concat(p),o._gltf.nodes,p);a.push(o.loadNodeAsync("/nodes/".concat(v.index),v,function(A){A.parent=f}))}r(f)};if(n.mesh==null||n.skin!=null){var c=n.name||"node".concat(n.index);this._babylonScene._blockEntityCollection=!!this._assetContainer;var u=new Cn(c,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.mesh==null?n._babylonTransformNode=u:n._babylonTransformNodeForSkin=u,i(u)}if(n.mesh!=null)if(n.skin==null){var l=m.Get("".concat(e,"/mesh"),this._gltf.meshes,n.mesh);a.push(this._loadMeshAsync("/meshes/".concat(l.index),n,l,i))}else{var l=m.Get("".concat(e,"/mesh"),this._gltf.meshes,n.mesh);a.push(this._loadMeshAsync("/meshes/".concat(l.index),n,l,function(d){var h=n._babylonTransformNodeForSkin,_=m.Get("".concat(e,"/skin"),o._gltf.skins,n.skin);a.push(o._loadSkinAsync("/skins/".concat(_.index),n,_,function(p){o._forEachPrimitive(n,function(v){v.skeleton=p}),o._postSceneLoadActions.push(function(){if(_.skeleton!=null){var v=m.Get("/skins/".concat(_.index,"/skeleton"),o._gltf.nodes,_.skeleton).parent;n.index===v.index?d.parent=n._babylonTransformNodeForSkin.parent:d.parent=v._babylonTransformNode}else d.parent=o._rootBabylonMesh;o._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:d})})}))}))}return this.logClose(),Promise.all(a).then(function(){return o._forEachPrimitive(n,function(f){f.geometry&&f.geometry.useBoundingInfoFromGeometry?f._updateBoundingInfo():f.refreshBoundingInfo(!0)}),n._babylonTransformNode})},t.prototype._loadMeshAsync=function(e,n,r,o){var s=r.primitives;if(!s||!s.length)throw new Error("".concat(e,": Primitives are missing"));s[0].index==null&&m.Assign(s);var a=new Array;this.logOpen("".concat(e," ").concat(r.name||""));var i=n.name||"node".concat(n.index);if(s.length===1){var c=r.primitives[0];a.push(this._loadMeshPrimitiveAsync("".concat(e,"/primitives/").concat(c.index),i,n,r,c,function(f){n._babylonTransformNode=f,n._primitiveBabylonMeshes=[f]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,n._babylonTransformNode=new Cn(i,this._babylonScene),n._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._primitiveBabylonMeshes=[];for(var u=0,l=s;u<l.length;u++){var c=l[u];a.push(this._loadMeshPrimitiveAsync("".concat(e,"/primitives/").concat(c.index),"".concat(i,"_primitive").concat(c.index),n,r,c,function(d){d.parent=n._babylonTransformNode,n._primitiveBabylonMeshes.push(d)}))}}return o(n._babylonTransformNode),this.logClose(),Promise.all(a).then(function(){return n._babylonTransformNode})},t.prototype._loadMeshPrimitiveAsync=function(e,n,r,o,s,a){var i=this,c=this._extensionsLoadMeshPrimitiveAsync(e,n,r,o,s,a);if(c)return c;this.logOpen("".concat(e));var u=this._disableInstancedMesh===0&&this._parent.createInstances&&r.skin==null&&!o.primitives[0].targets,l,f;if(u&&s._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=s._instanceData.babylonSourceMesh.createInstance(n),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f=s._instanceData.promise;else{var d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;var h=new ue(n,this._babylonScene);h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?Y.CounterClockWiseSideOrientation:Y.ClockWiseSideOrientation,this._createMorphTargets(e,r,o,s,h),d.push(this._loadVertexDataAsync(e,s,h).then(function(A){return i._loadMorphTargetsAsync(e,s,h,A).then(function(){i._disposed||(i._babylonScene._blockEntityCollection=!!i._assetContainer,A.applyToMesh(h),A._parentContainer=i._assetContainer,i._babylonScene._blockEntityCollection=!1)})}));var _=t._GetDrawMode(e,s.mode);if(s.material==null){var p=this._defaultBabylonMaterialData[_];p||(p=this._createDefaultMaterial("__GLTFLoader._default",_),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[_]=p),h.material=p}else if(!this.parent.skipMaterials){var v=m.Get("".concat(e,"/material"),this._gltf.materials,s.material);d.push(this._loadMaterialAsync("/materials/".concat(v.index),v,h,_,function(A){h.material=A}))}f=Promise.all(d),u&&(s._instanceData={babylonSourceMesh:h,promise:f}),l=h}return t.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),a(l),this.logClose(),f.then(function(){return l})},t.prototype._loadVertexDataAsync=function(e,n,r){var o=this,s=this._extensionsLoadVertexDataAsync(e,n,r);if(s)return s;var a=n.attributes;if(!a)throw new Error("".concat(e,": Attributes are missing"));var i=new Array,c=new Pe(r.name,this._babylonScene);if(n.indices==null)r.isUnIndexed=!0;else{var u=m.Get("".concat(e,"/indices"),this._gltf.accessors,n.indices);i.push(this._loadIndicesAccessorAsync("/accessors/".concat(u.index),u).then(function(f){c.setIndices(f)}))}var l=function(f,d,h){if(a[f]!=null){r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(d)===-1&&r._delayInfo.push(d);var _=m.Get("".concat(e,"/attributes/").concat(f),o._gltf.accessors,a[f]);i.push(o._loadVertexAccessorAsync("/accessors/".concat(_.index),_,d).then(function(p){if(p.getKind()===w.PositionKind&&!o.parent.alwaysComputeBoundingBox&&!r.skeleton){var v=_.min,A=_.max;if(v!==void 0&&A!==void 0){if(_.normalized&&_.componentType!==5126){var T=1;switch(_.componentType){case 5120:T=127;break;case 5121:T=255;break;case 5122:T=32767;break;case 5123:T=65535;break}for(var y=0;y<3;++y)v[y]=Math.max(v[y]/T,-1),A[y]=Math.max(A[y]/T,-1)}var O=Z.Vector3[0],C=Z.Vector3[1];O.copyFromFloats.apply(O,v),C.copyFromFloats.apply(C,A),c._boundingInfo=new ir(O,C),c.useBoundingInfoFromGeometry=!0}}c.setVerticesBuffer(p,_.count)})),d==w.MatricesIndicesExtraKind&&(r.numBoneInfluencers=8),h&&h(_)}};return l("POSITION",w.PositionKind),l("NORMAL",w.NormalKind),l("TANGENT",w.TangentKind),l("TEXCOORD_0",w.UVKind),l("TEXCOORD_1",w.UV2Kind),l("TEXCOORD_2",w.UV3Kind),l("TEXCOORD_3",w.UV4Kind),l("TEXCOORD_4",w.UV5Kind),l("TEXCOORD_5",w.UV6Kind),l("JOINTS_0",w.MatricesIndicesKind),l("WEIGHTS_0",w.MatricesWeightsKind),l("JOINTS_1",w.MatricesIndicesExtraKind),l("WEIGHTS_1",w.MatricesWeightsExtraKind),l("COLOR_0",w.ColorKind,function(f){f.type==="VEC4"&&(r.hasVertexAlpha=!0)}),Promise.all(i).then(function(){return c})},t.prototype._createMorphTargets=function(e,n,r,o,s){if(!!o.targets){if(n._numMorphTargets==null)n._numMorphTargets=o.targets.length;else if(o.targets.length!==n._numMorphTargets)throw new Error("".concat(e,": Primitives do not have the same number of targets"));var a=r.extras?r.extras.targetNames:null;s.morphTargetManager=new nr(s.getScene()),s.morphTargetManager.areUpdatesFrozen=!0;for(var i=0;i<o.targets.length;i++){var c=n.weights?n.weights[i]:r.weights?r.weights[i]:0,u=a?a[i]:"morphTarget".concat(i);s.morphTargetManager.addTarget(new rr(u,c,s.getScene()))}}},t.prototype._loadMorphTargetsAsync=function(e,n,r,o){if(!n.targets)return Promise.resolve();for(var s=new Array,a=r.morphTargetManager,i=0;i<a.numTargets;i++){var c=a.getTarget(i);s.push(this._loadMorphTargetVertexDataAsync("".concat(e,"/targets/").concat(i),o,n.targets[i],c))}return Promise.all(s).then(function(){a.areUpdatesFrozen=!1})},t.prototype._loadMorphTargetVertexDataAsync=function(e,n,r,o){var s=this,a=new Array,i=function(c,u,l){if(r[c]!=null){var f=n.getVertexBuffer(u);if(!!f){var d=m.Get("".concat(e,"/").concat(c),s._gltf.accessors,r[c]);a.push(s._loadFloatAccessorAsync("/accessors/".concat(d.index),d).then(function(h){l(f,h)}))}}};return i("POSITION",w.PositionKind,function(c,u){var l=new Float32Array(u.length);c.forEach(u.length,function(f,d){l[d]=u[d]+f}),o.setPositions(l)}),i("NORMAL",w.NormalKind,function(c,u){var l=new Float32Array(u.length);c.forEach(l.length,function(f,d){l[d]=u[d]+f}),o.setNormals(l)}),i("TANGENT",w.TangentKind,function(c,u){var l=new Float32Array(u.length/3*4),f=0;c.forEach(u.length/3*4,function(d,h){(h+1)%4!=0&&(l[f]=u[f]+d,f++)}),o.setTangents(l)}),Promise.all(a).then(function(){})},t._LoadTransform=function(e,n){if(e.skin==null){var r=S.Zero(),o=j.Identity(),s=S.One();if(e.matrix){var a=W.FromArray(e.matrix);a.decompose(s,o,r)}else e.translation&&(r=S.FromArray(e.translation)),e.rotation&&(o=j.FromArray(e.rotation)),e.scale&&(s=S.FromArray(e.scale));n.position=r,n.rotationQuaternion=o,n.scaling=s}},t.prototype._loadSkinAsync=function(e,n,r,o){var s=this,a=this._extensionsLoadSkinAsync(e,n,r);if(a)return a;if(r._data)return o(r._data.babylonSkeleton),r._data.promise;var i="skeleton".concat(r.index);this._babylonScene._blockEntityCollection=!!this._assetContainer;var c=new be(r.name||i,i,this._babylonScene);c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,r,c);var u=this._loadSkinInverseBindMatricesDataAsync(e,r).then(function(l){s._updateBoneMatrices(c,l)});return r._data={babylonSkeleton:c,promise:u},o(c),u},t.prototype._loadBones=function(e,n,r){if(n.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){var o=this._findSkeletonRootNode("".concat(e,"/joints"),n.joints);if(o)if(n.skeleton===void 0)n.skeleton=o.index;else{var s=function(d,h){for(;h.parent;h=h.parent)if(h.parent===d)return!0;return!1},a=m.Get("".concat(e,"/skeleton"),this._gltf.nodes,n.skeleton);a!==o&&!s(a,o)&&(K.Warn("".concat(e,"/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root")),n.skeleton=o.index)}else K.Warn("".concat(e,": Failed to find common root"))}for(var i={},c=0,u=n.joints;c<u.length;c++){var l=u[c],f=m.Get("".concat(e,"/joints/").concat(l),this._gltf.nodes,l);this._loadBone(f,n,r,i)}},t.prototype._findSkeletonRootNode=function(e,n){if(n.length===0)return null;for(var r={},o=0,s=n;o<s.length;o++){for(var a=s[o],i=new Array,c=m.Get("".concat(e,"/").concat(a),this._gltf.nodes,a);c.index!==-1;)i.unshift(c),c=c.parent;r[a]=i}for(var u=null,l=0;;++l){var i=r[n[0]];if(l>=i.length)return u;for(var c=i[l],f=1;f<n.length;++f)if(i=r[n[f]],l>=i.length||c!==i[l])return u;u=c}},t.prototype._loadBone=function(e,n,r,o){var s=o[e.index];if(s)return s;var a=null;e.index!==n.skeleton&&(e.parent&&e.parent.index!==-1?a=this._loadBone(e.parent,n,r,o):n.skeleton!==void 0&&K.Warn("/skins/".concat(n.index,"/skeleton: Skeleton node is not a common root")));var i=n.joints.indexOf(e.index);return s=new he(e.name||"joint".concat(e.index),r,a,this._getNodeMatrix(e),null,null,i),o[e.index]=s,this._postSceneLoadActions.push(function(){s.linkTransformNode(e._babylonTransformNode)}),s},t.prototype._loadSkinInverseBindMatricesDataAsync=function(e,n){if(n.inverseBindMatrices==null)return Promise.resolve(null);var r=m.Get("".concat(e,"/inverseBindMatrices"),this._gltf.accessors,n.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/".concat(r.index),r)},t.prototype._updateBoneMatrices=function(e,n){for(var r=0,o=e.bones;r<o.length;r++){var s=o[r],a=W.Identity(),i=s._index;n&&i!==-1&&(W.FromArrayToRef(n,i*16,a),a.invertToRef(a));var c=s.getParent();c&&a.multiplyToRef(c.getInvertedAbsoluteTransform(),a),s.updateMatrix(a,!1,!1),s._updateDifferenceMatrix(void 0,!1)}},t.prototype._getNodeMatrix=function(e){return e.matrix?W.FromArray(e.matrix):W.Compose(e.scale?S.FromArray(e.scale):S.One(),e.rotation?j.FromArray(e.rotation):j.Identity(),e.translation?S.FromArray(e.translation):S.Zero())},t.prototype.loadCameraAsync=function(e,n,r){r===void 0&&(r=function(){});var o=this._extensionsLoadCameraAsync(e,n,r);if(o)return o;var s=new Array;this.logOpen("".concat(e," ").concat(n.name||"")),this._babylonScene._blockEntityCollection=!!this._assetContainer;var a=new Me(n.name||"camera".concat(n.index),S.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,a.rotation=new S(0,Math.PI,0),n.type){case"perspective":{var i=n.perspective;if(!i)throw new Error("".concat(e,": Camera perspective properties are missing"));a.fov=i.yfov,a.minZ=i.znear,a.maxZ=i.zfar||0;break}case"orthographic":{if(!n.orthographic)throw new Error("".concat(e,": Camera orthographic properties are missing"));a.mode=On.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-n.orthographic.xmag,a.orthoRight=n.orthographic.xmag,a.orthoBottom=-n.orthographic.ymag,a.orthoTop=n.orthographic.ymag,a.minZ=n.orthographic.znear,a.maxZ=n.orthographic.zfar;break}default:throw new Error("".concat(e,": Invalid camera type (").concat(n.type,")"))}return t.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),r(a),this.logClose(),Promise.all(s).then(function(){return a})},t.prototype._loadAnimationsAsync=function(){var e=this._gltf.animations;if(!e)return Promise.resolve();for(var n=new Array,r=0;r<e.length;r++){var o=e[r];n.push(this.loadAnimationAsync("/animations/".concat(o.index),o).then(function(s){s.targetedAnimations.length===0&&s.dispose()}))}return Promise.all(n).then(function(){})},t.prototype.loadAnimationAsync=function(e,n){var r=this._extensionsLoadAnimationAsync(e,n);if(r)return r;this._babylonScene._blockEntityCollection=!!this._assetContainer;var o=new tr(n.name||"animation".concat(n.index),this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._babylonAnimationGroup=o;var s=new Array;m.Assign(n.channels),m.Assign(n.samplers);for(var a=0,i=n.channels;a<i.length;a++){var c=i[a];s.push(this._loadAnimationChannelAsync("".concat(e,"/channels/").concat(c.index),e,n,c,o))}return Promise.all(s).then(function(){return o.normalize(0),o})},t.prototype._loadAnimationChannelAsync=function(e,n,r,o,s,a){var i=this;if(a===void 0&&(a=null),o.target.node==null)return Promise.resolve();var c=m.Get("".concat(e,"/target/node"),this._gltf.nodes,o.target.node);if(o.target.path==="weights"&&!c._numMorphTargets||o.target.path!=="weights"&&!c._babylonTransformNode)return Promise.resolve();var u=m.Get("".concat(e,"/sampler"),r.samplers,o.sampler);return this._loadAnimationSamplerAsync("".concat(n,"/samplers/").concat(o.sampler),u).then(function(l){var f,d;switch(o.target.path){case"translation":{f="position",d=Q.ANIMATIONTYPE_VECTOR3;break}case"rotation":{f="rotationQuaternion",d=Q.ANIMATIONTYPE_QUATERNION;break}case"scale":{f="scaling",d=Q.ANIMATIONTYPE_VECTOR3;break}case"weights":{f="influence",d=Q.ANIMATIONTYPE_FLOAT;break}default:throw new Error("".concat(e,"/target/path: Invalid value (").concat(o.target.path,")"))}var h=0,_;switch(f){case"position":{_=function(x){var L=S.FromArray(l.output,h).scaleInPlace(x);return h+=3,L};break}case"rotationQuaternion":{_=function(x){var L=j.FromArray(l.output,h).scaleInPlace(x);return h+=4,L};break}case"scaling":{_=function(x){var L=S.FromArray(l.output,h).scaleInPlace(x);return h+=3,L};break}case"influence":{_=function(x){for(var L=new Array(c._numMorphTargets),F=0;F<c._numMorphTargets;F++)L[F]=l.output[h++]*x;return L};break}}var p;switch(l.interpolation){case"STEP":{p=function(x){return{frame:l.input[x]*i.parent.targetFps,value:_(1),interpolation:cr.STEP}};break}case"LINEAR":{p=function(x){return{frame:l.input[x]*i.parent.targetFps,value:_(1)}};break}case"CUBICSPLINE":{var v=1/i.parent.targetFps;p=function(x){return{frame:l.input[x]*i.parent.targetFps,inTangent:_(v),value:_(1),outTangent:_(v)}};break}}for(var A=new Array(l.input.length),T=0;T<l.input.length;T++)A[T]=p(T);if(f==="influence")for(var y=function(x){var L="".concat(s.name,"_channel").concat(s.targetedAnimations.length),F=new Q(L,f,i.parent.targetFps,d);F.setKeys(A.map(function(E){return{frame:E.frame,inTangent:E.inTangent?E.inTangent[x]:void 0,value:E.value[x],outTangent:E.outTangent?E.outTangent[x]:void 0,interpolation:E.interpolation}})),i._forEachPrimitive(c,function(E){var G=E;if(G.morphTargetManager){var V=G.morphTargetManager.getTarget(x),ne=F.clone();V.animations.push(ne),s.addTargetedAnimation(ne,V)}})},O=0;O<c._numMorphTargets;O++)y(O);else{var C="".concat(s.name,"_channel").concat(s.targetedAnimations.length),b=new Q(C,f,i.parent.targetFps,d);b.setKeys(A),a!=null&&a.animations!=null?(a.animations.push(b),s.addTargetedAnimation(b,a)):(c._babylonTransformNode.animations.push(b),s.addTargetedAnimation(b,c._babylonTransformNode))}})},t.prototype._loadAnimationSamplerAsync=function(e,n){if(n._data)return n._data;var r=n.interpolation||"LINEAR";switch(r){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error("".concat(e,"/interpolation: Invalid value (").concat(n.interpolation,")"))}var o=m.Get("".concat(e,"/input"),this._gltf.accessors,n.input),s=m.Get("".concat(e,"/output"),this._gltf.accessors,n.output);return n._data=Promise.all([this._loadFloatAccessorAsync("/accessors/".concat(o.index),o),this._loadFloatAccessorAsync("/accessors/".concat(s.index),s)]).then(function(a){var i=a[0],c=a[1];return{input:i,interpolation:r,output:c}}),n._data},t.prototype.loadBufferAsync=function(e,n,r,o){var s=this._extensionsLoadBufferAsync(e,n,r,o);if(s)return s;if(!n._data)if(n.uri)n._data=this.loadUriAsync("".concat(e,"/uri"),n,n.uri);else{if(!this._bin)throw new Error("".concat(e,": Uri is missing or the binary glTF is missing its binary chunk"));n._data=this._bin.readAsync(0,n.byteLength)}return n._data.then(function(a){try{return new Uint8Array(a.buffer,a.byteOffset+r,o)}catch(i){throw new Error("".concat(e,": ").concat(i.message))}})},t.prototype.loadBufferViewAsync=function(e,n){var r=this._extensionsLoadBufferViewAsync(e,n);if(r)return r;if(n._data)return n._data;var o=m.Get("".concat(e,"/buffer"),this._gltf.buffers,n.buffer);return n._data=this.loadBufferAsync("/buffers/".concat(o.index),o,n.byteOffset||0,n.byteLength),n._data},t.prototype._loadAccessorAsync=function(e,n,r){var o=this;if(n._data)return n._data;var s=t._GetNumComponents(e,n.type),a=s*w.GetTypeByteLength(n.componentType),i=s*n.count;if(n.bufferView==null)n._data=Promise.resolve(new r(i));else{var c=m.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/".concat(c.index),c).then(function(l){if(n.componentType===5126&&!n.normalized&&(!c.byteStride||c.byteStride===a))return t._GetTypedArray(e,n.componentType,l,n.byteOffset,i);var f=new r(i);return w.ForEach(l,n.byteOffset||0,c.byteStride||a,s,n.componentType,f.length,n.normalized||!1,function(d,h){f[h]=d}),f})}if(n.sparse){var u=n.sparse;n._data=n._data.then(function(l){var f=l,d=m.Get("".concat(e,"/sparse/indices/bufferView"),o._gltf.bufferViews,u.indices.bufferView),h=m.Get("".concat(e,"/sparse/values/bufferView"),o._gltf.bufferViews,u.values.bufferView);return Promise.all([o.loadBufferViewAsync("/bufferViews/".concat(d.index),d),o.loadBufferViewAsync("/bufferViews/".concat(h.index),h)]).then(function(_){var p=_[0],v=_[1],A=t._GetTypedArray("".concat(e,"/sparse/indices"),u.indices.componentType,p,u.indices.byteOffset,u.count),T=s*u.count,y;if(n.componentType===5126&&!n.normalized)y=t._GetTypedArray("".concat(e,"/sparse/values"),n.componentType,v,u.values.byteOffset,T);else{var O=t._GetTypedArray("".concat(e,"/sparse/values"),n.componentType,v,u.values.byteOffset,T);y=new r(T),w.ForEach(O,0,a,s,n.componentType,y.length,n.normalized||!1,function(F,E){y[E]=F})}for(var C=0,b=0;b<A.length;b++)for(var x=A[b]*s,L=0;L<s;L++)f[x++]=y[C++];return f})})}return n._data},t.prototype._loadFloatAccessorAsync=function(e,n){return this._loadAccessorAsync(e,n,Float32Array)},t.prototype._loadIndicesAccessorAsync=function(e,n){if(n.type!=="SCALAR")throw new Error("".concat(e,"/type: Invalid value ").concat(n.type));if(n.componentType!==5121&&n.componentType!==5123&&n.componentType!==5125)throw new Error("".concat(e,"/componentType: Invalid value ").concat(n.componentType));if(n._data)return n._data;if(n.sparse){var r=t._GetTypedArrayConstructor("".concat(e,"/componentType"),n.componentType);n._data=this._loadAccessorAsync(e,n,r)}else{var o=m.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/".concat(o.index),o).then(function(s){return t._GetTypedArray(e,n.componentType,s,n.byteOffset,n.count)})}return n._data},t.prototype._loadVertexBufferViewAsync=function(e){if(e._babylonBuffer)return e._babylonBuffer;var n=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync("/bufferViews/".concat(e.index),e).then(function(r){return new or(n,r,!1)}),e._babylonBuffer},t.prototype._loadVertexAccessorAsync=function(e,n,r){var o;if((o=n._babylonVertexBuffer)===null||o===void 0?void 0:o[r])return n._babylonVertexBuffer[r];n._babylonVertexBuffer||(n._babylonVertexBuffer={});var s=this._babylonScene.getEngine();if(n.sparse)n._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(e,n).then(function(i){return new w(s,i,r,!1)});else if(r===w.MatricesIndicesKind||r===w.MatricesIndicesExtraKind)n._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(e,n).then(function(i){return new w(s,i,r,!1)});else{var a=m.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._babylonVertexBuffer[r]=this._loadVertexBufferViewAsync(a).then(function(i){var c=t._GetNumComponents(e,n.type);return new w(s,i,r,!1,!1,a.byteStride,!1,n.byteOffset,c,n.componentType,n.normalized,!0,1,!0)})}return n._babylonVertexBuffer[r]},t.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return n&&(n.baseColorFactor?(r.albedoColor=M.FromArray(n.baseColorFactor),r.alpha=n.baseColorFactor[3]):r.albedoColor=M.White(),r.metallic=n.metallicFactor==null?1:n.metallicFactor,r.roughness=n.roughnessFactor==null?1:n.roughnessFactor,n.baseColorTexture&&o.push(this.loadTextureInfoAsync("".concat(e,"/baseColorTexture"),n.baseColorTexture,function(s){s.name="".concat(r.name," (Base Color)"),r.albedoTexture=s})),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture.nonColorData=!0,o.push(this.loadTextureInfoAsync("".concat(e,"/metallicRoughnessTexture"),n.metallicRoughnessTexture,function(s){s.name="".concat(r.name," (Metallic Roughness)"),r.metallicTexture=s})),r.useMetallnessFromMetallicTextureBlue=!0,r.useRoughnessFromMetallicTextureGreen=!0,r.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(o).then(function(){})},t.prototype._loadMaterialAsync=function(e,n,r,o,s){s===void 0&&(s=function(){});var a=this._extensionsLoadMaterialAsync(e,n,r,o,s);if(a)return a;n._data=n._data||{};var i=n._data[o];if(!i){this.logOpen("".concat(e," ").concat(n.name||""));var c=this.createMaterial(e,n,o);i={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,n,c)},n._data[o]=i,t.AddPointerMetadata(c,e),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return r&&(i.babylonMeshes.push(r),r.onDisposeObservable.addOnce(function(){var u=i.babylonMeshes.indexOf(r);u!==-1&&i.babylonMeshes.splice(u,1)})),s(i.babylonMaterial),i.promise.then(function(){return i.babylonMaterial})},t.prototype._createDefaultMaterial=function(e,n){this._babylonScene._blockEntityCollection=!!this._assetContainer;var r=new D(e,this._babylonScene);return r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.fillMode=n,r.enableSpecularAntiAliasing=!0,r.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,r.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,r.transparencyMode=D.PBRMATERIAL_OPAQUE,r.metallic=1,r.roughness=1,r},t.prototype.createMaterial=function(e,n,r){var o=this._extensionsCreateMaterial(e,n,r);if(o)return o;var s=n.name||"material".concat(n.index),a=this._createDefaultMaterial(s,r);return a},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this._extensionsLoadMaterialPropertiesAsync(e,n,r);if(o)return o;var s=new Array;return s.push(this.loadMaterialBasePropertiesAsync(e,n,r)),n.pbrMetallicRoughness&&s.push(this._loadMaterialMetallicRoughnessPropertiesAsync("".concat(e,"/pbrMetallicRoughness"),n.pbrMetallicRoughness,r)),this.loadMaterialAlphaProperties(e,n,r),Promise.all(s).then(function(){})},t.prototype.loadMaterialBasePropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return r.emissiveColor=n.emissiveFactor?M.FromArray(n.emissiveFactor):new M(0,0,0),n.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),n.normalTexture&&(n.normalTexture.nonColorData=!0,o.push(this.loadTextureInfoAsync("".concat(e,"/normalTexture"),n.normalTexture,function(s){s.name="".concat(r.name," (Normal)"),r.bumpTexture=s})),r.invertNormalMapX=!this._babylonScene.useRightHandedSystem,r.invertNormalMapY=this._babylonScene.useRightHandedSystem,n.normalTexture.scale!=null&&r.bumpTexture&&(r.bumpTexture.level=n.normalTexture.scale),r.forceIrradianceInFragment=!0),n.occlusionTexture&&(n.occlusionTexture.nonColorData=!0,o.push(this.loadTextureInfoAsync("".concat(e,"/occlusionTexture"),n.occlusionTexture,function(s){s.name="".concat(r.name," (Occlusion)"),r.ambientTexture=s})),r.useAmbientInGrayScale=!0,n.occlusionTexture.strength!=null&&(r.ambientTextureStrength=n.occlusionTexture.strength)),n.emissiveTexture&&o.push(this.loadTextureInfoAsync("".concat(e,"/emissiveTexture"),n.emissiveTexture,function(s){s.name="".concat(r.name," (Emissive)"),r.emissiveTexture=s})),Promise.all(o).then(function(){})},t.prototype.loadMaterialAlphaProperties=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=n.alphaMode||"OPAQUE";switch(o){case"OPAQUE":{r.transparencyMode=D.PBRMATERIAL_OPAQUE;break}case"MASK":{r.transparencyMode=D.PBRMATERIAL_ALPHATEST,r.alphaCutOff=n.alphaCutoff==null?.5:n.alphaCutoff,r.albedoTexture&&(r.albedoTexture.hasAlpha=!0);break}case"BLEND":{r.transparencyMode=D.PBRMATERIAL_ALPHABLEND,r.albedoTexture&&(r.albedoTexture.hasAlpha=!0,r.useAlphaFromAlbedoTexture=!0);break}default:throw new Error("".concat(e,"/alphaMode: Invalid value (").concat(n.alphaMode,")"))}},t.prototype.loadTextureInfoAsync=function(e,n,r){var o=this;r===void 0&&(r=function(){});var s=this._extensionsLoadTextureInfoAsync(e,n,r);if(s)return s;if(this.logOpen("".concat(e)),n.texCoord>=6)throw new Error("".concat(e,"/texCoord: Invalid value (").concat(n.texCoord,")"));var a=m.Get("".concat(e,"/index"),this._gltf.textures,n.index);a._textureInfo=n;var i=this._loadTextureAsync("/textures/".concat(n.index),a,function(c){c.coordinatesIndex=n.texCoord||0,t.AddPointerMetadata(c,e),o._parent.onTextureLoadedObservable.notifyObservers(c),r(c)});return this.logClose(),i},t.prototype._loadTextureAsync=function(e,n,r){r===void 0&&(r=function(){});var o=this._extensionsLoadTextureAsync(e,n,r);if(o)return o;this.logOpen("".concat(e," ").concat(n.name||""));var s=n.sampler==null?t.DefaultSampler:m.Get("".concat(e,"/sampler"),this._gltf.samplers,n.sampler),a=m.Get("".concat(e,"/source"),this._gltf.images,n.source),i=this._createTextureAsync(e,s,a,r,void 0,!n._textureInfo.nonColorData);return this.logClose(),i},t.prototype._createTextureAsync=function(e,n,r,o,s,a){var i=this;o===void 0&&(o=function(){});var c=this._loadSampler("/samplers/".concat(n.index),n),u=new Array,l=new _e;this._babylonScene._blockEntityCollection=!!this._assetContainer;var f={noMipmap:c.noMipMaps,invertY:!1,samplingMode:c.samplingMode,onLoad:function(){i._disposed||l.resolve()},onError:function(h,_){i._disposed||l.reject(new Error("".concat(e,": ").concat(_&&_.message?_.message:h||"Failed to load texture")))},mimeType:r.mimeType,loaderOptions:s,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},d=new P(null,this._babylonScene,f);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u.push(l.promise),u.push(this.loadImageAsync("/images/".concat(r.index),r).then(function(h){var _=r.uri||"".concat(i._fileName,"#image").concat(r.index),p="data:".concat(i._uniqueRootUrl).concat(_);d.updateURL(p,h)})),d.wrapU=c.wrapU,d.wrapV=c.wrapV,o(d),Promise.all(u).then(function(){return d})},t.prototype._loadSampler=function(e,n){return n._data||(n._data={noMipMaps:n.minFilter===9728||n.minFilter===9729,samplingMode:t._GetTextureSamplingMode(e,n),wrapU:t._GetTextureWrapMode("".concat(e,"/wrapS"),n.wrapS),wrapV:t._GetTextureWrapMode("".concat(e,"/wrapT"),n.wrapT)}),n._data},t.prototype.loadImageAsync=function(e,n){if(!n._data){if(this.logOpen("".concat(e," ").concat(n.name||"")),n.uri)n._data=this.loadUriAsync("".concat(e,"/uri"),n,n.uri);else{var r=m.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/".concat(r.index),r)}this.logClose()}return n._data},t.prototype.loadUriAsync=function(e,n,r){var o=this,s=this._extensionsLoadUriAsync(e,n,r);if(s)return s;if(!t._ValidateUri(r))throw new Error("".concat(e,": '").concat(r,"' is invalid"));if(sr(r)){var a=new Uint8Array(En(r));return this.log("".concat(e,": Decoded ").concat(r.substr(0,64),"... (").concat(a.length," bytes)")),Promise.resolve(a)}return this.log("".concat(e,": Loading ").concat(r)),this._parent.preprocessUrlAsync(this._rootUrl+r).then(function(i){return new Promise(function(c,u){o._parent._loadFile(o._babylonScene,i,function(l){o._disposed||(o.log("".concat(e,": Loaded ").concat(r," (").concat(l.byteLength," bytes)")),c(new Uint8Array(l)))},!0,function(l){u(new ar("".concat(e,": Failed to load '").concat(r,"'").concat(l?": "+l.status+" "+l.statusText:""),l))})})})},t.AddPointerMetadata=function(e,n){var r=e.metadata=e.metadata||{},o=r.gltf=r.gltf||{},s=o.pointers=o.pointers||[];s.push(n)},t._GetTextureWrapMode=function(e,n){switch(n=n==null?10497:n,n){case 33071:return P.CLAMP_ADDRESSMODE;case 33648:return P.MIRROR_ADDRESSMODE;case 10497:return P.WRAP_ADDRESSMODE;default:return K.Warn("".concat(e,": Invalid value (").concat(n,")")),P.WRAP_ADDRESSMODE}},t._GetTextureSamplingMode=function(e,n){var r=n.magFilter==null?9729:n.magFilter,o=n.minFilter==null?9987:n.minFilter;if(r===9729)switch(o){case 9728:return P.LINEAR_NEAREST;case 9729:return P.LINEAR_LINEAR;case 9984:return P.LINEAR_NEAREST_MIPNEAREST;case 9985:return P.LINEAR_LINEAR_MIPNEAREST;case 9986:return P.LINEAR_NEAREST_MIPLINEAR;case 9987:return P.LINEAR_LINEAR_MIPLINEAR;default:return K.Warn("".concat(e,"/minFilter: Invalid value (").concat(o,")")),P.LINEAR_LINEAR_MIPLINEAR}else switch(r!==9728&&K.Warn("".concat(e,"/magFilter: Invalid value (").concat(r,")")),o){case 9728:return P.NEAREST_NEAREST;case 9729:return P.NEAREST_LINEAR;case 9984:return P.NEAREST_NEAREST_MIPNEAREST;case 9985:return P.NEAREST_LINEAR_MIPNEAREST;case 9986:return P.NEAREST_NEAREST_MIPLINEAR;case 9987:return P.NEAREST_LINEAR_MIPLINEAR;default:return K.Warn("".concat(e,"/minFilter: Invalid value (").concat(o,")")),P.NEAREST_NEAREST_MIPNEAREST}},t._GetTypedArrayConstructor=function(e,n){switch(n){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error("".concat(e,": Invalid component type ").concat(n))}},t._GetTypedArray=function(e,n,r,o,s){var a=r.buffer;o=r.byteOffset+(o||0);var i=t._GetTypedArrayConstructor("".concat(e,"/componentType"),n),c=w.GetTypeByteLength(n);return o%c!=0?(K.Warn("".concat(e,": Copying buffer as byte offset (").concat(o,") is not a multiple of component type byte length (").concat(c,")")),new i(a.slice(o,o+s*c),0)):new i(a,o,s)},t._GetNumComponents=function(e,n){switch(n){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error("".concat(e,": Invalid type (").concat(n,")"))},t._ValidateUri=function(e){return N.IsBase64(e)||e.indexOf("..")===-1},t._GetDrawMode=function(e,n){switch(n==null&&(n=4),n){case 0:return Y.PointListDrawMode;case 1:return Y.LineListDrawMode;case 2:return Y.LineLoopDrawMode;case 3:return Y.LineStripDrawMode;case 4:return Y.TriangleFillMode;case 5:return Y.TriangleStripDrawMode;case 6:return Y.TriangleFanDrawMode}throw new Error("".concat(e,": Invalid mesh primitive mode (").concat(n,")"))},t.prototype._compileMaterialsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile materials");var n=new Array;if(this._gltf.materials)for(var r=0,o=this._gltf.materials;r<o.length;r++){var s=o[r];if(s._data)for(var a in s._data)for(var i=s._data[a],c=0,u=i.babylonMeshes;c<u.length;c++){var l=u[c];l.computeWorldMatrix(!0);var f=i.babylonMaterial;n.push(f.forceCompilationAsync(l)),n.push(f.forceCompilationAsync(l,{useInstances:!0})),this._parent.useClipPlane&&(n.push(f.forceCompilationAsync(l,{clipPlane:!0})),n.push(f.forceCompilationAsync(l,{clipPlane:!0,useInstances:!0})))}}return Promise.all(n).then(function(){e._parent._endPerformanceCounter("Compile materials")})},t.prototype._compileShadowGeneratorsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var n=new Array,r=this._babylonScene.lights,o=0,s=r;o<s.length;o++){var a=s[o],i=a.getShadowGenerator();i&&n.push(i.forceCompilationAsync())}return Promise.all(n).then(function(){e._parent._endPerformanceCounter("Compile shadow generators")})},t.prototype._forEachExtensions=function(e){for(var n=0,r=this._extensions;n<r.length;n++){var o=r[n];o.enabled&&e(o)}},t.prototype._applyExtensions=function(e,n,r){for(var o=0,s=this._extensions;o<s.length;o++){var a=s[o];if(a.enabled){var i="".concat(a.name,".").concat(n),c=e;c._activeLoaderExtensionFunctions=c._activeLoaderExtensionFunctions||{};var u=c._activeLoaderExtensionFunctions;if(!u[i]){u[i]=!0;try{var l=r(a);if(l)return l}finally{delete u[i]}}}}return null},t.prototype._extensionsOnLoading=function(){this._forEachExtensions(function(e){return e.onLoading&&e.onLoading()})},t.prototype._extensionsOnReady=function(){this._forEachExtensions(function(e){return e.onReady&&e.onReady()})},t.prototype._extensionsLoadSceneAsync=function(e,n){return this._applyExtensions(n,"loadScene",function(r){return r.loadSceneAsync&&r.loadSceneAsync(e,n)})},t.prototype._extensionsLoadNodeAsync=function(e,n,r){return this._applyExtensions(n,"loadNode",function(o){return o.loadNodeAsync&&o.loadNodeAsync(e,n,r)})},t.prototype._extensionsLoadCameraAsync=function(e,n,r){return this._applyExtensions(n,"loadCamera",function(o){return o.loadCameraAsync&&o.loadCameraAsync(e,n,r)})},t.prototype._extensionsLoadVertexDataAsync=function(e,n,r){return this._applyExtensions(n,"loadVertexData",function(o){return o._loadVertexDataAsync&&o._loadVertexDataAsync(e,n,r)})},t.prototype._extensionsLoadMeshPrimitiveAsync=function(e,n,r,o,s,a){return this._applyExtensions(s,"loadMeshPrimitive",function(i){return i._loadMeshPrimitiveAsync&&i._loadMeshPrimitiveAsync(e,n,r,o,s,a)})},t.prototype._extensionsLoadMaterialAsync=function(e,n,r,o,s){return this._applyExtensions(n,"loadMaterial",function(a){return a._loadMaterialAsync&&a._loadMaterialAsync(e,n,r,o,s)})},t.prototype._extensionsCreateMaterial=function(e,n,r){return this._applyExtensions(n,"createMaterial",function(o){return o.createMaterial&&o.createMaterial(e,n,r)})},t.prototype._extensionsLoadMaterialPropertiesAsync=function(e,n,r){return this._applyExtensions(n,"loadMaterialProperties",function(o){return o.loadMaterialPropertiesAsync&&o.loadMaterialPropertiesAsync(e,n,r)})},t.prototype._extensionsLoadTextureInfoAsync=function(e,n,r){return this._applyExtensions(n,"loadTextureInfo",function(o){return o.loadTextureInfoAsync&&o.loadTextureInfoAsync(e,n,r)})},t.prototype._extensionsLoadTextureAsync=function(e,n,r){return this._applyExtensions(n,"loadTexture",function(o){return o._loadTextureAsync&&o._loadTextureAsync(e,n,r)})},t.prototype._extensionsLoadAnimationAsync=function(e,n){return this._applyExtensions(n,"loadAnimation",function(r){return r.loadAnimationAsync&&r.loadAnimationAsync(e,n)})},t.prototype._extensionsLoadSkinAsync=function(e,n,r){return this._applyExtensions(r,"loadSkin",function(o){return o._loadSkinAsync&&o._loadSkinAsync(e,n,r)})},t.prototype._extensionsLoadUriAsync=function(e,n,r){return this._applyExtensions(n,"loadUri",function(o){return o._loadUriAsync&&o._loadUriAsync(e,n,r)})},t.prototype._extensionsLoadBufferViewAsync=function(e,n){return this._applyExtensions(n,"loadBufferView",function(r){return r.loadBufferViewAsync&&r.loadBufferViewAsync(e,n)})},t.prototype._extensionsLoadBufferAsync=function(e,n,r,o){return this._applyExtensions(n,"loadBuffer",function(s){return s.loadBufferAsync&&s.loadBufferAsync(e,n,r,o)})},t.LoadExtensionAsync=function(e,n,r,o){if(!n.extensions)return null;var s=n.extensions,a=s[r];return a?o("".concat(e,"/extensions/").concat(r),a):null},t.LoadExtraAsync=function(e,n,r,o){if(!n.extras)return null;var s=n.extras,a=s[r];return a?o("".concat(e,"/extras/").concat(r),a):null},t.prototype.isExtensionUsed=function(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1},t.prototype.logOpen=function(e){this._parent._logOpen(e)},t.prototype.logClose=function(){this._parent._logClose()},t.prototype.log=function(e){this._parent._log(e)},t.prototype.startPerformanceCounter=function(e){this._parent._startPerformanceCounter(e)},t.prototype.endPerformanceCounter=function(e){this._parent._endPerformanceCounter(e)},t._RegisteredExtensions={},t.DefaultSampler={index:-1},t}();oe._CreateGLTF2Loader=function(t){return new g(t)};var Ue="EXT_lights_image_based",Wr=function(){function t(e){this.name=Ue,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ue)}return t.prototype.dispose=function(){this._loader=null,delete this._lights},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._lights=n.lights}},t.prototype.loadSceneAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,s){var a=new Array;a.push(r._loader.loadSceneAsync(e,n)),r._loader.logOpen("".concat(o));var i=m.Get("".concat(o,"/light"),r._lights,s.light);return a.push(r._loadLightAsync("/extensions/".concat(r.name,"/lights/").concat(s.light),i).then(function(c){r._loader.babylonScene.environmentTexture=c})),r._loader.logClose(),Promise.all(a).then(function(){})})},t.prototype._loadLightAsync=function(e,n){var r=this;if(!n._loaded){var o=new Array;this._loader.logOpen("".concat(e));for(var s=new Array(n.specularImages.length),a=function(u){var l=n.specularImages[u];s[u]=new Array(l.length);for(var f=function(h){var _="".concat(e,"/specularImages/").concat(u,"/").concat(h);i._loader.logOpen("".concat(_));var p=l[h],v=m.Get(_,i._loader.gltf.images,p);o.push(i._loader.loadImageAsync("/images/".concat(p),v).then(function(A){s[u][h]=A})),i._loader.logClose()},d=0;d<l.length;d++)f(d)},i=this,c=0;c<n.specularImages.length;c++)a(c);this._loader.logClose(),n._loaded=Promise.all(o).then(function(){var u=new lr(r._loader.babylonScene,null,n.specularImageSize);if(u.name=n.name||"environment",n._babylonTexture=u,n.intensity!=null&&(u.level=n.intensity),n.rotation){var l=j.FromArray(n.rotation);r._loader.babylonScene.useRightHandedSystem||(l=j.Inverse(l)),W.FromQuaternionToRef(l,u.getReflectionTextureMatrix())}if(!n.irradianceCoefficients)throw new Error("".concat(e,": Irradiance coefficients are missing"));var f=ur.FromArray(n.irradianceCoefficients);f.scaleInPlace(n.intensity),f.convertIrradianceToLambertianRadiance();var d=fr.FromHarmonics(f),h=(s.length-1)/dr.Log2(n.specularImageSize);return u.updateRGBDAsync(s,d,h)})}return n._loaded.then(function(){return n._babylonTexture})},t}();g.RegisterExtension(Ue,function(t){return new Wr(t)});var Ve="EXT_mesh_gpu_instancing",jr=function(){function t(e){this.name=Ve,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ve)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){o._loader._disableInstancedMesh++;var i=o._loader.loadNodeAsync("/nodes/".concat(n.index),n,r);if(o._loader._disableInstancedMesh--,!n._primitiveBabylonMeshes)return i;var c=new Array,u=0,l=function(f){if(a.attributes[f]==null){c.push(Promise.resolve(null));return}var d=m.Get("".concat(s,"/attributes/").concat(f),o._loader.gltf.accessors,a.attributes[f]);if(c.push(o._loader._loadFloatAccessorAsync("/accessors/".concat(d.bufferView),d)),u===0)u=d.count;else if(u!==d.count)throw new Error("".concat(s,"/attributes: Instance buffer accessors do not have the same count."))};return l("TRANSLATION"),l("ROTATION"),l("SCALE"),i.then(function(f){return Promise.all(c).then(function(d){var h=d[0],_=d[1],p=d[2],v=new Float32Array(u*16);Z.Vector3[0].copyFromFloats(0,0,0),Z.Quaternion[0].copyFromFloats(0,0,0,1),Z.Vector3[1].copyFromFloats(1,1,1);for(var A=0;A<u;++A)h&&S.FromArrayToRef(h,A*3,Z.Vector3[0]),_&&j.FromArrayToRef(_,A*4,Z.Quaternion[0]),p&&S.FromArrayToRef(p,A*3,Z.Vector3[1]),W.ComposeToRef(Z.Vector3[1],Z.Quaternion[0],Z.Vector3[0],Z.Matrix[0]),Z.Matrix[0].copyToArray(v,A*16);for(var T=0,y=n._primitiveBabylonMeshes;T<y.length;T++){var O=y[T];O.thinInstanceSetBuffer("matrix",v,16,!0)}return f})})})},t}();g.RegisterExtension(Ve,function(t){return new jr(t)});var He="EXT_meshopt_compression",qr=function(){function t(e){this.name=He,this.enabled=e.isExtensionUsed(He),this._loader=e}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadBufferViewAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,s){var a=n;if(a._meshOptData)return a._meshOptData;var i=m.Get("".concat(e,"/buffer"),r._loader.gltf.buffers,s.buffer);return a._meshOptData=r._loader.loadBufferAsync("/buffers/".concat(i.index),i,s.byteOffset||0,s.byteLength).then(function(c){return hr.Default.decodeGltfBufferAsync(c,s.count,s.byteStride,s.mode,s.filter)}),a._meshOptData})},t}();g.RegisterExtension(He,function(t){return new qr(t)});var Ke="EXT_texture_webp",Xr=function(){function t(e){this.name=Ke,this._loader=e,this.enabled=e.isExtensionUsed(Ke)}return t.prototype.dispose=function(){this._loader=null},t.prototype._loadTextureAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=n.sampler==null?g.DefaultSampler:m.Get("".concat(e,"/sampler"),o._loader.gltf.samplers,n.sampler),c=m.Get("".concat(s,"/source"),o._loader.gltf.images,a.source);return o._loader._createTextureAsync(e,i,c,function(u){r(u)},void 0,!n._textureInfo.nonColorData)})},t}();g.RegisterExtension(Ke,function(t){return new Xr(t)});var We="KHR_draco_mesh_compression",Jr=function(){function t(e){this.name=We,this._loader=e,this.enabled=bn.DecoderAvailable&&this._loader.isExtensionUsed(We)}return t.prototype.dispose=function(){delete this.dracoCompression,this._loader=null},t.prototype._loadVertexDataAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){if(n.mode!=null){if(n.mode!==5&&n.mode!==4)throw new Error("".concat(e,": Unsupported mode ").concat(n.mode));if(n.mode===5)throw new Error("".concat(e,": Mode ").concat(n.mode," is not currently supported"))}var i={},c={},u=function(f,d){var h=a.attributes[f];if(!(h===void 0||n.attributes[f]===void 0)){i[d]=h;var _=m.Get("".concat(e,"/attributes/").concat(f),o._loader.gltf.accessors,n.attributes[f]);if(_.normalized&&_.componentType!==5126){var p=1;switch(_.componentType){case 5120:p=127;break;case 5121:p=255;break;case 5122:p=32767;break;case 5123:p=65535;break}c[d]=p}r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(d)===-1&&r._delayInfo.push(d)}};u("POSITION",w.PositionKind),u("NORMAL",w.NormalKind),u("TANGENT",w.TangentKind),u("TEXCOORD_0",w.UVKind),u("TEXCOORD_1",w.UV2Kind),u("TEXCOORD_2",w.UV3Kind),u("TEXCOORD_3",w.UV4Kind),u("TEXCOORD_4",w.UV5Kind),u("TEXCOORD_5",w.UV6Kind),u("JOINTS_0",w.MatricesIndicesKind),u("WEIGHTS_0",w.MatricesWeightsKind),u("COLOR_0",w.ColorKind);var l=m.Get(s,o._loader.gltf.bufferViews,a.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=o._loader.loadBufferViewAsync("/bufferViews/".concat(l.index),l).then(function(f){var d=o.dracoCompression||bn.Default;return d.decodeMeshAsync(f,i,c).then(function(h){var _=new Pe(r.name,o._loader.babylonScene);return h.applyToGeometry(_),_}).catch(function(h){throw new Error("".concat(e,": ").concat(h.message))})})),l._dracoBabylonGeometry})},t}();g.RegisterExtension(We,function(t){return new Jr(t)});var je="KHR_lights_punctual",zr=function(){function t(e){this.name=je,this._loader=e,this.enabled=this._loader.isExtensionUsed(je)}return t.prototype.dispose=function(){this._loader=null,delete this._lights},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._lights=n.lights}},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){return o._loader.loadNodeAsync(e,n,function(i){var c,u=m.Get(s,o._lights,a.light),l=u.name||i.name;switch(o._loader.babylonScene._blockEntityCollection=!!o._loader._assetContainer,u.type){case"directional":{c=new ye(l,S.Backward(),o._loader.babylonScene);break}case"point":{c=new Ne(l,S.Zero(),o._loader.babylonScene);break}case"spot":{var f=new xe(l,S.Zero(),S.Backward(),0,1,o._loader.babylonScene);f.angle=(u.spot&&u.spot.outerConeAngle||Math.PI/4)*2,f.innerAngle=(u.spot&&u.spot.innerConeAngle||0)*2,c=f;break}default:throw o._loader.babylonScene._blockEntityCollection=!1,new Error("".concat(s,": Invalid light type (").concat(u.type,")"))}c._parentContainer=o._loader._assetContainer,o._loader.babylonScene._blockEntityCollection=!1,c.falloffType=_r.FALLOFF_GLTF,c.diffuse=u.color?M.FromArray(u.color):M.White(),c.intensity=u.intensity==null?1:u.intensity,c.range=u.range==null?Number.MAX_VALUE:u.range,c.parent=i,o._loader._babylonLights.push(c),g.AddPointerMetadata(c,s),r(i)})})},t}();g.RegisterExtension(je,function(t){return new zr(t)});var qe="KHR_materials_pbrSpecularGlossiness",Yr=function(){function t(e){this.name=qe,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(qe)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loadSpecularGlossinessPropertiesAsync(s,n,a,r)),o._loader.loadMaterialAlphaProperties(e,n,r),Promise.all(i).then(function(){})})},t.prototype._loadSpecularGlossinessPropertiesAsync=function(e,n,r,o){if(!(o instanceof D))throw new Error("".concat(e,": Material type not supported"));var s=new Array;return o.metallic=null,o.roughness=null,r.diffuseFactor?(o.albedoColor=M.FromArray(r.diffuseFactor),o.alpha=r.diffuseFactor[3]):o.albedoColor=M.White(),o.reflectivityColor=r.specularFactor?M.FromArray(r.specularFactor):M.White(),o.microSurface=r.glossinessFactor==null?1:r.glossinessFactor,r.diffuseTexture&&s.push(this._loader.loadTextureInfoAsync("".concat(e,"/diffuseTexture"),r.diffuseTexture,function(a){a.name="".concat(o.name," (Diffuse)"),o.albedoTexture=a})),r.specularGlossinessTexture&&(s.push(this._loader.loadTextureInfoAsync("".concat(e,"/specularGlossinessTexture"),r.specularGlossinessTexture,function(a){a.name="".concat(o.name," (Specular Glossiness)"),o.reflectivityTexture=a,o.reflectivityTexture.hasAlpha=!0})),o.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(s).then(function(){})},t}();g.RegisterExtension(qe,function(t){return new Yr(t)});var Xe="KHR_materials_unlit",Zr=function(){function t(e){this.name=Xe,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xe)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(){return o._loadUnlitPropertiesAsync(e,n,r)})},t.prototype._loadUnlitPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;r.unlit=!0;var s=n.pbrMetallicRoughness;return s&&(s.baseColorFactor?(r.albedoColor=M.FromArray(s.baseColorFactor),r.alpha=s.baseColorFactor[3]):r.albedoColor=M.White(),s.baseColorTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/baseColorTexture"),s.baseColorTexture,function(a){a.name="".concat(r.name," (Base Color)"),r.albedoTexture=a}))),n.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,n,r),Promise.all(o).then(function(){})},t}();g.RegisterExtension(Xe,function(t){return new Zr(t)});var Je="KHR_materials_clearcoat",$r=function(){function t(e){this.name=Je,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Je)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadClearCoatPropertiesAsync(s,a,r)),Promise.all(i).then(function(){})})},t.prototype._loadClearCoatPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return r.clearCoat.isEnabled=!0,r.clearCoat.useRoughnessFromMainTexture=!1,r.clearCoat.remapF0OnInterfaceChange=!1,n.clearcoatFactor!=null?r.clearCoat.intensity=n.clearcoatFactor:r.clearCoat.intensity=0,n.clearcoatTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/clearcoatTexture"),n.clearcoatTexture,function(s){s.name="".concat(r.name," (ClearCoat Intensity)"),r.clearCoat.texture=s})),n.clearcoatRoughnessFactor!=null?r.clearCoat.roughness=n.clearcoatRoughnessFactor:r.clearCoat.roughness=0,n.clearcoatRoughnessTexture&&(n.clearcoatRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/clearcoatRoughnessTexture"),n.clearcoatRoughnessTexture,function(s){s.name="".concat(r.name," (ClearCoat Roughness)"),r.clearCoat.textureRoughness=s}))),n.clearcoatNormalTexture&&(n.clearcoatNormalTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/clearcoatNormalTexture"),n.clearcoatNormalTexture,function(s){s.name="".concat(r.name," (ClearCoat Normal)"),r.clearCoat.bumpTexture=s})),r.invertNormalMapX=!r.getScene().useRightHandedSystem,r.invertNormalMapY=r.getScene().useRightHandedSystem,n.clearcoatNormalTexture.scale!=null&&(r.clearCoat.bumpTexture.level=n.clearcoatNormalTexture.scale)),Promise.all(o).then(function(){})},t}();g.RegisterExtension(Je,function(t){return new $r(t)});var ze="KHR_materials_iridescence",Qr=function(){function t(e){this.name=ze,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ze)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadIridescencePropertiesAsync(s,a,r)),Promise.all(i).then(function(){})})},t.prototype._loadIridescencePropertiesAsync=function(e,n,r){var o,s,a,i,c;if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var u=new Array;return r.iridescence.isEnabled=!0,r.iridescence.intensity=(o=n.iridescenceFactor)!==null&&o!==void 0?o:0,r.iridescence.indexOfRefraction=(a=(s=n.iridescenceIor)!==null&&s!==void 0?s:n.iridescenceIOR)!==null&&a!==void 0?a:1.3,r.iridescence.minimumThickness=(i=n.iridescenceThicknessMinimum)!==null&&i!==void 0?i:100,r.iridescence.maximumThickness=(c=n.iridescenceThicknessMaximum)!==null&&c!==void 0?c:400,n.iridescenceTexture&&u.push(this._loader.loadTextureInfoAsync("".concat(e,"/iridescenceTexture"),n.iridescenceTexture,function(l){l.name="".concat(r.name," (Iridescence Intensity)"),r.iridescence.texture=l})),n.iridescenceThicknessTexture&&u.push(this._loader.loadTextureInfoAsync("".concat(e,"/iridescenceThicknessTexture"),n.iridescenceThicknessTexture,function(l){l.name="".concat(r.name," (Iridescence Thickness)"),r.iridescence.thicknessTexture=l})),Promise.all(u).then(function(){})},t}();g.RegisterExtension(ze,function(t){return new Qr(t)});var Ye="KHR_materials_emissive_strength",et=function(){function t(e){this.name=Ye,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ye)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){return o._loader.loadMaterialPropertiesAsync(e,n,r).then(function(){o._loadEmissiveProperties(s,a,r)})})},t.prototype._loadEmissiveProperties=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));n.emissiveStrength!==void 0&&r.emissiveColor.scaleToRef(n.emissiveStrength,r.emissiveColor)},t}();g.RegisterExtension(Ye,function(t){return new et(t)});var Ze="KHR_materials_sheen",nt=function(){function t(e){this.name=Ze,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ze)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadSheenPropertiesAsync(s,a,r)),Promise.all(i).then(function(){})})},t.prototype._loadSheenPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return r.sheen.isEnabled=!0,r.sheen.intensity=1,n.sheenColorFactor!=null?r.sheen.color=M.FromArray(n.sheenColorFactor):r.sheen.color=M.Black(),n.sheenColorTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/sheenColorTexture"),n.sheenColorTexture,function(s){s.name="".concat(r.name," (Sheen Color)"),r.sheen.texture=s})),n.sheenRoughnessFactor!==void 0?r.sheen.roughness=n.sheenRoughnessFactor:r.sheen.roughness=0,n.sheenRoughnessTexture&&(n.sheenRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/sheenRoughnessTexture"),n.sheenRoughnessTexture,function(s){s.name="".concat(r.name," (Sheen Roughness)"),r.sheen.textureRoughness=s}))),r.sheen.albedoScaling=!0,r.sheen.useRoughnessFromMainTexture=!1,Promise.all(o).then(function(){})},t}();g.RegisterExtension(Ze,function(t){return new nt(t)});var $e="KHR_materials_specular",rt=function(){function t(e){this.name=$e,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed($e)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadSpecularPropertiesAsync(s,a,r)),Promise.all(i).then(function(){})})},t.prototype._loadSpecularPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return n.specularFactor!==void 0&&(r.metallicF0Factor=n.specularFactor),n.specularColorFactor!==void 0&&(r.metallicReflectanceColor=M.FromArray(n.specularColorFactor)),n.specularTexture&&(n.specularTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/specularTexture"),n.specularTexture,function(s){s.name="".concat(r.name," (Specular F0 Strength)"),r.metallicReflectanceTexture=s,r.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),n.specularColorTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/specularColorTexture"),n.specularColorTexture,function(s){s.name="".concat(r.name," (Specular F0 Color)"),r.reflectanceTexture=s})),Promise.all(o).then(function(){})},t}();g.RegisterExtension($e,function(t){return new rt(t)});var Qe="KHR_materials_ior",tt=function(){function t(e){this.name=Qe,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qe)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadIorPropertiesAsync(s,a,r)),Promise.all(i).then(function(){})})},t.prototype._loadIorPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));return n.ior!==void 0?r.indexOfRefraction=n.ior:r.indexOfRefraction=t._DEFAULT_IOR,Promise.resolve()},t._DEFAULT_IOR=1.5,t}();g.RegisterExtension(Qe,function(t){return new tt(t)});var X="KHR_materials_variants",ot=function(){function t(e){this.name=X,this._loader=e,this.enabled=this._loader.isExtensionUsed(X)}return t.prototype.dispose=function(){this._loader=null},t.GetAvailableVariants=function(e){var n=this._GetExtensionMetadata(e);return n?Object.keys(n.variants):[]},t.prototype.getAvailableVariants=function(e){return t.GetAvailableVariants(e)},t.SelectVariant=function(e,n){var r=this._GetExtensionMetadata(e);if(!r)throw new Error("Cannot select variant on a glTF mesh that does not have the ".concat(X," extension"));var o=function(c){var u=r.variants[c];if(u)for(var l=0,f=u;l<f.length;l++){var d=f[l];d.mesh.material=d.material}};if(n instanceof Array)for(var s=0,a=n;s<a.length;s++){var i=a[s];o(i)}else o(n);r.lastSelected=n},t.prototype.selectVariant=function(e,n){return t.SelectVariant(e,n)},t.Reset=function(e){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot reset on a glTF mesh that does not have the ".concat(X," extension"));for(var r=0,o=n.original;r<o.length;r++){var s=o[r];s.mesh.material=s.material}n.lastSelected=null},t.prototype.reset=function(e){return t.Reset(e)},t.GetLastSelectedVariant=function(e){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the ".concat(X," extension"));return n.lastSelected},t.prototype.getLastSelectedVariant=function(e){return t.GetLastSelectedVariant(e)},t._GetExtensionMetadata=function(e){var n,r;return((r=(n=e==null?void 0:e.metadata)===null||n===void 0?void 0:n.gltf)===null||r===void 0?void 0:r[X])||null},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._variants=n.variants}},t.prototype._loadMeshPrimitiveAsync=function(e,n,r,o,s,a){var i=this;return g.LoadExtensionAsync(e,s,this.name,function(c,u){var l=new Array;return l.push(i._loader._loadMeshPrimitiveAsync(e,n,r,o,s,function(f){if(a(f),f instanceof ue){var d=g._GetDrawMode(e,s.mode),h=i._loader.rootBabylonMesh,_=h?h.metadata=h.metadata||{}:{},p=_.gltf=_.gltf||{},v=p[X]=p[X]||{lastSelected:null,original:[],variants:{}};v.original.push({mesh:f,material:f.material});for(var A=function(y){var O=u.mappings[y],C=m.Get("".concat(c,"/mappings/").concat(y,"/material"),i._loader.gltf.materials,O.material);l.push(i._loader._loadMaterialAsync("#/materials/".concat(O.material),C,f,d,function(b){for(var x=function(F){var E=O.variants[F],G=m.Get("/extensions/".concat(X,"/variants/").concat(E),i._variants,E);v.variants[G.name]=v.variants[G.name]||[],v.variants[G.name].push({mesh:f,material:b}),f.onClonedObservable.add(function(V){var ne=V,$=null,H=ne;do{if(H=H.parent,!H)return;$=t._GetExtensionMetadata(H)}while($===null);if(h&&$===t._GetExtensionMetadata(h)){H.metadata={};for(var B in h.metadata)H.metadata[B]=h.metadata[B];H.metadata.gltf=[];for(var B in h.metadata.gltf)H.metadata.gltf[B]=h.metadata.gltf[B];H.metadata.gltf[X]={lastSelected:null,original:[],variants:{}};for(var ie=0,I=$.original;ie<I.length;ie++){var dn=I[ie];H.metadata.gltf[X].original.push({mesh:dn.mesh,material:dn.material})}for(var B in $.variants)if(Object.prototype.hasOwnProperty.call($.variants,B)){H.metadata.gltf[X].variants[B]=[];for(var Ee=0,hn=$.variants[B];Ee<hn.length;Ee++){var _n=hn[Ee];H.metadata.gltf[X].variants[B].push({mesh:_n.mesh,material:_n.material})}}$=H.metadata.gltf[X]}for(var Te=0,pn=$.original;Te<pn.length;Te++){var de=pn[Te];de.mesh===f&&(de.mesh=ne)}for(var Oe=0,vn=$.variants[G.name];Oe<vn.length;Oe++){var de=vn[Oe];de.mesh===f&&(de.mesh=ne)}})},L=0;L<O.variants.length;++L)x(L)}))},T=0;T<u.mappings.length;++T)A(T)}})),Promise.all(l).then(function(f){var d=f[0];return d})})},t}();g.RegisterExtension(X,function(t){return new ot(t)});var st=function(){function t(e,n){var r=this;this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=ge(ge({},t._GetDefaultOptions()),e),this._scene=n,this._scene._transmissionHelper=this,this.onErrorObservable=new k,this._scene.onDisposeObservable.addOnce(function(){r.dispose()}),this._parseScene(),this._setupRenderTargets()}return t._GetDefaultOptions=function(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:le.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}},t.prototype.updateOptions=function(e){var n=this,r=Object.keys(e).filter(function(a){return n._options[a]!==e[a]});if(!!r.length){var o=ge(ge({},this._options),e),s=this._options;this._options=o,o.renderSize!==s.renderSize||o.renderTargetTextureType!==s.renderTargetTextureType||o.generateMipmaps!==s.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=o.samples,this._opaqueRenderTarget.lodGenerationScale=o.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=o.lodGenerationOffset)}},t.prototype.getOpaqueTarget=function(){return this._opaqueRenderTarget},t.prototype._shouldRenderAsTransmission=function(e){return e?!!(e instanceof D&&e.subSurface.isRefractionEnabled):!1},t.prototype._addMesh=function(e){var n=this;this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),N.SetImmediate(function(){n._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=n._opaqueRenderTarget,n._transparentMeshesCache.push(e)):n._opaqueMeshesCache.push(e)})},t.prototype._removeMesh=function(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];var n=this._transparentMeshesCache.indexOf(e);n!==-1&&this._transparentMeshesCache.splice(n,1),n=this._opaqueMeshesCache.indexOf(e),n!==-1&&this._opaqueMeshesCache.splice(n,1)},t.prototype._parseScene=function(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))},t.prototype._onMeshMaterialChanged=function(e){var n=this._transparentMeshesCache.indexOf(e),r=this._opaqueMeshesCache.indexOf(e),o=this._shouldRenderAsTransmission(e.material);o?(e.material instanceof D&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),r!==-1?(this._opaqueMeshesCache.splice(r,1),this._transparentMeshesCache.push(e)):n===-1&&this._transparentMeshesCache.push(e)):n!==-1?(this._transparentMeshesCache.splice(n,1),this._opaqueMeshesCache.push(e)):r===-1&&this._opaqueMeshesCache.push(e)},t.prototype._setupRenderTargets=function(){var e=this,n,r;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new pr("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(r=(n=this._options.clearColor)===null||n===void 0?void 0:n.clone())!==null&&r!==void 0?r:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;var o,s;this._opaqueRenderTarget.onBeforeBindObservable.add(function(a){s=e._scene.environmentIntensity,e._scene.environmentIntensity=1,o=e._scene.imageProcessingConfiguration.applyByPostProcess,e._options.clearColor?a.clearColor.copyFrom(e._options.clearColor):e._scene.clearColor.toLinearSpaceToRef(a.clearColor),e._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(function(){e._scene.environmentIntensity=s,e._scene.imageProcessingConfiguration._applyByPostProcess=o}),this._transparentMeshesCache.forEach(function(a){e._shouldRenderAsTransmission(a.material)&&(a.material.refractionTexture=e._opaqueRenderTarget)})},t.prototype.dispose=function(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]},t}(),en="KHR_materials_transmission",at=function(){function t(e){this.name=en,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(en),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadTransparentPropertiesAsync(s,n,r,a)),Promise.all(i).then(function(){})})},t.prototype._loadTransparentPropertiesAsync=function(e,n,r,o){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var s=r;if(s.subSurface.isRefractionEnabled=!0,s.subSurface.volumeIndexOfRefraction=1,s.subSurface.useAlbedoToTintRefraction=!0,o.transmissionFactor!==void 0){s.subSurface.refractionIntensity=o.transmissionFactor;var a=s.getScene();s.subSurface.refractionIntensity&&!a._transmissionHelper&&new st({},s.getScene())}else return s.subSurface.refractionIntensity=0,s.subSurface.isRefractionEnabled=!1,Promise.resolve();return s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=0,o.transmissionTexture?(o.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(e,"/transmissionTexture"),o.transmissionTexture,void 0).then(function(i){s.subSurface.refractionIntensityTexture=i,s.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},t}();g.RegisterExtension(en,function(t){return new at(t)});var nn="KHR_materials_translucency",it=function(){function t(e){this.name=nn,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(nn),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadTranslucentPropertiesAsync(s,n,r,a)),Promise.all(i).then(function(){})})},t.prototype._loadTranslucentPropertiesAsync=function(e,n,r,o){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var s=r;if(s.subSurface.isTranslucencyEnabled=!0,s.subSurface.volumeIndexOfRefraction=1,s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=0,s.subSurface.useAlbedoToTintTranslucency=!0,o.translucencyFactor!==void 0)s.subSurface.translucencyIntensity=o.translucencyFactor;else return s.subSurface.translucencyIntensity=0,s.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return o.translucencyTexture?(o.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(e,"/translucencyTexture"),o.translucencyTexture).then(function(a){s.subSurface.translucencyIntensityTexture=a})):Promise.resolve()},t}();g.RegisterExtension(nn,function(t){return new it(t)});var rn="KHR_materials_volume",ct=function(){function t(e){this.name=rn,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(rn),this.enabled&&this._loader._disableInstancedMesh++}return t.prototype.dispose=function(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadVolumePropertiesAsync(s,n,r,a)),Promise.all(i).then(function(){})})},t.prototype._loadVolumePropertiesAsync=function(e,n,r,o){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));if(!r.subSurface.isRefractionEnabled&&!r.subSurface.isTranslucencyEnabled||!o.thicknessFactor)return Promise.resolve();r.subSurface.volumeIndexOfRefraction=r.indexOfRefraction;var s=o.attenuationDistance!==void 0?o.attenuationDistance:Number.MAX_VALUE;return r.subSurface.tintColorAtDistance=s,o.attenuationColor!==void 0&&o.attenuationColor.length==3&&r.subSurface.tintColor.copyFromFloats(o.attenuationColor[0],o.attenuationColor[1],o.attenuationColor[2]),r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=o.thicknessFactor,r.subSurface.useThicknessAsDepth=!0,o.thicknessTexture?(o.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(e,"/thicknessTexture"),o.thicknessTexture).then(function(a){r.subSurface.thicknessTexture=a,r.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},t}();g.RegisterExtension(rn,function(t){return new ct(t)});var tn="KHR_mesh_quantization",lt=function(){function t(e){this.name=tn,this.enabled=e.isExtensionUsed(tn)}return t.prototype.dispose=function(){},t}();g.RegisterExtension(tn,function(t){return new lt(t)});var on="KHR_texture_basisu",ut=function(){function t(e){this.name=on,this._loader=e,this.enabled=e.isExtensionUsed(on)}return t.prototype.dispose=function(){this._loader=null},t.prototype._loadTextureAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=n.sampler==null?g.DefaultSampler:m.Get("".concat(e,"/sampler"),o._loader.gltf.samplers,n.sampler),c=m.Get("".concat(s,"/source"),o._loader.gltf.images,a.source);return o._loader._createTextureAsync(e,i,c,function(u){r(u)},n._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!n._textureInfo.nonColorData)})},t}();g.RegisterExtension(on,function(t){return new ut(t)});var sn="KHR_texture_transform",ft=function(){function t(e){this.name=sn,this._loader=e,this.enabled=this._loader.isExtensionUsed(sn)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadTextureInfoAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){return o._loader.loadTextureInfoAsync(e,n,function(i){if(!(i instanceof P))throw new Error("".concat(s,": Texture type not supported"));a.offset&&(i.uOffset=a.offset[0],i.vOffset=a.offset[1]),i.uRotationCenter=0,i.vRotationCenter=0,a.rotation&&(i.wAng=-a.rotation),a.scale&&(i.uScale=a.scale[0],i.vScale=a.scale[1]),a.texCoord!=null&&(i.coordinatesIndex=a.texCoord),r(i)})})},t}();g.RegisterExtension(sn,function(t){return new ft(t)});var an="KHR_xmp_json_ld",dt=function(){function t(e){this.name=an,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(an)}return t.prototype.dispose=function(){this._loader=null},t.prototype.onLoading=function(){var e,n,r;if(this._loader.rootBabylonMesh!==null){var o=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,s=(r=(n=this._loader.gltf.asset)===null||n===void 0?void 0:n.extensions)===null||r===void 0?void 0:r.KHR_xmp_json_ld;if(o&&s){var a=+s.packet;o.packets&&a<o.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=o.packets[a])}}},t}();g.RegisterExtension(an,function(t){return new dt(t)});var cn="MSFT_audio_emitter",ht=function(){function t(e){this.name=cn,this._loader=e,this.enabled=this._loader.isExtensionUsed(cn)}return t.prototype.dispose=function(){this._loader=null,this._clips=null,this._emitters=null},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._clips=n.clips,this._emitters=n.emitters,m.Assign(this._clips),m.Assign(this._emitters)}},t.prototype.loadSceneAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,s){var a=new Array;a.push(r._loader.loadSceneAsync(e,n));for(var i=0,c=s.emitters;i<c.length;i++){var u=c[i],l=m.Get("".concat(o,"/emitters"),r._emitters,u);if(l.refDistance!=null||l.maxDistance!=null||l.rolloffFactor!=null||l.distanceModel!=null||l.innerAngle!=null||l.outerAngle!=null)throw new Error("".concat(o,": Direction or Distance properties are not allowed on emitters attached to a scene"));a.push(r._loadEmitterAsync("".concat(o,"/emitters/").concat(l.index),l))}return Promise.all(a).then(function(){})})},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i=new Array;return o._loader.loadNodeAsync(s,n,function(c){for(var u=function(h){var _=m.Get("".concat(s,"/emitters"),o._emitters,h);i.push(o._loadEmitterAsync("".concat(s,"/emitters/").concat(_.index),_).then(function(){for(var p=0,v=_._babylonSounds;p<v.length;p++){var A=v[p];A.attachToMesh(c),(_.innerAngle!=null||_.outerAngle!=null)&&(A.setLocalDirectionToMesh(S.Forward()),A.setDirectionalCone(2*N.ToDegrees(_.innerAngle==null?Math.PI:_.innerAngle),2*N.ToDegrees(_.outerAngle==null?Math.PI:_.outerAngle),0))}}))},l=0,f=a.emitters;l<f.length;l++){var d=f[l];u(d)}r(c)}).then(function(c){return Promise.all(i).then(function(){return c})})})},t.prototype.loadAnimationAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,s){return r._loader.loadAnimationAsync(e,n).then(function(a){var i=new Array;m.Assign(s.events);for(var c=0,u=s.events;c<u.length;c++){var l=u[c];i.push(r._loadAnimationEventAsync("".concat(o,"/events/").concat(l.index),e,n,l,a))}return Promise.all(i).then(function(){return a})})})},t.prototype._loadClipAsync=function(e,n){if(n._objectURL)return n._objectURL;var r;if(n.uri)r=this._loader.loadUriAsync(e,n,n.uri);else{var o=m.Get("".concat(e,"/bufferView"),this._loader.gltf.bufferViews,n.bufferView);r=this._loader.loadBufferViewAsync("/bufferViews/".concat(o.index),o)}return n._objectURL=r.then(function(s){return URL.createObjectURL(new Blob([s],{type:n.mimeType}))}),n._objectURL},t.prototype._loadEmitterAsync=function(e,n){var r=this;if(n._babylonSounds=n._babylonSounds||[],!n._babylonData){for(var o=new Array,s=n.name||"emitter".concat(n.index),a={loop:!1,autoplay:!1,volume:n.volume==null?1:n.volume},i=function(f){var d="/extensions/".concat(c.name,"/clips"),h=m.Get(d,c._clips,n.clips[f].clip);o.push(c._loadClipAsync("".concat(d,"/").concat(n.clips[f].clip),h).then(function(_){var p=n._babylonSounds[f]=new mr(s,_,r._loader.babylonScene,null,a);p.refDistance=n.refDistance||1,p.maxDistance=n.maxDistance||256,p.rolloffFactor=n.rolloffFactor||1,p.distanceModel=n.distanceModel||"exponential"}))},c=this,u=0;u<n.clips.length;u++)i(u);var l=Promise.all(o).then(function(){var f=n.clips.map(function(h){return h.weight||1}),d=new vr(n.loop||!1,n._babylonSounds,f);n.innerAngle&&(d.directionalConeInnerAngle=2*N.ToDegrees(n.innerAngle)),n.outerAngle&&(d.directionalConeOuterAngle=2*N.ToDegrees(n.outerAngle)),n.volume&&(d.volume=n.volume),n._babylonData.sound=d});n._babylonData={loaded:l}}return n._babylonData.loaded},t.prototype._getEventAction=function(e,n,r,o,s){switch(r){case"play":return function(a){var i=(s||0)+(a-o);n.play(i)};case"stop":return function(){n.stop()};case"pause":return function(){n.pause()};default:throw new Error("".concat(e,": Unsupported action ").concat(r))}},t.prototype._loadAnimationEventAsync=function(e,n,r,o,s){var a=this;if(s.targetedAnimations.length==0)return Promise.resolve();var i=s.targetedAnimations[0],c=o.emitter,u=m.Get("/extensions/".concat(this.name,"/emitters"),this._emitters,c);return this._loadEmitterAsync(e,u).then(function(){var l=u._babylonData.sound;if(l){var f=new Ar(o.time,a._getEventAction(e,l,o.action,o.time,o.startOffset));i.animation.addEvent(f),s.onAnimationGroupEndObservable.add(function(){l.stop()}),s.onAnimationGroupPauseObservable.add(function(){l.pause()})}})},t}();g.RegisterExtension(cn,function(t){return new ht(t)});var ln="MSFT_lod",_t=function(){function t(e){this.name=ln,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new k,this.onMaterialLODsLoadedObservable=new k,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(ln)}return t.prototype.dispose=function(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()},t.prototype.onReady=function(){for(var e=this,n=function(i){var c=Promise.all(r._nodePromiseLODs[i]).then(function(){i!==0&&(e._loader.endPerformanceCounter("Node LOD ".concat(i)),e._loader.log("Loaded node LOD ".concat(i))),e.onNodeLODsLoadedObservable.notifyObservers(i),i!==e._nodePromiseLODs.length-1&&(e._loader.startPerformanceCounter("Node LOD ".concat(i+1)),e._loadBufferLOD(e._nodeBufferLODs,i+1),e._nodeSignalLODs[i]&&e._nodeSignalLODs[i].resolve())});r._loader._completePromises.push(c)},r=this,o=0;o<this._nodePromiseLODs.length;o++)n(o);for(var s=function(i){var c=Promise.all(a._materialPromiseLODs[i]).then(function(){i!==0&&(e._loader.endPerformanceCounter("Material LOD ".concat(i)),e._loader.log("Loaded material LOD ".concat(i))),e.onMaterialLODsLoadedObservable.notifyObservers(i),i!==e._materialPromiseLODs.length-1&&(e._loader.startPerformanceCounter("Material LOD ".concat(i+1)),e._loadBufferLOD(e._materialBufferLODs,i+1),e._materialSignalLODs[i]&&e._materialSignalLODs[i].resolve())});a._loader._completePromises.push(c)},a=this,o=0;o<this._materialPromiseLODs.length;o++)s(o)},t.prototype.loadSceneAsync=function(e,n){var r=this._loader.loadSceneAsync(e,n);return this._loadBufferLOD(this._bufferLODs,0),r},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(s,a){var i,c=o._getLODs(s,n,o._loader.gltf.nodes,a.ids);o._loader.logOpen("".concat(s));for(var u=function(f){var d=c[f];f!==0&&(o._nodeIndexLOD=f,o._nodeSignalLODs[f]=o._nodeSignalLODs[f]||new _e);var h=function(p){r(p),p.setEnabled(!1)},_=o._loader.loadNodeAsync("/nodes/".concat(d.index),d,h).then(function(p){if(f!==0){var v=c[f-1];v._babylonTransformNode&&(o._disposeTransformNode(v._babylonTransformNode),delete v._babylonTransformNode)}return p.setEnabled(!0),p});o._nodePromiseLODs[f]=o._nodePromiseLODs[f]||[],f===0?i=_:(o._nodeIndexLOD=null,o._nodePromiseLODs[f].push(_))},l=0;l<c.length;l++)u(l);return o._loader.logClose(),i})},t.prototype._loadMaterialAsync=function(e,n,r,o,s){var a=this;return this._nodeIndexLOD?null:g.LoadExtensionAsync(e,n,this.name,function(i,c){var u,l=a._getLODs(i,n,a._loader.gltf.materials,c.ids);a._loader.logOpen("".concat(i));for(var f=function(h){var _=l[h];h!==0&&(a._materialIndexLOD=h);var p=a._loader._loadMaterialAsync("/materials/".concat(_.index),_,r,o,function(v){h===0&&s(v)}).then(function(v){if(h!==0){s(v);var A=l[h-1]._data;A[o]&&(a._disposeMaterials([A[o].babylonMaterial]),delete A[o])}return v});a._materialPromiseLODs[h]=a._materialPromiseLODs[h]||[],h===0?u=p:(a._materialIndexLOD=null,a._materialPromiseLODs[h].push(p))},d=0;d<l.length;d++)f(d);return a._loader.logClose(),u})},t.prototype._loadUriAsync=function(e,n,r){var o=this;if(this._nodeIndexLOD!==null){this._loader.log("deferred");var s=this._nodeIndexLOD-1;return this._nodeSignalLODs[s]=this._nodeSignalLODs[s]||new _e,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(function(){return o._loader.loadUriAsync(e,n,r)})}else if(this._materialIndexLOD!==null){this._loader.log("deferred");var s=this._materialIndexLOD-1;return this._materialSignalLODs[s]=this._materialSignalLODs[s]||new _e,this._materialSignalLODs[s].promise.then(function(){return o._loader.loadUriAsync(e,n,r)})}return null},t.prototype.loadBufferAsync=function(e,n,r,o){if(this._loader.parent.useRangeRequests&&!n.uri){if(!this._loader.bin)throw new Error("".concat(e,": Uri is missing or the binary glTF is missing its binary chunk"));var s=function(a,i){var c=r,u=c+o-1,l=a[i];return l?(l.start=Math.min(l.start,c),l.end=Math.max(l.end,u)):(l={start:c,end:u,loaded:new _e},a[i]=l),l.loaded.promise.then(function(f){return new Uint8Array(f.buffer,f.byteOffset+r-l.start,o)})};return this._loader.log("deferred"),this._nodeIndexLOD!==null?s(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?s(this._materialBufferLODs,this._materialIndexLOD):s(this._bufferLODs,0)}return null},t.prototype._loadBufferLOD=function(e,n){var r=e[n];r&&(this._loader.log("Loading buffer range [".concat(r.start,"-").concat(r.end,"]")),this._loader.bin.readAsync(r.start,r.end-r.start+1).then(function(o){r.loaded.resolve(o)},function(o){r.loaded.reject(o)}))},t.prototype._getLODs=function(e,n,r,o){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");for(var s=new Array,a=o.length-1;a>=0;a--)if(s.push(m.Get("".concat(e,"/ids/").concat(o[a]),r,o[a])),s.length===this.maxLODsToLoad)return s;return s.push(n),s},t.prototype._disposeTransformNode=function(e){var n=this,r=new Array,o=e.material;o&&r.push(o);for(var s=0,a=e.getChildMeshes();s<a.length;s++){var i=a[s];i.material&&r.push(i.material)}e.dispose();var c=r.filter(function(u){return n._loader.babylonScene.meshes.every(function(l){return l.material!=u})});this._disposeMaterials(c)},t.prototype._disposeMaterials=function(e){for(var n={},r=0,o=e;r<o.length;r++){for(var s=o[r],a=0,i=s.getActiveTextures();a<i.length;a++){var c=i[a];n[c.uniqueId]=c}s.dispose()}for(var u in n)for(var l=0,f=this._loader.babylonScene.materials;l<f.length;l++){var s=f[l];s.hasTexture(n[u])&&delete n[u]}for(var u in n)n[u].dispose()},t}();g.RegisterExtension(ln,function(t){return new _t(t)});var un="MSFT_minecraftMesh",pt=function(){function t(e){this.name=un,this._loader=e,this.enabled=this._loader.isExtensionUsed(un)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtraAsync(e,n,this.name,function(s,a){if(a){if(!(r instanceof D))throw new Error("".concat(s,": Material type not supported"));var i=o._loader.loadMaterialPropertiesAsync(e,n,r);return r.needAlphaBlending()&&(r.forceDepthWrite=!0,r.separateCullingPass=!0),r.backFaceCulling=r.forceDepthWrite,r.twoSidedLighting=!0,i}return null})},t}();g.RegisterExtension(un,function(t){return new pt(t)});var fn="MSFT_sRGBFactors",vt=function(){function t(e){this.name=fn,this._loader=e,this.enabled=this._loader.isExtensionUsed(fn)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtraAsync(e,n,this.name,function(s,a){if(a){if(!(r instanceof D))throw new Error("".concat(s,": Material type not supported"));var i=o._loader.loadMaterialPropertiesAsync(e,n,r);return r.albedoTexture||r.albedoColor.toLinearSpaceToRef(r.albedoColor),r.reflectivityTexture||r.reflectivityColor.toLinearSpaceToRef(r.reflectivityColor),i}return null})},t}();g.RegisterExtension(fn,function(t){return new vt(t)});var kn="ExtrasAsMetadata",At=function(){function t(e){this.name=kn,this.enabled=!0,this._loader=e}return t.prototype._assignExtras=function(e,n){if(n.extras&&Object.keys(n.extras).length>0){var r=e.metadata=e.metadata||{},o=r.gltf=r.gltf||{};o.extras=n.extras}},t.prototype.dispose=function(){this._loader=null},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return this._loader.loadNodeAsync(e,n,function(s){o._assignExtras(s,n),r(s)})},t.prototype.loadCameraAsync=function(e,n,r){var o=this;return this._loader.loadCameraAsync(e,n,function(s){o._assignExtras(s,n),r(s)})},t.prototype.createMaterial=function(e,n,r){var o=this._loader.createMaterial(e,n,r);return this._assignExtras(o,n),o},t}();g.RegisterExtension(kn,function(t){return new At(t)});var mt="/assets/apc.6635a715.glb";function yt(t){const e={forward:!1,left:!1,right:!1},n={forward:new k,left:new k,right:new k,all:new k},r={w:"forward",a:"left",d:"right"};return t.actionManager=new Ie(t),t.actionManager.registerAction(new wn(Ie.OnKeyDownTrigger,function(o){const s=o.sourceEvent,a=r[s.key.toLowerCase()];a&&!e[a]&&(e[a]=!0,n[a].notifyObservers(!0),n.all.notifyObservers(e))})),t.actionManager.registerAction(new wn(Ie.OnKeyUpTrigger,function(o){const s=o.sourceEvent,a=r[s.key.toLowerCase()];a&&e[a]&&(e[a]=!1,n[a].notifyObservers(!1),n.all.notifyObservers(e))})),gn(yn({},n),{destroy:()=>{}})}function Tt(t,e){t.enableOfflineSupport=!1,Q.AllowMatricesInterpolation=!0;var n=new yr(t);const r=yt(n);var o=new Le("light1",new S(0,1,0),n);o.intensity=.6,o.specular=M.Black();var s=new ye("dir01",new S(3,-3,1),n);s.position=new S(0,5,5);var a=new gr(1024,s);a.useBlurExponentialShadowMap=!0,a.blurKernel=32;const i=new Er("camera1",new S,n);i.radius=5,i.heightOffset=1.5;const c=new S;r.all.add(l=>{c.set(0,0,0),l.forward&&c.addInPlaceFromFloats(0,0,1),l.left&&c.addInPlaceFromFloats(-1,0,0),l.right&&c.addInPlaceFromFloats(1,0,0)}),n.onPointerObservable.add(l=>{switch(l.type){case Tr.POINTERTAP:console.log(l),l.event.clientX<e.clientWidth*.2?c.set(1,0,0):l.event.clientX<e.clientWidth*.4?c.set(1,0,1):l.event.clientX<e.clientWidth*.6?c.set(0,0,1):l.event.clientX<e.clientWidth*.8?c.set(-1,0,1):c.set(-1,0,0)}});const u=n.createDefaultEnvironment({enableGroundShadow:!0});return u.setMainColor(M.Teal()),u.ground.position.y+=.01,Ce.ImportMesh("",mt,"",n,(l,f,d,h,_,p,v)=>{a.addShadowCaster(l[0],!0);const A=h.find(E=>E.name==="Idle"),T=h.find(E=>E.name==="Walking"),y=h.find(E=>E.name==="Left"),O=h.find(E=>E.name==="Right");[A,T,y,O].forEach(E=>{E.setWeightForAllAnimatables(0),E.start(!0)}),[y,O].forEach(E=>{E.syncAllAnimationsWith(T.animatables[0])});const C={idleAnimation:1,walkingAnimation:0,leftAnimation:0,rightAnimation:0},b={idleAnimation:1,walkingAnimation:0,leftAnimation:0,rightAnimation:0},x=["idleAnimation","walkingAnimation","leftAnimation","rightAnimation"];n.onBeforeAnimationsObservable.add(()=>{C.walkingAnimation=c.z>.1?1:1e-6,C.leftAnimation=c.x<-.1?1:0,C.rightAnimation=c.x>.1?1:0,C.idleAnimation=C.walkingAnimation==1e-6&&C.leftAnimation==0&&C.rightAnimation==0?1:0;for(const E of x)b[E]<C[E]?(b[E]+=.1,b[E]>C[E]&&(b[E]=C[E])):b[E]>C[E]&&(b[E]-=.1,b[E]<C[E]&&(b[E]=C[E]));A.setWeightForAllAnimatables(b.idleAnimation),T.setWeightForAllAnimatables(b.walkingAnimation),y.setWeightForAllAnimatables(b.leftAnimation),O.setWeightForAllAnimatables(b.rightAnimation)});const L=new ue("dummy",n,l[0]);L.position.addInPlaceFromFloats(0,1,0),i.lockedTarget=L;const F={idleAnimation:A,walkingAnimation:T,leftAnimation:y,rightAnimation:O,meshes:l,particleSystems:f,skeletons:d,animationGroups:h,transformNodes:_,geometries:p,lights:v};console.debug("hax",F),Object.assign(window,{hax:F})},function(){}),n}export{Tt as createScene};
