import{Q as S,V as g,d as fe,cj as xe,C as Re,A as O,h as C,y as me,U as be,v as D,x as M,S as E,m as Me,O as Q,n as v,p as b,j as Z,P as F,by as we,K as Ce,F as J,bh as G,H as Pe,N as Oe,J as q,i as ke,a1 as X,ae as le,af as $,L as K,aF as Ie,aC as De,W as Se,g as he,t as de,aP as pe,aA as Le,R as Fe}from"./runBabylonPlaygroundScene-32a4afbd.js";import{i as Ee,R as Be}from"./pbrMaterial-34e2fd30.js";import{B as ge,T as ae}from"./linesBuilder-a2dae4c1.js";import{P as Ve,D as Ue}from"./blurPostProcess-f61d1d3e.js";const Ne=Object.freeze(new S(0,0,0,0)),We=Object.freeze(g.Zero()),Ye=Object.freeze(fe.Zero()),Xe=Object.freeze(xe.Zero()),ze=Object.freeze(Re.Black());class Ze{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===O.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=C.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(const r of this._target)this._preparePath(r,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const n=t.getEvents();n&&n.length>0&&n.forEach(a=>{this._events.push(a._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e[i[0]];for(let n=1;n<i.length-1;n++)s=s[i[n]];this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const s=this._target[i];this._setValue(s,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getRestPose&&this._targetPath==="_matrix"?t=i.getRestPose():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,s,n){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const r=t[this._targetPath];r.clone?this._originalBlendValue=r.clone():this._originalBlendValue=r}this._originalBlendValue.m?O.AllowMatrixDecomposeForInterpolation?this._currentValue?C.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=C.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?C.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=C.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=O._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const a=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;s!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[n]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let n=0;n<i.length;n++)i[n].onlyOnce||(i[n].isDone=i[n].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,-1)}_prepareForSpeedRatioChange(e){const t=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-t}animate(e,t,i,s,n,a=-1){const r=this._animation,l=r.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let h=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const _=i-t;let d,c=e*(r.framePerSecond*n)/1e3+this._ratioOffset,m=0;if(s&&this._animationState.loopMode===O.ANIMATIONLOOPMODE_YOYO){const p=(c-t)/_;c=Math.abs(Math.sin(p*Math.PI))*_+t}if(this._previousDelay=e,this._previousRatio=c,!s&&i>=t&&c>=_)h=!1,m=r._getKeyValue(this._maxValue);else if(!s&&t>=i&&c<=_)h=!1,m=r._getKeyValue(this._minValue);else if(this._animationState.loopMode!==O.ANIMATIONLOOPMODE_CYCLE){const p=i.toString()+t.toString();if(!this._offsetsCache[p]){this._animationState.repeatCount=0,this._animationState.loopMode=O.ANIMATIONLOOPMODE_CYCLE;const y=r._interpolate(t,this._animationState),P=r._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),r.dataType){case O.ANIMATIONTYPE_FLOAT:this._offsetsCache[p]=P-y;break;case O.ANIMATIONTYPE_QUATERNION:this._offsetsCache[p]=P.subtract(y);break;case O.ANIMATIONTYPE_VECTOR3:this._offsetsCache[p]=P.subtract(y);break;case O.ANIMATIONTYPE_VECTOR2:this._offsetsCache[p]=P.subtract(y);break;case O.ANIMATIONTYPE_SIZE:this._offsetsCache[p]=P.subtract(y);break;case O.ANIMATIONTYPE_COLOR3:this._offsetsCache[p]=P.subtract(y);break}this._highLimitsCache[p]=P}m=this._highLimitsCache[p],d=this._offsetsCache[p]}if(d===void 0)switch(r.dataType){case O.ANIMATIONTYPE_FLOAT:d=0;break;case O.ANIMATIONTYPE_QUATERNION:d=Ne;break;case O.ANIMATIONTYPE_VECTOR3:d=We;break;case O.ANIMATIONTYPE_VECTOR2:d=Ye;break;case O.ANIMATIONTYPE_SIZE:d=Xe;break;case O.ANIMATIONTYPE_COLOR3:d=ze}let f;if(this._host&&this._host.syncRoot){const p=this._host.syncRoot,y=(p.masterFrame-p.fromFrame)/(p.toFrame-p.fromFrame);f=t+(i-t)*y}else c>0&&t>i||c<0&&t<i?f=h&&_!==0?i+c%_:t:f=h&&_!==0?t+c%_:i;const u=this._events;if(n>0&&this.currentFrame>f||n<0&&this.currentFrame<f){this._onLoop();for(let p=0;p<u.length;p++)u[p].onlyOnce||(u[p].isDone=!1);this._animationState.key=n>0?0:r.getKeys().length-1}this._currentFrame=f,this._animationState.repeatCount=_===0?0:c/_>>0,this._animationState.highLimitValue=m,this._animationState.offsetValue=d;const A=r._interpolate(f,this._animationState);if(this.setValue(A,a),u.length){for(let p=0;p<u.length;p++)if(_>0&&f>=u[p].frame&&u[p].frame>=t||_<0&&f<=u[p].frame&&u[p].frame<=t){const y=u[p];y.isDone||(y.onlyOnce&&(u.splice(p,1),p--),y.isDone=!0,y.action(f))}}return h||(this._stopped=!0),h}}class w extends be{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,n=null,a=null,r=null){var l;super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=(l=s==null?void 0:s.clone())!==null&&l!==void 0?l:C.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=r,this._absoluteMatrix=new C,this._absoluteBindMatrix=new C,this._absoluteInverseBindMatrix=new C,this._finalMatrix=new C,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){var e;if(this._linkedTransformNode){const t=D.Vector3[0],i=D.Quaternion[0],s=D.Vector3[1];this.getRestMatrix().decompose(t,i,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:S.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=g.Zero(),this._localRotation=S.Zero(),this._localPosition=g.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,C.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=M.LOCAL,i,s=!0){const n=this.getLocalMatrix();if(t==M.LOCAL)s?(n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z)):n.setTranslationFromFloats(e.x,e.y,e.z);else{let a=null;i&&(a=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=w._TmpMats[0],l=w._TmpVecs[0];this.parent?i&&a?(r.copyFrom(this.parent.getAbsoluteMatrix()),r.multiplyToRef(a,r)):r.copyFrom(this.parent.getAbsoluteMatrix()):C.IdentityToRef(r),s&&r.setTranslationFromFloats(0,0,0),r.invert(),g.TransformCoordinatesToRef(e,r,l),s?(n.addAtIndex(12,l.x),n.addAtIndex(13,l.y),n.addAtIndex(14,l.z)):n.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=M.LOCAL,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=M.LOCAL,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,M.WORLD,t)}scale(e,t,i,s=!1){const n=this.getLocalMatrix(),a=w._TmpMats[0];C.ScalingToRef(e,t,i,a),a.multiplyToRef(n,n),a.invert();for(const r of this.children){const l=r.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),r._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const r of this.children)r.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=M.LOCAL,n){if(s===M.LOCAL){const l=w._TmpQuat;S.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,s,n);return}const a=w._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,n))return;const r=w._TmpMats[1];C.RotationYawPitchRollToRef(e,t,i,r),a.multiplyToRef(r,r),this._rotateWithMatrix(r,s,n)}rotate(e,t,i=M.LOCAL,s){const n=w._TmpMats[0];n.setTranslationFromFloats(0,0,0),C.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,s)}setAxisAngle(e,t,i=M.LOCAL,s){if(i===M.LOCAL){const r=w._TmpQuat;S.RotationAxisToRef(e,t,r),this.setRotationQuaternion(r,i,s);return}const n=w._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,s))return;const a=w._TmpMats[1];C.RotationAxisToRef(e,t,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,i,s)}setRotation(e,t=M.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=M.LOCAL,i){if(t===M.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const s=w._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=w._TmpMats[1];C.FromQuaternionToRef(e,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=M.LOCAL,i){if(t===M.LOCAL){const a=w._TmpQuat;S.FromRotationMatrixToRef(e,a),this.setRotationQuaternion(a,t,i);return}const s=w._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=w._TmpMats[1];n.copyFrom(e),s.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=M.LOCAL,i){const s=this.getLocalMatrix(),n=s.m[12],a=s.m[13],r=s.m[14],l=this.getParent(),h=w._TmpMats[3],_=w._TmpMats[4];l&&t==M.WORLD?(i?(h.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteMatrix()),_.copyFrom(h),_.invert(),s.multiplyToRef(h,s),s.multiplyToRef(e,s),s.multiplyToRef(_,s)):t==M.WORLD&&i?(h.copyFrom(i.getWorldMatrix()),_.copyFrom(h),_.invert(),s.multiplyToRef(h,s),s.multiplyToRef(e,s),s.multiplyToRef(_,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(n,a,r),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=w._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),C.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):C.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=M.LOCAL,t=null){const i=g.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=M.LOCAL,t,i){if(e==M.LOCAL){const s=this.getLocalMatrix();i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}else{let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=w._TmpMats[0];t&&s?(n.copyFrom(this.getAbsoluteMatrix()),n.multiplyToRef(s,n)):n=this.getAbsoluteMatrix(),i.x=n.m[12],i.y=n.m[13],i.z=n.m[14]}}getAbsolutePosition(e=null){const t=g.Zero();return this.getPositionToRef(M.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(M.WORLD,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=g.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=w._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),g.TransformNormalToRef(e,n,i),i.normalize()}getRotation(e=M.LOCAL,t=null){const i=g.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=M.LOCAL,t=null,i){const s=w._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=M.LOCAL,t=null){const i=S.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=M.LOCAL,t=null,i){if(e==M.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const s=w._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(n),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.decompose(void 0,i,void 0)}}getRotationMatrix(e=M.LOCAL,t){const i=C.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=M.LOCAL,t,i){if(e==M.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const s=w._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(n),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=g.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=w._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),g.TransformCoordinatesToRef(e,n,i)}getLocalPositionFromAbsolute(e,t=null){const i=g.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=w._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),n.invert(),g.TransformCoordinatesToRef(e,n,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}w._TmpVecs=me.BuildArray(2,g.Zero);w._TmpQuat=S.Identity();w._TmpMats=me.BuildArray(5,C.Identity);class ye{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,s=100,n=!1,a=1,r,l,h,_=!1){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=n,this.onAnimationEnd=r,this.onAnimationLoop=h,this.isAdditive=_,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new Q,this.onAnimationLoopObservable=new Q,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],n=new Ze(e,s,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=(t=this._frameToSyncFromJump)!==null&&t!==void 0?t:i[0].currentFrame;const n=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-n}for(let s=0;s<i.length;s++)i[s].goToFrame(e);this._goToFrame=e}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const n=this._runtimeAnimations;for(let a=n.length-1;a>=0;a--){const r=n[a];e&&r.animation.name!=e||t&&!t(r.target)||(r.dispose(),n.splice(a,1))}n.length==0&&(i||this._scene._activeAnimatables.splice(s,1),this._raiseOnAnimationEnd())}}else{const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){i||this._scene._activeAnimatables.splice(s,1);const n=this._runtimeAnimations;for(let a=0;a<n.length;a++)n[a].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const a=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||a}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}E.prototype._animate=function(){if(!this.animationsEnabled)return;const o=Me.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=o}this.deltaTime=this.useConstantAnimationDeltaTime?16:(o-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=o;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const s=e[i];!s._animate(t)&&s.disposeOnEnd&&i--}this._processLateAnimationBindings()};E.prototype.beginWeightedAnimation=function(o,e,t,i=1,s,n=1,a,r,l,h,_=!1){const d=this.beginAnimation(o,e,t,s,n,a,r,!1,l,h,_);return d.weight=i,d};E.prototype.beginAnimation=function(o,e,t,i,s=1,n,a,r=!0,l,h,_=!1){e>t&&s>0&&(s*=-1),r&&this.stopAnimation(o,void 0,l),a||(a=new ye(this,o,e,t,i,s,n,void 0,h,_));const d=l?l(o):!0;if(o.animations&&d&&a.appendAnimations(o,o.animations),o.getAnimatables){const c=o.getAnimatables();for(let m=0;m<c.length;m++)this.beginAnimation(c[m],e,t,i,s,n,a,r,l,h)}return a.reset(),a};E.prototype.beginHierarchyAnimation=function(o,e,t,i,s,n=1,a,r,l=!0,h,_,d=!1){const c=o.getDescendants(e),m=[];m.push(this.beginAnimation(o,t,i,s,n,a,r,l,h,void 0,d));for(const f of c)m.push(this.beginAnimation(f,t,i,s,n,a,r,l,h,void 0,d));return m};E.prototype.beginDirectAnimation=function(o,e,t,i,s,n,a,r,l=!1){if(n===void 0&&(n=1),t>i&&n>0)n*=-1;else if(i>t&&n<0){const _=i;i=t,t=_}return new ye(this,o,t,i,s,n,a,e,r,l)};E.prototype.beginDirectHierarchyAnimation=function(o,e,t,i,s,n,a,r,l,h=!1){const _=o.getDescendants(e),d=[];d.push(this.beginDirectAnimation(o,t,i,s,n,a,r,l,h));for(const c of _)d.push(this.beginDirectAnimation(c,t,i,s,n,a,r,l,h));return d};E.prototype.getAnimatableByTarget=function(o){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===o)return this._activeAnimatables[e];return null};E.prototype.getAllAnimatablesByTarget=function(o){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===o&&e.push(this._activeAnimatables[t]);return e};E.prototype.stopAnimation=function(o,e,t){const i=this.getAllAnimatablesByTarget(o);for(const s of i)s.stop(e,t)};E.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let o=0;o<this._activeAnimatables.length;o++)this._activeAnimatables[o].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const o of this.animationGroups)o.stop()};E.prototype._registerTargetForLateAnimationBinding=function(o,e){const t=o.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[o.targetPath]||(t._lateAnimationHolders[o.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),o.isAdditive?(t._lateAnimationHolders[o.targetPath].additiveAnimations.push(o),t._lateAnimationHolders[o.targetPath].totalAdditiveWeight+=o.weight):(t._lateAnimationHolders[o.targetPath].animations.push(o),t._lateAnimationHolders[o.targetPath].totalWeight+=o.weight)};E.prototype._processLateAnimationBindingsForMatrices=function(o){if(o.totalWeight===0&&o.totalAdditiveWeight===0)return o.originalValue;let e=1;const t=D.Vector3[0],i=D.Vector3[1],s=D.Quaternion[0];let n=0;const a=o.animations[0],r=o.originalValue;let l=1,h=!1;if(o.totalWeight<1)l=1-o.totalWeight,r.decompose(i,s,t);else{if(n=1,e=o.totalWeight,l=a.weight/e,l==1)if(o.totalAdditiveWeight)h=!0;else return a.currentValue;a.currentValue.decompose(i,s,t)}if(!h){i.scaleInPlace(l),t.scaleInPlace(l),s.scaleInPlace(l);for(let d=n;d<o.animations.length;d++){const c=o.animations[d];if(c.weight===0)continue;l=c.weight/e;const m=D.Vector3[2],f=D.Vector3[3],u=D.Quaternion[1];c.currentValue.decompose(f,u,m),f.scaleAndAddToRef(l,i),u.scaleAndAddToRef(S.Dot(s,u)>0?l:-l,s),m.scaleAndAddToRef(l,t)}s.normalize()}for(let d=0;d<o.additiveAnimations.length;d++){const c=o.additiveAnimations[d];if(c.weight===0)continue;const m=D.Vector3[2],f=D.Vector3[3],u=D.Quaternion[1];c.currentValue.decompose(f,u,m),f.multiplyToRef(i,f),g.LerpToRef(i,f,c.weight,i),s.multiplyToRef(u,u),S.SlerpToRef(s,u,c.weight,s),m.scaleAndAddToRef(c.weight,t)}const _=a?a._animationState.workValue:D.Matrix[0].clone();return C.ComposeToRef(i,s,t,_),_};E.prototype._processLateAnimationBindingsForQuaternions=function(o,e){if(o.totalWeight===0&&o.totalAdditiveWeight===0)return e;const t=o.animations[0],i=o.originalValue;let s=e;if(o.totalWeight===0&&o.totalAdditiveWeight>0)s.copyFrom(i);else if(o.animations.length===1){if(S.SlerpToRef(i,t.currentValue,Math.min(1,o.totalWeight),s),o.totalAdditiveWeight===0)return s}else if(o.animations.length>1){let n=1,a,r;if(o.totalWeight<1){const h=1-o.totalWeight;a=[],r=[],a.push(i),r.push(h)}else{if(o.animations.length===2&&(S.SlerpToRef(o.animations[0].currentValue,o.animations[1].currentValue,o.animations[1].weight/o.totalWeight,e),o.totalAdditiveWeight===0))return e;a=[],r=[],n=o.totalWeight}for(let h=0;h<o.animations.length;h++){const _=o.animations[h];a.push(_.currentValue),r.push(_.weight/n)}let l=0;for(let h=0;h<a.length;){if(!h){S.SlerpToRef(a[h],a[h+1],r[h+1]/(r[h]+r[h+1]),e),s=e,l=r[h]+r[h+1],h+=2;continue}l+=r[h],S.SlerpToRef(s,a[h],r[h]/l,s),h++}}for(let n=0;n<o.additiveAnimations.length;n++){const a=o.additiveAnimations[n];a.weight!==0&&(s.multiplyToRef(a.currentValue,D.Quaternion[0]),S.SlerpToRef(s,D.Quaternion[0],a.weight,s))}return s};E.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let o=0;o<this._registeredForLateAnimationBindings.length;o++){const e=this._registeredForLateAnimationBindings.data[o];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],s=i.animations[0],n=i.originalValue;if(n==null)continue;const a=O.AllowMatrixDecomposeForInterpolation&&n.m;let r=e[t];if(a)r=this._processLateAnimationBindingsForMatrices(i);else if(n.w!==void 0)r=this._processLateAnimationBindingsForQuaternions(i,r||S.Identity());else{let h=0,_=1;if(i.totalWeight<1)s&&n.scale?r=n.scale(1-i.totalWeight):s?r=n*(1-i.totalWeight):n.clone?r=n.clone():r=n;else if(s){_=i.totalWeight;const d=s.weight/_;d!==1?s.currentValue.scale?r=s.currentValue.scale(d):r=s.currentValue*d:r=s.currentValue,h=1}for(let d=h;d<i.animations.length;d++){const c=i.animations[d],m=c.weight/_;if(m)c.currentValue.scaleAndAddToRef?c.currentValue.scaleAndAddToRef(m,r):r+=c.currentValue*m;else continue}for(let d=0;d<i.additiveAnimations.length;d++){const c=i.additiveAnimations[d],m=c.weight;if(m)c.currentValue.scaleAndAddToRef?c.currentValue.scaleAndAddToRef(m,r):r+=c.currentValue*m;else continue}}e[t]=r}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};w.prototype.copyAnimationRange=function(o,e,t,i=!1,s=null){this.animations.length===0&&(this.animations.push(new O(this.name,"_matrix",o.animations[0].framePerSecond,O.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const n=o.animations[0].getRange(e);if(!n)return!1;const a=n.from,r=n.to,l=o.animations[0].getKeys(),h=o.length,_=o.getParent(),d=this.getParent(),c=i&&_&&h&&this.length&&h!==this.length,m=c&&d&&_?d.length/_.length:1,f=i&&!d&&s&&(s.x!==1||s.y!==1||s.z!==1),u=this.animations[0].getKeys();let A,p,y;for(let P=0,k=l.length;P<k;P++)A=l[P],A.frame>=a&&A.frame<=r&&(i?(y=A.value.clone(),c?(p=y.getTranslation(),y.setTranslation(p.scaleInPlace(m))):f&&s?(p=y.getTranslation(),y.setTranslation(p.multiplyInPlace(s))):y=A.value):y=A.value,u.push({frame:A.frame+t,value:y}));return this.animations[0].createRange(e,a+t,r+t),!0};class ee{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new Q,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=Z.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==F.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===we.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,F.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}v([b()],ee.prototype,"wheelPrecisionX",void 0);v([b()],ee.prototype,"wheelPrecisionY",void 0);v([b()],ee.prototype,"wheelPrecisionZ",void 0);class V{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=Z.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Ce.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-s,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,s):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(s,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-s):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,s,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-s,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),g.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}v([b()],V.prototype,"keysUp",void 0);v([b()],V.prototype,"keysUpward",void 0);v([b()],V.prototype,"keysDown",void 0);v([b()],V.prototype,"keysDownward",void 0);v([b()],V.prototype,"keysLeft",void 0);v([b()],V.prototype,"keysRight",void 0);v([b()],V.prototype,"rotationSpeed",void 0);v([b()],V.prototype,"keysRotateLeft",void 0);v([b()],V.prototype,"keysRotateRight",void 0);v([b()],V.prototype,"keysRotateUp",void 0);v([b()],V.prototype,"keysRotateDown",void 0);J.FreeCameraKeyboardMoveInput=V;class te{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new Q,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=Z.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const n=s.event,a=n.pointerType==="touch";if(t.isInVRExclusivePointerMode||!this.touchEnabled&&a||s.type!==F.POINTERMOVE&&this.buttons.indexOf(n.button)===-1)return;const r=n.target;if(s.type===F.POINTERDOWN){if(a&&this._activePointerId!==-1||!a&&this._currentActiveButton!==-1)return;this._activePointerId=n.pointerId;try{r==null||r.setPointerCapture(n.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===F.POINTERUP){if(a&&this._activePointerId!==n.pointerId||!a&&this._currentActiveButton!==n.button)return;try{r==null||r.releasePointerCapture(n.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(s.type===F.POINTERMOVE&&(this._activePointerId===n.pointerId||!a)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){let l=n.clientX-this._previousPosition.x;const h=n.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(l*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=l/this.angularSensibility,this.camera.cameraRotation.x+=h/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:h}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}}),this._onMouseMove=s=>{if(!t.isPointerLock||t.isInVRExclusivePointerMode)return;let n=s.movementX;this.camera.getScene().useRightHandedSystem&&(n*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(n*=-1),this.camera.cameraRotation.y+=n/this.angularSensibility;const a=s.movementY;this.camera.cameraRotation.x+=a/this.angularSensibility,this._previousPosition=null,e||s.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,F.POINTERDOWN|F.POINTERUP|F.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}v([b()],te.prototype,"buttons",void 0);v([b()],te.prototype,"angularSensibility",void 0);J.FreeCameraMouseInput=te;var R;(function(o){o[o.MoveRelative=0]="MoveRelative",o[o.RotateRelative=1]="RotateRelative",o[o.MoveScene=2]="MoveScene"})(R||(R={}));class N extends ee{constructor(){super(...arguments),this._moveRelative=g.Zero(),this._rotateRelative=g.Zero(),this._moveScene=g.Zero(),this._wheelXAction=R.MoveRelative,this._wheelXActionCoordinate=G.X,this._wheelYAction=R.MoveRelative,this._wheelYActionCoordinate=G.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==R.MoveRelative||(this._wheelXAction=R.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==R.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==R.MoveRelative||(this._wheelYAction=R.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==R.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==R.MoveRelative||(this._wheelZAction=R.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==R.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==R.RotateRelative||(this._wheelXAction=R.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==R.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==R.RotateRelative||(this._wheelYAction=R.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==R.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==R.RotateRelative||(this._wheelZAction=R.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==R.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==R.MoveScene||(this._wheelXAction=R.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==R.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==R.MoveScene||(this._wheelYAction=R.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==R.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==R.MoveScene||(this._wheelZAction=R.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==R.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=C.Zero();this.camera.getViewMatrix().invertToRef(e);const t=g.Zero();g.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let s=null;switch(t){case R.MoveRelative:s=this._moveRelative;break;case R.RotateRelative:s=this._rotateRelative;break;case R.MoveScene:s=this._moveScene;break}switch(i){case G.X:s.set(e,0,0);break;case G.Y:s.set(0,e,0);break;case G.Z:s.set(0,0,e);break}}}v([b()],N.prototype,"wheelXMoveRelative",null);v([b()],N.prototype,"wheelYMoveRelative",null);v([b()],N.prototype,"wheelZMoveRelative",null);v([b()],N.prototype,"wheelXRotateRelative",null);v([b()],N.prototype,"wheelYRotateRelative",null);v([b()],N.prototype,"wheelZRotateRelative",null);v([b()],N.prototype,"wheelXMoveScene",null);v([b()],N.prototype,"wheelYMoveScene",null);v([b()],N.prototype,"wheelZMoveScene",null);J.FreeCameraMouseWheelInput=N;class ie{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Z.IsSafari()}attachControl(e){e=Z.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event,n=s.pointerType==="mouse"||this._isSafari&&typeof s.pointerType>"u";if(!(!this.allowMouse&&n)){if(i.type===F.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),this._pointerPressed.length!==1)return;t={x:s.clientX,y:s.clientY}}else if(i.type===F.POINTERUP){e||s.preventDefault();const a=this._pointerPressed.indexOf(s.pointerId);if(a===-1||(this._pointerPressed.splice(a,1),a!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===F.POINTERMOVE){if(e||s.preventDefault(),!t||this._pointerPressed.indexOf(s.pointerId)!=0)return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,F.POINTERDOWN|F.POINTERUP|F.POINTERMOVE),this._onLostFocus){const s=this.camera.getEngine().getInputElement();s&&s.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const i=e._computeLocalCameraSpeed(),s=new g(0,0,this.touchMoveSensibility!==0?i*this._offsetY/this.touchMoveSensibility:0);C.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(g.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}v([b()],ie.prototype,"touchAngularSensibility",void 0);v([b()],ie.prototype,"touchMoveSensibility",void 0);J.FreeCameraTouchInput=ie;class Ge extends Pe{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new V),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new te(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new N,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new ie),this}clear(){super.clear(),this._mouseInput=null}}class se extends Oe{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new g(.5,1,.5),this.ellipsoidOffset=new g(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=g.Zero(),this._diffPosition=g.Zero(),this._newPosition=g.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,a,r=null)=>{(h=>{this._newPosition.copyFrom(h),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>ke.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&r&&this.onCollide(r))})(a)},this.inputs=new Ge(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=Z.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new g(0,0,0),this.cameraRotation=new fe(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=g.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=g.Zero(),this._transformedDirection=g.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}v([q()],se.prototype,"ellipsoid",void 0);v([q()],se.prototype,"ellipsoidOffset",void 0);v([b()],se.prototype,"checkCollisions",void 0);v([b()],se.prototype,"applyGravity",void 0);X.prototype._createDepthStencilCubeTexture=function(o,e,t){const i=new le(this,$.DepthStencil);if(i.isCube=!0,this.webGLVersion===1)return K.Error("Depth cube texture is not supported by WebGL 1."),i;const s=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,o,s.generateStencil,s.bilinearFiltering,s.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=s.generateStencil;for(let a=0;a<6;a++)s.generateStencil?n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,n.DEPTH24_STENCIL8,o,o,0,n.DEPTH_STENCIL,n.UNSIGNED_INT_24_8,null):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,n.DEPTH_COMPONENT24,o,o,0,n.DEPTH_COMPONENT,n.UNSIGNED_INT,null);return this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i};X.prototype._partialLoadFile=function(o,e,t,i,s=null){const n=r=>{t[e]=r,t._internalCount++,t._internalCount===6&&i(t)},a=(r,l)=>{s&&r&&s(r.status+" "+r.statusText,l)};this._loadFile(o,n,void 0,void 0,!0,a)};X.prototype._cascadeLoadFiles=function(o,e,t,i=null){const s=[];s._internalCount=0;for(let n=0;n<6;n++)this._partialLoadFile(t[n],n,s,e,i)};X.prototype._cascadeLoadImgs=function(o,e,t,i,s=null,n){const a=[];a._internalCount=0;for(let r=0;r<6;r++)this._partialLoadImg(i[r],r,a,o,e,t,s,n)};X.prototype._partialLoadImg=function(o,e,t,i,s,n,a=null,r){const l=Ie();De(o,d=>{t[e]=d,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&n&&n(s,t)},(d,c)=>{i&&i.removePendingData(l),a&&a(d,c)},i?i.offlineProvider:null,r),i&&i.addPendingData(l)};X.prototype._setCubeMapTextureParams=function(o,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),o.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),o._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};X.prototype.createCubeTextureBase=function(o,e,t,i,s=null,n=null,a,r=null,l=!1,h=0,_=0,d=null,c=null,m=null,f=!1){const u=d||new le(this,$.Cube);u.isCube=!0,u.url=o,u.generateMipMaps=!i,u._lodGenerationScale=h,u._lodGenerationOffset=_,u._useSRGBBuffer=!!f&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),u!==d&&(u.label=o.substring(0,60)),this._doNotHandleContextLost||(u._extension=r,u._files=t);const A=o;this._transformTextureUrl&&!d&&(o=this._transformTextureUrl(o));const p=o.split("?")[0],y=p.lastIndexOf("."),P=r||(y>-1?p.substring(y).toLowerCase():"");let k=null;for(const x of X._TextureLoaders)if(x.canLoad(P)){k=x;break}const B=(x,T)=>{o===A?n&&x&&n(x.status+" "+x.statusText,T):(K.Warn(`Failed to load ${o}, falling back to the ${A}`),this.createCubeTextureBase(A,e,t,!!i,s,n,a,r,l,h,_,u,c,m,f))};if(k){const x=T=>{c&&c(u,T),k.loadCubeData(T,u,l,s,n)};t&&t.length===6?k.supportCascades?this._cascadeLoadFiles(e,T=>x(T.map(I=>new Uint8Array(I))),t,n):n?n("Textures type does not support cascades."):K.Warn("Texture loader does not support cascades."):this._loadFile(o,T=>x(new Uint8Array(T)),void 0,void 0,!0,B)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,u,(x,T)=>{m&&m(x,T)},t,n)}return this._internalTexturesCache.push(u),u};X.prototype.createCubeTexture=function(o,e,t,i,s=null,n=null,a,r=null,l=!1,h=0,_=0,d=null,c,m=!1){const f=this._gl;return this.createCubeTextureBase(o,e,t,!!i,s,n,a,r,l,h,_,d,u=>this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,u,!0),(u,A)=>{const p=this.needPOTTextures?X.GetExponentOfTwo(A[0].width,this._caps.maxCubemapTextureSize):A[0].width,y=p,P=[f.TEXTURE_CUBE_MAP_POSITIVE_X,f.TEXTURE_CUBE_MAP_POSITIVE_Y,f.TEXTURE_CUBE_MAP_POSITIVE_Z,f.TEXTURE_CUBE_MAP_NEGATIVE_X,f.TEXTURE_CUBE_MAP_NEGATIVE_Y,f.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,u,!0),this._unpackFlipY(!1);const k=a?this._getInternalFormat(a,u._useSRGBBuffer):u._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:f.RGBA;let B=a?this._getInternalFormat(a):f.RGBA;u._useSRGBBuffer&&this.webGLVersion===1&&(B=k);for(let x=0;x<P.length;x++)if(A[x].width!==p||A[x].height!==y){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){K.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=p,this._workingCanvas.height=y,this._workingContext.drawImage(A[x],0,0,A[x].width,A[x].height,0,0,p,y),f.texImage2D(P[x],0,k,B,f.UNSIGNED_BYTE,this._workingCanvas)}else f.texImage2D(P[x],0,k,B,f.UNSIGNED_BYTE,A[x]);i||f.generateMipmap(f.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(u,!i),u.width=p,u.height=y,u.isReady=!0,a&&(u.format=a),u.onLoadedObservable.notifyObservers(u),u.onLoadedObservable.clear(),s&&s()},!!m)};const He="rgbdEncodePixelShader",Qe=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;Se.ShadersStore[He]=Qe;const ue="image/png",re=2,H=[134,22,135,150,246,214,150,54];function Ke(o){const e=new DataView(o.buffer,o.byteOffset,o.byteLength);let t=0;for(let a=0;a<H.length;a++)if(e.getUint8(t++)!==H[a])return K.Error("Not a babylon environment map"),null;let i="",s=0;for(;s=e.getUint8(t++);)i+=String.fromCharCode(s);let n=JSON.parse(i);return n=ne(n),n.specular&&(n.specular.specularDataPosition=t,n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function ne(o){if(o.version>re)throw new Error(`Unsupported babylon environment map version "${o.version}". Latest supported version is "${re}".`);return o.version===2||(o=Object.assign(Object.assign({},o),{version:2,imageType:ue})),o}async function je(o,e={}){var t,i;const s=o.getInternalTexture();if(!s)return Promise.reject("The cube texture is invalid.");const n=(t=e.imageType)!==null&&t!==void 0?t:ue,a=s.getEngine();if(o.textureType!==2&&o.textureType!==1&&o.textureType!==0&&o.textureType!==0&&o.textureType!==7&&o.textureType!==-1)return Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let r=1;if(!a.getCaps().textureFloatRender&&(r=2,!a.getCaps().textureHalfFloatRender))return Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");o.sphericalPolynomial;const l=(i=o.getInternalTexture())===null||i===void 0?void 0:i._sphericalPolynomialPromise,h=s.width,_=new E(a),d={};a.flushFramebuffer();const c=he.ILog2(s.width);for(let T=0;T<=c;T++){const I=Math.pow(2,c-T);for(let W=0;W<6;W++){let Y=await o.readPixels(W,T,void 0,!1);if(Y&&Y.byteLength===Y.length){const z=new Float32Array(Y.byteLength*4);for(let U=0;U<Y.byteLength;U++)z[U]=Y[U]/255,z[U]=Math.pow(z[U],2.2);Y=z}else if(Y&&o.gammaSpace){const z=Y;for(let U=0;U<z.length;U++)z[U]=Math.pow(z[U],2.2)}const oe=a.createRawTexture(Y,I,I,5,!1,!0,1,null,r);await Be.EncodeTextureToRGBD(oe,_,r);const Te=await a._readTexturePixels(oe,I,I),ve=await Ue.DumpDataAsync(I,I,Te,n,void 0,!1,!0,e.imageQuality);d[T*6+W]=ve,oe.dispose()}}_.dispose(),l&&await l;const m={version:re,width:h,imageType:n,irradiance:Je(o),specular:{mipmaps:[],lodGenerationScale:o.lodGenerationScale}};let f=0;for(let T=0;T<=c;T++)for(let I=0;I<6;I++){const W=d[T*6+I].byteLength;m.specular.mipmaps.push({length:W,position:f}),f+=W}const u=JSON.stringify(m),A=new ArrayBuffer(u.length+1),p=new Uint8Array(A);for(let T=0,I=u.length;T<I;T++)p[T]=u.charCodeAt(T);p[u.length]=0;const y=H.length+f+A.byteLength,P=new ArrayBuffer(y),k=new Uint8Array(P),B=new DataView(P);let x=0;for(let T=0;T<H.length;T++)B.setUint8(x++,H[T]);k.set(new Uint8Array(A),x),x+=A.byteLength;for(let T=0;T<=c;T++)for(let I=0;I<6;I++){const W=d[T*6+I];k.set(new Uint8Array(W),x),x+=W.byteLength}return P}function Je(o){const e=o.sphericalPolynomial;return e==null?null:{x:[e.x.x,e.x.y,e.x.z],y:[e.y.x,e.y.y,e.y.z],z:[e.z.x,e.z.y,e.z.z],xx:[e.xx.x,e.xx.y,e.xx.z],yy:[e.yy.x,e.yy.y,e.yy.z],zz:[e.zz.x,e.zz.y,e.zz.z],yz:[e.yz.x,e.yz.y,e.yz.z],zx:[e.zx.x,e.zx.y,e.zx.z],xy:[e.xy.x,e.xy.y,e.xy.z]}}function Ae(o,e){e=ne(e);const t=e.specular;let i=he.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const s=new Array(i);for(let n=0;n<i;n++){s[n]=new Array(6);for(let a=0;a<6;a++){const r=t.mipmaps[n*6+a];s[n][a]=new Uint8Array(o.buffer,o.byteOffset+t.specularDataPosition+r.position,r.length)}}return s}function qe(o,e,t){t=ne(t);const i=t.specular;if(!i)return Promise.resolve();o._lodGenerationScale=i.lodGenerationScale;const s=Ae(e,t);return j(o,s,t.imageType)}function _e(o,e,t,i,s,n,a,r,l,h,_){return new Promise((d,c)=>{if(t){const m=e.createTexture(null,!0,!0,null,1,null,f=>{c(f)},o);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=f=>{f._bindTexture("textureSampler",m),f.setFloat2("scale",1,e._features.needsInvertingBitmap&&o instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],h,!0,n,a),e.restoreDefaultFramebuffer(),m.dispose(),URL.revokeObjectURL(s),d())})}else{if(e._uploadImageToTexture(_,o,n,a),r){const m=l[a];m&&e._uploadImageToTexture(m._texture,o,n,0)}d()}})}function j(o,e,t=ue){if(!Z.IsExponentOfTwo(o.width))throw new Error("Texture size must be a power of two");const i=he.ILog2(o.width)+1,s=o.getEngine();let n=!1,a=!1,r=null,l=null,h=null;const _=s.getCaps();if(o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,o),_.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?_.textureHalfFloatRender&&_.textureHalfFloatLinearFiltering?(n=!0,o.type=2):_.textureFloatRender&&_.textureFloatLinearFiltering&&(n=!0,o.type=1):n=!1:(n=!1,a=!0,h={}),n)r=new Ve("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,o.type,void 0,null,!1),o._isRGBD=!1,o.invertY=!1,l=s.createRenderTargetCubeTexture(o.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:o.type,format:5});else if(o._isRGBD=!0,o.invertY=!0,a){const m=o._lodGenerationScale,f=o._lodGenerationOffset;for(let u=0;u<3;u++){const p=1-u/2,y=f,P=(i-1)*m+f,k=y+(P-y)*p,B=Math.round(Math.min(Math.max(k,0),P)),x=new le(s,$.Temp);x.isCube=!0,x.invertY=!0,x.generateMipMaps=!1,s.updateTextureSamplingMode(2,x);const T=new ge(null);switch(T._isCube=!0,T._texture=x,h[B]=T,u){case 0:o._lodTextureLow=T;break;case 1:o._lodTextureMid=T;break;case 2:o._lodTextureHigh=T;break}}}const d=[];for(let c=0;c<e.length;c++)for(let m=0;m<6;m++){const f=e[c][m],u=new Blob([f],{type:t}),A=URL.createObjectURL(u);let p;if(typeof Image>"u"||s._features.forceBitmapOverHTMLImageElement)p=s.createImageBitmap(u,{premultiplyAlpha:"none"}).then(y=>_e(y,s,n,r,A,m,c,a,h,l,o));else{const y=new Image;y.src=A,p=new Promise((P,k)=>{y.onload=()=>{_e(y,s,n,r,A,m,c,a,h,l,o).then(()=>P()).catch(B=>{k(B)})},y.onerror=B=>{k(B)}})}d.push(p)}if(e.length<i){let c;const m=Math.pow(2,i-1-e.length),f=m*m*4;switch(o.type){case 0:{c=new Uint8Array(f);break}case 2:{c=new Uint16Array(f);break}case 1:{c=new Float32Array(f);break}}for(let u=e.length;u<i;u++)for(let A=0;A<6;A++)s._uploadArrayBufferViewToTexture(o,c,A,u)}return Promise.all(d).then(()=>{l&&(s._releaseTexture(o),l._swapAndDie(o)),r&&r.dispose(),a&&(o._lodTextureHigh&&o._lodTextureHigh._texture&&(o._lodTextureHigh._texture.isReady=!0),o._lodTextureMid&&o._lodTextureMid._texture&&(o._lodTextureMid._texture.isReady=!0),o._lodTextureLow&&o._lodTextureLow._texture&&(o._lodTextureLow._texture.isReady=!0))})}function $e(o,e){e=ne(e);const t=e.irradiance;if(!t)return;const i=new Ee;g.FromArrayToRef(t.x,0,i.x),g.FromArrayToRef(t.y,0,i.y),g.FromArrayToRef(t.z,0,i.z),g.FromArrayToRef(t.xx,0,i.xx),g.FromArrayToRef(t.yy,0,i.yy),g.FromArrayToRef(t.zz,0,i.zz),g.FromArrayToRef(t.yz,0,i.yz),g.FromArrayToRef(t.zx,0,i.zx),g.FromArrayToRef(t.xy,0,i.xy),o._sphericalPolynomial=i}function ot(o,e,t,i,s){const n=o.getEngine().createRawCubeTexture(null,o.width,o.format,o.type,o.generateMipMaps,o.invertY,o.samplingMode,o._compression),a=j(n,e).then(()=>o);return o.onRebuildCallback=r=>({proxy:a,isReady:!0,isAsync:!0}),o._source=$.CubeRawRGBD,o._bufferViewArrayArray=e,o._lodGenerationScale=i,o._lodGenerationOffset=s,o._sphericalPolynomial=t,j(o,e).then(()=>(o.isReady=!0,o))}const at={GetEnvInfo:Ke,CreateEnvTextureAsync:je,CreateImageDataArrayBufferViews:Ae,UploadEnvLevelsAsync:qe,UploadLevelsAsync:j,UploadEnvSpherical:$e};class L extends ge{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(C.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach(n=>s+=n),new L(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const a=new L(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=n,a}constructor(e,t,i=null,s=!1,n=null,a=null,r=null,l=5,h=!1,_=null,d=!1,c=.8,m=0,f,u){var A;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new Q,this.boundingBoxPosition=g.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new C,this.name=e,this.url=e,this._noMipmap=s,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=C.Identity(),this._createPolynomials=d,this.coordinatesMode=ae.CUBIC_MODE,this._extensions=i,this._files=n,this._forcedExtension=_,this._loaderOptions=f,this._useSRGBBuffer=u,this._lodScale=c,this._lodOffset=m,!(!e&&!n)&&this.updateURL(e,_,a,h,r,i,(A=this.getScene())===null||A===void 0?void 0:A.useDelayedTextureLoading,n)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,s=!1,n=null,a=null,r=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const h=e.lastIndexOf("."),_=t||(h>-1?e.substring(h).toLowerCase():""),d=_.indexOf(".dds")===0,c=_.indexOf(".env")===0,m=_.indexOf(".basis")===0;if(c?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!m&&!c&&!d&&!a&&(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let f=0;f<a.length;f++)this._files.push(e+a[f]);this._extensions=a}r?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t,i;if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,r=>r.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e,!(!((i=this.getScene())===null||i===void 0)&&i.useRightHandedSystem)))return;const s=D.Vector3[0],n=D.Quaternion[0],a=D.Vector3[1];this._textureMatrix.decompose(s,n,a),n.z*=-1,n.w*=-1,C.ComposeToRef(s,n,a,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return!((e=this.getScene())===null||e===void 0)&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var i;const s=this.getScene(),n=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const a=()=>{var l;this.onLoadObservable.notifyObservers(this),n&&(n.dispose(),(l=this.getScene())===null||l===void 0||l.markAllMaterialsAsDirty(1)),e&&e()},r=(l,h)=>{this._loadingError=!0,this._errorObject={message:l,exception:h},t&&t(l,h),ae.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?Z.SetImmediate(()=>a()):this._texture.onLoadedObservable.add(()=>a()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,r,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,r,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(i=this._texture)===null||i===void 0||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const s=de.Parse(()=>{var n;let a=!1;return e.prefiltered&&(a=e.prefiltered),new L(i+((n=e.url)!==null&&n!==void 0?n:e.name),t,e.extensions,!1,e.files||null,null,null,void 0,a,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=g.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=g.FromArray(e.boundingBoxSize)),e.animations)for(let n=0;n<e.animations.length;n++){const a=e.animations[n],r=Le("BABYLON.Animation");r&&s.animations.push(r.Parse(a))}return s}clone(){let e=0;const t=de.Clone(()=>{const i=new L(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}v([b()],L.prototype,"url",void 0);v([q()],L.prototype,"boundingBoxPosition",void 0);v([q()],L.prototype,"boundingBoxSize",null);v([b("rotationY")],L.prototype,"rotationY",null);v([b("files")],L.prototype,"_files",void 0);v([b("forcedExtension")],L.prototype,"_forcedExtension",void 0);v([b("extensions")],L.prototype,"_extensions",void 0);v([pe("textureMatrix")],L.prototype,"_textureMatrix",void 0);v([pe("textureMatrixRefraction")],L.prototype,"_textureMatrixRefraction",void 0);ae._CubeTextureParser=L.Parse;Fe("BABYLON.CubeTexture",L);class et{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const s=this._pendingActions.shift();s?this._execute(e,s):e.idle=!0})})}}class ce extends et{constructor(e,t,i=ce.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,s)=>{t(i,()=>{s(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(a=>{a.terminate()});const n=this._workerInfos.indexOf(e);n!==-1&&this._workerInfos.splice(n,1)},this._options.idleTimeElapsedBeforeRelease))})})}}ce.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};export{ye as A,ee as B,L as C,at as E,Ge as F,Ke as G,Ze as R,$e as U,et as W,ot as _,se as a,Ae as b,ce as c,w as d,je as e,V as f,te as g,N as h,ie as i,qe as j,j as k,ne as n};
