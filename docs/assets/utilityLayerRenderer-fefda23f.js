import{j as H,a8 as w,O as W,a2 as Be,aA as fe,R as V,n as R,ar as we,m as Pe,h as ce,f as U,C as ge,q as ke,V as m,d as M,aE as b,g as f,w as L,v as Y,bF as $e,l as de,W as ze,p as I,E as X,ad as Le,aa as F,a9 as ye,i as Me,a6 as oe,cP as Ne,t as j,aD as Ge,aG as Ue,S as We,P as T,bZ as le,aL as Ye}from"./runBabylonPlaygroundScene-32a4afbd.js";import{T as ie,V as He,E as Xe,H as Ze}from"./linesBuilder-a2dae4c1.js";import{b as Ee,P as qe}from"./blurPostProcess-f61d1d3e.js";class S{}S.ANCHOR_SYSTEM="xr-anchor-system";S.BACKGROUND_REMOVER="xr-background-remover";S.HIT_TEST="xr-hit-test";S.MESH_DETECTION="xr-mesh-detection";S.PHYSICS_CONTROLLERS="xr-physics-controller";S.PLANE_DETECTION="xr-plane-detection";S.POINTER_SELECTION="xr-controller-pointer-selection";S.TELEPORTATION="xr-controller-teleportation";S.FEATURE_POINTS="xr-feature-points";S.HAND_TRACKING="xr-hand-tracking";S.IMAGE_TRACKING="xr-image-tracking";S.NEAR_INTERACTION="xr-near-interaction";S.DOM_OVERLAY="xr-dom-overlay";S.MOVEMENT="xr-controller-movement";S.LIGHT_ESTIMATION="xr-light-estimation";S.EYE_TRACKING="xr-eye-tracking";S.WALKING_LOCOMOTION="xr-walking-locomotion";S.LAYERS="xr-layers";S.DEPTH_SENSING="xr-depth-sensing";S.SPACE_WARP="xr-space-warp";class G{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&this.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)})})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){const s=this._AvailableFeatures[e][t];if(!s)throw new Error("feature not found");return s(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&t.featureImplementation.attach()}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&t.featureImplementation.detach()}disableFeature(e){const t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},r=!0,s=!0){const n=typeof e=="string"?e:e.Name;let a=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(t==="stable"?a=G.GetStableVersionOfFeature(n):t==="latest"?a=G.GetLatestVersionOfFeature(n):a=+t,a===-1||isNaN(a))throw new Error(`feature not found - ${n} (${t})`)}else a=t;const h=G._ConflictingFeatures[n];if(h!==void 0&&this.getEnabledFeatures().indexOf(h)!==-1)throw new Error(`Feature ${n} cannot be enabled while ${h} is enabled.`);const c=this._features[n],d=G.ConstructFeature(n,a,this._xrSessionManager,i);if(!d)throw new Error(`feature not found - ${n}`);c&&this.disableFeature(n);const p=d();if(p.dependsOn&&!p.dependsOn.every(C=>!!this._features[C]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${p.dependsOn.join(", ")}`);if(p.isCompatible())return this._features[n]={featureImplementation:p,enabled:!0,version:a,required:s},r?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(s)throw new Error("required feature not compatible");return H.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),p}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const r=this._features[i],s=r.featureImplementation.xrNativeFeatureName;if(s&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(s)===-1&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(s)===-1&&e.optionalFeatures.push(s))),r.featureImplementation.getXRSessionInitExtension){const n=await r.featureImplementation.getXRSessionInitExtension();e=Object.assign(Object.assign({},e),n)}}return e}}G._AvailableFeatures={};G._ConflictingFeatures={[S.TELEPORTATION]:S.MOVEMENT,[S.MOVEMENT]:S.TELEPORTATION};class st{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0}isCompatible(){return!0}_addNewAttachObserver(e,t){this._removeOnDetach.push({observable:e,observer:e.add(t)})}}var l;(function(o){o[o.Float=1]="Float",o[o.Int=2]="Int",o[o.Vector2=4]="Vector2",o[o.Vector3=8]="Vector3",o[o.Vector4=16]="Vector4",o[o.Color3=32]="Color3",o[o.Color4=64]="Color4",o[o.Matrix=128]="Matrix",o[o.Object=256]="Object",o[o.AutoDetect=1024]="AutoDetect",o[o.BasedOnInput=2048]="BasedOnInput",o[o.All=4095]="All"})(l||(l={}));var u;(function(o){o[o.Vertex=1]="Vertex",o[o.Fragment=2]="Fragment",o[o.Neutral=4]="Neutral",o[o.VertexAndFragment=3]="VertexAndFragment"})(u||(u={}));class Ve{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===u.Fragment;this.compilationString=`\r
${t?`//Entry point\r
`:""}void main(void) {\r
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\r
${t?`//Constants\r
`:""}${this._constantDeclaration}\r
${this.compilationString}`);let r="";for(const s in this.functions)r+=this.functions[s]+`\r
`;this.compilationString=`\r
${r}\r
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\r
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\r
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\r
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r
${t?`//Varyings\r
`:""}${this.sharedData.varyingDeclaration}\r
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\r
${t?`//Samplers\r
`:""}${this._samplerDeclaration}\r
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\r
${t?`//Uniforms\r
`:""}${this._uniformDeclaration}\r
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\r
${t?`//Attributes\r
`:""}${this._attributeDeclaration}\r
${this.compilationString}`),this.compilationString=`precision highp float;\r
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defines(WEBGPU)\r
precision highp sampler2DArray;\r
#endif\r
`+this.compilationString;for(const s in this.extensions){const n=this.extensions[s];this.compilationString=`\r
${n}\r
${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\r
`,this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\r
`,this.samplers.push(e))}_getGLType(e){switch(e){case l.Float:return"float";case l.Int:return"int";case l.Vector2:return"vec2";case l.Color3:case l.Vector3:return"vec3";case l.Color4:case l.Vector4:return"vec4";case l.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\r
${t}\r
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`\r
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r
`;let r=w.IncludesShadersStore[e]+`\r
`;if(this.sharedData.emitComments&&(r=t+`\r
`+r),!i)return r;if(i.replaceStrings)for(let s=0;s<i.replaceStrings.length;s++){const n=i.replaceStrings[s];r=r.replace(n.search,n.replace)}return r}_emitFunctionFromInclude(e,t,i,r=""){const s=e+r;if(!this.functions[s]){if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\r
`:this.functions[s]=`#include<${e}>${i!=null&&i.substitutionVars?"("+(i==null?void 0:i.substitutionVars)+")":""}\r
`,this.sharedData.emitComments&&(this.functions[s]=t+`\r
`+this.functions[s]);return}if(this.functions[s]=w.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[s]=t+`\r
`+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(let n=0;n<i.replaceStrings.length;n++){const a=i.replaceStrings[n];this.functions[s]=this.functions[s].replace(a.search,a.replace)}}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){return this.sharedData.varyings.indexOf(e)!==-1?!1:(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\r
`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\r
`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\r
`,i&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)}_emitUniformFromString(e,t,i="",r=!1){this.uniforms.indexOf(e)===-1&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\r
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}\r
`),this._uniformDeclaration+=`uniform ${t} ${e};\r
`,i&&(this._uniformDeclaration+=`#endif\r
`))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class Ke{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\r
`;if(e)throw`Build of NodeMaterial failed:\r
`+e}}var A;(function(o){o[o.Compatible=0]="Compatible",o[o.TypeIncompatible=1]="TypeIncompatible",o[o.TargetIncompatible=2]="TargetIncompatible",o[o.HierarchyIssue=3]="HierarchyIssue"})(A||(A={}));var Z;(function(o){o[o.Input=0]="Input",o[o.Output=1]="Output"})(Z||(Z={}));class q{static AreEquivalentTypes(e,t){switch(e){case l.Vector3:{if(t===l.Color3)return!0;break}case l.Vector4:{if(t===l.Color4)return!0;break}case l.Color3:{if(t===l.Vector3)return!0;break}case l.Color4:{if(t===l.Vector4)return!0;break}}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===l.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===l.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==u.VertexAndFragment?this._target:this._ownerBlock.target===u.Fragment?u.Fragment:u.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===u.Vertex||(e.ownerBlock.target===u.Neutral||e.ownerBlock.target===u.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===u.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===u.Vertex||e.target===u.Vertex||(e.ownerBlock.target===u.Neutral||e.ownerBlock.target===u.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===u.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===u.Fragment||(e.ownerBlock.target===u.Neutral||e.ownerBlock.target===u.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInFragmentShader))return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=l.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new W,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=u.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===A.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===u.Fragment){if(i.target===u.Vertex)return A.TargetIncompatible;for(const n of i.outputs)if(n.ownerBlock.target!=u.Neutral&&n.isConnectedInVertexShader)return A.TargetIncompatible}if(this.type!==e.type&&e.innerType!==l.AutoDetect)return q.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&q.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?A.Compatible:A.TypeIncompatible;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return A.TypeIncompatible;let r=i,s=t;return this.direction===Z.Input&&(r=t,s=i),r.isAnAncestorOf(s)?A.HierarchyIssue:A.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<l.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class D{get name(){return this._name}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=u.Vertex,i=!1,r=!1){this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===u.Neutral,this._isFinalMerger=i,this._isInput=r,this._name=e,this.uniqueId=Be.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===u.Neutral}initialize(e){}bind(e,t,i,r){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}registerInput(e,t,i=!1,r,s){return s=s??new q(e,this,Z.Input),s.type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return r=r??new q(e,this,Z.Output),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===l.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===u.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===u.Vertex?!1:!!((this.target===u.VertexAndFragment||this.target===u.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);const s=t._vertexState!=null,n=e._buildTarget===u.Vertex&&e.target!==u.VertexAndFragment;if(s&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==u.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const a=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+a.associatedVariableName,t._getGLType(a.type))&&(t._vertexState.compilationString+=`${"v_"+a.associatedVariableName} = ${a.associatedVariableName};\r
`),i.associatedVariableName="v_"+a.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==u.Neutral&&(!(i.target&this.target)||!(i.target&e.target)))continue;const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===u.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case u.Vertex:e.sharedData.checks.emitVertex=!0;break;case u.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\r
//${this.name}\r
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(i.target&e.target)for(const r of i.endpoints){const s=r.ownerBlock;s&&s.target&e.target&&t.indexOf(s)!==-1&&this._processBuild(s,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\r
${e}.visibleOnFrame = ${this.visibleOnFrame};\r
${e}.target = ${this.target};\r
`}_dumpCode(e,t){t.push(this);let i;const r=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=r||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let s=0;do s++,this._codeVariableName=r+s;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName),i=`\r
// ${this.getClassName()}\r
`,this.comments&&(i+=`// ${this.comments}\r
`),i+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\r
`,i+=this._dumpPropertiesCode();for(const s of this.inputs){if(!s.isConnected)continue;const a=s.connectedPoint.ownerBlock;t.indexOf(a)===-1&&(i+=a._dumpCode(e,t))}for(const s of this.outputs)if(s.hasEndpoints)for(const n of s.endpoints){const a=n.ownerBlock;a&&t.indexOf(a)===-1&&(i+=a._dumpCode(e,t))}return i}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\r
`}return t}clone(e,t=""){const i=this.serialize(),r=fe(i.customType);if(r){const s=new r;return s._deserialize(i,e,t),s}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var r;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=(r=e.target)!==null&&r!==void 0?r:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((r,s)=>{r.displayName&&(this.inputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.inputs[s].isExposedOnFrame=r.isExposedOnFrame,this.inputs[s].exposedPortPosition=r.exposedPortPosition)}),i&&i.forEach((r,s)=>{r.displayName&&(this.outputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[s].isExposedOnFrame=r.isExposedOnFrame,this.outputs[s].exposedPortPosition=r.exposedPortPosition)})}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class me extends D{constructor(e){super(e,u.Neutral),this.complementW=1,this.complementZ=0,this.target=u.Vertex,this.registerInput("vector",l.AutoDetect),this.registerInput("transform",l.Matrix),this.registerOutput("output",l.Vector4),this.registerOutput("xyz",l.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(this.complementW===0){const r=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",r),e.sharedData.blocksWithDefines.push(this);const s=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${s} = mat3(${i.associatedVariableName});\r
`,e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+=`${s} = transposeMat3(inverseMat3(${s}));\r
`,e.compilationString+=`#endif\r
`,t.connectedPoint.type){case l.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\r
`;break;case l.Vector3:case l.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${s} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\r
`;break}}else{const r=i.associatedVariableName;switch(t.connectedPoint.type){case l.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${r} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\r
`;break;case l.Vector3:case l.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${r} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${r} * ${t.associatedVariableName};\r
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\r
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\r
`,e}}V("BABYLON.TransformBlock",me);class ee extends D{constructor(e){super(e,u.Vertex,!0),this.registerInput("vector",l.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e){for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector;return e.compilationString+=`gl_Position = ${t.associatedVariableName};\r
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;\r
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r
`),this}}V("BABYLON.VertexOutputBlock",ee);var z;(function(o){o[o.Boolean=0]="Boolean",o[o.Float=1]="Float",o[o.Int=2]="Int",o[o.Vector2=3]="Vector2",o[o.List=4]="List"})(z||(z={}));function K(o,e=z.Boolean,t="PROPERTIES",i){return(r,s)=>{let n=r._propStore;n||(n=[],r._propStore=n),n.push({propertyName:s,displayName:o,type:e,groupName:t,options:i??{}})}}class $ extends D{constructor(e){super(e,u.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",l.Color4,!0),this.registerInput("rgb",l.AutoDetect,!0),this.registerInput("a",l.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(l.Color3|l.Vector3|l.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){this.useLogarithmicDepth&&i&&we.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const s=`//${this.name}`;if(e._emitFunctionFromInclude("helperFunctions",s),t.connectedPoint)r.isConnected?e.compilationString+=`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${r.associatedVariableName});\r
`:e.compilationString+=`gl_FragColor = ${t.associatedVariableName};\r
`;else if(i.connectedPoint){let n="1.0";r.connectedPoint&&(n=r.associatedVariableName),i.connectedPoint.type===l.Float?e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${n});\r
`:e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${n});\r
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this.useLogarithmicDepth&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var r;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=(r=e.useLogarithmicDepth)!==null&&r!==void 0?r:!1}}R([K("Convert to gamma space",z.Boolean,"PROPERTIES",{notifiers:{update:!0}})],$.prototype,"convertToGammaSpace",void 0);R([K("Convert to linear space",z.Boolean,"PROPERTIES",{notifiers:{update:!0}})],$.prototype,"convertToLinearSpace",void 0);R([K("Use logarithmic depth",z.Boolean,"PROPERTIES")],$.prototype,"useLogarithmicDepth",void 0);V("BABYLON.FragmentOutputBlock",$);var y;(function(o){o[o.Uniform=0]="Uniform",o[o.Attribute=1]="Attribute",o[o.Varying=2]="Varying",o[o.Undefined=3]="Undefined"})(y||(y={}));var g;(function(o){o[o.World=1]="World",o[o.View=2]="View",o[o.Projection=3]="Projection",o[o.ViewProjection=4]="ViewProjection",o[o.WorldView=5]="WorldView",o[o.WorldViewProjection=6]="WorldViewProjection",o[o.CameraPosition=7]="CameraPosition",o[o.FogColor=8]="FogColor",o[o.DeltaTime=9]="DeltaTime",o[o.CameraParameters=10]="CameraParameters",o[o.MaterialAlpha=11]="MaterialAlpha"})(g||(g={}));var k;(function(o){o[o.None=0]="None",o[o.Time=1]="Time",o[o.RealTime=2]="RealTime"})(k||(k={}));const Je={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},he={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Re={particle_texturemask:!0};class E extends D{get type(){if(this._type===l.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=l.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=l.Vector2,this._type;case"Vector3":return this._type=l.Vector3,this._type;case"Vector4":return this._type=l.Vector4,this._type;case"Color3":return this._type=l.Color3,this._type;case"Color4":return this._type=l.Color4,this._type;case"Matrix":return this._type=l.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=l.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=l.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=l.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=l.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case g.World:case g.WorldView:case g.WorldViewProjection:case g.View:case g.ViewProjection:case g.Projection:return this._type=l.Matrix,this._type;case g.CameraPosition:return this._type=l.Vector3,this._type;case g.FogColor:return this._type=l.Color3,this._type;case g.DeltaTime:case g.MaterialAlpha:return this._type=l.Float,this._type;case g.CameraParameters:return this._type=l.Vector4,this._type}}return this._type}constructor(e,t=u.Vertex,i=l.AutoDetect){super(e,t,!1,!0),this._mode=y.Undefined,this._animationType=k.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new W,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=y.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===l.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=y.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=y.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===y.Undefined}get isUniform(){return this._mode===y.Uniform}set isUniform(e){this._mode=e?y.Uniform:y.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===y.Attribute}set isAttribute(e){this._mode=e?y.Attribute:y.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===y.Varying}set isVarying(e){this._mode=e?y.Varying:y.Undefined,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=y.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case k.Time:{this.type===l.Float&&(this.value+=e.getAnimationRatio()*.01);break}case k.RealTime:{this.type===l.Float&&(this.value=(Pe.Now-e.getEngine().startTime)/1e3);break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}\r
`:`#ifdef ${e}\r
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case l.Float:this.value=0;break;case l.Vector2:this.value=M.Zero();break;case l.Vector3:this.value=m.Zero();break;case l.Vector4:this.value=ke.Zero();break;case l.Color3:this.value=ge.White();break;case l.Color4:this.value=new U(1,1,1,1);break;case l.Matrix:this.value=ce.Identity();break}}_emitConstant(e){switch(this.type){case l.Float:return`${e._emitFloat(this.value)}`;case l.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case l.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case l.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case l.Color3:return b.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&b.Color3[0].toGammaSpaceToRef(b.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&b.Color3[0].toLinearSpaceToRef(b.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${b.Color3[0].r}, ${b.Color3[0].g}, ${b.Color3[0].b})`;case l.Color4:return b.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&b.Color4[0].toGammaSpaceToRef(b.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&b.Color4[0].toLinearSpaceToRef(b.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${b.Color4[0].r}, ${b.Color4[0].g}, ${b.Color4[0].b}, ${b.Color4[0].a})`}return""}get _noContextSwitch(){return he[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\r
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,t&&(e._uniformDeclaration+=`#endif\r
`);const r=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case g.WorldView:r.needWorldViewMatrix=!0;break;case g.WorldViewProjection:r.needWorldViewProjectionMatrix=!0;break}else this._animationType!==k.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(i=Je[this.name])!==null&&i!==void 0?i:this.name,this.target===u.Vertex&&e._vertexState){he[this.name]?Re[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),he[this.name]?Re[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,t&&(e._attributeDeclaration+=`#endif\r
`))}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const s=this.associatedVariableName;switch(this._systemValue){case g.World:e.setMatrix(s,t);break;case g.WorldView:e.setMatrix(s,i);break;case g.WorldViewProjection:e.setMatrix(s,r);break}}_transmit(e,t,i){if(this.isAttribute)return;const r=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case g.World:case g.WorldView:case g.WorldViewProjection:return;case g.View:e.setMatrix(r,t.getViewMatrix());break;case g.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case g.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case g.CameraPosition:t.bindEyePosition(e,r,!0);break;case g.FogColor:e.setColor3(r,t.fogColor);break;case g.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case g.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case g.MaterialAlpha:e.setFloat(r,i.alpha);break}return}const s=this._valueCallback?this._valueCallback():this._storedValue;if(s!==null)switch(this.type){case l.Float:e.setFloat(r,s);break;case l.Int:e.setInt(r,s);break;case l.Color3:b.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&b.Color3[0].toGammaSpaceToRef(b.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&b.Color3[0].toLinearSpaceToRef(b.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,b.Color3[0]);break;case l.Color4:b.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&b.Color4[0].toGammaSpaceToRef(b.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&b.Color4[0].toLinearSpaceToRef(b.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,b.Color4[0]);break;case l.Vector2:e.setVector2(r,s);break;case l.Vector3:e.setVector3(r,s);break;case l.Vector4:e.setVector4(r,s);break;case l.Matrix:e.setMatrix(r,s);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\r
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${g[this._systemValue]});\r
`;if(this.isUniform){const t=[];let i="";switch(this.type){case l.Float:i=`${this.value}`;break;case l.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case l.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case l.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case l.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case l.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case l.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return t.push(`${e}.value = ${i}`),this.type===l.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${k[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;\r
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===y.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===y.Attribute&&e.type===l.Vector3&&(this._type=l.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const r=fe(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}}V("BABYLON.InputBlock",E);class Oe extends D{constructor(e){super(e,u.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",l.AutoDetect,!1,u.VertexAndFragment),this.registerOutput("rgba",l.Color4,u.Neutral),this.registerOutput("rgb",l.Color3,u.Neutral),this.registerOutput("r",l.Float,u.Neutral),this.registerOutput("g",l.Float,u.Neutral),this.registerOutput("b",l.Float,u.Neutral),this.registerOutput("a",l.Float,u.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(l.Vector2|l.Vector3|l.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?u.VertexAndFragment:u.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===u.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r
`;return}if(this.uv.ownerBlock.target===u.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r
`;return}e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===u.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}if(this.uv.ownerBlock.target===u.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==u.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=ie.Parse(e.texture,t,i))}}V("BABYLON.CurrentScreenBlock",Oe);class De extends D{constructor(e){super(e,u.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",l.AutoDetect,!1,u.VertexAndFragment),this.registerOutput("rgba",l.Color4,u.Neutral),this.registerOutput("rgb",l.Color3,u.Neutral),this.registerOutput("r",l.Float,u.Neutral),this.registerOutput("g",l.Float,u.Neutral),this.registerOutput("b",l.Float,u.Neutral),this.registerOutput("a",l.Float,u.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(l.Vector2|l.Vector3|l.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="particle_uv");t||(t=new E("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),e.target===u.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\r
`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=ie.Parse(e.texture,t,i))}}V("BABYLON.ParticleTextureBlock",De);class Te extends D{constructor(e){super(e,u.Fragment),this._isUnique=!0,this.registerInput("color",l.Color4,!1,u.Fragment),this.registerOutput("rampColor",l.Color4,u.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==u.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = ${this.color.associatedVariableName};
                float alpha = ${this.color.associatedVariableName}.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                ${this._declareOutput(this.rampColor,e)} = baseColor;
            #else
                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}V("BABYLON.ParticleRampGradientBlock",Te);class Fe extends D{constructor(e){super(e,u.Fragment),this._isUnique=!0,this.registerInput("color",l.Color4,!1,u.Fragment),this.registerInput("alphaTexture",l.Float,!1,u.Fragment),this.registerInput("alphaColor",l.Float,!1,u.Fragment),this.registerOutput("blendColor",l.Color4,u.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==u.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${this._declareOutput(this.blendColor,e)};
                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;
            #else
                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}V("BABYLON.ParticleBlendMultiplyBlock",Fe);class te extends D{constructor(e){super(e,u.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",l.Vector4,!0),this.registerInput("xyz ",l.Vector3,!0),this.registerInput("xy ",l.Vector2,!0),this.registerInput("zw ",l.Vector2,!0),this.registerInput("x",l.Float,!0),this.registerInput("y",l.Float,!0),this.registerInput("z",l.Float,!0),this.registerInput("w",l.Float,!0),this.registerOutput("xyzw",l.Vector4),this.registerOutput("xyz",l.Vector3),this.registerOutput("xy",l.Vector2),this.registerOutput("zw",l.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,s=this.w,n=this.xyIn,a=this.zwIn,h=this.xyzIn,c=this.xyzwIn,d=this._outputs[0],p=this._outputs[1],_=this._outputs[2],C=this._outputs[3];return c.isConnected?(d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};\r
`),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};\r
`),_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};\r
`)):h.isConnected?(d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = vec4(${h.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+` = ${h.associatedVariableName}${this._buildSwizzle(3)};\r
`),_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+` = ${h.associatedVariableName}${this._buildSwizzle(2)};\r
`)):n.isConnected?(d.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(d,e)+` = vec4(${n.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(d,e)+` = vec4(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+` = vec3(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\r
`),_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};\r
`),C.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(C,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(C,e)+` = vec2(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r
`)):(d.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(d,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(d,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};\r
`),p.hasEndpoints&&(e.compilationString+=this._declareOutput(p,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};\r
`),_.hasEndpoints&&(e.compilationString+=this._declareOutput(_,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\r
`),C.hasEndpoints&&(a.isConnected?e.compilationString+=this._declareOutput(C,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(C,e)+` = vec2(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};\r
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var r,s,n,a;super._deserialize(e,t,i),this.xSwizzle=(r=e.xSwizzle)!==null&&r!==void 0?r:"x",this.ySwizzle=(s=e.ySwizzle)!==null&&s!==void 0?s:"y",this.zSwizzle=(n=e.zSwizzle)!==null&&n!==void 0?n:"z",this.wSwizzle=(a=e.wSwizzle)!==null&&a!==void 0?a:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\r
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\r
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\r
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\r
`,e}}V("BABYLON.VectorMergerBlock",te);class re extends D{constructor(e){super(e,u.Neutral),this.sourceRange=new M(-1,1),this.targetRange=new M(0,1),this.registerInput("input",l.AutoDetect),this.registerInput("sourceMin",l.Float,!0),this.registerInput("sourceMax",l.Float,!0),this.registerInput("targetMin",l.Float,!0),this.registerInput("targetMax",l.Float,!0),this.registerOutput("output",l.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${s}) / (${r} - ${i});\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=M.FromArray(e.sourceRange),this.targetRange=M.FromArray(e.targetRange)}}R([K("From",z.Vector2)],re.prototype,"sourceRange",void 0);R([K("To",z.Vector2)],re.prototype,"targetRange",void 0);V("BABYLON.RemapBlock",re);class pe extends D{constructor(e){super(e,u.Neutral),this.registerInput("left",l.AutoDetect),this.registerInput("right",l.AutoDetect),this.registerOutput("output",l.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(l.Float),this._inputs[1].acceptedConnectionPointTypes.push(l.Float)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r
`,this}}V("BABYLON.MultiplyBlock",pe);var O;(function(o){o[o.Material=0]="Material",o[o.PostProcess=1]="PostProcess",o[o.Particle=2]="Particle",o[o.ProceduralTexture=3]="ProceduralTexture"})(O||(O={}));class _e{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.minEmitBox=new m(-.5,-.5,-.5),this.maxEmitBox=new m(.5,.5,.5)}startDirectionFunction(e,t,i,r){const s=f.RandomRange(this.direction1.x,this.direction2.x),n=f.RandomRange(this.direction1.y,this.direction2.y),a=f.RandomRange(this.direction1.z,this.direction2.z);if(r){t.x=s,t.y=n,t.z=a;return}m.TransformNormalFromFloatsToRef(s,n,a,e,t)}startPositionFunction(e,t,i,r){const s=f.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),n=f.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),a=f.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(r){t.x=s,t.y=n,t.z=a;return}m.TransformCoordinatesFromFloatsToRef(s,n,a,e,t)}clone(){const e=new _e;return L.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),m.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),m.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class be{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){r?Y.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),Y.Vector3[0]).normalize();const s=f.RandomRange(0,this.directionRandomizer),n=f.RandomRange(0,this.directionRandomizer),a=f.RandomRange(0,this.directionRandomizer);t.x=Y.Vector3[0].x+s,t.y=Y.Vector3[0].y+n,t.z=Y.Vector3[0].z+a,t.normalize()}startPositionFunction(e,t,i,r){const s=f.RandomRange(0,Math.PI*2);let n;this.emitFromSpawnPointOnly?n=1e-4:(n=f.RandomRange(0,this.heightRange),n=1-n*n);let a=this._radius-f.RandomRange(0,this._radius*this.radiusRange);a=a*n;const h=a*Math.sin(s),c=a*Math.cos(s),d=n*this._height;if(r){t.x=h,t.y=d,t.z=c;return}m.TransformCoordinatesFromFloatsToRef(h,d,c,e,t)}clone(){const e=new be(this._radius,this._angle,this.directionRandomizer);return L.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}}class se{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=m.Zero()}startDirectionFunction(e,t,i,r,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),m.TransformNormalToRef(this._tempVector,s,this._tempVector);const n=f.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let a=Math.atan2(this._tempVector.x,this._tempVector.z);if(a+=f.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=n,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),r){t.copyFrom(this._tempVector);return}m.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){const s=f.RandomRange(-this.height/2,this.height/2),n=f.RandomRange(0,2*Math.PI),a=f.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),h=Math.sqrt(a)*this.radius,c=h*Math.cos(n),d=h*Math.sin(n);if(r){t.copyFromFloats(c,s,d);return}m.TransformCoordinatesFromFloatsToRef(c,s,d,e,t)}clone(){const e=new se(this.radius,this.directionRandomizer);return L.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Se extends se{constructor(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=s}startDirectionFunction(e,t){const i=f.RandomRange(this.direction1.x,this.direction2.x),r=f.RandomRange(this.direction1.y,this.direction2.y),s=f.RandomRange(this.direction1.z,this.direction2.z);m.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new Se(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return L.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class xe{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),n=f.RandomRange(0,this.directionRandomizer),a=f.RandomRange(0,this.directionRandomizer),h=f.RandomRange(0,this.directionRandomizer);if(s.x+=n,s.y+=a,s.z+=h,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-f.RandomRange(0,this.radius*this.radiusRange),n=f.RandomRange(0,1),a=f.RandomRange(0,2*Math.PI),h=Math.acos(2*n-1),c=s*Math.cos(a)*Math.sin(h),d=s*Math.cos(h),p=s*Math.sin(a)*Math.sin(h);if(r){t.copyFromFloats(c,Math.abs(d),p);return}m.TransformCoordinatesFromFloatsToRef(c,Math.abs(d),p,e,t)}clone(){const e=new xe(this.radius,this.directionRandomizer);return L.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class ve{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0)}startDirectionFunction(e,t,i,r){const s=f.RandomRange(this.direction1.x,this.direction2.x),n=f.RandomRange(this.direction1.y,this.direction2.y),a=f.RandomRange(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,n,a);return}m.TransformNormalFromFloatsToRef(s,n,a,e,t)}startPositionFunction(e,t,i,r){if(r){t.copyFromFloats(0,0,0);return}m.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new ve;return L.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}}class ae{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),n=f.RandomRange(0,this.directionRandomizer),a=f.RandomRange(0,this.directionRandomizer),h=f.RandomRange(0,this.directionRandomizer);if(s.x+=n,s.y+=a,s.z+=h,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-f.RandomRange(0,this.radius*this.radiusRange),n=f.RandomRange(0,1),a=f.RandomRange(0,2*Math.PI),h=Math.acos(2*n-1),c=s*Math.cos(a)*Math.sin(h),d=s*Math.cos(h),p=s*Math.sin(a)*Math.sin(h);if(r){t.copyFromFloats(c,d,p);return}m.TransformCoordinatesFromFloatsToRef(c,d,p,e,t)}clone(){const e=new ae(this.radius,this.directionRandomizer);return L.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Ce extends ae{constructor(e=1,t=new m(0,1,0),i=new m(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=f.RandomRange(this.direction1.x,this.direction2.x),r=f.RandomRange(this.direction1.y,this.direction2.y),s=f.RandomRange(this.direction1.z,this.direction2.z);m.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new Ce(this.radius,this.direction1,this.direction2);return L.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class B{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:m.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:m.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:m.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:m.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let r=0;for(const s of t){if(s.gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=m.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new m(10,10,10),this.onAnimationEnd=null,this.blendMode=B.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new M(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new m(0,0,0),this._useLogarithmicDepth=!1,this.gravity=m.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new U(1,1,1,1),this.color2=new U(1,1,1,1),this.colorDead=new U(0,0,0,1),this.textureMask=new U(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new $e,this.id=e,this.name=e}createPointEmitter(e,t){const i=new ve;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=new xe(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=new ae(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new m(0,1,0),i=new m(0,1,0)){const r=new Ce(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const s=new se(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){const n=new Se(e,t,i,r,s);return this.particleEmitterType=n,n}createConeEmitter(e=1,t=Math.PI/4){const i=new be(e,t);return this.particleEmitterType=i,i}createBoxEmitter(e,t,i,r){const s=new _e;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}}B.BLENDMODE_ONEONE=0;B.BLENDMODE_STANDARD=1;B.BLENDMODE_ADD=2;B.BLENDMODE_MULTIPLY=3;B.BLENDMODE_MULTIPLYADD=4;class Ae extends D{constructor(e){super(e,u.Neutral),this.registerInput("rgba",l.Color4,!0),this.registerInput("rgb ",l.Color3,!0),this.registerOutput("rgb",l.Color3),this.registerOutput("r",l.Float),this.registerOutput("g",l.Float),this.registerOutput("b",l.Float),this.registerOutput("a",l.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\r
`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.r;\r
`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.g;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.b;\r
`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.a;\r
`),this}}V("BABYLON.ColorSplitterBlock",Ae);class je{constructor(e){this.name=de.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=new Array}register(){this.scene._beforeClearStage.registerStep(de.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){H.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}H.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}const Qe="proceduralVertexShader",et=`attribute vec2 position;
varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;ze.ShadersStore[Qe]=et;class P extends ie{constructor(e,t,i,r,s=null,n=!0,a=!1,h=0){super(null,r,!n),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new W,this.onBeforeGenerationObservable=new W,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,r=this.getScene()||X.LastCreatedScene;let c=r._getComponent(de.NAME_PROCEDURALTEXTURE);c||(c=new je(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=h,this._generateMipMaps=n,this._drawWrapper=new Le(this._fullEngine),this.setFragment(i),this._fallbackTexture=s;const d=this._createRtWrapper(a,t,n,h);this._texture=d.texture;const p=[];p.push(1,1),p.push(-1,1),p.push(-1,-1),p.push(1,-1),this._vertexBuffers[F.PositionKind]=new F(this._fullEngine,p,F.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[F.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Ee.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Ee.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)===null||e===void 0||e.dispose()}_getDefines(){return""}isReady(){const e=this._fullEngine;let t;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const i=this._getDefines();return this._drawWrapper.effect&&i===this._cachedDefines&&this._drawWrapper.effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?t={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:t={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==i&&(this._cachedDefines=i,this._drawWrapper.effect=e.createEffect(t,[F.PositionKind],this._uniforms,this._samplers,i,void 0,void 0,()=>{var r;(r=this._rtWrapper)===null||r===void 0||r.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const r=this.getScene();if(!r)return;const s=this._fullEngine;if(s.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),s.setState(!1),!this.nodeMaterialSource){for(const a in this._textures)this._drawWrapper.effect.setTexture(a,this._textures[a]);for(const a in this._ints)this._drawWrapper.effect.setInt(a,this._ints[a]);for(const a in this._floats)this._drawWrapper.effect.setFloat(a,this._floats[a]);for(const a in this._floatsArrays)this._drawWrapper.effect.setArray(a,this._floatsArrays[a]);for(const a in this._colors3)this._drawWrapper.effect.setColor3(a,this._colors3[a]);for(const a in this._colors4){const h=this._colors4[a];this._drawWrapper.effect.setFloat4(a,h.r,h.g,h.b,h.a)}for(const a in this._vectors2)this._drawWrapper.effect.setVector2(a,this._vectors2[a]);for(const a in this._vectors3)this._drawWrapper.effect.setVector3(a,this._vectors3[a]);for(const a in this._matrices)this._drawWrapper.effect.setMatrix(a,this._matrices[a])}if(!this._texture||!this._rtWrapper)return;(t=s._debugPushGroup)===null||t===void 0||t.call(s,`procedural texture generation for ${this.name}`,1);const n=s.currentViewport;if(this.isCube)for(let a=0;a<6;a++)s.bindFramebuffer(this._rtWrapper,a,void 0,void 0,!0),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",a),this.autoClear&&s.clear(r.clearColor,!0,!1,!1),s.drawElementsType(ye.TriangleFillMode,0,6);else s.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&s.clear(r.clearColor,!0,!1,!1),s.drawElementsType(ye.TriangleFillMode,0,6);s.unBindFramebuffer(this._rtWrapper,this.isCube),n&&s.setViewport(n),this.isCube&&s.generateMipMapsForCubemap(this._texture),(i=s._debugPopGroup)===null||i===void 0||i.call(s,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new P(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[F.PositionKind];i&&(i.dispose(),this._vertexBuffers[F.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}R([I()],P.prototype,"isEnabled",void 0);R([I()],P.prototype,"autoClear",void 0);R([I()],P.prototype,"_generateMipMaps",void 0);R([I()],P.prototype,"_size",void 0);R([I()],P.prototype,"refreshRate",null);V("BABYLON.ProceduralTexture",P);var x;(function(o){o[o.Cos=0]="Cos",o[o.Sin=1]="Sin",o[o.Abs=2]="Abs",o[o.Exp=3]="Exp",o[o.Exp2=4]="Exp2",o[o.Round=5]="Round",o[o.Floor=6]="Floor",o[o.Ceiling=7]="Ceiling",o[o.Sqrt=8]="Sqrt",o[o.Log=9]="Log",o[o.Tan=10]="Tan",o[o.ArcTan=11]="ArcTan",o[o.ArcCos=12]="ArcCos",o[o.ArcSin=13]="ArcSin",o[o.Fract=14]="Fract",o[o.Sign=15]="Sign",o[o.Radians=16]="Radians",o[o.Degrees=17]="Degrees"})(x||(x={}));class Ie extends D{constructor(e){super(e,u.Neutral),this.operation=x.Cos,this.registerInput("input",l.AutoDetect),this.registerOutput("output",l.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case x.Cos:{i="cos";break}case x.Sin:{i="sin";break}case x.Abs:{i="abs";break}case x.Exp:{i="exp";break}case x.Exp2:{i="exp2";break}case x.Round:{i="round";break}case x.Floor:{i="floor";break}case x.Ceiling:{i="ceil";break}case x.Sqrt:{i="sqrt";break}case x.Log:{i="log";break}case x.Tan:{i="tan";break}case x.ArcTan:{i="atan";break}case x.ArcCos:{i="acos";break}case x.ArcSin:{i="asin";break}case x.Fract:{i="fract";break}case x.Sign:{i="sign";break}case x.Radians:{i="radians";break}case x.Degrees:{i="degrees";break}}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\r
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${x[this.operation]};\r
`}}V("BABYLON.TrigonometryBlock",Ie);const ue={effect:null,subMesh:null};class Q extends Ue{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class v extends He{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||X.LastCreatedScene),this._buildId=v._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new ce,this._cachedWorldViewProjectionMatrix=new ce,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new W,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=O.Material,this.forceAlphaBlending=!1,this._options=Object.assign({emitComments:!1},i),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return H.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&u.Vertex&&this._addVertexOutputNode(e),e.target&u.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:(e.target&u.Vertex&&this._removeVertexOutputNode(e),e.target&u.Fragment&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=u.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=u.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_initializeBlock(e,t,i,r=!0){if(e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const s=e.getClassName();for(const n of this.attachedBlocks)if(n.getClassName()===s)throw`Cannot have multiple blocks of type ${s} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const s of e.inputs){s.associatedVariableName="";const n=s.connectedPoint;if(n){const a=n.ownerBlock;a!==e&&((a.target===u.VertexAndFragment||t.target===u.Fragment&&a.target===u.Vertex&&a._preparationId!==this._buildId)&&i.push(a),this._initializeBlock(a,t,i,r))}}for(const s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===u.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!0){this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),s=this._mode===O.Particle;if(this._vertexOutputNodes.length===0&&!s)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Ve,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=u.Vertex,this._fragmentCompilationState=new Ve,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=u.Fragment,this._sharedData=new Ke,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;const n=[],a=[];for(const c of this._vertexOutputNodes)n.push(c),this._initializeBlock(c,this._vertexCompilationState,a,i);for(const c of this._fragmentOutputNodes)a.push(c),this._initializeBlock(c,this._fragmentCompilationState,n,i);this.optimize();for(const c of n)c.build(this._vertexCompilationState,n);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const c of a)this._resetDualBlocks(c,this._buildId-1);for(const c of a)c.build(this._fragmentCompilationState,a);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=v._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const h=this.getScene().meshes;for(const c of h)if(c.subMeshes)for(const d of c.subMeshes){if(d.getMaterial()!==this||!d.materialDefines)continue;const p=d.materialDefines;p.markAllAsDirty(),p.reset()}}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(F.NormalKind),t.TANGENT=e.isVerticesDataPresent(F.TangentKind);const n=e.useVertexColors&&e.isVerticesDataPresent(F.ColorKind);t.VERTEXCOLOR_NME=n;let a=!1;for(let h=1;h<=6;++h){const c=t["UV"+h];t["UV"+h]=e.isVerticesDataPresent(`uv${h===1?"":h}`),a=a||t["UV"+h]!==c}(i!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}createPostProcess(e,t=1,i=1,r,s,n=0,a=5){return this.mode!==O.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,n,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,n,a=0,h=5){let c=this.name+this._buildId;const d=new Q,p=new oe(c+"PostProcess",this.getScene());let _=this._buildId;return this._processDefines(p,d),w.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(d.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new qe(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,n,d.toString(),a,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,h),e.nodeMaterialSource=this,e.onApplyObservable.add(C=>{_!==this._buildId&&(delete w.ShadersStore[c+"VertexShader"],delete w.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,d.markAllAsDirty(),_=this._buildId),this._processDefines(p,d)&&(w.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Ne.SetImmediate(()=>e.updateEffect(d.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(C)}),e}createProceduralTexture(e,t){if(this.mode!==O.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new P(i,e,null,t),s=new oe(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};const n=new Q,a=this._processDefines(s,n);w.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let h=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[F.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),a==null?void 0:a.fallbacks,void 0);r.nodeMaterialSource=this,r._setEffect(h);let c=this._buildId;return r.onBeforeGenerationObservable.add(()=>{c!==this._buildId&&(delete w.ShadersStore[i+"VertexShader"],delete w.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),c=this._buildId);const d=this._processDefines(s,n);d&&(w.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Ne.SetImmediate(()=>{h=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[F.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),d==null?void 0:d.fallbacks,void 0),r._setEffect(h)})),this._checkInternals(h)}),r}_createEffectForParticles(e,t,i,r,s,n,a,h=""){let c=this.name+this._buildId+"_"+t;n||(n=new Q),a||(a=this.getScene().getMeshByName(this.name+"Particle"),a||(a=new oe(this.name+"Particle",this.getScene()),a.reservedDataStore={hidden:!0}));let d=this._buildId;const p=[];let _=h;if(!s){const C=this._processDefines(a,n);w.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),e.fillDefines(p,t),_=p.join(`
`),s=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+_,C==null?void 0:C.fallbacks,i,r,e),e.setCustomEffect(s,t)}s.onBindObservable.add(C=>{d!==this._buildId&&(delete w.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,n.markAllAsDirty(),d=this._buildId),p.length=0,e.fillDefines(p,t);const ne=p.join(`
`);ne!==_&&(n.markAllAsDirty(),_=ne);const J=this._processDefines(a,n);if(J){w.RegisterShader(c,this._fragmentCompilationState._builtCompilationString),C=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+_,J==null?void 0:J.fallbacks,i,r,e),e.setCustomEffect(C,t),this._createEffectForParticles(e,t,i,r,C,n,a,h);return}this._checkInternals(C)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==O.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,B.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,B.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==O.Material){console.log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let s=null;const n=this.getScene();if(we.PrepareDefinesForCamera(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(a=>{a.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(a=>{a.prepareDefines(e,this,t,i,r)}),t.isDirty){const a=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(_=>{_.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const h=[];this._sharedData.dynamicUniformBlocks.forEach(_=>{_.updateUniformsAndSamples(this._vertexCompilationState,this,t,h)});const c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(_=>{c.indexOf(_)===-1&&c.push(_)});const d=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(_=>{d.indexOf(_)===-1&&d.push(_)});const p=new Xe;this._sharedData.blocksWithFallbacks.forEach(_=>{_.provideFallbacks(e,p)}),s={lightDisposed:a,uniformBuffers:h,mergedUniforms:c,mergedSamplers:d,fallbacks:p}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const h=r.getFrameId();if(this._animationFrame!==h){for(const c of this._sharedData.animatedInputs)c.animate(r);this._animationFrame=h}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Q);const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if(this._prepareDefinesForAttributes(e,s),this._sharedData.blockingBlocks.some(h=>!h.isReady(e,this,s,i)))return!1;const a=this._processDefines(e,s,i,t);if(a){const h=t.effect,c=s.toString();let d=n.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:a.mergedUniforms,uniformBuffersNames:a.uniformBuffers,samplers:a.mergedSamplers,defines:c,fallbacks:a.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:s.NUM_MORPH_INFLUENCERS}},n);if(d)if(this._onEffectCreatedObservable&&(ue.effect=d,ue.subMesh=t,this._onEffectCreatedObservable.notifyObservers(ue)),this.allowShaderHotSwapping&&h&&!d.isReady()){if(d=h,s.markAsUnprocessed(),a.lightDisposed)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(d,s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return`// Vertex shader\r
${this._vertexCompilationState.compilationString}\r
\r
// Fragment shader\r
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(r,s,t.visibility),a=this._sharedData;if(n){for(const h of a.bindableBlocks)h.bind(s,this,t,i);for(const h of a.forcedBindableBlocks)h.bind(s,this,t,i);for(const h of a.inputBlocks)h._transmit(s,r,this)}else if(!this.isFrozen)for(const h of a.forcedBindableBlocks)h.bind(s,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)v._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const r of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))r.dispose();for(const r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t=Object.assign({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:v.EditorURL;H.LoadScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new E("Position");e.setAsAttribute("position");const t=new E("World");t.setAsSystemValue(g.World);const i=new me("WorldPos");e.connectTo(i),t.connectTo(i);const r=new E("ViewProjection");r.setAsSystemValue(g.ViewProjection);const s=new me("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);const n=new ee("VertexOutput");s.connectTo(n);const a=new E("color");a.value=new U(.8,.8,.8,1);const h=new $("FragmentOutput");a.connectTo(h),this.addOutputNode(n),this.addOutputNode(h),this._mode=O.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new E("Position");e.setAsAttribute("position2d");const t=new E("Constant1");t.isConstant=!0,t.value=1;const i=new te("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new ee("VertexOutput");i.connectTo(r);const s=new E("Scale");s.visibleInInspector=!0,s.value=new M(1,1);const n=new re("uv0");e.connectTo(n);const a=new pe("UV scale");n.connectTo(a),s.connectTo(a);const h=new Oe("CurrentScreen");a.connectTo(h),h.texture=new ie("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const c=new $("FragmentOutput");h.connectTo(c,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(c),this._mode=O.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new E("Position");e.setAsAttribute("position2d");const t=new E("Constant1");t.isConstant=!0,t.value=1;const i=new te("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new ee("VertexOutput");i.connectTo(r);const s=new E("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=k.Time,s.isConstant=!1;const n=new E("Color3");n.value=new ge(1,1,1),n.isConstant=!1;const a=new $("FragmentOutput"),h=new te("VectorMerger");h.visibleInInspector=!1;const c=new Ie("Cos");c.operation=x.Cos,e.connectTo(h),s.output.connectTo(c.input),c.output.connectTo(h.z),h.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=O.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new E("uv");e.setAsAttribute("particle_uv");const t=new De("ParticleTexture");e.connectTo(t);const i=new E("Color");i.setAsAttribute("particle_color");const r=new pe("Texture * Color");t.connectTo(r),i.connectTo(r);const s=new Te("ParticleRampGradient");r.connectTo(s);const n=new Ae("ColorSplitter");i.connectTo(n);const a=new Fe("ParticleBlendMultiply");s.connectTo(a),t.connectTo(a,{output:"a"}),n.connectTo(a,{output:"a"});const h=new $("FragmentOutput");a.connectTo(h),this.addOutputNode(h),this._mode=O.Particle}async loadAsync(e,t=""){return v.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const n of this._vertexOutputNodes)this._gatherBlocks(n,t);const r=[];for(const n of this._fragmentOutputNodes)this._gatherBlocks(n,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r
`;for(const n of t)n.isInput&&e.indexOf(n)===-1&&(s+=n._dumpCode(i,e));for(const n of r)n.isInput&&e.indexOf(n)===-1&&(s+=n._dumpCode(i,e));e=[],s+=`\r
// Connections\r
`;for(const n of this._vertexOutputNodes)s+=n._dumpCodeForOutputConnections(e);for(const n of this._fragmentOutputNodes)s+=n._dumpCodeForOutputConnections(e);s+=`\r
// Output nodes\r
`;for(const n of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${n._codeVariableName});\r
`;for(const n of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${n._codeVariableName});\r
`;return s+=`nodeMaterial.build();\r
`,s}serialize(e){const t=e?{}:j.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(const r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const n=i[s.id];if(n){for(const a of s.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){const h=n.getInputByName(a.inputName);if(!h||h.isConnected)continue;r.connectTo(h,!0),this._restoreConnections(n,t,i);continue}}}}parseSerializedObject(e,t="",i=!1){var r;i||this.clear();const s={};for(const n of e.blocks){const a=fe(n.customType);if(a){const h=new a;h._deserialize(n,this.getScene(),t),s[n.id]=h,this.attachedBlocks.push(h)}}for(let n=0;n<e.blocks.length;n++){const a=e.blocks[n],h=s[a.id];h&&(h.inputs.length&&!i||this._restoreConnections(h,e,s))}if(e.outputNodes)for(const n of e.outputNodes)this.addOutputNode(s[n]);if(e.locations||e.editorData&&e.editorData.locations){const n=e.locations||e.editorData.locations;for(const h of n)s[h.blockId]&&(h.blockId=s[h.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&n.concat(this.editorData.locations),e.locations?this.editorData={locations:n}:(this.editorData=e.editorData,this.editorData.locations=n);const a=[];for(const h in s)a[h]=s[h].uniqueId;this.editorData.map=a}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=(r=e.mode)!==null&&r!==void 0?r:O.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=j.Clone(()=>new v(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}static Parse(e,t,i=""){const r=j.Parse(()=>new v(e.name,t),e,t,i);return r.parseSerializedObject(e,i),r.build(),r}static async ParseFromFileAsync(e,t,i,r="",s=!1,n){const a=n??new v(e,i),h=await i._loadFileAsync(t),c=JSON.parse(h);return a.parseSerializedObject(c,r),s||a.build(),a}static ParseFromSnippetAsync(e,t=X.LastCreatedScene,i="",r,s=!1){return e==="_BLANK"?Promise.resolve(v.CreateDefault("blank",t)):new Promise((n,a)=>{const h=new Ge;h.addEventListener("readystatechange",()=>{if(h.readyState==4)if(h.status==200){const c=JSON.parse(JSON.parse(h.responseText).jsonPayload),d=JSON.parse(c.nodeMaterial);r||(r=j.Parse(()=>new v(e,t),d,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(d),r.snippetId=e;try{s||r.build(),n(r)}catch(p){a(p)}}else a("Unable to load the snippet "+e)}),h.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),h.send()})}static CreateDefault(e,t){const i=new v(e,t);return i.setToDefault(),i.build(),i}}v._BuildIdGenerator=0;v.EditorURL=`https://unpkg.com/babylonjs-node-editor@${Me.Version}/babylon.nodeEditor.js`;v.SnippetUrl="https://snippet.babylonjs.com";v.IgnoreTexturesAtLoadTime=!1;R([I()],v.prototype,"ignoreAlpha",void 0);R([I()],v.prototype,"maxSimultaneousLights",void 0);R([I("mode")],v.prototype,"_mode",void 0);R([I("comment")],v.prototype,"comment",void 0);R([I()],v.prototype,"forceAlphaBlending",void 0);V("BABYLON.NodeMaterial",v);class N{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Ze("shared gizmo light",new m(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=ge.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return N._DefaultUtilityLayer==null?N._CreateDefaultUtilityLayerFromScene(X.LastCreatedScene):N._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return N._DefaultUtilityLayer=new N(e),N._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{N._DefaultUtilityLayer=null}),N._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return N._DefaultKeepDepthUtilityLayer==null&&(N._DefaultKeepDepthUtilityLayer=new N(X.LastCreatedScene),N._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,N._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{N._DefaultKeepDepthUtilityLayer=null})),N._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new W,this.utilityLayerScene=new We(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(i=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&i.type!==T.POINTERMOVE&&i.type!==T.POINTERUP&&i.type!==T.POINTERDOWN&&i.type!==T.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const r=i.event;if(e.isPointerCaptured(r.pointerId)){this._pointerCaptures[r.pointerId]=!1;return}const s=a=>{let h=null;if(i.nearInteractionPickingInfo)i.nearInteractionPickingInfo.pickedMesh.getScene()==a?h=i.nearInteractionPickingInfo:h=new Ye;else if(a!==this.utilityLayerScene&&i.originalPickingInfo)h=i.originalPickingInfo;else{let c=null;this._renderCamera&&(c=a._activeCamera,a._activeCamera=this._renderCamera,i.ray=null),h=i.ray?a.pickWithRay(i.ray):a.pick(e.pointerX,e.pointerY),c&&(a._activeCamera=c)}return h},n=s(this.utilityLayerScene);if(!i.ray&&n&&(i.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(i),this.onlyCheckPointerDownEvents&&i.type!=T.POINTERDOWN){i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new le(i.type,i.event,n),i.type),i.type===T.POINTERUP&&this._pointerCaptures[r.pointerId]&&(this._pointerCaptures[r.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new le(i.type,i.event,n),i.type),i.skipOnPointerObservable=!0);else{const a=s(e),h=i.event;a&&n&&(n.distance===0&&a.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(a.pickedMesh)?(this._notifyObservers(i,a,h),i.skipOnPointerObservable=!0):i.type===T.POINTERDOWN?this._pointerCaptures[h.pointerId]=!0:(i.type===T.POINTERMOVE||i.type===T.POINTERUP)&&(this._lastPointerEvents[h.pointerId]&&(this.onPointerOutObservable.notifyObservers(h.pointerId),delete this._lastPointerEvents[h.pointerId]),this._notifyObservers(i,a,h)):!this._pointerCaptures[h.pointerId]&&(n.distance<a.distance||a.distance===0)?(this._notifyObservers(i,n,h),i.skipOnPointerObservable||(i.skipOnPointerObservable=n.distance>0)):!this._pointerCaptures[h.pointerId]&&n.distance>=a.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(a.pickedMesh)?(this._notifyObservers(i,a,h),i.skipOnPointerObservable=!0):((i.type===T.POINTERMOVE||i.type===T.POINTERUP)&&this._lastPointerEvents[h.pointerId]&&(this.onPointerOutObservable.notifyObservers(h.pointerId),delete this._lastPointerEvents[h.pointerId]),this._notifyObservers(i,n,h))),i.type===T.POINTERUP&&this._pointerCaptures[h.pointerId]&&(this._pointerCaptures[h.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(i=>{this.shouldRender&&i==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new le(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}N._DefaultUtilityLayer=null;N._DefaultKeepDepthUtilityLayer=null;export{k as A,B,Ae as C,x as D,ee as E,$ as F,xe as H,E as I,pe as M,q as N,P,re as R,Ce as S,me as T,N as U,te as V,S as W,A as a,D as b,u as c,l as d,g as e,K as f,z as g,Z as h,v as i,O as j,_e as k,G as l,st as m,be as n,Oe as o,Se as p,se as q,y as r,Q as s,Fe as t,Te as u,De as v,ve as w,je as x,ae as y,Ie as z};
