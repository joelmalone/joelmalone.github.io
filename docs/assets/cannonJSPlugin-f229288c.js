import{Q as S,V as N,L as P,ao as _,aa as w,h as A}from"./runBabylonPlaygroundScene-32a4afbd.js";import{P as u}from"./physicsImpostor-3dac248c.js";import{P as b,a as m,c as v}from"./physicsEngineComponent-f32049b7.js";var R=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function J(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}function F(f){if(f.__esModule)return f;var t=f.default;if(typeof t=="function"){var e=function o(){if(this instanceof o){var n=[null];n.push.apply(n,arguments);var i=Function.bind.apply(t,n);return new i}return t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(f).forEach(function(o){var n=Object.getOwnPropertyDescriptor(f,o);Object.defineProperty(e,o,n.get?n:{enumerable:!0,get:function(){return f[o]}})}),e}class C{constructor(t=!0,e=10,o=CANNON){if(this._useDeltaForWorldStep=t,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new S,this._minus90X=new S(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new S(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=N.Zero(),this._tmpDeltaPosition=N.Zero(),this._tmpUnityRotation=new S,this.BJSCANNON=o,!this.isSupported()){P.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=e,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new b}getPluginVersion(){return 1}setGravity(t){const e=t;this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(t){this._fixedTimeStep=t}getTimeStep(){return this._fixedTimeStep}executeStep(t,e){if(this._firstFrame){this._firstFrame=!1;for(const o of e)o.type==u.HeightmapImpostor||o.type===u.PlaneImpostor||o.beforeStep()}this.world.step(this._useDeltaForWorldStep?t:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(t=>{typeof this.world.removeBody=="function"?this.world.removeBody(t):this.world.remove(t)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(t,e,o){const n=new this.BJSCANNON.Vec3(o.x,o.y,o.z),i=new this.BJSCANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyImpulse(i,n)}applyForce(t,e,o){const n=new this.BJSCANNON.Vec3(o.x,o.y,o.z),i=new this.BJSCANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyForce(i,n)}generatePhysicsBody(t){if(this._removeMarkedPhysicsBodiesFromWorld(),t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){const e=this._createShape(t);if(!e){P.Warn("It was not possible to create a physics body for this object.");return}const o=t.physicsBody;o&&this.removePhysicsBody(t);const n=this._addMaterial("mat-"+t.uniqueId,t.getParam("friction"),t.getParam("restitution")),i={mass:t.getParam("mass"),material:n},s=t.getParam("nativeOptions");for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&(i[a]=s[a]);t.physicsBody=new this.BJSCANNON.Body(i),t.physicsBody.addEventListener("collide",t.onCollide),this.world.addEventListener("preStep",t.beforeStep),this.world.addEventListener("postStep",t.afterStep),t.physicsBody.addShape(e),typeof this.world.addBody=="function"?this.world.addBody(t.physicsBody):this.world.add(t.physicsBody),o&&["force","torque","velocity","angularVelocity"].forEach(function(a){const r=o[a];t.physicsBody[a].set(r.x,r.y,r.z)}),this._processChildMeshes(t)}this._updatePhysicsBodyTransformation(t)}_processChildMeshes(t){const e=t.object.getChildMeshes?t.object.getChildMeshes(!0):[],o=t.object.rotationQuaternion;if(o?o.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),e.length){const n=i=>{if(!i.rotationQuaternion)return;const s=i.getPhysicsImpostor();if(s&&s.parent!==t&&i.parent){const r=i.getAbsolutePosition().subtract(i.parent.getAbsolutePosition()),c=i.rotationQuaternion.multiply(this._tmpQuaternion);s.physicsBody&&(this.removePhysicsBody(s),s.physicsBody=null),s.parent=t,s.resetUpdateFlags(),t.physicsBody.addShape(this._createShape(s),new this.BJSCANNON.Vec3(r.x,r.y,r.z),new this.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w)),t.physicsBody.mass+=s.getParam("mass")}i.getChildMeshes(!0).filter(a=>!!a.physicsImpostor).forEach(n)};e.filter(i=>!!i.physicsImpostor).forEach(n)}}removePhysicsBody(t){t.physicsBody.removeEventListener("collide",t.onCollide),this.world.removeEventListener("preStep",t.beforeStep),this.world.removeEventListener("postStep",t.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(t.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(t.physicsBody)}generateJoint(t){const e=t.mainImpostor.physicsBody,o=t.connectedImpostor.physicsBody;if(!e||!o)return;let n;const i=t.joint.jointData,s={pivotA:i.mainPivot?new this.BJSCANNON.Vec3().set(i.mainPivot.x,i.mainPivot.y,i.mainPivot.z):null,pivotB:i.connectedPivot?new this.BJSCANNON.Vec3().set(i.connectedPivot.x,i.connectedPivot.y,i.connectedPivot.z):null,axisA:i.mainAxis?new this.BJSCANNON.Vec3().set(i.mainAxis.x,i.mainAxis.y,i.mainAxis.z):null,axisB:i.connectedAxis?new this.BJSCANNON.Vec3().set(i.connectedAxis.x,i.connectedAxis.y,i.connectedAxis.z):null,maxForce:i.nativeParams.maxForce,collideConnected:!!i.collision};switch(t.joint.type){case m.HingeJoint:case m.Hinge2Joint:n=new this.BJSCANNON.HingeConstraint(e,o,s);break;case m.DistanceJoint:n=new this.BJSCANNON.DistanceConstraint(e,o,i.maxDistance||2);break;case m.SpringJoint:{const a=i;n=new this.BJSCANNON.Spring(e,o,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:s.pivotA,localAnchorB:s.pivotB});break}case m.LockJoint:n=new this.BJSCANNON.LockConstraint(e,o,s);break;case m.PointToPointJoint:case m.BallAndSocketJoint:default:n=new this.BJSCANNON.PointToPointConstraint(e,s.pivotA,o,s.pivotB,s.maxForce);break}n.collideConnected=!!i.collision,t.joint.physicsJoint=n,t.joint.type!==m.SpringJoint?this.world.addConstraint(n):(t.joint.jointData.forceApplicationCallback=t.joint.jointData.forceApplicationCallback||function(){n.applyForce()},t.mainImpostor.registerAfterPhysicsStep(t.joint.jointData.forceApplicationCallback))}removeJoint(t){t.joint.type!==m.SpringJoint?this.world.removeConstraint(t.joint.physicsJoint):t.mainImpostor.unregisterAfterPhysicsStep(t.joint.jointData.forceApplicationCallback)}_addMaterial(t,e,o){let n,i;for(n=0;n<this._physicsMaterials.length;n++)if(i=this._physicsMaterials[n],i.friction===e&&i.restitution===o)return i;const s=new this.BJSCANNON.Material(t);return s.friction=e,s.restitution=o,this._physicsMaterials.push(s),s}_checkWithEpsilon(t){return t<_?_:t}_createShape(t){const e=t.object;let o;const n=t.getObjectExtents();switch(t.type){case u.SphereImpostor:{const i=n.x,s=n.y,a=n.z;o=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(i),this._checkWithEpsilon(s),this._checkWithEpsilon(a))/2);break}case u.CylinderImpostor:{let i=t.getParam("nativeOptions");i||(i={});const s=i.radiusTop!==void 0?i.radiusTop:this._checkWithEpsilon(n.x)/2,a=i.radiusBottom!==void 0?i.radiusBottom:this._checkWithEpsilon(n.x)/2,r=i.height!==void 0?i.height:this._checkWithEpsilon(n.y),c=i.numSegments!==void 0?i.numSegments:16;o=new this.BJSCANNON.Cylinder(s,a,r,c);const B=new this.BJSCANNON.Quaternion;B.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const p=new this.BJSCANNON.Vec3(0,0,0);o.transformAllPoints(p,B);break}case u.BoxImpostor:{const i=n.scale(.5);o=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(i.x),this._checkWithEpsilon(i.y),this._checkWithEpsilon(i.z)));break}case u.PlaneImpostor:P.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),o=new this.BJSCANNON.Plane;break;case u.MeshImpostor:{const i=e.getVerticesData?e.getVerticesData(w.PositionKind):[],s=e.getIndices?e.getIndices():[];if(!i){P.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}const a=e.position.clone(),r=e.rotation&&e.rotation.clone(),c=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace();const B=e.computeWorldMatrix(!0),p=new Array;let l;for(l=0;l<i.length;l+=3)N.TransformCoordinates(N.FromArray(i,l),B).toArray(p,l);P.Warn("MeshImpostor only collides against spheres."),o=new this.BJSCANNON.Trimesh(p,s),e.position.copyFrom(a),r&&e.rotation&&e.rotation.copyFrom(r),c&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(c);break}case u.HeightmapImpostor:{const i=e.position.clone(),s=e.rotation&&e.rotation.clone(),a=e.rotationQuaternion&&e.rotationQuaternion.clone();e.position.copyFromFloats(0,0,0),e.rotation&&e.rotation.copyFromFloats(0,0,0),e.rotationQuaternion&&e.rotationQuaternion.copyFrom(t.getParentsRotation()),e.rotationQuaternion&&e.parent&&e.rotationQuaternion.conjugateInPlace(),e.rotationQuaternion&&e.rotationQuaternion.multiplyInPlace(this._minus90X),o=this._createHeightmap(e),e.position.copyFrom(i),s&&e.rotation&&e.rotation.copyFrom(s),a&&e.rotationQuaternion&&e.rotationQuaternion.copyFrom(a),e.computeWorldMatrix(!0);break}case u.ParticleImpostor:o=new this.BJSCANNON.Particle;break;case u.NoImpostor:o=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return o}_createHeightmap(t,e){let o=t.getVerticesData(w.PositionKind);const n=t.computeWorldMatrix(!0),i=new Array;let s;for(s=0;s<o.length;s+=3)N.TransformCoordinates(N.FromArray(o,s),n).toArray(i,s);o=i;const a=new Array,r=e||~~(Math.sqrt(o.length/3)-1),c=t.getBoundingInfo(),B=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),p=c.boundingBox.extendSizeWorld.z,l=B*2/r;for(let d=0;d<o.length;d=d+3){const y=Math.round(o[d+0]/l+r/2),g=Math.round((o[d+1]/l-r/2)*-1),x=-o[d+2]+p;a[y]||(a[y]=[]),a[y][g]||(a[y][g]=x),a[y][g]=Math.max(x,a[y][g])}for(let d=0;d<=r;++d){if(!a[d]){let y=1;for(;!a[(d+y)%r];)y++;a[d]=a[(d+y)%r].slice()}for(let y=0;y<=r;++y)if(!a[d][y]){let g=1,x;for(;x===void 0;)x=a[d][(y+g++)%r];a[d][y]=x}}const h=new this.BJSCANNON.Heightfield(a,{elementSize:l});return h.minY=p,h}_updatePhysicsBodyTransformation(t){const e=t.object;if(e.computeWorldMatrix&&e.computeWorldMatrix(!0),!e.getBoundingInfo())return;const o=t.getObjectCenter();this._tmpDeltaPosition.copyFrom(e.getAbsolutePivotPoint().subtract(o)),this._tmpDeltaPosition.divideInPlace(t.object.scaling),this._tmpPosition.copyFrom(o);let n=e.rotationQuaternion;if(n){if((t.type===u.PlaneImpostor||t.type===u.HeightmapImpostor)&&(n=n.multiply(this._minus90X),t.setDeltaRotation(this._plus90X)),t.type===u.HeightmapImpostor){const i=e;let s=i.getBoundingInfo();const a=i.rotationQuaternion;i.rotationQuaternion=this._tmpUnityRotation,i.computeWorldMatrix(!0);const r=o.clone();let c=i.getPivotMatrix();c?c=c.clone():c=A.Identity();const B=A.Translation(s.boundingBox.extendSizeWorld.x,0,-s.boundingBox.extendSizeWorld.z);i.setPreTransformMatrix(B),i.computeWorldMatrix(!0),s=i.getBoundingInfo();const p=s.boundingBox.centerWorld.subtract(o).subtract(i.position).negate();this._tmpPosition.copyFromFloats(p.x,p.y-s.boundingBox.extendSizeWorld.y,p.z),this._tmpDeltaPosition.copyFrom(s.boundingBox.centerWorld.subtract(r)),this._tmpDeltaPosition.y+=s.boundingBox.extendSizeWorld.y,i.rotationQuaternion=a,i.setPreTransformMatrix(c),i.computeWorldMatrix(!0)}else t.type===u.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);t.setDeltaPosition(this._tmpDeltaPosition),t.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),t.physicsBody.quaternion.set(n.x,n.y,n.z,n.w)}}setTransformationFromPhysicsBody(t){if(t.object.position.set(t.physicsBody.position.x,t.physicsBody.position.y,t.physicsBody.position.z),t.object.rotationQuaternion){const e=t.physicsBody.quaternion;t.object.rotationQuaternion.set(e.x,e.y,e.z,e.w)}}setPhysicsBodyTransformation(t,e,o){t.physicsBody.position.set(e.x,e.y,e.z),t.physicsBody.quaternion.set(o.x,o.y,o.z,o.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(t,e){t.physicsBody.velocity.set(e.x,e.y,e.z)}setAngularVelocity(t,e){t.physicsBody.angularVelocity.set(e.x,e.y,e.z)}getLinearVelocity(t){const e=t.physicsBody.velocity;return e?new N(e.x,e.y,e.z):null}getAngularVelocity(t){const e=t.physicsBody.angularVelocity;return e?new N(e.x,e.y,e.z):null}setBodyMass(t,e){t.physicsBody.mass=e,t.physicsBody.updateMassProperties()}getBodyMass(t){return t.physicsBody.mass}getBodyFriction(t){return t.physicsBody.material.friction}setBodyFriction(t,e){t.physicsBody.material.friction=e}getBodyRestitution(t){return t.physicsBody.material.restitution}setBodyRestitution(t,e){t.physicsBody.material.restitution=e}sleepBody(t){t.physicsBody.sleep()}wakeUpBody(t){t.physicsBody.wakeUp()}updateDistanceJoint(t,e){t.physicsJoint.distance=e}setMotor(t,e,o,n){n||(t.physicsJoint.enableMotor(),t.physicsJoint.setMotorSpeed(e),o&&this.setLimit(t,o))}setLimit(t,e,o){t.physicsJoint.motorEquation.maxForce=o,t.physicsJoint.motorEquation.minForce=e===void 0?-e:e}syncMeshWithImpostor(t,e){const o=e.physicsBody;t.position.x=o.position.x,t.position.y=o.position.y,t.position.z=o.position.z,t.rotationQuaternion&&(t.rotationQuaternion.x=o.quaternion.x,t.rotationQuaternion.y=o.quaternion.y,t.rotationQuaternion.z=o.quaternion.z,t.rotationQuaternion.w=o.quaternion.w)}getRadius(t){return t.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(t,e){const o=t.physicsBody.shapes[0];e.x=o.halfExtents.x*2,e.y=o.halfExtents.y*2,e.z=o.halfExtents.z*2}dispose(){}_extendNamespace(){const t=new this.BJSCANNON.Vec3,e=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(o,n,i){if(i=i||10,n=n||0,n===0)this.internalStep(o),this.time+=o;else{let s=Math.floor((this.time+n)/o)-Math.floor(this.time/o);s=Math.min(s,i)||1;const a=performance.now();for(let l=0;l!==s&&(this.internalStep(o),!(performance.now()-a>o*1e3));l++);this.time+=n;const c=this.time%o/o,B=t,p=this.bodies;for(let l=0;l!==p.length;l++){const h=p[l];h.type!==e.Body.STATIC&&h.sleepState!==e.Body.SLEEPING?(h.position.vsub(h.previousPosition,B),B.scale(c,B),h.position.vadd(B,h.interpolatedPosition)):(h.interpolatedPosition.set(h.position.x,h.position.y,h.position.z),h.interpolatedQuaternion.set(h.quaternion.x,h.quaternion.y,h.quaternion.z,h.quaternion.w))}}}}raycast(t,e){return this._raycastResult.reset(t,e),this.raycastToRef(t,e,this._raycastResult),this._raycastResult}raycastToRef(t,e,o){this._cannonRaycastResult.reset(),this.world.raycastClosest(t,e,{},this._cannonRaycastResult),o.reset(t,e),this._cannonRaycastResult.hasHit&&(o.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),o.setHitDistance(this._cannonRaycastResult.distance))}}v.DefaultPluginFactory=()=>new C;export{C,F as a,R as c,J as g};
