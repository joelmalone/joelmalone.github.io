var Vn=Object.defineProperty,kn=Object.defineProperties;var Hn=Object.getOwnPropertyDescriptors;var An=Object.getOwnPropertySymbols;var Kn=Object.prototype.hasOwnProperty,Wn=Object.prototype.propertyIsEnumerable;var yn=(t,e,n)=>e in t?Vn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,mn=(t,e)=>{for(var n in e||(e={}))Kn.call(e,n)&&yn(t,n,e[n]);if(An)for(var n of An(e))Wn.call(e,n)&&yn(t,n,e[n]);return t},gn=(t,e)=>kn(t,Hn(e));import{T as M,L as K,O as U,D as be,a as jn,S as re,b as En,R as qn,c as Xn,d as Ce,M as W,e as Jn,V as S,f as zn,g as P,h as le,i as Tn,C as Yn,j as Zn,k as we,l as Le,m as x,n as Y,o as ue,Q as j,p as Q,H as Ne,q as ge,P as Me,r as xe,F as Pe,s as On,t as fe,B as _e,u as $n,v as Qn,G as Ie,w as er,x as w,_ as Sn,y as bn,z as nr,I as rr,J as tr,K as or,N as D,U as pe,W as ar,X as sr,Y as Z,Z as ir,$ as cr,a0 as lr,a1 as ur,a2 as fr,a3 as dr,a4 as hr,a5 as Cn,a6 as _r,a7 as Ee,a8 as pr,a9 as vr,aa as Ar,ab as yr,ac as mr,ad as gr,ae as Er,af as Tr,ag as Re,ah as wn}from"./vendor.a8b3d448.js";function Fe(t,e,n,r){var o={externalResourceFunction:function(a){return r(a).then(function(s){return new Uint8Array(s)})}};return n&&(o.uri=e==="file:"?n:e+n),t instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(t),o):GLTFValidator.validateString(t,o)}function Or(){var t=[];onmessage=function(e){var n=e.data;switch(n.id){case"init":{importScripts(n.url);break}case"validate":{Fe(n.data,n.rootUrl,n.fileName,function(r){return new Promise(function(o,a){var s=t.length;t.push({resolve:o,reject:a}),postMessage({id:"getExternalResource",index:s,uri:r})})}).then(function(r){postMessage({id:"validate.resolve",value:r})},function(r){postMessage({id:"validate.reject",reason:r})});break}case"getExternalResource.resolve":{t[n.index].resolve(n.value);break}case"getExternalResource.reject":{t[n.index].reject(n.reason);break}}}}var Sr=function(){function t(){}return t.ValidateAsync=function(e,n,r,o){var a=this;return typeof Worker=="function"?new Promise(function(s,i){var c="".concat(Fe,"(").concat(Or,")()"),u=URL.createObjectURL(new Blob([c],{type:"application/javascript"})),l=new Worker(u),f=function(h){l.removeEventListener("error",f),l.removeEventListener("message",d),i(h)},d=function(h){var _=h.data;switch(_.id){case"getExternalResource":{o(_.uri).then(function(p){l.postMessage({id:"getExternalResource.resolve",index:_.index,value:p},[p])},function(p){l.postMessage({id:"getExternalResource.reject",index:_.index,reason:p})});break}case"validate.resolve":{l.removeEventListener("error",f),l.removeEventListener("message",d),s(_.value);break}case"validate.reject":l.removeEventListener("error",f),l.removeEventListener("message",d),i(_.reason)}};l.addEventListener("error",f),l.addEventListener("message",d),l.postMessage({id:"init",url:a.Configuration.url}),l.postMessage({id:"validate",data:e,rootUrl:n,fileName:r})}):(this._LoadScriptPromise||(this._LoadScriptPromise=M.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(function(){return Fe(e,n,r,o)}))},t.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},t}();function Ln(t,e,n){try{return Promise.resolve(new Uint8Array(t,e,n))}catch(r){return Promise.reject(r)}}var ve;(function(t){t[t.AUTO=0]="AUTO",t[t.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(ve||(ve={}));var de;(function(t){t[t.NONE=0]="NONE",t[t.FIRST=1]="FIRST",t[t.ALL=2]="ALL"})(de||(de={}));var J;(function(t){t[t.LOADING=0]="LOADING",t[t.READY=1]="READY",t[t.COMPLETE=2]="COMPLETE"})(J||(J={}));var ae=function(){function t(){this.onParsedObservable=new U,this.coordinateSystemMode=ve.AUTO,this.animationStartMode=de.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable=new U,this.onTextureLoadedObservable=new U,this.onMaterialLoadedObservable=new U,this.onCameraLoadedObservable=new U,this.onCompleteObservable=new U,this.onErrorObservable=new U,this.onDisposeObservable=new U,this.onExtensionLoadedObservable=new U,this.validate=!1,this.onValidatedObservable=new U,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new U,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(t.prototype,"onParsed",{set:function(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMeshLoaded",{set:function(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTextureLoaded",{set:function(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMaterialLoaded",{set:function(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onCameraLoaded",{set:function(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onComplete",{set:function(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onError",{set:function(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onExtensionLoaded",{set:function(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onValidated",{set:function(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null);for(var e=0,n=this._requests;e<n.length;e++){var r=n[e];r.abort()}this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=function(o){return Promise.resolve(o)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},t.prototype.loadFile=function(e,n,r,o,a,s){var i=this;this._progressCallback=o;var c=n.name?"file:":M.GetFolderPath(n),u=n.name||M.GetFilename(n);if(a){if(this.useRangeRequests){this.validate&&K.Warn("glTF validation is not supported when range requests are enabled");var l={abort:function(){},onCompleteObservable:new U},f={readAsync:function(d,h){return new Promise(function(_,p){i._loadFile(e,n,function(v){_(new Uint8Array(v))},!0,function(v){p(v)},function(v){v.setRequestHeader("Range","bytes=".concat(d,"-").concat(d+h-1))})})},byteLength:0};return this._unpackBinaryAsync(new be(f)).then(function(d){l.onCompleteObservable.notifyObservers(l),r(d)},s?function(d){return s(void 0,d)}:void 0),l}return this._loadFile(e,n,function(d){i._validate(e,d,c,u),i._unpackBinaryAsync(new be({readAsync:function(h,_){return Ln(d,h,_)},byteLength:d.byteLength})).then(function(h){r(h)},s?function(h){return s(void 0,h)}:void 0)},!0,s)}return this._loadFile(e,n,function(d){i._validate(e,d,c,u),r({json:i._parseJson(d)})},a,s)},t.prototype.importMeshAsync=function(e,n,r,o,a,s){var i=this;return Promise.resolve().then(function(){return i.onParsedObservable.notifyObservers(r),i.onParsedObservable.clear(),i._log("Loading ".concat(s||"")),i._loader=i._getLoader(r),i._loader.importMeshAsync(e,n,null,r,o,a,s)})},t.prototype.loadAsync=function(e,n,r,o,a){var s=this;return Promise.resolve().then(function(){return s.onParsedObservable.notifyObservers(n),s.onParsedObservable.clear(),s._log("Loading ".concat(a||"")),s._loader=s._getLoader(n),s._loader.loadAsync(e,n,r,o,a)})},t.prototype.loadAssetContainerAsync=function(e,n,r,o,a){var s=this;return Promise.resolve().then(function(){s.onParsedObservable.notifyObservers(n),s.onParsedObservable.clear(),s._log("Loading ".concat(a||"")),s._loader=s._getLoader(n);var i=new jn(e),c=[];s.onMaterialLoadedObservable.add(function(f){c.push(f)});var u=[];s.onTextureLoadedObservable.add(function(f){u.push(f)});var l=[];return s.onCameraLoadedObservable.add(function(f){l.push(f)}),s._loader.importMeshAsync(null,e,i,n,r,o,a).then(function(f){return Array.prototype.push.apply(i.geometries,f.geometries),Array.prototype.push.apply(i.meshes,f.meshes),Array.prototype.push.apply(i.particleSystems,f.particleSystems),Array.prototype.push.apply(i.skeletons,f.skeletons),Array.prototype.push.apply(i.animationGroups,f.animationGroups),Array.prototype.push.apply(i.materials,c),Array.prototype.push.apply(i.textures,u),Array.prototype.push.apply(i.lights,f.lights),Array.prototype.push.apply(i.transformNodes,f.transformNodes),Array.prototype.push.apply(i.cameras,l),i})})},t.prototype.canDirectLoad=function(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||re.StartsWith(e,"data:base64,"+t.magicBase64Encoded)||re.StartsWith(e,"data:;base64,"+t.magicBase64Encoded)||re.StartsWith(e,"data:application/octet-stream;base64,"+t.magicBase64Encoded)||re.StartsWith(e,"data:model/gltf-binary;base64,"+t.magicBase64Encoded)},t.prototype.directLoad=function(e,n){if(re.StartsWith(n,"base64,"+t.magicBase64Encoded)||re.StartsWith(n,";base64,"+t.magicBase64Encoded)||re.StartsWith(n,"application/octet-stream;base64,"+t.magicBase64Encoded)||re.StartsWith(n,"model/gltf-binary;base64,"+t.magicBase64Encoded)){var r=En(n);return this._validate(e,r),this._unpackBinaryAsync(new be({readAsync:function(o,a){return Ln(r,o,a)},byteLength:r.byteLength}))}return this._validate(e,n),Promise.resolve({json:this._parseJson(n)})},t.prototype.createPlugin=function(){return new t},Object.defineProperty(t.prototype,"loaderState",{get:function(){return this._state},enumerable:!1,configurable:!0}),t.prototype.whenCompleteAsync=function(){var e=this;return new Promise(function(n,r){e.onCompleteObservable.addOnce(function(){n()}),e.onErrorObservable.addOnce(function(o){r(o)})})},t.prototype._setState=function(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(J[this._state]))},t.prototype._loadFile=function(e,n,r,o,a,s){var i=this,c=e._loadFile(n,r,function(u){i._onProgress(u,c)},!0,o,a,s);return c.onCompleteObservable.add(function(u){i._requests.splice(i._requests.indexOf(u),1)}),this._requests.push(c),c},t.prototype._onProgress=function(e,n){if(!!this._progressCallback){n._lengthComputable=e.lengthComputable,n._loaded=e.loaded,n._total=e.total;for(var r=!0,o=0,a=0,s=0,i=this._requests;s<i.length;s++){var c=i[s];if(c._lengthComputable===void 0||c._loaded===void 0||c._total===void 0)return;r=r&&c._lengthComputable,o+=c._loaded,a+=c._total}this._progressCallback({lengthComputable:r,loaded:o,total:r?a:0})}},t.prototype._validate=function(e,n,r,o){var a=this;r===void 0&&(r=""),o===void 0&&(o=""),!!this.validate&&(this._startPerformanceCounter("Validate JSON"),Sr.ValidateAsync(n,r,o,function(s){return a.preprocessUrlAsync(r+s).then(function(i){return e._loadFileAsync(i,void 0,!0,!0)})}).then(function(s){a._endPerformanceCounter("Validate JSON"),a.onValidatedObservable.notifyObservers(s),a.onValidatedObservable.clear()},function(s){a._endPerformanceCounter("Validate JSON"),M.Warn("Failed to validate: ".concat(s.message)),a.onValidatedObservable.clear()}))},t.prototype._getLoader=function(e){var n=e.json.asset||{};this._log("Asset version: ".concat(n.version)),n.minVersion&&this._log("Asset minimum version: ".concat(n.minVersion)),n.generator&&this._log("Asset generator: ".concat(n.generator));var r=t._parseVersion(n.version);if(!r)throw new Error("Invalid version: "+n.version);if(n.minVersion!==void 0){var o=t._parseVersion(n.minVersion);if(!o)throw new Error("Invalid minimum version: "+n.minVersion);if(t._compareVersion(o,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+n.minVersion)}var a={1:t._CreateGLTF1Loader,2:t._CreateGLTF2Loader},s=a[r.major];if(!s)throw new Error("Unsupported version: "+n.version);return s(this)},t.prototype._parseJson=function(e){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: ".concat(e.length));var n=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),n},t.prototype._unpackBinaryAsync=function(e){var n=this;return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(function(){var r={Magic:1179937895},o=e.readUint32();if(o!==r.Magic)throw new qn("Unexpected magic: "+o,Xn.GLTFLoaderUnexpectedMagicError);var a=e.readUint32();n.loggingEnabled&&n._log("Binary version: ".concat(a));var s=e.readUint32();if(e.buffer.byteLength!==0&&s!==e.buffer.byteLength)throw new Error("Length in header does not match actual data length: ".concat(s," != ").concat(e.buffer.byteLength));var i;switch(a){case 1:{i=n._unpackBinaryV1Async(e,s);break}case 2:{i=n._unpackBinaryV2Async(e,s);break}default:throw new Error("Unsupported version: "+a)}return n._endPerformanceCounter("Unpack Binary"),i})},t.prototype._unpackBinaryV1Async=function(e,n){var r={JSON:0},o=e.readUint32(),a=e.readUint32();if(a!==r.JSON)throw new Error("Unexpected content format: ".concat(a));var s=n-e.byteOffset,i={json:this._parseJson(e.readString(o)),bin:null};if(s!==0){var c=e.byteOffset;i.bin={readAsync:function(u,l){return e.buffer.readAsync(c+u,l)},byteLength:s}}return Promise.resolve(i)},t.prototype._unpackBinaryV2Async=function(e,n){var r=this,o={JSON:1313821514,BIN:5130562},a=e.readUint32(),s=e.readUint32();if(s!==o.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+a===n?e.loadAsync(a).then(function(){return{json:r._parseJson(e.readString(a)),bin:null}}):e.loadAsync(a+8).then(function(){var i={json:r._parseJson(e.readString(a)),bin:null},c=function(){var u=e.readUint32(),l=e.readUint32();switch(l){case o.JSON:throw new Error("Unexpected JSON chunk");case o.BIN:{var f=e.byteOffset;i.bin={readAsync:function(d,h){return e.buffer.readAsync(f+d,h)},byteLength:u},e.skipBytes(u);break}default:{e.skipBytes(u);break}}return e.byteOffset!==n?e.loadAsync(8).then(c):Promise.resolve(i)};return c()})},t._parseVersion=function(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};var n=(e+"").match(/^(\d+)\.(\d+)/);return n?{major:parseInt(n[1]),minor:parseInt(n[2])}:null},t._compareVersion=function(e,n){return e.major>n.major?1:e.major<n.major?-1:e.minor>n.minor?1:e.minor<n.minor?-1:0},t.prototype._logOpen=function(e){this._log(e),this._logIndentLevel++},t.prototype._logClose=function(){--this._logIndentLevel},t.prototype._logEnabled=function(e){var n=t._logSpaces.substr(0,this._logIndentLevel*2);K.Log("".concat(n).concat(e))},t.prototype._logDisabled=function(e){},t.prototype._startPerformanceCounterEnabled=function(e){M.StartPerformanceCounter(e)},t.prototype._startPerformanceCounterDisabled=function(e){},t.prototype._endPerformanceCounterEnabled=function(e){M.EndPerformanceCounter(e)},t.prototype._endPerformanceCounterDisabled=function(e){},t.IncrementalLoading=!0,t.HomogeneousCoordinates=!1,t.magicBase64Encoded="Z2xURg",t._logSpaces="                                ",t}();Ce&&Ce.RegisterPlugin(new ae);var se;(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.FLOAT=5126]="FLOAT"})(se||(se={}));var Be;(function(t){t[t.FRAGMENT=35632]="FRAGMENT",t[t.VERTEX=35633]="VERTEX"})(Be||(Be={}));var q;(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D"})(q||(q={}));var Ae;(function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.REPEAT=10497]="REPEAT"})(Ae||(Ae={}));var ee;(function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9728]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ee||(ee={}));var Nn;(function(t){t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Nn||(Nn={}));var De;(function(t){t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(De||(De={}));var R;(function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(R||(R={}));var z=function(){function t(){}return t.SetMatrix=function(e,n,r,o,a){var s=null;if(r.semantic==="MODEL")s=n.getWorldMatrix();else if(r.semantic==="PROJECTION")s=e.getProjectionMatrix();else if(r.semantic==="VIEW")s=e.getViewMatrix();else if(r.semantic==="MODELVIEWINVERSETRANSPOSE")s=W.Transpose(n.getWorldMatrix().multiply(e.getViewMatrix()).invert());else if(r.semantic==="MODELVIEW")s=n.getWorldMatrix().multiply(e.getViewMatrix());else if(r.semantic==="MODELVIEWPROJECTION")s=n.getWorldMatrix().multiply(e.getTransformMatrix());else if(r.semantic==="MODELINVERSE")s=n.getWorldMatrix().invert();else if(r.semantic==="VIEWINVERSE")s=e.getViewMatrix().invert();else if(r.semantic==="PROJECTIONINVERSE")s=e.getProjectionMatrix().invert();else if(r.semantic==="MODELVIEWINVERSE")s=n.getWorldMatrix().multiply(e.getViewMatrix()).invert();else if(r.semantic==="MODELVIEWPROJECTIONINVERSE")s=n.getWorldMatrix().multiply(e.getTransformMatrix()).invert();else if(r.semantic==="MODELINVERSETRANSPOSE")s=W.Transpose(n.getWorldMatrix().invert());else debugger;if(s)switch(r.type){case q.FLOAT_MAT2:a.setMatrix2x2(o,W.GetAsMatrix2x2(s));break;case q.FLOAT_MAT3:a.setMatrix3x3(o,W.GetAsMatrix3x3(s));break;case q.FLOAT_MAT4:a.setMatrix(o,s);break}},t.SetUniform=function(e,n,r,o){switch(o){case q.FLOAT:return e.setFloat(n,r),!0;case q.FLOAT_VEC2:return e.setVector2(n,zn.FromArray(r)),!0;case q.FLOAT_VEC3:return e.setVector3(n,S.FromArray(r)),!0;case q.FLOAT_VEC4:return e.setVector4(n,Jn.FromArray(r)),!0;default:return!1}},t.GetWrapMode=function(e){switch(e){case Ae.CLAMP_TO_EDGE:return P.CLAMP_ADDRESSMODE;case Ae.MIRRORED_REPEAT:return P.MIRROR_ADDRESSMODE;case Ae.REPEAT:return P.WRAP_ADDRESSMODE;default:return P.WRAP_ADDRESSMODE}},t.GetByteStrideFromType=function(e){var n=e.type;switch(n){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},t.GetTextureFilterMode=function(e){switch(e){case ee.LINEAR:case ee.LINEAR_MIPMAP_NEAREST:case ee.LINEAR_MIPMAP_LINEAR:return P.TRILINEAR_SAMPLINGMODE;case ee.NEAREST:case ee.NEAREST_MIPMAP_NEAREST:return P.NEAREST_SAMPLINGMODE;default:return P.BILINEAR_SAMPLINGMODE}},t.GetBufferFromBufferView=function(e,n,r,o,a){var r=n.byteOffset+r,s=e.loadedBufferViews[n.buffer];if(r+o>s.byteLength)throw new Error("Buffer access is out of range");var i=s.buffer;switch(r+=s.byteOffset,a){case se.BYTE:return new Int8Array(i,r,o);case se.UNSIGNED_BYTE:return new Uint8Array(i,r,o);case se.SHORT:return new Int16Array(i,r,o);case se.UNSIGNED_SHORT:return new Uint16Array(i,r,o);default:return new Float32Array(i,r,o)}},t.GetBufferFromAccessor=function(e,n){var r=e.bufferViews[n.bufferView],o=n.count*t.GetByteStrideFromType(n);return t.GetBufferFromBufferView(e,r,n.byteOffset,o,n.componentType)},t.DecodeBufferToText=function(e){for(var n="",r=e.byteLength,o=0;o<r;++o)n+=String.fromCharCode(e[o]);return n},t.GetDefaultMaterial=function(e){if(!t._DefaultMaterial){le.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),le.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);var n={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},r={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};t._DefaultMaterial=new Tn("GLTFDefaultMaterial",e,n,r),t._DefaultMaterial.setColor4("u_emission",new Yn(.5,.5,.5,1))}return t._DefaultMaterial},t._DefaultMaterial=null,t}(),ie;(function(t){t[t.IDENTIFIER=1]="IDENTIFIER",t[t.UNKNOWN=2]="UNKNOWN",t[t.END_OF_INPUT=3]="END_OF_INPUT"})(ie||(ie={}));var Mn=function(){function t(e){this._pos=0,this.currentToken=ie.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}return t.prototype.getNextToken=function(){if(this.isEnd())return ie.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=ie.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=ie.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},t.prototype.peek=function(){return this._toParse[this._pos]},t.prototype.read=function(){return this._toParse[this._pos++]},t.prototype.forward=function(){this._pos++},t.prototype.isEnd=function(){return this._pos>=this._maxPos},t}(),xn=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],Pn=["world","view","projection","worldView","worldViewProjection","mBones"],br=["translation","rotation","scale"],Cr=["position","rotationQuaternion","scaling"],wr=function(t,e){for(var n in t){var r=t[n];e.buffers[n]=r,e.buffersCount++}},Lr=function(t,e){for(var n in t){var r=t[n];e.shaders[n]=r,e.shaderscount++}},V=function(t,e,n){for(var r in t){var o=t[r];n[e][r]=o}},Nr=function(t){if(!!t)for(var e=0;e<t.length/2;e++)t[e*2+1]=1-t[e*2+1]},In=function(t){if(t.semantic==="NORMAL")return"normal";if(t.semantic==="POSITION")return"position";if(t.semantic==="JOINT")return"matricesIndices";if(t.semantic==="WEIGHT")return"matricesWeights";if(t.semantic==="COLOR")return"color";if(t.semantic&&t.semantic.indexOf("TEXCOORD_")!==-1){var e=Number(t.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Mr=function(t){for(var e in t.animations){var n=t.animations[e];if(!(!n.channels||!n.samplers))for(var r=null,o=0;o<n.channels.length;o++){var a=n.channels[o],s=n.samplers[a.sampler];if(!!s){var i=null,c=null;n.parameters?(i=n.parameters[s.input],c=n.parameters[s.output]):(i=s.input,c=s.output);var u=z.GetBufferFromAccessor(t,t.accessors[i]),l=z.GetBufferFromAccessor(t,t.accessors[c]),f=a.target.id,d=t.scene.getNodeById(f);if(d===null&&(d=t.scene.getNodeByName(f)),d===null){M.Warn("Creating animation named "+e+". But cannot find node named "+f+" to attach to");continue}var h=d instanceof _e,_=a.target.path,p=br.indexOf(_);p!==-1&&(_=Cr[p]);var v=Q.ANIMATIONTYPE_MATRIX;h||(_==="rotationQuaternion"?(v=Q.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new j):v=Q.ANIMATIONTYPE_VECTOR3);var m=null,O=[],A=0,T=!1;h&&r&&r.getKeys().length===u.length&&(m=r,T=!0),T||(t.scene._blockEntityCollection=!!t.assetContainer,m=new Q(e,h?"_matrix":_,1,v,Q.ANIMATIONLOOPMODE_CYCLE),t.scene._blockEntityCollection=!1);for(var b=0;b<u.length;b++){var C=null;if(_==="rotationQuaternion"?(C=j.FromArray([l[A],l[A+1],l[A+2],l[A+3]]),A+=4):(C=S.FromArray([l[A],l[A+1],l[A+2]]),A+=3),h){var L=d,N=S.Zero(),F=new j,E=S.Zero(),G=L.getBaseMatrix();T&&r&&(G=r.getKeys()[b].value),G.decompose(E,F,N),_==="position"?N=C:_==="rotationQuaternion"?F=C:E=C,C=W.Compose(E,F,N)}T?r&&(r.getKeys()[b].value=C):O.push({frame:u[b],value:C})}!T&&m&&(m.setKeys(O),d.animations.push(m)),r=m,t.scene.stopAnimation(d),t.scene.beginAnimation(d,0,u[u.length-1],!0,1)}}}},Ge=function(t){var e=null;if(t.translation||t.rotation||t.scale){var n=S.FromArray(t.scale||[1,1,1]),r=j.FromArray(t.rotation||[0,0,0,1]),o=S.FromArray(t.translation||[0,0,0]);e=W.Compose(n,r,o)}else e=W.FromArray(t.matrix);return e},Rn=function(t,e,n,r){for(var o=0;o<r.bones.length;o++)if(r.bones[o].name===n)return r.bones[o];var a=t.nodes;for(var s in a){var i=a[s];if(!!i.jointName)for(var c=i.children,o=0;o<c.length;o++){var u=t.nodes[c[o]];if(!!u.jointName&&u.jointName===n){var l=Ge(i),f=new _e(i.name||"",r,Rn(t,e,i.jointName,r),l);return f.id=s,f}}}return null},xr=function(t,e){for(var n=0;n<t.length;n++)for(var r=t[n],o=0;o<r.node.children.length;o++){var a=r.node.children[o];if(a===e)return r.bone}return null},Ue=function(t,e){var n=t.nodes,r=n[e];if(r)return{node:r,id:e};for(var o in n)if(r=n[o],r.jointName===e)return{node:r,id:o};return null},Pr=function(t,e){for(var n=0;n<t.jointNames.length;n++)if(t.jointNames[n]===e)return!0;return!1},Ir=function(t,e,n,r){for(var o in t.nodes){var a=t.nodes[o],s=o;if(!(!a.jointName||Pr(n,a.jointName))){var i=Ge(a),c=new _e(a.name||"",e,null,i);c.id=s,r.push({bone:c,node:a,id:s})}}for(var u=0;u<r.length;u++)for(var l=r[u],f=l.node.children,d=0;d<f.length;d++){for(var h=null,_=0;_<r.length;_++)if(r[_].id===f[d]){h=r[_];break}h&&(h.bone._parent=l.bone,l.bone.children.push(h.bone))}},Rr=function(t,e,n,r,o){if(r||(r=new we(e.name||"","",t.scene)),!e.babylonSkeleton)return r;var a=[],s=[];Ir(t,r,e,a),r.bones=[];for(var i=0;i<e.jointNames.length;i++){var c=Ue(t,e.jointNames[i]);if(!!c){var u=c.node;if(!u){M.Warn("Joint named "+e.jointNames[i]+" does not exist");continue}var o=c.id,l=t.scene.getBoneById(o);if(l){r.bones.push(l);continue}for(var f=!1,d=null,h=0;h<i;h++){var _=Ue(t,e.jointNames[h]);if(!!_){var p=_.node;if(!p){M.Warn("Joint named "+e.jointNames[h]+" does not exist when looking for parent");continue}var v=p.children;if(!!v){f=!1;for(var m=0;m<v.length;m++)if(v[m]===o){d=Rn(t,e,e.jointNames[h],r),f=!0;break}if(f)break}}}var O=Ge(u);!d&&a.length>0&&(d=xr(a,o),d&&s.indexOf(d)===-1&&s.push(d));var A=new _e(u.jointName||"",r,d,O);A.id=o}}var T=r.bones;r.bones=[];for(var i=0;i<e.jointNames.length;i++){var c=Ue(t,e.jointNames[i]);if(!!c){for(var h=0;h<T.length;h++)if(T[h].id===c.id){r.bones.push(T[h]);break}}}r.prepare();for(var i=0;i<s.length;i++)r.bones.push(s[i]);return r},Fn=function(t,e,n,r,o){if(o||(t.scene._blockEntityCollection=!!t.assetContainer,o=new fe(e.name||"",t.scene),o._parentContainer=t.assetContainer,t.scene._blockEntityCollection=!1,o.id=r),!e.babylonNode)return o;for(var a=[],s=null,i=new Array,c=new Array,u=new Array,l=new Array,f=0;f<n.length;f++){var d=n[f],h=t.meshes[d];if(!!h)for(var _=0;_<h.primitives.length;_++){var p=new $n,v=h.primitives[_];v.mode!==4;var m=v.attributes,O=null,A=null;for(var T in m)if(O=t.accessors[m[T]],A=z.GetBufferFromAccessor(t,O),T==="NORMAL")p.normals=new Float32Array(A.length),p.normals.set(A);else if(T==="POSITION"){if(ae.HomogeneousCoordinates){p.positions=new Float32Array(A.length-A.length/4);for(var b=0;b<A.length;b+=4)p.positions[b]=A[b],p.positions[b+1]=A[b+1],p.positions[b+2]=A[b+2]}else p.positions=new Float32Array(A.length),p.positions.set(A);c.push(p.positions.length)}else if(T.indexOf("TEXCOORD_")!==-1){var C=Number(T.split("_")[1]),L=w.UVKind+(C===0?"":C+1),N=new Float32Array(A.length);N.set(A),Nr(N),p.set(N,L)}else T==="JOINT"?(p.matricesIndices=new Float32Array(A.length),p.matricesIndices.set(A)):T==="WEIGHT"?(p.matricesWeights=new Float32Array(A.length),p.matricesWeights.set(A)):T==="COLOR"&&(p.colors=new Float32Array(A.length),p.colors.set(A));if(O=t.accessors[v.indices],O)A=z.GetBufferFromAccessor(t,O),p.indices=new Int32Array(A.length),p.indices.set(A),l.push(p.indices.length);else{for(var F=[],b=0;b<p.positions.length/3;b++)F.push(b);p.indices=new Int32Array(F),l.push(p.indices.length)}s?s.merge(p):s=p;var E=t.scene.getMaterialById(v.material);a.push(E===null?z.GetDefaultMaterial(t.scene):E),i.push(i.length===0?0:i[i.length-1]+c[c.length-2]),u.push(u.length===0?0:u[u.length-1]+l[l.length-2])}}var G;t.scene._blockEntityCollection=!!t.assetContainer,a.length>1?(G=new Qn("multimat"+r,t.scene),G.subMaterials=a):G=new Le("multimat"+r,t.scene),a.length===1&&(G=a[0]),G._parentContainer=t.assetContainer,o.material||(o.material=G),new Ie(r,t.scene,s,!1,o),o.computeWorldMatrix(!0),t.scene._blockEntityCollection=!1,o.subMeshes=[];for(var k=0,f=0;f<n.length;f++){var d=n[f],h=t.meshes[d];if(!!h)for(var _=0;_<h.primitives.length;_++)h.primitives[_].mode!==4,er.AddToMesh(k,i[k],c[k],u[k],l[k],o,o,!0),k++}return o},Ve=function(t,e,n,r){t.position&&(t.position=e),(t.rotationQuaternion||t.rotation)&&(t.rotationQuaternion=n),t.scaling&&(t.scaling=r)},Fr=function(t,e,n){if(e.matrix){var r=new S(0,0,0),o=new j,a=new S(0,0,0),s=W.FromArray(e.matrix);s.decompose(a,o,r),Ve(t,r,o,a)}else e.translation&&e.rotation&&e.scale&&Ve(t,S.FromArray(e.translation),j.FromArray(e.rotation),S.FromArray(e.scale));t.computeWorldMatrix(!0)},Br=function(t,e,n,r){var o=null;if(t.importOnlyMeshes&&(e.skin||e.meshes)&&t.importMeshesNames&&t.importMeshesNames.length>0&&t.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){var a=t.skins[e.skin],s=Fn(t,e,e.meshes,n,e.babylonNode);s.skeleton=t.scene.getLastSkeletonById(e.skin),s.skeleton===null&&(s.skeleton=Rr(t,a,s,a.babylonSkeleton,e.skin),a.babylonSkeleton||(a.babylonSkeleton=s.skeleton)),o=s}}else if(e.meshes){var s=Fn(t,e,e.mesh?[e.mesh]:e.meshes,n,e.babylonNode);o=s}else if(e.light&&!e.babylonNode&&!t.importOnlyMeshes){var i=t.lights[e.light];if(i){if(i.type==="ambient"){var c=i[i.type],u=new Ne(e.light,S.Zero(),t.scene);u.name=e.name||"",c.color&&(u.diffuse=x.FromArray(c.color)),o=u}else if(i.type==="directional"){var l=i[i.type],f=new ge(e.light,S.Zero(),t.scene);f.name=e.name||"",l.color&&(f.diffuse=x.FromArray(l.color)),o=f}else if(i.type==="point"){var d=i[i.type],h=new Me(e.light,S.Zero(),t.scene);h.name=e.name||"",d.color&&(h.diffuse=x.FromArray(d.color)),o=h}else if(i.type==="spot"){var _=i[i.type],p=new xe(e.light,S.Zero(),S.Zero(),0,0,t.scene);p.name=e.name||"",_.color&&(p.diffuse=x.FromArray(_.color)),_.fallOfAngle&&(p.angle=_.fallOfAngle),_.fallOffExponent&&(p.exponent=_.fallOffExponent),o=p}}}else if(e.camera&&!e.babylonNode&&!t.importOnlyMeshes){var v=t.cameras[e.camera];if(v){if(t.scene._blockEntityCollection=!!t.assetContainer,v.type==="orthographic"){var m=new Pe(e.camera,S.Zero(),t.scene,!1);m.name=e.name||"",m.mode=On.ORTHOGRAPHIC_CAMERA,m.attachControl(),o=m,m._parentContainer=t.assetContainer}else if(v.type==="perspective"){var O=v[v.type],A=new Pe(e.camera,S.Zero(),t.scene,!1);A.name=e.name||"",A.attachControl(),O.aspectRatio||(O.aspectRatio=t.scene.getEngine().getRenderWidth()/t.scene.getEngine().getRenderHeight()),O.znear&&O.zfar&&(A.maxZ=O.zfar,A.minZ=O.znear),o=A,A._parentContainer=t.assetContainer}t.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(o===null){t.scene._blockEntityCollection=!!t.assetContainer;var T=new fe(e.name||"",t.scene);T._parentContainer=t.assetContainer,t.scene._blockEntityCollection=!1,e.babylonNode=T,o=T}}if(o!==null){if(e.matrix&&o instanceof fe)Fr(o,e);else{var b=e.translation||[0,0,0],C=e.rotation||[0,0,0,1],L=e.scale||[1,1,1];Ve(o,S.FromArray(b),j.FromArray(C),S.FromArray(L))}o.updateCache(!0),e.babylonNode=o}return o},ye=function(t,e,n,r){r===void 0&&(r=!1);var o=t.nodes[e],a=null;if(t.importOnlyMeshes&&!r&&t.importMeshesNames?t.importMeshesNames.indexOf(o.name||"")!==-1||t.importMeshesNames.length===0?r=!0:r=!1:r=!0,!o.jointName&&r&&(a=Br(t,o,e),a!==null&&(a.id=e,a.parent=n)),o.children)for(var s=0;s<o.children.length;s++)ye(t,o.children[s],a,r)},Bn=function(t){var e=t.currentScene;if(e)for(var n=0;n<e.nodes.length;n++)ye(t,e.nodes[n],null);else for(var r in t.scenes){e=t.scenes[r];for(var n=0;n<e.nodes.length;n++)ye(t,e.nodes[n],null)}Mr(t);for(var n=0;n<t.scene.skeletons.length;n++){var o=t.scene.skeletons[n];t.scene.beginAnimation(o,0,Number.MAX_VALUE,!0,1)}},Dr=function(t,e,n,r,o,a,s){var i=a.values||o.parameters;for(var c in n){var u=n[c],l=u.type;if(l===q.FLOAT_MAT2||l===q.FLOAT_MAT3||l===q.FLOAT_MAT4){if(u.semantic&&!u.source&&!u.node)z.SetMatrix(e.scene,t,u,c,r.getEffect());else if(u.semantic&&(u.source||u.node)){var f=e.scene.getNodeByName(u.source||u.node||"");if(f===null&&(f=e.scene.getNodeById(u.source||u.node||"")),f===null)continue;z.SetMatrix(e.scene,f,u,c,r.getEffect())}}else{var d=i[o.uniforms[c]];if(!d)continue;if(l===q.SAMPLER_2D){var h=e.textures[a.values?d:u.value].babylonTexture;if(h==null)continue;r.getEffect().setTexture(c,h)}else z.SetUniform(r.getEffect(),c,d,l)}}s(r)},Gr=function(t,e,n,r,o){var a=r.values||n.parameters,s=n.uniforms;for(var i in o){var c=o[i],u=c.type,l=a[s[i]];if(l===void 0&&(l=c.value),!!l){var f=function(d){return function(h){c.value&&d&&(e.setTexture(d,h),delete o[d])}};u===q.SAMPLER_2D?oe.LoadTextureAsync(t,r.values?l:c.value,f(i),function(){return f(null)}):c.value&&z.SetUniform(e,i,r.values?l:c.value,u)&&delete o[i]}}},Ur=function(t,e,n){return function(r,o){e.dispose(!0),n("Cannot compile program named "+t.name+". Error: "+o+". Default material will be applied")}},Vr=function(t,e,n,r,o,a){return function(s){Gr(t,e,n,r,o),e.onBind=function(i){Dr(i,t,o,e,n,r,a)}}},Dn=function(t,e,n){for(var r in e.uniforms){var o=e.uniforms[r],a=e.parameters[o];if(t.currentIdentifier===r&&a.semantic&&!a.source&&!a.node){var s=xn.indexOf(a.semantic);if(s!==-1)return delete n[r],Pn[s]}}return t.currentIdentifier},Gn=function(t){for(var e in t.materials)oe.LoadMaterialAsync(t,e,function(n){},function(){})},te=function(){function t(){}return t.CreateRuntime=function(e,n,r){var o={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:n,rootUrl:r,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&V(e.extensions,"extensions",o),e.extensionsUsed&&V(e.extensionsUsed,"extensionsUsed",o),e.buffers&&wr(e.buffers,o),e.bufferViews&&V(e.bufferViews,"bufferViews",o),e.accessors&&V(e.accessors,"accessors",o),e.meshes&&V(e.meshes,"meshes",o),e.lights&&V(e.lights,"lights",o),e.cameras&&V(e.cameras,"cameras",o),e.nodes&&V(e.nodes,"nodes",o),e.images&&V(e.images,"images",o),e.textures&&V(e.textures,"textures",o),e.shaders&&Lr(e.shaders,o),e.programs&&V(e.programs,"programs",o),e.samplers&&V(e.samplers,"samplers",o),e.techniques&&V(e.techniques,"techniques",o),e.materials&&V(e.materials,"materials",o),e.animations&&V(e.animations,"animations",o),e.skins&&V(e.skins,"skins",o),e.scenes&&(o.scenes=e.scenes),e.scene&&e.scenes&&(o.currentScene=e.scenes[e.scene]),o},t.LoadBufferAsync=function(e,n,r,o,a){var s=e.buffers[n];M.IsBase64(s.uri)?setTimeout(function(){return r(new Uint8Array(M.DecodeBase64(s.uri)))}):M.LoadFile(e.rootUrl+s.uri,function(i){return r(new Uint8Array(i))},a,void 0,!0,function(i){i&&o(i.status+" "+i.statusText)})},t.LoadTextureBufferAsync=function(e,n,r,o){var a=e.textures[n];if(!a||!a.source){o("");return}if(a.babylonTexture){r(null);return}var s=e.images[a.source];M.IsBase64(s.uri)?setTimeout(function(){return r(new Uint8Array(M.DecodeBase64(s.uri)))}):M.LoadFile(e.rootUrl+s.uri,function(i){return r(new Uint8Array(i))},void 0,void 0,!0,function(i){i&&o(i.status+" "+i.statusText)})},t.CreateTextureAsync=function(e,n,r,o,a){var s=e.textures[n];if(s.babylonTexture){o(s.babylonTexture);return}var i=e.samplers[s.sampler],c=i.minFilter===ee.NEAREST_MIPMAP_NEAREST||i.minFilter===ee.NEAREST_MIPMAP_LINEAR||i.minFilter===ee.LINEAR_MIPMAP_NEAREST||i.minFilter===ee.LINEAR_MIPMAP_LINEAR,u=P.BILINEAR_SAMPLINGMODE,l=r==null?new Blob:new Blob([r]),f=URL.createObjectURL(l),d=function(){return URL.revokeObjectURL(f)},h=new P(f,e.scene,!c,!0,u,d,d);i.wrapS!==void 0&&(h.wrapU=z.GetWrapMode(i.wrapS)),i.wrapT!==void 0&&(h.wrapV=z.GetWrapMode(i.wrapT)),h.name=n,s.babylonTexture=h,o(h)},t.LoadShaderStringAsync=function(e,n,r,o){var a=e.shaders[n];if(M.IsBase64(a.uri)){var s=atob(a.uri.split(",")[1]);r&&r(s)}else M.LoadFile(e.rootUrl+a.uri,r,void 0,void 0,!1,function(i){i&&o&&o(i.status+" "+i.statusText)})},t.LoadMaterialAsync=function(e,n,r,o){var a=e.materials[n];if(!a.technique){o&&o("No technique found.");return}var s=e.techniques[a.technique];if(!s){e.scene._blockEntityCollection=!!e.assetContainer;var i=new Le(n,e.scene);i._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,i.diffuseColor=new x(.5,.5,.5),i.sideOrientation=Y.CounterClockWiseSideOrientation,r(i);return}var c=e.programs[s.program],u=s.states,l=le.ShadersStore[c.vertexShader+"VertexShader"],f=le.ShadersStore[c.fragmentShader+"PixelShader"],d="",h="",_=new Mn(l),p=new Mn(f),v={},m=[],O=[],A=[];for(var T in s.uniforms){var b=s.uniforms[T],C=s.parameters[b];if(v[T]=C,C.semantic&&!C.node&&!C.source){var L=xn.indexOf(C.semantic);L!==-1?(m.push(Pn[L]),delete v[T]):m.push(T)}else C.type===q.SAMPLER_2D?A.push(T):m.push(T)}for(var N in s.attributes){var F=s.attributes[N],E=s.parameters[F];if(E.semantic){var G=In(E);G&&O.push(G)}}for(;!_.isEnd()&&_.getNextToken();){var k=_.currentToken;if(k!==ie.IDENTIFIER){d+=_.currentString;continue}var ne=!1;for(var N in s.attributes){var F=s.attributes[N],E=s.parameters[F];if(_.currentIdentifier===N&&E.semantic){d+=In(E),ne=!0;break}}ne||(d+=Dn(_,s,v))}for(;!p.isEnd()&&p.getNextToken();){var k=p.currentToken;if(k!==ie.IDENTIFIER){h+=p.currentString;continue}h+=Dn(p,s,v)}var $={vertex:c.vertexShader+n,fragment:c.fragmentShader+n},H={attributes:O,uniforms:m,samplers:A,needAlphaBlending:u&&u.enable&&u.enable.indexOf(3042)!==-1};le.ShadersStore[c.vertexShader+n+"VertexShader"]=d,le.ShadersStore[c.fragmentShader+n+"PixelShader"]=h;var B=new Tn(n,e.scene,$,H);if(B.onError=Ur(c,B,o),B.onCompiled=Vr(e,B,s,a,v,r),B.sideOrientation=Y.CounterClockWiseSideOrientation,u&&u.functions){var ce=u.functions;ce.cullFace&&ce.cullFace[0]!==De.BACK&&(B.backFaceCulling=!1);var I=ce.blendFuncSeparate;I&&(I[0]===R.SRC_ALPHA&&I[1]===R.ONE_MINUS_SRC_ALPHA&&I[2]===R.ONE&&I[3]===R.ONE?B.alphaMode=ue.ALPHA_COMBINE:I[0]===R.ONE&&I[1]===R.ONE&&I[2]===R.ZERO&&I[3]===R.ONE?B.alphaMode=ue.ALPHA_ONEONE:I[0]===R.SRC_ALPHA&&I[1]===R.ONE&&I[2]===R.ZERO&&I[3]===R.ONE?B.alphaMode=ue.ALPHA_ADD:I[0]===R.ZERO&&I[1]===R.ONE_MINUS_SRC_COLOR&&I[2]===R.ONE&&I[3]===R.ONE?B.alphaMode=ue.ALPHA_SUBTRACT:I[0]===R.DST_COLOR&&I[1]===R.ZERO&&I[2]===R.ONE&&I[3]===R.ONE?B.alphaMode=ue.ALPHA_MULTIPLY:I[0]===R.SRC_ALPHA&&I[1]===R.ONE_MINUS_SRC_COLOR&&I[2]===R.ONE&&I[3]===R.ONE&&(B.alphaMode=ue.ALPHA_MAXIMIZED))}},t}(),me=function(){function t(){}return t.RegisterExtension=function(e){if(t.Extensions[e.name]){M.Error('Tool with the same name "'+e.name+'" already exists');return}t.Extensions[e.name]=e},t.prototype.dispose=function(){},t.prototype._importMeshAsync=function(e,n,r,o,a,s,i,c){var u=this;return n.useRightHandedSystem=!0,oe.LoadRuntimeAsync(n,r,o,function(l){l.assetContainer=a,l.importOnlyMeshes=!0,e===""?l.importMeshesNames=[]:typeof e=="string"?l.importMeshesNames=[e]:e&&!(e instanceof Array)?l.importMeshesNames=[e]:(l.importMeshesNames=[],M.Warn("Argument meshesNames must be of type string or string[]")),u._createNodes(l);var f=new Array,d=new Array;for(var h in l.nodes){var _=l.nodes[h];_.babylonNode instanceof Zn&&f.push(_.babylonNode)}for(var p in l.skins){var v=l.skins[p];v.babylonSkeleton instanceof we&&d.push(v.babylonSkeleton)}u._loadBuffersAsync(l,function(){u._loadShadersAsync(l,function(){Gn(l),Bn(l),!ae.IncrementalLoading&&s&&s(f,d)})},i),ae.IncrementalLoading&&s&&s(f,d)},c),!0},t.prototype.importMeshAsync=function(e,n,r,o,a,s){var i=this;return new Promise(function(c,u){i._importMeshAsync(e,n,o,a,r,function(l,f){c({meshes:l,particleSystems:[],skeletons:f,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},s,function(l){u(new Error(l))})})},t.prototype._loadAsync=function(e,n,r,o,a,s){var i=this;e.useRightHandedSystem=!0,oe.LoadRuntimeAsync(e,n,r,function(c){oe.LoadRuntimeExtensionsAsync(c,function(){i._createNodes(c),i._loadBuffersAsync(c,function(){i._loadShadersAsync(c,function(){Gn(c),Bn(c),ae.IncrementalLoading||o()})}),ae.IncrementalLoading&&o()},s)},s)},t.prototype.loadAsync=function(e,n,r,o){var a=this;return new Promise(function(s,i){a._loadAsync(e,n,r,function(){s()},o,function(c){i(new Error(c))})})},t.prototype._loadShadersAsync=function(e,n){var r=!1,o=function(i,c){oe.LoadShaderStringAsync(e,i,function(u){u instanceof ArrayBuffer||(e.loadedShaderCount++,u&&(le.ShadersStore[i+(c.type===Be.VERTEX?"VertexShader":"PixelShader")]=u),e.loadedShaderCount===e.shaderscount&&n())},function(){M.Error("Error when loading shader program named "+i+" located at "+c.uri)})};for(var a in e.shaders){r=!0;var s=e.shaders[a];s?o.bind(this,a,s)():M.Error("No shader named: "+a)}r||n()},t.prototype._loadBuffersAsync=function(e,n,r){var o=!1,a=function(c,u){oe.LoadBufferAsync(e,c,function(l){e.loadedBufferCount++,l&&(l.byteLength!=e.buffers[c].byteLength&&M.Error("Buffer named "+c+" is length "+l.byteLength+". Expected: "+u.byteLength),e.loadedBufferViews[c]=l),e.loadedBufferCount===e.buffersCount&&n()},function(){M.Error("Error when loading buffer named "+c+" located at "+u.uri)})};for(var s in e.buffers){o=!0;var i=e.buffers[s];i?a.bind(this,s,i)():M.Error("No buffer named: "+s)}o||n()},t.prototype._createNodes=function(e){var n=e.currentScene;if(n)for(var r=0;r<n.nodes.length;r++)ye(e,n.nodes[r],null);else for(var o in e.scenes){n=e.scenes[o];for(var r=0;r<n.nodes.length;r++)ye(e,n.nodes[r],null)}},t.Extensions={},t}(),oe=function(){function t(e){this._name=e}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),t.prototype.loadRuntimeAsync=function(e,n,r,o,a){return!1},t.prototype.loadRuntimeExtensionsAsync=function(e,n,r){return!1},t.prototype.loadBufferAsync=function(e,n,r,o,a){return!1},t.prototype.loadTextureBufferAsync=function(e,n,r,o){return!1},t.prototype.createTextureAsync=function(e,n,r,o,a){return!1},t.prototype.loadShaderStringAsync=function(e,n,r,o){return!1},t.prototype.loadMaterialAsync=function(e,n,r,o){return!1},t.LoadRuntimeAsync=function(e,n,r,o,a){t.ApplyExtensions(function(s){return s.loadRuntimeAsync(e,n,r,o,a)},function(){setTimeout(function(){!o||o(te.CreateRuntime(n.json,e,r))})})},t.LoadRuntimeExtensionsAsync=function(e,n,r){t.ApplyExtensions(function(o){return o.loadRuntimeExtensionsAsync(e,n,r)},function(){setTimeout(function(){n()})})},t.LoadBufferAsync=function(e,n,r,o,a){t.ApplyExtensions(function(s){return s.loadBufferAsync(e,n,r,o,a)},function(){te.LoadBufferAsync(e,n,r,o,a)})},t.LoadTextureAsync=function(e,n,r,o){t.LoadTextureBufferAsync(e,n,function(a){a&&t.CreateTextureAsync(e,n,a,r,o)},o)},t.LoadShaderStringAsync=function(e,n,r,o){t.ApplyExtensions(function(a){return a.loadShaderStringAsync(e,n,r,o)},function(){te.LoadShaderStringAsync(e,n,r,o)})},t.LoadMaterialAsync=function(e,n,r,o){t.ApplyExtensions(function(a){return a.loadMaterialAsync(e,n,r,o)},function(){te.LoadMaterialAsync(e,n,r,o)})},t.LoadTextureBufferAsync=function(e,n,r,o){t.ApplyExtensions(function(a){return a.loadTextureBufferAsync(e,n,r,o)},function(){te.LoadTextureBufferAsync(e,n,r,o)})},t.CreateTextureAsync=function(e,n,r,o,a){t.ApplyExtensions(function(s){return s.createTextureAsync(e,n,r,o,a)},function(){te.CreateTextureAsync(e,n,r,o,a)})},t.ApplyExtensions=function(e,n){for(var r in me.Extensions){var o=me.Extensions[r];if(e(o))return}n()},t}();ae._CreateGLTF1Loader=function(){return new me};var kr="binary_glTF",Hr=function(t){Sn(e,t);function e(){return t.call(this,"KHR_binary_glTF")||this}return e.prototype.loadRuntimeAsync=function(n,r,o,a,s){var i=r.json.extensionsUsed;return!i||i.indexOf(this.name)===-1||!r.bin?!1:(this._bin=r.bin,a(te.CreateRuntime(r.json,n,o)),!0)},e.prototype.loadBufferAsync=function(n,r,o,a){return n.extensionsUsed.indexOf(this.name)===-1||r!==kr?!1:(this._bin.readAsync(0,this._bin.byteLength).then(o,function(s){return a(s.message)}),!0)},e.prototype.loadTextureBufferAsync=function(n,r,o,a){var s=n.textures[r],i=n.images[s.source];if(!i.extensions||!(this.name in i.extensions))return!1;var c=i.extensions[this.name],u=n.bufferViews[c.bufferView],l=z.GetBufferFromBufferView(n,u,0,u.byteLength,se.UNSIGNED_BYTE);return o(l),!0},e.prototype.loadShaderStringAsync=function(n,r,o,a){var s=n.shaders[r];if(!s.extensions||!(this.name in s.extensions))return!1;var i=s.extensions[this.name],c=n.bufferViews[i.bufferView],u=z.GetBufferFromBufferView(n,c,0,c.byteLength,se.UNSIGNED_BYTE);return setTimeout(function(){var l=z.DecodeBufferToText(u);o(l)}),!0},e}(oe);me.RegisterExtension(new Hr);var Kr=function(t){Sn(e,t);function e(){return t.call(this,"KHR_materials_common")||this}return e.prototype.loadRuntimeExtensionsAsync=function(n,r,o){if(!n.extensions)return!1;var a=n.extensions[this.name];if(!a)return!1;var s=a.lights;if(s)for(var i in s){var c=s[i];switch(c.type){case"ambient":var u=new Ne(c.name,new S(0,1,0),n.scene),l=c.ambient;l&&(u.diffuse=x.FromArray(l.color||[1,1,1]));break;case"point":var f=new Me(c.name,new S(10,10,10),n.scene),d=c.point;d&&(f.diffuse=x.FromArray(d.color||[1,1,1]));break;case"directional":var h=new ge(c.name,new S(0,-1,0),n.scene),_=c.directional;_&&(h.diffuse=x.FromArray(_.color||[1,1,1]));break;case"spot":var p=c.spot;if(p){var v=new xe(c.name,new S(0,10,0),new S(0,-1,0),p.fallOffAngle||Math.PI,p.fallOffExponent||0,n.scene);v.diffuse=x.FromArray(p.color||[1,1,1])}break;default:M.Warn('GLTF Material Common extension: light type "'+c.type+"\u201D not supported");break}}return!1},e.prototype.loadMaterialAsync=function(n,r,o,a){var s=n.materials[r];if(!s||!s.extensions)return!1;var i=s.extensions[this.name];if(!i)return!1;var c=new Le(r,n.scene);return c.sideOrientation=Y.CounterClockWiseSideOrientation,i.technique==="CONSTANT"&&(c.disableLighting=!0),c.backFaceCulling=i.doubleSided===void 0?!1:!i.doubleSided,c.alpha=i.values.transparency===void 0?1:i.values.transparency,c.specularPower=i.values.shininess===void 0?0:i.values.shininess,typeof i.values.ambient=="string"?this._loadTexture(n,i.values.ambient,c,"ambientTexture",a):c.ambientColor=x.FromArray(i.values.ambient||[0,0,0]),typeof i.values.diffuse=="string"?this._loadTexture(n,i.values.diffuse,c,"diffuseTexture",a):c.diffuseColor=x.FromArray(i.values.diffuse||[0,0,0]),typeof i.values.emission=="string"?this._loadTexture(n,i.values.emission,c,"emissiveTexture",a):c.emissiveColor=x.FromArray(i.values.emission||[0,0,0]),typeof i.values.specular=="string"?this._loadTexture(n,i.values.specular,c,"specularTexture",a):c.specularColor=x.FromArray(i.values.specular||[0,0,0]),!0},e.prototype._loadTexture=function(n,r,o,a,s){te.LoadTextureBufferAsync(n,r,function(i){te.CreateTextureAsync(n,r,i,function(c){return o[a]=c},s)},s)},e}(oe);me.RegisterExtension(new Kr);var y=function(){function t(){}return t.Get=function(e,n,r){if(!n||r==null||!n[r])throw new Error("".concat(e,": Failed to find index (").concat(r,")"));return n[r]},t.Assign=function(e){if(e)for(var n=0;n<e.length;n++)e[n].index=n},t}(),g=function(){function t(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}return t.RegisterExtension=function(e,n){t.UnregisterExtension(e)&&K.Warn("Extension with the name '".concat(e,"' already exists")),t._RegisteredExtensions[e]={factory:n}},t.UnregisterExtension=function(e){return t._RegisteredExtensions[e]?(delete t._RegisteredExtensions[e],!0):!1},Object.defineProperty(t.prototype,"gltf",{get:function(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bin",{get:function(){return this._bin},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"babylonScene",{get:function(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(function(e){return e.dispose&&e.dispose()}),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())},t.prototype.importMeshAsync=function(e,n,r,o,a,s,i){var c=this;return i===void 0&&(i=""),Promise.resolve().then(function(){c._babylonScene=n,c._assetContainer=r,c._loadData(o);var u=null;if(e){var l={};if(c._gltf.nodes)for(var f=0,d=c._gltf.nodes;f<d.length;f++){var h=d[f];h.name&&(l[h.name]=h.index)}var _=e instanceof Array?e:[e];u=_.map(function(p){var v=l[p];if(v===void 0)throw new Error("Failed to find node '".concat(p,"'"));return v})}return c._loadAsync(a,i,u,function(){return{meshes:c._getMeshes(),particleSystems:[],skeletons:c._getSkeletons(),animationGroups:c._getAnimationGroups(),lights:c._babylonLights,transformNodes:c._getTransformNodes(),geometries:c._getGeometries()}})})},t.prototype.loadAsync=function(e,n,r,o,a){var s=this;return a===void 0&&(a=""),Promise.resolve().then(function(){return s._babylonScene=e,s._loadData(n),s._loadAsync(r,a,null,function(){})})},t.prototype._loadAsync=function(e,n,r,o){var a=this;return Promise.resolve().then(function(){a._rootUrl=e,a._uniqueRootUrl=!re.StartsWith(e,"file:")&&n?e:"".concat(e).concat(Date.now(),"/"),a._fileName=n,a._loadExtensions(),a._checkExtensions();var s="".concat(J[J.LOADING]," => ").concat(J[J.READY]),i="".concat(J[J.LOADING]," => ").concat(J[J.COMPLETE]);a._parent._startPerformanceCounter(s),a._parent._startPerformanceCounter(i),a._parent._setState(J.LOADING),a._extensionsOnLoading();var c=new Array,u=a._babylonScene.blockMaterialDirtyMechanism;if(a._babylonScene.blockMaterialDirtyMechanism=!0,r)c.push(a.loadSceneAsync("/nodes",{nodes:r,index:-1}));else if(a._gltf.scene!=null||a._gltf.scenes&&a._gltf.scenes[0]){var l=y.Get("/scene",a._gltf.scenes,a._gltf.scene||0);c.push(a.loadSceneAsync("/scenes/".concat(l.index),l))}if(a.parent.loadAllMaterials&&a._gltf.materials)for(var f=0;f<a._gltf.materials.length;++f){var d=a._gltf.materials[f],h="/materials/"+f,_=Y.TriangleFillMode;c.push(a._loadMaterialAsync(h,d,null,_,function(v){}))}a._babylonScene.blockMaterialDirtyMechanism=u,a._parent.compileMaterials&&c.push(a._compileMaterialsAsync()),a._parent.compileShadowGenerators&&c.push(a._compileShadowGeneratorsAsync());var p=Promise.all(c).then(function(){return a._rootBabylonMesh&&a._rootBabylonMesh.setEnabled(!0),a._extensionsOnReady(),a._parent._setState(J.READY),a._startAnimations(),o()});return p.then(function(v){return a._parent._endPerformanceCounter(s),M.SetImmediate(function(){a._disposed||Promise.all(a._completePromises).then(function(){a._parent._endPerformanceCounter(i),a._parent._setState(J.COMPLETE),a._parent.onCompleteObservable.notifyObservers(void 0),a._parent.onCompleteObservable.clear(),a.dispose()},function(m){a._parent.onErrorObservable.notifyObservers(m),a._parent.onErrorObservable.clear(),a.dispose()})}),v})}).catch(function(s){throw a._disposed||(a._parent.onErrorObservable.notifyObservers(s),a._parent.onErrorObservable.clear(),a.dispose()),s})},t.prototype._loadData=function(e){if(this._gltf=e.json,this._setupData(),e.bin){var n=this._gltf.buffers;if(n&&n[0]&&!n[0].uri){var r=n[0];(r.byteLength<e.bin.byteLength-3||r.byteLength>e.bin.byteLength)&&K.Warn("Binary buffer length (".concat(r.byteLength,") from JSON does not match chunk length (").concat(e.bin.byteLength,")")),this._bin=e.bin}else K.Warn("Unexpected BIN chunk")}},t.prototype._setupData=function(){if(y.Assign(this._gltf.accessors),y.Assign(this._gltf.animations),y.Assign(this._gltf.buffers),y.Assign(this._gltf.bufferViews),y.Assign(this._gltf.cameras),y.Assign(this._gltf.images),y.Assign(this._gltf.materials),y.Assign(this._gltf.meshes),y.Assign(this._gltf.nodes),y.Assign(this._gltf.samplers),y.Assign(this._gltf.scenes),y.Assign(this._gltf.skins),y.Assign(this._gltf.textures),this._gltf.nodes){for(var e={},n=0,r=this._gltf.nodes;n<r.length;n++){var o=r[n];if(o.children)for(var a=0,s=o.children;a<s.length;a++){var i=s[a];e[i]=o.index}}for(var c=this._createRootNode(),u=0,l=this._gltf.nodes;u<l.length;u++){var o=l[u],f=e[o.index];o.parent=f===void 0?c:this._gltf.nodes[f]}}},t.prototype._loadExtensions=function(){for(var e in t._RegisteredExtensions){var n=t._RegisteredExtensions[e].factory(this);n.name!==e&&K.Warn("The name of the glTF loader extension instance does not match the registered name: ".concat(n.name," !== ").concat(e)),this._extensions.push(n),this._parent.onExtensionLoadedObservable.notifyObservers(n)}this._extensions.sort(function(r,o){return(r.order||Number.MAX_VALUE)-(o.order||Number.MAX_VALUE)}),this._parent.onExtensionLoadedObservable.clear()},t.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var e=function(s){var i=n._extensions.some(function(c){return c.name===s&&c.enabled});if(!i)throw new Error("Require extension ".concat(s," is not available"))},n=this,r=0,o=this._gltf.extensionsRequired;r<o.length;r++){var a=o[r];e(a)}},t.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new fe("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case ve.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],t._LoadTransform(e,this._rootBabylonMesh));break}case ve.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error("Invalid coordinate system mode (".concat(this._parent.coordinateSystemMode,")"))}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e},t.prototype.loadSceneAsync=function(e,n){var r=this,o=this._extensionsLoadSceneAsync(e,n);if(o)return o;var a=new Array;if(this.logOpen("".concat(e," ").concat(n.name||"")),n.nodes)for(var s=0,i=n.nodes;s<i.length;s++){var c=i[s],u=y.Get("".concat(e,"/nodes/").concat(c),this._gltf.nodes,c);a.push(this.loadNodeAsync("/nodes/".concat(u.index),u,function(h){h.parent=r._rootBabylonMesh}))}for(var l=0,f=this._postSceneLoadActions;l<f.length;l++){var d=f[l];d()}return a.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(a).then(function(){})},t.prototype._forEachPrimitive=function(e,n){if(e._primitiveBabylonMeshes)for(var r=0,o=e._primitiveBabylonMeshes;r<o.length;r++){var a=o[r];n(a)}},t.prototype._getGeometries=function(){var e=new Array,n=this._gltf.nodes;if(n)for(var r=0,o=n;r<o.length;r++){var a=o[r];this._forEachPrimitive(a,function(s){var i=s.geometry;i&&e.indexOf(i)===-1&&e.push(i)})}return e},t.prototype._getMeshes=function(){var e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);var n=this._gltf.nodes;if(n)for(var r=0,o=n;r<o.length;r++){var a=o[r];this._forEachPrimitive(a,function(s){e.push(s)})}return e},t.prototype._getTransformNodes=function(){var e=new Array,n=this._gltf.nodes;if(n)for(var r=0,o=n;r<o.length;r++){var a=o[r];a._babylonTransformNode&&a._babylonTransformNode.getClassName()==="TransformNode"&&e.push(a._babylonTransformNode)}return e},t.prototype._getSkeletons=function(){var e=new Array,n=this._gltf.skins;if(n)for(var r=0,o=n;r<o.length;r++){var a=o[r];a._data&&e.push(a._data.babylonSkeleton)}return e},t.prototype._getAnimationGroups=function(){var e=new Array,n=this._gltf.animations;if(n)for(var r=0,o=n;r<o.length;r++){var a=o[r];a._babylonAnimationGroup&&e.push(a._babylonAnimationGroup)}return e},t.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case de.NONE:break;case de.FIRST:{var e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case de.ALL:{for(var e=this._getAnimationGroups(),n=0,r=e;n<r.length;n++){var o=r[n];o.start(!0)}break}default:{K.Error("Invalid animation start mode (".concat(this._parent.animationStartMode,")"));return}}},t.prototype.loadNodeAsync=function(e,n,r){var o=this;r===void 0&&(r=function(){});var a=this._extensionsLoadNodeAsync(e,n,r);if(a)return a;if(n._babylonTransformNode)throw new Error("".concat(e,": Invalid recursive node hierarchy"));var s=new Array;this.logOpen("".concat(e," ").concat(n.name||""));var i=function(l){if(t.AddPointerMetadata(l,e),t._LoadTransform(n,l),n.camera!=null){var f=y.Get("".concat(e,"/camera"),o._gltf.cameras,n.camera);s.push(o.loadCameraAsync("/cameras/".concat(f.index),f,function(v){v.parent=l}))}if(n.children)for(var d=0,h=n.children;d<h.length;d++){var _=h[d],p=y.Get("".concat(e,"/children/").concat(_),o._gltf.nodes,_);s.push(o.loadNodeAsync("/nodes/".concat(p.index),p,function(v){v.parent=l}))}r(l)};if(n.mesh==null||n.skin!=null){var c=n.name||"node".concat(n.index);this._babylonScene._blockEntityCollection=!!this._assetContainer,n._babylonTransformNode=new bn(c,this._babylonScene),n._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i(n._babylonTransformNode)}if(n.mesh!=null)if(n.skin==null){var u=y.Get("".concat(e,"/mesh"),this._gltf.meshes,n.mesh);s.push(this._loadMeshAsync("/meshes/".concat(u.index),n,u,i))}else{var u=y.Get("".concat(e,"/mesh"),this._gltf.meshes,n.mesh);s.push(this._loadMeshAsync("/meshes/".concat(u.index),n,u,function(f){t.AddPointerMetadata(f,e);var d=y.Get("".concat(e,"/skin"),o._gltf.skins,n.skin);s.push(o._loadSkinAsync("/skins/".concat(d.index),n,d,function(h){o._forEachPrimitive(n,function(_){_.skeleton=h}),o._postSceneLoadActions.push(function(){if(d.skeleton!=null){var _=y.Get("/skins/".concat(d.index,"/skeleton"),o._gltf.nodes,d.skeleton);f.parent=_.parent._babylonTransformNode}else f.parent=o._rootBabylonMesh})}))}))}return this.logClose(),Promise.all(s).then(function(){return o._forEachPrimitive(n,function(l){l.geometry&&l.geometry.useBoundingInfoFromGeometry?l._updateBoundingInfo():l.refreshBoundingInfo(!0)}),n._babylonTransformNode})},t.prototype._loadMeshAsync=function(e,n,r,o){var a=r.primitives;if(!a||!a.length)throw new Error("".concat(e,": Primitives are missing"));a[0].index==null&&y.Assign(a);var s=new Array;this.logOpen("".concat(e," ").concat(r.name||""));var i=n.name||"node".concat(n.index);if(a.length===1){var c=r.primitives[0];s.push(this._loadMeshPrimitiveAsync("".concat(e,"/primitives/").concat(c.index),i,n,r,c,function(f){n._babylonTransformNode=f,n._primitiveBabylonMeshes=[f]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,n._babylonTransformNode=new bn(i,this._babylonScene),n._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._primitiveBabylonMeshes=[];for(var u=0,l=a;u<l.length;u++){var c=l[u];s.push(this._loadMeshPrimitiveAsync("".concat(e,"/primitives/").concat(c.index),"".concat(i,"_primitive").concat(c.index),n,r,c,function(d){d.parent=n._babylonTransformNode,n._primitiveBabylonMeshes.push(d)}))}}return o(n._babylonTransformNode),this.logClose(),Promise.all(s).then(function(){return n._babylonTransformNode})},t.prototype._loadMeshPrimitiveAsync=function(e,n,r,o,a,s){var i=this,c=this._extensionsLoadMeshPrimitiveAsync(e,n,r,o,a,s);if(c)return c;this.logOpen("".concat(e));var u=this._disableInstancedMesh===0&&this._parent.createInstances&&r.skin==null&&!o.primitives[0].targets,l,f;if(u&&a._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,l=a._instanceData.babylonSourceMesh.createInstance(n),l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f=a._instanceData.promise;else{var d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;var h=new fe(n,this._babylonScene);h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?Y.CounterClockWiseSideOrientation:Y.ClockWiseSideOrientation,this._createMorphTargets(e,r,o,a,h),d.push(this._loadVertexDataAsync(e,a,h).then(function(m){return i._loadMorphTargetsAsync(e,a,h,m).then(function(){i._babylonScene._blockEntityCollection=!!i._assetContainer,m.applyToMesh(h),m._parentContainer=i._assetContainer,i._babylonScene._blockEntityCollection=!1})}));var _=t._GetDrawMode(e,a.mode);if(a.material==null){var p=this._defaultBabylonMaterialData[_];p||(p=this._createDefaultMaterial("__GLTFLoader._default",_),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[_]=p),h.material=p}else{var v=y.Get("".concat(e,"/material"),this._gltf.materials,a.material);d.push(this._loadMaterialAsync("/materials/".concat(v.index),v,h,_,function(m){h.material=m}))}f=Promise.all(d),u&&(a._instanceData={babylonSourceMesh:h,promise:f}),l=h}return t.AddPointerMetadata(l,e),this._parent.onMeshLoadedObservable.notifyObservers(l),s(l),this.logClose(),f.then(function(){return l})},t.prototype._loadVertexDataAsync=function(e,n,r){var o=this,a=this._extensionsLoadVertexDataAsync(e,n,r);if(a)return a;var s=n.attributes;if(!s)throw new Error("".concat(e,": Attributes are missing"));var i=new Array,c=new Ie(r.name,this._babylonScene);if(n.indices==null)r.isUnIndexed=!0;else{var u=y.Get("".concat(e,"/indices"),this._gltf.accessors,n.indices);i.push(this._loadIndicesAccessorAsync("/accessors/".concat(u.index),u).then(function(f){c.setIndices(f)}))}var l=function(f,d,h){if(s[f]!=null){r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(d)===-1&&r._delayInfo.push(d);var _=y.Get("".concat(e,"/attributes/").concat(f),o._gltf.accessors,s[f]);i.push(o._loadVertexAccessorAsync("/accessors/".concat(_.index),_,d).then(function(p){if(p.getKind()===w.PositionKind&&!o.parent.alwaysComputeBoundingBox&&!r.skeleton){var v=_.min,m=_.max;if(v!==void 0&&m!==void 0){if(_.normalized&&_.componentType!==5126){var O=1;switch(_.componentType){case 5120:O=127;break;case 5121:O=255;break;case 5122:O=32767;break;case 5123:O=65535;break}for(var A=0;A<3;++A)v[A]=Math.max(v[A]/O,-1),m[A]=Math.max(m[A]/O,-1)}var T=Z.Vector3[0],b=Z.Vector3[1];T.copyFromFloats.apply(T,v),b.copyFromFloats.apply(b,m),c._boundingInfo=new ir(T,b),c.useBoundingInfoFromGeometry=!0}}c.setVerticesBuffer(p,_.count)})),d==w.MatricesIndicesExtraKind&&(r.numBoneInfluencers=8),h&&h(_)}};return l("POSITION",w.PositionKind),l("NORMAL",w.NormalKind),l("TANGENT",w.TangentKind),l("TEXCOORD_0",w.UVKind),l("TEXCOORD_1",w.UV2Kind),l("TEXCOORD_2",w.UV3Kind),l("TEXCOORD_3",w.UV4Kind),l("TEXCOORD_4",w.UV5Kind),l("TEXCOORD_5",w.UV6Kind),l("JOINTS_0",w.MatricesIndicesKind),l("WEIGHTS_0",w.MatricesWeightsKind),l("JOINTS_1",w.MatricesIndicesExtraKind),l("WEIGHTS_1",w.MatricesWeightsExtraKind),l("COLOR_0",w.ColorKind,function(f){f.type==="VEC4"&&(r.hasVertexAlpha=!0)}),Promise.all(i).then(function(){return c})},t.prototype._createMorphTargets=function(e,n,r,o,a){if(!!o.targets){if(n._numMorphTargets==null)n._numMorphTargets=o.targets.length;else if(o.targets.length!==n._numMorphTargets)throw new Error("".concat(e,": Primitives do not have the same number of targets"));var s=r.extras?r.extras.targetNames:null;a.morphTargetManager=new nr(a.getScene()),a.morphTargetManager.areUpdatesFrozen=!0;for(var i=0;i<o.targets.length;i++){var c=n.weights?n.weights[i]:r.weights?r.weights[i]:0,u=s?s[i]:"morphTarget".concat(i);a.morphTargetManager.addTarget(new rr(u,c,a.getScene()))}}},t.prototype._loadMorphTargetsAsync=function(e,n,r,o){if(!n.targets)return Promise.resolve();for(var a=new Array,s=r.morphTargetManager,i=0;i<s.numTargets;i++){var c=s.getTarget(i);a.push(this._loadMorphTargetVertexDataAsync("".concat(e,"/targets/").concat(i),o,n.targets[i],c))}return Promise.all(a).then(function(){s.areUpdatesFrozen=!1})},t.prototype._loadMorphTargetVertexDataAsync=function(e,n,r,o){var a=this,s=new Array,i=function(c,u,l){if(r[c]!=null){var f=n.getVertexBuffer(u);if(!!f){var d=y.Get("".concat(e,"/").concat(c),a._gltf.accessors,r[c]);s.push(a._loadFloatAccessorAsync("/accessors/".concat(d.index),d).then(function(h){l(f,h)}))}}};return i("POSITION",w.PositionKind,function(c,u){var l=new Float32Array(u.length);c.forEach(u.length,function(f,d){l[d]=u[d]+f}),o.setPositions(l)}),i("NORMAL",w.NormalKind,function(c,u){var l=new Float32Array(u.length);c.forEach(l.length,function(f,d){l[d]=u[d]+f}),o.setNormals(l)}),i("TANGENT",w.TangentKind,function(c,u){var l=new Float32Array(u.length/3*4),f=0;c.forEach(u.length/3*4,function(d,h){(h+1)%4!=0&&(l[f]=u[f]+d,f++)}),o.setTangents(l)}),Promise.all(s).then(function(){})},t._LoadTransform=function(e,n){if(e.skin==null){var r=S.Zero(),o=j.Identity(),a=S.One();if(e.matrix){var s=W.FromArray(e.matrix);s.decompose(a,o,r)}else e.translation&&(r=S.FromArray(e.translation)),e.rotation&&(o=j.FromArray(e.rotation)),e.scale&&(a=S.FromArray(e.scale));n.position=r,n.rotationQuaternion=o,n.scaling=a}},t.prototype._loadSkinAsync=function(e,n,r,o){var a=this,s=this._extensionsLoadSkinAsync(e,n,r);if(s)return s;if(r._data)return o(r._data.babylonSkeleton),r._data.promise;var i="skeleton".concat(r.index);this._babylonScene._blockEntityCollection=!!this._assetContainer;var c=new we(r.name||i,i,this._babylonScene);c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,r,c);var u=this._loadSkinInverseBindMatricesDataAsync(e,r).then(function(l){a._updateBoneMatrices(c,l)});return r._data={babylonSkeleton:c,promise:u},o(c),u},t.prototype._loadBones=function(e,n,r){if(n.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){var o=this._findSkeletonRootNode("".concat(e,"/joints"),n.joints);if(o)if(n.skeleton===void 0)n.skeleton=o.index;else{var a=function(d,h){for(;h.parent;h=h.parent)if(h.parent===d)return!0;return!1},s=y.Get("".concat(e,"/skeleton"),this._gltf.nodes,n.skeleton);s!==o&&!a(s,o)&&(K.Warn("".concat(e,"/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root")),n.skeleton=o.index)}else K.Warn("".concat(e,": Failed to find common root"))}for(var i={},c=0,u=n.joints;c<u.length;c++){var l=u[c],f=y.Get("".concat(e,"/joints/").concat(l),this._gltf.nodes,l);this._loadBone(f,n,r,i)}},t.prototype._findSkeletonRootNode=function(e,n){for(var r={},o=0,a=n;o<a.length;o++){for(var s=a[o],i=new Array,c=y.Get("".concat(e,"/").concat(s),this._gltf.nodes,s);c.index!==-1;)i.unshift(c),c=c.parent;r[s]=i}for(var u=null,l=0;;++l){var i=r[n[0]];if(l>=i.length)return u;for(var c=i[l],f=1;f<n.length;++f)if(i=r[n[f]],l>=i.length||c!==i[l])return u;u=c}},t.prototype._loadBone=function(e,n,r,o){var a=o[e.index];if(a)return a;var s=null;e.index!==n.skeleton&&(e.parent&&e.parent.index!==-1?s=this._loadBone(e.parent,n,r,o):n.skeleton!==void 0&&K.Warn("/skins/".concat(n.index,"/skeleton: Skeleton node is not a common root")));var i=n.joints.indexOf(e.index);return a=new _e(e.name||"joint".concat(e.index),r,s,this._getNodeMatrix(e),null,null,i),o[e.index]=a,this._postSceneLoadActions.push(function(){a.linkTransformNode(e._babylonTransformNode)}),a},t.prototype._loadSkinInverseBindMatricesDataAsync=function(e,n){if(n.inverseBindMatrices==null)return Promise.resolve(null);var r=y.Get("".concat(e,"/inverseBindMatrices"),this._gltf.accessors,n.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/".concat(r.index),r)},t.prototype._updateBoneMatrices=function(e,n){for(var r=0,o=e.bones;r<o.length;r++){var a=o[r],s=W.Identity(),i=a._index;n&&i!==-1&&(W.FromArrayToRef(n,i*16,s),s.invertToRef(s));var c=a.getParent();c&&s.multiplyToRef(c.getInvertedAbsoluteTransform(),s),a.updateMatrix(s,!1,!1),a._updateDifferenceMatrix(void 0,!1)}},t.prototype._getNodeMatrix=function(e){return e.matrix?W.FromArray(e.matrix):W.Compose(e.scale?S.FromArray(e.scale):S.One(),e.rotation?j.FromArray(e.rotation):j.Identity(),e.translation?S.FromArray(e.translation):S.Zero())},t.prototype.loadCameraAsync=function(e,n,r){r===void 0&&(r=function(){});var o=this._extensionsLoadCameraAsync(e,n,r);if(o)return o;var a=new Array;this.logOpen("".concat(e," ").concat(n.name||"")),this._babylonScene._blockEntityCollection=!!this._assetContainer;var s=new Pe(n.name||"camera".concat(n.index),S.Zero(),this._babylonScene,!1);switch(s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.ignoreParentScaling=!0,s.rotation=new S(0,Math.PI,0),n.type){case"perspective":{var i=n.perspective;if(!i)throw new Error("".concat(e,": Camera perspective properties are missing"));s.fov=i.yfov,s.minZ=i.znear,s.maxZ=i.zfar||0;break}case"orthographic":{if(!n.orthographic)throw new Error("".concat(e,": Camera orthographic properties are missing"));s.mode=On.ORTHOGRAPHIC_CAMERA,s.orthoLeft=-n.orthographic.xmag,s.orthoRight=n.orthographic.xmag,s.orthoBottom=-n.orthographic.ymag,s.orthoTop=n.orthographic.ymag,s.minZ=n.orthographic.znear,s.maxZ=n.orthographic.zfar;break}default:throw new Error("".concat(e,": Invalid camera type (").concat(n.type,")"))}return t.AddPointerMetadata(s,e),this._parent.onCameraLoadedObservable.notifyObservers(s),r(s),this.logClose(),Promise.all(a).then(function(){return s})},t.prototype._loadAnimationsAsync=function(){var e=this._gltf.animations;if(!e)return Promise.resolve();for(var n=new Array,r=0;r<e.length;r++){var o=e[r];n.push(this.loadAnimationAsync("/animations/".concat(o.index),o).then(function(a){a.targetedAnimations.length===0&&a.dispose()}))}return Promise.all(n).then(function(){})},t.prototype.loadAnimationAsync=function(e,n){var r=this._extensionsLoadAnimationAsync(e,n);if(r)return r;this._babylonScene._blockEntityCollection=!!this._assetContainer;var o=new tr(n.name||"animation".concat(n.index),this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._babylonAnimationGroup=o;var a=new Array;y.Assign(n.channels),y.Assign(n.samplers);for(var s=0,i=n.channels;s<i.length;s++){var c=i[s];a.push(this._loadAnimationChannelAsync("".concat(e,"/channels/").concat(c.index),e,n,c,o))}return Promise.all(a).then(function(){return o.normalize(0),o})},t.prototype._loadAnimationChannelAsync=function(e,n,r,o,a,s){var i=this;if(s===void 0&&(s=null),o.target.node==null)return Promise.resolve();var c=y.Get("".concat(e,"/target/node"),this._gltf.nodes,o.target.node);if(o.target.path==="weights"&&!c._numMorphTargets||o.target.path!=="weights"&&!c._babylonTransformNode)return Promise.resolve();var u=y.Get("".concat(e,"/sampler"),r.samplers,o.sampler);return this._loadAnimationSamplerAsync("".concat(n,"/samplers/").concat(o.sampler),u).then(function(l){var f,d;switch(o.target.path){case"translation":{f="position",d=Q.ANIMATIONTYPE_VECTOR3;break}case"rotation":{f="rotationQuaternion",d=Q.ANIMATIONTYPE_QUATERNION;break}case"scale":{f="scaling",d=Q.ANIMATIONTYPE_VECTOR3;break}case"weights":{f="influence",d=Q.ANIMATIONTYPE_FLOAT;break}default:throw new Error("".concat(e,"/target/path: Invalid value (").concat(o.target.path,")"))}var h=0,_;switch(f){case"position":{_=function(L){var N=S.FromArray(l.output,h).scaleInPlace(L);return h+=3,N};break}case"rotationQuaternion":{_=function(L){var N=j.FromArray(l.output,h).scaleInPlace(L);return h+=4,N};break}case"scaling":{_=function(L){var N=S.FromArray(l.output,h).scaleInPlace(L);return h+=3,N};break}case"influence":{_=function(L){for(var N=new Array(c._numMorphTargets),F=0;F<c._numMorphTargets;F++)N[F]=l.output[h++]*L;return N};break}}var p;switch(l.interpolation){case"STEP":{p=function(L){return{frame:l.input[L]*i.parent.targetFps,value:_(1),interpolation:cr.STEP}};break}case"LINEAR":{p=function(L){return{frame:l.input[L]*i.parent.targetFps,value:_(1)}};break}case"CUBICSPLINE":{var v=1/i.parent.targetFps;p=function(L){return{frame:l.input[L]*i.parent.targetFps,inTangent:_(v),value:_(1),outTangent:_(v)}};break}}for(var m=new Array(l.input.length),O=0;O<l.input.length;O++)m[O]=p(O);if(f==="influence")for(var A=function(L){var N="".concat(a.name,"_channel").concat(a.targetedAnimations.length),F=new Q(N,f,i.parent.targetFps,d);F.setKeys(m.map(function(E){return{frame:E.frame,inTangent:E.inTangent?E.inTangent[L]:void 0,value:E.value[L],outTangent:E.outTangent?E.outTangent[L]:void 0}})),i._forEachPrimitive(c,function(E){var G=E,k=G.morphTargetManager.getTarget(L),ne=F.clone();k.animations.push(ne),a.addTargetedAnimation(ne,k)})},T=0;T<c._numMorphTargets;T++)A(T);else{var b="".concat(a.name,"_channel").concat(a.targetedAnimations.length),C=new Q(b,f,i.parent.targetFps,d);C.setKeys(m),s!=null&&s.animations!=null?(s.animations.push(C),a.addTargetedAnimation(C,s)):(c._babylonTransformNode.animations.push(C),a.addTargetedAnimation(C,c._babylonTransformNode))}})},t.prototype._loadAnimationSamplerAsync=function(e,n){if(n._data)return n._data;var r=n.interpolation||"LINEAR";switch(r){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error("".concat(e,"/interpolation: Invalid value (").concat(n.interpolation,")"))}var o=y.Get("".concat(e,"/input"),this._gltf.accessors,n.input),a=y.Get("".concat(e,"/output"),this._gltf.accessors,n.output);return n._data=Promise.all([this._loadFloatAccessorAsync("/accessors/".concat(o.index),o),this._loadFloatAccessorAsync("/accessors/".concat(a.index),a)]).then(function(s){var i=s[0],c=s[1];return{input:i,interpolation:r,output:c}}),n._data},t.prototype.loadBufferAsync=function(e,n,r,o){var a=this._extensionsLoadBufferAsync(e,n,r,o);if(a)return a;if(!n._data)if(n.uri)n._data=this.loadUriAsync("".concat(e,"/uri"),n,n.uri);else{if(!this._bin)throw new Error("".concat(e,": Uri is missing or the binary glTF is missing its binary chunk"));n._data=this._bin.readAsync(0,n.byteLength)}return n._data.then(function(s){try{return new Uint8Array(s.buffer,s.byteOffset+r,o)}catch(i){throw new Error("".concat(e,": ").concat(i.message))}})},t.prototype.loadBufferViewAsync=function(e,n){var r=this._extensionsLoadBufferViewAsync(e,n);if(r)return r;if(n._data)return n._data;var o=y.Get("".concat(e,"/buffer"),this._gltf.buffers,n.buffer);return n._data=this.loadBufferAsync("/buffers/".concat(o.index),o,n.byteOffset||0,n.byteLength),n._data},t.prototype._loadAccessorAsync=function(e,n,r){var o=this;if(n._data)return n._data;var a=t._GetNumComponents(e,n.type),s=a*w.GetTypeByteLength(n.componentType),i=a*n.count;if(n.bufferView==null)n._data=Promise.resolve(new r(i));else{var c=y.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/".concat(c.index),c).then(function(l){if(n.componentType===5126&&!n.normalized&&(!c.byteStride||c.byteStride===s))return t._GetTypedArray(e,n.componentType,l,n.byteOffset,i);var f=new r(i);return w.ForEach(l,n.byteOffset||0,c.byteStride||s,a,n.componentType,f.length,n.normalized||!1,function(d,h){f[h]=d}),f})}if(n.sparse){var u=n.sparse;n._data=n._data.then(function(l){var f=l,d=y.Get("".concat(e,"/sparse/indices/bufferView"),o._gltf.bufferViews,u.indices.bufferView),h=y.Get("".concat(e,"/sparse/values/bufferView"),o._gltf.bufferViews,u.values.bufferView);return Promise.all([o.loadBufferViewAsync("/bufferViews/".concat(d.index),d),o.loadBufferViewAsync("/bufferViews/".concat(h.index),h)]).then(function(_){var p=_[0],v=_[1],m=t._GetTypedArray("".concat(e,"/sparse/indices"),u.indices.componentType,p,u.indices.byteOffset,u.count),O=a*u.count,A;if(n.componentType===5126&&!n.normalized)A=t._GetTypedArray("".concat(e,"/sparse/values"),n.componentType,v,u.values.byteOffset,O);else{var T=t._GetTypedArray("".concat(e,"/sparse/values"),n.componentType,v,u.values.byteOffset,O);A=new r(O),w.ForEach(T,0,s,a,n.componentType,A.length,n.normalized||!1,function(F,E){A[E]=F})}for(var b=0,C=0;C<m.length;C++)for(var L=m[C]*a,N=0;N<a;N++)f[L++]=A[b++];return f})})}return n._data},t.prototype._loadFloatAccessorAsync=function(e,n){return this._loadAccessorAsync(e,n,Float32Array)},t.prototype._loadIndicesAccessorAsync=function(e,n){if(n.type!=="SCALAR")throw new Error("".concat(e,"/type: Invalid value ").concat(n.type));if(n.componentType!==5121&&n.componentType!==5123&&n.componentType!==5125)throw new Error("".concat(e,"/componentType: Invalid value ").concat(n.componentType));if(n._data)return n._data;if(n.sparse){var r=t._GetTypedArrayConstructor("".concat(e,"/componentType"),n.componentType);n._data=this._loadAccessorAsync(e,n,r)}else{var o=y.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/".concat(o.index),o).then(function(a){return t._GetTypedArray(e,n.componentType,a,n.byteOffset,n.count)})}return n._data},t.prototype._loadVertexBufferViewAsync=function(e,n){var r=this;return e._babylonBuffer||(e._babylonBuffer=this.loadBufferViewAsync("/bufferViews/".concat(e.index),e).then(function(o){return new or(r._babylonScene.getEngine(),o,!1)})),e._babylonBuffer},t.prototype._loadVertexAccessorAsync=function(e,n,r){var o=this,a;if((a=n._babylonVertexBuffer)===null||a===void 0?void 0:a[r])return n._babylonVertexBuffer[r];if(n._babylonVertexBuffer||(n._babylonVertexBuffer={}),n.sparse)n._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(e,n).then(function(i){return new w(o._babylonScene.getEngine(),i,r,!1)});else if(r===w.MatricesIndicesKind||r===w.MatricesIndicesExtraKind)n._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(e,n).then(function(i){return new w(o._babylonScene.getEngine(),i,r,!1)});else{var s=y.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._babylonVertexBuffer[r]=this._loadVertexBufferViewAsync(s,r).then(function(i){var c=t._GetNumComponents(e,n.type);return new w(o._babylonScene.getEngine(),i,r,!1,!1,s.byteStride,!1,n.byteOffset,c,n.componentType,n.normalized,!0,1,!0)})}return n._babylonVertexBuffer[r]},t.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return n&&(n.baseColorFactor?(r.albedoColor=x.FromArray(n.baseColorFactor),r.alpha=n.baseColorFactor[3]):r.albedoColor=x.White(),r.metallic=n.metallicFactor==null?1:n.metallicFactor,r.roughness=n.roughnessFactor==null?1:n.roughnessFactor,n.baseColorTexture&&o.push(this.loadTextureInfoAsync("".concat(e,"/baseColorTexture"),n.baseColorTexture,function(a){a.name="".concat(r.name," (Base Color)"),r.albedoTexture=a})),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture.nonColorData=!0,o.push(this.loadTextureInfoAsync("".concat(e,"/metallicRoughnessTexture"),n.metallicRoughnessTexture,function(a){a.name="".concat(r.name," (Metallic Roughness)"),r.metallicTexture=a})),r.useMetallnessFromMetallicTextureBlue=!0,r.useRoughnessFromMetallicTextureGreen=!0,r.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(o).then(function(){})},t.prototype._loadMaterialAsync=function(e,n,r,o,a){a===void 0&&(a=function(){});var s=this._extensionsLoadMaterialAsync(e,n,r,o,a);if(s)return s;n._data=n._data||{};var i=n._data[o];if(!i){this.logOpen("".concat(e," ").concat(n.name||""));var c=this.createMaterial(e,n,o);i={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,n,c)},n._data[o]=i,t.AddPointerMetadata(c,e),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return r&&(i.babylonMeshes.push(r),r.onDisposeObservable.addOnce(function(){var u=i.babylonMeshes.indexOf(r);u!==-1&&i.babylonMeshes.splice(u,1)})),a(i.babylonMaterial),i.promise.then(function(){return i.babylonMaterial})},t.prototype._createDefaultMaterial=function(e,n){this._babylonScene._blockEntityCollection=!!this._assetContainer;var r=new D(e,this._babylonScene);return r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.fillMode=n,r.enableSpecularAntiAliasing=!0,r.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,r.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,r.transparencyMode=D.PBRMATERIAL_OPAQUE,r.metallic=1,r.roughness=1,r},t.prototype.createMaterial=function(e,n,r){var o=this._extensionsCreateMaterial(e,n,r);if(o)return o;var a=n.name||"material".concat(n.index),s=this._createDefaultMaterial(a,r);return s},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this._extensionsLoadMaterialPropertiesAsync(e,n,r);if(o)return o;var a=new Array;return a.push(this.loadMaterialBasePropertiesAsync(e,n,r)),n.pbrMetallicRoughness&&a.push(this._loadMaterialMetallicRoughnessPropertiesAsync("".concat(e,"/pbrMetallicRoughness"),n.pbrMetallicRoughness,r)),this.loadMaterialAlphaProperties(e,n,r),Promise.all(a).then(function(){})},t.prototype.loadMaterialBasePropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return r.emissiveColor=n.emissiveFactor?x.FromArray(n.emissiveFactor):new x(0,0,0),n.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),n.normalTexture&&(n.normalTexture.nonColorData=!0,o.push(this.loadTextureInfoAsync("".concat(e,"/normalTexture"),n.normalTexture,function(a){a.name="".concat(r.name," (Normal)"),r.bumpTexture=a})),r.invertNormalMapX=!this._babylonScene.useRightHandedSystem,r.invertNormalMapY=this._babylonScene.useRightHandedSystem,n.normalTexture.scale!=null&&(r.bumpTexture.level=n.normalTexture.scale),r.forceIrradianceInFragment=!0),n.occlusionTexture&&(n.occlusionTexture.nonColorData=!0,o.push(this.loadTextureInfoAsync("".concat(e,"/occlusionTexture"),n.occlusionTexture,function(a){a.name="".concat(r.name," (Occlusion)"),r.ambientTexture=a})),r.useAmbientInGrayScale=!0,n.occlusionTexture.strength!=null&&(r.ambientTextureStrength=n.occlusionTexture.strength)),n.emissiveTexture&&o.push(this.loadTextureInfoAsync("".concat(e,"/emissiveTexture"),n.emissiveTexture,function(a){a.name="".concat(r.name," (Emissive)"),r.emissiveTexture=a})),Promise.all(o).then(function(){})},t.prototype.loadMaterialAlphaProperties=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=n.alphaMode||"OPAQUE";switch(o){case"OPAQUE":{r.transparencyMode=D.PBRMATERIAL_OPAQUE;break}case"MASK":{r.transparencyMode=D.PBRMATERIAL_ALPHATEST,r.alphaCutOff=n.alphaCutoff==null?.5:n.alphaCutoff,r.albedoTexture&&(r.albedoTexture.hasAlpha=!0);break}case"BLEND":{r.transparencyMode=D.PBRMATERIAL_ALPHABLEND,r.albedoTexture&&(r.albedoTexture.hasAlpha=!0,r.useAlphaFromAlbedoTexture=!0);break}default:throw new Error("".concat(e,"/alphaMode: Invalid value (").concat(n.alphaMode,")"))}},t.prototype.loadTextureInfoAsync=function(e,n,r){var o=this;r===void 0&&(r=function(){});var a=this._extensionsLoadTextureInfoAsync(e,n,r);if(a)return a;if(this.logOpen("".concat(e)),n.texCoord>=6)throw new Error("".concat(e,"/texCoord: Invalid value (").concat(n.texCoord,")"));var s=y.Get("".concat(e,"/index"),this._gltf.textures,n.index);s._textureInfo=n;var i=this._loadTextureAsync("/textures/".concat(n.index),s,function(c){c.coordinatesIndex=n.texCoord||0,t.AddPointerMetadata(c,e),o._parent.onTextureLoadedObservable.notifyObservers(c),r(c)});return this.logClose(),i},t.prototype._loadTextureAsync=function(e,n,r){r===void 0&&(r=function(){});var o=this._extensionsLoadTextureAsync(e,n,r);if(o)return o;this.logOpen("".concat(e," ").concat(n.name||""));var a=n.sampler==null?t.DefaultSampler:y.Get("".concat(e,"/sampler"),this._gltf.samplers,n.sampler),s=y.Get("".concat(e,"/source"),this._gltf.images,n.source),i=this._createTextureAsync(e,a,s,r,void 0,!n._textureInfo.nonColorData);return this.logClose(),i},t.prototype._createTextureAsync=function(e,n,r,o,a,s){var i=this;o===void 0&&(o=function(){});var c=this._loadSampler("/samplers/".concat(n.index),n),u=new Array,l=new pe;this._babylonScene._blockEntityCollection=!!this._assetContainer;var f={noMipmap:c.noMipMaps,invertY:!1,samplingMode:c.samplingMode,onLoad:function(){i._disposed||l.resolve()},onError:function(h,_){i._disposed||l.reject(new Error("".concat(e,": ").concat(_&&_.message?_.message:h||"Failed to load texture")))},mimeType:r.mimeType,loaderOptions:a,useSRGBBuffer:!!s&&this._parent.useSRGBBuffers},d=new P(null,this._babylonScene,f);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u.push(l.promise),u.push(this.loadImageAsync("/images/".concat(r.index),r).then(function(h){var _=r.uri||"".concat(i._fileName,"#image").concat(r.index),p="data:".concat(i._uniqueRootUrl).concat(_);d.updateURL(p,h)})),d.wrapU=c.wrapU,d.wrapV=c.wrapV,o(d),Promise.all(u).then(function(){return d})},t.prototype._loadSampler=function(e,n){return n._data||(n._data={noMipMaps:n.minFilter===9728||n.minFilter===9729,samplingMode:t._GetTextureSamplingMode(e,n),wrapU:t._GetTextureWrapMode("".concat(e,"/wrapS"),n.wrapS),wrapV:t._GetTextureWrapMode("".concat(e,"/wrapT"),n.wrapT)}),n._data},t.prototype.loadImageAsync=function(e,n){if(!n._data){if(this.logOpen("".concat(e," ").concat(n.name||"")),n.uri)n._data=this.loadUriAsync("".concat(e,"/uri"),n,n.uri);else{var r=y.Get("".concat(e,"/bufferView"),this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/".concat(r.index),r)}this.logClose()}return n._data},t.prototype.loadUriAsync=function(e,n,r){var o=this,a=this._extensionsLoadUriAsync(e,n,r);if(a)return a;if(!t._ValidateUri(r))throw new Error("".concat(e,": '").concat(r,"' is invalid"));if(ar(r)){var s=new Uint8Array(En(r));return this.log("".concat(e,": Decoded ").concat(r.substr(0,64),"... (").concat(s.length," bytes)")),Promise.resolve(s)}return this.log("".concat(e,": Loading ").concat(r)),this._parent.preprocessUrlAsync(this._rootUrl+r).then(function(i){return new Promise(function(c,u){o._parent._loadFile(o._babylonScene,i,function(l){o._disposed||(o.log("".concat(e,": Loaded ").concat(r," (").concat(l.byteLength," bytes)")),c(new Uint8Array(l)))},!0,function(l){u(new sr("".concat(e,": Failed to load '").concat(r,"'").concat(l?": "+l.status+" "+l.statusText:""),l))})})})},t.AddPointerMetadata=function(e,n){var r=e.metadata=e.metadata||{},o=r.gltf=r.gltf||{},a=o.pointers=o.pointers||[];a.push(n)},t._GetTextureWrapMode=function(e,n){switch(n=n==null?10497:n,n){case 33071:return P.CLAMP_ADDRESSMODE;case 33648:return P.MIRROR_ADDRESSMODE;case 10497:return P.WRAP_ADDRESSMODE;default:return K.Warn("".concat(e,": Invalid value (").concat(n,")")),P.WRAP_ADDRESSMODE}},t._GetTextureSamplingMode=function(e,n){var r=n.magFilter==null?9729:n.magFilter,o=n.minFilter==null?9987:n.minFilter;if(r===9729)switch(o){case 9728:return P.LINEAR_NEAREST;case 9729:return P.LINEAR_LINEAR;case 9984:return P.LINEAR_NEAREST_MIPNEAREST;case 9985:return P.LINEAR_LINEAR_MIPNEAREST;case 9986:return P.LINEAR_NEAREST_MIPLINEAR;case 9987:return P.LINEAR_LINEAR_MIPLINEAR;default:return K.Warn("".concat(e,"/minFilter: Invalid value (").concat(o,")")),P.LINEAR_LINEAR_MIPLINEAR}else switch(r!==9728&&K.Warn("".concat(e,"/magFilter: Invalid value (").concat(r,")")),o){case 9728:return P.NEAREST_NEAREST;case 9729:return P.NEAREST_LINEAR;case 9984:return P.NEAREST_NEAREST_MIPNEAREST;case 9985:return P.NEAREST_LINEAR_MIPNEAREST;case 9986:return P.NEAREST_NEAREST_MIPLINEAR;case 9987:return P.NEAREST_LINEAR_MIPLINEAR;default:return K.Warn("".concat(e,"/minFilter: Invalid value (").concat(o,")")),P.NEAREST_NEAREST_MIPNEAREST}},t._GetTypedArrayConstructor=function(e,n){switch(n){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error("".concat(e,": Invalid component type ").concat(n))}},t._GetTypedArray=function(e,n,r,o,a){var s=r.buffer;o=r.byteOffset+(o||0);var i=t._GetTypedArrayConstructor("".concat(e,"/componentType"),n),c=w.GetTypeByteLength(n);return o%c!=0?(K.Warn("".concat(e,": Copying buffer as byte offset (").concat(o,") is not a multiple of component type byte length (").concat(c,")")),new i(s.slice(o,o+a*c),0)):new i(s,o,a)},t._GetNumComponents=function(e,n){switch(n){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error("".concat(e,": Invalid type (").concat(n,")"))},t._ValidateUri=function(e){return M.IsBase64(e)||e.indexOf("..")===-1},t._GetDrawMode=function(e,n){switch(n==null&&(n=4),n){case 0:return Y.PointListDrawMode;case 1:return Y.LineListDrawMode;case 2:return Y.LineLoopDrawMode;case 3:return Y.LineStripDrawMode;case 4:return Y.TriangleFillMode;case 5:return Y.TriangleStripDrawMode;case 6:return Y.TriangleFanDrawMode}throw new Error("".concat(e,": Invalid mesh primitive mode (").concat(n,")"))},t.prototype._compileMaterialsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile materials");var n=new Array;if(this._gltf.materials)for(var r=0,o=this._gltf.materials;r<o.length;r++){var a=o[r];if(a._data)for(var s in a._data)for(var i=a._data[s],c=0,u=i.babylonMeshes;c<u.length;c++){var l=u[c];l.computeWorldMatrix(!0);var f=i.babylonMaterial;n.push(f.forceCompilationAsync(l)),n.push(f.forceCompilationAsync(l,{useInstances:!0})),this._parent.useClipPlane&&(n.push(f.forceCompilationAsync(l,{clipPlane:!0})),n.push(f.forceCompilationAsync(l,{clipPlane:!0,useInstances:!0})))}}return Promise.all(n).then(function(){e._parent._endPerformanceCounter("Compile materials")})},t.prototype._compileShadowGeneratorsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var n=new Array,r=this._babylonScene.lights,o=0,a=r;o<a.length;o++){var s=a[o],i=s.getShadowGenerator();i&&n.push(i.forceCompilationAsync())}return Promise.all(n).then(function(){e._parent._endPerformanceCounter("Compile shadow generators")})},t.prototype._forEachExtensions=function(e){for(var n=0,r=this._extensions;n<r.length;n++){var o=r[n];o.enabled&&e(o)}},t.prototype._applyExtensions=function(e,n,r){for(var o=0,a=this._extensions;o<a.length;o++){var s=a[o];if(s.enabled){var i="".concat(s.name,".").concat(n),c=e;c._activeLoaderExtensionFunctions=c._activeLoaderExtensionFunctions||{};var u=c._activeLoaderExtensionFunctions;if(!u[i]){u[i]=!0;try{var l=r(s);if(l)return l}finally{delete u[i]}}}}return null},t.prototype._extensionsOnLoading=function(){this._forEachExtensions(function(e){return e.onLoading&&e.onLoading()})},t.prototype._extensionsOnReady=function(){this._forEachExtensions(function(e){return e.onReady&&e.onReady()})},t.prototype._extensionsLoadSceneAsync=function(e,n){return this._applyExtensions(n,"loadScene",function(r){return r.loadSceneAsync&&r.loadSceneAsync(e,n)})},t.prototype._extensionsLoadNodeAsync=function(e,n,r){return this._applyExtensions(n,"loadNode",function(o){return o.loadNodeAsync&&o.loadNodeAsync(e,n,r)})},t.prototype._extensionsLoadCameraAsync=function(e,n,r){return this._applyExtensions(n,"loadCamera",function(o){return o.loadCameraAsync&&o.loadCameraAsync(e,n,r)})},t.prototype._extensionsLoadVertexDataAsync=function(e,n,r){return this._applyExtensions(n,"loadVertexData",function(o){return o._loadVertexDataAsync&&o._loadVertexDataAsync(e,n,r)})},t.prototype._extensionsLoadMeshPrimitiveAsync=function(e,n,r,o,a,s){return this._applyExtensions(a,"loadMeshPrimitive",function(i){return i._loadMeshPrimitiveAsync&&i._loadMeshPrimitiveAsync(e,n,r,o,a,s)})},t.prototype._extensionsLoadMaterialAsync=function(e,n,r,o,a){return this._applyExtensions(n,"loadMaterial",function(s){return s._loadMaterialAsync&&s._loadMaterialAsync(e,n,r,o,a)})},t.prototype._extensionsCreateMaterial=function(e,n,r){return this._applyExtensions(n,"createMaterial",function(o){return o.createMaterial&&o.createMaterial(e,n,r)})},t.prototype._extensionsLoadMaterialPropertiesAsync=function(e,n,r){return this._applyExtensions(n,"loadMaterialProperties",function(o){return o.loadMaterialPropertiesAsync&&o.loadMaterialPropertiesAsync(e,n,r)})},t.prototype._extensionsLoadTextureInfoAsync=function(e,n,r){return this._applyExtensions(n,"loadTextureInfo",function(o){return o.loadTextureInfoAsync&&o.loadTextureInfoAsync(e,n,r)})},t.prototype._extensionsLoadTextureAsync=function(e,n,r){return this._applyExtensions(n,"loadTexture",function(o){return o._loadTextureAsync&&o._loadTextureAsync(e,n,r)})},t.prototype._extensionsLoadAnimationAsync=function(e,n){return this._applyExtensions(n,"loadAnimation",function(r){return r.loadAnimationAsync&&r.loadAnimationAsync(e,n)})},t.prototype._extensionsLoadSkinAsync=function(e,n,r){return this._applyExtensions(r,"loadSkin",function(o){return o._loadSkinAsync&&o._loadSkinAsync(e,n,r)})},t.prototype._extensionsLoadUriAsync=function(e,n,r){return this._applyExtensions(n,"loadUri",function(o){return o._loadUriAsync&&o._loadUriAsync(e,n,r)})},t.prototype._extensionsLoadBufferViewAsync=function(e,n){return this._applyExtensions(n,"loadBufferView",function(r){return r.loadBufferViewAsync&&r.loadBufferViewAsync(e,n)})},t.prototype._extensionsLoadBufferAsync=function(e,n,r,o){return this._applyExtensions(n,"loadBuffer",function(a){return a.loadBufferAsync&&a.loadBufferAsync(e,n,r,o)})},t.LoadExtensionAsync=function(e,n,r,o){if(!n.extensions)return null;var a=n.extensions,s=a[r];return s?o("".concat(e,"/extensions/").concat(r),s):null},t.LoadExtraAsync=function(e,n,r,o){if(!n.extras)return null;var a=n.extras,s=a[r];return s?o("".concat(e,"/extras/").concat(r),s):null},t.prototype.isExtensionUsed=function(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1},t.prototype.logOpen=function(e){this._parent._logOpen(e)},t.prototype.logClose=function(){this._parent._logClose()},t.prototype.log=function(e){this._parent._log(e)},t.prototype.startPerformanceCounter=function(e){this._parent._startPerformanceCounter(e)},t.prototype.endPerformanceCounter=function(e){this._parent._endPerformanceCounter(e)},t._RegisteredExtensions={},t.DefaultSampler={index:-1},t}();ae._CreateGLTF2Loader=function(t){return new g(t)};var ke="EXT_lights_image_based",Wr=function(){function t(e){this.name=ke,this._loader=e,this.enabled=this._loader.isExtensionUsed(ke)}return t.prototype.dispose=function(){this._loader=null,delete this._lights},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._lights=n.lights}},t.prototype.loadSceneAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,a){var s=new Array;s.push(r._loader.loadSceneAsync(e,n)),r._loader.logOpen("".concat(o));var i=y.Get("".concat(o,"/light"),r._lights,a.light);return s.push(r._loadLightAsync("/extensions/".concat(r.name,"/lights/").concat(a.light),i).then(function(c){r._loader.babylonScene.environmentTexture=c})),r._loader.logClose(),Promise.all(s).then(function(){})})},t.prototype._loadLightAsync=function(e,n){var r=this;if(!n._loaded){var o=new Array;this._loader.logOpen("".concat(e));for(var a=new Array(n.specularImages.length),s=function(u){var l=n.specularImages[u];a[u]=new Array(l.length);for(var f=function(h){var _="".concat(e,"/specularImages/").concat(u,"/").concat(h);i._loader.logOpen("".concat(_));var p=l[h],v=y.Get(_,i._loader.gltf.images,p);o.push(i._loader.loadImageAsync("/images/".concat(p),v).then(function(m){a[u][h]=m})),i._loader.logClose()},d=0;d<l.length;d++)f(d)},i=this,c=0;c<n.specularImages.length;c++)s(c);this._loader.logClose(),n._loaded=Promise.all(o).then(function(){var u=new lr(r._loader.babylonScene,null,n.specularImageSize);if(u.name=n.name||"environment",n._babylonTexture=u,n.intensity!=null&&(u.level=n.intensity),n.rotation){var l=j.FromArray(n.rotation);r._loader.babylonScene.useRightHandedSystem||(l=j.Inverse(l)),W.FromQuaternionToRef(l,u.getReflectionTextureMatrix())}if(!n.irradianceCoefficients)throw new Error("".concat(e,": Irradiance coefficients are missing"));var f=ur.FromArray(n.irradianceCoefficients);f.scaleInPlace(n.intensity),f.convertIrradianceToLambertianRadiance();var d=fr.FromHarmonics(f),h=(a.length-1)/dr.Log2(n.specularImageSize);return u.updateRGBDAsync(a,d,h)})}return n._loaded.then(function(){return n._babylonTexture})},t}();g.RegisterExtension(ke,function(t){return new Wr(t)});var He="EXT_mesh_gpu_instancing",jr=function(){function t(e){this.name=He,this._loader=e,this.enabled=this._loader.isExtensionUsed(He)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){o._loader._disableInstancedMesh++;var i=o._loader.loadNodeAsync("/nodes/".concat(n.index),n,r);if(o._loader._disableInstancedMesh--,!n._primitiveBabylonMeshes)return i;var c=new Array,u=0,l=function(f){if(s.attributes[f]==null){c.push(Promise.resolve(null));return}var d=y.Get("".concat(a,"/attributes/").concat(f),o._loader.gltf.accessors,s.attributes[f]);if(c.push(o._loader._loadFloatAccessorAsync("/accessors/".concat(d.bufferView),d)),u===0)u=d.count;else if(u!==d.count)throw new Error("".concat(a,"/attributes: Instance buffer accessors do not have the same count."))};return l("TRANSLATION"),l("ROTATION"),l("SCALE"),i.then(function(f){return Promise.all(c).then(function(d){var h=d[0],_=d[1],p=d[2],v=new Float32Array(u*16);Z.Vector3[0].copyFromFloats(0,0,0),Z.Quaternion[0].copyFromFloats(0,0,0,1),Z.Vector3[1].copyFromFloats(1,1,1);for(var m=0;m<u;++m)h&&S.FromArrayToRef(h,m*3,Z.Vector3[0]),_&&j.FromArrayToRef(_,m*4,Z.Quaternion[0]),p&&S.FromArrayToRef(p,m*3,Z.Vector3[1]),W.ComposeToRef(Z.Vector3[1],Z.Quaternion[0],Z.Vector3[0],Z.Matrix[0]),Z.Matrix[0].copyToArray(v,m*16);for(var O=0,A=n._primitiveBabylonMeshes;O<A.length;O++){var T=A[O];T.thinInstanceSetBuffer("matrix",v,16,!0)}return f})})})},t}();g.RegisterExtension(He,function(t){return new jr(t)});var Ke="EXT_meshopt_compression",qr=function(){function t(e){this.name=Ke,this.enabled=e.isExtensionUsed(Ke),this._loader=e}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadBufferViewAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,a){var s=n;if(s._meshOptData)return s._meshOptData;var i=y.Get("".concat(e,"/buffer"),r._loader.gltf.buffers,a.buffer);return s._meshOptData=r._loader.loadBufferAsync("/buffers/".concat(i.index),i,a.byteOffset||0,a.byteLength).then(function(c){return hr.Default.decodeGltfBufferAsync(c,a.count,a.byteStride,a.mode,a.filter)}),s._meshOptData})},t}();g.RegisterExtension(Ke,function(t){return new qr(t)});var We="EXT_texture_webp",Xr=function(){function t(e){this.name=We,this._loader=e,this.enabled=e.isExtensionUsed(We)}return t.prototype.dispose=function(){this._loader=null},t.prototype._loadTextureAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=n.sampler==null?g.DefaultSampler:y.Get("".concat(e,"/sampler"),o._loader.gltf.samplers,n.sampler),c=y.Get("".concat(a,"/source"),o._loader.gltf.images,s.source);return o._loader._createTextureAsync(e,i,c,function(u){r(u)},void 0,!n._textureInfo.nonColorData)})},t}();g.RegisterExtension(We,function(t){return new Xr(t)});var je="KHR_draco_mesh_compression",Jr=function(){function t(e){this.name=je,this._loader=e,this.enabled=Cn.DecoderAvailable&&this._loader.isExtensionUsed(je)}return t.prototype.dispose=function(){delete this.dracoCompression,this._loader=null},t.prototype._loadVertexDataAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){if(n.mode!=null){if(n.mode!==5&&n.mode!==4)throw new Error("".concat(e,": Unsupported mode ").concat(n.mode));if(n.mode===5)throw new Error("".concat(e,": Mode ").concat(n.mode," is not currently supported"))}var i={},c={},u=function(f,d){var h=s.attributes[f];if(!(h===void 0||n.attributes[f]===void 0)){i[d]=h;var _=y.Get("".concat(e,"/attributes/").concat(f),o._loader.gltf.accessors,n.attributes[f]);if(_.normalized&&_.componentType!==5126){var p=1;switch(_.componentType){case 5120:p=127;break;case 5121:p=255;break;case 5122:p=32767;break;case 5123:p=65535;break}c[d]=p}r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(d)===-1&&r._delayInfo.push(d)}};u("POSITION",w.PositionKind),u("NORMAL",w.NormalKind),u("TANGENT",w.TangentKind),u("TEXCOORD_0",w.UVKind),u("TEXCOORD_1",w.UV2Kind),u("TEXCOORD_2",w.UV3Kind),u("TEXCOORD_3",w.UV4Kind),u("TEXCOORD_4",w.UV5Kind),u("TEXCOORD_5",w.UV6Kind),u("JOINTS_0",w.MatricesIndicesKind),u("WEIGHTS_0",w.MatricesWeightsKind),u("COLOR_0",w.ColorKind);var l=y.Get(a,o._loader.gltf.bufferViews,s.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=o._loader.loadBufferViewAsync("/bufferViews/".concat(l.index),l).then(function(f){var d=o.dracoCompression||Cn.Default;return d.decodeMeshAsync(f,i,c).then(function(h){var _=new Ie(r.name,o._loader.babylonScene);return h.applyToGeometry(_),_}).catch(function(h){throw new Error("".concat(e,": ").concat(h.message))})})),l._dracoBabylonGeometry})},t}();g.RegisterExtension(je,function(t){return new Jr(t)});var qe="KHR_lights_punctual",zr=function(){function t(e){this.name=qe,this._loader=e,this.enabled=this._loader.isExtensionUsed(qe)}return t.prototype.dispose=function(){this._loader=null,delete this._lights},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._lights=n.lights}},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){return o._loader.loadNodeAsync(e,n,function(i){var c,u=y.Get(a,o._lights,s.light),l=u.name||i.name;switch(o._loader.babylonScene._blockEntityCollection=!!o._loader._assetContainer,u.type){case"directional":{c=new ge(l,S.Backward(),o._loader.babylonScene);break}case"point":{c=new Me(l,S.Zero(),o._loader.babylonScene);break}case"spot":{var f=new xe(l,S.Zero(),S.Backward(),0,1,o._loader.babylonScene);f.angle=(u.spot&&u.spot.outerConeAngle||Math.PI/4)*2,f.innerAngle=(u.spot&&u.spot.innerConeAngle||0)*2,c=f;break}default:throw o._loader.babylonScene._blockEntityCollection=!1,new Error("".concat(a,": Invalid light type (").concat(u.type,")"))}c._parentContainer=o._loader._assetContainer,o._loader.babylonScene._blockEntityCollection=!1,c.falloffType=_r.FALLOFF_GLTF,c.diffuse=u.color?x.FromArray(u.color):x.White(),c.intensity=u.intensity==null?1:u.intensity,c.range=u.range==null?Number.MAX_VALUE:u.range,c.parent=i,o._loader._babylonLights.push(c),g.AddPointerMetadata(c,a),r(i)})})},t}();g.RegisterExtension(qe,function(t){return new zr(t)});var Xe="KHR_materials_pbrSpecularGlossiness",Yr=function(){function t(e){this.name=Xe,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xe)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loadSpecularGlossinessPropertiesAsync(a,n,s,r)),o._loader.loadMaterialAlphaProperties(e,n,r),Promise.all(i).then(function(){})})},t.prototype._loadSpecularGlossinessPropertiesAsync=function(e,n,r,o){if(!(o instanceof D))throw new Error("".concat(e,": Material type not supported"));var a=new Array;return o.metallic=null,o.roughness=null,r.diffuseFactor?(o.albedoColor=x.FromArray(r.diffuseFactor),o.alpha=r.diffuseFactor[3]):o.albedoColor=x.White(),o.reflectivityColor=r.specularFactor?x.FromArray(r.specularFactor):x.White(),o.microSurface=r.glossinessFactor==null?1:r.glossinessFactor,r.diffuseTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(e,"/diffuseTexture"),r.diffuseTexture,function(s){s.name="".concat(o.name," (Diffuse)"),o.albedoTexture=s})),r.specularGlossinessTexture&&(a.push(this._loader.loadTextureInfoAsync("".concat(e,"/specularGlossinessTexture"),r.specularGlossinessTexture,function(s){s.name="".concat(o.name," (Specular Glossiness)"),o.reflectivityTexture=s})),o.reflectivityTexture.hasAlpha=!0,o.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(a).then(function(){})},t}();g.RegisterExtension(Xe,function(t){return new Yr(t)});var Je="KHR_materials_unlit",Zr=function(){function t(e){this.name=Je,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Je)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(){return o._loadUnlitPropertiesAsync(e,n,r)})},t.prototype._loadUnlitPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;r.unlit=!0;var a=n.pbrMetallicRoughness;return a&&(a.baseColorFactor?(r.albedoColor=x.FromArray(a.baseColorFactor),r.alpha=a.baseColorFactor[3]):r.albedoColor=x.White(),a.baseColorTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/baseColorTexture"),a.baseColorTexture,function(s){s.name="".concat(r.name," (Base Color)"),r.albedoTexture=s}))),n.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,n,r),Promise.all(o).then(function(){})},t}();g.RegisterExtension(Je,function(t){return new Zr(t)});var ze="KHR_materials_clearcoat",$r=function(){function t(e){this.name=ze,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ze)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadClearCoatPropertiesAsync(a,s,r)),Promise.all(i).then(function(){})})},t.prototype._loadClearCoatPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return r.clearCoat.isEnabled=!0,r.clearCoat.useRoughnessFromMainTexture=!1,r.clearCoat.remapF0OnInterfaceChange=!1,n.clearcoatFactor!=null?r.clearCoat.intensity=n.clearcoatFactor:r.clearCoat.intensity=0,n.clearcoatTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/clearcoatTexture"),n.clearcoatTexture,function(a){a.name="".concat(r.name," (ClearCoat Intensity)"),r.clearCoat.texture=a})),n.clearcoatRoughnessFactor!=null?r.clearCoat.roughness=n.clearcoatRoughnessFactor:r.clearCoat.roughness=0,n.clearcoatRoughnessTexture&&(n.clearcoatRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/clearcoatRoughnessTexture"),n.clearcoatRoughnessTexture,function(a){a.name="".concat(r.name," (ClearCoat Roughness)"),r.clearCoat.textureRoughness=a}))),n.clearcoatNormalTexture&&(n.clearcoatNormalTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/clearcoatNormalTexture"),n.clearcoatNormalTexture,function(a){a.name="".concat(r.name," (ClearCoat Normal)"),r.clearCoat.bumpTexture=a})),r.invertNormalMapX=!r.getScene().useRightHandedSystem,r.invertNormalMapY=r.getScene().useRightHandedSystem,n.clearcoatNormalTexture.scale!=null&&(r.clearCoat.bumpTexture.level=n.clearcoatNormalTexture.scale)),Promise.all(o).then(function(){})},t}();g.RegisterExtension(ze,function(t){return new $r(t)});var Ye="KHR_materials_emissive_strength",Qr=function(){function t(e){this.name=Ye,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ye)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){return o._loader.loadMaterialPropertiesAsync(e,n,r).then(function(){o._loadEmissiveProperties(a,s,r)})})},t.prototype._loadEmissiveProperties=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));n.emissiveStrength!==void 0&&r.emissiveColor.scaleToRef(n.emissiveStrength,r.emissiveColor)},t}();g.RegisterExtension(Ye,function(t){return new Qr(t)});var Ze="KHR_materials_sheen",et=function(){function t(e){this.name=Ze,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ze)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadSheenPropertiesAsync(a,s,r)),Promise.all(i).then(function(){})})},t.prototype._loadSheenPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return r.sheen.isEnabled=!0,r.sheen.intensity=1,n.sheenColorFactor!=null?r.sheen.color=x.FromArray(n.sheenColorFactor):r.sheen.color=x.Black(),n.sheenColorTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/sheenColorTexture"),n.sheenColorTexture,function(a){a.name="".concat(r.name," (Sheen Color)"),r.sheen.texture=a})),n.sheenRoughnessFactor!==void 0?r.sheen.roughness=n.sheenRoughnessFactor:r.sheen.roughness=0,n.sheenRoughnessTexture&&(n.sheenRoughnessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/sheenRoughnessTexture"),n.sheenRoughnessTexture,function(a){a.name="".concat(r.name," (Sheen Roughness)"),r.sheen.textureRoughness=a}))),r.sheen.albedoScaling=!0,r.sheen.useRoughnessFromMainTexture=!1,Promise.all(o).then(function(){})},t}();g.RegisterExtension(Ze,function(t){return new et(t)});var $e="KHR_materials_specular",nt=function(){function t(e){this.name=$e,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed($e)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadSpecularPropertiesAsync(a,s,r)),Promise.all(i).then(function(){})})},t.prototype._loadSpecularPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var o=new Array;return n.specularFactor!==void 0&&(r.metallicF0Factor=n.specularFactor),n.specularColorFactor!==void 0&&(r.metallicReflectanceColor=x.FromArray(n.specularColorFactor)),n.specularTexture&&(n.specularTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync("".concat(e,"/specularTexture"),n.specularTexture,function(a){a.name="".concat(r.name," (Specular F0 Strength)"),r.metallicReflectanceTexture=a,r.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),n.specularColorTexture&&o.push(this._loader.loadTextureInfoAsync("".concat(e,"/specularColorTexture"),n.specularColorTexture,function(a){a.name="".concat(r.name," (Specular F0 Color)"),r.reflectanceTexture=a})),Promise.all(o).then(function(){})},t}();g.RegisterExtension($e,function(t){return new nt(t)});var Qe="KHR_materials_ior",rt=function(){function t(e){this.name=Qe,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qe)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadIorPropertiesAsync(a,s,r)),Promise.all(i).then(function(){})})},t.prototype._loadIorPropertiesAsync=function(e,n,r){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));return n.ior!==void 0?r.indexOfRefraction=n.ior:r.indexOfRefraction=t._DEFAULT_IOR,Promise.resolve()},t._DEFAULT_IOR=1.5,t}();g.RegisterExtension(Qe,function(t){return new rt(t)});var X="KHR_materials_variants",tt=function(){function t(e){this.name=X,this._loader=e,this.enabled=this._loader.isExtensionUsed(X)}return t.prototype.dispose=function(){this._loader=null},t.GetAvailableVariants=function(e){var n=this._GetExtensionMetadata(e);return n?Object.keys(n.variants):[]},t.prototype.getAvailableVariants=function(e){return t.GetAvailableVariants(e)},t.SelectVariant=function(e,n){var r=this._GetExtensionMetadata(e);if(!r)throw new Error("Cannot select variant on a glTF mesh that does not have the ".concat(X," extension"));var o=function(c){var u=r.variants[c];if(u)for(var l=0,f=u;l<f.length;l++){var d=f[l];d.mesh.material=d.material}};if(n instanceof Array)for(var a=0,s=n;a<s.length;a++){var i=s[a];o(i)}else o(n);r.lastSelected=n},t.prototype.selectVariant=function(e,n){return t.SelectVariant(e,n)},t.Reset=function(e){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot reset on a glTF mesh that does not have the ".concat(X," extension"));for(var r=0,o=n.original;r<o.length;r++){var a=o[r];a.mesh.material=a.material}n.lastSelected=null},t.prototype.reset=function(e){return t.Reset(e)},t.GetLastSelectedVariant=function(e){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the ".concat(X," extension"));return n.lastSelected},t.prototype.getLastSelectedVariant=function(e){return t.GetLastSelectedVariant(e)},t._GetExtensionMetadata=function(e){var n,r;return((r=(n=e==null?void 0:e.metadata)===null||n===void 0?void 0:n.gltf)===null||r===void 0?void 0:r[X])||null},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._variants=n.variants}},t.prototype._loadMeshPrimitiveAsync=function(e,n,r,o,a,s){var i=this;return g.LoadExtensionAsync(e,a,this.name,function(c,u){var l=new Array;return l.push(i._loader._loadMeshPrimitiveAsync(e,n,r,o,a,function(f){if(s(f),f instanceof fe){var d=g._GetDrawMode(e,a.mode),h=i._loader.rootBabylonMesh,_=h?h.metadata=h.metadata||{}:{},p=_.gltf=_.gltf||{},v=p[X]=p[X]||{lastSelected:null,original:[],variants:{}};v.original.push({mesh:f,material:f.material});for(var m=function(A){var T=u.mappings[A],b=y.Get("".concat(c,"/mappings/").concat(A,"/material"),i._loader.gltf.materials,T.material);l.push(i._loader._loadMaterialAsync("#/materials/".concat(T.material),b,f,d,function(C){for(var L=function(F){var E=T.variants[F],G=y.Get("/extensions/".concat(X,"/variants/").concat(E),i._variants,E);v.variants[G.name]=v.variants[G.name]||[],v.variants[G.name].push({mesh:f,material:C}),f.onClonedObservable.add(function(k){var ne=k,$=null,H=ne;do{if(H=H.parent,!H)return;$=t._GetExtensionMetadata(H)}while($===null);if(h&&$===t._GetExtensionMetadata(h)){H.metadata={};for(var B in h.metadata)H.metadata[B]=h.metadata[B];H.metadata.gltf=[];for(var B in h.metadata.gltf)H.metadata.gltf[B]=h.metadata.gltf[B];H.metadata.gltf[X]={lastSelected:null,original:[],variants:{}};for(var ce=0,I=$.original;ce<I.length;ce++){var dn=I[ce];H.metadata.gltf[X].original.push({mesh:dn.mesh,material:dn.material})}for(var B in $.variants)if($.variants.hasOwnProperty(B)){H.metadata.gltf[X].variants[B]=[];for(var Te=0,hn=$.variants[B];Te<hn.length;Te++){var _n=hn[Te];H.metadata.gltf[X].variants[B].push({mesh:_n.mesh,material:_n.material})}}$=H.metadata.gltf[X]}for(var Oe=0,pn=$.original;Oe<pn.length;Oe++){var he=pn[Oe];he.mesh===f&&(he.mesh=ne)}for(var Se=0,vn=$.variants[G.name];Se<vn.length;Se++){var he=vn[Se];he.mesh===f&&(he.mesh=ne)}})},N=0;N<T.variants.length;++N)L(N)}))},O=0;O<u.mappings.length;++O)m(O)}})),Promise.all(l).then(function(f){var d=f[0];return d})})},t}();g.RegisterExtension(X,function(t){return new tt(t)});var ot=function(){function t(e,n){var r=this;this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=Ee(Ee({},t._getDefaultOptions()),e),this._scene=n,this._scene._transmissionHelper=this,this.onErrorObservable=new U,this._scene.onDisposeObservable.addOnce(function(o){r.dispose()}),this._parseScene(),this._setupRenderTargets()}return t._getDefaultOptions=function(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ue.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}},t.prototype.updateOptions=function(e){var n=this,r=Object.keys(e).filter(function(s){return n._options[s]!==e[s]});if(!!r.length){var o=Ee(Ee({},this._options),e),a=this._options;this._options=o,o.renderSize!==a.renderSize||o.renderTargetTextureType!==a.renderTargetTextureType||o.generateMipmaps!==a.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=o.samples,this._opaqueRenderTarget.lodGenerationScale=o.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=o.lodGenerationOffset)}},t.prototype.getOpaqueTarget=function(){return this._opaqueRenderTarget},t.prototype.shouldRenderAsTransmission=function(e){return e?!!(e instanceof D&&e.subSurface.isRefractionEnabled):!1},t.prototype._addMesh=function(e){var n=this;this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),M.SetImmediate(function(){n.shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=n._opaqueRenderTarget,n._transparentMeshesCache.push(e)):n._opaqueMeshesCache.push(e)})},t.prototype._removeMesh=function(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];var n=this._transparentMeshesCache.indexOf(e);n!==-1&&this._transparentMeshesCache.splice(n,1),n=this._opaqueMeshesCache.indexOf(e),n!==-1&&this._opaqueMeshesCache.splice(n,1)},t.prototype._parseScene=function(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))},t.prototype._onMeshMaterialChanged=function(e){var n=this._transparentMeshesCache.indexOf(e),r=this._opaqueMeshesCache.indexOf(e),o=this.shouldRenderAsTransmission(e.material);o?(e.material instanceof D&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),r!==-1?(this._opaqueMeshesCache.splice(r,1),this._transparentMeshesCache.push(e)):n===-1&&this._transparentMeshesCache.push(e)):n!==-1?(this._transparentMeshesCache.splice(n,1),this._opaqueMeshesCache.push(e)):r===-1&&this._opaqueMeshesCache.push(e)},t.prototype._setupRenderTargets=function(){var e=this,n,r;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new pr("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(r=(n=this._options.clearColor)===null||n===void 0?void 0:n.clone())!==null&&r!==void 0?r:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;var o,a;this._opaqueRenderTarget.onBeforeBindObservable.add(function(s){a=e._scene.environmentIntensity,e._scene.environmentIntensity=1,o=e._scene.imageProcessingConfiguration.applyByPostProcess,e._options.clearColor?s.clearColor.copyFrom(e._options.clearColor):e._scene.clearColor.toLinearSpaceToRef(s.clearColor),e._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(function(){e._scene.environmentIntensity=a,e._scene.imageProcessingConfiguration._applyByPostProcess=o}),this._transparentMeshesCache.forEach(function(s){e.shouldRenderAsTransmission(s.material)&&(s.material.refractionTexture=e._opaqueRenderTarget)})},t.prototype.dispose=function(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]},t}(),en="KHR_materials_transmission",at=function(){function t(e){this.name=en,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(en),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadTransparentPropertiesAsync(a,n,r,s)),Promise.all(i).then(function(){})})},t.prototype._loadTransparentPropertiesAsync=function(e,n,r,o){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var a=r;if(a.subSurface.isRefractionEnabled=!0,a.subSurface.volumeIndexOfRefraction=1,a.subSurface.useAlbedoToTintRefraction=!0,o.transmissionFactor!==void 0){a.subSurface.refractionIntensity=o.transmissionFactor;var s=a.getScene();a.subSurface.refractionIntensity&&!s._transmissionHelper&&new ot({},a.getScene())}else return a.subSurface.refractionIntensity=0,a.subSurface.isRefractionEnabled=!1,Promise.resolve();return a.subSurface.minimumThickness=0,a.subSurface.maximumThickness=0,o.transmissionTexture?(o.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(e,"/transmissionTexture"),o.transmissionTexture,void 0).then(function(i){a.subSurface.refractionIntensityTexture=i,a.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},t}();g.RegisterExtension(en,function(t){return new at(t)});var nn="KHR_materials_translucency",st=function(){function t(e){this.name=nn,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(nn),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadTranslucentPropertiesAsync(a,n,r,s)),Promise.all(i).then(function(){})})},t.prototype._loadTranslucentPropertiesAsync=function(e,n,r,o){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));var a=r;if(a.subSurface.isTranslucencyEnabled=!0,a.subSurface.volumeIndexOfRefraction=1,a.subSurface.minimumThickness=0,a.subSurface.maximumThickness=0,a.subSurface.useAlbedoToTintTranslucency=!0,o.translucencyFactor!==void 0)a.subSurface.translucencyIntensity=o.translucencyFactor;else return a.subSurface.translucencyIntensity=0,a.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return o.translucencyTexture?(o.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(e,"/translucencyTexture"),o.translucencyTexture).then(function(s){a.subSurface.translucencyIntensityTexture=s})):Promise.resolve()},t}();g.RegisterExtension(nn,function(t){return new st(t)});var rn="KHR_materials_volume",it=function(){function t(e){this.name=rn,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(rn),this.enabled&&this._loader._disableInstancedMesh++}return t.prototype.dispose=function(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return i.push(o._loader.loadMaterialBasePropertiesAsync(e,n,r)),i.push(o._loader.loadMaterialPropertiesAsync(e,n,r)),i.push(o._loadVolumePropertiesAsync(a,n,r,s)),Promise.all(i).then(function(){})})},t.prototype._loadVolumePropertiesAsync=function(e,n,r,o){if(!(r instanceof D))throw new Error("".concat(e,": Material type not supported"));if(!r.subSurface.isRefractionEnabled&&!r.subSurface.isTranslucencyEnabled||!o.thicknessFactor)return Promise.resolve();r.subSurface.volumeIndexOfRefraction=r.indexOfRefraction;var a=o.attenuationDistance!==void 0?o.attenuationDistance:Number.MAX_VALUE;return r.subSurface.tintColorAtDistance=a,o.attenuationColor!==void 0&&o.attenuationColor.length==3&&r.subSurface.tintColor.copyFromFloats(o.attenuationColor[0],o.attenuationColor[1],o.attenuationColor[2]),r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=o.thicknessFactor,r.subSurface.useThicknessAsDepth=!0,o.thicknessTexture?(o.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync("".concat(e,"/thicknessTexture"),o.thicknessTexture).then(function(s){r.subSurface.thicknessTexture=s,r.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},t}();g.RegisterExtension(rn,function(t){return new it(t)});var tn="KHR_mesh_quantization",ct=function(){function t(e){this.name=tn,this.enabled=e.isExtensionUsed(tn)}return t.prototype.dispose=function(){},t}();g.RegisterExtension(tn,function(t){return new ct(t)});var on="KHR_texture_basisu",lt=function(){function t(e){this.name=on,this._loader=e,this.enabled=e.isExtensionUsed(on)}return t.prototype.dispose=function(){this._loader=null},t.prototype._loadTextureAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=n.sampler==null?g.DefaultSampler:y.Get("".concat(e,"/sampler"),o._loader.gltf.samplers,n.sampler),c=y.Get("".concat(a,"/source"),o._loader.gltf.images,s.source);return o._loader._createTextureAsync(e,i,c,function(u){r(u)},n._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!n._textureInfo.nonColorData)})},t}();g.RegisterExtension(on,function(t){return new lt(t)});var an="KHR_texture_transform",ut=function(){function t(e){this.name=an,this._loader=e,this.enabled=this._loader.isExtensionUsed(an)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadTextureInfoAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){return o._loader.loadTextureInfoAsync(e,n,function(i){if(!(i instanceof P))throw new Error("".concat(a,": Texture type not supported"));s.offset&&(i.uOffset=s.offset[0],i.vOffset=s.offset[1]),i.uRotationCenter=0,i.vRotationCenter=0,s.rotation&&(i.wAng=-s.rotation),s.scale&&(i.uScale=s.scale[0],i.vScale=s.scale[1]),s.texCoord!=null&&(i.coordinatesIndex=s.texCoord),r(i)})})},t}();g.RegisterExtension(an,function(t){return new ut(t)});var sn="KHR_xmp_json_ld",ft=function(){function t(e){this.name=sn,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(sn)}return t.prototype.dispose=function(){this._loader=null},t.prototype.onLoading=function(){var e,n,r;if(this._loader.rootBabylonMesh!==null){var o=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,a=(r=(n=this._loader.gltf.asset)===null||n===void 0?void 0:n.extensions)===null||r===void 0?void 0:r.KHR_xmp_json_ld;if(o&&a){var s=+a.packet;o.packets&&s<o.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=o.packets[s])}}},t}();g.RegisterExtension(sn,function(t){return new ft(t)});var cn="MSFT_audio_emitter",dt=function(){function t(e){this.name=cn,this._loader=e,this.enabled=this._loader.isExtensionUsed(cn)}return t.prototype.dispose=function(){this._loader=null,this._clips=null,this._emitters=null},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._clips=n.clips,this._emitters=n.emitters,y.Assign(this._clips),y.Assign(this._emitters)}},t.prototype.loadSceneAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,a){var s=new Array;s.push(r._loader.loadSceneAsync(e,n));for(var i=0,c=a.emitters;i<c.length;i++){var u=c[i],l=y.Get("".concat(o,"/emitters"),r._emitters,u);if(l.refDistance!=null||l.maxDistance!=null||l.rolloffFactor!=null||l.distanceModel!=null||l.innerAngle!=null||l.outerAngle!=null)throw new Error("".concat(o,": Direction or Distance properties are not allowed on emitters attached to a scene"));s.push(r._loadEmitterAsync("".concat(o,"/emitters/").concat(l.index),l))}return Promise.all(s).then(function(){})})},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i=new Array;return o._loader.loadNodeAsync(a,n,function(c){for(var u=function(h){var _=y.Get("".concat(a,"/emitters"),o._emitters,h);i.push(o._loadEmitterAsync("".concat(a,"/emitters/").concat(_.index),_).then(function(){for(var p=0,v=_._babylonSounds;p<v.length;p++){var m=v[p];m.attachToMesh(c),(_.innerAngle!=null||_.outerAngle!=null)&&(m.setLocalDirectionToMesh(S.Forward()),m.setDirectionalCone(2*M.ToDegrees(_.innerAngle==null?Math.PI:_.innerAngle),2*M.ToDegrees(_.outerAngle==null?Math.PI:_.outerAngle),0))}}))},l=0,f=s.emitters;l<f.length;l++){var d=f[l];u(d)}r(c)}).then(function(c){return Promise.all(i).then(function(){return c})})})},t.prototype.loadAnimationAsync=function(e,n){var r=this;return g.LoadExtensionAsync(e,n,this.name,function(o,a){return r._loader.loadAnimationAsync(e,n).then(function(s){var i=new Array;y.Assign(a.events);for(var c=0,u=a.events;c<u.length;c++){var l=u[c];i.push(r._loadAnimationEventAsync("".concat(o,"/events/").concat(l.index),e,n,l,s))}return Promise.all(i).then(function(){return s})})})},t.prototype._loadClipAsync=function(e,n){if(n._objectURL)return n._objectURL;var r;if(n.uri)r=this._loader.loadUriAsync(e,n,n.uri);else{var o=y.Get("".concat(e,"/bufferView"),this._loader.gltf.bufferViews,n.bufferView);r=this._loader.loadBufferViewAsync("/bufferViews/".concat(o.index),o)}return n._objectURL=r.then(function(a){return URL.createObjectURL(new Blob([a],{type:n.mimeType}))}),n._objectURL},t.prototype._loadEmitterAsync=function(e,n){var r=this;if(n._babylonSounds=n._babylonSounds||[],!n._babylonData){for(var o=new Array,a=n.name||"emitter".concat(n.index),s={loop:!1,autoplay:!1,volume:n.volume==null?1:n.volume},i=function(f){var d="/extensions/".concat(c.name,"/clips"),h=y.Get(d,c._clips,n.clips[f].clip);o.push(c._loadClipAsync("".concat(d,"/").concat(n.clips[f].clip),h).then(function(_){var p=n._babylonSounds[f]=new yr(a,_,r._loader.babylonScene,null,s);p.refDistance=n.refDistance||1,p.maxDistance=n.maxDistance||256,p.rolloffFactor=n.rolloffFactor||1,p.distanceModel=n.distanceModel||"exponential"}))},c=this,u=0;u<n.clips.length;u++)i(u);var l=Promise.all(o).then(function(){var f=n.clips.map(function(h){return h.weight||1}),d=new vr(n.loop||!1,n._babylonSounds,f);n.innerAngle&&(d.directionalConeInnerAngle=2*M.ToDegrees(n.innerAngle)),n.outerAngle&&(d.directionalConeOuterAngle=2*M.ToDegrees(n.outerAngle)),n.volume&&(d.volume=n.volume),n._babylonData.sound=d});n._babylonData={loaded:l}}return n._babylonData.loaded},t.prototype._getEventAction=function(e,n,r,o,a){switch(r){case"play":return function(s){var i=(a||0)+(s-o);n.play(i)};case"stop":return function(s){n.stop()};case"pause":return function(s){n.pause()};default:throw new Error("".concat(e,": Unsupported action ").concat(r))}},t.prototype._loadAnimationEventAsync=function(e,n,r,o,a){var s=this;if(a.targetedAnimations.length==0)return Promise.resolve();var i=a.targetedAnimations[0],c=o.emitter,u=y.Get("/extensions/".concat(this.name,"/emitters"),this._emitters,c);return this._loadEmitterAsync(e,u).then(function(){var l=u._babylonData.sound;if(l){var f=new Ar(o.time,s._getEventAction(e,l,o.action,o.time,o.startOffset));i.animation.addEvent(f),a.onAnimationGroupEndObservable.add(function(){l.stop()}),a.onAnimationGroupPauseObservable.add(function(){l.pause()})}})},t}();g.RegisterExtension(cn,function(t){return new dt(t)});var ln="MSFT_lod",ht=function(){function t(e){this.name=ln,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new U,this.onMaterialLODsLoadedObservable=new U,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(ln)}return t.prototype.dispose=function(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()},t.prototype.onReady=function(){for(var e=this,n=function(i){var c=Promise.all(r._nodePromiseLODs[i]).then(function(){i!==0&&(e._loader.endPerformanceCounter("Node LOD ".concat(i)),e._loader.log("Loaded node LOD ".concat(i))),e.onNodeLODsLoadedObservable.notifyObservers(i),i!==e._nodePromiseLODs.length-1&&(e._loader.startPerformanceCounter("Node LOD ".concat(i+1)),e._loadBufferLOD(e._nodeBufferLODs,i+1),e._nodeSignalLODs[i]&&e._nodeSignalLODs[i].resolve())});r._loader._completePromises.push(c)},r=this,o=0;o<this._nodePromiseLODs.length;o++)n(o);for(var a=function(i){var c=Promise.all(s._materialPromiseLODs[i]).then(function(){i!==0&&(e._loader.endPerformanceCounter("Material LOD ".concat(i)),e._loader.log("Loaded material LOD ".concat(i))),e.onMaterialLODsLoadedObservable.notifyObservers(i),i!==e._materialPromiseLODs.length-1&&(e._loader.startPerformanceCounter("Material LOD ".concat(i+1)),e._loadBufferLOD(e._materialBufferLODs,i+1),e._materialSignalLODs[i]&&e._materialSignalLODs[i].resolve())});s._loader._completePromises.push(c)},s=this,o=0;o<this._materialPromiseLODs.length;o++)a(o)},t.prototype.loadSceneAsync=function(e,n){var r=this._loader.loadSceneAsync(e,n);return this._loadBufferLOD(this._bufferLODs,0),r},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return g.LoadExtensionAsync(e,n,this.name,function(a,s){var i,c=o._getLODs(a,n,o._loader.gltf.nodes,s.ids);o._loader.logOpen("".concat(a));for(var u=function(f){var d=c[f];f!==0&&(o._nodeIndexLOD=f,o._nodeSignalLODs[f]=o._nodeSignalLODs[f]||new pe);var h=function(p){r(p),p.setEnabled(!1)},_=o._loader.loadNodeAsync("/nodes/".concat(d.index),d,h).then(function(p){if(f!==0){var v=c[f-1];v._babylonTransformNode&&(o._disposeTransformNode(v._babylonTransformNode),delete v._babylonTransformNode)}return p.setEnabled(!0),p});o._nodePromiseLODs[f]=o._nodePromiseLODs[f]||[],f===0?i=_:(o._nodeIndexLOD=null,o._nodePromiseLODs[f].push(_))},l=0;l<c.length;l++)u(l);return o._loader.logClose(),i})},t.prototype._loadMaterialAsync=function(e,n,r,o,a){var s=this;return this._nodeIndexLOD?null:g.LoadExtensionAsync(e,n,this.name,function(i,c){var u,l=s._getLODs(i,n,s._loader.gltf.materials,c.ids);s._loader.logOpen("".concat(i));for(var f=function(h){var _=l[h];h!==0&&(s._materialIndexLOD=h);var p=s._loader._loadMaterialAsync("/materials/".concat(_.index),_,r,o,function(v){h===0&&a(v)}).then(function(v){if(h!==0){a(v);var m=l[h-1]._data;m[o]&&(s._disposeMaterials([m[o].babylonMaterial]),delete m[o])}return v});s._materialPromiseLODs[h]=s._materialPromiseLODs[h]||[],h===0?u=p:(s._materialIndexLOD=null,s._materialPromiseLODs[h].push(p))},d=0;d<l.length;d++)f(d);return s._loader.logClose(),u})},t.prototype._loadUriAsync=function(e,n,r){var o=this;if(this._nodeIndexLOD!==null){this._loader.log("deferred");var a=this._nodeIndexLOD-1;return this._nodeSignalLODs[a]=this._nodeSignalLODs[a]||new pe,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(function(){return o._loader.loadUriAsync(e,n,r)})}else if(this._materialIndexLOD!==null){this._loader.log("deferred");var a=this._materialIndexLOD-1;return this._materialSignalLODs[a]=this._materialSignalLODs[a]||new pe,this._materialSignalLODs[a].promise.then(function(){return o._loader.loadUriAsync(e,n,r)})}return null},t.prototype.loadBufferAsync=function(e,n,r,o){if(this._loader.parent.useRangeRequests&&!n.uri){if(!this._loader.bin)throw new Error("".concat(e,": Uri is missing or the binary glTF is missing its binary chunk"));var a=function(s,i){var c=r,u=c+o-1,l=s[i];return l?(l.start=Math.min(l.start,c),l.end=Math.max(l.end,u)):(l={start:c,end:u,loaded:new pe},s[i]=l),l.loaded.promise.then(function(f){return new Uint8Array(f.buffer,f.byteOffset+r-l.start,o)})};return this._loader.log("deferred"),this._nodeIndexLOD!==null?a(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?a(this._materialBufferLODs,this._materialIndexLOD):a(this._bufferLODs,0)}return null},t.prototype._loadBufferLOD=function(e,n){var r=e[n];r&&(this._loader.log("Loading buffer range [".concat(r.start,"-").concat(r.end,"]")),this._loader.bin.readAsync(r.start,r.end-r.start+1).then(function(o){r.loaded.resolve(o)},function(o){r.loaded.reject(o)}))},t.prototype._getLODs=function(e,n,r,o){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");for(var a=new Array,s=o.length-1;s>=0;s--)if(a.push(y.Get("".concat(e,"/ids/").concat(o[s]),r,o[s])),a.length===this.maxLODsToLoad)return a;return a.push(n),a},t.prototype._disposeTransformNode=function(e){var n=this,r=new Array,o=e.material;o&&r.push(o);for(var a=0,s=e.getChildMeshes();a<s.length;a++){var i=s[a];i.material&&r.push(i.material)}e.dispose();var c=r.filter(function(u){return n._loader.babylonScene.meshes.every(function(l){return l.material!=u})});this._disposeMaterials(c)},t.prototype._disposeMaterials=function(e){for(var n={},r=0,o=e;r<o.length;r++){for(var a=o[r],s=0,i=a.getActiveTextures();s<i.length;s++){var c=i[s];n[c.uniqueId]=c}a.dispose()}for(var u in n)for(var l=0,f=this._loader.babylonScene.materials;l<f.length;l++){var a=f[l];a.hasTexture(n[u])&&delete n[u]}for(var u in n)n[u].dispose()},t}();g.RegisterExtension(ln,function(t){return new ht(t)});var un="MSFT_minecraftMesh",_t=function(){function t(e){this.name=un,this._loader=e,this.enabled=this._loader.isExtensionUsed(un)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtraAsync(e,n,this.name,function(a,s){if(s){if(!(r instanceof D))throw new Error("".concat(a,": Material type not supported"));var i=o._loader.loadMaterialPropertiesAsync(e,n,r);return r.needAlphaBlending()&&(r.forceDepthWrite=!0,r.separateCullingPass=!0),r.backFaceCulling=r.forceDepthWrite,r.twoSidedLighting=!0,i}return null})},t}();g.RegisterExtension(un,function(t){return new _t(t)});var fn="MSFT_sRGBFactors",pt=function(){function t(e){this.name=fn,this._loader=e,this.enabled=this._loader.isExtensionUsed(fn)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,n,r){var o=this;return g.LoadExtraAsync(e,n,this.name,function(a,s){if(s){if(!(r instanceof D))throw new Error("".concat(a,": Material type not supported"));var i=o._loader.loadMaterialPropertiesAsync(e,n,r);return r.albedoTexture||r.albedoColor.toLinearSpaceToRef(r.albedoColor),r.reflectivityTexture||r.reflectivityColor.toLinearSpaceToRef(r.reflectivityColor),i}return null})},t}();g.RegisterExtension(fn,function(t){return new pt(t)});var Un="ExtrasAsMetadata",vt=function(){function t(e){this.name=Un,this.enabled=!0,this._loader=e}return t.prototype._assignExtras=function(e,n){if(n.extras&&Object.keys(n.extras).length>0){var r=e.metadata=e.metadata||{},o=r.gltf=r.gltf||{};o.extras=n.extras}},t.prototype.dispose=function(){this._loader=null},t.prototype.loadNodeAsync=function(e,n,r){var o=this;return this._loader.loadNodeAsync(e,n,function(a){o._assignExtras(a,n),r(a)})},t.prototype.loadCameraAsync=function(e,n,r){var o=this;return this._loader.loadCameraAsync(e,n,function(a){o._assignExtras(a,n),r(a)})},t.prototype.createMaterial=function(e,n,r){var o=this._loader.createMaterial(e,n,r);return this._assignExtras(o,n),o},t}();g.RegisterExtension(Un,function(t){return new vt(t)});var At="/assets/apc.6635a715.glb";function yt(t){const e={forward:!1,left:!1,right:!1},n={forward:new U,left:new U,right:new U,all:new U},r={w:"forward",a:"left",d:"right"};return t.actionManager=new Re(t),t.actionManager.registerAction(new wn(Re.OnKeyDownTrigger,function(o){const a=o.sourceEvent,s=r[a.key.toLowerCase()];s&&!e[s]&&(e[s]=!0,n[s].notifyObservers(!0),n.all.notifyObservers(e))})),t.actionManager.registerAction(new wn(Re.OnKeyUpTrigger,function(o){const a=o.sourceEvent,s=r[a.key.toLowerCase()];s&&e[s]&&(e[s]=!1,n[s].notifyObservers(!1),n.all.notifyObservers(e))})),gn(mn({},n),{destroy:()=>{}})}function Et(t,e){t.enableOfflineSupport=!1,Q.AllowMatricesInterpolation=!0;var n=new mr(t);const r=yt(n);var o=new Ne("light1",new S(0,1,0),n);o.intensity=.6,o.specular=x.Black();var a=new ge("dir01",new S(3,-3,1),n);a.position=new S(0,5,5);var s=new gr(1024,a);s.useBlurExponentialShadowMap=!0,s.blurKernel=32;const i=new Er("camera1",new S,n);i.radius=5,i.heightOffset=1.5;const c=new S;r.all.add(l=>{c.set(0,0,0),l.forward&&c.addInPlaceFromFloats(0,0,1),l.left&&c.addInPlaceFromFloats(-1,0,0),l.right&&c.addInPlaceFromFloats(1,0,0)}),n.onPointerObservable.add(l=>{switch(l.type){case Tr.POINTERTAP:console.log(l),l.event.clientX<e.clientWidth*.2?c.set(1,0,0):l.event.clientX<e.clientWidth*.4?c.set(1,0,1):l.event.clientX<e.clientWidth*.6?c.set(0,0,1):l.event.clientX<e.clientWidth*.8?c.set(-1,0,1):c.set(-1,0,0)}});const u=n.createDefaultEnvironment({enableGroundShadow:!0});return u.setMainColor(x.Teal()),u.ground.position.y+=.01,Ce.ImportMesh("",At,"",n,(l,f,d,h,_,p,v)=>{s.addShadowCaster(l[0],!0);const m=h.find(E=>E.name==="Idle"),O=h.find(E=>E.name==="Walking"),A=h.find(E=>E.name==="Left"),T=h.find(E=>E.name==="Right");[m,O,A,T].forEach(E=>{E.setWeightForAllAnimatables(0),E.start(!0)}),[A,T].forEach(E=>{E.syncAllAnimationsWith(O.animatables[0])});const b={idleAnimation:1,walkingAnimation:0,leftAnimation:0,rightAnimation:0},C={idleAnimation:1,walkingAnimation:0,leftAnimation:0,rightAnimation:0},L=["idleAnimation","walkingAnimation","leftAnimation","rightAnimation"];n.onBeforeAnimationsObservable.add(()=>{b.walkingAnimation=c.z>.1?1:1e-6,b.leftAnimation=c.x<-.1?1:0,b.rightAnimation=c.x>.1?1:0,b.idleAnimation=b.walkingAnimation==1e-6&&b.leftAnimation==0&&b.rightAnimation==0?1:0;for(const E of L)C[E]<b[E]?(C[E]+=.1,C[E]>b[E]&&(C[E]=b[E])):C[E]>b[E]&&(C[E]-=.1,C[E]<b[E]&&(C[E]=b[E]));m.setWeightForAllAnimatables(C.idleAnimation),O.setWeightForAllAnimatables(C.walkingAnimation),A.setWeightForAllAnimatables(C.leftAnimation),T.setWeightForAllAnimatables(C.rightAnimation)});const N=new fe("dummy",n,l[0]);N.position.addInPlaceFromFloats(0,1,0),i.lockedTarget=N;const F={idleAnimation:m,walkingAnimation:O,leftAnimation:A,rightAnimation:T,meshes:l,particleSystems:f,skeletons:d,animationGroups:h,transformNodes:_,geometries:p,lights:v};console.debug("hax",F),Object.assign(window,{hax:F})},function(){}),n}export{Et as createScene};
