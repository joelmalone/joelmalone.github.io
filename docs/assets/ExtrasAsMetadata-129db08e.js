import{k as zt,E as be,M as H,T as ke,X as It,L as w,j as P,i as C,O as q,V as E,av as us,a1 as he,ae as St,af as Oe,h as R,b1 as Bt,A as I,v as j,w as ds,U as Xt,n as re,p as ce,s as fs,t as Ge,aa as b,aA as _s,aQ as ms,a7 as je,aK as Yt,aN as Zt,bj as ps,bl as Jt,ai as gs,aj as As,q as ys,d as Ts,a8 as pe,f as xs,a6 as bs,C as U,a9 as se,Q as J,az as Es,ay as Ct,aH as vs,b0 as Is,bH as Ss,bO as Cs,g as Ms}from"./runBabylonPlaygroundScene-32a4afbd.js";import{d as ye,C as Os,_ as ws,c as Ps,a as We}from"./workerPool-f37bc04e.js";import{O as Ns,L as Be,T as L,d as Qt,S as Mt,H as es}from"./linesBuilder-a2dae4c1.js";import{S as ts,C as me,D as Ot}from"./directionalLight-d037032f.js";import{h as W,S as Ls,i as Ds}from"./pbrMaterial-34e2fd30.js";import{b as Rs}from"./blurPostProcess-f61d1d3e.js";import{A as Bs}from"./animationGroup-a96e107c.js";import{S as Ft}from"./sceneLoader-f06775c7.js";class wt{constructor(e,t,s){this.frame=e,this.action=t,this.onlyOnce=s,this.isDone=!1}_clone(){return new wt(this.frame,this.action,this.onlyOnce)}}class Fs extends zt{}class Us{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class $s extends zt{constructor(e){super(),this._wasAddedToScene=!1,e=e||be.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const a of e)t.set(a.uniqueId,a);const s={dependsOn:new Map,dependedBy:new Map};for(const a of e){const l=a.uniqueId;s.dependsOn.set(l,new Set),s.dependedBy.set(l,new Set)}for(const a of e){const l=a.uniqueId,h=s.dependsOn.get(l);if(a instanceof Ns){const u=a.sourceMesh;t.has(u.uniqueId)&&(h.add(u.uniqueId),s.dependedBy.get(u.uniqueId).add(l))}const c=s.dependedBy.get(l);for(const u of a.getDescendants()){const d=u.uniqueId;t.has(d)&&(c.add(d),s.dependsOn.get(d).add(l))}}const n=[],i=[];for(const a of e){const l=a.uniqueId;s.dependsOn.get(l).size===0&&(i.push(a),t.delete(l))}const r=i;for(;r.length>0;){const a=r.shift();n.push(a);const l=s.dependedBy.get(a.uniqueId);for(const h of Array.from(l.values())){const c=s.dependsOn.get(h);c.delete(a.uniqueId),c.size===0&&t.get(h)&&(r.push(t.get(h)),t.delete(h))}}return t.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>console.error(a.name))),n}_addNodeAndDescendantsToList(e,t,s,n){if(!(!s||n&&!n(s)||t.has(s.uniqueId))){e.push(s),t.add(s.uniqueId);for(const i of s.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,i,n)}}_isNodeInContainer(e){return e instanceof H&&this.meshes.indexOf(e)!==-1||e instanceof ke&&this.transformNodes.indexOf(e)!==-1||e instanceof Be&&this.lights.indexOf(e)!==-1||e instanceof It&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,s){this._isValidHierarchy()||P.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const n={},i={},r=new Us,a=[],l=[],h=Object.assign({doNotInstantiate:!0},s),c=(_,p)=>{if(n[_.uniqueId]=p.uniqueId,i[p.uniqueId]=p,e&&(p.name=e(_.name)),p instanceof H){const g=p;if(g.morphTargetManager){const y=_.morphTargetManager;g.morphTargetManager=y.clone();for(let v=0;v<y.numTargets;v++){const O=y.getTarget(v),T=g.morphTargetManager.getTarget(v);n[O.uniqueId]=T.uniqueId,i[T.uniqueId]=T}}}},u=[],d=new Set;for(const _ of this.transformNodes)_.parent===null&&this._addNodeAndDescendantsToList(u,d,_,h.predicate);for(const _ of this.meshes)_.parent===null&&this._addNodeAndDescendantsToList(u,d,_,h.predicate);const f=this._topologicalSort(u),m=(_,p)=>{if(c(_,p),_.parent){const g=n[_.parent.uniqueId],y=i[g];y?p.parent=y:p.parent=_.parent}if(p.position&&_.position&&p.position.copyFrom(_.position),p.rotationQuaternion&&_.rotationQuaternion&&p.rotationQuaternion.copyFrom(_.rotationQuaternion),p.rotation&&_.rotation&&p.rotation.copyFrom(_.rotation),p.scaling&&_.scaling&&p.scaling.copyFrom(_.scaling),p.material){const g=p;if(g.material)if(t){const y=_.material;if(l.indexOf(y)===-1){let v=y.clone(e?e(y.name):"Clone of "+y.name);if(l.push(y),n[y.uniqueId]=v.uniqueId,i[v.uniqueId]=v,y.getClassName()==="MultiMaterial"){const O=y;for(const T of O.subMaterials)T&&(v=T.clone(e?e(T.name):"Clone of "+T.name),l.push(T),n[T.uniqueId]=v.uniqueId,i[v.uniqueId]=v);O.subMaterials=O.subMaterials.map(T=>T&&i[n[T.uniqueId]])}}g.getClassName()!=="InstancedMesh"&&(g.material=i[n[y.uniqueId]])}else g.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(g.material)===-1&&this.scene.addMultiMaterial(g.material):this.scene.materials.indexOf(g.material)===-1&&this.scene.addMaterial(g.material)}p.parent===null&&r.rootNodes.push(p)};return f.forEach(_=>{if(_.getClassName()==="InstancedMesh"){const p=_,g=p.sourceMesh,y=n[g.uniqueId],O=(typeof y=="number"?i[y]:g).createInstance(p.name);m(p,O)}else{let p=!0;_.getClassName()==="TransformNode"||_.getClassName()==="Node"||_.skeleton||!_.getTotalVertices||_.getTotalVertices()===0?p=!1:h.doNotInstantiate&&(typeof h.doNotInstantiate=="function"?p=!h.doNotInstantiate(_):p=!h.doNotInstantiate);const g=p?_.createInstance(`instance of ${_.name}`):_.clone(`Clone of ${_.name}`,null,!0);if(!g)throw new Error(`Could not clone or instantiate node on Asset Container ${_.name}`);m(_,g)}}),this.skeletons.forEach(_=>{if(h.predicate&&!h.predicate(_))return;const p=_.clone(e?e(_.name):"Clone of "+_.name);for(const g of this.meshes)if(g.skeleton===_&&!g.isAnInstance){const y=i[n[g.uniqueId]];if(!y||y.isAnInstance||(y.skeleton=p,a.indexOf(p)!==-1))continue;a.push(p);for(const v of p.bones)v._linkedTransformNode&&(v._linkedTransformNode=i[n[v._linkedTransformNode.uniqueId]])}r.skeletons.push(p)}),this.animationGroups.forEach(_=>{if(h.predicate&&!h.predicate(_))return;const p=_.clone(e?e(_.name):"Clone of "+_.name,g=>i[n[g.uniqueId]]||g);r.animationGroups.push(p)}),r}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||P.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.addCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.addLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.addMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.addSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.addGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.addTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.addActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.addReflectionProbe(t)})}removeAllFromScene(){this._isValidHierarchy()||P.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,s){if(!(!e||!t))for(const n of e){let i=!0;if(s){for(const r of s)if(n===r){i=!1;break}}i&&(t.push(n),n._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new Fs);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new H("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=be.LastCreatedScene,t,s=null){if(!e)return w.Error("No scene available to merge animations to"),[];const n=s||(a=>{let l=null;const h=a.animations.length?a.animations[0].targetProperty:"",c=a.name.split(".").join("").split("_primitive")[0];switch(h){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(a.name)||e.getTransformNodeByName(c);break;case"influence":l=e.getMorphTargetByName(a.name)||e.getMorphTargetByName(c);break;default:l=e.getNodeByName(a.name)||e.getNodeByName(c)}return l});this.getNodes().forEach(a=>{const l=n(a);if(l!==null){for(const h of a.animations){const c=l.animations.filter(u=>u.targetProperty===h.targetProperty);for(const u of c){const d=l.animations.indexOf(u,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(a.animations)}});const r=new Array;return this.animationGroups.slice().forEach(a=>{r.push(a.clone(a.name,n)),a.animatables.forEach(l=>{l.stop()})}),t.forEach(a=>{const l=n(a.target);l&&(e.beginAnimation(l,a.fromFrame,a.toFrame,a.loopAnimation,a.speedRatio,a.onAnimationEnd?a.onAnimationEnd:void 0,void 0,!0,void 0,a.onAnimationLoop?a.onAnimationLoop:void 0),e.stopAnimation(a.target))}),r}}class ge{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(!((e=C.audioEngine)===null||e===void 0)&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:C.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){var t;this._spatialSound=e,this._spatialSound&&(!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio)&&C.audioEngine.audioContext&&this._createSpatialParameters()}constructor(e,t,s,n=null,i){var r,a,l,h,c;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new q,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=E.Zero(),this._localDirection=new E(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,s=s||be.LastCreatedScene,!!s)if(this._scene=s,ge._SceneComponentInitialization(s),this._readyToPlayCallback=n,this._customAttenuationFunction=(u,d,f,m,_)=>d<f?u*(1-d/f):0,i&&(this.autoplay=i.autoplay||!1,this._loop=i.loop||!1,i.volume!==void 0&&(this._volume=i.volume),this._spatialSound=(r=i.spatialSound)!==null&&r!==void 0?r:!1,this.maxDistance=(a=i.maxDistance)!==null&&a!==void 0?a:100,this.useCustomAttenuation=(l=i.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=i.rolloffFactor||1,this.refDistance=i.refDistance||1,this.distanceModel=i.distanceModel||"linear",this._playbackRate=i.playbackRate||1,this._streaming=(h=i.streaming)!==null&&h!==void 0?h:!1,this._length=i.length,this._offset=i.offset),!((c=C.audioEngine)===null||c===void 0)&&c.canUseWebAudio&&C.audioEngine.audioContext){this._soundGain=C.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let u=!0;if(t)try{typeof t=="string"?this._urlType="String":t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let d=[],f=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=C.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=C.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(f=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":d.push(t);case"Array":d.length===0&&(d=t);for(let m=0;m<d.length;m++){const _=d[m];if(f=i&&i.skipCodecCheck||_.indexOf(".mp3",_.length-4)!==-1&&C.audioEngine.isMP3supported||_.indexOf(".ogg",_.length-4)!==-1&&C.audioEngine.isOGGsupported||_.indexOf(".wav",_.length-4)!==-1||_.indexOf(".m4a",_.length-4)!==-1||_.indexOf(".mp4",_.length-4)!==-1||_.indexOf("blob:")!==-1,f){this._streaming?(this._htmlAudioElement=new Audio(_),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,P.SetCorsBehavior(_,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(_,p=>{this._soundLoaded(p)},void 0,!0,!0,p=>{p&&w.Error("XHR "+p.status+" error on: "+_+"."),w.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:u=!1;break}u?f||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):w.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{w.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),C.audioEngine&&!C.audioEngine.WarnedWebAudioUnsupported&&(w.Error("Web Audio is not supported by your browser."),C.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;!((e=C.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;!((t=C.audioEngine)===null||t===void 0)&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;!((t=C.audioEngine)===null||t===void 0)&&t.audioContext&&C.audioEngine.audioContext.decodeAudioData(e,s=>{this._audioBufferLoaded(s)},s=>{w.Error("Error while decoding audio data for: "+this.name+" / Error: "+s)})}setAudioBuffer(e){var t;!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,s,n,i,r,a,l,h,c,u;e&&(this.loop=(t=e.loop)!==null&&t!==void 0?t:this.loop,this.maxDistance=(s=e.maxDistance)!==null&&s!==void 0?s:this.maxDistance,this.useCustomAttenuation=(n=e.useCustomAttenuation)!==null&&n!==void 0?n:this.useCustomAttenuation,this.rolloffFactor=(i=e.rolloffFactor)!==null&&i!==void 0?i:this.rolloffFactor,this.refDistance=(r=e.refDistance)!==null&&r!==void 0?r:this.refDistance,this.distanceModel=(a=e.distanceModel)!==null&&a!==void 0?a:this.distanceModel,this._playbackRate=(l=e.playbackRate)!==null&&l!==void 0?l:this._playbackRate,this._length=(h=e.length)!==null&&h!==void 0?h:void 0,this._setOffset((c=e.offset)!==null&&c!==void 0?c:void 0),this.setVolume((u=e.volume)!==null&&u!==void 0?u:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e,t;!((e=C.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&C.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(t=this._soundPanner)!==null&&t!==void 0?t:C.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_updateSpatialParameters(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;!((e=C.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,s){if(t<e){w.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=s,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){w.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){w.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=E.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if(!((e=C.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,s){var n,i,r,a;if(this._isReadyToPlay&&this._scene.audioEnabled&&(!((n=C.audioEngine)===null||n===void 0)&&n.audioContext))try{let l=e?((i=C.audioEngine)===null||i===void 0?void 0:i.audioContext.currentTime)+e:(r=C.audioEngine)===null||r===void 0?void 0:r.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=C.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const h=()=>{var c,u;if(!((c=C.audioEngine)===null||c===void 0)&&c.unlocked){const d=this._htmlAudioElement.play();d!==void 0&&d.catch(()=>{var f,m;(f=C.audioEngine)===null||f===void 0||f.lock(),(this.loop||this.autoplay)&&((m=C.audioEngine)===null||m===void 0||m.onAudioUnlockedObservable.addOnce(()=>{h()}))})}else(this.loop||this.autoplay)&&((u=C.audioEngine)===null||u===void 0||u.onAudioUnlockedObservable.addOnce(()=>{h()}))};h()}}else{const h=()=>{var c,u,d,f;if(!((c=C.audioEngine)===null||c===void 0)&&c.audioContext){if(s=s||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const m=this._soundSource;m.onended=()=>{m.disconnect()}}if(this._soundSource=(u=C.audioEngine)===null||u===void 0?void 0:u.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),s!==void 0&&(this._soundSource.loopEnd=(t|0)+s),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((d=C.audioEngine)===null||d===void 0?void 0:d.audioContext.currentTime)+e:C.audioEngine.audioContext.currentTime;const m=((this.isPaused?this.currentTime:0)+((f=this._offset)!==null&&f!==void 0?f:0))%this._soundSource.buffer.duration;this._soundSource.start(l,m,this.loop?void 0:s)}}};((a=C.audioEngine)===null||a===void 0?void 0:a.audioContext.state)==="suspended"?setTimeout(()=>{var c;((c=C.audioEngine)===null||c===void 0?void 0:c.audioContext.state)==="suspended"?(C.audioEngine.lock(),(this.loop||this.autoplay)&&C.audioEngine.onAudioUnlockedObservable.addOnce(()=>{h()})):h()},500):h()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){w.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(!((t=C.audioEngine)===null||t===void 0)&&t.audioContext&&this._soundSource){const s=e?C.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(s)}}else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;this.isPlaying&&(this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):!((e=C.audioEngine)===null||e===void 0)&&e.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=C.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var s;!((s=C.audioEngine)===null||s===void 0)&&s.canUseWebAudio&&this._soundGain&&(t&&C.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(C.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,C.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,C.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const n=e.getBoundingInfo();this.setPosition(n.boundingSphere.centerWorld)}!((t=C.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(s._audioBuffer=this.getAudioBuffer(),s._isReadyToPlay=!0,s.autoplay&&s.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},s=new ge(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&s.setAttenuationFunction(this._customAttenuationFunction),s.setPosition(this._position),s.setPlaybackRate(this._playbackRate),e(),s}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,s,n){const i=e.name;let r;e.url?r=s+e.url:r=s+i;const a={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!n)l=new ge(i,r,t,()=>{t.removePendingData(l)},a),t.addPendingData(l);else{const h=()=>{n._isReadyToPlay?(l._audioBuffer=n.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):setTimeout(h,300)};l=new ge(i,new ArrayBuffer(0),t,null,a),h()}if(e.position){const h=E.FromArray(e.position);l.setPosition(h)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const h=E.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(h)}if(e.connectedMeshId){const h=t.getMeshById(e.connectedMeshId);h&&l.attachToMesh(h)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}}ge._SceneComponentInitialization=o=>{throw us("AudioSceneComponent")};class Vs{constructor(e,t,s){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==s.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=s;let n=0;for(const r of s)n+=r;const i=n>0?1/n:0;for(let r=0;r<this._weights.length;r++)this._weights[r]*=i;this._sounds=t;for(const r of this._sounds)r.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){w.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){w.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const s=Math.random();let n=0;for(let i=0;i<this._weights.length;i++)if(n+=this._weights[i],s<=n){this._currentIndex=i;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}he.prototype.updateRawTexture=function(o,e,t,s,n=null,i=0,r=!1){if(!o)return;const a=this._getRGBABufferInternalSizedFormat(i,t,r),l=this._getInternalFormat(t),h=this._getWebGLTextureType(i);this._bindTextureDirectly(this._gl.TEXTURE_2D,o,!0),this._unpackFlipY(s===void 0?!0:!!s),this._doNotHandleContextLost||(o._bufferView=e,o.format=t,o.type=i,o.invertY=s,o._compression=n),o.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],o.width,o.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,o.width,o.height,0,l,h,e),o.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),o.isReady=!0};he.prototype.createRawTexture=function(o,e,t,s,n,i,r,a=null,l=0,h=0,c=!1){const u=new St(this,Oe.Raw);u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=s,u.generateMipMaps=n,u.samplingMode=r,u.invertY=i,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!n),this._doNotHandleContextLost||(u._bufferView=o),this.updateRawTexture(u,o,s,i,a,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const d=this._getSamplingParameters(r,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u};he.prototype.createRawCubeTexture=function(o,e,t,s,n,i,r,a=null){const l=this._gl,h=new St(this,Oe.CubeRaw);h.isCube=!0,h.format=t,h.type=s,this._doNotHandleContextLost||(h._bufferViewArray=o);const c=this._getWebGLTextureType(s);let u=this._getInternalFormat(t);u===l.RGB&&(u=l.RGBA),c===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(n=!1,r=1,w.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,r=1,w.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===l.FLOAT&&!this._caps.textureFloatRender?(n=!1,w.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):c===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,w.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const d=e,f=d;if(h.width=d,h.height=f,h.invertY=i,h._compression=a,!this.needPOTTextures||P.IsExponentOfTwo(h.width)&&P.IsExponentOfTwo(h.height)||(n=!1),o)this.updateRawCubeTexture(h,o,t,s,i,a);else{const p=this._getRGBABufferInternalSizedFormat(s),g=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,h,!0);for(let y=0;y<6;y++)a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,this.getCaps().s3tc[a],h.width,h.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,p,h.width,h.height,0,u,c,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,!0),o&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(r,n);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.generateMipMaps=n,h.samplingMode=r,h.isReady=!0,h};he.prototype.updateRawCubeTexture=function(o,e,t,s,n,i=null,r=0){o._bufferViewArray=e,o.format=t,o.type=s,o.invertY=n,o._compression=i;const a=this._gl,l=this._getWebGLTextureType(s);let h=this._getInternalFormat(t);const c=this._getRGBABufferInternalSizedFormat(s);let u=!1;h===a.RGB&&(h=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,o,!0),this._unpackFlipY(n===void 0?!0:!!n),o.width%4!==0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let m=e[f];i?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,r,this.getCaps().s3tc[i],o.width,o.height,0,m):(u&&(m=ss(m,o.width,o.height,s)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,r,c,o.width,o.height,0,h,l,m))}(!this.needPOTTextures||P.IsExponentOfTwo(o.width)&&P.IsExponentOfTwo(o.height))&&o.generateMipMaps&&r===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),o.isReady=!0};he.prototype.createRawCubeTextureFromUrl=function(o,e,t,s,n,i,r,a,l=null,h=null,c=3,u=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,s,n,!i,u,c,null);e==null||e.addPendingData(f),f.url=o,f.isReady=!1,this._internalTexturesCache.push(f);const m=(p,g)=>{e==null||e.removePendingData(f),h&&p&&h(p.status+" "+p.statusText,g)},_=p=>{const g=f.width,y=r(p);if(y){if(a){const v=this._getWebGLTextureType(n);let O=this._getInternalFormat(s);const T=this._getRGBABufferInternalSizedFormat(n);let M=!1;O===d.RGB&&(O=d.RGBA,M=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const S=a(y);for(let N=0;N<S.length;N++){const B=g>>N;for(let F=0;F<6;F++){let k=S[N][F];M&&(k=ss(k,B,B,n)),d.texImage2D(F,N,T,B,B,0,O,v,k)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,y,s,n,u);f.isReady=!0,e==null||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(o,p=>{_(p)},void 0,e==null?void 0:e.offlineProvider,!0,m),f};function ss(o,e,t,s){let n,i=1;s===1?n=new Float32Array(e*t*4):s===2?(n=new Uint16Array(e*t*4),i=15360):s===7?n=new Uint32Array(e*t*4):n=new Uint8Array(e*t*4);for(let r=0;r<e;r++)for(let a=0;a<t;a++){const l=(a*e+r)*3,h=(a*e+r)*4;n[h+0]=o[l+0],n[h+1]=o[l+1],n[h+2]=o[l+2],n[h+3]=i}return n}function ns(o){return function(e,t,s,n,i,r,a,l,h=null,c=0){const u=o?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=o?Oe.Raw3D:Oe.Raw2DArray,f=new St(this,d);f.baseWidth=t,f.baseHeight=s,f.baseDepth=n,f.width=t,f.height=s,f.depth=n,f.format=i,f.type=c,f.generateMipMaps=r,f.samplingMode=l,o?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),o?this.updateRawTexture3D(f,e,i,a,h,c):this.updateRawTexture2DArray(f,e,i,a,h,c),this._bindTextureDirectly(u,f,!0);const m=this._getSamplingParameters(l,r);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,m.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,m.min),r&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(f),f}}he.prototype.createRawTexture2DArray=ns(!1);he.prototype.createRawTexture3D=ns(!0);function is(o){return function(e,t,s,n,i=null,r=0){const a=o?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(r),h=this._getInternalFormat(s),c=this._getRGBABufferInternalSizedFormat(r,s);this._bindTextureDirectly(a,e,!0),this._unpackFlipY(n===void 0?!0:!!n),this._doNotHandleContextLost||(e._bufferView=t,e.format=s,e.invertY=n,e._compression=i),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),i&&t?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[i],e.width,e.height,e.depth,0,t):this._gl.texImage3D(a,0,c,e.width,e.height,e.depth,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),e.isReady=!0}}he.prototype.updateRawTexture2DArray=is(!1);he.prototype.updateRawTexture3D=is(!0);class ne extends L{constructor(e,t,s,n,i,r=!0,a=!1,l=3,h=0,c,u){super(null,i,!r,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,c),this.format=n,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&h===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&h===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,s,n,r,a,l,null,h,c??0,u??!1),this.wrapU=L.CLAMP_ADDRESSMODE,this.wrapV=L.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,s,n,i=!0,r=!1,a=3){return new ne(e,t,s,1,n,i,r,a)}static CreateLuminanceAlphaTexture(e,t,s,n,i=!0,r=!1,a=3){return new ne(e,t,s,2,n,i,r,a)}static CreateAlphaTexture(e,t,s,n,i=!0,r=!1,a=3){return new ne(e,t,s,0,n,i,r,a)}static CreateRGBTexture(e,t,s,n,i=!0,r=!1,a=3,l=0,h=0,c=!1){return new ne(e,t,s,4,n,i,r,a,l,h,c)}static CreateRGBATexture(e,t,s,n,i=!0,r=!1,a=3,l=0,h=0,c=!1){return new ne(e,t,s,5,n,i,r,a,l,h,c)}static CreateRGBAStorageTexture(e,t,s,n,i=!0,r=!1,a=3,l=0,h=!1){return new ne(e,t,s,5,n,i,r,a,l,1,h)}static CreateRTexture(e,t,s,n,i=!0,r=!1,a=L.TRILINEAR_SAMPLINGMODE,l=1){return new ne(e,t,s,6,n,i,r,a,l)}static CreateRStorageTexture(e,t,s,n,i=!0,r=!1,a=L.TRILINEAR_SAMPLINGMODE,l=1){return new ne(e,t,s,6,n,i,r,a,l,1)}}class Ee{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,s){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=R.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new q,this.bones=[],this._scene=s||be.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):((!this._transformMatrices||this._isDirty)&&this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let s=!0;for(const n in this._ranges)s&&(t+=", ",s=!1),t+=n;t+="}"}return t}getBoneIndexByName(e){for(let t=0,s=this.bones.length;t<s;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,s){if(!this._ranges[e]){this._ranges[e]=new Bt(e,t,s);for(let n=0,i=this.bones.length;n<i;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(e,t,s)}}deleteAnimationRange(e,t=!0){for(let s=0,n=this.bones.length;s<n;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,s=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let n=!0;const i=this._getHighestAnimationFrame()+1,r={},a=e.bones;let l,h;for(h=0,l=a.length;h<l;h++)r[a[h].name]=a[h];this.bones.length!==a.length&&(w.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),n=!1);const c=s&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(h=0,l=this.bones.length;h<l;h++){const d=this.bones[h].name,f=r[d];f?n=n&&this.bones[h].copyAnimationRange(f,t,i,s,c):(w.Warn("copyAnimationRange: not same rig, missing source bone "+d),n=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new Bt(t,u.from+i,u.to+i)),n}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,s=this.bones.length;t<s;t++)if(this.bones[t].animations[0]){const n=this.bones[t].animations[0].getHighestFrame();e<n&&(e=n)}return e}beginAnimation(e,t,s,n){const i=this.getAnimationRange(e);return i?this._scene.beginAnimation(this,i.from,i.to,t,s,n):null}static MakeAnimationAdditive(e,t=0,s){const n=e.getAnimationRange(s);if(!n)return null;const i=e._scene.getAllAnimatablesByTarget(e);let r=null;for(let l=0;l<i.length;l++){const h=i[l];if(h.fromFrame===(n==null?void 0:n.from)&&h.toFrame===(n==null?void 0:n.to)){r=h;break}}const a=e.getAnimatables();for(let l=0;l<a.length;l++){const c=a[l].animations;if(c)for(let u=0;u<c.length;u++)I.MakeAnimationAdditive(c[u],t,s)}return r&&(r.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let s=0;s<this.bones.length;s++){const n=this.bones[s];n._childUpdateId++;const i=n.getParent();if(i?n.getLocalMatrix().multiplyToRef(i.getFinalMatrix(),n.getFinalMatrix()):t?n.getLocalMatrix().multiplyToRef(t,n.getFinalMatrix()):n.getFinalMatrix().copyFrom(n.getLocalMatrix()),n._index!==-1){const r=n._index===null?s:n._index;n.getAbsoluteInverseBindMatrix().multiplyToArray(n.getFinalMatrix(),e,r*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(){if(this._numBonesWithLinkedTransformNode>0){for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let s=this._isDirty;if((!e._bonesTransformMatrices||e._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),s=!0),!!s){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const n of this.bones)n.getParent()||(n.getBindMatrix().multiplyToRef(t,j.Matrix[1]),n._updateAbsoluteBindMatrices(j.Matrix[1]));if(this.isUsingTextureForMatrices){const n=(this.bones.length+1)*4;(!e._transformMatrixTexture||e._transformMatrixTexture.getSize().width!==n)&&(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=ne.CreateRGBATexture(e._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=ne.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const s=new Ee(e,t||e,this._scene);s.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let n=0;n<this.bones.length;n++){const i=this.bones[n];let r=null;const a=i.getParent();if(a){const h=this.bones.indexOf(a);r=s.bones[h]}const l=new ye(i.name,s,r,i.getBindMatrix().clone(),i.getRestMatrix().clone());l._index=i._index,i._linkedTransformNode&&l.linkTransformNode(i._linkedTransformNode),ds.DeepCopy(i.animations,l.animations)}if(this._ranges){s._ranges={};for(const n in this._ranges){const i=this._ranges[n];i&&(s._ranges[n]=i.clone())}}return this._isDirty=!0,s}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(s=>{s.enableBlending=!0,s.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let s=0;s<this.bones.length;s++){const n=this.bones[s],i=n.getParent(),r={parentBoneIndex:i?this.bones.indexOf(i):-1,index:n.getIndex(),name:n.name,id:n.id,matrix:n.getBindMatrix().toArray(),rest:n.getRestMatrix().toArray(),linkedTransformNodeId:(e=n.getTransformNode())===null||e===void 0?void 0:e.id};t.bones.push(r),n.length&&(r.length=n.length),n.metadata&&(r.metadata=n.metadata),n.animations&&n.animations.length>0&&(r.animation=n.animations[0].serialize()),t.ranges=[];for(const a in this._ranges){const l=this._ranges[a];if(!l)continue;const h={};h.name=a,h.from=l.from,h.to=l.to,t.ranges.push(h)}}return t}static Parse(e,t){const s=new Ee(e.name,e.id,t);e.dimensionsAtRest&&(s.dimensionsAtRest=E.FromArray(e.dimensionsAtRest)),s.needInitialSkinMatrix=e.needInitialSkinMatrix;let n;for(n=0;n<e.bones.length;n++){const i=e.bones[n],r=e.bones[n].index;let a=null;i.parentBoneIndex>-1&&(a=s.bones[i.parentBoneIndex]);const l=i.rest?R.FromArray(i.rest):null,h=new ye(i.name,s,a,R.FromArray(i.matrix),l,null,r);i.id!==void 0&&i.id!==null&&(h.id=i.id),i.length&&(h.length=i.length),i.metadata&&(h.metadata=i.metadata),i.animation&&h.animations.push(I.Parse(i.animation)),i.linkedTransformNodeId!==void 0&&i.linkedTransformNodeId!==null&&(s._hasWaitingData=!0,h._waitingTransformNodeId=i.linkedTransformNodeId)}if(e.ranges)for(n=0;n<e.ranges.length;n++){const i=e.ranges[n];s.createAnimationRange(i.name,i.from,i.to)}return s}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,t=new Array(this.bones.length);for(let s=0;s<this.bones.length;s++)this._sortBones(s,e,t);this.bones=e}_sortBones(e,t,s){if(s[e])return;s[e]=!0;const n=this.bones[e];if(!n)return;n._index===void 0&&(n._index=e);const i=n.getParent();i&&this._sortBones(this.bones.indexOf(i),t,s),t.push(n)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}Xt.AddNodeConstructor("Light_Type_2",(o,e)=>()=>new Q(o,E.Zero(),E.Zero(),0,0,e));class Q extends ts{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(Q._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):Q._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,s,n,i,r){super(e,r),this._innerAngle=0,this._projectionTextureMatrix=R.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=E.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=E.Zero(),this._projectionTextureViewLightMatrix=R.Zero(),this._projectionTextureProjectionLightMatrix=R.Zero(),this._projectionTextureScalingMatrix=R.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=s,this.angle=n,this.exponent=i}getClassName(){return"SpotLight"}getTypeID(){return Be.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,s){const n=this.getScene().activeCamera;if(!n)return;this._shadowAngleScale=this._shadowAngleScale||1;const i=this._shadowAngleScale*this._angle,r=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;R.PerspectiveFovLHToRef(i,1,l?a:r,l?r:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),R.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,s=e/(e-t),n=-s*t,i=1/Math.tan(this._angle/2),r=1;R.FromValuesToRef(i/r,0,0,0,0,i,0,0,0,0,s,1,0,0,n,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof L){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;R.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let s;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),s=E.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),s=E.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",s.x,s.y,s.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let s;return this.computeTransformedInformation()?s=E.Normalize(this.transformedDirection):s=E.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-s.x,-s.y,-s.z):e.setFloat3(t,s.x,s.y,s.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),s=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?s:this._scene.getEngine().isNDCHalfZRange?0:s}getDepthMaxZ(e){const t=this._scene.getEngine(),s=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:s}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}re([ce()],Q.prototype,"angle",null);re([ce()],Q.prototype,"innerAngle",null);re([ce()],Q.prototype,"shadowAngleScale",null);re([ce()],Q.prototype,"exponent",void 0);re([ce()],Q.prototype,"projectionTextureLightNear",null);re([ce()],Q.prototype,"projectionTextureLightFar",null);re([ce()],Q.prototype,"projectionTextureUpDirection",null);re([fs("projectedLightTexture")],Q.prototype,"_projectionTexture",void 0);Xt.AddNodeConstructor("Light_Type_0",(o,e)=>()=>new Ne(o,E.Zero(),e));class Ne extends ts{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const s=this._shadowGenerators.values();for(let n=s.next();n.done!==!0;n=s.next())n.value.recreateShadowMap()}}constructor(e,t,s){super(e,s),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Be.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new E(1,0,0);case 1:return new E(-1,0,0);case 2:return new E(0,-1,0);case 3:return new E(0,1,0);case 4:return new E(0,0,1);case 5:return new E(0,0,-1)}return E.Zero()}_setDefaultShadowProjectionMatrix(e,t,s){const n=this.getScene().activeCamera;if(!n)return;const i=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,r=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;R.PerspectiveFovLHToRef(this.shadowAngle,1,a?r:i,a?i:r,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}re([ce()],Ne.prototype,"shadowAngle",null);class Ae{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,s=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new q,this._onDataLayoutChanged=new q,this._animationPropertiesOverride=null,this._scene=s||be.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=Ge.Clone(()=>new Ae(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),Ge.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const s=new Ae(e.name,e.influence);if(s.setPositions(e.positions),e.id!=null&&(s.id=e.id),e.normals&&s.setNormals(e.normals),e.tangents&&s.setTangents(e.tangents),e.uvs&&s.setUVs(e.uvs),e.animations){for(let n=0;n<e.animations.length;n++){const i=e.animations[n],r=_s("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}e.autoAnimate&&t&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return s}static FromMesh(e,t,s){t||(t=e.name);const n=new Ae(t,s,e.getScene());return n.setPositions(e.getVerticesData(b.PositionKind)),e.isVerticesDataPresent(b.NormalKind)&&n.setNormals(e.getVerticesData(b.NormalKind)),e.isVerticesDataPresent(b.TangentKind)&&n.setTangents(e.getVerticesData(b.TangentKind)),e.isVerticesDataPresent(b.UVKind)&&n.setUVs(e.getVerticesData(b.UVKind)),n}}re([ce()],Ae.prototype,"id",void 0);class Pt extends L{get depth(){return this._depth}constructor(e,t,s,n,i,r,a=!0,l=!1,h=L.TRILINEAR_SAMPLINGMODE,c=0){super(null,r,!a,l),this.format=i,this._texture=r.getEngine().createRawTexture2DArray(e,t,s,n,i,a,l,h,null,c),this._depth=n,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,s,n,i,r=!0,a=!1,l=3,h=0){return new Pt(e,t,s,n,5,i,r,a,l,h)}}class de{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new ms(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=be.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return de.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(!((e=this._scene)===null||e===void 0)&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new de(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let s=-1;for(const n of this._targets){if(s++,n.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=de.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(n),this._morphTargetTextureIndices[t]=s,this._tempInfluences[t++]=n.influence,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs;const i=n.getPositions();if(i){const r=i.length/3;if(this._vertexCount===0)this._vertexCount=r;else if(this._vertexCount!==r){w.Error("Incompatible target. Targets must all have the same vertices count.");return}}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(let n=0;n<t;n++)this._influences[n]=this._tempInfluences[n];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const s=this._targetStoreTexture.getSize();s.width===this._textureWidth&&s.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const s=this._targets.length,n=new Float32Array(s*this._textureWidth*this._textureHeight*4);let i=0;for(let r=0;r<s;r++){const a=this._targets[r],l=a.getPositions(),h=a.getNormals(),c=a.getUVs(),u=a.getTangents();if(!l){r===0&&w.Error("Invalid morph target. Target must have positions.");return}i=r*this._textureWidth*this._textureHeight*4;for(let d=0;d<this._vertexCount;d++)n[i]=l[d*3],n[i+1]=l[d*3+1],n[i+2]=l[d*3+2],i+=4,h&&(n[i]=h[d*3],n[i+1]=h[d*3+1],n[i+2]=h[d*3+2],i+=4),c&&(n[i]=c[d*2],n[i+1]=c[d*2+1],i+=4),u&&(n[i]=u[d*3],n[i+1]=u[d*3+1],n[i+2]=u[d*3+2],i+=4)}this._targetStoreTexture=Pt.CreateRGBATexture(n,this._textureWidth,this._textureHeight,s,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const s=new de(t);s._uniqueId=e.id;for(const n of e.targets)s.addTarget(Ae.Parse(n,t));return s}}de.EnableTextureStorage=!0;de.MaxActiveMorphTargetsInVertexAttributeMode=8;class Nt extends Os{constructor(e,t,s,n=5,i=0,r=!1,a=!1,l=3,h=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,s,n,i,r,a,l,h)}update(e,t,s,n,i=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,s,n,i)}updateRGBDAsync(e,t=null,s=.8,n=0){return ws(this._texture,e,t,s,n).then(()=>{})}clone(){return Ge.Clone(()=>{const e=this.getScene(),t=this._texture,s=new Nt(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===Oe.CubeRawRGBD&&s.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),s},this)}}function ks(o){return new Promise(e=>{DracoDecoderModule({wasmBinary:o}).then(t=>{e({module:t})})})}function He(o,e,t,s,n,i){const r=new o.DecoderBuffer;r.Init(e,e.byteLength);const a=new o.Decoder;let l,h;try{const c=a.GetEncodedGeometryType(r);switch(c){case o.TRIANGULAR_MESH:l=new o.Mesh,h=a.DecodeBufferToMesh(r,l);break;case o.POINT_CLOUD:l=new o.PointCloud,h=a.DecodeBufferToPointCloud(r,l);break;default:throw new Error(`Invalid geometry type ${c}`)}if(!h.ok()||!l.ptr)throw new Error(h.error_msg());if(c===o.TRIANGULAR_MESH){const f=l.num_faces()*3,m=f*4,_=o._malloc(m);try{a.GetTrianglesUInt32Array(l,m,_);const p=new Uint32Array(f);p.set(new Uint32Array(o.HEAPF32.buffer,_,f)),s(p)}finally{o._free(_)}}const u=(d,f,m=1)=>{const _=f.num_components(),p=l.num_points(),g=p*_,y=g*Float32Array.BYTES_PER_ELEMENT,v=o._malloc(y);try{a.GetAttributeDataArrayForAllPoints(l,f,o.DT_FLOAT32,y,v);const O=new Float32Array(o.HEAPF32.buffer,v,g);if(d==="color"&&_===3){const T=new Float32Array(p*4);for(let M=0,S=0;M<T.length;M+=4,S+=_)T[M+0]=O[S+0],T[M+1]=O[S+1],T[M+2]=O[S+2],T[M+3]=1;n(d,T)}else{const T=new Float32Array(g);if(T.set(new Float32Array(o.HEAPF32.buffer,v,g)),m!==1)for(let M=0;M<T.length;M++)T[M]=T[M]/m;n(d,T)}}finally{o._free(v)}};if(t)for(const d in t){const f=t[d],m=a.GetAttributeByUniqueId(l,f),_=i&&i[d]||1;u(d,m,_)}else{const d={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const f in d){const m=a.GetAttributeId(l,o[d[f]]);if(m!==-1){const _=a.GetAttribute(l,m);u(f,_)}}}}finally{l&&o.destroy(l),o.destroy(a),o.destroy(r)}}function Gs(){let o;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const s=t.decoder;s.url&&(importScripts(s.url),o=DracoDecoderModule({wasmBinary:s.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!o)throw new Error("Draco decoder module is not available");o.then(s=>{He(s,t.dataView,t.attributes,n=>{postMessage({id:"indices",value:n},[n.buffer])},(n,i)=>{postMessage({id:n,value:i},[i.buffer])}),postMessage("done")});break}}}}class te{static get DecoderAvailable(){const e=te.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return te._Default||(te._Default=new te),te._Default}constructor(e=te.DefaultNumWorkers){const t=te.Configuration.decoder,s=t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:P.GetAbsoluteUrl(t.wasmUrl),wasmBinaryPromise:P.LoadFileAsync(P.GetAbsoluteUrl(t.wasmBinaryUrl))}:{url:P.GetAbsoluteUrl(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&typeof Worker=="function"&&typeof URL=="function"?this._workerPoolPromise=s.wasmBinaryPromise.then(n=>{const i=`${He}(${Gs})()`,r=URL.createObjectURL(new Blob([i],{type:"application/javascript"}));return new Ps(e,()=>new Promise((a,l)=>{const h=new Worker(r),c=d=>{h.removeEventListener("error",c),h.removeEventListener("message",u),l(d)},u=d=>{d.data==="done"&&(h.removeEventListener("error",c),h.removeEventListener("message",u),a(h))};h.addEventListener("error",c),h.addEventListener("message",u),h.postMessage({id:"init",decoder:{url:s.url,wasmBinary:n}})}))}):this._decoderModulePromise=s.wasmBinaryPromise.then(n=>{if(!s.url)throw new Error("Draco decoder module is not available");return P.LoadScriptAsync(s.url).then(()=>ks(n))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}decodeMeshAsync(e,t,s){const n=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then(i=>new Promise((r,a)=>{i.push((l,h)=>{const c=new je,u=m=>{l.removeEventListener("error",u),l.removeEventListener("message",d),a(m),h()},d=m=>{if(m.data==="done")l.removeEventListener("error",u),l.removeEventListener("message",d),r(c),h();else if(m.data.id==="indices")c.indices=m.data.value;else{const _=s&&s[m.data.id]?s[m.data.id]:1;if(_!==1)for(let p=0;p<m.data.value.length;p++)m.data.value[p]=m.data.value[p]/_;c.set(m.data.value,m.data.id)}};l.addEventListener("error",u),l.addEventListener("message",d);const f=new Uint8Array(n.byteLength);f.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),l.postMessage({id:"decodeMesh",dataView:f,attributes:t},[f.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(i=>{const r=new je;return He(i.module,n,t,a=>{r.indices=a},(a,l)=>{r.set(l,a)},s),r});throw new Error("Draco decoder module is not available")}}te.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}};te.DefaultNumWorkers=te.GetDefaultNumWorkers();te._Default=null;class le{static get Default(){return le._Default||(le._Default=new le),le._Default}constructor(){const e=le.Configuration.decoder;this._decoderModulePromise=P.LoadScriptAsync(P.GetAbsoluteUrl(e.url)).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,s,n,i){return this._decoderModulePromise.then(()=>{const r=new Uint8Array(t*s);return MeshoptDecoder.decodeGltfBuffer(r,t,s,e,n,i),r})}}le.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}};le._Default=null;H.prototype.thinInstanceAdd=function(o,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return w.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(o)?o.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(o))for(let s=0;s<o.length;++s)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,o[s],s===o.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,o,e);return t};H.prototype.thinInstanceAddSelf=function(o=!0){return this.thinInstanceAdd(R.IdentityReadOnly,o)};H.prototype.thinInstanceRegisterAttribute=function(o,e){o===b.ColorKind&&(o=b.ColorInstanceKind),this.removeVerticesData(o),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[o]=e,this._userThinInstanceBuffersStorage.sizes[o]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[o]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[o]),this._userThinInstanceBuffersStorage.vertexBuffers[o]=new b(this.getEngine(),this._userThinInstanceBuffersStorage.data[o],o,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o])};H.prototype.thinInstanceSetMatrixAt=function(o,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||o>=this._thinInstanceDataStorage.instancesCount)return!1;const s=this._thinInstanceDataStorage.matrixData;return e.copyToArray(s,o*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[o]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};H.prototype.thinInstanceSetAttributeAt=function(o,e,t,s=!0){return o===b.ColorKind&&(o=b.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[o]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(o,0),this._userThinInstanceBuffersStorage.data[o].set(t,e*this._userThinInstanceBuffersStorage.strides[o]),s&&this.thinInstanceBufferUpdated(o),!0)};Object.defineProperty(H.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(o){var e,t;const s=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(t=this.source)===null||t===void 0?void 0:t._thinInstanceDataStorage.matrixData,n=s?s.length/16:0;o<=n&&(this._thinInstanceDataStorage.instancesCount=o)},enumerable:!0,configurable:!0});H.prototype._thinInstanceCreateMatrixBuffer=function(o,e,t=!1){o===b.ColorKind&&(o=b.ColorInstanceKind);const s=new Yt(this.getEngine(),e,!t,16,!1,!0);for(let n=0;n<4;n++)this.setVerticesBuffer(s.createVertexBuffer(o+n,n*4,4));return s};H.prototype.thinInstanceSetBuffer=function(o,e,t=0,s=!1){var n,i,r;t=t||16,o==="matrix"?((n=this._thinInstanceDataStorage.matrixBuffer)===null||n===void 0||n.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,s),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):o==="previousMatrix"?((i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,s))):(o===b.ColorKind&&(o=b.ColorInstanceKind),e===null?!((r=this._userThinInstanceBuffersStorage)===null||r===void 0)&&r.data[o]&&(this.removeVerticesData(o),delete this._userThinInstanceBuffersStorage.data[o],delete this._userThinInstanceBuffersStorage.strides[o],delete this._userThinInstanceBuffersStorage.sizes[o],delete this._userThinInstanceBuffersStorage.vertexBuffers[o]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[o]=e,this._userThinInstanceBuffersStorage.strides[o]=t,this._userThinInstanceBuffersStorage.sizes[o]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[o]=new b(this.getEngine(),e,o,!s,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o])))};H.prototype.thinInstanceBufferUpdated=function(o){var e,t,s;o==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):o==="previousMatrix"?(t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(o===b.ColorKind&&(o=b.ColorInstanceKind),!((s=this._userThinInstanceBuffersStorage)===null||s===void 0)&&s.vertexBuffers[o]&&this._userThinInstanceBuffersStorage.vertexBuffers[o].updateDirectly(this._userThinInstanceBuffersStorage.data[o],0))};H.prototype.thinInstancePartialBufferUpdate=function(o,e,t){var s;o==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(o===b.ColorKind&&(o=b.ColorInstanceKind),!((s=this._userThinInstanceBuffersStorage)===null||s===void 0)&&s.vertexBuffers[o]&&this._userThinInstanceBuffersStorage.vertexBuffers[o].updateDirectly(e,t))};H.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const o=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=R.FromArray(o,e*16)}return this._thinInstanceDataStorage.worldMatrices};H.prototype.thinInstanceRefreshBoundingInfo=function(o=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const s=this._thinInstanceDataStorage.boundingVectors;if(o||!this.rawBoundingInfo){s.length=0,this.refreshBoundingInfo(e,t);const r=this.getBoundingInfo();this.rawBoundingInfo=new Zt(r.minimum,r.maximum)}const n=this.getBoundingInfo(),i=this._thinInstanceDataStorage.matrixData;if(s.length===0)for(let r=0;r<n.boundingBox.vectors.length;++r)s.push(n.boundingBox.vectors[r].clone());j.Vector3[0].setAll(Number.POSITIVE_INFINITY),j.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let r=0;r<this._thinInstanceDataStorage.instancesCount;++r){R.FromArrayToRef(i,r*16,j.Matrix[0]);for(let a=0;a<s.length;++a)E.TransformCoordinatesToRef(s[a],j.Matrix[0],j.Vector3[2]),j.Vector3[0].minimizeInPlace(j.Vector3[2]),j.Vector3[1].maximizeInPlace(j.Vector3[2])}n.reConstruct(j.Vector3[0],j.Vector3[1]),this._updateBoundingInfo()};H.prototype._thinInstanceUpdateBufferSize=function(o,e=1){var t,s,n;o===b.ColorKind&&(o=b.ColorInstanceKind);const i=o==="matrix";if(!i&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[o]))return;const r=i?16:this._userThinInstanceBuffersStorage.strides[o],a=i?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[o];let l=i?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[o];const h=(this._thinInstanceDataStorage.instancesCount+e)*r;let c=a;for(;c<h;)c*=2;if(!l||a!=c){if(!l)l=new Float32Array(c);else{const u=new Float32Array(c);u.set(l,0),l=u}i?((t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=c,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((s=this._thinInstanceDataStorage.previousMatrixBuffer)===null||s===void 0||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):((n=this._userThinInstanceBuffersStorage.vertexBuffers[o])===null||n===void 0||n.dispose(),this._userThinInstanceBuffersStorage.data[o]=l,this._userThinInstanceBuffersStorage.sizes[o]=c,this._userThinInstanceBuffersStorage.vertexBuffers[o]=new b(this.getEngine(),l,o,!0,!1,r,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o]))}};H.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};H.prototype._disposeThinInstanceSpecificData=function(){var o;!((o=this._thinInstanceDataStorage)===null||o===void 0)&&o.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};class Se{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}class De{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return ps(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function Ke(o,e,t,s){const n={externalResourceFunction:i=>s(i).then(r=>new Uint8Array(r))};return t&&(n.uri=e==="file:"?t:e+t),o instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(o),n):GLTFValidator.validateString(o,n)}function js(){const o=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{Ke(t.data,t.rootUrl,t.fileName,s=>new Promise((n,i)=>{const r=o.length;o.push({resolve:n,reject:i}),postMessage({id:"getExternalResource",index:r,uri:s})})).then(s=>{postMessage({id:"validate.resolve",value:s})},s=>{postMessage({id:"validate.reject",reason:s})});break}case"getExternalResource.resolve":{o[t.index].resolve(t.value);break}case"getExternalResource.reject":{o[t.index].reject(t.reason);break}}}}class rs{static ValidateAsync(e,t,s,n){const i=ArrayBuffer.isView(e)?e.slice().buffer:e;return typeof Worker=="function"?new Promise((r,a)=>{const l=`${Ke}(${js})()`,h=URL.createObjectURL(new Blob([l],{type:"application/javascript"})),c=new Worker(h),u=f=>{c.removeEventListener("error",u),c.removeEventListener("message",d),a(f)},d=f=>{const m=f.data;switch(m.id){case"getExternalResource":{n(m.uri).then(_=>{c.postMessage({id:"getExternalResource.resolve",index:m.index,value:_},[_])},_=>{c.postMessage({id:"getExternalResource.reject",index:m.index,reason:_})});break}case"validate.resolve":{c.removeEventListener("error",u),c.removeEventListener("message",d),r(m.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",u),c.removeEventListener("message",d),a(m.reason),c.terminate()}};c.addEventListener("error",u),c.addEventListener("message",d),c.postMessage({id:"init",url:this.Configuration.url}),c.postMessage({id:"validate",data:i,rootUrl:t,fileName:s})}):(this._LoadScriptPromise||(this._LoadScriptPromise=P.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>Ke(i,t,s,n)))}}rs.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};function Ut(o,e,t){try{return Promise.resolve(new Uint8Array(o,e,t))}catch(s){return Promise.reject(s)}}function Ws(o,e,t){try{if(o.byteOffset+t>o.byteLength)throw new Error("Array length out of bounds.");return Promise.resolve(new Uint8Array(o.buffer,o.byteOffset+e,t))}catch(s){return Promise.reject(s)}}var we;(function(o){o[o.AUTO=0]="AUTO",o[o.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(we||(we={}));var xe;(function(o){o[o.NONE=0]="NONE",o[o.FIRST=1]="FIRST",o[o.ALL=2]="ALL"})(xe||(xe={}));var ee;(function(o){o[o.LOADING=0]="LOADING",o[o.READY=1]="READY",o[o.COMPLETE=2]="COMPLETE"})(ee||(ee={}));class V{constructor(){this.onParsedObservable=new q,this.coordinateSystemMode=we.AUTO,this.animationStartMode=xe.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new q,this.onSkinLoadedObservable=new q,this.onTextureLoadedObservable=new q,this.onMaterialLoadedObservable=new q,this.onCameraLoadedObservable=new q,this.onCompleteObservable=new q,this.onErrorObservable=new q,this.onDisposeObservable=new q,this.onExtensionLoadedObservable=new q,this.validate=!1,this.onValidatedObservable=new q,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new q,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,s,n,i,r,a,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,s,n,a,l),null;this._progressCallback=i;const h=t.name||P.GetFilename(t);if(r){if(this.useRangeRequests){this.validate&&w.Warn("glTF validation is not supported when range requests are enabled");const c={abort:()=>{},onCompleteObservable:new q},u={readAsync:(d,f)=>new Promise((m,_)=>{this._loadFile(e,t,p=>{m(new Uint8Array(p))},!0,p=>{_(p)},p=>{p.setRequestHeader("Range",`bytes=${d}-${d+f-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new De(u)).then(d=>{c.onCompleteObservable.notifyObservers(c),n(d)},a?d=>a(void 0,d):void 0),c}return this._loadFile(e,t,c=>{this._validate(e,new Uint8Array(c),s,h),this._unpackBinaryAsync(new De({readAsync:(u,d)=>Ut(c,u,d),byteLength:c.byteLength})).then(u=>{n(u)},a?u=>a(void 0,u):void 0)},!0,a)}return this._loadFile(e,t,c=>{this._validate(e,new Uint8Array(c),s,h),n({json:this._parseJson(c)})},r,a)}_loadBinary(e,t,s,n,i,r){this._validate(e,t,s,r),this._unpackBinaryAsync(new De({readAsync:(a,l)=>Ws(t,a,l),byteLength:t.byteLength})).then(a=>{n(a)},i?a=>i(void 0,a):void 0)}importMeshAsync(e,t,s,n,i,r){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(e,t,null,s,n,i,r)))}loadAsync(e,t,s,n,i){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${i||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,s,n,i)))}loadAssetContainerAsync(e,t,s,n,i){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${i||""}`),this._loader=this._getLoader(t);const r=new $s(e),a=[];this.onMaterialLoadedObservable.add(u=>{a.push(u)});const l=[];this.onTextureLoadedObservable.add(u=>{l.push(u)});const h=[];this.onCameraLoadedObservable.add(u=>{h.push(u)});const c=[];return this.onMeshLoadedObservable.add(u=>{u.morphTargetManager&&c.push(u.morphTargetManager)}),this._loader.importMeshAsync(null,e,r,t,s,n,i).then(u=>(Array.prototype.push.apply(r.geometries,u.geometries),Array.prototype.push.apply(r.meshes,u.meshes),Array.prototype.push.apply(r.particleSystems,u.particleSystems),Array.prototype.push.apply(r.skeletons,u.skeletons),Array.prototype.push.apply(r.animationGroups,u.animationGroups),Array.prototype.push.apply(r.materials,a),Array.prototype.push.apply(r.textures,l),Array.prototype.push.apply(r.lights,u.lights),Array.prototype.push.apply(r.transformNodes,u.transformNodes),Array.prototype.push.apply(r.cameras,h),Array.prototype.push.apply(r.morphTargetManagers,c),r))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+V._MagicBase64Encoded)||e.startsWith("data:;base64,"+V._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+V._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+V._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+V._MagicBase64Encoded)||t.startsWith(";base64,"+V._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+V._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+V._MagicBase64Encoded)){const s=Jt(t);return this._validate(e,new Uint8Array(s)),this._unpackBinaryAsync(new De({readAsync:(n,i)=>Ut(s,n,i),byteLength:s.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new V}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(s=>{t(s)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(ee[this._state]))}_loadFile(e,t,s,n,i,r){const a=e._loadFile(t,s,l=>{this._onProgress(l,a)},!0,n,i,r);return a.onCompleteObservable.add(l=>{this._requests.splice(this._requests.indexOf(l),1)}),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let s=!0,n=0,i=0;for(const r of this._requests){if(r._lengthComputable===void 0||r._loaded===void 0||r._total===void 0)return;s=s&&r._lengthComputable,n+=r._loaded,i+=r._total}this._progressCallback({lengthComputable:s,loaded:n,total:s?i:0})}_validate(e,t,s="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),rs.ValidateAsync(t,s,n,i=>this.preprocessUrlAsync(s+i).then(r=>e._loadFileAsync(r,void 0,!0,!0))).then(i=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(i),this.onValidatedObservable.clear()},i=>{this._endPerformanceCounter("Validate JSON"),P.Warn(`Failed to validate: ${i.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const s=V._parseVersion(t.version);if(!s)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const r=V._parseVersion(t.minVersion);if(!r)throw new Error("Invalid minimum version: "+t.minVersion);if(V._compareVersion(r,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const i={1:V._CreateGLTF1Loader,2:V._CreateGLTF2Loader}[s.major];if(!i)throw new Error("Unsupported version: "+t.version);return i(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},s=e.readUint32();if(s!==t.Magic)throw new gs("Unexpected magic: "+s,As.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const i=e.readUint32();!this.useRangeRequests&&i!==e.buffer.byteLength&&w.Warn(`Length in header does not match actual data length: ${i} != ${e.buffer.byteLength}`);let r;switch(n){case 1:{r=this._unpackBinaryV1Async(e,i);break}case 2:{r=this._unpackBinaryV2Async(e,i);break}default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),r})}_unpackBinaryV1Async(e,t){const s={JSON:0},n=e.readUint32(),i=e.readUint32();if(i!==s.JSON)throw new Error(`Unexpected content format: ${i}`);const r=t-e.byteOffset,a={json:this._parseJson(e.readString(n)),bin:null};if(r!==0){const l=e.byteOffset;a.bin={readAsync:(h,c)=>e.buffer.readAsync(l+h,c),byteLength:r}}return Promise.resolve(a)}_unpackBinaryV2Async(e,t){const s={JSON:1313821514,BIN:5130562},n=e.readUint32();if(e.readUint32()!==s.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+n===t?e.loadAsync(n).then(()=>({json:this._parseJson(e.readString(n)),bin:null})):e.loadAsync(n+8).then(()=>{const r={json:this._parseJson(e.readString(n)),bin:null},a=()=>{const l=e.readUint32();switch(e.readUint32()){case s.JSON:throw new Error("Unexpected JSON chunk");case s.BIN:{const c=e.byteOffset;r.bin={readAsync:(u,d)=>e.buffer.readAsync(c+u,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(a):Promise.resolve(r)};return a()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=V._logSpaces.substr(0,this._logIndentLevel*2);w.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){P.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){P.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}V.IncrementalLoading=!0;V.HomogeneousCoordinates=!1;V._MagicBase64Encoded="Z2xURg";V._logSpaces="                                ";Ft&&Ft.RegisterPlugin(new V);var fe;(function(o){o[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.FLOAT=5126]="FLOAT"})(fe||(fe={}));var qe;(function(o){o[o.FRAGMENT=35632]="FRAGMENT",o[o.VERTEX=35633]="VERTEX"})(qe||(qe={}));var Z;(function(o){o[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.INT=5124]="INT",o[o.UNSIGNED_INT=5125]="UNSIGNED_INT",o[o.FLOAT=5126]="FLOAT",o[o.FLOAT_VEC2=35664]="FLOAT_VEC2",o[o.FLOAT_VEC3=35665]="FLOAT_VEC3",o[o.FLOAT_VEC4=35666]="FLOAT_VEC4",o[o.INT_VEC2=35667]="INT_VEC2",o[o.INT_VEC3=35668]="INT_VEC3",o[o.INT_VEC4=35669]="INT_VEC4",o[o.BOOL=35670]="BOOL",o[o.BOOL_VEC2=35671]="BOOL_VEC2",o[o.BOOL_VEC3=35672]="BOOL_VEC3",o[o.BOOL_VEC4=35673]="BOOL_VEC4",o[o.FLOAT_MAT2=35674]="FLOAT_MAT2",o[o.FLOAT_MAT3=35675]="FLOAT_MAT3",o[o.FLOAT_MAT4=35676]="FLOAT_MAT4",o[o.SAMPLER_2D=35678]="SAMPLER_2D"})(Z||(Z={}));var Me;(function(o){o[o.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",o[o.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",o[o.REPEAT=10497]="REPEAT"})(Me||(Me={}));var ie;(function(o){o[o.NEAREST=9728]="NEAREST",o[o.LINEAR=9728]="LINEAR",o[o.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",o[o.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",o[o.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",o[o.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ie||(ie={}));var $t;(function(o){o[o.ALPHA=6406]="ALPHA",o[o.RGB=6407]="RGB",o[o.RGBA=6408]="RGBA",o[o.LUMINANCE=6409]="LUMINANCE",o[o.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})($t||($t={}));var ze;(function(o){o[o.FRONT=1028]="FRONT",o[o.BACK=1029]="BACK",o[o.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(ze||(ze={}));var G;(function(o){o[o.ZERO=0]="ZERO",o[o.ONE=1]="ONE",o[o.SRC_COLOR=768]="SRC_COLOR",o[o.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",o[o.DST_COLOR=774]="DST_COLOR",o[o.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",o[o.SRC_ALPHA=770]="SRC_ALPHA",o[o.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",o[o.DST_ALPHA=772]="DST_ALPHA",o[o.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",o[o.CONSTANT_COLOR=32769]="CONSTANT_COLOR",o[o.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",o[o.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",o[o.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",o[o.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(G||(G={}));class K{static SetMatrix(e,t,s,n,i){let r=null;if(s.semantic==="MODEL"?r=t.getWorldMatrix():s.semantic==="PROJECTION"?r=e.getProjectionMatrix():s.semantic==="VIEW"?r=e.getViewMatrix():s.semantic==="MODELVIEWINVERSETRANSPOSE"?r=R.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):s.semantic==="MODELVIEW"?r=t.getWorldMatrix().multiply(e.getViewMatrix()):s.semantic==="MODELVIEWPROJECTION"?r=t.getWorldMatrix().multiply(e.getTransformMatrix()):s.semantic==="MODELINVERSE"?r=t.getWorldMatrix().invert():s.semantic==="VIEWINVERSE"?r=e.getViewMatrix().invert():s.semantic==="PROJECTIONINVERSE"?r=e.getProjectionMatrix().invert():s.semantic==="MODELVIEWINVERSE"?r=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():s.semantic==="MODELVIEWPROJECTIONINVERSE"?r=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():s.semantic==="MODELINVERSETRANSPOSE"&&(r=R.Transpose(t.getWorldMatrix().invert())),r)switch(s.type){case Z.FLOAT_MAT2:i.setMatrix2x2(n,R.GetAsMatrix2x2(r));break;case Z.FLOAT_MAT3:i.setMatrix3x3(n,R.GetAsMatrix3x3(r));break;case Z.FLOAT_MAT4:i.setMatrix(n,r);break}}static SetUniform(e,t,s,n){switch(n){case Z.FLOAT:return e.setFloat(t,s),!0;case Z.FLOAT_VEC2:return e.setVector2(t,Ts.FromArray(s)),!0;case Z.FLOAT_VEC3:return e.setVector3(t,E.FromArray(s)),!0;case Z.FLOAT_VEC4:return e.setVector4(t,ys.FromArray(s)),!0;default:return!1}}static GetWrapMode(e){switch(e){case Me.CLAMP_TO_EDGE:return L.CLAMP_ADDRESSMODE;case Me.MIRRORED_REPEAT:return L.MIRROR_ADDRESSMODE;case Me.REPEAT:return L.WRAP_ADDRESSMODE;default:return L.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case ie.LINEAR:case ie.LINEAR_MIPMAP_NEAREST:case ie.LINEAR_MIPMAP_LINEAR:return L.TRILINEAR_SAMPLINGMODE;case ie.NEAREST:case ie.NEAREST_MIPMAP_NEAREST:return L.NEAREST_SAMPLINGMODE;default:return L.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,s,n,i){s=t.byteOffset+s;const r=e.loadedBufferViews[t.buffer];if(s+n>r.byteLength)throw new Error("Buffer access is out of range");const a=r.buffer;switch(s+=r.byteOffset,i){case fe.BYTE:return new Int8Array(a,s,n);case fe.UNSIGNED_BYTE:return new Uint8Array(a,s,n);case fe.SHORT:return new Int16Array(a,s,n);case fe.UNSIGNED_SHORT:return new Uint16Array(a,s,n);default:return new Float32Array(a,s,n)}}static GetBufferFromAccessor(e,t){const s=e.bufferViews[t.bufferView],n=t.count*K.GetByteStrideFromType(t);return K.GetBufferFromBufferView(e,s,t.byteOffset,n,t.componentType)}static DecodeBufferToText(e){let t="";const s=e.byteLength;for(let n=0;n<s;++n)t+=String.fromCharCode(e[n]);return t}static GetDefaultMaterial(e){if(!K._DefaultMaterial){pe.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),pe.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},s={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};K._DefaultMaterial=new Qt("GLTFDefaultMaterial",e,t,s),K._DefaultMaterial.setColor4("u_emission",new xs(.5,.5,.5,1))}return K._DefaultMaterial}}K._DefaultMaterial=null;var _e;(function(o){o[o.IDENTIFIER=1]="IDENTIFIER",o[o.UNKNOWN=2]="UNKNOWN",o[o.END_OF_INPUT=3]="END_OF_INPUT"})(_e||(_e={}));class Vt{constructor(e){this._pos=0,this.currentToken=_e.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return _e.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=_e.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=_e.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const os=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],as=["world","view","projection","worldView","worldViewProjection","mBones"],Hs=["translation","rotation","scale"],Ks=["position","rotationQuaternion","scaling"],qs=(o,e)=>{for(const t in o){const s=o[t];e.buffers[t]=s,e.buffersCount++}},zs=(o,e)=>{for(const t in o){const s=o[t];e.shaders[t]=s,e.shaderscount++}},X=(o,e,t)=>{for(const s in o){const n=o[s];t[e][s]=n}},Xs=o=>{if(o)for(let e=0;e<o.length/2;e++)o[e*2+1]=1-o[e*2+1]},kt=o=>{if(o.semantic==="NORMAL")return"normal";if(o.semantic==="POSITION")return"position";if(o.semantic==="JOINT")return"matricesIndices";if(o.semantic==="WEIGHT")return"matricesWeights";if(o.semantic==="COLOR")return"color";if(o.semantic&&o.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(o.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Ys=o=>{for(const e in o.animations){const t=o.animations[e];if(!t.channels||!t.samplers)continue;let s=null;for(let n=0;n<t.channels.length;n++){const i=t.channels[n],r=t.samplers[i.sampler];if(!r)continue;let a=null,l=null;t.parameters?(a=t.parameters[r.input],l=t.parameters[r.output]):(a=r.input,l=r.output);const h=K.GetBufferFromAccessor(o,o.accessors[a]),c=K.GetBufferFromAccessor(o,o.accessors[l]),u=i.target.id;let d=o.scene.getNodeById(u);if(d===null&&(d=o.scene.getNodeByName(u)),d===null){P.Warn("Creating animation named "+e+". But cannot find node named "+u+" to attach to");continue}const f=d instanceof ye;let m=i.target.path;const _=Hs.indexOf(m);_!==-1&&(m=Ks[_]);let p=I.ANIMATIONTYPE_MATRIX;f||(m==="rotationQuaternion"?(p=I.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new J):p=I.ANIMATIONTYPE_VECTOR3);let g=null;const y=[];let v=0,O=!1;f&&s&&s.getKeys().length===h.length&&(g=s,O=!0),O||(o.scene._blockEntityCollection=!!o.assetContainer,g=new I(e,f?"_matrix":m,1,p,I.ANIMATIONLOOPMODE_CYCLE),o.scene._blockEntityCollection=!1);for(let T=0;T<h.length;T++){let M=null;if(m==="rotationQuaternion"?(M=J.FromArray([c[v],c[v+1],c[v+2],c[v+3]]),v+=4):(M=E.FromArray([c[v],c[v+1],c[v+2]]),v+=3),f){const S=d;let N=E.Zero(),B=new J,F=E.Zero(),k=S.getBaseMatrix();O&&s&&(k=s.getKeys()[T].value),k.decompose(F,B,N),m==="position"?N=M:m==="rotationQuaternion"?B=M:F=M,M=R.Compose(F,B,N)}O?s&&(s.getKeys()[T].value=M):y.push({frame:h[T],value:M})}!O&&g&&(g.setKeys(y),d.animations.push(g)),s=g,o.scene.stopAnimation(d),o.scene.beginAnimation(d,0,h[h.length-1],!0,1)}}},Lt=o=>{let e=null;if(o.translation||o.rotation||o.scale){const t=E.FromArray(o.scale||[1,1,1]),s=J.FromArray(o.rotation||[0,0,0,1]),n=E.FromArray(o.translation||[0,0,0]);e=R.Compose(t,s,n)}else e=R.FromArray(o.matrix);return e},ls=(o,e,t,s)=>{for(let i=0;i<s.bones.length;i++)if(s.bones[i].name===t)return s.bones[i];const n=o.nodes;for(const i in n){const r=n[i];if(!r.jointName)continue;const a=r.children;for(let l=0;l<a.length;l++){const h=o.nodes[a[l]];if(h.jointName&&h.jointName===t){const c=Lt(r),u=new ye(r.name||"",s,ls(o,e,r.jointName,s),c);return u.id=i,u}}}return null},Zs=(o,e)=>{for(let t=0;t<o.length;t++){const s=o[t];for(let n=0;n<s.node.children.length;n++)if(s.node.children[n]===e)return s.bone}return null},Ue=(o,e)=>{const t=o.nodes;let s=t[e];if(s)return{node:s,id:e};for(const n in t)if(s=t[n],s.jointName===e)return{node:s,id:n};return null},Js=(o,e)=>{for(let t=0;t<o.jointNames.length;t++)if(o.jointNames[t]===e)return!0;return!1},Qs=(o,e,t,s)=>{for(const n in o.nodes){const i=o.nodes[n],r=n;if(!i.jointName||Js(t,i.jointName))continue;const a=Lt(i),l=new ye(i.name||"",e,null,a);l.id=r,s.push({bone:l,node:i,id:r})}for(let n=0;n<s.length;n++){const i=s[n],r=i.node.children;for(let a=0;a<r.length;a++){let l=null;for(let h=0;h<s.length;h++)if(s[h].id===r[a]){l=s[h];break}l&&(l.bone._parent=i.bone,i.bone.children.push(l.bone))}}},en=(o,e,t,s)=>{if(s||(s=new Ee(e.name||"","",o.scene)),!e.babylonSkeleton)return s;const n=[],i=[];Qs(o,s,e,n),s.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=Ue(o,e.jointNames[a]);if(!l)continue;const h=l.node;if(!h){P.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const c=l.id,u=o.scene.getBoneById(c);if(u){s.bones.push(u);continue}let d=!1,f=null;for(let p=0;p<a;p++){const g=Ue(o,e.jointNames[p]);if(!g)continue;const y=g.node;if(!y){P.Warn("Joint named "+e.jointNames[p]+" does not exist when looking for parent");continue}const v=y.children;if(v){d=!1;for(let O=0;O<v.length;O++)if(v[O]===c){f=ls(o,e,e.jointNames[p],s),d=!0;break}if(d)break}}const m=Lt(h);!f&&n.length>0&&(f=Zs(n,c),f&&i.indexOf(f)===-1&&i.push(f));const _=new ye(h.jointName||"",s,f,m);_.id=c}const r=s.bones;s.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=Ue(o,e.jointNames[a]);if(l){for(let h=0;h<r.length;h++)if(r[h].id===l.id){s.bones.push(r[h]);break}}}s.prepare();for(let a=0;a<i.length;a++)s.bones.push(i[a]);return s},Gt=(o,e,t,s,n)=>{if(n||(o.scene._blockEntityCollection=!!o.assetContainer,n=new H(e.name||"",o.scene),n._parentContainer=o.assetContainer,o.scene._blockEntityCollection=!1,n.id=s),!e.babylonNode)return n;const i=[];let r=null;const a=new Array,l=new Array,h=new Array,c=new Array;for(let f=0;f<t.length;f++){const m=t[f],_=o.meshes[m];if(_)for(let p=0;p<_.primitives.length;p++){const g=new je,y=_.primitives[p];y.mode;const v=y.attributes;let O=null,T=null;for(const S in v)if(O=o.accessors[v[S]],T=K.GetBufferFromAccessor(o,O),S==="NORMAL")g.normals=new Float32Array(T.length),g.normals.set(T);else if(S==="POSITION"){if(V.HomogeneousCoordinates){g.positions=new Float32Array(T.length-T.length/4);for(let N=0;N<T.length;N+=4)g.positions[N]=T[N],g.positions[N+1]=T[N+1],g.positions[N+2]=T[N+2]}else g.positions=new Float32Array(T.length),g.positions.set(T);l.push(g.positions.length)}else if(S.indexOf("TEXCOORD_")!==-1){const N=Number(S.split("_")[1]),B=b.UVKind+(N===0?"":N+1),F=new Float32Array(T.length);F.set(T),Xs(F),g.set(F,B)}else S==="JOINT"?(g.matricesIndices=new Float32Array(T.length),g.matricesIndices.set(T)):S==="WEIGHT"?(g.matricesWeights=new Float32Array(T.length),g.matricesWeights.set(T)):S==="COLOR"&&(g.colors=new Float32Array(T.length),g.colors.set(T));if(O=o.accessors[y.indices],O)T=K.GetBufferFromAccessor(o,O),g.indices=new Int32Array(T.length),g.indices.set(T),c.push(g.indices.length);else{const S=[];for(let N=0;N<g.positions.length/3;N++)S.push(N);g.indices=new Int32Array(S),c.push(g.indices.length)}r?r.merge(g):r=g;const M=o.scene.getMaterialById(y.material);i.push(M===null?K.GetDefaultMaterial(o.scene):M),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),h.push(h.length===0?0:h[h.length-1]+c[c.length-2])}}let u;o.scene._blockEntityCollection=!!o.assetContainer,i.length>1?(u=new Es("multimat"+s,o.scene),u.subMaterials=i):u=new Mt("multimat"+s,o.scene),i.length===1&&(u=i[0]),u._parentContainer=o.assetContainer,n.material||(n.material=u),new Ct(s,o.scene,r,!1,n),n.computeWorldMatrix(!0),o.scene._blockEntityCollection=!1,n.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){const m=t[f],_=o.meshes[m];if(_)for(let p=0;p<_.primitives.length;p++)_.primitives[p].mode,vs.AddToMesh(d,a[d],l[d],h[d],c[d],n,n,!0),d++}return n},Xe=(o,e,t,s)=>{o.position&&(o.position=e),(o.rotationQuaternion||o.rotation)&&(o.rotationQuaternion=t),o.scaling&&(o.scaling=s)},tn=(o,e)=>{if(e.matrix){const t=new E(0,0,0),s=new J,n=new E(0,0,0);R.FromArray(e.matrix).decompose(n,s,t),Xe(o,t,s,n)}else e.translation&&e.rotation&&e.scale&&Xe(o,E.FromArray(e.translation),J.FromArray(e.rotation),E.FromArray(e.scale));o.computeWorldMatrix(!0)},sn=(o,e,t)=>{let s=null;if(o.importOnlyMeshes&&(e.skin||e.meshes)&&o.importMeshesNames&&o.importMeshesNames.length>0&&o.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const n=o.skins[e.skin],i=Gt(o,e,e.meshes,t,e.babylonNode);i.skeleton=o.scene.getLastSkeletonById(e.skin),i.skeleton===null&&(i.skeleton=en(o,n,i,n.babylonSkeleton),n.babylonSkeleton||(n.babylonSkeleton=i.skeleton)),s=i}}else if(e.meshes)s=Gt(o,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!o.importOnlyMeshes){const n=o.lights[e.light];if(n){if(n.type==="ambient"){const i=n[n.type],r=new es(e.light,E.Zero(),o.scene);r.name=e.name||"",i.color&&(r.diffuse=U.FromArray(i.color)),s=r}else if(n.type==="directional"){const i=n[n.type],r=new Ot(e.light,E.Zero(),o.scene);r.name=e.name||"",i.color&&(r.diffuse=U.FromArray(i.color)),s=r}else if(n.type==="point"){const i=n[n.type],r=new Ne(e.light,E.Zero(),o.scene);r.name=e.name||"",i.color&&(r.diffuse=U.FromArray(i.color)),s=r}else if(n.type==="spot"){const i=n[n.type],r=new Q(e.light,E.Zero(),E.Zero(),0,0,o.scene);r.name=e.name||"",i.color&&(r.diffuse=U.FromArray(i.color)),i.fallOfAngle&&(r.angle=i.fallOfAngle),i.fallOffExponent&&(r.exponent=i.fallOffExponent),s=r}}}else if(e.camera&&!e.babylonNode&&!o.importOnlyMeshes){const n=o.cameras[e.camera];if(n){if(o.scene._blockEntityCollection=!!o.assetContainer,n.type==="orthographic"){const i=new We(e.camera,E.Zero(),o.scene,!1);i.name=e.name||"",i.mode=It.ORTHOGRAPHIC_CAMERA,i.attachControl(),s=i,i._parentContainer=o.assetContainer}else if(n.type==="perspective"){const i=n[n.type],r=new We(e.camera,E.Zero(),o.scene,!1);r.name=e.name||"",r.attachControl(),i.aspectRatio||(i.aspectRatio=o.scene.getEngine().getRenderWidth()/o.scene.getEngine().getRenderHeight()),i.znear&&i.zfar&&(r.maxZ=i.zfar,r.minZ=i.znear),s=r,r._parentContainer=o.assetContainer}o.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(s===null){o.scene._blockEntityCollection=!!o.assetContainer;const n=new H(e.name||"",o.scene);n._parentContainer=o.assetContainer,o.scene._blockEntityCollection=!1,e.babylonNode=n,s=n}}if(s!==null){if(e.matrix&&s instanceof H)tn(s,e);else{const n=e.translation||[0,0,0],i=e.rotation||[0,0,0,1],r=e.scale||[1,1,1];Xe(s,E.FromArray(n),J.FromArray(i),E.FromArray(r))}s.updateCache(!0),e.babylonNode=s}return s},Pe=(o,e,t,s=!1)=>{const n=o.nodes[e];let i=null;if(o.importOnlyMeshes&&!s&&o.importMeshesNames?o.importMeshesNames.indexOf(n.name||"")!==-1||o.importMeshesNames.length===0?s=!0:s=!1:s=!0,!n.jointName&&s&&(i=sn(o,n,e),i!==null&&(i.id=e,i.parent=t)),n.children)for(let r=0;r<n.children.length;r++)Pe(o,n.children[r],i,s)},jt=o=>{let e=o.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Pe(o,e.nodes[t],null);else for(const t in o.scenes){e=o.scenes[t];for(let s=0;s<e.nodes.length;s++)Pe(o,e.nodes[s],null)}Ys(o);for(let t=0;t<o.scene.skeletons.length;t++){const s=o.scene.skeletons[t];o.scene.beginAnimation(s,0,Number.MAX_VALUE,!0,1)}},nn=(o,e,t,s,n,i,r)=>{const a=i.values||n.parameters;for(const l in t){const h=t[l],c=h.type;if(c===Z.FLOAT_MAT2||c===Z.FLOAT_MAT3||c===Z.FLOAT_MAT4){if(h.semantic&&!h.source&&!h.node)K.SetMatrix(e.scene,o,h,l,s.getEffect());else if(h.semantic&&(h.source||h.node)){let u=e.scene.getNodeByName(h.source||h.node||"");if(u===null&&(u=e.scene.getNodeById(h.source||h.node||"")),u===null)continue;K.SetMatrix(e.scene,u,h,l,s.getEffect())}}else{const u=a[n.uniforms[l]];if(!u)continue;if(c===Z.SAMPLER_2D){const d=e.textures[i.values?u:h.value].babylonTexture;if(d==null)continue;s.getEffect().setTexture(l,d)}else K.SetUniform(s.getEffect(),l,u,c)}}r(s)},rn=(o,e,t,s,n)=>{const i=s.values||t.parameters,r=t.uniforms;for(const a in n){const l=n[a],h=l.type;let c=i[r[a]];if(c===void 0&&(c=l.value),!c)continue;const u=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete n[d])};h===Z.SAMPLER_2D?z.LoadTextureAsync(o,s.values?c:l.value,u(a),()=>u(null)):l.value&&K.SetUniform(e,a,s.values?c:l.value,h)&&delete n[a]}},on=(o,e,t)=>(s,n)=>{e.dispose(!0),t("Cannot compile program named "+o.name+". Error: "+n+". Default material will be applied")},an=(o,e,t,s,n,i)=>r=>{rn(o,e,t,s,n),e.onBind=a=>{nn(a,o,n,e,t,s,i)}},Wt=(o,e,t)=>{for(const s in e.uniforms){const n=e.uniforms[s],i=e.parameters[n];if(o.currentIdentifier===s&&i.semantic&&!i.source&&!i.node){const r=os.indexOf(i.semantic);if(r!==-1)return delete t[s],as[r]}}return o.currentIdentifier},Ht=o=>{for(const e in o.materials)z.LoadMaterialAsync(o,e,()=>{},()=>{})};class ae{static CreateRuntime(e,t,s){const n={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:s,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&X(e.extensions,"extensions",n),e.extensionsUsed&&X(e.extensionsUsed,"extensionsUsed",n),e.buffers&&qs(e.buffers,n),e.bufferViews&&X(e.bufferViews,"bufferViews",n),e.accessors&&X(e.accessors,"accessors",n),e.meshes&&X(e.meshes,"meshes",n),e.lights&&X(e.lights,"lights",n),e.cameras&&X(e.cameras,"cameras",n),e.nodes&&X(e.nodes,"nodes",n),e.images&&X(e.images,"images",n),e.textures&&X(e.textures,"textures",n),e.shaders&&zs(e.shaders,n),e.programs&&X(e.programs,"programs",n),e.samplers&&X(e.samplers,"samplers",n),e.techniques&&X(e.techniques,"techniques",n),e.materials&&X(e.materials,"materials",n),e.animations&&X(e.animations,"animations",n),e.skins&&X(e.skins,"skins",n),e.scenes&&(n.scenes=e.scenes),e.scene&&e.scenes&&(n.currentScene=e.scenes[e.scene]),n}static LoadBufferAsync(e,t,s,n,i){const r=e.buffers[t];P.IsBase64(r.uri)?setTimeout(()=>s(new Uint8Array(P.DecodeBase64(r.uri)))):P.LoadFile(e.rootUrl+r.uri,a=>s(new Uint8Array(a)),i,void 0,!0,a=>{a&&n(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,s,n){const i=e.textures[t];if(!i||!i.source){n("");return}if(i.babylonTexture){s(null);return}const r=e.images[i.source];P.IsBase64(r.uri)?setTimeout(()=>s(new Uint8Array(P.DecodeBase64(r.uri)))):P.LoadFile(e.rootUrl+r.uri,a=>s(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&n(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,s,n){const i=e.textures[t];if(i.babylonTexture){n(i.babylonTexture);return}const r=e.samplers[i.sampler],a=r.minFilter===ie.NEAREST_MIPMAP_NEAREST||r.minFilter===ie.NEAREST_MIPMAP_LINEAR||r.minFilter===ie.LINEAR_MIPMAP_NEAREST||r.minFilter===ie.LINEAR_MIPMAP_LINEAR,l=L.BILINEAR_SAMPLINGMODE,h=s==null?new Blob:new Blob([s]),c=URL.createObjectURL(h),u=()=>URL.revokeObjectURL(c),d=new L(c,e.scene,!a,!0,l,u,u);r.wrapS!==void 0&&(d.wrapU=K.GetWrapMode(r.wrapS)),r.wrapT!==void 0&&(d.wrapV=K.GetWrapMode(r.wrapT)),d.name=t,i.babylonTexture=d,n(d)}static LoadShaderStringAsync(e,t,s,n){const i=e.shaders[t];if(P.IsBase64(i.uri)){const r=atob(i.uri.split(",")[1]);s&&s(r)}else P.LoadFile(e.rootUrl+i.uri,s,void 0,void 0,!1,r=>{r&&n&&n(r.status+" "+r.statusText)})}static LoadMaterialAsync(e,t,s,n){const i=e.materials[t];if(!i.technique){n&&n("No technique found.");return}const r=e.techniques[i.technique];if(!r){e.scene._blockEntityCollection=!!e.assetContainer;const M=new Mt(t,e.scene);M._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,M.diffuseColor=new U(.5,.5,.5),M.sideOrientation=se.CounterClockWiseSideOrientation,s(M);return}const a=e.programs[r.program],l=r.states,h=pe.ShadersStore[a.vertexShader+"VertexShader"],c=pe.ShadersStore[a.fragmentShader+"PixelShader"];let u="",d="";const f=new Vt(h),m=new Vt(c),_={},p=[],g=[],y=[];for(const M in r.uniforms){const S=r.uniforms[M],N=r.parameters[S];if(_[M]=N,N.semantic&&!N.node&&!N.source){const B=os.indexOf(N.semantic);B!==-1?(p.push(as[B]),delete _[M]):p.push(M)}else N.type===Z.SAMPLER_2D?y.push(M):p.push(M)}for(const M in r.attributes){const S=r.attributes[M],N=r.parameters[S];if(N.semantic){const B=kt(N);B&&g.push(B)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==_e.IDENTIFIER){u+=f.currentString;continue}let S=!1;for(const N in r.attributes){const B=r.attributes[N],F=r.parameters[B];if(f.currentIdentifier===N&&F.semantic){u+=kt(F),S=!0;break}}S||(u+=Wt(f,r,_))}for(;!m.isEnd()&&m.getNextToken();){if(m.currentToken!==_e.IDENTIFIER){d+=m.currentString;continue}d+=Wt(m,r,_)}const v={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},O={attributes:g,uniforms:p,samplers:y,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};pe.ShadersStore[a.vertexShader+t+"VertexShader"]=u,pe.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;const T=new Qt(t,e.scene,v,O);if(T.onError=on(a,T,n),T.onCompiled=an(e,T,r,i,_,s),T.sideOrientation=se.CounterClockWiseSideOrientation,l&&l.functions){const M=l.functions;M.cullFace&&M.cullFace[0]!==ze.BACK&&(T.backFaceCulling=!1);const S=M.blendFuncSeparate;S&&(S[0]===G.SRC_ALPHA&&S[1]===G.ONE_MINUS_SRC_ALPHA&&S[2]===G.ONE&&S[3]===G.ONE?T.alphaMode=me.ALPHA_COMBINE:S[0]===G.ONE&&S[1]===G.ONE&&S[2]===G.ZERO&&S[3]===G.ONE?T.alphaMode=me.ALPHA_ONEONE:S[0]===G.SRC_ALPHA&&S[1]===G.ONE&&S[2]===G.ZERO&&S[3]===G.ONE?T.alphaMode=me.ALPHA_ADD:S[0]===G.ZERO&&S[1]===G.ONE_MINUS_SRC_COLOR&&S[2]===G.ONE&&S[3]===G.ONE?T.alphaMode=me.ALPHA_SUBTRACT:S[0]===G.DST_COLOR&&S[1]===G.ZERO&&S[2]===G.ONE&&S[3]===G.ONE?T.alphaMode=me.ALPHA_MULTIPLY:S[0]===G.SRC_ALPHA&&S[1]===G.ONE_MINUS_SRC_COLOR&&S[2]===G.ONE&&S[3]===G.ONE&&(T.alphaMode=me.ALPHA_MAXIMIZED))}}}let ve=class Ye{static RegisterExtension(e){if(Ye.Extensions[e.name]){P.Error('Tool with the same name "'+e.name+'" already exists');return}Ye.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,s,n,i,r,a,l){return t.useRightHandedSystem=!0,z.LoadRuntimeAsync(t,s,n,h=>{h.assetContainer=i,h.importOnlyMeshes=!0,e===""?h.importMeshesNames=[]:typeof e=="string"?h.importMeshesNames=[e]:e&&!(e instanceof Array)?h.importMeshesNames=[e]:(h.importMeshesNames=[],P.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(h);const c=new Array,u=new Array;for(const d in h.nodes){const f=h.nodes[d];f.babylonNode instanceof bs&&c.push(f.babylonNode)}for(const d in h.skins){const f=h.skins[d];f.babylonSkeleton instanceof Ee&&u.push(f.babylonSkeleton)}this._loadBuffersAsync(h,()=>{this._loadShadersAsync(h,()=>{Ht(h),jt(h),!V.IncrementalLoading&&r&&r(c,u)})}),V.IncrementalLoading&&r&&r(c,u)},l),!0}importMeshAsync(e,t,s,n,i,r){return new Promise((a,l)=>{this._importMeshAsync(e,t,n,i,s,(h,c)=>{a({meshes:h,particleSystems:[],skeletons:c,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},r,h=>{l(new Error(h))})})}_loadAsync(e,t,s,n,i,r){e.useRightHandedSystem=!0,z.LoadRuntimeAsync(e,t,s,a=>{z.LoadRuntimeExtensionsAsync(a,()=>{this._createNodes(a),this._loadBuffersAsync(a,()=>{this._loadShadersAsync(a,()=>{Ht(a),jt(a),V.IncrementalLoading||n()})}),V.IncrementalLoading&&n()},r)},r)}loadAsync(e,t,s,n){return new Promise((i,r)=>{this._loadAsync(e,t,s,()=>{i()},n,a=>{r(new Error(a))})})}_loadShadersAsync(e,t){let s=!1;const n=(i,r)=>{z.LoadShaderStringAsync(e,i,a=>{a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(pe.ShadersStore[i+(r.type===qe.VERTEX?"VertexShader":"PixelShader")]=a),e.loadedShaderCount===e.shaderscount&&t())},()=>{P.Error("Error when loading shader program named "+i+" located at "+r.uri)})};for(const i in e.shaders){s=!0;const r=e.shaders[i];r?n.bind(this,i,r)():P.Error("No shader named: "+i)}s||t()}_loadBuffersAsync(e,t){let s=!1;const n=(i,r)=>{z.LoadBufferAsync(e,i,a=>{e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[i].byteLength&&P.Error("Buffer named "+i+" is length "+a.byteLength+". Expected: "+r.byteLength),e.loadedBufferViews[i]=a),e.loadedBufferCount===e.buffersCount&&t()},()=>{P.Error("Error when loading buffer named "+i+" located at "+r.uri)})};for(const i in e.buffers){s=!0;const r=e.buffers[i];r?n.bind(this,i,r)():P.Error("No buffer named: "+i)}s||t()}_createNodes(e){let t=e.currentScene;if(t)for(let s=0;s<t.nodes.length;s++)Pe(e,t.nodes[s],null);else for(const s in e.scenes){t=e.scenes[s];for(let n=0;n<t.nodes.length;n++)Pe(e,t.nodes[n],null)}}};ve.Extensions={};class z{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,s,n,i){return!1}loadRuntimeExtensionsAsync(e,t,s){return!1}loadBufferAsync(e,t,s,n,i){return!1}loadTextureBufferAsync(e,t,s,n){return!1}createTextureAsync(e,t,s,n,i){return!1}loadShaderStringAsync(e,t,s,n){return!1}loadMaterialAsync(e,t,s,n){return!1}static LoadRuntimeAsync(e,t,s,n,i){z._ApplyExtensions(r=>r.loadRuntimeAsync(e,t,s,n,i),()=>{setTimeout(()=>{n&&n(ae.CreateRuntime(t.json,e,s))})})}static LoadRuntimeExtensionsAsync(e,t,s){z._ApplyExtensions(n=>n.loadRuntimeExtensionsAsync(e,t,s),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,s,n,i){z._ApplyExtensions(r=>r.loadBufferAsync(e,t,s,n,i),()=>{ae.LoadBufferAsync(e,t,s,n,i)})}static LoadTextureAsync(e,t,s,n){z._LoadTextureBufferAsync(e,t,i=>{i&&z._CreateTextureAsync(e,t,i,s,n)},n)}static LoadShaderStringAsync(e,t,s,n){z._ApplyExtensions(i=>i.loadShaderStringAsync(e,t,s,n),()=>{ae.LoadShaderStringAsync(e,t,s,n)})}static LoadMaterialAsync(e,t,s,n){z._ApplyExtensions(i=>i.loadMaterialAsync(e,t,s,n),()=>{ae.LoadMaterialAsync(e,t,s,n)})}static _LoadTextureBufferAsync(e,t,s,n){z._ApplyExtensions(i=>i.loadTextureBufferAsync(e,t,s,n),()=>{ae.LoadTextureBufferAsync(e,t,s,n)})}static _CreateTextureAsync(e,t,s,n,i){z._ApplyExtensions(r=>r.createTextureAsync(e,t,s,n,i),()=>{ae.CreateTextureAsync(e,t,s,n)})}static _ApplyExtensions(e,t){for(const s in ve.Extensions){const n=ve.Extensions[s];if(e(n))return}t()}}V._CreateGLTF1Loader=()=>new ve;const ln="binary_glTF";class hn extends z{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,s,n){const i=t.json.extensionsUsed;return!i||i.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,n(ae.CreateRuntime(t.json,e,s)),!0)}loadBufferAsync(e,t,s,n){return e.extensionsUsed.indexOf(this.name)===-1||t!==ln?!1:(this._bin.readAsync(0,this._bin.byteLength).then(s,i=>n(i.message)),!0)}loadTextureBufferAsync(e,t,s){const n=e.textures[t],i=e.images[n.source];if(!i.extensions||!(this.name in i.extensions))return!1;const r=i.extensions[this.name],a=e.bufferViews[r.bufferView],l=K.GetBufferFromBufferView(e,a,0,a.byteLength,fe.UNSIGNED_BYTE);return s(l),!0}loadShaderStringAsync(e,t,s){const n=e.shaders[t];if(!n.extensions||!(this.name in n.extensions))return!1;const i=n.extensions[this.name],r=e.bufferViews[i.bufferView],a=K.GetBufferFromBufferView(e,r,0,r.byteLength,fe.UNSIGNED_BYTE);return setTimeout(()=>{const l=K.DecodeBufferToText(a);s(l)}),!0}}ve.RegisterExtension(new hn);class cn extends z{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const s=t.lights;if(s)for(const n in s){const i=s[n];switch(i.type){case"ambient":{const r=new es(i.name,new E(0,1,0),e.scene),a=i.ambient;a&&(r.diffuse=U.FromArray(a.color||[1,1,1]));break}case"point":{const r=new Ne(i.name,new E(10,10,10),e.scene),a=i.point;a&&(r.diffuse=U.FromArray(a.color||[1,1,1]));break}case"directional":{const r=new Ot(i.name,new E(0,-1,0),e.scene),a=i.directional;a&&(r.diffuse=U.FromArray(a.color||[1,1,1]));break}case"spot":{const r=i.spot;if(r){const a=new Q(i.name,new E(0,10,0),new E(0,-1,0),r.fallOffAngle||Math.PI,r.fallOffExponent||0,e.scene);a.diffuse=U.FromArray(r.color||[1,1,1])}break}default:P.Warn('GLTF Material Common extension: light type "'+i.type+" not supported");break}}return!1}loadMaterialAsync(e,t,s,n){const i=e.materials[t];if(!i||!i.extensions)return!1;const r=i.extensions[this.name];if(!r)return!1;const a=new Mt(t,e.scene);return a.sideOrientation=se.CounterClockWiseSideOrientation,r.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=r.doubleSided===void 0?!1:!r.doubleSided,a.alpha=r.values.transparency===void 0?1:r.values.transparency,a.specularPower=r.values.shininess===void 0?0:r.values.shininess,typeof r.values.ambient=="string"?this._loadTexture(e,r.values.ambient,a,"ambientTexture",n):a.ambientColor=U.FromArray(r.values.ambient||[0,0,0]),typeof r.values.diffuse=="string"?this._loadTexture(e,r.values.diffuse,a,"diffuseTexture",n):a.diffuseColor=U.FromArray(r.values.diffuse||[0,0,0]),typeof r.values.emission=="string"?this._loadTexture(e,r.values.emission,a,"emissiveTexture",n):a.emissiveColor=U.FromArray(r.values.emission||[0,0,0]),typeof r.values.specular=="string"?this._loadTexture(e,r.values.specular,a,"specularTexture",n):a.specularColor=U.FromArray(r.values.specular||[0,0,0]),!0}_loadTexture(e,t,s,n,i){ae.LoadTextureBufferAsync(e,t,r=>{ae.CreateTextureAsync(e,t,r,a=>s[n]=a)},i)}}ve.RegisterExtension(new cn);function Kt(o,e,t,s){return E.FromArray(e,t).scaleInPlace(s)}function un(o,e,t,s){return J.FromArray(e,t).scaleInPlace(s)}function dn(o,e,t,s){const n=new Array(o._numMorphTargets);for(let i=0;i<n.length;i++)n[i]=e[t++]*s;return n}class Le{constructor(e,t,s,n){this.type=e,this.name=t,this.getValue=s,this.getStride=n}_buildAnimation(e,t,s){const n=new I(e,this.name,t,this.type);return n.setKeys(s),n}}class $e extends Le{buildAnimations(e,t,s,n,i){i(e._babylonTransformNode,this._buildAnimation(t,s,n))}}class fn extends Le{buildAnimations(e,t,s,n,i){if(e._numMorphTargets)for(let r=0;r<e._numMorphTargets;r++){const a=new I(`${t}_${r}`,this.name,s,this.type);if(a.setKeys(n.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[r]:void 0,value:l.value[r],outTangent:l.outTangent?l.outTangent[r]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const h=l.morphTargetManager.getTarget(r),c=a.clone();h.animations.push(c),i(h,c)}}}}}const Ce={translation:[new $e(I.ANIMATIONTYPE_VECTOR3,"position",Kt,()=>3)],rotation:[new $e(I.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",un,()=>4)],scale:[new $e(I.ANIMATIONTYPE_VECTOR3,"scaling",Kt,()=>3)],weights:[new fn(I.ANIMATIONTYPE_FLOAT,"influence",dn,o=>o._numMorphTargets)]};function hs(...o){const e=t=>t&&typeof t=="object";return o.reduce((t,s)=>(Object.keys(s).forEach(n=>{const i=t[n],r=s[n];Array.isArray(i)&&Array.isArray(r)?t[n]=i.concat(...r):e(i)&&e(r)?t[n]=hs(i,r):t[n]=r}),t),{})}class x{static Get(e,t,s){if(!t||s==null||!t[s])throw new Error(`${e}: Failed to find index (${s})`);return t[s]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class A{static RegisterExtension(e,t){A.UnregisterExtension(e)&&w.Warn(`Extension with the name '${e}' already exists`),A._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return A._RegisteredExtensions[e]?(delete A._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,s,n,i,r,a=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=s,this._loadData(n);let l=null;if(e){const h={};if(this._gltf.nodes)for(const u of this._gltf.nodes)u.name&&(h[u.name]=u.index);l=(e instanceof Array?e:[e]).map(u=>{const d=h[u];if(d===void 0)throw new Error(`Failed to find node '${u}'`);return d})}return this._loadAsync(i,a,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,t,s,n,i=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(s,i,null,()=>{})))}_loadAsync(e,t,s,n){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._loadExtensions(),this._checkExtensions();const i=`${ee[ee.LOADING]} => ${ee[ee.READY]}`,r=`${ee[ee.LOADING]} => ${ee[ee.COMPLETE]}`;this._parent._startPerformanceCounter(i),this._parent._startPerformanceCounter(r),this._parent._setState(ee.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(s)a.push(this.loadSceneAsync("/nodes",{nodes:s,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const c=x.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${c.index}`,c))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let c=0;c<this._gltf.materials.length;++c){const u=this._gltf.materials[c],d="/materials/"+c,f=se.TriangleFillMode;a.push(this._loadMaterialAsync(d,u,null,f,()=>{}))}return this._babylonScene.blockMaterialDirtyMechanism=l,this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),Promise.all(a).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(ee.READY),this._startAnimations(),n())).then(c=>(this._parent._endPerformanceCounter(i),P.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(r),this._parent._setState(ee.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},u=>{this._parent.onErrorObservable.notifyObservers(u),this._parent.onErrorObservable.clear(),this.dispose()})}),c))}).catch(i=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(i),this._parent.onErrorObservable.clear(),this.dispose()),i})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const s=t[0];(s.byteLength<e.bin.byteLength-3||s.byteLength>e.bin.byteLength)&&w.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else w.Warn("Unexpected BIN chunk")}}_setupData(){if(x.Assign(this._gltf.accessors),x.Assign(this._gltf.animations),x.Assign(this._gltf.buffers),x.Assign(this._gltf.bufferViews),x.Assign(this._gltf.cameras),x.Assign(this._gltf.images),x.Assign(this._gltf.materials),x.Assign(this._gltf.meshes),x.Assign(this._gltf.nodes),x.Assign(this._gltf.samplers),x.Assign(this._gltf.scenes),x.Assign(this._gltf.skins),x.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const s of this._gltf.nodes)if(s.children)for(const n of s.children)e[n]=s.index;const t=this._createRootNode();for(const s of this._gltf.nodes){const n=e[s.index];s.parent=n===void 0?t:this._gltf.nodes[n]}}}_loadExtensions(){for(const e in A._RegisteredExtensions){const t=A._RegisteredExtensions[e].factory(this);t.name!==e&&w.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(s=>s.name===e&&s.enabled))throw new Error(`Require extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new H("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case we.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],A._LoadTransform(e,this._rootBabylonMesh));break}case we.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const s=this._extensionsLoadSceneAsync(e,t);if(s)return s;const n=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const i of t.nodes){const r=x.Get(`${e}/nodes/${i}`,this._gltf.nodes,i);n.push(this.loadNodeAsync(`/nodes/${r.index}`,r,a=>{a.parent=this._rootBabylonMesh}))}for(const i of this._postSceneLoadActions)i();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const s of e._primitiveBabylonMeshes)t(s)}_getGeometries(){const e=new Array,t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,n=>{const i=n.geometry;i&&e.indexOf(i)===-1&&e.push(i)});return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,n=>{e.push(n)});return e}_getTransformNodes(){const e=new Array,t=this._gltf.nodes;if(t)for(const s of t)s._babylonTransformNode&&s._babylonTransformNode.getClassName()==="TransformNode"&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,t=this._gltf.skins;if(t)for(const s of t)s._data&&e.push(s._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,t=this._gltf.animations;if(t)for(const s of t)s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case xe.NONE:break;case xe.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case xe.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{w.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,s=()=>{}){const n=this._extensionsLoadNodeAsync(e,t,s);if(n)return n;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const i=new Array;this.logOpen(`${e} ${t.name||""}`);const r=a=>{if(A.AddPointerMetadata(a,e),A._LoadTransform(t,a),t.camera!=null){const l=x.Get(`${e}/camera`,this._gltf.cameras,t.camera);i.push(this.loadCameraAsync(`/cameras/${l.index}`,l,h=>{h.parent=a}))}if(t.children)for(const l of t.children){const h=x.Get(`${e}/children/${l}`,this._gltf.nodes,l);i.push(this.loadNodeAsync(`/nodes/${h.index}`,h,c=>{c.parent=a}))}s(a)};if(t.mesh==null||t.skin!=null){const a=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new ke(a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=l:t._babylonTransformNodeForSkin=l,r(l)}if(t.mesh!=null)if(t.skin==null){const a=x.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);i.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,r))}else{const a=x.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);i.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,l=>{const h=t._babylonTransformNodeForSkin;l.metadata=hs(h.metadata,l.metadata||{});const c=x.Get(`${e}/skin`,this._gltf.skins,t.skin);i.push(this._loadSkinAsync(`/skins/${c.index}`,t,c,u=>{this._forEachPrimitive(t,d=>{d.skeleton=u}),this._postSceneLoadActions.push(()=>{if(c.skeleton!=null){const d=x.Get(`/skins/${c.index}/skeleton`,this._gltf.nodes,c.skeleton).parent;t.index===d.index?l.parent=h.parent:l.parent=d._babylonTransformNode}else l.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:l})})}))}))}return this.logClose(),Promise.all(i).then(()=>(this._forEachPrimitive(t,a=>{a.geometry&&a.geometry.useBoundingInfoFromGeometry?a._updateBoundingInfo():a.refreshBoundingInfo(!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,s,n){const i=s.primitives;if(!i||!i.length)throw new Error(`${e}: Primitives are missing`);i[0].index==null&&x.Assign(i);const r=new Array;this.logOpen(`${e} ${s.name||""}`);const a=t.name||`node${t.index}`;if(i.length===1){const l=s.primitives[0];r.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,a,t,s,l,h=>{t._babylonTransformNode=h,t._primitiveBabylonMeshes=[h]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new ke(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of i)r.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${a}_primitive${l.index}`,t,s,l,h=>{h.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(h)}))}return n(t._babylonTransformNode),this.logClose(),Promise.all(r).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,s,n,i,r){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,s,n,i,r);if(a)return a;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&s.skin==null&&!n.primitives[0].targets;let h,c;if(l&&i._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,h=i._instanceData.babylonSourceMesh.createInstance(t),h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c=i._instanceData.promise;else{const u=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new H(t,this._babylonScene);d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?se.CounterClockWiseSideOrientation:se.ClockWiseSideOrientation,this._createMorphTargets(e,s,n,i,d),u.push(this._loadVertexDataAsync(e,i,d).then(m=>this._loadMorphTargetsAsync(e,i,d,m).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,m.applyToMesh(d),m._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=A._GetDrawMode(e,i.mode);if(i.material==null){let m=this._defaultBabylonMaterialData[f];m||(m=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(m),this._defaultBabylonMaterialData[f]=m),d.material=m}else if(!this.parent.skipMaterials){const m=x.Get(`${e}/material`,this._gltf.materials,i.material);u.push(this._loadMaterialAsync(`/materials/${m.index}`,m,d,f,_=>{d.material=_}))}c=Promise.all(u),l&&(i._instanceData={babylonSourceMesh:d,promise:c}),h=d}return A.AddPointerMetadata(h,e),this._parent.onMeshLoadedObservable.notifyObservers(h),r(h),this.logClose(),c.then(()=>h)}_loadVertexDataAsync(e,t,s){const n=this._extensionsLoadVertexDataAsync(e,t,s);if(n)return n;const i=t.attributes;if(!i)throw new Error(`${e}: Attributes are missing`);const r=new Array,a=new Ct(s.name,this._babylonScene);if(t.indices==null)s.isUnIndexed=!0;else{const h=x.Get(`${e}/indices`,this._gltf.accessors,t.indices);r.push(this._loadIndicesAccessorAsync(`/accessors/${h.index}`,h).then(c=>{a.setIndices(c)}))}const l=(h,c,u)=>{if(i[h]==null)return;s._delayInfo=s._delayInfo||[],s._delayInfo.indexOf(c)===-1&&s._delayInfo.push(c);const d=x.Get(`${e}/attributes/${h}`,this._gltf.accessors,i[h]);r.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,c).then(f=>{if(f.getKind()===b.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton&&d.min&&d.max){const m=j.Vector3[0].copyFromFloats(...d.min),_=j.Vector3[1].copyFromFloats(...d.max);if(d.normalized&&d.componentType!==5126){let p=1;switch(d.componentType){case 5120:p=127;break;case 5121:p=255;break;case 5122:p=32767;break;case 5123:p=65535;break}const g=1/p;m.scaleInPlace(g),_.scaleInPlace(g)}a._boundingInfo=new Zt(m,_),a.useBoundingInfoFromGeometry=!0}a.setVerticesBuffer(f,d.count)})),c==b.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),u&&u(d)};return l("POSITION",b.PositionKind),l("NORMAL",b.NormalKind),l("TANGENT",b.TangentKind),l("TEXCOORD_0",b.UVKind),l("TEXCOORD_1",b.UV2Kind),l("TEXCOORD_2",b.UV3Kind),l("TEXCOORD_3",b.UV4Kind),l("TEXCOORD_4",b.UV5Kind),l("TEXCOORD_5",b.UV6Kind),l("JOINTS_0",b.MatricesIndicesKind),l("WEIGHTS_0",b.MatricesWeightsKind),l("JOINTS_1",b.MatricesIndicesExtraKind),l("WEIGHTS_1",b.MatricesWeightsExtraKind),l("COLOR_0",b.ColorKind,h=>{h.type==="VEC4"&&(s.hasVertexAlpha=!0)}),Promise.all(r).then(()=>a)}_createMorphTargets(e,t,s,n,i){if(!n.targets)return;if(t._numMorphTargets==null)t._numMorphTargets=n.targets.length;else if(n.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const r=s.extras?s.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,i.morphTargetManager=new de(this._babylonScene),i.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.morphTargetManager.areUpdatesFrozen=!0;for(let a=0;a<n.targets.length;a++){const l=t.weights?t.weights[a]:s.weights?s.weights[a]:0,h=r?r[a]:`morphTarget${a}`;i.morphTargetManager.addTarget(new Ae(h,l,i.getScene()))}}_loadMorphTargetsAsync(e,t,s,n){if(!t.targets)return Promise.resolve();const i=new Array,r=s.morphTargetManager;for(let a=0;a<r.numTargets;a++){const l=r.getTarget(a);i.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${a}`,n,t.targets[a],l))}return Promise.all(i).then(()=>{r.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,s,n){const i=new Array,r=(a,l,h)=>{if(s[a]==null)return;const c=t.getVertexBuffer(l);if(!c)return;const u=x.Get(`${e}/${a}`,this._gltf.accessors,s[a]);i.push(this._loadFloatAccessorAsync(`/accessors/${u.index}`,u).then(d=>{h(c,d)}))};return r("POSITION",b.PositionKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(l.length,(c,u)=>{h[u]=l[u]+c}),n.setPositions(h)}),r("NORMAL",b.NormalKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(h.length,(c,u)=>{h[u]=l[u]+c}),n.setNormals(h)}),r("TANGENT",b.TangentKind,(a,l)=>{const h=new Float32Array(l.length/3*4);let c=0;a.forEach(l.length/3*4,(u,d)=>{(d+1)%4!==0&&(h[c]=l[c]+u,c++)}),n.setTangents(h)}),Promise.all(i).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let s=E.Zero(),n=J.Identity(),i=E.One();e.matrix?R.FromArray(e.matrix).decompose(i,n,s):(e.translation&&(s=E.FromArray(e.translation)),e.rotation&&(n=J.FromArray(e.rotation)),e.scale&&(i=E.FromArray(e.scale))),t.position=s,t.rotationQuaternion=n,t.scaling=i}_loadSkinAsync(e,t,s,n){const i=this._extensionsLoadSkinAsync(e,t,s);if(i)return i;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const r=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Ee(s.name||r,r,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,s,a);const l=this._loadSkinInverseBindMatricesDataAsync(e,s).then(h=>{this._updateBoneMatrices(a,h)});return s._data={babylonSkeleton:a,promise:l},n(a),l}_loadBones(e,t,s){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const i=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(i)if(t.skeleton===void 0)t.skeleton=i.index;else{const r=(l,h)=>{for(;h.parent;h=h.parent)if(h.parent===l)return!0;return!1},a=x.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);a!==i&&!r(a,i)&&(w.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=i.index)}else w.Warn(`${e}: Failed to find common root`)}const n={};for(const i of t.joints){const r=x.Get(`${e}/joints/${i}`,this._gltf.nodes,i);this._loadBone(r,t,s,n)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const s={};for(const i of t){const r=new Array;let a=x.Get(`${e}/${i}`,this._gltf.nodes,i);for(;a.index!==-1;)r.unshift(a),a=a.parent;s[i]=r}let n=null;for(let i=0;;++i){let r=s[t[0]];if(i>=r.length)return n;const a=r[i];for(let l=1;l<t.length;++l)if(r=s[t[l]],i>=r.length||a!==r[i])return n;n=a}}_loadBone(e,t,s,n){let i=n[e.index];if(i)return i;let r=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?r=this._loadBone(e.parent,t,s,n):t.skeleton!==void 0&&w.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return i=new ye(e.name||`joint${e.index}`,s,r,this._getNodeMatrix(e),null,null,a),n[e.index]=i,this._postSceneLoadActions.push(()=>{i.linkTransformNode(e._babylonTransformNode)}),i}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const s=x.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(e,t){for(const s of e.bones){const n=R.Identity(),i=s._index;t&&i!==-1&&(R.FromArrayToRef(t,i*16,n),n.invertToRef(n));const r=s.getParent();r&&n.multiplyToRef(r.getAbsoluteInverseBindMatrix(),n),s.updateMatrix(n,!1,!1),s._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?R.FromArray(e.matrix):R.Compose(e.scale?E.FromArray(e.scale):E.One(),e.rotation?J.FromArray(e.rotation):J.Identity(),e.translation?E.FromArray(e.translation):E.Zero())}loadCameraAsync(e,t,s=()=>{}){const n=this._extensionsLoadCameraAsync(e,t,s);if(n)return n;const i=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const r=new We(t.name||`camera${t.index}`,E.Zero(),this._babylonScene,!1);switch(r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.ignoreParentScaling=!0,t._babylonCamera=r,r.rotation=new E(0,Math.PI,0),t.type){case"perspective":{const a=t.perspective;if(!a)throw new Error(`${e}: Camera perspective properties are missing`);r.fov=a.yfov,r.minZ=a.znear,r.maxZ=a.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);r.mode=It.ORTHOGRAPHIC_CAMERA,r.orthoLeft=-t.orthographic.xmag,r.orthoRight=t.orthographic.xmag,r.orthoBottom=-t.orthographic.ymag,r.orthoTop=t.orthographic.ymag,r.minZ=t.orthographic.znear,r.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return A.AddPointerMetadata(r,e),this._parent.onCameraLoadedObservable.notifyObservers(r),s(r),this.logClose(),Promise.all(i).then(()=>r)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let s=0;s<e.length;s++){const n=e[s];t.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(i=>{i.targetedAnimations.length===0&&i.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const s=this._extensionsLoadAnimationAsync(e,t);if(s)return s;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new Bs(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=n;const i=new Array;x.Assign(t.channels),x.Assign(t.samplers);for(const r of t.channels)i.push(this._loadAnimationChannelAsync(`${e}/channels/${r.index}`,e,t,r,(a,l)=>{a.animations=a.animations||[],a.animations.push(l),n.addTargetedAnimation(l,a)}));return Promise.all(i).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(e,t,s,n,i){const r=this._extensionsLoadAnimationChannelAsync(e,t,s,n,i);if(r)return r;if(n.target.node==null)return Promise.resolve();const a=x.Get(`${e}/target/node`,this._gltf.nodes,n.target.node);if(n.target.path==="weights"&&!a._numMorphTargets||n.target.path!=="weights"&&!a._babylonTransformNode)return Promise.resolve();let l;switch(n.target.path){case"translation":{l=Ce.translation;break}case"rotation":{l=Ce.rotation;break}case"scale":{l=Ce.scale;break}case"weights":{l=Ce.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}const h={target:a,properties:l};return this._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,h,i)}_loadAnimationChannelFromTargetInfoAsync(e,t,s,n,i,r){const a=this.parent.targetFps,l=1/a,h=x.Get(`${e}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${n.sampler}`,h).then(c=>{let u=0;for(const d of i.properties){const f=d.getStride(i.target),m=c.input,_=c.output,p=new Array(m.length);let g=0;switch(c.interpolation){case"STEP":{for(let y=0;y<m.length;y++){const v=d.getValue(i.target,_,g,1);g+=f,p[y]={frame:m[y]*a,value:v,interpolation:Is.STEP}}break}case"CUBICSPLINE":{for(let y=0;y<m.length;y++){const v=d.getValue(i.target,_,g,l);g+=f;const O=d.getValue(i.target,_,g,1);g+=f;const T=d.getValue(i.target,_,g,l);g+=f,p[y]={frame:m[y]*a,inTangent:v,value:O,outTangent:T}}break}case"LINEAR":{for(let y=0;y<m.length;y++){const v=d.getValue(i.target,_,g,1);g+=f,p[y]={frame:m[y]*a,value:v}}break}}if(g>0){const y=`${s.name||`animation${s.index}`}_channel${n.index}_${u}`;d.buildAnimations(i.target,y,a,p,(v,O)=>{++u,r(v,O)})}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const s=t.interpolation||"LINEAR";switch(s){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const n=x.Get(`${e}/input`,this._gltf.accessors,t.input),i=x.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)]).then(([r,a])=>({input:r,interpolation:s,output:a})),t._data}loadBufferAsync(e,t,s,n){const i=this._extensionsLoadBufferAsync(e,t,s,n);if(i)return i;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(r=>{try{return new Uint8Array(r.buffer,r.byteOffset+s,n)}catch(a){throw new Error(`${e}: ${a.message}`)}})}loadBufferViewAsync(e,t){const s=this._extensionsLoadBufferViewAsync(e,t);if(s)return s;if(t._data)return t._data;const n=x.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${n.index}`,n,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,s){if(t._data)return t._data;const n=A._GetNumComponents(e,t.type),i=n*b.GetTypeByteLength(t.componentType),r=n*t.count;if(t.bufferView==null)t._data=Promise.resolve(new s(r));else{const a=x.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then(l=>{if(t.componentType===5126&&!t.normalized&&(!a.byteStride||a.byteStride===i))return A._GetTypedArray(e,t.componentType,l,t.byteOffset,r);{const h=new s(r);return b.ForEach(l,t.byteOffset||0,a.byteStride||i,n,t.componentType,h.length,t.normalized||!1,(c,u)=>{h[u]=c}),h}})}if(t.sparse){const a=t.sparse;t._data=t._data.then(l=>{const h=l,c=x.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),u=x.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${c.index}`,c),this.loadBufferViewAsync(`/bufferViews/${u.index}`,u)]).then(([d,f])=>{const m=A._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,d,a.indices.byteOffset,a.count),_=n*a.count;let p;if(t.componentType===5126&&!t.normalized)p=A._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,_);else{const y=A._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,_);p=new s(_),b.ForEach(y,0,i,n,t.componentType,p.length,t.normalized||!1,(v,O)=>{p[O]=v})}let g=0;for(let y=0;y<m.length;y++){let v=m[y]*n;for(let O=0;O<n;O++)h[v++]=p[g++]}return h})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const s=A._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,s)}else{const s=x.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then(n=>A._GetTypedArray(e,t.componentType,n,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(s=>new Yt(t,s,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,s){var n;if(!((n=t._babylonVertexBuffer)===null||n===void 0)&&n[s])return t._babylonVertexBuffer[s];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const i=this._babylonScene.getEngine();if(t.sparse)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then(r=>new b(i,r,s,!1));else if(s===b.MatricesIndicesKind||s===b.MatricesIndicesExtraKind)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then(r=>new b(i,r,s,!1));else{const r=x.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(r).then(a=>{const l=A._GetNumComponents(e,t.type);return new b(i,a,s,!1,!1,r.byteStride,!1,t.byteOffset,l,t.componentType,t.normalized,!0,1,!0)})}return t._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const n=new Array;return t&&(t.baseColorFactor?(s.albedoColor=U.FromArray(t.baseColorFactor),s.alpha=t.baseColorFactor[3]):s.albedoColor=U.White(),s.metallic=t.metallicFactor==null?1:t.metallicFactor,s.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,i=>{i.name=`${s.name} (Base Color)`,s.albedoTexture=i})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,i=>{i.name=`${s.name} (Metallic Roughness)`,s.metallicTexture=i})),s.useMetallnessFromMetallicTextureBlue=!0,s.useRoughnessFromMetallicTextureGreen=!0,s.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(e,t,s,n,i=()=>{}){const r=this._extensionsLoadMaterialAsync(e,t,s,n,i);if(r)return r;t._data=t._data||{};let a=t._data[n];if(!a){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,n);a={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[n]=a,A.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return s&&(a.babylonMeshes.push(s),s.onDisposeObservable.addOnce(()=>{const l=a.babylonMeshes.indexOf(s);l!==-1&&a.babylonMeshes.splice(l,1)})),i(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new W(e,this._babylonScene);return s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.fillMode=t,s.enableSpecularAntiAliasing=!0,s.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,s.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,s.transparencyMode=W.PBRMATERIAL_OPAQUE,s.metallic=1,s.roughness=1,s}createMaterial(e,t,s){const n=this._extensionsCreateMaterial(e,t,s);if(n)return n;const i=t.name||`material${t.index}`;return this._createDefaultMaterial(i,s)}loadMaterialPropertiesAsync(e,t,s){const n=this._extensionsLoadMaterialPropertiesAsync(e,t,s);if(n)return n;const i=new Array;return i.push(this.loadMaterialBasePropertiesAsync(e,t,s)),t.pbrMetallicRoughness&&i.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(e,t,s),Promise.all(i).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.emissiveColor=t.emissiveFactor?U.FromArray(t.emissiveFactor):new U(0,0,0),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,i=>{i.name=`${s.name} (Normal)`,s.bumpTexture=i})),s.invertNormalMapX=!this._babylonScene.useRightHandedSystem,s.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&s.bumpTexture&&(s.bumpTexture.level=t.normalTexture.scale),s.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,i=>{i.name=`${s.name} (Occlusion)`,s.ambientTexture=i})),s.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(s.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,i=>{i.name=`${s.name} (Emissive)`,s.emissiveTexture=i})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{s.transparencyMode=W.PBRMATERIAL_OPAQUE;break}case"MASK":{s.transparencyMode=W.PBRMATERIAL_ALPHATEST,s.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0);break}case"BLEND":{s.transparencyMode=W.PBRMATERIAL_ALPHABLEND,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0,s.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,t,s);if(n)return n;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const i=x.Get(`${e}/index`,this._gltf.textures,t.index);i._textureInfo=t;const r=this._loadTextureAsync(`/textures/${t.index}`,i,a=>{a.coordinatesIndex=t.texCoord||0,A.AddPointerMetadata(a,e),this._parent.onTextureLoadedObservable.notifyObservers(a),s(a)});return this.logClose(),r}_loadTextureAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureAsync(e,t,s);if(n)return n;this.logOpen(`${e} ${t.name||""}`);const i=t.sampler==null?A.DefaultSampler:x.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),r=x.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,i,r,s,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,s,n=()=>{},i,r){const a=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,h=new Se;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(d,f)=>{this._disposed||h.reject(new Error(`${e}: ${f&&f.message?f.message:d||"Failed to load texture"}`))},mimeType:s.mimeType,loaderOptions:i,useSRGBBuffer:!!r&&this._parent.useSRGBBuffers},u=new L(null,this._babylonScene,c);return u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(h.promise),l.push(this.loadImageAsync(`/images/${s.index}`,s).then(d=>{const f=s.uri||`${this._fileName}#image${s.index}`,m=`data:${this._uniqueRootUrl}${f}`;u.updateURL(m,d)})),u.wrapU=a.wrapU,u.wrapV=a.wrapV,n(u),Promise.all(l).then(()=>u)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:A._GetTextureSamplingMode(e,t),wrapU:A._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:A._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const s=x.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}this.logClose()}return t._data}loadUriAsync(e,t,s){const n=this._extensionsLoadUriAsync(e,t,s);if(n)return n;if(!A._ValidateUri(s))throw new Error(`${e}: '${s}' is invalid`);if(Ss(s)){const i=new Uint8Array(Jt(s));return this.log(`${e}: Decoded ${s.substr(0,64)}... (${i.length} bytes)`),Promise.resolve(i)}return this.log(`${e}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then(i=>new Promise((r,a)=>{this._parent._loadFile(this._babylonScene,i,l=>{this._disposed||(this.log(`${e}: Loaded ${s} (${l.byteLength} bytes)`),r(new Uint8Array(l)))},!0,l=>{a(new Cs(`${e}: Failed to load '${s}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const s=e._internalMetadata=e._internalMetadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return L.CLAMP_ADDRESSMODE;case 33648:return L.MIRROR_ADDRESSMODE;case 10497:return L.WRAP_ADDRESSMODE;default:return w.Warn(`${e}: Invalid value (${t})`),L.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const s=t.magFilter==null?9729:t.magFilter,n=t.minFilter==null?9987:t.minFilter;if(s===9729)switch(n){case 9728:return L.LINEAR_NEAREST;case 9729:return L.LINEAR_LINEAR;case 9984:return L.LINEAR_NEAREST_MIPNEAREST;case 9985:return L.LINEAR_LINEAR_MIPNEAREST;case 9986:return L.LINEAR_NEAREST_MIPLINEAR;case 9987:return L.LINEAR_LINEAR_MIPLINEAR;default:return w.Warn(`${e}/minFilter: Invalid value (${n})`),L.LINEAR_LINEAR_MIPLINEAR}else switch(s!==9728&&w.Warn(`${e}/magFilter: Invalid value (${s})`),n){case 9728:return L.NEAREST_NEAREST;case 9729:return L.NEAREST_LINEAR;case 9984:return L.NEAREST_NEAREST_MIPNEAREST;case 9985:return L.NEAREST_LINEAR_MIPNEAREST;case 9986:return L.NEAREST_NEAREST_MIPLINEAR;case 9987:return L.NEAREST_LINEAR_MIPLINEAR;default:return w.Warn(`${e}/minFilter: Invalid value (${n})`),L.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,s,n,i){const r=s.buffer;n=s.byteOffset+(n||0);const a=A._GetTypedArrayConstructor(`${e}/componentType`,t),l=b.GetTypeByteLength(t);return n%l!==0?(w.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${l})`),new a(r.slice(n,n+i*l),0)):new a(r,n,i)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return P.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return se.PointListDrawMode;case 1:return se.LineListDrawMode;case 2:return se.LineLoopDrawMode;case 3:return se.LineStripDrawMode;case 4:return se.TriangleFillMode;case 5:return se.TriangleStripDrawMode;case 6:return se.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const s in t._data){const n=t._data[s];for(const i of n.babylonMeshes){i.computeWorldMatrix(!0);const r=n.babylonMaterial;e.push(r.forceCompilationAsync(i)),e.push(r.forceCompilationAsync(i,{useInstances:!0})),this._parent.useClipPlane&&(e.push(r.forceCompilationAsync(i,{clipPlane:!0})),e.push(r.forceCompilationAsync(i,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const s of t){const n=s.getShadowGenerator();n&&e.push(n.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,s){for(const n of this._extensions)if(n.enabled){const i=`${n.name}.${t}`,r=e;r._activeLoaderExtensionFunctions=r._activeLoaderExtensionFunctions||{};const a=r._activeLoaderExtensionFunctions;if(!a[i]){a[i]=!0;try{const l=s(n);if(l)return l}finally{delete a[i]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",s=>s.loadSceneAsync&&s.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,s){return this._applyExtensions(t,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(e,t,s))}_extensionsLoadCameraAsync(e,t,s){return this._applyExtensions(t,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(e,t,s))}_extensionsLoadVertexDataAsync(e,t,s){return this._applyExtensions(t,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,t,s))}_extensionsLoadMeshPrimitiveAsync(e,t,s,n,i,r){return this._applyExtensions(i,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,s,n,i,r))}_extensionsLoadMaterialAsync(e,t,s,n,i){return this._applyExtensions(t,"loadMaterial",r=>r._loadMaterialAsync&&r._loadMaterialAsync(e,t,s,n,i))}_extensionsCreateMaterial(e,t,s){return this._applyExtensions(t,"createMaterial",n=>n.createMaterial&&n.createMaterial(e,t,s))}_extensionsLoadMaterialPropertiesAsync(e,t,s){return this._applyExtensions(t,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,t,s))}_extensionsLoadTextureInfoAsync(e,t,s){return this._applyExtensions(t,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,t,s))}_extensionsLoadTextureAsync(e,t,s){return this._applyExtensions(t,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(e,t,s))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",s=>s.loadAnimationAsync&&s.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,s,n,i){return this._applyExtensions(s,"loadAnimationChannel",r=>r._loadAnimationChannelAsync&&r._loadAnimationChannelAsync(e,t,s,n,i))}_extensionsLoadSkinAsync(e,t,s){return this._applyExtensions(s,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(e,t,s))}_extensionsLoadUriAsync(e,t,s){return this._applyExtensions(t,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(e,t,s))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,s,n){return this._applyExtensions(t,"loadBuffer",i=>i.loadBufferAsync&&i.loadBufferAsync(e,t,s,n))}static LoadExtensionAsync(e,t,s,n){if(!t.extensions)return null;const r=t.extensions[s];return r?n(`${e}/extensions/${s}`,r):null}static LoadExtraAsync(e,t,s,n){if(!t.extras)return null;const r=t.extras[s];return r?n(`${e}/extras/${s}`,r):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}A._RegisteredExtensions={};A.DefaultSampler={index:-1};V._CreateGLTF2Loader=o=>new A(o);const Ze="EXT_lights_image_based";class _n{constructor(e){this.name=Ze,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ze)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(s,n)=>{const i=new Array;i.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${s}`);const r=x.Get(`${s}/light`,this._lights,n.light);return i.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,r).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(i).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const s=new Array;this._loader.logOpen(`${e}`);const n=new Array(t.specularImages.length);for(let i=0;i<t.specularImages.length;i++){const r=t.specularImages[i];n[i]=new Array(r.length);for(let a=0;a<r.length;a++){const l=`${e}/specularImages/${i}/${a}`;this._loader.logOpen(`${l}`);const h=r[a],c=x.Get(l,this._loader.gltf.images,h);s.push(this._loader.loadImageAsync(`/images/${h}`,c).then(u=>{n[i][a]=u})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(s).then(()=>{const i=new Nt(this._loader.babylonScene,null,t.specularImageSize);if(i.name=t.name||"environment",t._babylonTexture=i,t.intensity!=null&&(i.level=t.intensity),t.rotation){let h=J.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(h=J.Inverse(h)),R.FromQuaternionToRef(h,i.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const r=Ls.FromArray(t.irradianceCoefficients);r.scaleInPlace(t.intensity),r.convertIrradianceToLambertianRadiance();const a=Ds.FromHarmonics(r),l=(n.length-1)/Ms.Log2(t.specularImageSize);return i.updateRGBDAsync(n,a,l)})}return t._loaded.then(()=>t._babylonTexture)}}A.RegisterExtension(Ze,o=>new _n(o));const Je="EXT_mesh_gpu_instancing";class mn{constructor(e){this.name=Je,this._loader=e,this.enabled=this._loader.isExtensionUsed(Je)}dispose(){this._loader=null}loadNodeAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{this._loader._disableInstancedMesh++;const r=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,s);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return r;const a=new Array;let l=0;const h=c=>{if(i.attributes[c]==null){a.push(Promise.resolve(null));return}const u=x.Get(`${n}/attributes/${c}`,this._loader.gltf.accessors,i.attributes[c]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${u.bufferView}`,u)),l===0)l=u.count;else if(l!==u.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return h("TRANSLATION"),h("ROTATION"),h("SCALE"),r.then(c=>Promise.all(a).then(([u,d,f])=>{const m=new Float32Array(l*16);j.Vector3[0].copyFromFloats(0,0,0),j.Quaternion[0].copyFromFloats(0,0,0,1),j.Vector3[1].copyFromFloats(1,1,1);for(let _=0;_<l;++_)u&&E.FromArrayToRef(u,_*3,j.Vector3[0]),d&&J.FromArrayToRef(d,_*4,j.Quaternion[0]),f&&E.FromArrayToRef(f,_*3,j.Vector3[1]),R.ComposeToRef(j.Vector3[1],j.Quaternion[0],j.Vector3[0],j.Matrix[0]),j.Matrix[0].copyToArray(m,_*16);for(const _ of t._primitiveBabylonMeshes)_.thinInstanceSetBuffer("matrix",m,16,!0);return c}))})}}A.RegisterExtension(Je,o=>new mn(o));const Qe="EXT_meshopt_compression";class pn{constructor(e){this.name=Qe,this.enabled=e.isExtensionUsed(Qe),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(s,n)=>{const i=t;if(i._meshOptData)return i._meshOptData;const r=x.Get(`${e}/buffer`,this._loader.gltf.buffers,n.buffer);return i._meshOptData=this._loader.loadBufferAsync(`/buffers/${r.index}`,r,n.byteOffset||0,n.byteLength).then(a=>le.Default.decodeGltfBufferAsync(a,n.count,n.byteStride,n.mode,n.filter)),i._meshOptData})}}A.RegisterExtension(Qe,o=>new pn(o));const et="EXT_texture_webp";class gn{constructor(e){this.name=et,this._loader=e,this.enabled=e.isExtensionUsed(et)}dispose(){this._loader=null}_loadTextureAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=t.sampler==null?A.DefaultSampler:x.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=x.Get(`${n}/source`,this._loader.gltf.images,i.source);return this._loader._createTextureAsync(e,r,a,l=>{s(l)},void 0,!t._textureInfo.nonColorData)})}}A.RegisterExtension(et,o=>new gn(o));const tt="KHR_draco_mesh_compression";class An{constructor(e){this.name=tt,this._loader=e,this.enabled=te.DecoderAvailable&&this._loader.isExtensionUsed(tt)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{if(t.mode!=null){if(t.mode!==5&&t.mode!==4)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(t.mode===5)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const r={},a={},l=(c,u)=>{const d=i.attributes[c];if(d===void 0||t.attributes[c]===void 0)return;r[u]=d;const f=x.Get(`${e}/attributes/${c}`,this._loader.gltf.accessors,t.attributes[c]);if(f.normalized&&f.componentType!==5126){let m=1;switch(f.componentType){case 5120:m=127;break;case 5121:m=255;break;case 5122:m=32767;break;case 5123:m=65535;break}a[u]=m}s._delayInfo=s._delayInfo||[],s._delayInfo.indexOf(u)===-1&&s._delayInfo.push(u)};l("POSITION",b.PositionKind),l("NORMAL",b.NormalKind),l("TANGENT",b.TangentKind),l("TEXCOORD_0",b.UVKind),l("TEXCOORD_1",b.UV2Kind),l("TEXCOORD_2",b.UV3Kind),l("TEXCOORD_3",b.UV4Kind),l("TEXCOORD_4",b.UV5Kind),l("TEXCOORD_5",b.UV6Kind),l("JOINTS_0",b.MatricesIndicesKind),l("WEIGHTS_0",b.MatricesWeightsKind),l("COLOR_0",b.ColorKind);const h=x.Get(n,this._loader.gltf.bufferViews,i.bufferView);return h._dracoBabylonGeometry||(h._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${h.index}`,h).then(c=>(this.dracoCompression||te.Default).decodeMeshAsync(c,r,a).then(d=>{const f=new Ct(s.name,this._loader.babylonScene);return d.applyToGeometry(f),f}).catch(d=>{throw new Error(`${e}: ${d.message}`)}))),h._dracoBabylonGeometry})}}A.RegisterExtension(tt,o=>new An(o));const st="KHR_lights_punctual";class yn{constructor(e){this.name=st,this._loader=e,this.enabled=this._loader.isExtensionUsed(st)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,x.Assign(this._lights)}}loadNodeAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>this._loader.loadNodeAsync(e,t,r=>{let a;const l=x.Get(n,this._lights,i.light),h=l.name||r.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const c=new Ot(h,E.Backward(),this._loader.babylonScene);c.position.setAll(0),a=c;break}case"point":{a=new Ne(h,E.Zero(),this._loader.babylonScene);break}case"spot":{const c=new Q(h,E.Zero(),E.Backward(),0,1,this._loader.babylonScene);c.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,c.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=c;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${n}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=Be.FALLOFF_GLTF,a.diffuse=l.color?U.FromArray(l.color):U.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=r,this._loader._babylonLights.push(a),A.AddPointerMetadata(a,n),s(r)}))}}A.RegisterExtension(st,o=>new yn(o));const nt="KHR_materials_pbrSpecularGlossiness";class Tn{constructor(e){this.name=nt,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(nt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),r.push(this._loadSpecularGlossinessPropertiesAsync(n,t,i,s)),this._loader.loadMaterialAlphaProperties(e,t,s),Promise.all(r).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,s,n){if(!(n instanceof W))throw new Error(`${e}: Material type not supported`);const i=new Array;return n.metallic=null,n.roughness=null,s.diffuseFactor?(n.albedoColor=U.FromArray(s.diffuseFactor),n.alpha=s.diffuseFactor[3]):n.albedoColor=U.White(),n.reflectivityColor=s.specularFactor?U.FromArray(s.specularFactor):U.White(),n.microSurface=s.glossinessFactor==null?1:s.glossinessFactor,s.diffuseTexture&&i.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,s.diffuseTexture,r=>{r.name=`${n.name} (Diffuse)`,n.albedoTexture=r})),s.specularGlossinessTexture&&(i.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,s.specularGlossinessTexture,r=>{r.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=r,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(i).then(()=>{})}}A.RegisterExtension(nt,o=>new Tn(o));const it="KHR_materials_unlit";class xn{constructor(e){this.name=it,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(it)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,s))}_loadUnlitPropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const n=new Array;s.unlit=!0;const i=t.pbrMetallicRoughness;return i&&(i.baseColorFactor?(s.albedoColor=U.FromArray(i.baseColorFactor),s.alpha=i.baseColorFactor[3]):s.albedoColor=U.White(),i.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,i.baseColorTexture,r=>{r.name=`${s.name} (Base Color)`,s.albedoTexture=r}))),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,s),Promise.all(n).then(()=>{})}}A.RegisterExtension(it,o=>new xn(o));const rt="KHR_materials_clearcoat";class bn{constructor(e){this.name=rt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(rt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadClearCoatPropertiesAsync(n,i,s)),Promise.all(r).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.clearCoat.isEnabled=!0,s.clearCoat.useRoughnessFromMainTexture=!1,s.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?s.clearCoat.intensity=t.clearcoatFactor:s.clearCoat.intensity=0,t.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,i=>{i.name=`${s.name} (ClearCoat Intensity)`,s.clearCoat.texture=i})),t.clearcoatRoughnessFactor!=null?s.clearCoat.roughness=t.clearcoatRoughnessFactor:s.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,i=>{i.name=`${s.name} (ClearCoat Roughness)`,s.clearCoat.textureRoughness=i}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,i=>{i.name=`${s.name} (ClearCoat Normal)`,s.clearCoat.bumpTexture=i})),s.invertNormalMapX=!s.getScene().useRightHandedSystem,s.invertNormalMapY=s.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(s.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(n).then(()=>{})}}A.RegisterExtension(rt,o=>new bn(o));const ot="KHR_materials_iridescence";class En{constructor(e){this.name=ot,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(ot)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadIridescencePropertiesAsync(n,i,s)),Promise.all(r).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,s){var n,i,r,a,l;if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const h=new Array;return s.iridescence.isEnabled=!0,s.iridescence.intensity=(n=t.iridescenceFactor)!==null&&n!==void 0?n:0,s.iridescence.indexOfRefraction=(r=(i=t.iridescenceIor)!==null&&i!==void 0?i:t.iridescenceIOR)!==null&&r!==void 0?r:1.3,s.iridescence.minimumThickness=(a=t.iridescenceThicknessMinimum)!==null&&a!==void 0?a:100,s.iridescence.maximumThickness=(l=t.iridescenceThicknessMaximum)!==null&&l!==void 0?l:400,t.iridescenceTexture&&h.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,c=>{c.name=`${s.name} (Iridescence Intensity)`,s.iridescence.texture=c})),t.iridescenceThicknessTexture&&h.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,c=>{c.name=`${s.name} (Iridescence Thickness)`,s.iridescence.thicknessTexture=c})),Promise.all(h).then(()=>{})}}A.RegisterExtension(ot,o=>new En(o));const at="KHR_materials_anisotropy";class vn{constructor(e){this.name=at,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(at)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadIridescencePropertiesAsync(n,i,s)),Promise.all(r).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,s){var n,i;if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const r=new Array;return s.anisotropy.isEnabled=!0,s.anisotropy.intensity=(n=t.anisotropyStrength)!==null&&n!==void 0?n:0,s.anisotropy.angle=(i=t.anisotropyRotation)!==null&&i!==void 0?i:0,t.anisotropyTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,a=>{a.name=`${s.name} (Anisotropy Intensity)`,s.anisotropy.texture=a})),Promise.all(r).then(()=>{})}}A.RegisterExtension(at,o=>new vn(o));const lt="KHR_materials_emissive_strength";class In{constructor(e){this.name=lt,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(lt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>this._loader.loadMaterialPropertiesAsync(e,t,s).then(()=>{this._loadEmissiveProperties(n,i,s)}))}_loadEmissiveProperties(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&s.emissiveColor.scaleToRef(t.emissiveStrength,s.emissiveColor)}}A.RegisterExtension(lt,o=>new In(o));const ht="KHR_materials_sheen";class Sn{constructor(e){this.name=ht,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ht)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadSheenPropertiesAsync(n,i,s)),Promise.all(r).then(()=>{})})}_loadSheenPropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.sheen.isEnabled=!0,s.sheen.intensity=1,t.sheenColorFactor!=null?s.sheen.color=U.FromArray(t.sheenColorFactor):s.sheen.color=U.Black(),t.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,i=>{i.name=`${s.name} (Sheen Color)`,s.sheen.texture=i})),t.sheenRoughnessFactor!==void 0?s.sheen.roughness=t.sheenRoughnessFactor:s.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,i=>{i.name=`${s.name} (Sheen Roughness)`,s.sheen.textureRoughness=i}))),s.sheen.albedoScaling=!0,s.sheen.useRoughnessFromMainTexture=!1,Promise.all(n).then(()=>{})}}A.RegisterExtension(ht,o=>new Sn(o));const ct="KHR_materials_specular";class Cn{constructor(e){this.name=ct,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ct)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadSpecularPropertiesAsync(n,i,s)),Promise.all(r).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const n=new Array;return t.specularFactor!==void 0&&(s.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(s.metallicReflectanceColor=U.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,i=>{i.name=`${s.name} (Specular F0 Strength)`,s.metallicReflectanceTexture=i,s.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,i=>{i.name=`${s.name} (Specular F0 Color)`,s.reflectanceTexture=i})),Promise.all(n).then(()=>{})}}A.RegisterExtension(ct,o=>new Cn(o));const ut="KHR_materials_ior";class Fe{constructor(e){this.name=ut,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(ut)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadIorPropertiesAsync(n,i,s)),Promise.all(r).then(()=>{})})}_loadIorPropertiesAsync(e,t,s){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?s.indexOfRefraction=t.ior:s.indexOfRefraction=Fe._DEFAULT_IOR,Promise.resolve()}}Fe._DEFAULT_IOR=1.5;A.RegisterExtension(ut,o=>new Fe(o));const Y="KHR_materials_variants";class ue{constructor(e){this.name=Y,this._loader=e,this.enabled=this._loader.isExtensionUsed(Y)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return ue.GetAvailableVariants(e)}static SelectVariant(e,t){const s=this._GetExtensionMetadata(e);if(!s)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${Y} extension`);const n=i=>{const r=s.variants[i];if(r)for(const a of r)a.mesh.material=a.material};if(t instanceof Array)for(const i of t)n(i);else n(t);s.lastSelected=t}selectVariant(e,t){return ue.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${Y} extension`);for(const s of t.original)s.mesh.material=s.material;t.lastSelected=null}reset(e){return ue.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${Y} extension`);return t.lastSelected}getLastSelectedVariant(e){return ue.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,s;return((s=(t=e==null?void 0:e._internalMetadata)===null||t===void 0?void 0:t.gltf)===null||s===void 0?void 0:s[Y])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,s,n,i,r){return A.LoadExtensionAsync(e,i,this.name,(a,l)=>{const h=new Array;return h.push(this._loader._loadMeshPrimitiveAsync(e,t,s,n,i,c=>{if(r(c),c instanceof H){const u=A._GetDrawMode(e,i.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},m=f.gltf=f.gltf||{},_=m[Y]=m[Y]||{lastSelected:null,original:[],variants:{}};_.original.push({mesh:c,material:c.material});for(let p=0;p<l.mappings.length;++p){const g=l.mappings[p],y=x.Get(`${a}/mappings/${p}/material`,this._loader.gltf.materials,g.material);h.push(this._loader._loadMaterialAsync(`#/materials/${g.material}`,y,c,u,v=>{for(let O=0;O<g.variants.length;++O){const T=g.variants[O],M=x.Get(`/extensions/${Y}/variants/${T}`,this._variants,T);_.variants[M.name]=_.variants[M.name]||[],_.variants[M.name].push({mesh:c,material:v}),c.onClonedObservable.add(S=>{const N=S;let B=null,F=N;do{if(F=F.parent,!F)return;B=ue._GetExtensionMetadata(F)}while(B===null);if(d&&B===ue._GetExtensionMetadata(d)){F._internalMetadata={};for(const k in d._internalMetadata)F._internalMetadata[k]=d._internalMetadata[k];F._internalMetadata.gltf=[];for(const k in d._internalMetadata.gltf)F._internalMetadata.gltf[k]=d._internalMetadata.gltf[k];F._internalMetadata.gltf[Y]={lastSelected:null,original:[],variants:{}};for(const k of B.original)F._internalMetadata.gltf[Y].original.push({mesh:k.mesh,material:k.material});for(const k in B.variants)if(Object.prototype.hasOwnProperty.call(B.variants,k)){F._internalMetadata.gltf[Y].variants[k]=[];for(const Rt of B.variants[k])F._internalMetadata.gltf[Y].variants[k].push({mesh:Rt.mesh,material:Rt.material})}B=F._internalMetadata.gltf[Y]}for(const k of B.original)k.mesh===c&&(k.mesh=N);for(const k of B.variants[M.name])k.mesh===c&&(k.mesh=N)})}}))}}})),Promise.all(h).then(([c])=>c)})}}A.RegisterExtension(Y,o=>new ue(o));class Dt{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:me.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...Dt._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new q,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(i=>this._options[i]!==e[i]).length)return;const s={...this._options,...e},n=this._options;this._options=s,s.renderSize!==n.renderSize||s.renderTargetTextureType!==n.renderTargetTextureType||s.generateMipmaps!==n.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=s.samples,this._opaqueRenderTarget.lodGenerationScale=s.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=s.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof W&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),P.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),s=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof W&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),s!==-1?(this._opaqueMeshesCache.splice(s,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):s===-1&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Rs("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(t=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&t!==void 0?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;let s,n;this._opaqueRenderTarget.onBeforeBindObservable.add(i=>{n=this._scene.environmentIntensity,this._scene.environmentIntensity=1,s=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?i.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(i.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=n,this._scene.imageProcessingConfiguration._applyByPostProcess=s}),this._transparentMeshesCache.forEach(i=>{this._shouldRenderAsTransmission(i.material)&&(i.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const dt="KHR_materials_transmission";class Mn{constructor(e){this.name=dt,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(dt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadTransparentPropertiesAsync(n,t,s,i)),Promise.all(r).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,s,n){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const i=s;if(i.subSurface.isRefractionEnabled=!0,i.subSurface.volumeIndexOfRefraction=1,i.subSurface.useAlbedoToTintRefraction=!0,n.transmissionFactor!==void 0){i.subSurface.refractionIntensity=n.transmissionFactor;const r=i.getScene();i.subSurface.refractionIntensity&&!r._transmissionHelper&&new Dt({},i.getScene())}else return i.subSurface.refractionIntensity=0,i.subSurface.isRefractionEnabled=!1,Promise.resolve();return i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=0,n.transmissionTexture?(n.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,n.transmissionTexture,void 0).then(r=>{i.subSurface.refractionIntensityTexture=r,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}A.RegisterExtension(dt,o=>new Mn(o));const ft="KHR_materials_translucency";class On{constructor(e){this.name=ft,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(ft),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadTranslucentPropertiesAsync(n,t,s,i)),Promise.all(r).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,s,n){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);const i=s;if(i.subSurface.isTranslucencyEnabled=!0,i.subSurface.volumeIndexOfRefraction=1,i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=0,i.subSurface.useAlbedoToTintTranslucency=!0,n.translucencyFactor!==void 0)i.subSurface.translucencyIntensity=n.translucencyFactor;else return i.subSurface.translucencyIntensity=0,i.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return n.translucencyTexture?(n.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,n.translucencyTexture).then(r=>{i.subSurface.translucencyIntensityTexture=r})):Promise.resolve()}}A.RegisterExtension(ft,o=>new On(o));const _t="KHR_materials_volume";class wn{constructor(e){this.name=_t,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(_t),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return r.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),r.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),r.push(this._loadVolumePropertiesAsync(n,t,s,i)),Promise.all(r).then(()=>{})})}_loadVolumePropertiesAsync(e,t,s,n){if(!(s instanceof W))throw new Error(`${e}: Material type not supported`);if(!s.subSurface.isRefractionEnabled&&!s.subSurface.isTranslucencyEnabled||!n.thicknessFactor)return Promise.resolve();s.subSurface.volumeIndexOfRefraction=s.indexOfRefraction;const i=n.attenuationDistance!==void 0?n.attenuationDistance:Number.MAX_VALUE;return s.subSurface.tintColorAtDistance=i,n.attenuationColor!==void 0&&n.attenuationColor.length==3&&s.subSurface.tintColor.copyFromFloats(n.attenuationColor[0],n.attenuationColor[1],n.attenuationColor[2]),s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=n.thicknessFactor,s.subSurface.useThicknessAsDepth=!0,n.thicknessTexture?(n.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,n.thicknessTexture).then(r=>{s.subSurface.thicknessTexture=r,s.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}A.RegisterExtension(_t,o=>new wn(o));const mt="KHR_mesh_quantization";class Pn{constructor(e){this.name=mt,this.enabled=e.isExtensionUsed(mt)}dispose(){}}A.RegisterExtension(mt,o=>new Pn(o));const pt="KHR_texture_basisu";class Nn{constructor(e){this.name=pt,this._loader=e,this.enabled=e.isExtensionUsed(pt)}dispose(){this._loader=null}_loadTextureAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=t.sampler==null?A.DefaultSampler:x.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=x.Get(`${n}/source`,this._loader.gltf.images,i.source);return this._loader._createTextureAsync(e,r,a,l=>{s(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}A.RegisterExtension(pt,o=>new Nn(o));const gt="KHR_texture_transform";class Ln{constructor(e){this.name=gt,this._loader=e,this.enabled=this._loader.isExtensionUsed(gt)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>this._loader.loadTextureInfoAsync(e,t,r=>{if(!(r instanceof L))throw new Error(`${n}: Texture type not supported`);i.offset&&(r.uOffset=i.offset[0],r.vOffset=i.offset[1]),r.uRotationCenter=0,r.vRotationCenter=0,i.rotation&&(r.wAng=-i.rotation),i.scale&&(r.uScale=i.scale[0],r.vScale=i.scale[1]),i.texCoord!=null&&(r.coordinatesIndex=i.texCoord),s(r)}))}}A.RegisterExtension(gt,o=>new Ln(o));const At="KHR_xmp_json_ld";class Dn{constructor(e){this.name=At,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(At)}dispose(){this._loader=null}onLoading(){var e,t,s;if(this._loader.rootBabylonMesh===null)return;const n=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,i=(s=(t=this._loader.gltf.asset)===null||t===void 0?void 0:t.extensions)===null||s===void 0?void 0:s.KHR_xmp_json_ld;if(n&&i){const r=+i.packet;n.packets&&r<n.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=n.packets[r])}}}A.RegisterExtension(At,o=>new Dn(o));function Te(o,e,t,s){return U.FromArray(e,t).scale(s)}function Rn(o,e,t,s){return e[t+3]*s}function $(o,e,t,s){return e[t]*s}function yt(o,e,t,s){return-e[t]*s}function Re(o,e,t,s){return e[t+1]*s}function qt(o,e,t,s){return e[t]*s*2}function Ve(o){return{scale:[new D(I.ANIMATIONTYPE_FLOAT,`${o}.uScale`,$,()=>2),new D(I.ANIMATIONTYPE_FLOAT,`${o}.vScale`,Re,()=>2)],offset:[new D(I.ANIMATIONTYPE_FLOAT,`${o}.uOffset`,$,()=>2),new D(I.ANIMATIONTYPE_FLOAT,`${o}.vOffset`,Re,()=>2)],rotation:[new D(I.ANIMATIONTYPE_FLOAT,`${o}.wAng`,yt,()=>1)]}}class oe extends Le{buildAnimations(e,t,s,n,i){i(e._babylonCamera,this._buildAnimation(t,s,n))}}class D extends Le{buildAnimations(e,t,s,n,i){for(const r in e._data)i(e._data[r].babylonMaterial,this._buildAnimation(t,s,n))}}class Ie extends Le{buildAnimations(e,t,s,n,i){i(e._babylonLight,this._buildAnimation(t,s,n))}}const Bn={__array__:{__target__:!0,...Ce}},Fn={__array__:{__target__:!0,orthographic:{xmag:[new oe(I.ANIMATIONTYPE_FLOAT,"orthoLeft",yt,()=>1),new oe(I.ANIMATIONTYPE_FLOAT,"orthoRight",Re,()=>1)],ymag:[new oe(I.ANIMATIONTYPE_FLOAT,"orthoBottom",yt,()=>1),new oe(I.ANIMATIONTYPE_FLOAT,"orthoTop",Re,()=>1)],zfar:[new oe(I.ANIMATIONTYPE_FLOAT,"maxZ",$,()=>1)],znear:[new oe(I.ANIMATIONTYPE_FLOAT,"minZ",$,()=>1)]},perspective:{yfov:[new oe(I.ANIMATIONTYPE_FLOAT,"fov",$,()=>1)],zfar:[new oe(I.ANIMATIONTYPE_FLOAT,"maxZ",$,()=>1)],znear:[new oe(I.ANIMATIONTYPE_FLOAT,"minZ",$,()=>1)]}}},Un={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new D(I.ANIMATIONTYPE_COLOR3,"albedoColor",Te,()=>4),new D(I.ANIMATIONTYPE_FLOAT,"alpha",Rn,()=>4)],metallicFactor:[new D(I.ANIMATIONTYPE_FLOAT,"metallic",$,()=>1)],roughnessFactor:[new D(I.ANIMATIONTYPE_FLOAT,"roughness",$,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:Ve("albedoTexture")}}},emissiveFactor:[new D(I.ANIMATIONTYPE_COLOR3,"emissiveColor",Te,()=>3)],normalTexture:{scale:[new D(I.ANIMATIONTYPE_FLOAT,"bumpTexture.level",$,()=>1)]},occlusionTexture:{strength:[new D(I.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",$,()=>1)],extensions:{KHR_texture_transform:Ve("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:Ve("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new D(I.ANIMATIONTYPE_FLOAT,"indexOfRefraction",$,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new D(I.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",$,()=>1)],clearcoatRoughnessFactor:[new D(I.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",$,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new D(I.ANIMATIONTYPE_COLOR3,"sheen.color",Te,()=>3)],sheenRoughnessFactor:[new D(I.ANIMATIONTYPE_FLOAT,"sheen.roughness",$,()=>1)]},KHR_materials_specular:{specularFactor:[new D(I.ANIMATIONTYPE_FLOAT,"metallicF0Factor",$,()=>1)],specularColorFactor:[new D(I.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Te,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new D(I.ANIMATIONTYPE_FLOAT,"emissiveIntensity",$,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new D(I.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",$,()=>1)]},KHR_materials_volume:{attenuationColor:[new D(I.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Te,()=>3)],attenuationDistance:[new D(I.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",$,()=>1)],thicknessFactor:[new D(I.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",$,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new D(I.ANIMATIONTYPE_FLOAT,"iridescence.intensity",$,()=>1)],iridescenceIor:[new D(I.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",$,()=>1)],iridescenceThicknessMinimum:[new D(I.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",$,()=>1)],iridescenceThicknessMaximum:[new D(I.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",$,()=>1)]},KHR_materials_anisotropy:{anisotropyStrength:[new D(I.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",$,()=>1)],anisotropyRotation:[new D(I.ANIMATIONTYPE_FLOAT,"anisotropy.angle",$,()=>1)]}}}},$n={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new Ie(I.ANIMATIONTYPE_COLOR3,"diffuse",Te,()=>3)],intensity:[new Ie(I.ANIMATIONTYPE_FLOAT,"intensity",$,()=>1)],range:[new Ie(I.ANIMATIONTYPE_FLOAT,"range",$,()=>1)],spot:{innerConeAngle:[new Ie(I.ANIMATIONTYPE_FLOAT,"innerAngle",qt,()=>1)],outerConeAngle:[new Ie(I.ANIMATIONTYPE_FLOAT,"angle",qt,()=>1)]}}}}},Vn={nodes:Bn,materials:Un,cameras:Fn,extensions:$n},Tt="KHR_animation_pointer";class kn{constructor(e){this.name=Tt,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Tt)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,s,n,i){var r;const a=(r=n.target.extensions)===null||r===void 0?void 0:r.KHR_animation_pointer;if(!a)return null;n.target.path!=="pointer"&&w.Warn(`${e}/target/path: Value (${n.target.path}) must be (pointer) when using the ${this.name} extension`),n.target.node!=null&&w.Warn(`${e}/target/node: Value (${n.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,h=a.pointer;if(!h)throw new Error(`${l}: Pointer is missing`);const c=this._parseAnimationPointer(`${l}/pointer`,h);return c?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,c,i):(w.Warn(`${l}/pointer: Invalid pointer (${h}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return w.Warn(`${e}: Value (${t}) must start with a slash`),null;const s=t.split("/");s.shift();let n=Vn,i=this._loader.gltf,r;for(const a of s){if(n.__array__)n=n.__array__;else if(n=n[a],!n)return null;i=i&&i[a],n.__target__&&(r=i)}return!r||!Array.isArray(n)?null:{target:r,properties:n}}}A.RegisterExtension(Tt,o=>new kn(o));const xt="MSFT_audio_emitter";class Gn{constructor(e){this.name=xt,this._loader=e,this.enabled=this._loader.isExtensionUsed(xt)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,x.Assign(this._clips),x.Assign(this._emitters)}}loadSceneAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(s,n)=>{const i=new Array;i.push(this._loader.loadSceneAsync(e,t));for(const r of n.emitters){const a=x.Get(`${s}/emitters`,this._emitters,r);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${s}: Direction or Distance properties are not allowed on emitters attached to a scene`);i.push(this._loadEmitterAsync(`${s}/emitters/${a.index}`,a))}return Promise.all(i).then(()=>{})})}loadNodeAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{const r=new Array;return this._loader.loadNodeAsync(n,t,a=>{for(const l of i.emitters){const h=x.Get(`${n}/emitters`,this._emitters,l);r.push(this._loadEmitterAsync(`${n}/emitters/${h.index}`,h).then(()=>{for(const c of h._babylonSounds)c.attachToMesh(a),(h.innerAngle!=null||h.outerAngle!=null)&&(c.setLocalDirectionToMesh(E.Forward()),c.setDirectionalCone(2*P.ToDegrees(h.innerAngle==null?Math.PI:h.innerAngle),2*P.ToDegrees(h.outerAngle==null?Math.PI:h.outerAngle),0))}))}s(a)}).then(a=>Promise.all(r).then(()=>a))})}loadAnimationAsync(e,t){return A.LoadExtensionAsync(e,t,this.name,(s,n)=>this._loader.loadAnimationAsync(e,t).then(i=>{const r=new Array;x.Assign(n.events);for(const a of n.events)r.push(this._loadAnimationEventAsync(`${s}/events/${a.index}`,e,t,a,i));return Promise.all(r).then(()=>i)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let s;if(t.uri)s=this._loader.loadUriAsync(e,t,t.uri);else{const n=x.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);s=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}return t._objectURL=s.then(n=>URL.createObjectURL(new Blob([n],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const s=new Array,n=t.name||`emitter${t.index}`,i={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){const l=`/extensions/${this.name}/clips`,h=x.Get(l,this._clips,t.clips[a].clip);s.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,h).then(c=>{const u=t._babylonSounds[a]=new ge(n,c,this._loader.babylonScene,null,i);u.refDistance=t.refDistance||1,u.maxDistance=t.maxDistance||256,u.rolloffFactor=t.rolloffFactor||1,u.distanceModel=t.distanceModel||"exponential"}))}const r=Promise.all(s).then(()=>{const a=t.clips.map(h=>h.weight||1),l=new Vs(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*P.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*P.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:r}}return t._babylonData.loaded}_getEventAction(e,t,s,n,i){switch(s){case"play":return r=>{const a=(i||0)+(r-n);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${s}`)}}_loadAnimationEventAsync(e,t,s,n,i){if(i.targetedAnimations.length==0)return Promise.resolve();const r=i.targetedAnimations[0],a=n.emitter,l=x.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{const h=l._babylonData.sound;if(h){const c=new wt(n.time,this._getEventAction(e,h,n.action,n.time,n.startOffset));r.animation.addEvent(c),i.onAnimationGroupEndObservable.add(()=>{h.stop()}),i.onAnimationGroupPauseObservable.add(()=>{h.pause()})}})}}A.RegisterExtension(xt,o=>new Gn(o));const bt="MSFT_lod";class jn{constructor(e){this.name=bt,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new q,this.onMaterialLODsLoadedObservable=new q,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(bt)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const s=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),s}loadNodeAsync(e,t,s){return A.LoadExtensionAsync(e,t,this.name,(n,i)=>{let r;const a=this._getLODs(n,t,this._loader.gltf.nodes,i.ids);this._loader.logOpen(`${n}`);for(let l=0;l<a.length;l++){const h=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Se);const c=d=>{s(d),d.setEnabled(!1)},u=this._loader.loadNodeAsync(`/nodes/${h.index}`,h,c).then(d=>{if(l!==0){const f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?r=u:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(u))}return this._loader.logClose(),r})}_loadMaterialAsync(e,t,s,n,i){return this._nodeIndexLOD?null:A.LoadExtensionAsync(e,t,this.name,(r,a)=>{let l;const h=this._getLODs(r,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${r}`);for(let c=0;c<h.length;c++){const u=h[c];c!==0&&(this._materialIndexLOD=c);const d=this._loader._loadMaterialAsync(`/materials/${u.index}`,u,s,n,f=>{c===0&&i(f)}).then(f=>{if(c!==0){i(f);const m=h[c-1]._data;m[n]&&(this._disposeMaterials([m[n].babylonMaterial]),delete m[n])}return f});this._materialPromiseLODs[c]=this._materialPromiseLODs[c]||[],c===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[c].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,s){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const n=this._nodeIndexLOD-1;return this._nodeSignalLODs[n]=this._nodeSignalLODs[n]||new Se,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,s))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const n=this._materialIndexLOD-1;return this._materialSignalLODs[n]=this._materialSignalLODs[n]||new Se,this._materialSignalLODs[n].promise.then(()=>this._loader.loadUriAsync(e,t,s))}return null}loadBufferAsync(e,t,s,n){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const i=(r,a)=>{const l=s,h=l+n-1;let c=r[a];return c?(c.start=Math.min(c.start,l),c.end=Math.max(c.end,h)):(c={start:l,end:h,loaded:new Se},r[a]=c),c.loaded.promise.then(u=>new Uint8Array(u.buffer,u.byteOffset+s-c.start,n))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?i(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?i(this._materialBufferLODs,this._materialIndexLOD):i(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const s=e[t];s&&(this._loader.log(`Loading buffer range [${s.start}-${s.end}]`),this._loader.bin.readAsync(s.start,s.end-s.start+1).then(n=>{s.loaded.resolve(n)},n=>{s.loaded.reject(n)}))}_getLODs(e,t,s,n){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const i=new Array;for(let r=n.length-1;r>=0;r--)if(i.push(x.Get(`${e}/ids/${n[r]}`,s,n[r])),i.length===this.maxLODsToLoad)return i;return i.push(t),i}_disposeTransformNode(e){const t=new Array,s=e.material;s&&t.push(s);for(const i of e.getChildMeshes())i.material&&t.push(i.material);e.dispose();const n=t.filter(i=>this._loader.babylonScene.meshes.every(r=>r.material!=i));this._disposeMaterials(n)}_disposeMaterials(e){const t={};for(const s of e){for(const n of s.getActiveTextures())t[n.uniqueId]=n;s.dispose()}for(const s in t)for(const n of this._loader.babylonScene.materials)n.hasTexture(t[s])&&delete t[s];for(const s in t)t[s].dispose()}}A.RegisterExtension(bt,o=>new jn(o));const Et="MSFT_minecraftMesh";class Wn{constructor(e){this.name=Et,this._loader=e,this.enabled=this._loader.isExtensionUsed(Et)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtraAsync(e,t,this.name,(n,i)=>{if(i){if(!(s instanceof W))throw new Error(`${n}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,s);return s.needAlphaBlending()&&(s.forceDepthWrite=!0,s.separateCullingPass=!0),s.backFaceCulling=s.forceDepthWrite,s.twoSidedLighting=!0,r}return null})}}A.RegisterExtension(Et,o=>new Wn(o));const vt="MSFT_sRGBFactors";class Hn{constructor(e){this.name=vt,this._loader=e,this.enabled=this._loader.isExtensionUsed(vt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return A.LoadExtraAsync(e,t,this.name,(n,i)=>{if(i){if(!(s instanceof W))throw new Error(`${n}: Material type not supported`);const r=this._loader.loadMaterialPropertiesAsync(e,t,s),a=s.getScene().getEngine().useExactSrgbConversions;return s.albedoTexture||s.albedoColor.toLinearSpaceToRef(s.albedoColor,a),s.reflectivityTexture||s.reflectivityColor.toLinearSpaceToRef(s.reflectivityColor,a),r}return null})}}A.RegisterExtension(vt,o=>new Hn(o));const cs="ExtrasAsMetadata";class Kn{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const s=e.metadata=e.metadata||{},n=s.gltf=s.gltf||{};n.extras=t.extras}}constructor(e){this.name=cs,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,s){return this._loader.loadNodeAsync(e,t,n=>{this._assignExtras(n,t),s(n)})}loadCameraAsync(e,t,s){return this._loader.loadCameraAsync(e,t,n=>{this._assignExtras(n,t),s(n)})}createMaterial(e,t,s){const n=this._loader.createMaterial(e,t,s);return this._assignExtras(n,t),n}}A.RegisterExtension(cs,o=>new Kn(o));export{ue as $,$s as A,Kn as B,A as C,De as D,G as E,kn as F,hn as G,An as H,Us as I,yn as J,Fs as K,vn as L,de as M,bn as N,In as O,Ne as P,Fe as Q,ne as R,ge as S,En as T,Tn as U,Sn as V,Vs as W,Cn as X,On as Y,Mn as Z,xn as _,Q as a,wn as a0,Pn as a1,Nn as a2,Ln as a3,Dn as a4,Gn as a5,jn as a6,Wn as a7,Hn as a8,V as a9,xe as aa,we as ab,ee as ac,rs as ad,Ee as b,wt as c,Se as d,te as e,le as f,Ae as g,Nt as h,Pt as i,fe as j,ze as k,Z as l,qe as m,ie as n,$t as o,Me as p,ve as q,ae as r,z as s,cn as t,K as u,x as v,_n as w,mn as x,pn as y,gn as z};
