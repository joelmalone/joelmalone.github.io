var Gr=Object.defineProperty,Vr=Object.defineProperties;var Ur=Object.getOwnPropertyDescriptors;var pr=Object.getOwnPropertySymbols;var kr=Object.prototype.hasOwnProperty,Hr=Object.prototype.propertyIsEnumerable;var vr=(t,e,r)=>e in t?Gr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ar=(t,e)=>{for(var r in e||(e={}))kr.call(e,r)&&vr(t,r,e[r]);if(pr)for(var r of pr(e))Hr.call(e,r)&&vr(t,r,e[r]);return t},yr=(t,e)=>Vr(t,Ur(e));import{T as N,L as $,O as V,D as Se,a as Kr,S as re,b as mr,c as Ce,M as K,d as Wr,V as S,e as jr,f as P,g as le,h as gr,C as qr,i as Xr,j as Le,k as we,l as M,m as z,n as ue,Q as W,o as Q,H as Ne,p as ge,P as xe,q as Me,F as Pe,r as Er,s as ce,B as _e,t as Jr,G as Ie,u as zr,v as Yr,w as L,_ as Tr,x as Or,y as Zr,z as $r,I as Qr,J as en,K as D,N as pe,R as rn,U as nn,W as Y,X as tn,Y as sn,Z as on,$ as an,a0 as ln,a1 as un,a2 as cn,a3 as br,a4 as fn,a5 as Ee,a6 as dn,a7 as hn,a8 as _n,a9 as pn,aa as vn,ab as An,ac as yn,ad as mn,ae as Re,af as Sr}from"./vendor.a6be2030.js";function Fe(t,e,r,n){var s={externalResourceFunction:function(o){return n(o).then(function(a){return new Uint8Array(a)})}};return r&&(s.uri=e==="file:"?r:e+r),t instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(t),s):GLTFValidator.validateString(t,s)}function gn(){var t=[];onmessage=function(e){var r=e.data;switch(r.id){case"init":{importScripts(r.url);break}case"validate":{Fe(r.data,r.rootUrl,r.fileName,function(n){return new Promise(function(s,o){var a=t.length;t.push({resolve:s,reject:o}),postMessage({id:"getExternalResource",index:a,uri:n})})}).then(function(n){postMessage({id:"validate.resolve",value:n})},function(n){postMessage({id:"validate.reject",reason:n})});break}case"getExternalResource.resolve":{t[r.index].resolve(r.value);break}case"getExternalResource.reject":{t[r.index].reject(r.reason);break}}}}var En=function(){function t(){}return t.ValidateAsync=function(e,r,n,s){var o=this;return typeof Worker=="function"?new Promise(function(a,i){var l=Fe+"("+gn+")()",c=URL.createObjectURL(new Blob([l],{type:"application/javascript"})),u=new Worker(c),f=function(h){u.removeEventListener("error",f),u.removeEventListener("message",d),i(h)},d=function(h){var _=h.data;switch(_.id){case"getExternalResource":{s(_.uri).then(function(p){u.postMessage({id:"getExternalResource.resolve",index:_.index,value:p},[p])},function(p){u.postMessage({id:"getExternalResource.reject",index:_.index,reason:p})});break}case"validate.resolve":{u.removeEventListener("error",f),u.removeEventListener("message",d),a(_.value);break}case"validate.reject":u.removeEventListener("error",f),u.removeEventListener("message",d),i(_.reason)}};u.addEventListener("error",f),u.addEventListener("message",d),u.postMessage({id:"init",url:o.Configuration.url}),u.postMessage({id:"validate",data:e,rootUrl:r,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=N.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(function(){return Fe(e,r,n,s)}))},t.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},t}();function Cr(t,e,r){try{return Promise.resolve(new Uint8Array(t,e,r))}catch(n){return Promise.reject(n)}}var ve;(function(t){t[t.AUTO=0]="AUTO",t[t.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(ve||(ve={}));var de;(function(t){t[t.NONE=0]="NONE",t[t.FIRST=1]="FIRST",t[t.ALL=2]="ALL"})(de||(de={}));var X;(function(t){t[t.LOADING=0]="LOADING",t[t.READY=1]="READY",t[t.COMPLETE=2]="COMPLETE"})(X||(X={}));var se=function(){function t(){this.onParsedObservable=new V,this.coordinateSystemMode=ve.AUTO,this.animationStartMode=de.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.useSRGBBuffers=!0,this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable=new V,this.onTextureLoadedObservable=new V,this.onMaterialLoadedObservable=new V,this.onCameraLoadedObservable=new V,this.onCompleteObservable=new V,this.onErrorObservable=new V,this.onDisposeObservable=new V,this.onExtensionLoadedObservable=new V,this.validate=!1,this.onValidatedObservable=new V,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new V,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(t.prototype,"onParsed",{set:function(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMeshLoaded",{set:function(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTextureLoaded",{set:function(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onMaterialLoaded",{set:function(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onCameraLoaded",{set:function(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onComplete",{set:function(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onError",{set:function(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onExtensionLoaded",{set:function(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onValidated",{set:function(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null);for(var e=0,r=this._requests;e<r.length;e++){var n=r[e];n.abort()}this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=function(s){return Promise.resolve(s)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},t.prototype.loadFile=function(e,r,n,s,o,a){var i=this;if(this._progressCallback=s,o){if(this.useRangeRequests){this.validate&&$.Warn("glTF validation is not supported when range requests are enabled");var l={abort:function(){},onCompleteObservable:new V},c={readAsync:function(u,f){return new Promise(function(d,h){i._loadFile(e,r,function(_){d(new Uint8Array(_))},!0,function(_){h(_)},function(_){_.setRequestHeader("Range","bytes="+u+"-"+(u+f-1))})})},byteLength:0};return this._unpackBinaryAsync(new Se(c)).then(function(u){l.onCompleteObservable.notifyObservers(l),n(u)},a?function(u){return a(void 0,u)}:void 0),l}return this._loadFile(e,r,function(u){var f=u;i._unpackBinaryAsync(new Se({readAsync:function(d,h){return Cr(f,d,h)},byteLength:f.byteLength})).then(function(d){n(d)},a?function(d){return a(void 0,d)}:void 0)},!0,a)}return this._loadFile(e,r,function(u){if(r.name)i._validate(e,u,"file:",r.name);else{var f=r;i._validate(e,u,N.GetFolderPath(f),N.GetFilename(f))}n({json:i._parseJson(u)})},o,a)},t.prototype.importMeshAsync=function(e,r,n,s,o,a){var i=this;return Promise.resolve().then(function(){return i.onParsedObservable.notifyObservers(n),i.onParsedObservable.clear(),i._log("Loading "+(a||"")),i._loader=i._getLoader(n),i._loader.importMeshAsync(e,r,null,n,s,o,a)})},t.prototype.loadAsync=function(e,r,n,s,o){var a=this;return Promise.resolve().then(function(){return a.onParsedObservable.notifyObservers(r),a.onParsedObservable.clear(),a._log("Loading "+(o||"")),a._loader=a._getLoader(r),a._loader.loadAsync(e,r,n,s,o)})},t.prototype.loadAssetContainerAsync=function(e,r,n,s,o){var a=this;return Promise.resolve().then(function(){a.onParsedObservable.notifyObservers(r),a.onParsedObservable.clear(),a._log("Loading "+(o||"")),a._loader=a._getLoader(r);var i=new Kr(e),l=[];a.onMaterialLoadedObservable.add(function(f){l.push(f)});var c=[];a.onTextureLoadedObservable.add(function(f){c.push(f)});var u=[];return a.onCameraLoadedObservable.add(function(f){u.push(f)}),a._loader.importMeshAsync(null,e,i,r,n,s,o).then(function(f){return Array.prototype.push.apply(i.geometries,f.geometries),Array.prototype.push.apply(i.meshes,f.meshes),Array.prototype.push.apply(i.particleSystems,f.particleSystems),Array.prototype.push.apply(i.skeletons,f.skeletons),Array.prototype.push.apply(i.animationGroups,f.animationGroups),Array.prototype.push.apply(i.materials,l),Array.prototype.push.apply(i.textures,c),Array.prototype.push.apply(i.lights,f.lights),Array.prototype.push.apply(i.transformNodes,f.transformNodes),Array.prototype.push.apply(i.cameras,u),i})})},t.prototype.canDirectLoad=function(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||re.StartsWith(e,"data:base64,"+t.magicBase64Encoded)||re.StartsWith(e,"data:;base64,"+t.magicBase64Encoded)||re.StartsWith(e,"data:application/octet-stream;base64,"+t.magicBase64Encoded)||re.StartsWith(e,"data:model/gltf-binary;base64,"+t.magicBase64Encoded)},t.prototype.directLoad=function(e,r){if(re.StartsWith(r,"base64,"+t.magicBase64Encoded)||re.StartsWith(r,";base64,"+t.magicBase64Encoded)||re.StartsWith(r,"application/octet-stream;base64,"+t.magicBase64Encoded)||re.StartsWith(r,"model/gltf-binary;base64,"+t.magicBase64Encoded)){var n=mr(r);return this._validate(e,n),this._unpackBinaryAsync(new Se({readAsync:function(s,o){return Cr(n,s,o)},byteLength:n.byteLength}))}return this._validate(e,r),Promise.resolve({json:this._parseJson(r)})},t.prototype.createPlugin=function(){return new t},Object.defineProperty(t.prototype,"loaderState",{get:function(){return this._state},enumerable:!1,configurable:!0}),t.prototype.whenCompleteAsync=function(){var e=this;return new Promise(function(r,n){e.onCompleteObservable.addOnce(function(){r()}),e.onErrorObservable.addOnce(function(s){n(s)})})},t.prototype._setState=function(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(X[this._state]))},t.prototype._loadFile=function(e,r,n,s,o,a){var i=this,l=e._loadFile(r,n,function(c){i._onProgress(c,l)},!0,s,o,a);return l.onCompleteObservable.add(function(c){i._requests.splice(i._requests.indexOf(c),1)}),this._requests.push(l),l},t.prototype._onProgress=function(e,r){if(!!this._progressCallback){r._lengthComputable=e.lengthComputable,r._loaded=e.loaded,r._total=e.total;for(var n=!0,s=0,o=0,a=0,i=this._requests;a<i.length;a++){var l=i[a];if(l._lengthComputable===void 0||l._loaded===void 0||l._total===void 0)return;n=n&&l._lengthComputable,s+=l._loaded,o+=l._total}this._progressCallback({lengthComputable:n,loaded:s,total:n?o:0})}},t.prototype._validate=function(e,r,n,s){var o=this;n===void 0&&(n=""),s===void 0&&(s=""),!!this.validate&&(this._startPerformanceCounter("Validate JSON"),En.ValidateAsync(r,n,s,function(a){return o.preprocessUrlAsync(n+a).then(function(i){return e._loadFileAsync(i,void 0,!0,!0)})}).then(function(a){o._endPerformanceCounter("Validate JSON"),o.onValidatedObservable.notifyObservers(a),o.onValidatedObservable.clear()},function(a){o._endPerformanceCounter("Validate JSON"),N.Warn("Failed to validate: "+a.message),o.onValidatedObservable.clear()}))},t.prototype._getLoader=function(e){var r=e.json.asset||{};this._log("Asset version: "+r.version),r.minVersion&&this._log("Asset minimum version: "+r.minVersion),r.generator&&this._log("Asset generator: "+r.generator);var n=t._parseVersion(r.version);if(!n)throw new Error("Invalid version: "+r.version);if(r.minVersion!==void 0){var s=t._parseVersion(r.minVersion);if(!s)throw new Error("Invalid minimum version: "+r.minVersion);if(t._compareVersion(s,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+r.minVersion)}var o={1:t._CreateGLTF1Loader,2:t._CreateGLTF2Loader},a=o[n.major];if(!a)throw new Error("Unsupported version: "+r.version);return a(this)},t.prototype._parseJson=function(e){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: "+e.length);var r=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),r},t.prototype._unpackBinaryAsync=function(e){var r=this;return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(function(){var n={Magic:1179937895},s=e.readUint32();if(s!==n.Magic)throw new Error("Unexpected magic: "+s);var o=e.readUint32();r.loggingEnabled&&r._log("Binary version: "+o);var a=e.readUint32();if(e.buffer.byteLength!==0&&a!==e.buffer.byteLength)throw new Error("Length in header does not match actual data length: "+a+" != "+e.buffer.byteLength);var i;switch(o){case 1:{i=r._unpackBinaryV1Async(e,a);break}case 2:{i=r._unpackBinaryV2Async(e,a);break}default:throw new Error("Unsupported version: "+o)}return r._endPerformanceCounter("Unpack Binary"),i})},t.prototype._unpackBinaryV1Async=function(e,r){var n={JSON:0},s=e.readUint32(),o=e.readUint32();if(o!==n.JSON)throw new Error("Unexpected content format: "+o);var a=r-e.byteOffset,i={json:this._parseJson(e.readString(s)),bin:null};if(a!==0){var l=e.byteOffset;i.bin={readAsync:function(c,u){return e.buffer.readAsync(l+c,u)},byteLength:a}}return Promise.resolve(i)},t.prototype._unpackBinaryV2Async=function(e,r){var n=this,s={JSON:1313821514,BIN:5130562},o=e.readUint32(),a=e.readUint32();if(a!==s.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+o===r?e.loadAsync(o).then(function(){return{json:n._parseJson(e.readString(o)),bin:null}}):e.loadAsync(o+8).then(function(){var i={json:n._parseJson(e.readString(o)),bin:null},l=function(){var c=e.readUint32(),u=e.readUint32();switch(u){case s.JSON:throw new Error("Unexpected JSON chunk");case s.BIN:{var f=e.byteOffset;i.bin={readAsync:function(d,h){return e.buffer.readAsync(f+d,h)},byteLength:c},e.skipBytes(c);break}default:{e.skipBytes(c);break}}return e.byteOffset!==r?e.loadAsync(8).then(l):Promise.resolve(i)};return l()})},t._parseVersion=function(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};var r=(e+"").match(/^(\d+)\.(\d+)/);return r?{major:parseInt(r[1]),minor:parseInt(r[2])}:null},t._compareVersion=function(e,r){return e.major>r.major?1:e.major<r.major?-1:e.minor>r.minor?1:e.minor<r.minor?-1:0},t.prototype._logOpen=function(e){this._log(e),this._logIndentLevel++},t.prototype._logClose=function(){--this._logIndentLevel},t.prototype._logEnabled=function(e){var r=t._logSpaces.substr(0,this._logIndentLevel*2);$.Log(""+r+e)},t.prototype._logDisabled=function(e){},t.prototype._startPerformanceCounterEnabled=function(e){N.StartPerformanceCounter(e)},t.prototype._startPerformanceCounterDisabled=function(e){},t.prototype._endPerformanceCounterEnabled=function(e){N.EndPerformanceCounter(e)},t.prototype._endPerformanceCounterDisabled=function(e){},t.IncrementalLoading=!0,t.HomogeneousCoordinates=!1,t.magicBase64Encoded="Z2xURg",t._logSpaces="                                ",t}();Ce&&Ce.RegisterPlugin(new se);var oe;(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.FLOAT=5126]="FLOAT"})(oe||(oe={}));var Be;(function(t){t[t.FRAGMENT=35632]="FRAGMENT",t[t.VERTEX=35633]="VERTEX"})(Be||(Be={}));var j;(function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D"})(j||(j={}));var Ae;(function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",t[t.REPEAT=10497]="REPEAT"})(Ae||(Ae={}));var ee;(function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9728]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ee||(ee={}));var Lr;(function(t){t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Lr||(Lr={}));var De;(function(t){t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(De||(De={}));var F;(function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(F||(F={}));var J=function(){function t(){}return t.SetMatrix=function(e,r,n,s,o){var a=null;if(n.semantic==="MODEL")a=r.getWorldMatrix();else if(n.semantic==="PROJECTION")a=e.getProjectionMatrix();else if(n.semantic==="VIEW")a=e.getViewMatrix();else if(n.semantic==="MODELVIEWINVERSETRANSPOSE")a=K.Transpose(r.getWorldMatrix().multiply(e.getViewMatrix()).invert());else if(n.semantic==="MODELVIEW")a=r.getWorldMatrix().multiply(e.getViewMatrix());else if(n.semantic==="MODELVIEWPROJECTION")a=r.getWorldMatrix().multiply(e.getTransformMatrix());else if(n.semantic==="MODELINVERSE")a=r.getWorldMatrix().invert();else if(n.semantic==="VIEWINVERSE")a=e.getViewMatrix().invert();else if(n.semantic==="PROJECTIONINVERSE")a=e.getProjectionMatrix().invert();else if(n.semantic==="MODELVIEWINVERSE")a=r.getWorldMatrix().multiply(e.getViewMatrix()).invert();else if(n.semantic==="MODELVIEWPROJECTIONINVERSE")a=r.getWorldMatrix().multiply(e.getTransformMatrix()).invert();else if(n.semantic==="MODELINVERSETRANSPOSE")a=K.Transpose(r.getWorldMatrix().invert());else debugger;if(a)switch(n.type){case j.FLOAT_MAT2:o.setMatrix2x2(s,K.GetAsMatrix2x2(a));break;case j.FLOAT_MAT3:o.setMatrix3x3(s,K.GetAsMatrix3x3(a));break;case j.FLOAT_MAT4:o.setMatrix(s,a);break}},t.SetUniform=function(e,r,n,s){switch(s){case j.FLOAT:return e.setFloat(r,n),!0;case j.FLOAT_VEC2:return e.setVector2(r,jr.FromArray(n)),!0;case j.FLOAT_VEC3:return e.setVector3(r,S.FromArray(n)),!0;case j.FLOAT_VEC4:return e.setVector4(r,Wr.FromArray(n)),!0;default:return!1}},t.GetWrapMode=function(e){switch(e){case Ae.CLAMP_TO_EDGE:return P.CLAMP_ADDRESSMODE;case Ae.MIRRORED_REPEAT:return P.MIRROR_ADDRESSMODE;case Ae.REPEAT:return P.WRAP_ADDRESSMODE;default:return P.WRAP_ADDRESSMODE}},t.GetByteStrideFromType=function(e){var r=e.type;switch(r){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},t.GetTextureFilterMode=function(e){switch(e){case ee.LINEAR:case ee.LINEAR_MIPMAP_NEAREST:case ee.LINEAR_MIPMAP_LINEAR:return P.TRILINEAR_SAMPLINGMODE;case ee.NEAREST:case ee.NEAREST_MIPMAP_NEAREST:return P.NEAREST_SAMPLINGMODE;default:return P.BILINEAR_SAMPLINGMODE}},t.GetBufferFromBufferView=function(e,r,n,s,o){var n=r.byteOffset+n,a=e.loadedBufferViews[r.buffer];if(n+s>a.byteLength)throw new Error("Buffer access is out of range");var i=a.buffer;switch(n+=a.byteOffset,o){case oe.BYTE:return new Int8Array(i,n,s);case oe.UNSIGNED_BYTE:return new Uint8Array(i,n,s);case oe.SHORT:return new Int16Array(i,n,s);case oe.UNSIGNED_SHORT:return new Uint16Array(i,n,s);default:return new Float32Array(i,n,s)}},t.GetBufferFromAccessor=function(e,r){var n=e.bufferViews[r.bufferView],s=r.count*t.GetByteStrideFromType(r);return t.GetBufferFromBufferView(e,n,r.byteOffset,s,r.componentType)},t.DecodeBufferToText=function(e){for(var r="",n=e.byteLength,s=0;s<n;++s)r+=String.fromCharCode(e[s]);return r},t.GetDefaultMaterial=function(e){if(!t._DefaultMaterial){le.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),le.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);var r={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},n={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};t._DefaultMaterial=new gr("GLTFDefaultMaterial",e,r,n),t._DefaultMaterial.setColor4("u_emission",new qr(.5,.5,.5,1))}return t._DefaultMaterial},t._DefaultMaterial=null,t}(),ae;(function(t){t[t.IDENTIFIER=1]="IDENTIFIER",t[t.UNKNOWN=2]="UNKNOWN",t[t.END_OF_INPUT=3]="END_OF_INPUT"})(ae||(ae={}));var wr=function(){function t(e){this._pos=0,this.currentToken=ae.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}return t.prototype.getNextToken=function(){if(this.isEnd())return ae.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=ae.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=ae.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},t.prototype.peek=function(){return this._toParse[this._pos]},t.prototype.read=function(){return this._toParse[this._pos++]},t.prototype.forward=function(){this._pos++},t.prototype.isEnd=function(){return this._pos>=this._maxPos},t}(),Nr=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],xr=["world","view","projection","worldView","worldViewProjection","mBones"],Tn=["translation","rotation","scale"],On=["position","rotationQuaternion","scaling"],bn=function(t,e){for(var r in t){var n=t[r];e.buffers[r]=n,e.buffersCount++}},Sn=function(t,e){for(var r in t){var n=t[r];e.shaders[r]=n,e.shaderscount++}},U=function(t,e,r){for(var n in t){var s=t[n];r[e][n]=s}},Cn=function(t){if(!!t)for(var e=0;e<t.length/2;e++)t[e*2+1]=1-t[e*2+1]},Mr=function(t){if(t.semantic==="NORMAL")return"normal";if(t.semantic==="POSITION")return"position";if(t.semantic==="JOINT")return"matricesIndices";if(t.semantic==="WEIGHT")return"matricesWeights";if(t.semantic==="COLOR")return"color";if(t.semantic&&t.semantic.indexOf("TEXCOORD_")!==-1){var e=Number(t.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},Ln=function(t){for(var e in t.animations){var r=t.animations[e];if(!(!r.channels||!r.samplers))for(var n=null,s=0;s<r.channels.length;s++){var o=r.channels[s],a=r.samplers[o.sampler];if(!!a){var i=null,l=null;r.parameters?(i=r.parameters[a.input],l=r.parameters[a.output]):(i=a.input,l=a.output);var c=J.GetBufferFromAccessor(t,t.accessors[i]),u=J.GetBufferFromAccessor(t,t.accessors[l]),f=o.target.id,d=t.scene.getNodeById(f);if(d===null&&(d=t.scene.getNodeByName(f)),d===null){N.Warn("Creating animation named "+e+". But cannot find node named "+f+" to attach to");continue}var h=d instanceof _e,_=o.target.path,p=Tn.indexOf(_);p!==-1&&(_=On[p]);var v=Q.ANIMATIONTYPE_MATRIX;h||(_==="rotationQuaternion"?(v=Q.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new W):v=Q.ANIMATIONTYPE_VECTOR3);var y=null,b=[],A=0,T=!1;h&&n&&n.getKeys().length===c.length&&(y=n,T=!0),T||(t.scene._blockEntityCollection=!!t.assetContainer,y=new Q(e,h?"_matrix":_,1,v,Q.ANIMATIONLOOPMODE_CYCLE),t.scene._blockEntityCollection=!1);for(var E=0;E<c.length;E++){var m=null;if(_==="rotationQuaternion"?(m=W.FromArray([u[A],u[A+1],u[A+2],u[A+3]]),A+=4):(m=S.FromArray([u[A],u[A+1],u[A+2]]),A+=3),h){var R=d,w=S.Zero(),x=new W,C=S.Zero(),G=R.getBaseMatrix();T&&n&&(G=n.getKeys()[E].value),G.decompose(C,x,w),_==="position"?w=m:_==="rotationQuaternion"?x=m:C=m,m=K.Compose(C,x,w)}T?n&&(n.getKeys()[E].value=m):b.push({frame:c[E],value:m})}!T&&y&&(y.setKeys(b),d.animations.push(y)),n=y,t.scene.stopAnimation(d),t.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}}},Ge=function(t){var e=null;if(t.translation||t.rotation||t.scale){var r=S.FromArray(t.scale||[1,1,1]),n=W.FromArray(t.rotation||[0,0,0,1]),s=S.FromArray(t.translation||[0,0,0]);e=K.Compose(r,n,s)}else e=K.FromArray(t.matrix);return e},Pr=function(t,e,r,n){for(var s=0;s<n.bones.length;s++)if(n.bones[s].name===r)return n.bones[s];var o=t.nodes;for(var a in o){var i=o[a];if(!!i.jointName)for(var l=i.children,s=0;s<l.length;s++){var c=t.nodes[l[s]];if(!!c.jointName&&c.jointName===r){var u=Ge(i),f=new _e(i.name||"",n,Pr(t,e,i.jointName,n),u);return f.id=a,f}}}return null},wn=function(t,e){for(var r=0;r<t.length;r++)for(var n=t[r],s=0;s<n.node.children.length;s++){var o=n.node.children[s];if(o===e)return n.bone}return null},Ve=function(t,e){var r=t.nodes,n=r[e];if(n)return{node:n,id:e};for(var s in r)if(n=r[s],n.jointName===e)return{node:n,id:s};return null},Nn=function(t,e){for(var r=0;r<t.jointNames.length;r++)if(t.jointNames[r]===e)return!0;return!1},xn=function(t,e,r,n){for(var s in t.nodes){var o=t.nodes[s],a=s;if(!(!o.jointName||Nn(r,o.jointName))){var i=Ge(o),l=new _e(o.name||"",e,null,i);l.id=a,n.push({bone:l,node:o,id:a})}}for(var c=0;c<n.length;c++)for(var u=n[c],f=u.node.children,d=0;d<f.length;d++){for(var h=null,_=0;_<n.length;_++)if(n[_].id===f[d]){h=n[_];break}h&&(h.bone._parent=u.bone,u.bone.children.push(h.bone))}},Mn=function(t,e,r,n,s){if(n||(n=new Le(e.name||"","",t.scene)),!e.babylonSkeleton)return n;var o=[],a=[];xn(t,n,e,o),n.bones=[];for(var i=0;i<e.jointNames.length;i++){var l=Ve(t,e.jointNames[i]);if(!!l){var c=l.node;if(!c){N.Warn("Joint named "+e.jointNames[i]+" does not exist");continue}var s=l.id,u=t.scene.getBoneById(s);if(u){n.bones.push(u);continue}for(var f=!1,d=null,h=0;h<i;h++){var _=Ve(t,e.jointNames[h]);if(!!_){var p=_.node;if(!p){N.Warn("Joint named "+e.jointNames[h]+" does not exist when looking for parent");continue}var v=p.children;if(!!v){f=!1;for(var y=0;y<v.length;y++)if(v[y]===s){d=Pr(t,e,e.jointNames[h],n),f=!0;break}if(f)break}}}var b=Ge(c);!d&&o.length>0&&(d=wn(o,s),d&&a.indexOf(d)===-1&&a.push(d));var A=new _e(c.jointName||"",n,d,b);A.id=s}}var T=n.bones;n.bones=[];for(var i=0;i<e.jointNames.length;i++){var l=Ve(t,e.jointNames[i]);if(!!l){for(var h=0;h<T.length;h++)if(T[h].id===l.id){n.bones.push(T[h]);break}}}n.prepare();for(var i=0;i<a.length;i++)n.bones.push(a[i]);return n},Ir=function(t,e,r,n,s){if(s||(t.scene._blockEntityCollection=!!t.assetContainer,s=new ce(e.name||"",t.scene),s._parentContainer=t.assetContainer,t.scene._blockEntityCollection=!1,s.id=n),!e.babylonNode)return s;for(var o=[],a=null,i=new Array,l=new Array,c=new Array,u=new Array,f=0;f<r.length;f++){var d=r[f],h=t.meshes[d];if(!!h)for(var _=0;_<h.primitives.length;_++){var p=new Yr,v=h.primitives[_];v.mode!==4;var y=v.attributes,b=null,A=null;for(var T in y)if(b=t.accessors[y[T]],A=J.GetBufferFromAccessor(t,b),T==="NORMAL")p.normals=new Float32Array(A.length),p.normals.set(A);else if(T==="POSITION"){if(se.HomogeneousCoordinates){p.positions=new Float32Array(A.length-A.length/4);for(var E=0;E<A.length;E+=4)p.positions[E]=A[E],p.positions[E+1]=A[E+1],p.positions[E+2]=A[E+2]}else p.positions=new Float32Array(A.length),p.positions.set(A);l.push(p.positions.length)}else if(T.indexOf("TEXCOORD_")!==-1){var m=Number(T.split("_")[1]),R=L.UVKind+(m===0?"":m+1),w=new Float32Array(A.length);w.set(A),Cn(w),p.set(w,R)}else T==="JOINT"?(p.matricesIndices=new Float32Array(A.length),p.matricesIndices.set(A)):T==="WEIGHT"?(p.matricesWeights=new Float32Array(A.length),p.matricesWeights.set(A)):T==="COLOR"&&(p.colors=new Float32Array(A.length),p.colors.set(A));if(b=t.accessors[v.indices],b)A=J.GetBufferFromAccessor(t,b),p.indices=new Int32Array(A.length),p.indices.set(A),u.push(p.indices.length);else{for(var x=[],E=0;E<p.positions.length/3;E++)x.push(E);p.indices=new Int32Array(x),u.push(p.indices.length)}a?a.merge(p):a=p;var C=t.scene.getMaterialById(v.material);o.push(C===null?J.GetDefaultMaterial(t.scene):C),i.push(i.length===0?0:i[i.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+u[u.length-2])}}var G;t.scene._blockEntityCollection=!!t.assetContainer,o.length>1?(G=new Jr("multimat"+n,t.scene),G.subMaterials=o):G=new we("multimat"+n,t.scene),o.length===1&&(G=o[0]),G._parentContainer=t.assetContainer,s.material||(s.material=G),new Ie(n,t.scene,a,!1,s),s.computeWorldMatrix(!0),t.scene._blockEntityCollection=!1,s.subMeshes=[];for(var k=0,f=0;f<r.length;f++){var d=r[f],h=t.meshes[d];if(!!h)for(var _=0;_<h.primitives.length;_++)h.primitives[_].mode!==4,zr.AddToMesh(k,i[k],l[k],c[k],u[k],s,s,!0),k++}return s},Ue=function(t,e,r,n){t.position&&(t.position=e),(t.rotationQuaternion||t.rotation)&&(t.rotationQuaternion=r),t.scaling&&(t.scaling=n)},Pn=function(t,e,r){if(e.matrix){var n=new S(0,0,0),s=new W,o=new S(0,0,0),a=K.FromArray(e.matrix);a.decompose(o,s,n),Ue(t,n,s,o)}else e.translation&&e.rotation&&e.scale&&Ue(t,S.FromArray(e.translation),W.FromArray(e.rotation),S.FromArray(e.scale));t.computeWorldMatrix(!0)},In=function(t,e,r,n){var s=null;if(t.importOnlyMeshes&&(e.skin||e.meshes)&&t.importMeshesNames&&t.importMeshesNames.length>0&&t.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){var o=t.skins[e.skin],a=Ir(t,e,e.meshes,r,e.babylonNode);a.skeleton=t.scene.getLastSkeletonById(e.skin),a.skeleton===null&&(a.skeleton=Mn(t,o,a,o.babylonSkeleton,e.skin),o.babylonSkeleton||(o.babylonSkeleton=a.skeleton)),s=a}}else if(e.meshes){var a=Ir(t,e,e.mesh?[e.mesh]:e.meshes,r,e.babylonNode);s=a}else if(e.light&&!e.babylonNode&&!t.importOnlyMeshes){var i=t.lights[e.light];if(i){if(i.type==="ambient"){var l=i[i.type],c=new Ne(e.light,S.Zero(),t.scene);c.name=e.name||"",l.color&&(c.diffuse=M.FromArray(l.color)),s=c}else if(i.type==="directional"){var u=i[i.type],f=new ge(e.light,S.Zero(),t.scene);f.name=e.name||"",u.color&&(f.diffuse=M.FromArray(u.color)),s=f}else if(i.type==="point"){var d=i[i.type],h=new xe(e.light,S.Zero(),t.scene);h.name=e.name||"",d.color&&(h.diffuse=M.FromArray(d.color)),s=h}else if(i.type==="spot"){var _=i[i.type],p=new Me(e.light,S.Zero(),S.Zero(),0,0,t.scene);p.name=e.name||"",_.color&&(p.diffuse=M.FromArray(_.color)),_.fallOfAngle&&(p.angle=_.fallOfAngle),_.fallOffExponent&&(p.exponent=_.fallOffExponent),s=p}}}else if(e.camera&&!e.babylonNode&&!t.importOnlyMeshes){var v=t.cameras[e.camera];if(v){if(t.scene._blockEntityCollection=!!t.assetContainer,v.type==="orthographic"){var y=new Pe(e.camera,S.Zero(),t.scene,!1);y.name=e.name||"",y.mode=Er.ORTHOGRAPHIC_CAMERA,y.attachControl(),s=y,y._parentContainer=t.assetContainer}else if(v.type==="perspective"){var b=v[v.type],A=new Pe(e.camera,S.Zero(),t.scene,!1);A.name=e.name||"",A.attachControl(),b.aspectRatio||(b.aspectRatio=t.scene.getEngine().getRenderWidth()/t.scene.getEngine().getRenderHeight()),b.znear&&b.zfar&&(A.maxZ=b.zfar,A.minZ=b.znear),s=A,A._parentContainer=t.assetContainer}t.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(s===null){t.scene._blockEntityCollection=!!t.assetContainer;var T=new ce(e.name||"",t.scene);T._parentContainer=t.assetContainer,t.scene._blockEntityCollection=!1,e.babylonNode=T,s=T}}if(s!==null){if(e.matrix&&s instanceof ce)Pn(s,e);else{var E=e.translation||[0,0,0],m=e.rotation||[0,0,0,1],R=e.scale||[1,1,1];Ue(s,S.FromArray(E),W.FromArray(m),S.FromArray(R))}s.updateCache(!0),e.babylonNode=s}return s},ye=function(t,e,r,n){n===void 0&&(n=!1);var s=t.nodes[e],o=null;if(t.importOnlyMeshes&&!n&&t.importMeshesNames?t.importMeshesNames.indexOf(s.name||"")!==-1||t.importMeshesNames.length===0?n=!0:n=!1:n=!0,!s.jointName&&n&&(o=In(t,s,e),o!==null&&(o.id=e,o.parent=r)),s.children)for(var a=0;a<s.children.length;a++)ye(t,s.children[a],o,n)},Rr=function(t){var e=t.currentScene;if(e)for(var r=0;r<e.nodes.length;r++)ye(t,e.nodes[r],null);else for(var n in t.scenes){e=t.scenes[n];for(var r=0;r<e.nodes.length;r++)ye(t,e.nodes[r],null)}Ln(t);for(var r=0;r<t.scene.skeletons.length;r++){var s=t.scene.skeletons[r];t.scene.beginAnimation(s,0,Number.MAX_VALUE,!0,1)}},Rn=function(t,e,r,n,s,o,a){var i=o.values||s.parameters;for(var l in r){var c=r[l],u=c.type;if(u===j.FLOAT_MAT2||u===j.FLOAT_MAT3||u===j.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)J.SetMatrix(e.scene,t,c,l,n.getEffect());else if(c.semantic&&(c.source||c.node)){var f=e.scene.getNodeByName(c.source||c.node||"");if(f===null&&(f=e.scene.getNodeById(c.source||c.node||"")),f===null)continue;J.SetMatrix(e.scene,f,c,l,n.getEffect())}}else{var d=i[s.uniforms[l]];if(!d)continue;if(u===j.SAMPLER_2D){var h=e.textures[o.values?d:c.value].babylonTexture;if(h==null)continue;n.getEffect().setTexture(l,h)}else J.SetUniform(n.getEffect(),l,d,u)}}a(n)},Fn=function(t,e,r,n,s){var o=n.values||r.parameters,a=r.uniforms;for(var i in s){var l=s[i],c=l.type,u=o[a[i]];if(u===void 0&&(u=l.value),!!u){var f=function(d){return function(h){l.value&&d&&(e.setTexture(d,h),delete s[d])}};c===j.SAMPLER_2D?te.LoadTextureAsync(t,n.values?u:l.value,f(i),function(){return f(null)}):l.value&&J.SetUniform(e,i,n.values?u:l.value,c)&&delete s[i]}}},Bn=function(t,e,r){return function(n,s){e.dispose(!0),r("Cannot compile program named "+t.name+". Error: "+s+". Default material will be applied")}},Dn=function(t,e,r,n,s,o){return function(a){Fn(t,e,r,n,s),e.onBind=function(i){Rn(i,t,s,e,r,n,o)}}},Fr=function(t,e,r){for(var n in e.uniforms){var s=e.uniforms[n],o=e.parameters[s];if(t.currentIdentifier===n&&o.semantic&&!o.source&&!o.node){var a=Nr.indexOf(o.semantic);if(a!==-1)return delete r[n],xr[a]}}return t.currentIdentifier},Br=function(t){for(var e in t.materials)te.LoadMaterialAsync(t,e,function(r){},function(){})},ne=function(){function t(){}return t.CreateRuntime=function(e,r,n){var s={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:r,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&U(e.extensions,"extensions",s),e.extensionsUsed&&U(e.extensionsUsed,"extensionsUsed",s),e.buffers&&bn(e.buffers,s),e.bufferViews&&U(e.bufferViews,"bufferViews",s),e.accessors&&U(e.accessors,"accessors",s),e.meshes&&U(e.meshes,"meshes",s),e.lights&&U(e.lights,"lights",s),e.cameras&&U(e.cameras,"cameras",s),e.nodes&&U(e.nodes,"nodes",s),e.images&&U(e.images,"images",s),e.textures&&U(e.textures,"textures",s),e.shaders&&Sn(e.shaders,s),e.programs&&U(e.programs,"programs",s),e.samplers&&U(e.samplers,"samplers",s),e.techniques&&U(e.techniques,"techniques",s),e.materials&&U(e.materials,"materials",s),e.animations&&U(e.animations,"animations",s),e.skins&&U(e.skins,"skins",s),e.scenes&&(s.scenes=e.scenes),e.scene&&e.scenes&&(s.currentScene=e.scenes[e.scene]),s},t.LoadBufferAsync=function(e,r,n,s,o){var a=e.buffers[r];N.IsBase64(a.uri)?setTimeout(function(){return n(new Uint8Array(N.DecodeBase64(a.uri)))}):N.LoadFile(e.rootUrl+a.uri,function(i){return n(new Uint8Array(i))},o,void 0,!0,function(i){i&&s(i.status+" "+i.statusText)})},t.LoadTextureBufferAsync=function(e,r,n,s){var o=e.textures[r];if(!o||!o.source){s("");return}if(o.babylonTexture){n(null);return}var a=e.images[o.source];N.IsBase64(a.uri)?setTimeout(function(){return n(new Uint8Array(N.DecodeBase64(a.uri)))}):N.LoadFile(e.rootUrl+a.uri,function(i){return n(new Uint8Array(i))},void 0,void 0,!0,function(i){i&&s(i.status+" "+i.statusText)})},t.CreateTextureAsync=function(e,r,n,s,o){var a=e.textures[r];if(a.babylonTexture){s(a.babylonTexture);return}var i=e.samplers[a.sampler],l=i.minFilter===ee.NEAREST_MIPMAP_NEAREST||i.minFilter===ee.NEAREST_MIPMAP_LINEAR||i.minFilter===ee.LINEAR_MIPMAP_NEAREST||i.minFilter===ee.LINEAR_MIPMAP_LINEAR,c=P.BILINEAR_SAMPLINGMODE,u=n==null?new Blob:new Blob([n]),f=URL.createObjectURL(u),d=function(){return URL.revokeObjectURL(f)},h=new P(f,e.scene,!l,!0,c,d,d);i.wrapS!==void 0&&(h.wrapU=J.GetWrapMode(i.wrapS)),i.wrapT!==void 0&&(h.wrapV=J.GetWrapMode(i.wrapT)),h.name=r,a.babylonTexture=h,s(h)},t.LoadShaderStringAsync=function(e,r,n,s){var o=e.shaders[r];if(N.IsBase64(o.uri)){var a=atob(o.uri.split(",")[1]);n&&n(a)}else N.LoadFile(e.rootUrl+o.uri,n,void 0,void 0,!1,function(i){i&&s&&s(i.status+" "+i.statusText)})},t.LoadMaterialAsync=function(e,r,n,s){var o=e.materials[r];if(!o.technique){s&&s("No technique found.");return}var a=e.techniques[o.technique];if(!a){e.scene._blockEntityCollection=!!e.assetContainer;var i=new we(r,e.scene);i._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,i.diffuseColor=new M(.5,.5,.5),i.sideOrientation=z.CounterClockWiseSideOrientation,n(i);return}var l=e.programs[a.program],c=a.states,u=le.ShadersStore[l.vertexShader+"VertexShader"],f=le.ShadersStore[l.fragmentShader+"PixelShader"],d="",h="",_=new wr(u),p=new wr(f),v={},y=[],b=[],A=[];for(var T in a.uniforms){var E=a.uniforms[T],m=a.parameters[E];if(v[T]=m,m.semantic&&!m.node&&!m.source){var R=Nr.indexOf(m.semantic);R!==-1?(y.push(xr[R]),delete v[T]):y.push(T)}else m.type===j.SAMPLER_2D?A.push(T):y.push(T)}for(var w in a.attributes){var x=a.attributes[w],C=a.parameters[x];if(C.semantic){var G=Mr(C);G&&b.push(G)}}for(;!_.isEnd()&&_.getNextToken();){var k=_.currentToken;if(k!==ae.IDENTIFIER){d+=_.currentString;continue}var fe=!1;for(var w in a.attributes){var x=a.attributes[w],C=a.parameters[x];if(_.currentIdentifier===w&&C.semantic){d+=Mr(C),fe=!0;break}}fe||(d+=Fr(_,a,v))}for(;!p.isEnd()&&p.getNextToken();){var k=p.currentToken;if(k!==ae.IDENTIFIER){h+=p.currentString;continue}h+=Fr(p,a,v)}var Z={vertex:l.vertexShader+r,fragment:l.fragmentShader+r},H={attributes:b,uniforms:y,samplers:A,needAlphaBlending:c&&c.enable&&c.enable.indexOf(3042)!==-1};le.ShadersStore[l.vertexShader+r+"VertexShader"]=d,le.ShadersStore[l.fragmentShader+r+"PixelShader"]=h;var B=new gr(r,e.scene,Z,H);if(B.onError=Bn(l,B,s),B.onCompiled=Dn(e,B,a,o,v,n),B.sideOrientation=z.CounterClockWiseSideOrientation,c&&c.functions){var ie=c.functions;ie.cullFace&&ie.cullFace[0]!==De.BACK&&(B.backFaceCulling=!1);var I=ie.blendFuncSeparate;I&&(I[0]===F.SRC_ALPHA&&I[1]===F.ONE_MINUS_SRC_ALPHA&&I[2]===F.ONE&&I[3]===F.ONE?B.alphaMode=ue.ALPHA_COMBINE:I[0]===F.ONE&&I[1]===F.ONE&&I[2]===F.ZERO&&I[3]===F.ONE?B.alphaMode=ue.ALPHA_ONEONE:I[0]===F.SRC_ALPHA&&I[1]===F.ONE&&I[2]===F.ZERO&&I[3]===F.ONE?B.alphaMode=ue.ALPHA_ADD:I[0]===F.ZERO&&I[1]===F.ONE_MINUS_SRC_COLOR&&I[2]===F.ONE&&I[3]===F.ONE?B.alphaMode=ue.ALPHA_SUBTRACT:I[0]===F.DST_COLOR&&I[1]===F.ZERO&&I[2]===F.ONE&&I[3]===F.ONE?B.alphaMode=ue.ALPHA_MULTIPLY:I[0]===F.SRC_ALPHA&&I[1]===F.ONE_MINUS_SRC_COLOR&&I[2]===F.ONE&&I[3]===F.ONE&&(B.alphaMode=ue.ALPHA_MAXIMIZED))}},t}(),me=function(){function t(){}return t.RegisterExtension=function(e){if(t.Extensions[e.name]){N.Error('Tool with the same name "'+e.name+'" already exists');return}t.Extensions[e.name]=e},t.prototype.dispose=function(){},t.prototype._importMeshAsync=function(e,r,n,s,o,a,i,l){var c=this;return r.useRightHandedSystem=!0,te.LoadRuntimeAsync(r,n,s,function(u){u.assetContainer=o,u.importOnlyMeshes=!0,e===""?u.importMeshesNames=[]:typeof e=="string"?u.importMeshesNames=[e]:e&&!(e instanceof Array)?u.importMeshesNames=[e]:(u.importMeshesNames=[],N.Warn("Argument meshesNames must be of type string or string[]")),c._createNodes(u);var f=new Array,d=new Array;for(var h in u.nodes){var _=u.nodes[h];_.babylonNode instanceof Xr&&f.push(_.babylonNode)}for(var p in u.skins){var v=u.skins[p];v.babylonSkeleton instanceof Le&&d.push(v.babylonSkeleton)}c._loadBuffersAsync(u,function(){c._loadShadersAsync(u,function(){Br(u),Rr(u),!se.IncrementalLoading&&a&&a(f,d)})},i),se.IncrementalLoading&&a&&a(f,d)},l),!0},t.prototype.importMeshAsync=function(e,r,n,s,o,a){var i=this;return new Promise(function(l,c){i._importMeshAsync(e,r,s,o,n,function(u,f){l({meshes:u,particleSystems:[],skeletons:f,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},a,function(u){c(new Error(u))})})},t.prototype._loadAsync=function(e,r,n,s,o,a){var i=this;e.useRightHandedSystem=!0,te.LoadRuntimeAsync(e,r,n,function(l){te.LoadRuntimeExtensionsAsync(l,function(){i._createNodes(l),i._loadBuffersAsync(l,function(){i._loadShadersAsync(l,function(){Br(l),Rr(l),se.IncrementalLoading||s()})}),se.IncrementalLoading&&s()},a)},a)},t.prototype.loadAsync=function(e,r,n,s){var o=this;return new Promise(function(a,i){o._loadAsync(e,r,n,function(){a()},s,function(l){i(new Error(l))})})},t.prototype._loadShadersAsync=function(e,r){var n=!1,s=function(i,l){te.LoadShaderStringAsync(e,i,function(c){c instanceof ArrayBuffer||(e.loadedShaderCount++,c&&(le.ShadersStore[i+(l.type===Be.VERTEX?"VertexShader":"PixelShader")]=c),e.loadedShaderCount===e.shaderscount&&r())},function(){N.Error("Error when loading shader program named "+i+" located at "+l.uri)})};for(var o in e.shaders){n=!0;var a=e.shaders[o];a?s.bind(this,o,a)():N.Error("No shader named: "+o)}n||r()},t.prototype._loadBuffersAsync=function(e,r,n){var s=!1,o=function(l,c){te.LoadBufferAsync(e,l,function(u){e.loadedBufferCount++,u&&(u.byteLength!=e.buffers[l].byteLength&&N.Error("Buffer named "+l+" is length "+u.byteLength+". Expected: "+c.byteLength),e.loadedBufferViews[l]=u),e.loadedBufferCount===e.buffersCount&&r()},function(){N.Error("Error when loading buffer named "+l+" located at "+c.uri)})};for(var a in e.buffers){s=!0;var i=e.buffers[a];i?o.bind(this,a,i)():N.Error("No buffer named: "+a)}s||r()},t.prototype._createNodes=function(e){var r=e.currentScene;if(r)for(var n=0;n<r.nodes.length;n++)ye(e,r.nodes[n],null);else for(var s in e.scenes){r=e.scenes[s];for(var n=0;n<r.nodes.length;n++)ye(e,r.nodes[n],null)}},t.Extensions={},t}(),te=function(){function t(e){this._name=e}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),t.prototype.loadRuntimeAsync=function(e,r,n,s,o){return!1},t.prototype.loadRuntimeExtensionsAsync=function(e,r,n){return!1},t.prototype.loadBufferAsync=function(e,r,n,s,o){return!1},t.prototype.loadTextureBufferAsync=function(e,r,n,s){return!1},t.prototype.createTextureAsync=function(e,r,n,s,o){return!1},t.prototype.loadShaderStringAsync=function(e,r,n,s){return!1},t.prototype.loadMaterialAsync=function(e,r,n,s){return!1},t.LoadRuntimeAsync=function(e,r,n,s,o){t.ApplyExtensions(function(a){return a.loadRuntimeAsync(e,r,n,s,o)},function(){setTimeout(function(){!s||s(ne.CreateRuntime(r.json,e,n))})})},t.LoadRuntimeExtensionsAsync=function(e,r,n){t.ApplyExtensions(function(s){return s.loadRuntimeExtensionsAsync(e,r,n)},function(){setTimeout(function(){r()})})},t.LoadBufferAsync=function(e,r,n,s,o){t.ApplyExtensions(function(a){return a.loadBufferAsync(e,r,n,s,o)},function(){ne.LoadBufferAsync(e,r,n,s,o)})},t.LoadTextureAsync=function(e,r,n,s){t.LoadTextureBufferAsync(e,r,function(o){o&&t.CreateTextureAsync(e,r,o,n,s)},s)},t.LoadShaderStringAsync=function(e,r,n,s){t.ApplyExtensions(function(o){return o.loadShaderStringAsync(e,r,n,s)},function(){ne.LoadShaderStringAsync(e,r,n,s)})},t.LoadMaterialAsync=function(e,r,n,s){t.ApplyExtensions(function(o){return o.loadMaterialAsync(e,r,n,s)},function(){ne.LoadMaterialAsync(e,r,n,s)})},t.LoadTextureBufferAsync=function(e,r,n,s){t.ApplyExtensions(function(o){return o.loadTextureBufferAsync(e,r,n,s)},function(){ne.LoadTextureBufferAsync(e,r,n,s)})},t.CreateTextureAsync=function(e,r,n,s,o){t.ApplyExtensions(function(a){return a.createTextureAsync(e,r,n,s,o)},function(){ne.CreateTextureAsync(e,r,n,s,o)})},t.ApplyExtensions=function(e,r){for(var n in me.Extensions){var s=me.Extensions[n];if(e(s))return}r()},t}();se._CreateGLTF1Loader=function(){return new me};var Gn="binary_glTF",Vn=function(t){Tr(e,t);function e(){return t.call(this,"KHR_binary_glTF")||this}return e.prototype.loadRuntimeAsync=function(r,n,s,o,a){var i=n.json.extensionsUsed;return!i||i.indexOf(this.name)===-1||!n.bin?!1:(this._bin=n.bin,o(ne.CreateRuntime(n.json,r,s)),!0)},e.prototype.loadBufferAsync=function(r,n,s,o){return r.extensionsUsed.indexOf(this.name)===-1||n!==Gn?!1:(this._bin.readAsync(0,this._bin.byteLength).then(s,function(a){return o(a.message)}),!0)},e.prototype.loadTextureBufferAsync=function(r,n,s,o){var a=r.textures[n],i=r.images[a.source];if(!i.extensions||!(this.name in i.extensions))return!1;var l=i.extensions[this.name],c=r.bufferViews[l.bufferView],u=J.GetBufferFromBufferView(r,c,0,c.byteLength,oe.UNSIGNED_BYTE);return s(u),!0},e.prototype.loadShaderStringAsync=function(r,n,s,o){var a=r.shaders[n];if(!a.extensions||!(this.name in a.extensions))return!1;var i=a.extensions[this.name],l=r.bufferViews[i.bufferView],c=J.GetBufferFromBufferView(r,l,0,l.byteLength,oe.UNSIGNED_BYTE);return setTimeout(function(){var u=J.DecodeBufferToText(c);s(u)}),!0},e}(te);me.RegisterExtension(new Vn);var Un=function(t){Tr(e,t);function e(){return t.call(this,"KHR_materials_common")||this}return e.prototype.loadRuntimeExtensionsAsync=function(r,n,s){if(!r.extensions)return!1;var o=r.extensions[this.name];if(!o)return!1;var a=o.lights;if(a)for(var i in a){var l=a[i];switch(l.type){case"ambient":var c=new Ne(l.name,new S(0,1,0),r.scene),u=l.ambient;u&&(c.diffuse=M.FromArray(u.color||[1,1,1]));break;case"point":var f=new xe(l.name,new S(10,10,10),r.scene),d=l.point;d&&(f.diffuse=M.FromArray(d.color||[1,1,1]));break;case"directional":var h=new ge(l.name,new S(0,-1,0),r.scene),_=l.directional;_&&(h.diffuse=M.FromArray(_.color||[1,1,1]));break;case"spot":var p=l.spot;if(p){var v=new Me(l.name,new S(0,10,0),new S(0,-1,0),p.fallOffAngle||Math.PI,p.fallOffExponent||0,r.scene);v.diffuse=M.FromArray(p.color||[1,1,1])}break;default:N.Warn('GLTF Material Common extension: light type "'+l.type+"\u201D not supported");break}}return!1},e.prototype.loadMaterialAsync=function(r,n,s,o){var a=r.materials[n];if(!a||!a.extensions)return!1;var i=a.extensions[this.name];if(!i)return!1;var l=new we(n,r.scene);return l.sideOrientation=z.CounterClockWiseSideOrientation,i.technique==="CONSTANT"&&(l.disableLighting=!0),l.backFaceCulling=i.doubleSided===void 0?!1:!i.doubleSided,l.alpha=i.values.transparency===void 0?1:i.values.transparency,l.specularPower=i.values.shininess===void 0?0:i.values.shininess,typeof i.values.ambient=="string"?this._loadTexture(r,i.values.ambient,l,"ambientTexture",o):l.ambientColor=M.FromArray(i.values.ambient||[0,0,0]),typeof i.values.diffuse=="string"?this._loadTexture(r,i.values.diffuse,l,"diffuseTexture",o):l.diffuseColor=M.FromArray(i.values.diffuse||[0,0,0]),typeof i.values.emission=="string"?this._loadTexture(r,i.values.emission,l,"emissiveTexture",o):l.emissiveColor=M.FromArray(i.values.emission||[0,0,0]),typeof i.values.specular=="string"?this._loadTexture(r,i.values.specular,l,"specularTexture",o):l.specularColor=M.FromArray(i.values.specular||[0,0,0]),!0},e.prototype._loadTexture=function(r,n,s,o,a){ne.LoadTextureBufferAsync(r,n,function(i){ne.CreateTextureAsync(r,n,i,function(l){return s[o]=l},a)},a)},e}(te);me.RegisterExtension(new Un);var g=function(){function t(){}return t.Get=function(e,r,n){if(!r||n==null||!r[n])throw new Error(e+": Failed to find index ("+n+")");return r[n]},t.Assign=function(e){if(e)for(var r=0;r<e.length;r++)e[r].index=r},t}(),O=function(){function t(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._disposed=!1,this._extensions=new Array,this._defaultBabylonMaterialData={},this._parent=e}return t.RegisterExtension=function(e,r){t.UnregisterExtension(e)&&$.Warn("Extension with the name '"+e+"' already exists"),t._RegisteredExtensions[e]={factory:r}},t.UnregisterExtension=function(e){return t._RegisteredExtensions[e]?(delete t._RegisteredExtensions[e],!0):!1},Object.defineProperty(t.prototype,"gltf",{get:function(){return this._gltf},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bin",{get:function(){return this._bin},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"babylonScene",{get:function(){return this._babylonScene},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){if(!this._disposed){this._disposed=!0,this._completePromises.length=0;for(var e in this._extensions){var r=this._extensions[e];r.dispose&&r.dispose(),delete this._extensions[e]}this._gltf=null,this._babylonScene=null,this._rootBabylonMesh=null,this._parent.dispose()}},t.prototype.importMeshAsync=function(e,r,n,s,o,a,i){var l=this;return i===void 0&&(i=""),Promise.resolve().then(function(){l._babylonScene=r,l._assetContainer=n,l._loadData(s);var c=null;if(e){var u={};if(l._gltf.nodes)for(var f=0,d=l._gltf.nodes;f<d.length;f++){var h=d[f];h.name&&(u[h.name]=h.index)}var _=e instanceof Array?e:[e];c=_.map(function(p){var v=u[p];if(v===void 0)throw new Error("Failed to find node '"+p+"'");return v})}return l._loadAsync(o,i,c,function(){return{meshes:l._getMeshes(),particleSystems:[],skeletons:l._getSkeletons(),animationGroups:l._getAnimationGroups(),lights:l._babylonLights,transformNodes:l._getTransformNodes(),geometries:l._getGeometries()}})})},t.prototype.loadAsync=function(e,r,n,s,o){var a=this;return o===void 0&&(o=""),Promise.resolve().then(function(){return a._babylonScene=e,a._loadData(r),a._loadAsync(n,o,null,function(){})})},t.prototype._loadAsync=function(e,r,n,s){var o=this;return Promise.resolve().then(function(){o._rootUrl=e,o._uniqueRootUrl=!re.StartsWith(e,"file:")&&r?e:""+e+Date.now()+"/",o._fileName=r,o._loadExtensions(),o._checkExtensions();var a=X[X.LOADING]+" => "+X[X.READY],i=X[X.LOADING]+" => "+X[X.COMPLETE];o._parent._startPerformanceCounter(a),o._parent._startPerformanceCounter(i),o._parent._setState(X.LOADING),o._extensionsOnLoading();var l=new Array,c=o._babylonScene.blockMaterialDirtyMechanism;if(o._babylonScene.blockMaterialDirtyMechanism=!0,n)l.push(o.loadSceneAsync("/nodes",{nodes:n,index:-1}));else if(o._gltf.scene!=null||o._gltf.scenes&&o._gltf.scenes[0]){var u=g.Get("/scene",o._gltf.scenes,o._gltf.scene||0);l.push(o.loadSceneAsync("/scenes/"+u.index,u))}if(o.parent.loadAllMaterials&&o._gltf.materials)for(var f=0;f<o._gltf.materials.length;++f){var d=o._gltf.materials[f],h="/materials/"+f,_=z.TriangleFillMode;l.push(o._loadMaterialAsync(h,d,null,_,function(v){}))}o._babylonScene.blockMaterialDirtyMechanism=c,o._parent.compileMaterials&&l.push(o._compileMaterialsAsync()),o._parent.compileShadowGenerators&&l.push(o._compileShadowGeneratorsAsync());var p=Promise.all(l).then(function(){return o._rootBabylonMesh&&o._rootBabylonMesh.setEnabled(!0),o._extensionsOnReady(),o._parent._setState(X.READY),o._startAnimations(),s()});return p.then(function(v){return o._parent._endPerformanceCounter(a),N.SetImmediate(function(){o._disposed||Promise.all(o._completePromises).then(function(){o._parent._endPerformanceCounter(i),o._parent._setState(X.COMPLETE),o._parent.onCompleteObservable.notifyObservers(void 0),o._parent.onCompleteObservable.clear(),o.dispose()},function(y){o._parent.onErrorObservable.notifyObservers(y),o._parent.onErrorObservable.clear(),o.dispose()})}),v})}).catch(function(a){throw o._disposed||(o._parent.onErrorObservable.notifyObservers(a),o._parent.onErrorObservable.clear(),o.dispose()),a})},t.prototype._loadData=function(e){if(this._gltf=e.json,this._setupData(),e.bin){var r=this._gltf.buffers;if(r&&r[0]&&!r[0].uri){var n=r[0];(n.byteLength<e.bin.byteLength-3||n.byteLength>e.bin.byteLength)&&$.Warn("Binary buffer length ("+n.byteLength+") from JSON does not match chunk length ("+e.bin.byteLength+")"),this._bin=e.bin}else $.Warn("Unexpected BIN chunk")}},t.prototype._setupData=function(){if(g.Assign(this._gltf.accessors),g.Assign(this._gltf.animations),g.Assign(this._gltf.buffers),g.Assign(this._gltf.bufferViews),g.Assign(this._gltf.cameras),g.Assign(this._gltf.images),g.Assign(this._gltf.materials),g.Assign(this._gltf.meshes),g.Assign(this._gltf.nodes),g.Assign(this._gltf.samplers),g.Assign(this._gltf.scenes),g.Assign(this._gltf.skins),g.Assign(this._gltf.textures),this._gltf.nodes){for(var e={},r=0,n=this._gltf.nodes;r<n.length;r++){var s=n[r];if(s.children)for(var o=0,a=s.children;o<a.length;o++){var i=a[o];e[i]=s.index}}for(var l=this._createRootNode(),c=0,u=this._gltf.nodes;c<u.length;c++){var s=u[c],f=e[s.index];s.parent=f===void 0?l:this._gltf.nodes[f]}}},t.prototype._loadExtensions=function(){for(var e in t._RegisteredExtensions){var r=t._RegisteredExtensions[e].factory(this);r.name!==e&&$.Warn("The name of the glTF loader extension instance does not match the registered name: "+r.name+" !== "+e),this._extensions.push(r),this._parent.onExtensionLoadedObservable.notifyObservers(r)}this._extensions.sort(function(n,s){return(n.order||Number.MAX_VALUE)-(s.order||Number.MAX_VALUE)}),this._parent.onExtensionLoadedObservable.clear()},t.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var e=function(a){var i=r._extensions.some(function(l){return l.name===a&&l.enabled});if(!i)throw new Error("Require extension "+a+" is not available")},r=this,n=0,s=this._gltf.extensionsRequired;n<s.length;n++){var o=s[n];e(o)}},t.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new ce("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case ve.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],t._LoadTransform(e,this._rootBabylonMesh));break}case ve.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error("Invalid coordinate system mode ("+this._parent.coordinateSystemMode+")")}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e},t.prototype.loadSceneAsync=function(e,r){var n=this,s=this._extensionsLoadSceneAsync(e,r);if(s)return s;var o=new Array;if(this.logOpen(e+" "+(r.name||"")),r.nodes)for(var a=0,i=r.nodes;a<i.length;a++){var l=i[a],c=g.Get(e+"/nodes/"+l,this._gltf.nodes,l);o.push(this.loadNodeAsync("/nodes/"+c.index,c,function(p){p.parent=n._rootBabylonMesh}))}if(this._gltf.nodes)for(var u=0,f=this._gltf.nodes;u<f.length;u++){var c=f[u];if(c._babylonTransformNode&&c._babylonBones)for(var d=0,h=c._babylonBones;d<h.length;d++){var _=h[d];_.linkTransformNode(c._babylonTransformNode)}}return o.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(o).then(function(){})},t.prototype._forEachPrimitive=function(e,r){if(e._primitiveBabylonMeshes)for(var n=0,s=e._primitiveBabylonMeshes;n<s.length;n++){var o=s[n];r(o)}},t.prototype._getGeometries=function(){var e=new Array,r=this._gltf.nodes;if(r)for(var n=0,s=r;n<s.length;n++){var o=s[n];this._forEachPrimitive(o,function(a){var i=a.geometry;i&&e.indexOf(i)===-1&&e.push(i)})}return e},t.prototype._getMeshes=function(){var e=new Array;e.push(this._rootBabylonMesh);var r=this._gltf.nodes;if(r)for(var n=0,s=r;n<s.length;n++){var o=s[n];this._forEachPrimitive(o,function(a){e.push(a)})}return e},t.prototype._getTransformNodes=function(){var e=new Array,r=this._gltf.nodes;if(r)for(var n=0,s=r;n<s.length;n++){var o=s[n];o._babylonTransformNode&&o._babylonTransformNode.getClassName()==="TransformNode"&&e.push(o._babylonTransformNode)}return e},t.prototype._getSkeletons=function(){var e=new Array,r=this._gltf.skins;if(r)for(var n=0,s=r;n<s.length;n++){var o=s[n];o._data&&e.push(o._data.babylonSkeleton)}return e},t.prototype._getAnimationGroups=function(){var e=new Array,r=this._gltf.animations;if(r)for(var n=0,s=r;n<s.length;n++){var o=s[n];o._babylonAnimationGroup&&e.push(o._babylonAnimationGroup)}return e},t.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case de.NONE:break;case de.FIRST:{var e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case de.ALL:{for(var e=this._getAnimationGroups(),r=0,n=e;r<n.length;r++){var s=n[r];s.start(!0)}break}default:{$.Error("Invalid animation start mode ("+this._parent.animationStartMode+")");return}}},t.prototype.loadNodeAsync=function(e,r,n){var s=this;n===void 0&&(n=function(){});var o=this._extensionsLoadNodeAsync(e,r,n);if(o)return o;if(r._babylonTransformNode)throw new Error(e+": Invalid recursive node hierarchy");var a=new Array;this.logOpen(e+" "+(r.name||""));var i=function(u){if(t.AddPointerMetadata(u,e),t._LoadTransform(r,u),r.camera!=null){var f=g.Get(e+"/camera",s._gltf.cameras,r.camera);a.push(s.loadCameraAsync("/cameras/"+f.index,f,function(v){v.parent=u}))}if(r.children)for(var d=0,h=r.children;d<h.length;d++){var _=h[d],p=g.Get(e+"/children/"+_,s._gltf.nodes,_);a.push(s.loadNodeAsync("/nodes/"+p.index,p,function(v){v.parent=u}))}n(u)};if(r.mesh==null){var l=r.name||"node"+r.index;this._babylonScene._blockEntityCollection=!!this._assetContainer,r._babylonTransformNode=new Or(l,this._babylonScene),r._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i(r._babylonTransformNode)}else{var c=g.Get(e+"/mesh",this._gltf.meshes,r.mesh);a.push(this._loadMeshAsync("/meshes/"+c.index,r,c,i))}return this.logClose(),Promise.all(a).then(function(){return s._forEachPrimitive(r,function(u){u.geometry&&u.geometry.useBoundingInfoFromGeometry?u._updateBoundingInfo():u.refreshBoundingInfo(!0)}),r._babylonTransformNode})},t.prototype._loadMeshAsync=function(e,r,n,s){var o=n.primitives;if(!o||!o.length)throw new Error(e+": Primitives are missing");o[0].index==null&&g.Assign(o);var a=new Array;this.logOpen(e+" "+(n.name||""));var i=r.name||"node"+r.index;if(o.length===1){var l=n.primitives[0];a.push(this._loadMeshPrimitiveAsync(e+"/primitives/"+l.index,i,r,n,l,function(d){r._babylonTransformNode=d,r._primitiveBabylonMeshes=[d]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,r._babylonTransformNode=new Or(i,this._babylonScene),r._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r._primitiveBabylonMeshes=[];for(var c=0,u=o;c<u.length;c++){var l=u[c];a.push(this._loadMeshPrimitiveAsync(e+"/primitives/"+l.index,i+"_primitive"+l.index,r,n,l,function(h){h.parent=r._babylonTransformNode,r._primitiveBabylonMeshes.push(h)}))}}if(r.skin!=null){var f=g.Get(e+"/skin",this._gltf.skins,r.skin);a.push(this._loadSkinAsync("/skins/"+f.index,r,f))}return s(r._babylonTransformNode),this.logClose(),Promise.all(a).then(function(){return r._babylonTransformNode})},t.prototype._loadMeshPrimitiveAsync=function(e,r,n,s,o,a){var i=this,l=this._extensionsLoadMeshPrimitiveAsync(e,r,n,s,o,a);if(l)return l;this.logOpen(""+e);var c=this._disableInstancedMesh===0&&this._parent.createInstances&&n.skin==null&&!s.primitives[0].targets,u,f;if(c&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,u=o._instanceData.babylonSourceMesh.createInstance(r),u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f=o._instanceData.promise;else{var d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;var h=new ce(r,this._babylonScene);h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?z.CounterClockWiseSideOrientation:z.ClockWiseSideOrientation,this._createMorphTargets(e,n,s,o,h),d.push(this._loadVertexDataAsync(e,o,h).then(function(y){return i._loadMorphTargetsAsync(e,o,h,y).then(function(){i._babylonScene._blockEntityCollection=!!i._assetContainer,y.applyToMesh(h),y._parentContainer=i._assetContainer,i._babylonScene._blockEntityCollection=!1})}));var _=t._GetDrawMode(e,o.mode);if(o.material==null){var p=this._defaultBabylonMaterialData[_];p||(p=this._createDefaultMaterial("__GLTFLoader._default",_),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[_]=p),h.material=p}else{var v=g.Get(e+"/material",this._gltf.materials,o.material);d.push(this._loadMaterialAsync("/materials/"+v.index,v,h,_,function(y){h.material=y}))}f=Promise.all(d),c&&(o._instanceData={babylonSourceMesh:h,promise:f}),u=h}return t.AddPointerMetadata(u,e),this._parent.onMeshLoadedObservable.notifyObservers(u),a(u),this.logClose(),f.then(function(){return u})},t.prototype._loadVertexDataAsync=function(e,r,n){var s=this,o=this._extensionsLoadVertexDataAsync(e,r,n);if(o)return o;var a=r.attributes;if(!a)throw new Error(e+": Attributes are missing");var i=new Array,l=new Ie(n.name,this._babylonScene);if(r.indices==null)n.isUnIndexed=!0;else{var c=g.Get(e+"/indices",this._gltf.accessors,r.indices);i.push(this._loadIndicesAccessorAsync("/accessors/"+c.index,c).then(function(f){l.setIndices(f)}))}var u=function(f,d,h){if(a[f]!=null){n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(d)===-1&&n._delayInfo.push(d);var _=g.Get(e+"/attributes/"+f,s._gltf.accessors,a[f]);i.push(s._loadVertexAccessorAsync("/accessors/"+_.index,_,d).then(function(p){if(p.getKind()===L.PositionKind&&!s.parent.alwaysComputeBoundingBox&&!n.skeleton){var v=_.min,y=_.max;if(v!==void 0&&y!==void 0){if(_.normalized&&_.componentType!==5126){var b=1;switch(_.componentType){case 5120:b=127;break;case 5121:b=255;break;case 5122:b=32767;break;case 5123:b=65535;break}for(var A=0;A<3;++A)v[A]=Math.max(v[A]/b,-1),y[A]=Math.max(y[A]/b,-1)}var T=Y.Vector3[0],E=Y.Vector3[1];T.copyFromFloats.apply(T,v),E.copyFromFloats.apply(E,y),l._boundingInfo=new tn(T,E),l.useBoundingInfoFromGeometry=!0}}l.setVerticesBuffer(p,_.count)})),d==L.MatricesIndicesExtraKind&&(n.numBoneInfluencers=8),h&&h(_)}};return u("POSITION",L.PositionKind),u("NORMAL",L.NormalKind),u("TANGENT",L.TangentKind),u("TEXCOORD_0",L.UVKind),u("TEXCOORD_1",L.UV2Kind),u("TEXCOORD_2",L.UV3Kind),u("TEXCOORD_3",L.UV4Kind),u("TEXCOORD_4",L.UV5Kind),u("TEXCOORD_5",L.UV6Kind),u("JOINTS_0",L.MatricesIndicesKind),u("WEIGHTS_0",L.MatricesWeightsKind),u("JOINTS_1",L.MatricesIndicesExtraKind),u("WEIGHTS_1",L.MatricesWeightsExtraKind),u("COLOR_0",L.ColorKind,function(f){f.type==="VEC4"&&(n.hasVertexAlpha=!0)}),Promise.all(i).then(function(){return l})},t.prototype._createMorphTargets=function(e,r,n,s,o){if(!!s.targets){if(r._numMorphTargets==null)r._numMorphTargets=s.targets.length;else if(s.targets.length!==r._numMorphTargets)throw new Error(e+": Primitives do not have the same number of targets");var a=n.extras?n.extras.targetNames:null;o.morphTargetManager=new Zr(o.getScene()),o.morphTargetManager.areUpdatesFrozen=!0;for(var i=0;i<s.targets.length;i++){var l=r.weights?r.weights[i]:n.weights?n.weights[i]:0,c=a?a[i]:"morphTarget"+i;o.morphTargetManager.addTarget(new $r(c,l,o.getScene()))}}},t.prototype._loadMorphTargetsAsync=function(e,r,n,s){if(!r.targets)return Promise.resolve();for(var o=new Array,a=n.morphTargetManager,i=0;i<a.numTargets;i++){var l=a.getTarget(i);o.push(this._loadMorphTargetVertexDataAsync(e+"/targets/"+i,s,r.targets[i],l))}return Promise.all(o).then(function(){a.areUpdatesFrozen=!1})},t.prototype._loadMorphTargetVertexDataAsync=function(e,r,n,s){var o=this,a=new Array,i=function(l,c,u){if(n[l]!=null){var f=r.getVertexBuffer(c);if(!!f){var d=g.Get(e+"/"+l,o._gltf.accessors,n[l]);a.push(o._loadFloatAccessorAsync("/accessors/"+d.index,d).then(function(h){u(f,h)}))}}};return i("POSITION",L.PositionKind,function(l,c){var u=new Float32Array(c.length);l.forEach(c.length,function(f,d){u[d]=c[d]+f}),s.setPositions(u)}),i("NORMAL",L.NormalKind,function(l,c){var u=new Float32Array(c.length);l.forEach(u.length,function(f,d){u[d]=c[d]+f}),s.setNormals(u)}),i("TANGENT",L.TangentKind,function(l,c){var u=new Float32Array(c.length/3*4),f=0;l.forEach(c.length/3*4,function(d,h){(h+1)%4!=0&&(u[f]=c[f]+d,f++)}),s.setTangents(u)}),Promise.all(a).then(function(){})},t._LoadTransform=function(e,r){if(e.skin==null){var n=S.Zero(),s=W.Identity(),o=S.One();if(e.matrix){var a=K.FromArray(e.matrix);a.decompose(o,s,n)}else e.translation&&(n=S.FromArray(e.translation)),e.rotation&&(s=W.FromArray(e.rotation)),e.scale&&(o=S.FromArray(e.scale));r.position=n,r.rotationQuaternion=s,r.scaling=o}},t.prototype._loadSkinAsync=function(e,r,n){var s=this,o=this._extensionsLoadSkinAsync(e,r,n);if(o)return o;var a=function(u){s._forEachPrimitive(r,function(f){f.skeleton=u})};if(n._data)return a(n._data.babylonSkeleton),n._data.promise;var i="skeleton"+n.index;this._babylonScene._blockEntityCollection=!!this._assetContainer;var l=new Le(n.name||i,i,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.overrideMesh=this._rootBabylonMesh,this._loadBones(e,n,l),a(l);var c=this._loadSkinInverseBindMatricesDataAsync(e,n).then(function(u){s._updateBoneMatrices(l,u)});return n._data={babylonSkeleton:l,promise:c},c},t.prototype._loadBones=function(e,r,n){for(var s={},o=0,a=r.joints;o<a.length;o++){var i=a[o],l=g.Get(e+"/joints/"+i,this._gltf.nodes,i);this._loadBone(l,r,n,s)}},t.prototype._loadBone=function(e,r,n,s){var o=s[e.index];if(o)return o;var a=null;e.parent&&e.parent._babylonTransformNode!==this._rootBabylonMesh&&(a=this._loadBone(e.parent,r,n,s));var i=r.joints.indexOf(e.index);return o=new _e(e.name||"joint"+e.index,n,a,this._getNodeMatrix(e),null,null,i),s[e.index]=o,e._babylonBones=e._babylonBones||[],e._babylonBones.push(o),o},t.prototype._loadSkinInverseBindMatricesDataAsync=function(e,r){if(r.inverseBindMatrices==null)return Promise.resolve(null);var n=g.Get(e+"/inverseBindMatrices",this._gltf.accessors,r.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/"+n.index,n)},t.prototype._updateBoneMatrices=function(e,r){for(var n=0,s=e.bones;n<s.length;n++){var o=s[n],a=K.Identity(),i=o._index;r&&i!==-1&&(K.FromArrayToRef(r,i*16,a),a.invertToRef(a));var l=o.getParent();l&&a.multiplyToRef(l.getInvertedAbsoluteTransform(),a),o.updateMatrix(a,!1,!1),o._updateDifferenceMatrix(void 0,!1)}},t.prototype._getNodeMatrix=function(e){return e.matrix?K.FromArray(e.matrix):K.Compose(e.scale?S.FromArray(e.scale):S.One(),e.rotation?W.FromArray(e.rotation):W.Identity(),e.translation?S.FromArray(e.translation):S.Zero())},t.prototype.loadCameraAsync=function(e,r,n){n===void 0&&(n=function(){});var s=this._extensionsLoadCameraAsync(e,r,n);if(s)return s;var o=new Array;this.logOpen(e+" "+(r.name||"")),this._babylonScene._blockEntityCollection=!!this._assetContainer;var a=new Pe(r.name||"camera"+r.index,S.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,a.rotation=new S(0,Math.PI,0),r.type){case"perspective":{var i=r.perspective;if(!i)throw new Error(e+": Camera perspective properties are missing");a.fov=i.yfov,a.minZ=i.znear,a.maxZ=i.zfar||0;break}case"orthographic":{if(!r.orthographic)throw new Error(e+": Camera orthographic properties are missing");a.mode=Er.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-r.orthographic.xmag,a.orthoRight=r.orthographic.xmag,a.orthoBottom=-r.orthographic.ymag,a.orthoTop=r.orthographic.ymag,a.minZ=r.orthographic.znear,a.maxZ=r.orthographic.zfar;break}default:throw new Error(e+": Invalid camera type ("+r.type+")")}return t.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),n(a),this.logClose(),Promise.all(o).then(function(){return a})},t.prototype._loadAnimationsAsync=function(){var e=this._gltf.animations;if(!e)return Promise.resolve();for(var r=new Array,n=0;n<e.length;n++){var s=e[n];r.push(this.loadAnimationAsync("/animations/"+s.index,s).then(function(o){o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(r).then(function(){})},t.prototype.loadAnimationAsync=function(e,r){var n=this._extensionsLoadAnimationAsync(e,r);if(n)return n;this._babylonScene._blockEntityCollection=!!this._assetContainer;var s=new Qr(r.name||"animation"+r.index,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r._babylonAnimationGroup=s;var o=new Array;g.Assign(r.channels),g.Assign(r.samplers);for(var a=0,i=r.channels;a<i.length;a++){var l=i[a];o.push(this._loadAnimationChannelAsync(e+"/channels/"+l.index,e,r,l,s))}return Promise.all(o).then(function(){return s.normalize(0),s})},t.prototype._loadAnimationChannelAsync=function(e,r,n,s,o,a){var i=this;if(a===void 0&&(a=null),s.target.node==null)return Promise.resolve();var l=g.Get(e+"/target/node",this._gltf.nodes,s.target.node);if(s.target.path==="weights"&&!l._numMorphTargets||s.target.path!=="weights"&&!l._babylonTransformNode)return Promise.resolve();var c=g.Get(e+"/sampler",n.samplers,s.sampler);return this._loadAnimationSamplerAsync(r+"/samplers/"+s.sampler,c).then(function(u){var f,d;switch(s.target.path){case"translation":{f="position",d=Q.ANIMATIONTYPE_VECTOR3;break}case"rotation":{f="rotationQuaternion",d=Q.ANIMATIONTYPE_QUATERNION;break}case"scale":{f="scaling",d=Q.ANIMATIONTYPE_VECTOR3;break}case"weights":{f="influence",d=Q.ANIMATIONTYPE_FLOAT;break}default:throw new Error(e+"/target/path: Invalid value ("+s.target.path+")")}var h=0,_;switch(f){case"position":{_=function(){var m=S.FromArray(u.output,h);return h+=3,m};break}case"rotationQuaternion":{_=function(){var m=W.FromArray(u.output,h);return h+=4,m};break}case"scaling":{_=function(){var m=S.FromArray(u.output,h);return h+=3,m};break}case"influence":{_=function(){for(var m=new Array(l._numMorphTargets),R=0;R<l._numMorphTargets;R++)m[R]=u.output[h++];return m};break}}var p;switch(u.interpolation){case"STEP":{p=function(m){return{frame:u.input[m],value:_(),interpolation:sn.STEP}};break}case"LINEAR":{p=function(m){return{frame:u.input[m],value:_()}};break}case"CUBICSPLINE":{p=function(m){return{frame:u.input[m],inTangent:_(),value:_(),outTangent:_()}};break}}for(var v=new Array(u.input.length),y=0;y<u.input.length;y++)v[y]=p(y);if(f==="influence")for(var b=function(m){var R=o.name+"_channel"+o.targetedAnimations.length,w=new Q(R,f,1,d);w.setKeys(v.map(function(x){return{frame:x.frame,inTangent:x.inTangent?x.inTangent[m]:void 0,value:x.value[m],outTangent:x.outTangent?x.outTangent[m]:void 0}})),i._forEachPrimitive(l,function(x){var C=x,G=C.morphTargetManager.getTarget(m),k=w.clone();G.animations.push(k),o.addTargetedAnimation(k,G)})},A=0;A<l._numMorphTargets;A++)b(A);else{var T=o.name+"_channel"+o.targetedAnimations.length,E=new Q(T,f,1,d);E.setKeys(v),a!=null&&a.animations!=null?(a.animations.push(E),o.addTargetedAnimation(E,a)):(l._babylonTransformNode.animations.push(E),o.addTargetedAnimation(E,l._babylonTransformNode))}})},t.prototype._loadAnimationSamplerAsync=function(e,r){if(r._data)return r._data;var n=r.interpolation||"LINEAR";switch(n){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(e+"/interpolation: Invalid value ("+r.interpolation+")")}var s=g.Get(e+"/input",this._gltf.accessors,r.input),o=g.Get(e+"/output",this._gltf.accessors,r.output);return r._data=Promise.all([this._loadFloatAccessorAsync("/accessors/"+s.index,s),this._loadFloatAccessorAsync("/accessors/"+o.index,o)]).then(function(a){var i=a[0],l=a[1];return{input:i,interpolation:n,output:l}}),r._data},t.prototype.loadBufferAsync=function(e,r,n,s){var o=this._extensionsLoadBufferAsync(e,r,n,s);if(o)return o;if(!r._data)if(r.uri)r._data=this.loadUriAsync(e+"/uri",r,r.uri);else{if(!this._bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");r._data=this._bin.readAsync(0,r.byteLength)}return r._data.then(function(a){try{return new Uint8Array(a.buffer,a.byteOffset+n,s)}catch(i){throw new Error(e+": "+i.message)}})},t.prototype.loadBufferViewAsync=function(e,r){var n=this._extensionsLoadBufferViewAsync(e,r);if(n)return n;if(r._data)return r._data;var s=g.Get(e+"/buffer",this._gltf.buffers,r.buffer);return r._data=this.loadBufferAsync("/buffers/"+s.index,s,r.byteOffset||0,r.byteLength),r._data},t.prototype._loadAccessorAsync=function(e,r,n){var s=this;if(r._data)return r._data;var o=t._GetNumComponents(e,r.type),a=o*L.GetTypeByteLength(r.componentType),i=o*r.count;if(r.bufferView==null)r._data=Promise.resolve(new n(i));else{var l=g.Get(e+"/bufferView",this._gltf.bufferViews,r.bufferView);r._data=this.loadBufferViewAsync("/bufferViews/"+l.index,l).then(function(u){if(r.componentType===5126&&!r.normalized&&(!l.byteStride||l.byteStride===a))return t._GetTypedArray(e,r.componentType,u,r.byteOffset,i);var f=new n(i);return L.ForEach(u,r.byteOffset||0,l.byteStride||a,o,r.componentType,f.length,r.normalized||!1,function(d,h){f[h]=d}),f})}if(r.sparse){var c=r.sparse;r._data=r._data.then(function(u){var f=u,d=g.Get(e+"/sparse/indices/bufferView",s._gltf.bufferViews,c.indices.bufferView),h=g.Get(e+"/sparse/values/bufferView",s._gltf.bufferViews,c.values.bufferView);return Promise.all([s.loadBufferViewAsync("/bufferViews/"+d.index,d),s.loadBufferViewAsync("/bufferViews/"+h.index,h)]).then(function(_){var p=_[0],v=_[1],y=t._GetTypedArray(e+"/sparse/indices",c.indices.componentType,p,c.indices.byteOffset,c.count),b=o*c.count,A;if(r.componentType===5126&&!r.normalized)A=t._GetTypedArray(e+"/sparse/values",r.componentType,v,c.values.byteOffset,b);else{var T=t._GetTypedArray(e+"/sparse/values",r.componentType,v,c.values.byteOffset,b);A=new n(b),L.ForEach(T,0,a,o,r.componentType,A.length,r.normalized||!1,function(x,C){A[C]=x})}for(var E=0,m=0;m<y.length;m++)for(var R=y[m]*o,w=0;w<o;w++)f[R++]=A[E++];return f})})}return r._data},t.prototype._loadFloatAccessorAsync=function(e,r){return this._loadAccessorAsync(e,r,Float32Array)},t.prototype._loadIndicesAccessorAsync=function(e,r){if(r.type!=="SCALAR")throw new Error(e+"/type: Invalid value "+r.type);if(r.componentType!==5121&&r.componentType!==5123&&r.componentType!==5125)throw new Error(e+"/componentType: Invalid value "+r.componentType);if(r._data)return r._data;if(r.sparse){var n=t._GetTypedArrayConstructor(e+"/componentType",r.componentType);r._data=this._loadAccessorAsync(e,r,n)}else{var s=g.Get(e+"/bufferView",this._gltf.bufferViews,r.bufferView);r._data=this.loadBufferViewAsync("/bufferViews/"+s.index,s).then(function(o){return t._GetTypedArray(e,r.componentType,o,r.byteOffset,r.count)})}return r._data},t.prototype._loadVertexBufferViewAsync=function(e,r){var n=this;return e._babylonBuffer||(e._babylonBuffer=this.loadBufferViewAsync("/bufferViews/"+e.index,e).then(function(s){return new en(n._babylonScene.getEngine(),s,!1)})),e._babylonBuffer},t.prototype._loadVertexAccessorAsync=function(e,r,n){var s=this,o;if((o=r._babylonVertexBuffer)===null||o===void 0?void 0:o[n])return r._babylonVertexBuffer[n];if(r._babylonVertexBuffer||(r._babylonVertexBuffer={}),r.sparse)r._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,r).then(function(i){return new L(s._babylonScene.getEngine(),i,n,!1)});else if(n===L.MatricesIndicesKind||n===L.MatricesIndicesExtraKind)r._babylonVertexBuffer[n]=this._loadFloatAccessorAsync(e,r).then(function(i){return new L(s._babylonScene.getEngine(),i,n,!1)});else{var a=g.Get(e+"/bufferView",this._gltf.bufferViews,r.bufferView);r._babylonVertexBuffer[n]=this._loadVertexBufferViewAsync(a,n).then(function(i){var l=t._GetNumComponents(e,r.type);return new L(s._babylonScene.getEngine(),i,n,!1,!1,a.byteStride,!1,r.byteOffset,l,r.componentType,r.normalized,!0,1,!0)})}return r._babylonVertexBuffer[n]},t.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=new Array;return r&&(r.baseColorFactor?(n.albedoColor=M.FromArray(r.baseColorFactor),n.alpha=r.baseColorFactor[3]):n.albedoColor=M.White(),n.metallic=r.metallicFactor==null?1:r.metallicFactor,n.roughness=r.roughnessFactor==null?1:r.roughnessFactor,r.baseColorTexture&&s.push(this.loadTextureInfoAsync(e+"/baseColorTexture",r.baseColorTexture,function(o){o.name=n.name+" (Base Color)",n.albedoTexture=o})),r.metallicRoughnessTexture&&(r.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(e+"/metallicRoughnessTexture",r.metallicRoughnessTexture,function(o){o.name=n.name+" (Metallic Roughness)",n.metallicTexture=o})),n.useMetallnessFromMetallicTextureBlue=!0,n.useRoughnessFromMetallicTextureGreen=!0,n.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(s).then(function(){})},t.prototype._loadMaterialAsync=function(e,r,n,s,o){o===void 0&&(o=function(){});var a=this._extensionsLoadMaterialAsync(e,r,n,s,o);if(a)return a;r._data=r._data||{};var i=r._data[s];if(!i){this.logOpen(e+" "+(r.name||""));var l=this.createMaterial(e,r,s);i={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,r,l)},r._data[s]=i,t.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return n&&(i.babylonMeshes.push(n),n.onDisposeObservable.addOnce(function(){var c=i.babylonMeshes.indexOf(n);c!==-1&&i.babylonMeshes.splice(c,1)})),o(i.babylonMaterial),i.promise.then(function(){return i.babylonMaterial})},t.prototype._createDefaultMaterial=function(e,r){this._babylonScene._blockEntityCollection=!!this._assetContainer;var n=new D(e,this._babylonScene);return n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.fillMode=r,n.enableSpecularAntiAliasing=!0,n.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,n.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,n.transparencyMode=D.PBRMATERIAL_OPAQUE,n.metallic=1,n.roughness=1,n},t.prototype.createMaterial=function(e,r,n){var s=this._extensionsCreateMaterial(e,r,n);if(s)return s;var o=r.name||"material"+r.index,a=this._createDefaultMaterial(o,n);return a},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this._extensionsLoadMaterialPropertiesAsync(e,r,n);if(s)return s;var o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(e,r,n)),r.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(e+"/pbrMetallicRoughness",r.pbrMetallicRoughness,n)),this.loadMaterialAlphaProperties(e,r,n),Promise.all(o).then(function(){})},t.prototype.loadMaterialBasePropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=new Array;return n.emissiveColor=r.emissiveFactor?M.FromArray(r.emissiveFactor):new M(0,0,0),r.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),r.normalTexture&&(r.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(e+"/normalTexture",r.normalTexture,function(o){o.name=n.name+" (Normal)",n.bumpTexture=o})),n.invertNormalMapX=!this._babylonScene.useRightHandedSystem,n.invertNormalMapY=this._babylonScene.useRightHandedSystem,r.normalTexture.scale!=null&&(n.bumpTexture.level=r.normalTexture.scale),n.forceIrradianceInFragment=!0),r.occlusionTexture&&(r.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(e+"/occlusionTexture",r.occlusionTexture,function(o){o.name=n.name+" (Occlusion)",n.ambientTexture=o})),n.useAmbientInGrayScale=!0,r.occlusionTexture.strength!=null&&(n.ambientTextureStrength=r.occlusionTexture.strength)),r.emissiveTexture&&s.push(this.loadTextureInfoAsync(e+"/emissiveTexture",r.emissiveTexture,function(o){o.name=n.name+" (Emissive)",n.emissiveTexture=o})),Promise.all(s).then(function(){})},t.prototype.loadMaterialAlphaProperties=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=r.alphaMode||"OPAQUE";switch(s){case"OPAQUE":{n.transparencyMode=D.PBRMATERIAL_OPAQUE;break}case"MASK":{n.transparencyMode=D.PBRMATERIAL_ALPHATEST,n.alphaCutOff=r.alphaCutoff==null?.5:r.alphaCutoff,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0);break}case"BLEND":{n.transparencyMode=D.PBRMATERIAL_ALPHABLEND,n.albedoTexture&&(n.albedoTexture.hasAlpha=!0,n.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(e+"/alphaMode: Invalid value ("+r.alphaMode+")")}},t.prototype.loadTextureInfoAsync=function(e,r,n){var s=this;n===void 0&&(n=function(){});var o=this._extensionsLoadTextureInfoAsync(e,r,n);if(o)return o;if(this.logOpen(""+e),r.texCoord>=6)throw new Error(e+"/texCoord: Invalid value ("+r.texCoord+")");var a=g.Get(e+"/index",this._gltf.textures,r.index);a._textureInfo=r;var i=this._loadTextureAsync("/textures/"+r.index,a,function(l){l.coordinatesIndex=r.texCoord||0,t.AddPointerMetadata(l,e),s._parent.onTextureLoadedObservable.notifyObservers(l),n(l)});return this.logClose(),i},t.prototype._loadTextureAsync=function(e,r,n){n===void 0&&(n=function(){});var s=this._extensionsLoadTextureAsync(e,r,n);if(s)return s;this.logOpen(e+" "+(r.name||""));var o=r.sampler==null?t.DefaultSampler:g.Get(e+"/sampler",this._gltf.samplers,r.sampler),a=g.Get(e+"/source",this._gltf.images,r.source),i=this._createTextureAsync(e,o,a,n,void 0,!r._textureInfo.nonColorData);return this.logClose(),i},t.prototype._createTextureAsync=function(e,r,n,s,o,a){var i=this;s===void 0&&(s=function(){});var l=this._loadSampler("/samplers/"+r.index,r),c=new Array,u=new pe;this._babylonScene._blockEntityCollection=!!this._assetContainer;var f={noMipmap:l.noMipMaps,invertY:!1,samplingMode:l.samplingMode,onLoad:function(){i._disposed||u.resolve()},onError:function(h,_){i._disposed||u.reject(new Error(e+": "+(_&&_.message?_.message:h||"Failed to load texture")))},mimeType:n.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},d=new P(null,this._babylonScene,f);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c.push(u.promise),c.push(this.loadImageAsync("/images/"+n.index,n).then(function(h){var _=n.uri||i._fileName+"#image"+n.index,p="data:"+i._uniqueRootUrl+_;d.updateURL(p,h)})),d.wrapU=l.wrapU,d.wrapV=l.wrapV,s(d),Promise.all(c).then(function(){return d})},t.prototype._loadSampler=function(e,r){return r._data||(r._data={noMipMaps:r.minFilter===9728||r.minFilter===9729,samplingMode:t._GetTextureSamplingMode(e,r),wrapU:t._GetTextureWrapMode(e+"/wrapS",r.wrapS),wrapV:t._GetTextureWrapMode(e+"/wrapT",r.wrapT)}),r._data},t.prototype.loadImageAsync=function(e,r){if(!r._data){if(this.logOpen(e+" "+(r.name||"")),r.uri)r._data=this.loadUriAsync(e+"/uri",r,r.uri);else{var n=g.Get(e+"/bufferView",this._gltf.bufferViews,r.bufferView);r._data=this.loadBufferViewAsync("/bufferViews/"+n.index,n)}this.logClose()}return r._data},t.prototype.loadUriAsync=function(e,r,n){var s=this,o=this._extensionsLoadUriAsync(e,r,n);if(o)return o;if(!t._ValidateUri(n))throw new Error(e+": '"+n+"' is invalid");if(rn(n)){var a=new Uint8Array(mr(n));return this.log(e+": Decoded "+n.substr(0,64)+"... ("+a.length+" bytes)"),Promise.resolve(a)}return this.log(e+": Loading "+n),this._parent.preprocessUrlAsync(this._rootUrl+n).then(function(i){return new Promise(function(l,c){s._parent._loadFile(s._babylonScene,i,function(u){s._disposed||(s.log(e+": Loaded "+n+" ("+u.byteLength+" bytes)"),l(new Uint8Array(u)))},!0,function(u){c(new nn(e+": Failed to load '"+n+"'"+(u?": "+u.status+" "+u.statusText:""),u))})})})},t.AddPointerMetadata=function(e,r){var n=e.metadata=e.metadata||{},s=n.gltf=n.gltf||{},o=s.pointers=s.pointers||[];o.push(r)},t._GetTextureWrapMode=function(e,r){switch(r=r==null?10497:r,r){case 33071:return P.CLAMP_ADDRESSMODE;case 33648:return P.MIRROR_ADDRESSMODE;case 10497:return P.WRAP_ADDRESSMODE;default:return $.Warn(e+": Invalid value ("+r+")"),P.WRAP_ADDRESSMODE}},t._GetTextureSamplingMode=function(e,r){var n=r.magFilter==null?9729:r.magFilter,s=r.minFilter==null?9987:r.minFilter;if(n===9729)switch(s){case 9728:return P.LINEAR_NEAREST;case 9729:return P.LINEAR_LINEAR;case 9984:return P.LINEAR_NEAREST_MIPNEAREST;case 9985:return P.LINEAR_LINEAR_MIPNEAREST;case 9986:return P.LINEAR_NEAREST_MIPLINEAR;case 9987:return P.LINEAR_LINEAR_MIPLINEAR;default:return $.Warn(e+"/minFilter: Invalid value ("+s+")"),P.LINEAR_LINEAR_MIPLINEAR}else switch(n!==9728&&$.Warn(e+"/magFilter: Invalid value ("+n+")"),s){case 9728:return P.NEAREST_NEAREST;case 9729:return P.NEAREST_LINEAR;case 9984:return P.NEAREST_NEAREST_MIPNEAREST;case 9985:return P.NEAREST_LINEAR_MIPNEAREST;case 9986:return P.NEAREST_NEAREST_MIPLINEAR;case 9987:return P.NEAREST_LINEAR_MIPLINEAR;default:return $.Warn(e+"/minFilter: Invalid value ("+s+")"),P.NEAREST_NEAREST_MIPNEAREST}},t._GetTypedArrayConstructor=function(e,r){switch(r){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(e+": Invalid component type "+r)}},t._GetTypedArray=function(e,r,n,s,o){var a=n.buffer;s=n.byteOffset+(s||0);var i=t._GetTypedArrayConstructor(e+"/componentType",r),l=L.GetTypeByteLength(r);return s%l!=0?($.Warn(e+": Copying buffer as byte offset ("+s+") is not a multiple of component type byte length ("+l+")"),new i(a.slice(s,s+o*l),0)):new i(a,s,o)},t._GetNumComponents=function(e,r){switch(r){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(e+": Invalid type ("+r+")")},t._ValidateUri=function(e){return N.IsBase64(e)||e.indexOf("..")===-1},t._GetDrawMode=function(e,r){switch(r==null&&(r=4),r){case 0:return z.PointListDrawMode;case 1:return z.LineListDrawMode;case 2:return z.LineLoopDrawMode;case 3:return z.LineStripDrawMode;case 4:return z.TriangleFillMode;case 5:return z.TriangleStripDrawMode;case 6:return z.TriangleFanDrawMode}throw new Error(e+": Invalid mesh primitive mode ("+r+")")},t.prototype._compileMaterialsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile materials");var r=new Array;if(this._gltf.materials)for(var n=0,s=this._gltf.materials;n<s.length;n++){var o=s[n];if(o._data)for(var a in o._data)for(var i=o._data[a],l=0,c=i.babylonMeshes;l<c.length;l++){var u=c[l];u.computeWorldMatrix(!0);var f=i.babylonMaterial;r.push(f.forceCompilationAsync(u)),r.push(f.forceCompilationAsync(u,{useInstances:!0})),this._parent.useClipPlane&&(r.push(f.forceCompilationAsync(u,{clipPlane:!0})),r.push(f.forceCompilationAsync(u,{clipPlane:!0,useInstances:!0})))}}return Promise.all(r).then(function(){e._parent._endPerformanceCounter("Compile materials")})},t.prototype._compileShadowGeneratorsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var r=new Array,n=this._babylonScene.lights,s=0,o=n;s<o.length;s++){var a=o[s],i=a.getShadowGenerator();i&&r.push(i.forceCompilationAsync())}return Promise.all(r).then(function(){e._parent._endPerformanceCounter("Compile shadow generators")})},t.prototype._forEachExtensions=function(e){for(var r=0,n=this._extensions;r<n.length;r++){var s=n[r];s.enabled&&e(s)}},t.prototype._applyExtensions=function(e,r,n){for(var s=0,o=this._extensions;s<o.length;s++){var a=o[s];if(a.enabled){var i=a.name+"."+r,l=e;l._activeLoaderExtensionFunctions=l._activeLoaderExtensionFunctions||{};var c=l._activeLoaderExtensionFunctions;if(!c[i]){c[i]=!0;try{var u=n(a);if(u)return u}finally{delete c[i]}}}}return null},t.prototype._extensionsOnLoading=function(){this._forEachExtensions(function(e){return e.onLoading&&e.onLoading()})},t.prototype._extensionsOnReady=function(){this._forEachExtensions(function(e){return e.onReady&&e.onReady()})},t.prototype._extensionsLoadSceneAsync=function(e,r){return this._applyExtensions(r,"loadScene",function(n){return n.loadSceneAsync&&n.loadSceneAsync(e,r)})},t.prototype._extensionsLoadNodeAsync=function(e,r,n){return this._applyExtensions(r,"loadNode",function(s){return s.loadNodeAsync&&s.loadNodeAsync(e,r,n)})},t.prototype._extensionsLoadCameraAsync=function(e,r,n){return this._applyExtensions(r,"loadCamera",function(s){return s.loadCameraAsync&&s.loadCameraAsync(e,r,n)})},t.prototype._extensionsLoadVertexDataAsync=function(e,r,n){return this._applyExtensions(r,"loadVertexData",function(s){return s._loadVertexDataAsync&&s._loadVertexDataAsync(e,r,n)})},t.prototype._extensionsLoadMeshPrimitiveAsync=function(e,r,n,s,o,a){return this._applyExtensions(o,"loadMeshPrimitive",function(i){return i._loadMeshPrimitiveAsync&&i._loadMeshPrimitiveAsync(e,r,n,s,o,a)})},t.prototype._extensionsLoadMaterialAsync=function(e,r,n,s,o){return this._applyExtensions(r,"loadMaterial",function(a){return a._loadMaterialAsync&&a._loadMaterialAsync(e,r,n,s,o)})},t.prototype._extensionsCreateMaterial=function(e,r,n){return this._applyExtensions(r,"createMaterial",function(s){return s.createMaterial&&s.createMaterial(e,r,n)})},t.prototype._extensionsLoadMaterialPropertiesAsync=function(e,r,n){return this._applyExtensions(r,"loadMaterialProperties",function(s){return s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(e,r,n)})},t.prototype._extensionsLoadTextureInfoAsync=function(e,r,n){return this._applyExtensions(r,"loadTextureInfo",function(s){return s.loadTextureInfoAsync&&s.loadTextureInfoAsync(e,r,n)})},t.prototype._extensionsLoadTextureAsync=function(e,r,n){return this._applyExtensions(r,"loadTexture",function(s){return s._loadTextureAsync&&s._loadTextureAsync(e,r,n)})},t.prototype._extensionsLoadAnimationAsync=function(e,r){return this._applyExtensions(r,"loadAnimation",function(n){return n.loadAnimationAsync&&n.loadAnimationAsync(e,r)})},t.prototype._extensionsLoadSkinAsync=function(e,r,n){return this._applyExtensions(n,"loadSkin",function(s){return s._loadSkinAsync&&s._loadSkinAsync(e,r,n)})},t.prototype._extensionsLoadUriAsync=function(e,r,n){return this._applyExtensions(r,"loadUri",function(s){return s._loadUriAsync&&s._loadUriAsync(e,r,n)})},t.prototype._extensionsLoadBufferViewAsync=function(e,r){return this._applyExtensions(r,"loadBufferView",function(n){return n.loadBufferViewAsync&&n.loadBufferViewAsync(e,r)})},t.prototype._extensionsLoadBufferAsync=function(e,r,n,s){return this._applyExtensions(r,"loadBuffer",function(o){return o.loadBufferAsync&&o.loadBufferAsync(e,r,n,s)})},t.LoadExtensionAsync=function(e,r,n,s){if(!r.extensions)return null;var o=r.extensions,a=o[n];return a?s(e+"/extensions/"+n,a):null},t.LoadExtraAsync=function(e,r,n,s){if(!r.extras)return null;var o=r.extras,a=o[n];return a?s(e+"/extras/"+n,a):null},t.prototype.isExtensionUsed=function(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1},t.prototype.logOpen=function(e){this._parent._logOpen(e)},t.prototype.logClose=function(){this._parent._logClose()},t.prototype.log=function(e){this._parent._log(e)},t.prototype.startPerformanceCounter=function(e){this._parent._startPerformanceCounter(e)},t.prototype.endPerformanceCounter=function(e){this._parent._endPerformanceCounter(e)},t._RegisteredExtensions={},t.DefaultSampler={index:-1},t}();se._CreateGLTF2Loader=function(t){return new O(t)};var ke="EXT_lights_image_based",kn=function(){function t(e){this.name=ke,this._loader=e,this.enabled=this._loader.isExtensionUsed(ke)}return t.prototype.dispose=function(){this._loader=null,delete this._lights},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var r=e[this.name];this._lights=r.lights}},t.prototype.loadSceneAsync=function(e,r){var n=this;return O.LoadExtensionAsync(e,r,this.name,function(s,o){var a=new Array;a.push(n._loader.loadSceneAsync(e,r)),n._loader.logOpen(""+s);var i=g.Get(s+"/light",n._lights,o.light);return a.push(n._loadLightAsync("/extensions/"+n.name+"/lights/"+o.light,i).then(function(l){n._loader.babylonScene.environmentTexture=l})),n._loader.logClose(),Promise.all(a).then(function(){})})},t.prototype._loadLightAsync=function(e,r){var n=this;if(!r._loaded){var s=new Array;this._loader.logOpen(""+e);for(var o=new Array(r.specularImages.length),a=function(c){var u=r.specularImages[c];o[c]=new Array(u.length);for(var f=function(h){var _=e+"/specularImages/"+c+"/"+h;i._loader.logOpen(""+_);var p=u[h],v=g.Get(_,i._loader.gltf.images,p);s.push(i._loader.loadImageAsync("/images/"+p,v).then(function(y){o[c][h]=y})),i._loader.logClose()},d=0;d<u.length;d++)f(d)},i=this,l=0;l<r.specularImages.length;l++)a(l);this._loader.logClose(),r._loaded=Promise.all(s).then(function(){var c=new on(n._loader.babylonScene,null,r.specularImageSize);if(c.name=r.name||"environment",r._babylonTexture=c,r.intensity!=null&&(c.level=r.intensity),r.rotation){var u=W.FromArray(r.rotation);n._loader.babylonScene.useRightHandedSystem||(u=W.Inverse(u)),K.FromQuaternionToRef(u,c.getReflectionTextureMatrix())}if(!r.irradianceCoefficients)throw new Error(e+": Irradiance coefficients are missing");var f=an.FromArray(r.irradianceCoefficients);f.scaleInPlace(r.intensity),f.convertIrradianceToLambertianRadiance();var d=ln.FromHarmonics(f),h=(o.length-1)/un.Log2(r.specularImageSize);return c.updateRGBDAsync(o,d,h)})}return r._loaded.then(function(){return r._babylonTexture})},t}();O.RegisterExtension(ke,function(t){return new kn(t)});var He="EXT_mesh_gpu_instancing",Hn=function(){function t(e){this.name=He,this._loader=e,this.enabled=this._loader.isExtensionUsed(He)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadNodeAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){s._loader._disableInstancedMesh++;var i=s._loader.loadNodeAsync("/nodes/"+r.index,r,n);if(s._loader._disableInstancedMesh--,!r._primitiveBabylonMeshes)return i;var l=new Array,c=0,u=function(f){if(a.attributes[f]==null){l.push(Promise.resolve(null));return}var d=g.Get(o+"/attributes/"+f,s._loader.gltf.accessors,a.attributes[f]);if(l.push(s._loader._loadFloatAccessorAsync("/accessors/"+d.bufferView,d)),c===0)c=d.count;else if(c!==d.count)throw new Error(o+"/attributes: Instance buffer accessors do not have the same count.")};return u("TRANSLATION"),u("ROTATION"),u("SCALE"),i.then(function(f){return Promise.all(l).then(function(d){var h=d[0],_=d[1],p=d[2],v=new Float32Array(c*16);Y.Vector3[0].copyFromFloats(0,0,0),Y.Quaternion[0].copyFromFloats(0,0,0,1),Y.Vector3[1].copyFromFloats(1,1,1);for(var y=0;y<c;++y)h&&S.FromArrayToRef(h,y*3,Y.Vector3[0]),_&&W.FromArrayToRef(_,y*4,Y.Quaternion[0]),p&&S.FromArrayToRef(p,y*3,Y.Vector3[1]),K.ComposeToRef(Y.Vector3[1],Y.Quaternion[0],Y.Vector3[0],Y.Matrix[0]),Y.Matrix[0].copyToArray(v,y*16);for(var b=0,A=r._primitiveBabylonMeshes;b<A.length;b++){var T=A[b];T.thinInstanceSetBuffer("matrix",v,16,!0)}return f})})})},t}();O.RegisterExtension(He,function(t){return new Hn(t)});var Ke="EXT_meshopt_compression",Kn=function(){function t(e){this.name=Ke,this.enabled=e.isExtensionUsed(Ke),this._loader=e}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadBufferViewAsync=function(e,r){var n=this;return O.LoadExtensionAsync(e,r,this.name,function(s,o){var a=r;if(a._meshOptData)return a._meshOptData;var i=g.Get(e+"/buffer",n._loader.gltf.buffers,o.buffer);return a._meshOptData=n._loader.loadBufferAsync("/buffers/"+i.index,i,o.byteOffset||0,o.byteLength).then(function(l){return cn.Default.decodeGltfBufferAsync(l,o.count,o.byteStride,o.mode,o.filter)}),a._meshOptData})},t}();O.RegisterExtension(Ke,function(t){return new Kn(t)});var We="EXT_texture_webp",Wn=function(){function t(e){this.name=We,this._loader=e,this.enabled=e.isExtensionUsed(We)}return t.prototype.dispose=function(){this._loader=null},t.prototype._loadTextureAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=r.sampler==null?O.DefaultSampler:g.Get(e+"/sampler",s._loader.gltf.samplers,r.sampler),l=g.Get(o+"/source",s._loader.gltf.images,a.source);return s._loader._createTextureAsync(e,i,l,function(c){n(c)},void 0,!r._textureInfo.nonColorData)})},t}();O.RegisterExtension(We,function(t){return new Wn(t)});var je="KHR_draco_mesh_compression",jn=function(){function t(e){this.name=je,this._loader=e,this.enabled=br.DecoderAvailable&&this._loader.isExtensionUsed(je)}return t.prototype.dispose=function(){delete this.dracoCompression,this._loader=null},t.prototype._loadVertexDataAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){if(r.mode!=null){if(r.mode!==5&&r.mode!==4)throw new Error(e+": Unsupported mode "+r.mode);if(r.mode===5)throw new Error(e+": Mode "+r.mode+" is not currently supported")}var i={},l=function(u,f){var d=a.attributes[u];d!=null&&(n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(f)===-1&&n._delayInfo.push(f),i[f]=d)};l("POSITION",L.PositionKind),l("NORMAL",L.NormalKind),l("TANGENT",L.TangentKind),l("TEXCOORD_0",L.UVKind),l("TEXCOORD_1",L.UV2Kind),l("TEXCOORD_2",L.UV3Kind),l("TEXCOORD_3",L.UV4Kind),l("TEXCOORD_4",L.UV5Kind),l("TEXCOORD_5",L.UV6Kind),l("JOINTS_0",L.MatricesIndicesKind),l("WEIGHTS_0",L.MatricesWeightsKind),l("COLOR_0",L.ColorKind);var c=g.Get(o,s._loader.gltf.bufferViews,a.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=s._loader.loadBufferViewAsync("/bufferViews/"+c.index,c).then(function(u){var f=s.dracoCompression||br.Default;return f.decodeMeshAsync(u,i).then(function(d){var h=new Ie(n.name,s._loader.babylonScene);return d.applyToGeometry(h),h}).catch(function(d){throw new Error(e+": "+d.message)})})),c._dracoBabylonGeometry})},t}();O.RegisterExtension(je,function(t){return new jn(t)});var qe="KHR_lights_punctual",qn=function(){function t(e){this.name=qe,this._loader=e,this.enabled=this._loader.isExtensionUsed(qe)}return t.prototype.dispose=function(){this._loader=null,delete this._lights},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var r=e[this.name];this._lights=r.lights}},t.prototype.loadNodeAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){return s._loader.loadNodeAsync(e,r,function(i){var l,c=g.Get(o,s._lights,a.light),u=c.name||i.name;switch(s._loader.babylonScene._blockEntityCollection=!!s._loader._assetContainer,c.type){case"directional":{l=new ge(u,S.Backward(),s._loader.babylonScene);break}case"point":{l=new xe(u,S.Zero(),s._loader.babylonScene);break}case"spot":{var f=new Me(u,S.Zero(),S.Backward(),0,1,s._loader.babylonScene);f.angle=(c.spot&&c.spot.outerConeAngle||Math.PI/4)*2,f.innerAngle=(c.spot&&c.spot.innerConeAngle||0)*2,l=f;break}default:throw s._loader.babylonScene._blockEntityCollection=!1,new Error(o+": Invalid light type ("+c.type+")")}l._parentContainer=s._loader._assetContainer,s._loader.babylonScene._blockEntityCollection=!1,l.falloffType=fn.FALLOFF_GLTF,l.diffuse=c.color?M.FromArray(c.color):M.White(),l.intensity=c.intensity==null?1:c.intensity,l.range=c.range==null?Number.MAX_VALUE:c.range,l.parent=i,s._loader._babylonLights.push(l),O.AddPointerMetadata(l,o),n(i)})})},t}();O.RegisterExtension(qe,function(t){return new qn(t)});var Xe="KHR_materials_pbrSpecularGlossiness",Xn=function(){function t(e){this.name=Xe,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xe)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialBasePropertiesAsync(e,r,n)),i.push(s._loadSpecularGlossinessPropertiesAsync(o,r,a,n)),s._loader.loadMaterialAlphaProperties(e,r,n),Promise.all(i).then(function(){})})},t.prototype._loadSpecularGlossinessPropertiesAsync=function(e,r,n,s){if(!(s instanceof D))throw new Error(e+": Material type not supported");var o=new Array;return s.metallic=null,s.roughness=null,n.diffuseFactor?(s.albedoColor=M.FromArray(n.diffuseFactor),s.alpha=n.diffuseFactor[3]):s.albedoColor=M.White(),s.reflectivityColor=n.specularFactor?M.FromArray(n.specularFactor):M.White(),s.microSurface=n.glossinessFactor==null?1:n.glossinessFactor,n.diffuseTexture&&o.push(this._loader.loadTextureInfoAsync(e+"/diffuseTexture",n.diffuseTexture,function(a){a.name=s.name+" (Diffuse)",s.albedoTexture=a})),n.specularGlossinessTexture&&(o.push(this._loader.loadTextureInfoAsync(e+"/specularGlossinessTexture",n.specularGlossinessTexture,function(a){a.name=s.name+" (Specular Glossiness)",s.reflectivityTexture=a})),s.reflectivityTexture.hasAlpha=!0,s.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(o).then(function(){})},t}();O.RegisterExtension(Xe,function(t){return new Xn(t)});var Je="KHR_materials_unlit",Jn=function(){function t(e){this.name=Je,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Je)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(){return s._loadUnlitPropertiesAsync(e,r,n)})},t.prototype._loadUnlitPropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=new Array;n.unlit=!0;var o=r.pbrMetallicRoughness;return o&&(o.baseColorFactor?(n.albedoColor=M.FromArray(o.baseColorFactor),n.alpha=o.baseColorFactor[3]):n.albedoColor=M.White(),o.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(e+"/baseColorTexture",o.baseColorTexture,function(a){a.name=n.name+" (Base Color)",n.albedoTexture=a}))),r.doubleSided&&(n.backFaceCulling=!1,n.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,r,n),Promise.all(s).then(function(){})},t}();O.RegisterExtension(Je,function(t){return new Jn(t)});var ze="KHR_materials_clearcoat",zn=function(){function t(e){this.name=ze,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ze)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadClearCoatPropertiesAsync(o,a,n)),Promise.all(i).then(function(){})})},t.prototype._loadClearCoatPropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=new Array;return n.clearCoat.isEnabled=!0,n.clearCoat.useRoughnessFromMainTexture=!1,n.clearCoat.remapF0OnInterfaceChange=!1,r.clearcoatFactor!=null?n.clearCoat.intensity=r.clearcoatFactor:n.clearCoat.intensity=0,r.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(e+"/clearcoatTexture",r.clearcoatTexture,function(o){o.name=n.name+" (ClearCoat Intensity)",n.clearCoat.texture=o})),r.clearcoatRoughnessFactor!=null?n.clearCoat.roughness=r.clearcoatRoughnessFactor:n.clearCoat.roughness=0,r.clearcoatRoughnessTexture&&(r.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(e+"/clearcoatRoughnessTexture",r.clearcoatRoughnessTexture,function(o){o.name=n.name+" (ClearCoat Roughness)",n.clearCoat.textureRoughness=o}))),r.clearcoatNormalTexture&&(r.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(e+"/clearcoatNormalTexture",r.clearcoatNormalTexture,function(o){o.name=n.name+" (ClearCoat Normal)",n.clearCoat.bumpTexture=o})),n.invertNormalMapX=!n.getScene().useRightHandedSystem,n.invertNormalMapY=n.getScene().useRightHandedSystem,r.clearcoatNormalTexture.scale!=null&&(n.clearCoat.bumpTexture.level=r.clearcoatNormalTexture.scale)),Promise.all(s).then(function(){})},t}();O.RegisterExtension(ze,function(t){return new zn(t)});var Ye="KHR_materials_sheen",Yn=function(){function t(e){this.name=Ye,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ye)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadSheenPropertiesAsync(o,a,n)),Promise.all(i).then(function(){})})},t.prototype._loadSheenPropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=new Array;return n.sheen.isEnabled=!0,n.sheen.intensity=1,r.sheenColorFactor!=null?n.sheen.color=M.FromArray(r.sheenColorFactor):n.sheen.color=M.Black(),r.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(e+"/sheenColorTexture",r.sheenColorTexture,function(o){o.name=n.name+" (Sheen Color)",n.sheen.texture=o})),r.sheenRoughnessFactor!==void 0?n.sheen.roughness=r.sheenRoughnessFactor:n.sheen.roughness=0,r.sheenRoughnessTexture&&(r.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(e+"/sheenRoughnessTexture",r.sheenRoughnessTexture,function(o){o.name=n.name+" (Sheen Roughness)",n.sheen.textureRoughness=o}))),n.sheen.albedoScaling=!0,n.sheen.useRoughnessFromMainTexture=!1,Promise.all(s).then(function(){})},t}();O.RegisterExtension(Ye,function(t){return new Yn(t)});var Ze="KHR_materials_specular",Zn=function(){function t(e){this.name=Ze,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ze)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadSpecularPropertiesAsync(o,a,n)),Promise.all(i).then(function(){})})},t.prototype._loadSpecularPropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");var s=new Array;return r.specularFactor!==void 0&&(n.metallicF0Factor=r.specularFactor),r.specularColorFactor!==void 0&&(n.metallicReflectanceColor=M.FromArray(r.specularColorFactor)),r.specularTexture&&(r.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(e+"/specularTexture",r.specularTexture,function(o){o.name=n.name+" (Specular F0 Strength)",n.metallicReflectanceTexture=o,n.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),r.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(e+"/specularColorTexture",r.specularColorTexture,function(o){o.name=n.name+" (Specular F0 Color)",n.reflectanceTexture=o})),Promise.all(s).then(function(){})},t}();O.RegisterExtension(Ze,function(t){return new Zn(t)});var $e="KHR_materials_ior",$n=function(){function t(e){this.name=$e,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed($e)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadIorPropertiesAsync(o,a,n)),Promise.all(i).then(function(){})})},t.prototype._loadIorPropertiesAsync=function(e,r,n){if(!(n instanceof D))throw new Error(e+": Material type not supported");return r.ior!==void 0?n.indexOfRefraction=r.ior:n.indexOfRefraction=t._DEFAULT_IOR,Promise.resolve()},t._DEFAULT_IOR=1.5,t}();O.RegisterExtension($e,function(t){return new $n(t)});var q="KHR_materials_variants",Qn=function(){function t(e){this.name=q,this._loader=e,this.enabled=this._loader.isExtensionUsed(q)}return t.prototype.dispose=function(){this._loader=null},t.GetAvailableVariants=function(e){var r=this._GetExtensionMetadata(e);return r?Object.keys(r.variants):[]},t.prototype.getAvailableVariants=function(e){return t.GetAvailableVariants(e)},t.SelectVariant=function(e,r){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot select variant on a glTF mesh that does not have the "+q+" extension");var s=function(l){var c=n.variants[l];if(c)for(var u=0,f=c;u<f.length;u++){var d=f[u];d.mesh.material=d.material}};if(r instanceof Array)for(var o=0,a=r;o<a.length;o++){var i=a[o];s(i)}else s(r);n.lastSelected=r},t.prototype.selectVariant=function(e,r){return t.SelectVariant(e,r)},t.Reset=function(e){var r=this._GetExtensionMetadata(e);if(!r)throw new Error("Cannot reset on a glTF mesh that does not have the "+q+" extension");for(var n=0,s=r.original;n<s.length;n++){var o=s[n];o.mesh.material=o.material}r.lastSelected=null},t.prototype.reset=function(e){return t.Reset(e)},t.GetLastSelectedVariant=function(e){var r=this._GetExtensionMetadata(e);if(!r)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the "+q+" extension");return r.lastSelected},t.prototype.getLastSelectedVariant=function(e){return t.GetLastSelectedVariant(e)},t._GetExtensionMetadata=function(e){var r,n;return((n=(r=e==null?void 0:e.metadata)===null||r===void 0?void 0:r.gltf)===null||n===void 0?void 0:n[q])||null},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var r=e[this.name];this._variants=r.variants}},t.prototype._loadMeshPrimitiveAsync=function(e,r,n,s,o,a){var i=this;return O.LoadExtensionAsync(e,o,this.name,function(l,c){var u=new Array;return u.push(i._loader._loadMeshPrimitiveAsync(e,r,n,s,o,function(f){if(a(f),f instanceof ce){var d=O._GetDrawMode(e,o.mode),h=i._loader.rootBabylonMesh,_=h.metadata=h.metadata||{},p=_.gltf=_.gltf||{},v=p[q]=p[q]||{lastSelected:null,original:[],variants:{}};v.original.push({mesh:f,material:f.material});for(var y=function(A){var T=c.mappings[A],E=g.Get(l+"/mappings/"+A+"/material",i._loader.gltf.materials,T.material);u.push(i._loader._loadMaterialAsync("#/materials/"+T.material,E,f,d,function(m){for(var R=function(x){var C=T.variants[x],G=g.Get("/extensions/"+q+"/variants/"+C,i._variants,C);v.variants[G.name]=v.variants[G.name]||[],v.variants[G.name].push({mesh:f,material:m}),f.onClonedObservable.add(function(k){var fe=k,Z=null,H=fe;do{if(H=H.parent,!H)return;Z=t._GetExtensionMetadata(H)}while(Z===null);if(Z===t._GetExtensionMetadata(h)){H.metadata={};for(var B in h.metadata)H.metadata[B]=h.metadata[B];H.metadata.gltf=[];for(var B in h.metadata.gltf)H.metadata.gltf[B]=h.metadata.gltf[B];H.metadata.gltf[q]={lastSelected:null,original:[],variants:{}};for(var ie=0,I=Z.original;ie<I.length;ie++){var cr=I[ie];H.metadata.gltf[q].original.push({mesh:cr.mesh,material:cr.material})}for(var B in Z.variants)if(Z.variants.hasOwnProperty(B)){H.metadata.gltf[q].variants[B]=[];for(var Te=0,fr=Z.variants[B];Te<fr.length;Te++){var dr=fr[Te];H.metadata.gltf[q].variants[B].push({mesh:dr.mesh,material:dr.material})}}Z=H.metadata.gltf[q]}for(var Oe=0,hr=Z.original;Oe<hr.length;Oe++){var he=hr[Oe];he.mesh===f&&(he.mesh=fe)}for(var be=0,_r=Z.variants[G.name];be<_r.length;be++){var he=_r[be];he.mesh===f&&(he.mesh=fe)}})},w=0;w<T.variants.length;++w)R(w)}))},b=0;b<c.mappings.length;++b)y(b)}})),Promise.all(u).then(function(f){var d=f[0];return d})})},t}();O.RegisterExtension(q,function(t){return new Qn(t)});var et=function(){function t(e,r){var n=this;this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=Ee(Ee({},t._getDefaultOptions()),e),this._scene=r,this._scene._transmissionHelper=this,this.onErrorObservable=new V,this._scene.onDisposeObservable.addOnce(function(s){n.dispose()}),this._parseScene(),this._setupRenderTargets()}return t._getDefaultOptions=function(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ue.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}},t.prototype.updateOptions=function(e){var r=this,n=Object.keys(e).filter(function(a){return r._options[a]!==e[a]});if(!!n.length){var s=Ee(Ee({},this._options),e),o=this._options;this._options=s,s.renderSize!==o.renderSize||s.renderTargetTextureType!==o.renderTargetTextureType||s.generateMipmaps!==o.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=s.samples,this._opaqueRenderTarget.lodGenerationScale=s.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=s.lodGenerationOffset)}},t.prototype.getOpaqueTarget=function(){return this._opaqueRenderTarget},t.prototype.shouldRenderAsTransmission=function(e){return e?!!(e instanceof D&&e.subSurface.isRefractionEnabled):!1},t.prototype._addMesh=function(e){var r=this;this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),N.SetImmediate(function(){r.shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=r._opaqueRenderTarget,r._transparentMeshesCache.push(e)):r._opaqueMeshesCache.push(e)})},t.prototype._removeMesh=function(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];var r=this._transparentMeshesCache.indexOf(e);r!==-1&&this._transparentMeshesCache.splice(r,1),r=this._opaqueMeshesCache.indexOf(e),r!==-1&&this._opaqueMeshesCache.splice(r,1)},t.prototype._parseScene=function(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))},t.prototype._onMeshMaterialChanged=function(e){var r=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e),s=this.shouldRenderAsTransmission(e.material);s?(e.material instanceof D&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),n!==-1?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):r===-1&&this._transparentMeshesCache.push(e)):r!==-1?(this._transparentMeshesCache.splice(r,1),this._opaqueMeshesCache.push(e)):n===-1&&this._opaqueMeshesCache.push(e)},t.prototype._setupRenderTargets=function(){var e=this,r,n;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new dn("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(n=(r=this._options.clearColor)===null||r===void 0?void 0:r.clone())!==null&&n!==void 0?n:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;var s,o;this._opaqueRenderTarget.onBeforeBindObservable.add(function(a){o=e._scene.environmentIntensity,e._scene.environmentIntensity=1,s=e._scene.imageProcessingConfiguration.applyByPostProcess,e._options.clearColor?a.clearColor.copyFrom(e._options.clearColor):e._scene.clearColor.toLinearSpaceToRef(a.clearColor),e._scene.imageProcessingConfiguration.applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(function(){e._scene.environmentIntensity=o,e._scene.imageProcessingConfiguration.applyByPostProcess=s}),this._transparentMeshesCache.forEach(function(a){e.shouldRenderAsTransmission(a.material)&&(a.material.refractionTexture=e._opaqueRenderTarget)})},t.prototype.dispose=function(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]},t}(),Qe="KHR_materials_transmission",rt=function(){function t(e){this.name=Qe,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qe),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialBasePropertiesAsync(e,r,n)),i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadTransparentPropertiesAsync(o,r,n,a)),Promise.all(i).then(function(){})})},t.prototype._loadTransparentPropertiesAsync=function(e,r,n,s){if(!(n instanceof D))throw new Error(e+": Material type not supported");var o=n;if(o.subSurface.isRefractionEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.useAlbedoToTintRefraction=!0,s.transmissionFactor!==void 0){o.subSurface.refractionIntensity=s.transmissionFactor;var a=o.getScene();o.subSurface.refractionIntensity&&!a._transmissionHelper&&new et({},o.getScene())}else return o.subSurface.refractionIntensity=0,o.subSurface.isRefractionEnabled=!1,Promise.resolve();return o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,s.transmissionTexture?(s.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(e+"/transmissionTexture",s.transmissionTexture,void 0).then(function(i){o.subSurface.refractionIntensityTexture=i,o.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},t}();O.RegisterExtension(Qe,function(t){return new rt(t)});var er="KHR_materials_translucency",nt=function(){function t(e){this.name=er,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(er),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialBasePropertiesAsync(e,r,n)),i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadTranslucentPropertiesAsync(o,r,n,a)),Promise.all(i).then(function(){})})},t.prototype._loadTranslucentPropertiesAsync=function(e,r,n,s){if(!(n instanceof D))throw new Error(e+": Material type not supported");var o=n;if(o.subSurface.isTranslucencyEnabled=!0,o.subSurface.volumeIndexOfRefraction=1,o.subSurface.minimumThickness=0,o.subSurface.maximumThickness=0,o.subSurface.useAlbedoToTintTranslucency=!0,s.translucencyFactor!==void 0)o.subSurface.translucencyIntensity=s.translucencyFactor;else return o.subSurface.translucencyIntensity=0,o.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return s.translucencyTexture?(s.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(e+"/translucencyTexture",s.translucencyTexture).then(function(a){o.subSurface.translucencyIntensityTexture=a})):Promise.resolve()},t}();O.RegisterExtension(er,function(t){return new nt(t)});var rr="KHR_materials_volume",tt=function(){function t(e){this.name=rr,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(rr),this.enabled&&this._loader._disableInstancedMesh++}return t.prototype.dispose=function(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return i.push(s._loader.loadMaterialBasePropertiesAsync(e,r,n)),i.push(s._loader.loadMaterialPropertiesAsync(e,r,n)),i.push(s._loadVolumePropertiesAsync(o,r,n,a)),Promise.all(i).then(function(){})})},t.prototype._loadVolumePropertiesAsync=function(e,r,n,s){if(!(n instanceof D))throw new Error(e+": Material type not supported");if(!n.subSurface.isRefractionEnabled&&!n.subSurface.isTranslucencyEnabled||!s.thicknessFactor)return Promise.resolve();n.subSurface.volumeIndexOfRefraction=n.indexOfRefraction;var o=s.attenuationDistance!==void 0?s.attenuationDistance:Number.MAX_VALUE;return n.subSurface.tintColorAtDistance=o,s.attenuationColor!==void 0&&s.attenuationColor.length==3&&n.subSurface.tintColor.copyFromFloats(s.attenuationColor[0],s.attenuationColor[1],s.attenuationColor[2]),n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=s.thicknessFactor,n.subSurface.useThicknessAsDepth=!0,s.thicknessTexture?(s.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(e+"/thicknessTexture",s.thicknessTexture).then(function(a){n.subSurface.thicknessTexture=a,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()},t}();O.RegisterExtension(rr,function(t){return new tt(t)});var nr="KHR_mesh_quantization",st=function(){function t(e){this.name=nr,this.enabled=e.isExtensionUsed(nr)}return t.prototype.dispose=function(){},t}();O.RegisterExtension(nr,function(t){return new st(t)});var tr="KHR_texture_basisu",ot=function(){function t(e){this.name=tr,this._loader=e,this.enabled=e.isExtensionUsed(tr)}return t.prototype.dispose=function(){this._loader=null},t.prototype._loadTextureAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=r.sampler==null?O.DefaultSampler:g.Get(e+"/sampler",s._loader.gltf.samplers,r.sampler),l=g.Get(o+"/source",s._loader.gltf.images,a.source);return s._loader._createTextureAsync(e,i,l,function(c){n(c)},r._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!r._textureInfo.nonColorData)})},t}();O.RegisterExtension(tr,function(t){return new ot(t)});var sr="KHR_texture_transform",at=function(){function t(e){this.name=sr,this._loader=e,this.enabled=this._loader.isExtensionUsed(sr)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadTextureInfoAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){return s._loader.loadTextureInfoAsync(e,r,function(i){if(!(i instanceof P))throw new Error(o+": Texture type not supported");a.offset&&(i.uOffset=a.offset[0],i.vOffset=a.offset[1]),i.uRotationCenter=0,i.vRotationCenter=0,a.rotation&&(i.wAng=-a.rotation),a.scale&&(i.uScale=a.scale[0],i.vScale=a.scale[1]),a.texCoord!=null&&(i.coordinatesIndex=a.texCoord),n(i)})})},t}();O.RegisterExtension(sr,function(t){return new at(t)});var or="KHR_xmp_json_ld",it=function(){function t(e){this.name=or,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(or)}return t.prototype.dispose=function(){this._loader=null},t.prototype.onLoading=function(){var e,r,n,s=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,o=(n=(r=this._loader.gltf.asset)===null||r===void 0?void 0:r.extensions)===null||n===void 0?void 0:n.KHR_xmp_json_ld;if(s&&o){var a=+o.packet;s.packets&&a<s.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=s.packets[a])}},t}();O.RegisterExtension(or,function(t){return new it(t)});var ar="MSFT_audio_emitter",lt=function(){function t(e){this.name=ar,this._loader=e,this.enabled=this._loader.isExtensionUsed(ar)}return t.prototype.dispose=function(){this._loader=null,this._clips=null,this._emitters=null},t.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var r=e[this.name];this._clips=r.clips,this._emitters=r.emitters,g.Assign(this._clips),g.Assign(this._emitters)}},t.prototype.loadSceneAsync=function(e,r){var n=this;return O.LoadExtensionAsync(e,r,this.name,function(s,o){var a=new Array;a.push(n._loader.loadSceneAsync(e,r));for(var i=0,l=o.emitters;i<l.length;i++){var c=l[i],u=g.Get(s+"/emitters",n._emitters,c);if(u.refDistance!=null||u.maxDistance!=null||u.rolloffFactor!=null||u.distanceModel!=null||u.innerAngle!=null||u.outerAngle!=null)throw new Error(s+": Direction or Distance properties are not allowed on emitters attached to a scene");a.push(n._loadEmitterAsync(s+"/emitters/"+u.index,u))}return Promise.all(a).then(function(){})})},t.prototype.loadNodeAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i=new Array;return s._loader.loadNodeAsync(o,r,function(l){for(var c=function(h){var _=g.Get(o+"/emitters",s._emitters,h);i.push(s._loadEmitterAsync(o+"/emitters/"+_.index,_).then(function(){for(var p=0,v=_._babylonSounds;p<v.length;p++){var y=v[p];y.attachToMesh(l),(_.innerAngle!=null||_.outerAngle!=null)&&(y.setLocalDirectionToMesh(S.Forward()),y.setDirectionalCone(2*N.ToDegrees(_.innerAngle==null?Math.PI:_.innerAngle),2*N.ToDegrees(_.outerAngle==null?Math.PI:_.outerAngle),0))}}))},u=0,f=a.emitters;u<f.length;u++){var d=f[u];c(d)}n(l)}).then(function(l){return Promise.all(i).then(function(){return l})})})},t.prototype.loadAnimationAsync=function(e,r){var n=this;return O.LoadExtensionAsync(e,r,this.name,function(s,o){return n._loader.loadAnimationAsync(e,r).then(function(a){var i=new Array;g.Assign(o.events);for(var l=0,c=o.events;l<c.length;l++){var u=c[l];i.push(n._loadAnimationEventAsync(s+"/events/"+u.index,e,r,u,a))}return Promise.all(i).then(function(){return a})})})},t.prototype._loadClipAsync=function(e,r){if(r._objectURL)return r._objectURL;var n;if(r.uri)n=this._loader.loadUriAsync(e,r,r.uri);else{var s=g.Get(e+"/bufferView",this._loader.gltf.bufferViews,r.bufferView);n=this._loader.loadBufferViewAsync("/bufferViews/"+s.index,s)}return r._objectURL=n.then(function(o){return URL.createObjectURL(new Blob([o],{type:r.mimeType}))}),r._objectURL},t.prototype._loadEmitterAsync=function(e,r){var n=this;if(r._babylonSounds=r._babylonSounds||[],!r._babylonData){for(var s=new Array,o=r.name||"emitter"+r.index,a={loop:!1,autoplay:!1,volume:r.volume==null?1:r.volume},i=function(f){var d="/extensions/"+l.name+"/clips",h=g.Get(d,l._clips,r.clips[f].clip);s.push(l._loadClipAsync(d+"/"+r.clips[f].clip,h).then(function(_){var p=r._babylonSounds[f]=new pn(o,_,n._loader.babylonScene,null,a);p.refDistance=r.refDistance||1,p.maxDistance=r.maxDistance||256,p.rolloffFactor=r.rolloffFactor||1,p.distanceModel=r.distanceModel||"exponential"}))},l=this,c=0;c<r.clips.length;c++)i(c);var u=Promise.all(s).then(function(){var f=r.clips.map(function(h){return h.weight||1}),d=new hn(r.loop||!1,r._babylonSounds,f);r.innerAngle&&(d.directionalConeInnerAngle=2*N.ToDegrees(r.innerAngle)),r.outerAngle&&(d.directionalConeOuterAngle=2*N.ToDegrees(r.outerAngle)),r.volume&&(d.volume=r.volume),r._babylonData.sound=d});r._babylonData={loaded:u}}return r._babylonData.loaded},t.prototype._getEventAction=function(e,r,n,s,o){switch(n){case"play":return function(a){var i=(o||0)+(a-s);r.play(i)};case"stop":return function(a){r.stop()};case"pause":return function(a){r.pause()};default:throw new Error(e+": Unsupported action "+n)}},t.prototype._loadAnimationEventAsync=function(e,r,n,s,o){var a=this;if(o.targetedAnimations.length==0)return Promise.resolve();var i=o.targetedAnimations[0],l=s.emitter,c=g.Get("/extensions/"+this.name+"/emitters",this._emitters,l);return this._loadEmitterAsync(e,c).then(function(){var u=c._babylonData.sound;if(u){var f=new _n(s.time,a._getEventAction(e,u,s.action,s.time,s.startOffset));i.animation.addEvent(f),o.onAnimationGroupEndObservable.add(function(){u.stop()}),o.onAnimationGroupPauseObservable.add(function(){u.pause()})}})},t}();O.RegisterExtension(ar,function(t){return new lt(t)});var ir="MSFT_lod",ut=function(){function t(e){this.name=ir,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new V,this.onMaterialLODsLoadedObservable=new V,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(ir)}return t.prototype.dispose=function(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()},t.prototype.onReady=function(){for(var e=this,r=function(i){var l=Promise.all(n._nodePromiseLODs[i]).then(function(){i!==0&&(e._loader.endPerformanceCounter("Node LOD "+i),e._loader.log("Loaded node LOD "+i)),e.onNodeLODsLoadedObservable.notifyObservers(i),i!==e._nodePromiseLODs.length-1&&(e._loader.startPerformanceCounter("Node LOD "+(i+1)),e._loadBufferLOD(e._nodeBufferLODs,i+1),e._nodeSignalLODs[i]&&e._nodeSignalLODs[i].resolve())});n._loader._completePromises.push(l)},n=this,s=0;s<this._nodePromiseLODs.length;s++)r(s);for(var o=function(i){var l=Promise.all(a._materialPromiseLODs[i]).then(function(){i!==0&&(e._loader.endPerformanceCounter("Material LOD "+i),e._loader.log("Loaded material LOD "+i)),e.onMaterialLODsLoadedObservable.notifyObservers(i),i!==e._materialPromiseLODs.length-1&&(e._loader.startPerformanceCounter("Material LOD "+(i+1)),e._loadBufferLOD(e._materialBufferLODs,i+1),e._materialSignalLODs[i]&&e._materialSignalLODs[i].resolve())});a._loader._completePromises.push(l)},a=this,s=0;s<this._materialPromiseLODs.length;s++)o(s)},t.prototype.loadSceneAsync=function(e,r){var n=this._loader.loadSceneAsync(e,r);return this._loadBufferLOD(this._bufferLODs,0),n},t.prototype.loadNodeAsync=function(e,r,n){var s=this;return O.LoadExtensionAsync(e,r,this.name,function(o,a){var i,l=s._getLODs(o,r,s._loader.gltf.nodes,a.ids);s._loader.logOpen(""+o);for(var c=[],u=0;u<l.length;u++)c.push(null);for(var f=function(d){var h=l[d];d!==0&&(s._nodeIndexLOD=d,s._nodeSignalLODs[d]=s._nodeSignalLODs[d]||new pe);var _=function(v,y){var b,A,T;v.setEnabled(!1),c[y]=v;for(var E=!0,m=0;m<c.length;m++)c[m]||(E=!1);var R=c[c.length-1];if(E&&R&&s._isMesh(R)){var w=(T=(A=(b=R.metadata)===null||b===void 0?void 0:b.gltf)===null||A===void 0?void 0:A.extras)===null||T===void 0?void 0:T.MSFT_screencoverage;if(w&&w.length){w.reverse(),R.useLODScreenCoverage=!0;for(var m=0;m<c.length-1;m++){var x=c[m];x&&s._isMesh(x)&&R.addLODLevel(w[m+1],x)}w[0]>0&&R.addLODLevel(w[0],null)}}},p=s._loader.loadNodeAsync("/nodes/"+h.index,h,function(v){return _(v,d)}).then(function(v){var y,b,A,T=(A=(b=(y=l[l.length-1]._babylonTransformNode.metadata)===null||y===void 0?void 0:y.gltf)===null||b===void 0?void 0:b.extras)===null||A===void 0?void 0:A.MSFT_screencoverage;if(d!==0&&!T){var E=l[d-1];E._babylonTransformNode&&(s._disposeTransformNode(E._babylonTransformNode),delete E._babylonTransformNode)}return n(v),v.setEnabled(!0),v});s._nodePromiseLODs[d]=s._nodePromiseLODs[d]||[],d===0?i=p:(s._nodeIndexLOD=null,s._nodePromiseLODs[d].push(p))},u=0;u<l.length;u++)f(u);return s._loader.logClose(),i})},t.prototype._loadMaterialAsync=function(e,r,n,s,o){var a=this;return this._nodeIndexLOD?null:O.LoadExtensionAsync(e,r,this.name,function(i,l){var c,u=a._getLODs(i,r,a._loader.gltf.materials,l.ids);a._loader.logOpen(""+i);for(var f=function(h){var _=u[h];h!==0&&(a._materialIndexLOD=h);var p=a._loader._loadMaterialAsync("/materials/"+_.index,_,n,s,function(v){h===0&&o(v)}).then(function(v){if(h!==0){o(v);var y=u[h-1]._data;y[s]&&(a._disposeMaterials([y[s].babylonMaterial]),delete y[s])}return v});a._materialPromiseLODs[h]=a._materialPromiseLODs[h]||[],h===0?c=p:(a._materialIndexLOD=null,a._materialPromiseLODs[h].push(p))},d=0;d<u.length;d++)f(d);return a._loader.logClose(),c})},t.prototype._loadUriAsync=function(e,r,n){var s=this;if(this._nodeIndexLOD!==null){this._loader.log("deferred");var o=this._nodeIndexLOD-1;return this._nodeSignalLODs[o]=this._nodeSignalLODs[o]||new pe,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(function(){return s._loader.loadUriAsync(e,r,n)})}else if(this._materialIndexLOD!==null){this._loader.log("deferred");var o=this._materialIndexLOD-1;return this._materialSignalLODs[o]=this._materialSignalLODs[o]||new pe,this._materialSignalLODs[o].promise.then(function(){return s._loader.loadUriAsync(e,r,n)})}return null},t.prototype.loadBufferAsync=function(e,r,n,s){if(this._loader.parent.useRangeRequests&&!r.uri){if(!this._loader.bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");var o=function(a,i){var l=n,c=l+s-1,u=a[i];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,c)):(u={start:l,end:c,loaded:new pe},a[i]=u),u.loaded.promise.then(function(f){return new Uint8Array(f.buffer,f.byteOffset+n-u.start,s)})};return this._loader.log("deferred"),this._nodeIndexLOD!==null?o(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?o(this._materialBufferLODs,this._materialIndexLOD):o(this._bufferLODs,0)}return null},t.prototype._isMesh=function(e){return!!e.addLODLevel},t.prototype._loadBufferLOD=function(e,r){var n=e[r];n&&(this._loader.log("Loading buffer range ["+n.start+"-"+n.end+"]"),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(function(s){n.loaded.resolve(s)},function(s){n.loaded.reject(s)}))},t.prototype._getLODs=function(e,r,n,s){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");for(var o=new Array,a=s.length-1;a>=0;a--)if(o.push(g.Get(e+"/ids/"+s[a],n,s[a])),o.length===this.maxLODsToLoad)return o;return o.push(r),o},t.prototype._disposeTransformNode=function(e){var r=this,n=new Array,s=e.material;s&&n.push(s);for(var o=0,a=e.getChildMeshes();o<a.length;o++){var i=a[o];i.material&&n.push(i.material)}e.dispose();var l=n.filter(function(c){return r._loader.babylonScene.meshes.every(function(u){return u.material!=c})});this._disposeMaterials(l)},t.prototype._disposeMaterials=function(e){for(var r={},n=0,s=e;n<s.length;n++){for(var o=s[n],a=0,i=o.getActiveTextures();a<i.length;a++){var l=i[a];r[l.uniqueId]=l}o.dispose()}for(var c in r)for(var u=0,f=this._loader.babylonScene.materials;u<f.length;u++){var o=f[u];o.hasTexture(r[c])&&delete r[c]}for(var c in r)r[c].dispose()},t}();O.RegisterExtension(ir,function(t){return new ut(t)});var lr="MSFT_minecraftMesh",ct=function(){function t(e){this.name=lr,this._loader=e,this.enabled=this._loader.isExtensionUsed(lr)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtraAsync(e,r,this.name,function(o,a){if(a){if(!(n instanceof D))throw new Error(o+": Material type not supported");var i=s._loader.loadMaterialPropertiesAsync(e,r,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,i}return null})},t}();O.RegisterExtension(lr,function(t){return new ct(t)});var ur="MSFT_sRGBFactors",ft=function(){function t(e){this.name=ur,this._loader=e,this.enabled=this._loader.isExtensionUsed(ur)}return t.prototype.dispose=function(){this._loader=null},t.prototype.loadMaterialPropertiesAsync=function(e,r,n){var s=this;return O.LoadExtraAsync(e,r,this.name,function(o,a){if(a){if(!(n instanceof D))throw new Error(o+": Material type not supported");var i=s._loader.loadMaterialPropertiesAsync(e,r,n);return n.albedoTexture||n.albedoColor.toLinearSpaceToRef(n.albedoColor),n.reflectivityTexture||n.reflectivityColor.toLinearSpaceToRef(n.reflectivityColor),i}return null})},t}();O.RegisterExtension(ur,function(t){return new ft(t)});var Dr="ExtrasAsMetadata",dt=function(){function t(e){this.name=Dr,this.enabled=!0,this._loader=e}return t.prototype._assignExtras=function(e,r){if(r.extras&&Object.keys(r.extras).length>0){var n=e.metadata=e.metadata||{},s=n.gltf=n.gltf||{};s.extras=r.extras}},t.prototype.dispose=function(){this._loader=null},t.prototype.loadNodeAsync=function(e,r,n){var s=this;return this._loader.loadNodeAsync(e,r,function(o){s._assignExtras(o,r),n(o)})},t.prototype.loadCameraAsync=function(e,r,n){var s=this;return this._loader.loadCameraAsync(e,r,function(o){s._assignExtras(o,r),n(o)})},t.prototype.createMaterial=function(e,r,n){var s=this._loader.createMaterial(e,r,n);return this._assignExtras(s,r),s},t}();O.RegisterExtension(Dr,function(t){return new dt(t)});var ht="/assets/apc.6635a715.glb";function _t(t){const e={forward:!1,left:!1,right:!1},r={forward:new V,left:new V,right:new V,all:new V},n={w:"forward",a:"left",d:"right"};return t.actionManager=new Re(t),t.actionManager.registerAction(new Sr(Re.OnKeyDownTrigger,function(s){const o=s.sourceEvent,a=n[o.key.toLowerCase()];a&&!e[a]&&(e[a]=!0,r[a].notifyObservers(!0),r.all.notifyObservers(e))})),t.actionManager.registerAction(new Sr(Re.OnKeyUpTrigger,function(s){const o=s.sourceEvent,a=n[o.key.toLowerCase()];a&&e[a]&&(e[a]=!1,r[a].notifyObservers(!1),r.all.notifyObservers(e))})),yr(Ar({},r),{destroy:()=>{}})}function At(t,e){t.enableOfflineSupport=!1,Q.AllowMatricesInterpolation=!0;var r=new vn(t);const n=_t(r);var s=new Ne("light1",new S(0,1,0),r);s.intensity=.6,s.specular=M.Black();var o=new ge("dir01",new S(3,-3,1),r);o.position=new S(0,5,5);var a=new An(1024,o);a.useBlurExponentialShadowMap=!0,a.blurKernel=32;const i=new yn("camera1",new S,r);i.radius=5,i.heightOffset=1.5;const l=new S;n.all.add(u=>{l.set(0,0,0),u.forward&&l.addInPlaceFromFloats(0,0,1),u.left&&l.addInPlaceFromFloats(-1,0,0),u.right&&l.addInPlaceFromFloats(1,0,0)}),r.onPointerObservable.add(u=>{switch(u.type){case mn.POINTERTAP:console.log(u),u.event.clientX<e.clientWidth*.2?l.set(1,0,0):u.event.clientX<e.clientWidth*.4?l.set(1,0,1):u.event.clientX<e.clientWidth*.6?l.set(0,0,1):u.event.clientX<e.clientWidth*.8?l.set(-1,0,1):l.set(-1,0,0)}});const c=r.createDefaultEnvironment({enableGroundShadow:!0});return c.setMainColor(M.Teal()),c.ground.position.y+=.01,Ce.ImportMesh("",ht,"",r,(u,f,d,h,_,p,v)=>{a.addShadowCaster(u[0],!0);const y=h.find(C=>C.name==="Idle"),b=h.find(C=>C.name==="Walking"),A=h.find(C=>C.name==="Left"),T=h.find(C=>C.name==="Right");[y,b,A,T].forEach(C=>{C.setWeightForAllAnimatables(0),C.start(!0)}),[A,T].forEach(C=>{C.syncAllAnimationsWith(b.animatables[0])});const E={idleAnimation:1,walkingAnimation:0,leftAnimation:0,rightAnimation:0},m={idleAnimation:1,walkingAnimation:0,leftAnimation:0,rightAnimation:0},R=["idleAnimation","walkingAnimation","leftAnimation","rightAnimation"];r.onBeforeAnimationsObservable.add(()=>{E.walkingAnimation=l.z>.1?1:1e-6,E.leftAnimation=l.x<-.1?1:0,E.rightAnimation=l.x>.1?1:0,E.idleAnimation=E.walkingAnimation==1e-6&&E.leftAnimation==0&&E.rightAnimation==0?1:0;for(const C of R)m[C]<E[C]?(m[C]+=.1,m[C]>E[C]&&(m[C]=E[C])):m[C]>E[C]&&(m[C]-=.1,m[C]<E[C]&&(m[C]=E[C]));y.setWeightForAllAnimatables(m.idleAnimation),b.setWeightForAllAnimatables(m.walkingAnimation),A.setWeightForAllAnimatables(m.leftAnimation),T.setWeightForAllAnimatables(m.rightAnimation)});const w=new ce("dummy",r,u[0]);w.position.addInPlaceFromFloats(0,1,0),i.lockedTarget=w;const x={idleAnimation:y,walkingAnimation:b,leftAnimation:A,rightAnimation:T,meshes:u,particleSystems:f,skeletons:d,animationGroups:h,transformNodes:_,geometries:p,lights:v};console.debug("hax",x),Object.assign(window,{hax:x})},function(){}),r}export{At as createScene};
